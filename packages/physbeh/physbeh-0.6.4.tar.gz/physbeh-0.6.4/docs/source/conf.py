# Configuration file for the Sphinx documentation builder.
#
# For the full list of built-in configuration values, see the documentation:
# https://www.sphinx-doc.org/en/master/usage/configuration.html

import inspect
import operator
import os
import sys

from sphinx_gallery import gen_rst

import physbeh

gen_rst.EXAMPLE_HEADER = """
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "{0}"
.. LINE NUMBERS ARE GIVEN BELOW.

.. note::
    This is an example script. Please check the API reference or even
    the source code of the functions your are interested in using for
    further comprehension.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_{1}>`
        to download the full example code{2}

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_{1}:

"""

sys.path.append(os.path.abspath("./_ext"))
sys.path.insert(0, os.path.abspath("../../src"))

# -- Project information -----------------------------------------------------
# https://www.sphinx-doc.org/en/master/usage/configuration.html#project-information

project = "physbeh"
copyright = "2023, Felipe Cybis Pereira"
author = "Felipe Cybis Pereira"

# -- General configuration ---------------------------------------------------
# https://www.sphinx-doc.org/en/master/usage/configuration.html#general-configuration

extensions = [
    "sphinx.ext.autodoc",
    "sphinx.ext.intersphinx",
    "sphinx_gallery.gen_gallery",
    "sphinx_copybutton",
    "numpydoc",
    "sphinx.ext.linkcode",
    "gh_substitutions",
    "sphinx_design",
]

nitpicky = True
# Autosummary configuration
autosummary_generate = True
autosummary_context = {
    # Methods that should be skipped when generating the docs.
    # Class docstring should be under the instance itself and not in __init__.
    "skipmethods": ["__init__", "initialize"],
    "skipclassesmembers": [],
}

# The reST default role (used for this markup: `text`) to use for all documents.
default_role = "autolink"

# Once we have type hints for everything we can decide what to do with them in the
# documentation, for now numpydoc does not handle them very well so we set them not to
# appear in the description of the function
autodoc_typehints = "none"

# -- numpydoc configuration ------------------------------------------------------------

# Get rid of spurious warnings due to some interaction between autosummary and numpydoc.
# See https://github.com/phn/pytpm/issues/3#issuecomment-12133978 for more details
numpydoc_show_class_members = False
numpydoc_xref_param_type = True
numpydoc_xref_aliases = {
    "Tracking": "physbeh.tracking.Tracking",
    "path-like": ":term:`path-like <python:path-like object>`",
    "path_like": ":term:`path-like <python:path-like object>`",
    "function": "callable",
}
numpydoc_xref_ignore = {"optional", "or", "of"}
numpydoc_validate = True

# -- Intersphinx configuration ---------------------------------------------------------

intersphinx_mapping = {
    "python": ("https://docs.python.org/3/", None),
    "numpy": ("https://numpy.org/devdocs/", None),
    "matplotlib": ("https://matplotlib.org/stable/", None),
    "pandas": ("https://pandas.pydata.org/pandas-docs/stable/", None),
}

templates_path = ["_templates"]


# -- Options for HTML output -------------------------------------------------
# https://www.sphinx-doc.org/en/master/usage/configuration.html#options-for-html-output

html_theme = "pydata_sphinx_theme"
html_title = "PhysBeh"
html_short_title = "PhysBeh"
# Add any paths that contain custom static files (such as style sheets) here,
# relative to this directory. They are copied after the builtin static files,
# so a file named "default.css" will overwrite the builtin "default.css".
html_static_path = ["_static"]
html_css_files = [
    "no_italic.css",  # disable italic for span classes
    "theme_layout.css",  # control layout width
]

html_theme_options = {
    "icon_links": [
        {
            "name": "GitHub",
            "url": "https://github.com/FelipeCybis/physbeh",
            "icon": "fa-brands fa-github",
        },
    ],
    "use_edit_page_button": True,
    "navbar_end": ["theme-switcher", "navbar-icon-links"],
}
html_context = {
    "github_url": "https://github.com",
    "github_user": "FelipeCybis",
    "github_repo": "physbeh",
    "github_version": "main",
    "doc_path": "docs/source",
}

# sphinx-gallery configuration
sphinx_gallery_conf = {
    "examples_dirs": ["../../examples"],
    "gallery_dirs": ["./auto_examples"],
    "backreferences_dir": "./api/generated",
    "reference_url": {"pyfus": None},
    "doc_module": "pyfus",
    "image_scrapers": ("matplotlib",),
    "matplotlib_animations": True,
}


def touch_example_backreferences(app, what, name, obj, options, lines):
    # generate empty examples files, so that we don't get
    # inclusion errors if there are no examples for a class / module
    examples_path = os.path.join(app.srcdir, "api", "generated", f"{name}.examples")
    if not os.path.exists(examples_path):
        # touch file
        open(examples_path, "w").close()


def setup(app):
    app.connect("autodoc-process-docstring", touch_example_backreferences)


# The following is used by sphinx.ext.linkcode to provide links to github
def linkcode_resolve(domain, info):
    if domain != "py":
        return None
    if not info["module"]:
        return None

    revision = "main"
    package = "physbeh"
    url_fmt = (
        "https://github.com/FelipeCybis/physbeh/blob/{revision}/"
        "src/{package}/{path}#L{lineno}"
    )

    class_name = info["fullname"].split(".")[0]
    module = __import__(info["module"], fromlist=[class_name])
    obj = operator.attrgetter(info["fullname"])(module)
    # Unwrap the object to get the correct source
    # file in case that is wrapped by a decorator
    obj = inspect.unwrap(obj)

    try:
        # get filepath from object
        fn = inspect.getsourcefile(obj)
    except Exception:
        fn = None
    if not fn:
        return

    # Don't include filenames from outside this package's tree
    if os.path.dirname(__import__(package).__file__) not in fn:
        return

    # get filepath relative to package root (will be the same in github)
    fn = os.path.relpath(fn, start=os.path.dirname(__import__(package).__file__))
    try:
        # get permalink of object, if possible
        lineno = inspect.getsourcelines(obj)[1]
    except Exception:
        lineno = ""
    return url_fmt.format(revision=revision, package=package, path=fn, lineno=lineno)
