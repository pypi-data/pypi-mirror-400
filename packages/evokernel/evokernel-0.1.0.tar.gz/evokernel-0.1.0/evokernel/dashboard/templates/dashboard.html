<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EvoKernel - {{ run_name }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cpp.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        :root {
            --bg-primary: #0d0d0d;
            --bg-secondary: #171717;
            --bg-tertiary: #1f1f1f;
            --text-primary: #fafafa;
            --text-secondary: #a3a3a3;
            --text-muted: #525252;
            --accent: #22c55e;
            --accent-dim: #166534;
            --error: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --border: #262626;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }
        
        .app {
            display: grid;
            grid-template-columns: 1fr 320px;
            min-height: 100vh;
        }
        
        .main { padding: 24px; overflow-y: auto; }
        .sidebar { 
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            padding: 24px;
            overflow-y: auto;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .header h1 span { color: var(--accent); }
        
        .run-name {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .status-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            background: var(--bg-tertiary);
        }
        
        .status-badge.running { color: var(--accent); }
        .status-badge.completed { color: var(--info); }
        .status-badge.converging { color: var(--warning); }
        
        .pulse {
            width: 8px;
            height: 8px;
            background: currentColor;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.9); }
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }
        
        .stat-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            font-feature-settings: 'tnum';
        }
        
        .stat-value.highlight { color: var(--accent); }
        
        .stat-value small {
            font-size: 14px;
            font-weight: 400;
            color: var(--text-muted);
        }
        
        /* Progress */
        .progress-section { margin-bottom: 24px; }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .progress-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-dim) 100%);
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }
        
        .chart-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        #speedup-chart { height: 200px; }
        #family-tree { height: 200px; overflow: hidden; }
        
        /* Section Title */
        .section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 24px 0 12px;
        }
        
        /* Islands Grid */
        .islands-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .island-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            transition: border-color 0.15s;
        }
        
        .island-card.active { border-color: var(--accent); }
        
        .island-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .island-name {
            font-size: 13px;
            font-weight: 600;
        }
        
        .island-badge {
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            background: var(--accent);
            color: var(--bg-primary);
            border-radius: 4px;
        }
        
        .island-stats {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .island-stats div { margin-bottom: 2px; }
        .island-stats span { color: var(--text-primary); }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 0;
        }
        
        .tab {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            background: var(--bg-secondary);
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .tab:hover { color: var(--text-secondary); }
        .tab.active { 
            color: var(--text-primary);
            background: var(--bg-tertiary);
            border-color: var(--border);
        }
        
        /* Panel */
        .panel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 0 8px 8px 8px;
        }
        
        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .code-content {
            max-height: 400px;
            overflow: auto;
        }
        
        .code-content pre {
            margin: 0;
            padding: 16px;
        }
        
        .code-content code {
            font-family: 'JetBrains Mono', 'SF Mono', monospace;
            font-size: 12px !important;
            background: transparent !important;
        }
        
        .log {
            font-family: 'JetBrains Mono', 'SF Mono', monospace;
            font-size: 11px;
            padding: 16px;
            max-height: 400px;
            overflow: auto;
            line-height: 1.6;
        }
        
        .log-line { padding: 1px 0; }
        .log-line.error { color: var(--error); }
        .log-line.best { color: var(--accent); }
        .log-line.iter { color: var(--text-primary); font-weight: 500; }
        .log-line.migrate { color: #a78bfa; }
        
        .empty {
            color: var(--text-muted);
            text-align: center;
            padding: 60px;
            font-size: 13px;
        }
        
        .hidden { display: none; }
        
        /* Sidebar */
        .sidebar-section { margin-bottom: 24px; }
        
        .sidebar-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        /* Cost Panel */
        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        
        .cost-item:last-child { border-bottom: none; }
        
        .cost-label { color: var(--text-secondary); }
        .cost-value { font-weight: 600; font-feature-settings: 'tnum'; }
        .cost-total { color: var(--accent); }
        
        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: auto;
            padding-top: 24px;
        }
        
        .connection-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--error);
        }
        
        .connection-dot.connected { background: var(--accent); }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .app { grid-template-columns: 1fr; }
            .sidebar { border-left: none; border-top: 1px solid var(--border); }
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .charts-section { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="app">
        <main class="main">
            <div class="header">
                <div>
                    <h1>k<span>bench</span></h1>
                    <div class="run-name">{{ run_name }}</div>
                </div>
                <div class="status-group">
                    <div id="convergence-badge" class="status-badge converging hidden">
                        <span class="pulse"></span>
                        Converging
                    </div>
                    {% if status.running %}
                    <div class="status-badge running">
                        <span class="pulse"></span>
                        Running
                    </div>
                    {% elif status.completed %}
                    <div class="status-badge completed">Completed</div>
                    {% endif %}
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Iteration</div>
                    <div class="stat-value" id="stat-iteration">{{ status.iteration }}<small>/{{ status.max_iterations }}</small></div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Best Speedup</div>
                    <div class="stat-value highlight" id="stat-speedup">{{ "%.2f"|format(status.best_speedup) }}x</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Best Score</div>
                    <div class="stat-value" id="stat-score">{{ "%.4f"|format(status.best_score) }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Programs</div>
                    <div class="stat-value" id="stat-programs">{{ total_programs }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ETA</div>
                    <div class="stat-value" id="stat-eta" style="font-size: 20px;">{{ eta or '—' }}</div>
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-header">
                    <span id="progress-text">{{ "%.1f"|format(progress_pct) }}% complete</span>
                    <span id="progress-eta">{% if eta %}~{{ eta }} remaining{% endif %}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: {{ progress_pct }}%"></div>
                </div>
            </div>

            <div class="charts-section">
                <div class="chart-card">
                    <div class="chart-title">Speedup Over Iterations</div>
                    <div id="speedup-chart"></div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Evolution Tree</div>
                    <div id="family-tree"></div>
                </div>
            </div>

            <div class="section-title">Islands ({{ num_islands }})</div>
            <div class="islands-grid" id="islands-container">
                {% for island in islands %}
                <div class="island-card {% if island.is_current %}active{% endif %}" id="island-{{ island.index }}">
                    <div class="island-header">
                        <span class="island-name">Island {{ island.index }}</span>
                        {% if island.is_current %}<span class="island-badge">ACTIVE</span>{% endif %}
                    </div>
                    <div class="island-stats">
                        <div>Programs: <span>{{ island.program_count }}</span></div>
                        <div>Speedup: <span>{{ "%.2f"|format(island.best_speedup) if island.best_speedup else "—" }}x</span></div>
                        <div>Gen: <span>{{ island.generation }}</span></div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="section-title">Code</div>
            <div class="tabs">
                <div class="tab active" onclick="showTab('best')">Best</div>
                {% for island in islands %}
                {% if island.best_code %}
                <div class="tab" onclick="showTab('island{{ island.index }}')">Island {{ island.index }}</div>
                {% endif %}
                {% endfor %}
                <div class="tab" onclick="showTab('log')">Log</div>
            </div>

            <div class="panel">
                <div id="content-best">
                    {% if best_code %}
                    <div class="panel-header">Global best · Score {{ "%.4f"|format(status.best_score) }} · Speedup {{ "%.2f"|format(status.best_speedup) }}x</div>
                    <div class="code-content"><pre><code class="language-cpp">{{ best_code }}</code></pre></div>
                    {% else %}
                    <div class="empty">No best kernel yet</div>
                    {% endif %}
                </div>

                {% for island in islands %}
                {% if island.best_code %}
                <div id="content-island{{ island.index }}" class="hidden">
                    <div class="panel-header">Island {{ island.index }} best · Score {{ "%.3f"|format(island.best_score) }} · Speedup {{ "%.2f"|format(island.best_speedup) }}x</div>
                    <div class="code-content"><pre><code class="language-cpp">{{ island.best_code }}</code></pre></div>
                </div>
                {% endif %}
                {% endfor %}

                <div id="content-log" class="hidden">
                    <div class="log" id="log-content">
                        {% for line in log_lines %}
                        <div class="log-line {% if 'Error' in line or 'error' in line %}error{% elif 'best' in line.lower() %}best{% elif 'Iteration' in line %}iter{% elif 'migrat' in line.lower() %}migrate{% endif %}">{{ line }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </main>

        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Cost Tracking</div>
                <div class="cost-item">
                    <span class="cost-label">LLM API</span>
                    <span class="cost-value" id="cost-llm">$<span id="cost-llm-value">{{ "%.4f"|format(costs.llm_cost if costs else 0) }}</span></span>
                </div>
                <div class="cost-item">
                    <span class="cost-label">GPU Time</span>
                    <span class="cost-value" id="cost-gpu">$<span id="cost-gpu-value">{{ "%.4f"|format(costs.gpu_cost if costs else 0) }}</span></span>
                </div>
                <div class="cost-item">
                    <span class="cost-label">Total</span>
                    <span class="cost-value cost-total">$<span id="cost-total-value">{{ "%.4f"|format(costs.total if costs else 0) }}</span></span>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">GPU Info</div>
                <div class="cost-item">
                    <span class="cost-label">Type</span>
                    <span class="cost-value">{{ gpu_type|upper if gpu_type else 'A100' }}</span>
                </div>
                <div class="cost-item">
                    <span class="cost-label">GPU Seconds</span>
                    <span class="cost-value" id="gpu-seconds">{{ "%.1f"|format(costs.gpu_seconds if costs else 0) }}s</span>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">LLM Usage</div>
                <div class="cost-item">
                    <span class="cost-label">Input Tokens</span>
                    <span class="cost-value" id="tokens-input">{{ "{:,}".format(costs.llm_input_tokens if costs else 0) }}</span>
                </div>
                <div class="cost-item">
                    <span class="cost-label">Output Tokens</span>
                    <span class="cost-value" id="tokens-output">{{ "{:,}".format(costs.llm_output_tokens if costs else 0) }}</span>
                </div>
            </div>

            <div class="connection-status">
                <span class="connection-dot" id="connection-dot"></span>
                <span id="connection-text">Connecting...</span>
            </div>
        </aside>
    </div>

    <script>
        // WebSocket connection
        const socket = io();
        let isConnected = false;
        
        // Speedup history for chart and convergence detection
        let speedupHistory = {{ speedup_history|tojson if speedup_history else '[]' }};
        let maxIterations = {{ status.max_iterations }};
        
        // Evolution tree data
        let treeData = {{ tree_data|tojson if tree_data else 'null' }};
        
        // Initialize Plotly chart
        const chartLayout = {
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent',
            margin: { l: 40, r: 20, t: 10, b: 30 },
            xaxis: {
                title: { text: 'Iteration', font: { size: 10, color: '#525252' } },
                gridcolor: '#262626',
                tickfont: { size: 10, color: '#525252' },
                zeroline: false,
            },
            yaxis: {
                title: { text: 'Speedup', font: { size: 10, color: '#525252' } },
                gridcolor: '#262626',
                tickfont: { size: 10, color: '#525252' },
                zeroline: false,
            },
            showlegend: false,
        };
        
        const chartConfig = { displayModeBar: false, responsive: true };
        
        function initChart() {
            const iterations = speedupHistory.map((_, i) => i + 1);
            const trace = {
                x: iterations,
                y: speedupHistory,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#22c55e', width: 2 },
                marker: { size: 4, color: '#22c55e' },
                fill: 'tozeroy',
                fillcolor: 'rgba(34, 197, 94, 0.1)',
            };
            Plotly.newPlot('speedup-chart', [trace], chartLayout, chartConfig);
        }
        
        function updateChart(iteration, speedup) {
            speedupHistory.push(speedup);
            // Keep last 100 points
            if (speedupHistory.length > 100) {
                speedupHistory = speedupHistory.slice(-100);
            }
            Plotly.extendTraces('speedup-chart', {
                x: [[iteration]],
                y: [[speedup]]
            }, [0], 100);
        }
        
        // Initialize D3 family tree
        function initTree() {
            if (!treeData) {
                d3.select('#family-tree')
                    .append('div')
                    .attr('class', 'empty')
                    .text('No evolution data yet');
                return;
            }
            
            const container = document.getElementById('family-tree');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const svg = d3.select('#family-tree')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const g = svg.append('g')
                .attr('transform', `translate(40, 10)`);
            
            const treeLayout = d3.tree().size([height - 20, width - 80]);
            const root = d3.hierarchy(treeData);
            treeLayout(root);
            
            // Links
            g.selectAll('.link')
                .data(root.links())
                .enter()
                .append('path')
                .attr('class', 'link')
                .attr('fill', 'none')
                .attr('stroke', '#262626')
                .attr('stroke-width', 1)
                .attr('d', d3.linkHorizontal()
                    .x(d => d.y)
                    .y(d => d.x));
            
            // Nodes
            const nodes = g.selectAll('.node')
                .data(root.descendants())
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.y},${d.x})`);
            
            nodes.append('circle')
                .attr('r', 4)
                .attr('fill', d => d.data.improved ? '#22c55e' : '#525252')
                .attr('stroke', d => d.data.improved ? '#166534' : '#404040')
                .attr('stroke-width', 1);
            
            nodes.filter(d => d.data.improved)
                .append('text')
                .attr('dx', 8)
                .attr('dy', 3)
                .attr('font-size', '9px')
                .attr('fill', '#22c55e')
                .text(d => `${d.data.speedup?.toFixed(2)}x`);
        }
        
        // Convergence detection
        function checkConvergence() {
            if (speedupHistory.length < 10) return false;
            
            const recent = speedupHistory.slice(-10);
            const avgImprovement = recent.reduce((acc, val, i, arr) => {
                if (i === 0) return acc;
                return acc + Math.abs(val - arr[i - 1]) / arr[i - 1];
            }, 0) / (recent.length - 1);
            
            return avgImprovement < 0.01;
        }
        
        function updateConvergenceIndicator() {
            const badge = document.getElementById('convergence-badge');
            if (checkConvergence()) {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        // Tab switching
        function showTab(name) {
            document.querySelectorAll('[id^="content-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById('content-' + name).classList.remove('hidden');
            event.target.classList.add('active');
        }
        
        // WebSocket event handlers
        socket.on('connect', () => {
            isConnected = true;
            document.getElementById('connection-dot').classList.add('connected');
            document.getElementById('connection-text').textContent = 'Connected';
        });
        
        socket.on('disconnect', () => {
            isConnected = false;
            document.getElementById('connection-dot').classList.remove('connected');
            document.getElementById('connection-text').textContent = 'Disconnected';
        });
        
        socket.on('status_update', (data) => {
            // Update stats
            document.getElementById('stat-iteration').innerHTML = 
                `${data.iteration}<small>/${maxIterations}</small>`;
            document.getElementById('stat-speedup').textContent = 
                `${data.best_speedup?.toFixed(2) || '0.00'}x`;
            document.getElementById('stat-score').textContent = 
                data.best_score?.toFixed(4) || '0.0000';
            document.getElementById('stat-programs').textContent = 
                data.total_programs || 0;
            
            if (data.eta) {
                document.getElementById('stat-eta').textContent = data.eta;
                document.getElementById('progress-eta').textContent = `~${data.eta} remaining`;
            }
            
            // Update progress
            const progress = (data.iteration / maxIterations) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `${progress.toFixed(1)}% complete`;
            
            // Update chart
            if (data.best_speedup && data.iteration) {
                updateChart(data.iteration, data.best_speedup);
                updateConvergenceIndicator();
            }
            
            // Update costs
            if (data.costs) {
                document.getElementById('cost-llm-value').textContent = data.costs.llm_cost?.toFixed(4) || '0.0000';
                document.getElementById('cost-gpu-value').textContent = data.costs.gpu_cost?.toFixed(4) || '0.0000';
                document.getElementById('cost-total-value').textContent = data.costs.total?.toFixed(4) || '0.0000';
                document.getElementById('gpu-seconds').textContent = `${data.costs.gpu_seconds?.toFixed(1) || '0.0'}s`;
                document.getElementById('tokens-input').textContent = (data.costs.llm_input_tokens || 0).toLocaleString();
                document.getElementById('tokens-output').textContent = (data.costs.llm_output_tokens || 0).toLocaleString();
            }
        });
        
        socket.on('log_update', (data) => {
            const logContent = document.getElementById('log-content');
            if (data.line) {
                const lineEl = document.createElement('div');
                lineEl.className = 'log-line';
                if (data.line.includes('Error') || data.line.includes('error')) {
                    lineEl.classList.add('error');
                } else if (data.line.toLowerCase().includes('best')) {
                    lineEl.classList.add('best');
                } else if (data.line.includes('Iteration')) {
                    lineEl.classList.add('iter');
                } else if (data.line.toLowerCase().includes('migrat')) {
                    lineEl.classList.add('migrate');
                }
                lineEl.textContent = data.line;
                logContent.appendChild(lineEl);
                logContent.scrollTop = logContent.scrollHeight;
            }
        });
        
        // Initialize
        hljs.highlightAll();
        initChart();
        initTree();
        updateConvergenceIndicator();
    </script>
</body>
</html>
