# ============================================================================
# TRECO Feature Example: Advanced When Blocks
# ============================================================================
#
# Demonstrates advanced conditional transitions using "when" blocks with
# multiple condition types and complex logic.
#
# Features demonstrated:
# - status, status_in, status_range
# - body_contains, body_not_contains, body_matches
# - header_exists, header_equals, header_contains
# - response_time_ms
# - condition (Jinja2 expressions)
# - Combining multiple conditions (AND logic)
# - otherwise fallback
#
# Usage:
#   treco examples/features/when-blocks-advanced.yaml
#
# ============================================================================

metadata:
  name: "Advanced When Blocks Demo"
  version: "1.0"
  author: "TRECO Team"
  vulnerability: "N/A - Feature Demo"
  description: |
    Comprehensive demonstration of when blocks for conditional transitions
    based on HTTP responses, timing, headers, and custom logic.

target:
  host: "httpbin.org"
  port: 443
  tls:
    enabled: true

entrypoint:
  state: test_status_conditions

states:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Example 1: Status Code Conditions
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  test_status_conditions:
    description: "Test various status code matching"
    
    request: |
      GET /status/200 HTTP/1.1
      Host: {{ target.host }}
    
    logger:
      on_state_enter: |
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  When Blocks - Status Code Conditions                                        â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    next:
      # Exact status match
      - when:
          - status: 200
        goto: test_body_conditions
        logger: |
          âœ… Matched exact status 200
      
      # Status in list
      - when:
          - status_in: [200, 201, 204]
        goto: test_body_conditions
        logger: |
          âœ… Matched status in [200, 201, 204]
      
      # Status range
      - when:
          - status_range: [200, 299]
        goto: test_body_conditions
        logger: |
          âœ… Matched status in range 200-299
      
      # Fallback
      - otherwise: true
        goto: error_state
        logger: |
          âŒ Status did not match any condition

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Example 2: Body Content Conditions
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  test_body_conditions:
    description: "Test body content matching"
    
    request: |
      GET /html HTTP/1.1
      Host: {{ target.host }}
    
    logger:
      on_state_enter: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  When Blocks - Body Content Conditions                                       â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    next:
      # body_contains (simple substring)
      - when:
          - status: 200
          - body_contains: "Herman Melville"
        goto: test_header_conditions
        logger: |
          âœ… Body contains "Herman Melville"
      
      # body_not_contains (negative match)
      - when:
          - status: 200
          - body_not_contains: "ADMIN_PANEL"
        goto: test_header_conditions
        logger: |
          âœ… Body does NOT contain "ADMIN_PANEL"
      
      # body_matches (regex pattern)
      - when:
          - status: 200
          - body_matches: "<!DOCTYPE html>"
        goto: test_header_conditions
        logger: |
          âœ… Body matches HTML pattern
      
      # body_equals (exact match)
      - when:
          - body_equals: "EXACT_STRING"
        goto: test_header_conditions
        logger: |
          âœ… Body exactly equals expected string
      
      - otherwise: true
        goto: error_state
        logger: |
          âŒ Body did not match any condition

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Example 3: Header Conditions
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  test_header_conditions:
    description: "Test header matching"
    
    request: |
      GET /response-headers?Content-Type=application/json&X-Custom=test123 HTTP/1.1
      Host: {{ target.host }}
    
    logger:
      on_state_enter: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  When Blocks - Header Conditions                                             â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    next:
      # header_exists (check if header present)
      - when:
          - header_exists: "Content-Type"
        goto: test_timing_conditions
        logger: |
          âœ… Header "Content-Type" exists
      
      # header_not_exists (check if header absent)
      - when:
          - header_not_exists: "X-Admin-Token"
        goto: test_timing_conditions
        logger: |
          âœ… Header "X-Admin-Token" does NOT exist
      
      # header_equals (exact value match)
      - when:
          - header_equals:
              name: "Content-Type"
              value: "application/json"
        goto: test_timing_conditions
        logger: |
          âœ… Header "Content-Type" equals "application/json"
      
      # header_contains (substring in value)
      - when:
          - header_contains:
              name: "Content-Type"
              pattern: "json"
        goto: test_timing_conditions
        logger: |
          âœ… Header "Content-Type" contains "json"
      
      # header_matches (regex pattern)
      - when:
          - header_matches:
              name: "X-Custom"
              pattern: "test\\d+"
        goto: test_timing_conditions
        logger: |
          âœ… Header "X-Custom" matches pattern "test\\d+"
      
      - otherwise: true
        goto: error_state

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Example 4: Timing Conditions
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  test_timing_conditions:
    description: "Test response time conditions"
    
    request: |
      GET /delay/1 HTTP/1.1
      Host: {{ target.host }}
    
    logger:
      on_state_enter: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  When Blocks - Timing Conditions                                             â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    next:
      # Response faster than 500ms
      - when:
          - response_time_ms:
              operator: "<"
              value: 500
        goto: test_jinja_conditions
        logger: |
          âš¡ Fast response (< 500ms)
      
      # Response slower than 2000ms
      - when:
          - response_time_ms:
              operator: ">"
              value: 2000
        goto: error_state
        logger: |
          ğŸŒ Slow response (> 2000ms)
      
      # Response in acceptable range
      - when:
          - response_time_ms:
              operator: ">="
              value: 500
          - response_time_ms:
              operator: "<="
              value: 2000
        goto: test_jinja_conditions
        logger: |
          âœ… Response time in acceptable range (500-2000ms)
      
      - otherwise: true
        goto: error_state

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Example 5: Custom Jinja2 Conditions
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  test_jinja_conditions:
    description: "Test custom Jinja2 condition expressions"
    
    request: |
      GET /uuid HTTP/1.1
      Host: {{ target.host }}
    
    extract:
      uuid:
        type: jpath
        pattern: "$.uuid"
    
    logger:
      on_state_enter: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  When Blocks - Custom Jinja2 Conditions                                      â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    next:
      # Complex condition using Jinja2
      - when:
          - condition: "response.status_code == 200"
          - condition: "timing_ms < 2000"
          - condition: "test_jinja_conditions.uuid | length == 36"
        goto: test_combined_conditions
        logger: |
          âœ… All custom conditions met:
             â€¢ Status is 200
             â€¢ Response < 2000ms
             â€¢ UUID has 36 characters
      
      - otherwise: true
        goto: error_state

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Example 6: Combined Conditions (AND logic)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  test_combined_conditions:
    description: "Test combining multiple condition types"
    
    request: |
      GET /json HTTP/1.1
      Host: {{ target.host }}
    
    logger:
      on_state_enter: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  When Blocks - Combined Conditions (AND logic)                               â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    next:
      # All conditions must match (AND)
      - when:
          - status: 200                                    # Status is 200
          - header_contains:                               # AND Content-Type contains "json"
              name: "Content-Type"
              pattern: "json"
          - body_contains: "slideshow"                     # AND Body contains "slideshow"
          - response_time_ms:                              # AND Response < 1000ms
              operator: "<"
              value: 1000
        goto: success_state
        logger: |
          âœ… ALL conditions matched (AND logic):
             â€¢ HTTP 200
             â€¢ Content-Type contains "json"
             â€¢ Body contains "slideshow"
             â€¢ Response time < 1000ms
      
      # Partial match (some conditions failed)
      - when:
          - status: 200
          - body_contains: "slideshow"
        goto: success_state
        logger: |
          âš ï¸  Partial match (relaxed conditions)
      
      - otherwise: true
        goto: error_state
        logger: |
          âŒ No conditions matched

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Success and Error States
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  success_state:
    description: "All tests passed"
    
    request: |
      GET /status/200 HTTP/1.1
      Host: {{ target.host }}
    
    logger:
      on_state_enter: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  âœ… When Blocks Demo Complete!                                               â•‘
        â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        â•‘  All condition types demonstrated successfully:                              â•‘
        â•‘  â€¢ Status conditions (exact, in, range)                                      â•‘
        â•‘  â€¢ Body conditions (contains, not_contains, matches, equals)                 â•‘
        â•‘  â€¢ Header conditions (exists, equals, contains, matches)                     â•‘
        â•‘  â€¢ Timing conditions (>, <, >=, <=)                                          â•‘
        â•‘  â€¢ Custom Jinja2 conditions                                                  â•‘
        â•‘  â€¢ Combined conditions (AND logic)                                           â•‘
        â•‘  â€¢ Otherwise fallback                                                        â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  error_state:
    description: "Error state for failed conditions"
    
    request: |
      GET /status/500 HTTP/1.1
      Host: {{ target.host }}
    
    logger:
      on_state_enter: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  âŒ Condition Check Failed                                                   â•‘
        â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        â•‘  One or more when block conditions were not met.                             â•‘
        â•‘  Check the logs above to see which condition failed.                         â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•