orchestrator:
  id: orka-ui
  strategy: sequential
  queue: orka:generated
  memory_preset: "working"  # Use working memory for active processing
  agents:
    - fork_detect
    - join_detect
    - fork_temporal
    - join_paths
    - synthesize_timeline_answer
    - search_before
    - search_after
agents:
  - id: fork_detect
    type: fork
    targets:
      - [detect_change]  # Fixed: targets must be a list of lists (each branch is a list)
  - id: detect_change
    type: local_llm
    model: openai/gpt-oss-20b
    model_url: http://localhost:1234
    provider: lm_studio
    temperature: 0.3
    timeout: 60.0
    queue: orka:detect_change
    prompt: "Given the user query, identify if any important change in classification/understanding/definition (or any adjective associated to the query) occurred in history. If so, return the date when this change occurred. Format strictly: DD/MM/YYYY. If no specific historical change is known, return a reasonable estimate year. QUERY: {{ get_input() }} Constraints: Return a date in the format DD/MM/YYYY or just a year like 2000."
    depends_on:
      - fork_detect
    params:
      structured_output:
        enabled: true
        mode: prompt
        schema:
          required: [response]
          optional:
            confidence: number
  - id: join_detect
    type: join
    group: fork_detect
  - id: fork_temporal
    type: fork
    targets:
      - [generate_before_query]  # Fixed: Each branch must be wrapped in a list
      - [generate_after_query]
    depends_on:
      - join_detect
  - id: generate_before_query
    type: local_llm
    model: openai/gpt-oss-20b
    model_url: http://localhost:1234
    provider: lm_studio
    temperature: 0.4
    timeout: 60.0
    queue: orka:generate_before_query
    prompt: > 
      Based on the user's question and the detected pivot year, write a search query to find how the subject was classified or understood before that year. Use phrasing like: "how was [subject] classified before [year]?" SUBJECT: {{ get_input() }} YEAR: {% set change_data = get_agent_response("detect_change") %}{% if change_data and change_data.response %}{{ change_data.response }}{% else %}2000{% endif %} Constraints: Only return the search sentence.
    depends_on:
      - fork_temporal
    params:
      structured_output:
        enabled: true
        mode: prompt
        schema:
          required: [response]
          optional:
            confidence: number
  - id: generate_after_query
    type: local_llm
    model: openai/gpt-oss-20b
    model_url: http://localhost:1234
    provider: lm_studio
    temperature: 0.4
    timeout: 60.0
    queue: orka:generate_after_query
    prompt: >
      Based on the user's question and the detected pivot year, write a search query to find how the subject was classified or understood after that year. Use phrasing like: "how was [subject] classified after [year]?" SUBJECT: {{ get_input() }} YEAR: {% set change_data = get_agent_response("detect_change") %}{% if change_data and change_data.response %}{{ change_data.response }}{% else %}2000{% endif %} Constraints: Only return the search sentence.
    depends_on:
      - fork_temporal
    params:
      structured_output:
        enabled: true
        mode: prompt
        schema:
          required: [response]
          optional:
            confidence: number
  - id: join_paths
    type: join
    group: fork_temporal
    depends_on:
      - search_before
      - search_after
  - id: search_before
    type: duckduckgo
    queue: orka:search_before
    prompt: "{{ get_agent_response('generate_before_query') }}"
    depends_on:
      - generate_before_query
  - id: search_after
    type: duckduckgo
    queue: orka:search_after
    prompt: "{{ get_agent_response('generate_after_query') }}"
    depends_on:
      - generate_after_query
  - id: synthesize_timeline_answer
    type: local_llm
    model: openai/gpt-oss-20b
    model_url: http://localhost:1234
    provider: lm_studio
    temperature: 0.7
    timeout: 60.0
    queue: orka:synthesize_timeline_answer
    prompt: "Based on the query, the year, and data from both the before and after searches, write a comprehensive summary explaining: - What the subject was classified/understood/defined as before the change - What it became after the change - The context and significance of this shift QUERY: {{ get_input() }} YEAR: {% set change_data = get_agent_response('detect_change') %}{% if change_data and change_data.response %}{{ change_data.response }}{% else %}Unknown{% endif %} EXTRA DATA: {% set before = get_agent_response('search_before') %}{% if before and before.response %}{{ before.response }}{% else %}No response found for search_before{% endif %} | {% set after = get_agent_response('search_after') %}{% if after and after.response %}{{ after.response }}{% else %}No response found for search_after{% endif %}"
    depends_on:
      - join_paths
    params:
      structured_output:
        enabled: true
        mode: prompt
        schema:
          required: [response]
          optional:
            confidence: number
