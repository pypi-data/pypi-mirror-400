name: build-wheels

on:
  push:
    tags:
      - "v*.*.*"        # 打 tag 才會出包並發布
  workflow_dispatch:     # 也可手動觸發

jobs:
  # --- 1) sdist 只需建一次，用 Linux 即可 ---
  sdist:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build sdist
        run: |
          python -m pip install -U build
          python -m build --sdist --outdir dist

      - name: Upload sdist artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  # --- 2) 透過矩陣建 wheels ---
  wheels:
    strategy:
      matrix:
        os: [ubuntu-22.04, windows-2022]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install cibuildwheel
        run: python -m pip install -U pip cibuildwheel

      - name: Enable QEMU (Linux only, for aarch64)
        if: runner.os == 'Linux'
        run: docker run --rm --privileged tonistiigi/binfmt --install arm64

      - name: Build wheels (Linux + Windows + macOS)
        env:
          CIBW_BUILD: "cp311-*"
          CIBW_SKIP: "pp*"
          CIBW_ENVIRONMENT: 'CFLAGS="-O3"'
          CIBW_TEST_SKIP: "*"

          # ===== Linux 設定 =====
          CIBW_ARCHS_LINUX: "x86_64 aarch64"
          CIBW_MANYLINUX_X86_64_IMAGE: "quay.io/pypa/manylinux_2_28_x86_64"
          CIBW_MANYLINUX_AARCH64_IMAGE: "quay.io/pypa/manylinux_2_28_aarch64"
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: 'auditwheel repair --only-plat -w {dest_dir} {wheel}'

          # ===== Windows 設定 =====
          CIBW_ARCHS_WINDOWS: "AMD64"

          # ===== macOS =====
          CIBW_ARCHS_MACOS: "universal2"
        run: cibuildwheel --output-dir wheelhouse

      - name: Upload wheels artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: wheelhouse/*.whl

  publish:
    name: Publish (PyPI + Private + GCP Artifact Registry)
    needs: [wheels, sdist]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist/
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist/

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Twine check (optional but recommended)
        run: |
          python -m pip install -U twine
          python -m twine check dist/*

      # =====================================================
      # ✅ GCP auth (Service Account JSON) + upload to GAR
      # =====================================================
      - name: Authenticate to Google Cloud (service account JSON)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_JSON }}

      - name: Setup gcloud (optional)
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Upload to GCP Artifact Registry (Python)
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GAR_REGION: ${{ secrets.GAR_REGION }}
          GAR_PY_REPO: ${{ secrets.GAR_PY_REPO }}
        run: |
          python -m pip install -U pip twine keyring keyrings.google-artifactregistry-auth
          REPO_URL="https://${GAR_REGION}-python.pkg.dev/${GCP_PROJECT_ID}/${GAR_PY_REPO}/"
          python -m twine upload --repository-url "${REPO_URL}" dist/*

      # =========================
      # PyPI 發佈
      # =========================
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@v1.12.4
        with:
          packages-dir: dist
          password: ${{ secrets.PYPI_API_TOKEN }}
          verify-metadata: false
          attestations: false

      # =========================
      # 私有 PyPI 發佈
      # =========================
      - name: Upload to private PyPI
        env:
          TWINE_REPOSITORY_URL: https://innolux-registry.duckdns.org/pypi/
          TWINE_USERNAME: ${{ secrets.PRIVATE_PYPI_USER }}
          TWINE_PASSWORD: ${{ secrets.PRIVATE_PYPI_PASS }}
        run: |
          python -m pip install -U twine
          python -m twine upload dist/*
