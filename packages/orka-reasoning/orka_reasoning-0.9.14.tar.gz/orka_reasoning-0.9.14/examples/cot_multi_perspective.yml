# Chain-of-Thought Multi-Perspective Analysis
# Each loop iteration takes a different perspective (Analytical, Empathetic, Creative)
#
# ROBUSTNESS FEATURES:
# - Explicit SCORE format requirement
# - Multiple score extraction strategies
# - Fallback scores for failures
# - Focused prompts per perspective
# - Lower threshold for realistic performance

orchestrator:
  id: cot-multi-perspective
  strategy: sequential
  agents:
    - conversation_loop
    - final_answer_builder

agents:
  - id: conversation_loop
    type: loop
    max_loops: 3
    score_threshold: 0.50
    fallback_score: 0.30
    timeout_score: 0.20
    persist_across_runs: false
    
    # Robust score extraction
    score_extraction_config:
      strategies:
        - type: pattern
          patterns:
            - "SCORE:\\s*([0-9]+\\.?[0-9]*)"
            - "Score:\\s*([0-9]+\\.?[0-9]*)"
            - "QUALITY_SCORE:\\s*([0-9]+\\.?[0-9]*)"
        - type: pattern
          patterns:
            - "(0\\.[5-9][0-9]?)"
            - "(0\\.[4][5-9])"
        - type: agent_key
          agents: ["quality_scorer"]
          key: "response"
          transform: "extract_score"
    
    past_loops_metadata:
      loop_number: "{{ get_loop_number() }}"
      perspective: "{% set p = ['Analytical', 'Empathetic', 'Creative'] %}{{ p[(get_loop_number() - 1) % 3] }}"
      reasoning: "{{ get_agent_response('perspective_handler')['response'] | default('') }}"
      synthesis: "{{ get_agent_response('synthesizer')['response'] | default('') }}"
      quality_score: "{{ get_agent_response('quality_scorer')['response'] | default('') }}"
      timestamp: "{{ timestamp }}"
    
    internal_workflow:
      orchestrator:
        id: perspective-analysis
        strategy: sequential
        agents: [perspective_handler, synthesizer, quality_scorer]
      
      agents:
        - id: perspective_handler
          type: local_llm
          model: openai/gpt-oss-20b
          model_url: http://localhost:1234
          provider: lm_studio
          temperature: 0.6
          timeout: 60
          prompt: |
            {% set perspectives = ['Analytical', 'Empathetic', 'Creative'] %}
            {% set current = perspectives[(get_loop_number() - 1) % 3] %}
            
            TASK: Analyze from the {{ current }} perspective.
            QUERY: {{ get_input() }}
            
            {% if current == 'Analytical' %}
            ANALYTICAL LENS - Focus on:
            • Facts, data, and logical reasoning
            • Systematic problem decomposition
            • Evidence-based conclusions
            • Cause-and-effect relationships
            {% elif current == 'Empathetic' %}
            EMPATHETIC LENS - Focus on:
            • Human impact and emotional aspects
            • Stakeholder perspectives
            • Social and relational dynamics
            • Real-world consequences for people
            {% else %}
            CREATIVE LENS - Focus on:
            • Novel approaches and alternatives
            • Unconventional solutions
            • Future possibilities
            • Cross-domain connections
            {% endif %}
            
            {% if has_past_loops() %}
            BUILD ON PREVIOUS PERSPECTIVES:
            {% for p in get_past_loops() %}
            {{ p.perspective }}: {{ p.synthesis }}
            {% endfor %}
            {% endif %}
            
            REQUIRED OUTPUT FORMAT:
            
            PERSPECTIVE: {{ current }}
            
            REASONING:
            1. [Key observation from this lens]
            2. [Supporting point]
            3. [Implication or insight]
            
            CONCLUSION:
            [2-3 sentences summarizing this perspective's contribution]
            
            Target 200-300 words. Avoid repeating previous perspectives.

        - id: synthesizer
          type: local_llm
          model: openai/gpt-oss-20b
          model_url: http://localhost:1234
          provider: lm_studio
          temperature: 0.4
          timeout: 60
          prompt: |
            TASK: Synthesize the current perspective's insights.
            
            CURRENT ANALYSIS:
            {{ get_agent_response('perspective_handler') }}
            
            {% if has_past_loops() %}
            PREVIOUS SYNTHESES:
            {% for p in get_past_loops() %}
            {{ p.perspective }}: {{ p.synthesis }}
            {% endfor %}
            {% endif %}
            
            REQUIRED OUTPUT FORMAT:
            
            UNIQUE_INSIGHTS:
            - [New insight not in previous perspectives]
            - [Another unique contribution]
            
            BUILDS_ON:
            - [How this complements previous work]
            
            RESPONSE:
            [Synthesized perspective in 2-3 clear sentences]

        - id: quality_scorer
          type: local_llm
          model: openai/gpt-oss-20b
          model_url: http://localhost:1234
          provider: lm_studio
          temperature: 0.1
          timeout: 60
          prompt: |
            TASK: Score this perspective's quality.
            
            SYNTHESIS TO EVALUATE:
            {{ get_agent_response('synthesizer') }}
            
            SCORING RUBRIC:
            - Uniqueness (0-0.3): New insights vs repetition?
            - Depth (0-0.3): Thorough analysis?
            - Integration (0-0.2): Builds on previous work?
            - Clarity (0-0.2): Well-structured?
            
            {% if has_past_loops() %}
            PREVIOUS SCORES:
            {% for p in get_past_loops() %}
            {{ p.perspective }}: {{ p.quality_score }}
            {% endfor %}
            {% endif %}
            
            REQUIRED OUTPUT FORMAT:
            
            BREAKDOWN:
            - Uniqueness: [0.0-0.3]
            - Depth: [0.0-0.3]
            - Integration: [0.0-0.2]
            - Clarity: [0.0-0.2]
            
            SCORE: [Total 0.0-1.0]
            
            REASON: [One sentence explanation]
            
            IMPORTANT: SCORE line must be exactly "SCORE: X.XX"

  - id: final_answer_builder
    type: local_llm
    model: openai/gpt-oss-20b
    model_url: http://localhost:1234
    provider: lm_studio
    temperature: 0.4
    timeout: 60
    prompt: |
      TASK: Create final answer integrating all perspectives.
      
      ORIGINAL QUERY: {{ get_input() }}
      
      {% set loop_results = get_agent_response('conversation_loop') %}
      {% if loop_results and loop_results.past_loops %}
      MULTI-PERSPECTIVE ANALYSIS:
      {% for p in loop_results.past_loops %}
      
      === {{ p.perspective | upper }} ===
      Reasoning: {{ p.reasoning }}
      Synthesis: {{ p.synthesis }}
      Quality: {{ p.quality_score }}
      {% endfor %}
      {% else %}
      No multi-perspective data available.
      {% endif %}
      
      REQUIRED OUTPUT FORMAT:
      
      SUMMARY:
      [One clear sentence answering the query]
      
      DETAILED_RESPONSE:
      [Complete answer integrating all perspectives, 200-300 words]
      
      PERSPECTIVE_CONTRIBUTIONS:
      - Analytical: [Key contribution]
      - Empathetic: [Key contribution]
      - Creative: [Key contribution]
      
      Ensure the answer directly addresses the original query.
