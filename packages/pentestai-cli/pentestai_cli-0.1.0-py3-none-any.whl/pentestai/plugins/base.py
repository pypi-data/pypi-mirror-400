from __future__ import annotations

from abc import ABC, abstractmethod
from dataclasses import dataclass
from typing import Dict, Any, Optional, List

from pentestai.core.workflow import Context


@dataclass(frozen=True)
class RunResult:
    """
    Normalized plugin result that is JSON-serializable.
    - data: normalized payload
    - meta: execution metadata (cmd, stderr tail, duration, etc.)
    - files: files produced (paths as strings)
    """
    kind: str
    data: Dict[str, Any]
    meta: Dict[str, Any]
    files: List[str]


class Plugin(ABC):
    """
    Base class for all tool plugins (subfinder/httpx/nmap/nuclei/...).

    Design goals:
    - Stable interface for open-source contributors
    - Flags flow through ctx.vars (dry_run/verbose/timeout/etc.)
    - Output is normalized & consistent (RunResult)
    """

    # short unique id used by registry and CLI, e.g. "subfinder", "httpx", "nmap"
    name: str

    # optional semantic kind for artifacts, e.g. "recon.subdomains"
    kind: str = "generic"

    def validate_args(self, args: Dict[str, Any]) -> None:
        """
        Optional: validate/normalize plugin-specific args before running.
        Raise ValueError for invalid config.
        """
        return

    @abstractmethod
    def run(self, ctx: Context, args: Dict[str, Any]) -> RunResult:
        """
        Execute tool and return normalized result.

        Plugin must:
        - Respect ctx.safe_mode where relevant (avoid destructive options)
        - Respect ctx.vars flags when present:
            - dry_run: bool (do not execute external command)
            - verbose: bool (extra debug)
            - timeout: int/float (seconds) optional
        - Return RunResult that is JSON-serializable
        """
        ...
