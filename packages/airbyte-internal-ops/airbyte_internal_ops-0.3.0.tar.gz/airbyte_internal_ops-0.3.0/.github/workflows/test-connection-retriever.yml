name: Test Connection Retriever

permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      connection_id:
        description: "Airbyte Cloud connection ID to test retrieval for"
        required: true
        type: string

jobs:
  test-retriever:
    name: Test Connection Retriever
    runs-on: ubuntu-latest
    env:
      CI: "true"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: uv sync --group dev

      - name: Set up GCP credentials
        env:
          GCP_PROD_DB_ACCESS_CREDENTIALS: ${{ secrets.GCP_INTEGRATION_TESTER_CREDENTIALS }}
        run: |
          echo "$GCP_PROD_DB_ACCESS_CREDENTIALS" > /tmp/credentials.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/credentials.json" >> $GITHUB_ENV

      - name: Download Cloud SQL Proxy
        run: |
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.14.3/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy

      - name: Test Connection Retriever
        env:
          CONNECTION_ID: ${{ inputs.connection_id }}
        run: |
          # Start Cloud SQL Proxy in background
          ./cloud-sql-proxy prod-ab-cloud-proj:us-west3:prod-pgsql-replica --credentials-file /tmp/credentials.json &
          proxy_pid=$!

          # Wait for proxy to be ready
          sleep 5

          # Run the test
          uv run python -c "
          from airbyte_ops_mcp.regression_tests.connection_secret_retriever import retrieve_unmasked_config
          import os

          connection_id = os.environ['CONNECTION_ID']
          print(f'Testing retrieval for connection: {connection_id}')

          config = retrieve_unmasked_config(
              connection_id=connection_id,
              retrieval_reason='CI test of connection-retriever integration'
          )

          # Verify we got a config (don't print it - contains secrets)
          assert config is not None, 'Failed to retrieve config'
          assert isinstance(config, dict), 'Config should be a dict'
          print('Successfully retrieved unmasked config')
          "
          test_exit=$?

          # Kill the proxy
          kill $proxy_pid
          wait $proxy_pid 2>/dev/null || true

          exit $test_exit
