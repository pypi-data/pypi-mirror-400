{"version":3,"file":"audioService-k6JHBynD.js","sources":["../../../../../../ComfyUI_frontend/src/services/audioService.ts"],"sourcesContent":["import { register } from 'extendable-media-recorder'\nimport { connect } from 'extendable-media-recorder-wav-encoder'\n\nimport { useToastStore } from '@/platform/updates/common/toastStore'\nimport { api } from '@/scripts/api'\n\nexport interface AudioRecordingError {\n  type: 'permission' | 'not_supported' | 'encoder' | 'recording' | 'unknown'\n  message: string\n  originalError?: unknown\n}\n\nlet isEncoderRegistered: boolean = false\n\nexport const useAudioService = () => {\n  const handleError = (\n    type: AudioRecordingError['type'],\n    message: string,\n    originalError?: unknown\n  ) => {\n    console.error(`Audio Service Error (${type}):`, message, originalError)\n  }\n\n  const stopAllTracks = (currentStream: MediaStream | null) => {\n    if (currentStream) {\n      currentStream.getTracks().forEach((track) => {\n        track.stop()\n      })\n      currentStream = null\n    }\n  }\n\n  const registerWavEncoder = async (): Promise<void> => {\n    if (isEncoderRegistered) {\n      return\n    }\n\n    try {\n      await register(await connect())\n      isEncoderRegistered = true\n    } catch (err) {\n      if (\n        err instanceof Error &&\n        err.message.includes('already an encoder stored')\n      ) {\n        isEncoderRegistered = true\n      } else {\n        handleError('encoder', 'Failed to register WAV encoder', err)\n      }\n    }\n  }\n\n  const convertBlobToFileAndSubmit = async (blob: Blob): Promise<string> => {\n    const name = `recording-${Date.now()}.wav`\n    const file = new File([blob], name, { type: blob.type || 'audio/wav' })\n\n    const body = new FormData()\n    body.append('image', file)\n    body.append('subfolder', 'audio')\n    body.append('type', 'temp')\n\n    const resp = await api.fetchApi('/upload/image', {\n      method: 'POST',\n      body\n    })\n\n    if (resp.status !== 200) {\n      const err = `Error uploading temp file: ${resp.status} - ${resp.statusText}`\n      useToastStore().addAlert(err)\n      throw new Error(err)\n    }\n\n    const tempAudio = await resp.json()\n\n    return `audio/${tempAudio.name} [temp]`\n  }\n\n  return {\n    // Methods\n    convertBlobToFileAndSubmit,\n    registerWavEncoder,\n    stopAllTracks\n  }\n}\n"],"names":["isEncoderRegistered","useAudioService","__name","handleError","type","message","originalError","blob","name","file","body","resp","api","err","useToastStore","register","connect","currentStream","track"],"mappings":"sLAYA,IAAIA,EAA+B,GAE5B,MAAMC,EAAkBC,EAAA,IAAM,CACnC,MAAMC,EAAcD,EAAA,CAClBE,EACAC,EACAC,IACG,CACH,QAAQ,MAAM,wBAAwBF,CAAI,KAAMC,EAASC,CAAa,CAAA,EALpD,eA8Db,MAAA,CAEL,2BA3BiCJ,EAAA,MAAOK,GAAgC,CACxE,MAAMC,EAAO,aAAa,KAAK,IAAA,CAAK,OAC9BC,EAAO,IAAI,KAAK,CAACF,CAAI,EAAGC,EAAM,CAAE,KAAMD,EAAK,MAAQ,WAAa,CAAA,EAEhEG,EAAO,IAAI,SACZA,EAAA,OAAO,QAASD,CAAI,EACpBC,EAAA,OAAO,YAAa,OAAO,EAC3BA,EAAA,OAAO,OAAQ,MAAM,EAE1B,MAAMC,EAAO,MAAMC,EAAI,SAAS,gBAAiB,CAC/C,OAAQ,OACR,KAAAF,CAAA,CACD,EAEG,GAAAC,EAAK,SAAW,IAAK,CACvB,MAAME,EAAM,8BAA8BF,EAAK,MAAM,MAAMA,EAAK,UAAU,GAC5D,MAAAG,EAAA,EAAE,SAASD,CAAG,EACtB,IAAI,MAAMA,CAAG,CACrB,CAIO,MAAA,UAFW,MAAMF,EAAK,QAEH,IAAI,SAAA,EAtBG,8BA4BjC,mBAhDyBT,EAAA,SAA2B,CACpD,GAAI,CAAAF,EAIA,GAAA,CACI,MAAAe,EAAS,MAAMC,EAAA,CAAS,EACRhB,EAAA,SACfa,EAAK,CAEVA,aAAe,OACfA,EAAI,QAAQ,SAAS,2BAA2B,EAE1Bb,EAAA,GAEVG,EAAA,UAAW,iCAAkCU,CAAG,CAEhE,CAAA,EAjByB,sBAiDzB,cA1DoBX,EAACe,GAAsC,CACvDA,IACFA,EAAc,UAAU,EAAE,QAASC,GAAU,CAC3CA,EAAM,KAAK,CAAA,CACZ,EACeD,EAAA,KAClB,EANoB,gBA0DpB,CAEJ,EArE+B"}