id: docker/secrets-in-image
name: Secrets baked into image
level: critical
category: security
description: |
  Secrets, API keys, or credentials should never be baked into Docker images.
  Anyone with access to the image can extract these secrets. Even if the secret
  is deleted in a later layer, it remains in the image history.
checklist:
  - ENV instruction contains sensitive values (passwords, tokens, keys).
  - COPY or ADD includes .env, credentials, or key files.
  - ARG is used to pass secrets that end up in the image.
  - Hardcoded credentials in configuration files being copied.
fix: |
  Use runtime environment variables, Docker secrets, or a secrets manager.
  For build-time secrets, use BuildKit's --mount=type=secret feature.

tags:
  - docker
  - security
  - secrets

triggers:
  file_patterns:
    - "**/Dockerfile"
    - "**/Dockerfile.*"
    - "**/*.dockerfile"
  code_patterns:
    - "ENV.*PASSWORD"
    - "ENV.*SECRET"
    - "ENV.*API_KEY"
    - "COPY.*\\.env"
    - "ARG.*PASSWORD"

examples:
  bad: |
    ENV DATABASE_PASSWORD=supersecret123
    COPY .env /app/.env
  good: |
    # Pass at runtime: docker run -e DATABASE_PASSWORD
    # Or use secrets: docker run --secret db_password
