# AviUtl2 プロジェクトファイル (.aup2) フォーマット仕様書

**バージョン**: 1.0
**最終更新**: 2025-12-27

---

## 1. ファイル形式

### 1.1 基本仕様

| 項目 | 仕様 |
|------|------|
| エンコーディング | UTF-8（BOMなし） |
| 改行コード | CRLF (`\r\n`) |
| 形式 | INI風テキストフォーマット |
| 構文 | `[セクション名]` + `キー=値` |

### 1.2 座標系

| 軸 | 方向 |
|----|------|
| X軸 | 右方向が正 |
| Y軸 | **上方向が正**（スクリーン座標とは逆） |
| Z軸 | **画面奥方向が正** |

### 1.3 レイヤーと奥行き

**レイヤー番号と描画順序**:
- レイヤー番号が大きいほど**上（手前）**に表示される
- Layer 0 → Layer 1 → Layer 2 の順で描画され、後から描画されたものが上に重なる

**典型的な配置**:
```
Layer 0: 背景、編集対象の動画
Layer 1: 画像、テキスト、アノテーション
Layer 2: さらに上に載せるコンテンツ
...
```

**カメラ制御との関係**:
- カメラ制御なし: Z座標の値は描画順序に影響しない。レイヤー番号のみで前後関係が決まる
- カメラ制御あり: カメラ制御オブジェクトより下のレイヤー（番号が大きいレイヤー）では、Z座標による3D的な奥行きが考慮される

### 1.4 全体構造

```
[project]           # プロジェクトメタデータ（1個）
[scene.N]           # シーン設定（N=0,1,2...）
[ObjectID]          # タイムラインオブジェクト（0,1,2...）
[ObjectID.EffectID] # エフェクト（0.0, 0.1, 1.0, 1.1, ...）
```

---

## 2. データ型

### 2.1 プロパティ値の型

プロパティ値には3種類の型がある：

| 型 | 説明 | 例 |
|----|------|-----|
| **StaticValue** | 静的な数値。小数点以下2桁で出力 | `100.00`, `0.00` |
| **AnimatedValue** | アニメーション値。開始値、終了値、移動タイプ、パラメータで構成 | `-100.00,100.00,直線移動,0` |
| **文字列** | 文字列値。そのまま出力 | `Yu Gothic UI`, `通常` |

### 2.2 StaticValue

単一の数値。出力時は小数点以下2桁に整形される。

```ini
拡大率=100.00
透明度=0.00
X=50.00
```

### 2.3 AnimatedValue

時間経過で値が変化するアニメーション値。

**フォーマット**: `<開始値>,<終了値>,<移動タイプ>,<パラメータ>`

```ini
X=-100.00,100.00,直線移動,0
拡大率=100.00,10.00,補間移動,0
透明度=0.00,100.00,反復移動,4|5
```

### 2.4 色値（重要）

**色は16進数文字列として格納される。数値ではない。**

```ini
色=ff0000          # 赤
文字色=ffffff      # 白
影色=000000        # 黒
```

**パーサー実装上の注意**: `"000000"` のような文字列が `float(0.0)` に変換されないよう、6桁の16進数文字列は必ず文字列として保持する。

**判定方法**: 値が6文字かつ全て `[0-9a-fA-F]` の場合は色値として扱う。

---

## 3. セクション詳細

### 3.1 [project] セクション

プロジェクト全体のメタデータ。ファイル先頭に1つだけ存在。

| キー | 型 | 説明 |
|------|-----|------|
| `version` | int | AviUtl2バージョン番号（例: `2001901`） |
| `file` | string | プロジェクトファイルの絶対パス |
| `display.scene` | int | 現在表示中のシーン番号 |

### 3.2 [scene.N] セクション

シーンごとの設定。N はシーン番号（0始まり）。

| キー | 型 | 説明 | 例 |
|------|-----|------|-----|
| `scene` | int | シーン番号 | `0` |
| `name` | string | シーン名 | `Root` |
| `video.width` | int | 横解像度（ピクセル） | `1920` |
| `video.height` | int | 縦解像度（ピクセル） | `1080` |
| `video.rate` | int | フレームレート（FPS） | `30` |
| `video.scale` | int | ビデオスケール | `1` |
| `audio.rate` | int | 音声サンプルレート（Hz） | `44100` |
| `cursor.frame` | int | カーソルのフレーム位置 | `0` |
| `cursor.layer` | int | カーソルのレイヤー位置 | `0` |
| `display.frame` | int | 表示開始フレーム | `0` |
| `display.layer` | int | 表示開始レイヤー | `0` |
| `display.zoom` | int | ズーム倍率（10000=100%） | `10000` |
| `display.order` | int | 表示順序 | `0` |
| `display.camera` | string | カメラ設定 | `` |
| `display.grid.x` | string | X軸グリッド設定 | `16,-16` |
| `display.grid.y` | string | Y軸グリッド設定 | `16,-16` |
| `display.grid.width` | int | グリッド幅 | `200` |
| `display.grid.height` | int | グリッド高さ | `200` |
| `display.grid.step` | float | グリッドステップ | `200.000000` |
| `display.grid.range` | float | グリッド範囲 | `10000.000000` |
| `display.tempo.bpm` | float | テンポ（BPM） | `120.000000` |
| `display.tempo.beat` | int | 拍子 | `4` |
| `display.tempo.offset` | float | テンポオフセット | `0.000000` |

### 3.3 [ObjectID] セクション

タイムライン上のオブジェクト。

| キー | 型 | 説明 |
|------|-----|------|
| `layer` | int | レイヤー番号（0始まり、大きいほど上に表示） |
| `frame` | string | フレーム範囲（`開始,終了` 形式） |
| `focus` | int | 選択状態（1=選択中、省略可） |

**重要なルール**:
- 同一レイヤー・同一時刻に複数オブジェクトは配置不可
- フレーム計算: `秒数 = (終了フレーム - 開始フレーム + 1) / video.rate`

### 3.4 [ObjectID.EffectID] セクション

オブジェクトに付属するエフェクト。

- **ObjectID.0**: メインエフェクト（動画ファイル、テキスト、図形など）
- **ObjectID.1**: 描画設定（標準描画、映像再生、音声再生）
- **ObjectID.2以降**: 追加フィルタ効果

---

## 4. エフェクト詳細

### 4.1 標準描画 (effect.name=標準描画)

すべてのオブジェクトに付与される基本的な描画設定。

```ini
effect.name=標準描画
X=0.00                    # X座標
Y=0.00                    # Y座標
Z=0.00                    # Z座標
Group=1                   # グループ番号
中心X=0.00                # 回転中心Xオフセット
中心Y=0.00                # 回転中心Yオフセット
中心Z=0.00                # 回転中心Zオフセット
X軸回転=0.00              # X軸周りの回転（3D回転）
Y軸回転=0.00              # Y軸周りの回転（3D回転）
Z軸回転=0.00              # Z軸周りの回転（2D平面回転）
拡大率=100.000            # 拡大率 (%)
縦横比=0.000              # アスペクト比
透明度=0.00               # 透明度 (0=不透明, 100=完全透明)
合成モード=通常           # 合成モード
```

**回転軸の違い**:
- **Z軸回転**: 2D平面上での回転（時計/反時計回り）
- **X軸回転/Y軸回転**: 3D回転（カードが裏返るようなエフェクト）

**中心X/Y/Z**: 回転中心のオフセット。オブジェクトの中心から回転軸をずらす。

**合成モード**: `通常`, `加算`, `減算`, `乗算`, `スクリーン`, `オーバーレイ`, `比較(明)`, `比較(暗)`, `輝度`, `色差`, `陰影`, `明暗`, `差分`

### 4.2 テキスト (effect.name=テキスト)

```ini
effect.name=テキスト
サイズ=34.00              # フォントサイズ
字間=0.00                 # 文字間隔
行間=0.00                 # 行間隔
表示速度=0.00             # 表示速度（0=即座に全表示）
フォント=Yu Gothic UI     # フォント名
文字色=ffffff             # 文字色（16進数文字列）
影・縁色=000000           # 影/縁の色（16進数文字列）
文字装飾=標準文字         # 装飾タイプ
文字揃え=左寄せ[上]       # 揃え位置
B=0                       # ボールド (0/1)
I=0                       # イタリック (0/1)
テキスト=内容             # 表示テキスト（\nで改行）
文字毎に個別オブジェクト=0
自動スクロール=0
移動座標上に表示=0
オブジェクトの長さを自動調節=0
```

**文字装飾**: `標準文字`, `影付き文字`, `影付き文字(薄)`, `縁取り文字`, `縁取り文字(細)`, `縁取り文字(太)`, `縁取り文字(角)`

**文字揃え**:
- 横書き: `左寄せ[上]`, `左寄せ[中]`, `左寄せ[下]`, `中央揃え[上]`, `中央揃え[中]`, `中央揃え[下]`, `右寄せ[上]`, `右寄せ[中]`, `右寄せ[下]`
- 縦書き: `縦書 上寄[右]`, `縦書 上寄[中]`, `縦書 上寄[左]`, `縦書 中央[右]`, `縦書 中央[中]`, `縦書 中央[左]`, `縦書 下寄[右]`, `縦書 下寄[中]`, `縦書 下寄[左]`

### 4.3 図形 (effect.name=図形)

```ini
effect.name=図形
図形の種類=円             # 図形タイプ
サイズ=100                # サイズ（バウンディングボックス）
縦横比=0.00               # アスペクト比
ライン幅=4000             # 線の太さ（4000=塗りつぶし）
色=ff0000                 # 色（16進数文字列）
角を丸くする=0            # 角丸 (0/1)
```

**図形の種類**: `円`, `四角形`, `三角形`, `五角形`, `六角形`, `星型`, `ハート`, `背景`

**サイズの意味**: サイズはバウンディングボックスの寸法。図形の重心がボックス中心に位置し、少なくとも1点が辺に接する。

### 4.4 動画ファイル (effect.name=動画ファイル)

```ini
effect.name=動画ファイル
再生位置=0.000,0.000,再生範囲,0
再生速度=100.00
ファイル=C:\path\to\video.mp4
トラック=0
ループ再生=0
音声付き=0
YUV=
```

### 4.5 画像ファイル (effect.name=画像ファイル)

```ini
effect.name=画像ファイル
ファイル=C:\path\to\image.png
表示番号=0
連番ファイル=0
```

### 4.6 音声ファイル (effect.name=音声ファイル)

```ini
effect.name=音声ファイル
再生位置=0.000,0.000,再生範囲,0
再生速度=100.00
ファイル=C:\path\to\audio.mp3
トラック=0
ループ再生=0
```

---

## 5. フィルタエフェクト

### 5.1 ドロップシャドウ

```ini
effect.name=ドロップシャドウ
X=5                       # X方向オフセット
Y=5                       # Y方向オフセット
濃さ=60.0                 # 影の濃さ
拡散=5                    # 拡散範囲
影色=000000               # 影の色（16進数文字列）
影を別オブジェクトで描画=0
```

### 5.2 縁取り

```ini
effect.name=縁取り
サイズ=5                  # 縁の太さ
ぼかし=0                  # ぼかし量
縁色=ffffff               # 縁の色（16進数文字列）
パターン画像=             # パターン画像パス（空=単色）
```

### 5.3 グロー

```ini
effect.name=グロー
強さ=50.00                # グローの強さ
拡散=60                   # 拡散範囲
角度=25.00                # 光の角度
しきい値=50.0             # しきい値
比率=100.0                # 比率
ぼかし=1                  # ぼかしタイプ
形状=クロス(4本)          # 形状
光色=                     # 光の色（空=自動）
光成分のみ=0
サイズ固定=0
```

### 5.4 ぼかし

```ini
effect.name=ぼかし
範囲=5.00                 # ぼかし範囲
縦横比=0.00               # 縦横比
光の強さ=0.0              # 光の強さ
サイズ固定=0              # サイズ固定
```

### 5.5 振動

```ini
effect.name=振動
X=10.0                    # X方向振幅
Y=10.0                    # Y方向振幅
Z=0.0                     # Z方向振幅
周期=1.0                  # 振動周期
ランダム=0.0              # ランダム度
複雑さ=0.0                # 複雑さ
```

---

## 6. 移動タイプ（モーション）

### 6.1 基本構文

**静的な値**:
```ini
X=0.00
```

**アニメーション値**:
```ini
X=開始値,終了値,移動タイプ,パラメータ
```

### 6.2 移動タイプ一覧

| 移動タイプ | 説明 | 例 |
|-----------|------|-----|
| `直線移動` | 線形補間 | `X=-100.00,100.00,直線移動,0` |
| `補間移動` | イージング付き補間 | `X=-100.00,100.00,補間移動,0` |
| `瞬間移動` | 即座に値が変化 | `X=-100.00,100.00,瞬間移動,0` |
| `反復移動` | 往復運動 | `X=0.00,100.00,反復移動,4\|5` |
| `回転` | 円周上の移動 | `X=0.00,0.00,回転,4\|360` |
| `ランダム移動` | ランダムな移動 | `X=-100.00,100.00,ランダム移動,0` |
| `加減速移動` | 加速・減速付き | `X=-100.00,100.00,加減速移動,0` |
| `曲線移動` | ベジエ曲線に沿った移動 | `X=-100.00,100.00,曲線移動,0` |
| `移動量指定` | 1フレームあたりの移動量 | `X=-100.00,10.00,移動量指定,4` |
| `直線移動(時間制御)` | ベジエ曲線で速度制御 | （後述） |
| `補間移動(時間制御)` | ベジエ曲線で速度制御 | （後述） |

### 6.3 回転モード詳細

回転モードは X, Y, Z すべてに同時に適用される。

**フォーマット**:
```ini
X=<中心X>,<初期X>,回転,<パラメータ>
Y=<中心Y>,<初期Y>,回転,<パラメータ>
Z=<中心Z>,<初期Z>,回転,<パラメータ>
```

**回転半径の計算**:
```
radius = sqrt((初期X - 中心X)^2 + (初期Y - 中心Y)^2 + (初期Z - 中心Z)^2)
```

**パラメータ形式**: `4|360|<ベジエ曲線プロファイル>`
- `4`: 制御点タイプ
- `360`: 回転角度（度）
- ベジエ曲線プロファイル: 回転速度/イージングの制御

**例** (中心(0,100,0)、初期位置(0,200,0)、半径100で公転):
```ini
X=0.00,0.00,回転,4|360|0,1,0.485532,-0.475783,1,0,0.484522,-0.481481
Y=100.00,200.00,回転,4|360|0,1,0.485532,-0.475783,1,0,0.484522,-0.481481
Z=0.00,0.00,回転,4|360|0,1,0.485532,-0.475783,1,0,0.484522,-0.481481
```

### 6.4 ベジエ曲線フォーマット

時間制御で使用されるベジエ曲線パラメータ。

**形式**: `左端点X,左端点Y,左接線X,左接線Y,右端点X,右端点Y,右接線X,右接線Y`

**座標系**:
- X軸: 右向きが正 (0=開始, 1=終了)
- Y軸: 下向きが正

---

## 7. エスケープ規則

### 7.1 テキスト内のエスケープシーケンス

| シーケンス | 意味 |
|-----------|------|
| `\n` | 改行 |
| `\\` | バックスラッシュ（リテラル） |

### 7.2 エスケープ不要な文字

以下の文字はテキスト値内でそのまま使用可能:
- `[` `]` - 角括弧
- `=` - 等号
- `/` - スラッシュ
- `!"#$%&'()@`+;:*{}<>?_` - その他の記号

### 7.3 パーサー実装上の注意

- `=` は最初の出現で key/value を分割（value内の`=`はそのまま）
- `[` `]` は行頭でセクションヘッダーとして解釈、それ以外は通常文字
- 複数行テキストは `\n` で表現（実際の改行ではない）

---

## 8. 最小プロジェクト構造

```ini
[project]
version=2001901
ファイル=C:\path\to\project.aup2
display.scene=0
[scene.0]
scene=0
name=Root
video.width=1920
video.height=1080
video.rate=30
video.scale=1
audio.rate=44100
cursor.frame=0
cursor.layer=0
display.frame=0
display.layer=0
display.zoom=10000
display.order=0
display.camera=
display.grid.x=16,-16
display.grid.y=16,-16
display.grid.width=200
display.grid.height=200
display.grid.step=200.000000
display.grid.range=10000.000000
display.tempo.bpm=120.000000
display.tempo.beat=4
display.tempo.offset=0.000000
```

---

## 9. 実装上の注意点

### 9.1 色値の取り扱い

色は必ず**16進数文字列**として扱う。パーサーで `"000000"` が `float(0.0)` に変換されないよう注意。

**判定ロジック**:
```python
if len(value_str) == 6 and all(c in "0123456789abcdefABCDEF" for c in value_str):
    return value_str  # 文字列として返す
```

### 9.2 浮動小数点数の出力

数値は小数点以下2桁で出力する：
```python
def format_float(v: float) -> str:
    if v == int(v):
        return f"{int(v)}.00"
    return f"{v:.2f}"
```

### 9.3 プロパティ名

AviUtl2は日本語のプロパティ名を使用する。内部名（type, color, blend等）ではなく、日本語名（図形の種類, 色, 合成モード等）を使用すること。

### 9.4 改行コード

出力時は必ずCRLF (`\r\n`) を使用すること。

---

## 10. 変更履歴

| バージョン | 日付 | 内容 |
|-----------|------|------|
| 0.1 | 2025-12-25 | 初版作成 |
| 0.2 | 2025-12-25 | アニメーション構文、エスケープ規則を追加 |
| 0.3 | 2025-12-26 | フィルタ一覧、移動タイプ一覧を追加 |
| 1.0 | 2025-12-27 | データ型仕様を詳細化、座標系・回転モード・実装注意点を追加 |
