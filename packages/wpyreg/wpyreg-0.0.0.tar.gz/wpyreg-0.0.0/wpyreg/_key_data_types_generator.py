import os
import json
import marshmallow_dataclass
import textwrap

_SCRIPT_DIR = os.path.normpath(os.path.dirname(os.path.realpath(__file__))).replace('\\', '/')

# Structure of json:
# {
#   "sections": [
#     "name": "section name",
#     "comment": "section commend",
#     "values": [
#        {
#          "name": "key name",
#          "value":  "key value"
#          "comment": "key comment" | None
#        },
#        ...
#     ],
#     ...
#   ]
# }

#TODO: use std only instead of marshmallow_dataclass
@marshmallow_dataclass.dataclass
class ValueDataTypesValue:
    name: str
    value: str
    comment: str | None

@marshmallow_dataclass.dataclass
class ValueDataTypesSection:
    name: str
    comment: str | None
    values: list[ValueDataTypesValue]

@marshmallow_dataclass.dataclass
class ValueDataTypes:
    sections: list[ValueDataTypesSection]

def _generate_enum_constants(sections: list[ValueDataTypesSection], indent: str, generated_lines: list[str]):
    for section in sections:
        generated_lines += [
            f"{indent}# Section name: {section.name}"
        ]
        if section.comment is not None:
            for line in section.comment.splitlines():
                generated_lines += [
                    f"{indent}# {line}"
                ]
        for value in section.values:
            if value.comment is not None:
                for line in value.comment.splitlines():
                    generated_lines += [
                        f"{indent}# {line}"
                    ]
            generated_lines += [
                f"{indent}{value.name} = enum.auto()"
            ]
    generated_lines += [
        f"{indent}# When guesses don't work \n"
        f"{indent}NOT_RECOGNIZED = enum.auto()\n"
    ]


def _generate_from_native_data_type_int(sections: list[ValueDataTypesSection], indent: str, generated_lines: list[str]):
    preamble = """
        @staticmethod
        def from_native_data_type_int(data_type: int) -> 'ValueDataType':
            match data_type:
    """
    preamble = textwrap.dedent(preamble).strip()
    preamble = textwrap.indent(preamble, indent)
    generated_lines += preamble.splitlines()
    
    for section in sections:
        for value in section.values:
            generated_lines += [
                f"{indent * 3}case {value.value}: return ValueDataType.{value.name}"
            ]
    generated_lines += [
        f'{indent * 2}_error_log(f"from_native_data_type_int(): Unknown data_type: {{data_type}}: 0x{{data_type:X}}")',
        f'{indent * 2}return ValueDataType.NOT_RECOGNIZED\n'
    ]

def _generate_to_strings_and_repr(sections: list[ValueDataTypesSection], indent: str, generated_lines: list[str]):
    preamble = """
        def __str__(self):
            return self.to_string()
        
        def __repr__(self):
            return self.to_string()

        def to_string(self) -> str:
            match self:
    """
    preamble = textwrap.dedent(preamble).strip()
    preamble = textwrap.indent(preamble, indent)
    generated_lines += preamble.splitlines()

    for section in sections:
        for value in section.values:
            generated_lines += [
                f'{indent * 3}case self.{value.name}: return "{value.name}"'
            ]
    generated_lines += [
        f'{indent * 2}raise Exception(f"ValueDataType().to_string({{self.name}}) not recognized")',
    ]


def generate_key_data_types():
    START_TAG = "#SYSYIMP_VALUEDATATYPE_AUTOGENERATED_START"
    END_TAG =   "#SYSYIMP_VALUEDATATYPE_AUTOGENERATED_END"
    INDENT = "    "

    
    with open(f'{_SCRIPT_DIR}/key_data_types.json', "r", encoding="utf-8") as file:
        keys_json = json.load(file)
        data: ValueDataTypes = marshmallow_dataclass.class_schema(ValueDataTypes)().load(keys_json)

    generated_lines = [
        'class ValueDataType(enum.Enum):'
    ]
    
    _generate_enum_constants(data.sections, INDENT, generated_lines)
    _generate_from_native_data_type_int(data.sections, INDENT, generated_lines)
    _generate_to_strings_and_repr(data.sections, INDENT, generated_lines)
    

    DIFF_FILE_PATH = f'{_SCRIPT_DIR}/diff.py'
    
    with open(DIFF_FILE_PATH, "r", encoding="utf-8") as file:
        text = file.read()
    
    text_replace_start_index = text.find(START_TAG) + len(START_TAG) + 1
    text_replace_end_index = text.find(END_TAG, text_replace_start_index) - 1
    new_text = ''.join([
        text[0:text_replace_start_index],
        '\n'.join(generated_lines),
        '\n',
        text[text_replace_end_index + 1:]
    ])

    with open(DIFF_FILE_PATH, "w", encoding="utf-8") as file:
        file.write(new_text)