import sys
import shutil
from pathlib import Path
from typing import Any, TypedDict, Final

if sys.version_info >= (3, 11):
    import tomllib
    from typing import NotRequired
else:
    import tomli as tomllib
    from typing_extensions import NotRequired

from hatchling.builders.hooks.plugin.interface import BuildHookInterface


class BMPBlock(TypedDict):
    symbol: str
    promote: NotRequired[list[int]]
    range_start: int
    range_end: int


class BMPToml(dict[str, BMPBlock]): ...


class CustomHook(BuildHookInterface):
    _TAB_SIZE: Final[int] = 4
    _TAB: Final[str] = " " * _TAB_SIZE
    _GENERATION_NOTE: Final[str] = f"Auto generated by `{Path(__file__).name}`"
    _BLOCK_HEADER: Final[str] = "\n".join(
        [
            f"# {_GENERATION_NOTE}",
            "",
            "from typing import TypeAlias as _TypeAlias, Literal as _Literal",
            "\n",
        ]
    )
    _BLOCK_ASSIGNMENT: Final[str] = ": _TypeAlias = "
    _CHAR_UNION_SYMBOL: Final[str] = "Char"

    def initialize(
        self,
        _version: str,
        _build_data: dict[str, Any],
    ) -> None:
        self.project_dir = Path(self.root)
        self.src_dir = self.project_dir / "src"
        self.bmp_path = self.src_dir / "bmp.toml"
        self.init_template_file = self.src_dir / "__init__.py.template"
        self.symbols_template_path = self.src_dir / "_symbols.py.template"
        self.block_template_path = self.src_dir / "generic_block.template"
        self.package_dir = self.src_dir / "char_literal"
        self.init_file = self.package_dir / "__init__.py"
        self.generated_dir = self.package_dir / "_generated"
        self.symbols_path = self.package_dir / "_symbols.py"

        if self.package_dir.exists():  # Remove generated source if exists
            shutil.rmtree(self.package_dir)

        toml = self._load_toml()
        self._generate_init_file(toml)
        self._generate_symbol_file(toml)
        self._generate_blocks(toml)

    def _load_toml(self) -> BMPToml:
        with self.bmp_path.open("br") as toml_file:
            return BMPToml(
                **tomllib.load(toml_file),
            )

    def _generate_init_file(self, toml: BMPToml) -> None:
        template = self.init_template_file.read_text(encoding="utf-8")
        init_content = template.format(
            generation_note=self._GENERATION_NOTE,
            tab=self._TAB,
            char_union_symbol=self._CHAR_UNION_SYMBOL,
            listed_symbols=(
                "\n".join(f"- `{block['symbol']}`," for block in toml.values())
            ),
            quoted_symbols=(
                "\n".join(f'{self._TAB}"{block["symbol"]}",' for block in toml.values())
            ),
            imported_symbols=(
                "\n".join(
                    (
                        f"from .{self.symbols_path.stem} import {self._CHAR_UNION_SYMBOL}",
                        *(
                            f"from .{self.symbols_path.stem} import {block['symbol']}"
                            for block_name, block in toml.items()
                        ),
                    )
                )
            ),
        )
        self.init_file.parent.mkdir(parents=True, exist_ok=True)
        self.init_file.write_text(init_content, encoding="utf-8")

    def _generate_symbol_file(self, toml: BMPToml) -> None:
        template = self.symbols_template_path.read_text(encoding="utf-8")
        symbols_content = template.format(
            generation_note=self._GENERATION_NOTE,
            tab=self._TAB,
            char_union_symbol=self._CHAR_UNION_SYMBOL,
            char_union_definition="|".join(block["symbol"] for block in toml.values()),
            imported_symbols="\n".join(
                (
                    f"{self._TAB}from .{self.generated_dir.stem}.{block_name} import {block['symbol']}"
                    for block_name, block in toml.items()
                )
            ),
            placeholder_symbols="\n".join(
                (f"{self._TAB}{block['symbol']} = None" for block in toml.values())
            ),
        )
        self.symbols_path.parent.mkdir(parents=True, exist_ok=True)
        self.symbols_path.write_text(symbols_content, encoding="utf-8")

    def _generate_blocks(self, toml: BMPToml) -> None:
        self.generated_dir.mkdir(parents=True, exist_ok=True)
        for block_name, block in toml.items():
            block_path = self.generated_dir.joinpath(block_name).with_suffix(".py")
            with block_path.open("w", encoding="utf-8") as block_file:
                block_file.write(self._BLOCK_HEADER)
                block_file.write(block["symbol"])
                block_file.write(self._BLOCK_ASSIGNMENT)
                block_file.write("[")
                for promoted_codepoint in block.get("promote", ()):
                    char = chr(promoted_codepoint)
                    block_file.write(repr(char))
                    block_file.write(",")
                for codepoint in range(block["range_start"], block["range_end"]):
                    if codepoint in block.get("promote", ()):
                        continue
                    char = chr(codepoint)
                    block_file.write(repr(char))
                    block_file.write(",")
                block_file.write("]")
