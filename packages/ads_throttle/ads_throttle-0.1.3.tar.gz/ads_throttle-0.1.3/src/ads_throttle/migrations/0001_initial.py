# Generated by Django 5.2.9 on 2025-12-30 18:44

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name="SiteSetting",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "view_repeat_window_seconds",
                    models.PositiveIntegerField(
                        default=600,
                        help_text="Time window in seconds for counting ad impressions.",
                        verbose_name="View window (seconds)",
                    ),
                ),
                (
                    "view_repeat_threshold",
                    models.PositiveIntegerField(
                        default=20,
                        help_text="How many ad impressions are allowed within the window before blocking.",
                        verbose_name="View threshold",
                    ),
                ),
                (
                    "block_seconds",
                    models.PositiveIntegerField(
                        default=3600,
                        help_text="How long to block ads after the threshold is reached, in seconds.",
                        verbose_name="Block duration (seconds)",
                    ),
                ),
                (
                    "event_record_seconds",
                    models.PositiveIntegerField(
                        default=60,
                        help_text="How often (in seconds) to update block counters for a single viewer/page pair.",
                        verbose_name="Event record interval (seconds)",
                    ),
                ),
                (
                    "updated_at",
                    models.DateTimeField(auto_now=True, verbose_name="Updated at"),
                ),
            ],
            options={
                "verbose_name": "Ads throttle setting",
                "verbose_name_plural": "Ads throttle settings",
            },
        ),
        migrations.CreateModel(
            name="AdsThrottleEvent",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                ("scope", models.CharField(max_length=512, verbose_name="Scope")),
                (
                    "viewer_hash",
                    models.CharField(max_length=64, verbose_name="Viewer hash"),
                ),
                (
                    "ip_address_hash",
                    models.CharField(
                        blank=True, max_length=64, verbose_name="IP address hash"
                    ),
                ),
                ("first_seen", models.DateTimeField(verbose_name="First seen")),
                ("last_seen", models.DateTimeField(verbose_name="Last seen")),
                ("count", models.PositiveIntegerField(default=0, verbose_name="Count")),
                ("blocked", models.BooleanField(default=False, verbose_name="Blocked")),
            ],
            options={
                "verbose_name": "Ads throttle event",
                "verbose_name_plural": "Ads throttle events",
                "indexes": [
                    models.Index(
                        fields=["scope", "blocked", "last_seen"],
                        name="ads_throttl_scope_0356bb_idx",
                    ),
                    models.Index(
                        fields=["viewer_hash"], name="ads_throttl_viewer__08ca4e_idx"
                    ),
                    models.Index(
                        fields=["ip_address_hash"],
                        name="ads_throttl_ip_addr_6f10bf_idx",
                    ),
                ],
                "unique_together": {("scope", "viewer_hash")},
            },
        ),
        migrations.CreateModel(
            name="AdsThrottleOverride",
            fields=[
                (
                    "id",
                    models.BigAutoField(
                        auto_created=True,
                        primary_key=True,
                        serialize=False,
                        verbose_name="ID",
                    ),
                ),
                (
                    "scope",
                    models.CharField(
                        blank=True,
                        help_text="Page path or empty to apply site-wide.",
                        max_length=512,
                        verbose_name="Scope",
                    ),
                ),
                (
                    "viewer_id",
                    models.CharField(
                        blank=True,
                        help_text="Format: user:<id> or session:<key>.",
                        max_length=255,
                        verbose_name="Viewer ID",
                    ),
                ),
                (
                    "ip_address_hash",
                    models.CharField(
                        blank=True,
                        help_text="SHA256 hash of the IP address.",
                        max_length=64,
                        verbose_name="IP address hash",
                    ),
                ),
                (
                    "force_show",
                    models.BooleanField(default=False, verbose_name="Force show"),
                ),
                (
                    "force_block",
                    models.BooleanField(default=False, verbose_name="Force block"),
                ),
                (
                    "expires_at",
                    models.DateTimeField(
                        blank=True, null=True, verbose_name="Expires at"
                    ),
                ),
                (
                    "created_at",
                    models.DateTimeField(auto_now_add=True, verbose_name="Created at"),
                ),
                (
                    "updated_at",
                    models.DateTimeField(auto_now=True, verbose_name="Updated at"),
                ),
                (
                    "user",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="ads_throttle_overrides",
                        to=settings.AUTH_USER_MODEL,
                        verbose_name="User",
                    ),
                ),
            ],
            options={
                "verbose_name": "Ads throttle override",
                "verbose_name_plural": "Ads throttle overrides",
                "indexes": [
                    models.Index(
                        fields=["scope", "viewer_id", "expires_at"],
                        name="ads_thrott_scope_1ff7d4_idx",
                    ),
                    models.Index(
                        fields=["scope", "ip_address_hash", "expires_at"],
                        name="ads_thrott_scope_a6fb08_idx",
                    ),
                    models.Index(
                        fields=["scope", "user", "expires_at"],
                        name="ads_thrott_scope_f40e50_idx",
                    ),
                ],
            },
        ),
    ]
