name: Build and Publish

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      publish_to_pypi:
        description: 'Publish to PyPI (temporary)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: Build package
        run: |
          uv build --wheel
      
      - name: List built artifacts
        run: |
          ls -lh dist/
      
        # Publish to PyPI (temporary)
      - name: Publish to PyPI
        if: (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to_pypi == 'true') || github.event_name == 'release'
        run: |
          uv publish \
            --publish-url https://upload.pypi.org/legacy/ \
            --username __token__ \
            --password ${{ secrets.PYPI_API_TOKEN }} \
            dist/ml_workbench-*.whl

      # Publish to CodeArtifact (proprietary)
      - name: Configure AWS credentials for CodeArtifact
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1
      
    #   - name: Get CodeArtifact authorization token
    #     id: codeartifact-token
    #     run: |
    #       TOKEN=$(aws codeartifact get-authorization-token \
    #         --domain pheno \
    #         --domain-owner 471112612782 \
    #         --region eu-west-1 \
    #         --query authorizationToken \
    #         --output text)
    #       echo "token=$TOKEN" >> $GITHUB_OUTPUT
      
    #   - name: Publish to CodeArtifact
    #     run: |
    #       uv publish \
    #         --publish-url https://pheno-471112612782.d.codeartifact.eu-west-1.amazonaws.com/pypi/pheno-pip/ \
    #         --username aws \
    #         --password ${{ steps.codeartifact-token.outputs.token }} \
    #         dist/ml_workbench-*.whl
      

