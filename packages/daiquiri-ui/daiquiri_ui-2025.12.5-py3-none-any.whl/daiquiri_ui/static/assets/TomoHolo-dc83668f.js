import{j as e,a$ as W,b0 as Y,r as h,F as B,o as Q,I as Z,B as w,l as U,b1 as X,aX as J,aS as P,b2 as ee,u as te,b3 as se,b4 as ne,A as V,R,C as x,b5 as L,g as re,aL as ae,b6 as oe,b7 as ie,aP as le,a1 as ce,aw as de,q as ue}from"./index-4cf586ed.js";import{g as me}from"./geometry-252a228f.js";function pe(s){const{hardware:t}=s,n=t.online?t.properties.state:"OFFLINE",r={READY:"success",MOVING:"warning",STABILIZING:"warning",INVALID:"danger",INVALID_DETECTOR_BINNING_CHANGED:"danger",INVALID_DETECTOR_DISTANCE_CHANGED:"danger",INVALID_DETECTOR_CHANGED:"danger"},l=r[n]||r.UNKNOWN;return e.jsx(W,{state:n,minWidth:6,variant:l})}function xe(s){return s.type==="tomoholo"}function fe(s){const t=Y(s);return t===null||!xe(t)?null:t}function he(){const[s,t]=h.useState(!1),n=h.useRef(null),r=()=>t(!0),l=()=>t(!1);return h.useEffect(()=>{const a=n.current;return a?(a.addEventListener("mouseover",r),a.addEventListener("mouseout",l),()=>{a.removeEventListener("mouseover",r),a.removeEventListener("mouseout",l)}):()=>{}},[n.current]),[n,s]}function G(s){const{coef:t=1}=s,n=h.useRef(null),[r,l]=h.useState(!1),[a,u]=h.useState(!1);function m(i){if(i===null)return"";const c=i*t;return s.precision!==void 0?c.toFixed(s.precision):c.toString()}h.useEffect(()=>{n.current&&(n.current.value=m(s.value),l(!1))},[s.value,s.precision]);function o(i){const c=m(i);n!=null&&n.current&&(n.current.value=c)}function d(i){function c(){try{return Number.parseFloat(i.target.value)/t}catch{return null}}switch(i.key){case"Enter":{l(!1);const f=c(),g=s.onValidate(f);g&&g.catch(()=>{u(!0),setTimeout(()=>{o(s.value),u(!1)},2e3)}),i.preventDefault(),i.stopPropagation();break}case"Esc":case"Escape":r&&(u(!1),l(!1),o(s.value)),i.target.blur(),i.preventDefault(),i.stopPropagation();break}}function v(i){var c;l(i.target.value!==((c=s.value)==null?void 0:c.toString()))}return e.jsx(B.Control,{className:Q({"form-control-edited":r,"form-control-error":a}),type:"number",ref:n,onChange:v,onKeyDown:d,disabled:s.readOnly,step:s.step})}function ge(s){const{value:t,onValueChanged:n,disabled:r=!1}=s;return e.jsxs(Z,{children:[e.jsx(B.Control,{value:`${t??""}`,disabled:r,readOnly:!0}),e.jsx(w,{variant:t===2?"primary":"secondary",onClick:()=>{n(2)},disabled:r,children:"2"}),e.jsx(w,{variant:t===3?"primary":"secondary",onClick:()=>{n(3)},disabled:r,children:"3"}),e.jsx(w,{variant:t===4?"primary":"secondary",onClick:()=>{n(4)},disabled:r,children:"4"}),e.jsx(w,{variant:t===5?"primary":"secondary",onClick:()=>{n(5)},disabled:r,children:"5"})]})}function je(s){const{style:t,position:n,distances:r,className:l,thumbClassName:a,thumbStyle:u={},thumbTitle:m}=s,o=h.useMemo(()=>{const i=[];if(r.length>1){const c=r[0].position,f=r[1].position;i.push(c-(f-c)*.5)}for(const c of r)i.push(c.position);if(r.length>1){const c=r[r.length-2].position,f=r[r.length-1].position;i.push(f+(f-c)*.5)}return i},[r]),d=h.useMemo(()=>{if(n===null)return null;let i=o.length;for(const[b,C]of o.entries())if(n<C){i=b-1;break}if(i<=-1)return .5;if(i>=o.length)return o.length+.5;const c=o[i],f=o[i+1],g=(n-c)/(f-c),T=i===0?-.5:i,_=i===o.length-2?o.length-.5:i+1;return T*(1-g)+_*g},[o,n]);if(d===null)return e.jsx(e.Fragment,{});const v=U.clamp((d-.5)/(o.length-2),0,1)*100;return e.jsx("div",{className:`multi-linear-range ${l}`,style:t,children:e.jsx("i",{className:`${a}`,style:{...u,left:`${v}%`},title:m})})}ae("daiquiri.components.tomo.TomoDetector");function H(s,t,n,r){return h.useMemo(()=>{function l(m){return m==="um"?"μm":m}function a(m){return r<=0?m.toFixed(r):m.toFixed(r).replace(/\.?0+$/,"")}if(s===null)return"∅";if(t===n)return`${a(s)} ${l(n)}`;const u=le(s,t);return`${a(u.to(n).scalar)} ${l(n)}`},[s,t,n,r])}function ve(s){return s==null?null:s.replace("hardware:","")}function Ne(s){var O,A,S,k,M;const{distance:t,tomoDetector:n,moveToPosition:r,disabled:l=!1,gridColumn:a,stabilizing:u=!1,allowMoveOnFocus:m,sx:o}=s,[d,v]=he(),{onEnter:i,onLeave:c}=s,f=oe(ve((n==null?void 0:n.properties.detector)??null)),g=(f==null?void 0:f.properties.size)??[0,0],T=t.pixel_size*g[0],_=((O=o==null?void 0:o.properties)==null?void 0:O.tolerance)??.001,b=((A=o==null?void 0:o.properties)==null?void 0:A.display_digits)??3,C=((S=o==null?void 0:o.properties)==null?void 0:S.position)??null,$=((k=o==null?void 0:o.properties)==null?void 0:k.limits)??[0,1],z=((M=o==null?void 0:o.properties)==null?void 0:M.unit)??"mm",D=C!==null?Math.abs(t.position-C)<_:!1,j=t.position>=$[0]&&t.position<=$[1],N=t.distanceName==="focal",I=D?u?"warning":"primary":j?"secondary":"danger",E=j?"":"Position is outside of the axis limits";function F(){return N?e.jsx("h5",{className:"py-1",children:"Focal"}):e.jsx("h5",{className:`rounded-4 bg-${I} text-bg-${I} py-1`,children:`Distance ${t.distanceNum}`})}h.useEffect(()=>{v?i==null||i():c==null||c()},[v]);const p=H(t.z1,"mm","um",b-3),y=H(t.pixel_size,"um","nm",3),q=H(T,"um","um",3),K=H(t.position,z,z,b);return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{gridColumn:a,gridRow:1},className:"text-center",title:E,children:e.jsx(F,{})}),e.jsx("div",{style:{gridColumn:a,gridRow:2},className:"text-center",children:p}),e.jsx("div",{style:{gridColumn:a,gridRow:3},className:"text-center",children:!N&&`${y}`}),e.jsx("div",{style:{gridColumn:a,gridRow:4},className:"text-center",children:!N&&`${q}`}),e.jsx("div",{style:{gridColumn:a,gridRow:6},title:E,className:`text-center ${j?"":"text-danger"}`,children:K}),e.jsx("div",{style:{gridColumn:a,gridRow:7},title:`${j?"":"Position is outside of the axis limits"}${j&&u?"Waiting for stabilization":""}`,children:!(N&&!m)&&e.jsx(w,{ref:d,className:"w-100",variant:D?u?"warning":"primary":"secondary",onClick:()=>{r(t.distanceName)},disabled:l||!j||u,children:"Move to"})})]})}function ye(s){const{tomoDetector:t,gridColumn:n}=s;if(t===null)return e.jsx(e.Fragment,{});function r(){return((t==null?void 0:t.properties.detector)??"").replace("hardware:","")}const l=r(),a=t.properties.source_distance;return e.jsxs(e.Fragment,{children:[e.jsx("div",{style:{gridColumn:n,gridRow:1},className:"text-center",children:e.jsx("h5",{className:"py-1",children:"Detector"})}),e.jsx("div",{style:{gridColumn:n,gridRow:2},className:"text-center",children:a&&e.jsxs(e.Fragment,{children:[a.toFixed(2)," mm"]})}),e.jsxs("div",{style:{gridColumn:n,gridRow:5,zIndex:1},className:"text-center text-middle my-auto",children:[e.jsx("img",{className:"mx-auto my-auto",src:"resources/tomo/holo-detector.png",alt:"Detector",style:{gridColumn:7,gridRow:2,width:"92px",height:"92px",zIndex:0,imageRendering:"pixelated"}}),e.jsx("br",{}),l]})]})}function we(s){const t=s.includes("_hd.")?"default":"pixelated";return{"--sprite-sheet":`url(${s})`,"--spritesheet-rendering":t}}function be(s,t){var a;const n=ie(((a=s==null?void 0:s.properties.sample_stage)==null?void 0:a.slice(9))??null),r=(n==null?void 0:n.properties.x_axis_focal_pos)??null,l=(t==null?void 0:t.properties.distances)??[];return h.useMemo(()=>{const u=[];r&&u.push({distanceName:"focal",distanceNum:-1,pixel_size:0,position:r,z1:0});for(const[m,o]of l.entries())u.push({...o,distanceName:`dist${m+1}`,distanceNum:m+1});return u},[r,l])}function Ce(s){var j,N,I,E,F;const{options:t}=s,{tomoconfig:n}=t,r=X(n??""),l=J(n??""),a=fe((l==null?void 0:l.holotomo)??null),u=P((a==null?void 0:a.id)??null),m=ee((l==null?void 0:l.tomoDetector)??null),o=te(),d=se((l==null?void 0:l.sx)??null),v=P((d==null?void 0:d.id)??null),i=(d==null?void 0:d.properties.state[0])==="MOVING",c=be(r,a),[f,g]=h.useState(!1),_=((j=ne().avatar)==null?void 0:j.sprite_sheet)??"resources/tomo/fox-yellow.png";if(!a)return e.jsx(V,{variant:"warning",children:"No holotomo object found"});function b(p){u.call("move",p)}const C=f;function $(){if(d===null)return"tomo-avatar";if(!i)return C?"tomo-avatar stand":"tomo-avatar";const p=d.properties;return p.position===null||p.target===null?"tomo-avatar":p.position<p.target?"tomo-avatar walk-right":p.position>p.target?"tomo-avatar walk-left":"tomo-avatar"}const z=$(),D=me(d,"sx");return e.jsxs("div",{className:"w-100",style:{flex:"1 1 0%",display:"flex",flexDirection:"column"},children:[e.jsx("h2",{children:"Configuration"}),e.jsxs(R,{className:"g-0",children:[e.jsx(x,{className:"p-1 text-nowrap my-auto",xs:2,children:e.jsx("div",{children:"State"})}),e.jsx(x,{className:"p-1",xs:3,children:e.jsx(pe,{hardware:a})})]}),e.jsxs(R,{className:"g-0",children:[e.jsx(x,{className:"p-1 text-nowrap my-auto",xs:2,children:e.jsx("div",{children:"Nb distances"})}),e.jsx(x,{className:"p-1",xs:3,children:e.jsx(ge,{value:(N=a.properties)==null?void 0:N.nb_distances,onValueChanged:p=>{u.setProperty("nb_distances",p)},disabled:!o})})]}),e.jsxs(R,{className:"g-0",children:[e.jsx(x,{className:"p-1 text-nowrap my-auto",xs:2,children:e.jsx("div",{children:"Pixel size"})}),e.jsx(x,{className:"p-1",xs:3,children:e.jsx(G,{value:(I=a.properties)==null?void 0:I.pixel_size,onValidate:p=>{u.setProperty("pixel_size",p)},coef:1e3,readOnly:!o})}),e.jsx(x,{className:"p-1 text-nowrap my-auto",xs:1,children:e.jsx("div",{title:"Nanometer",children:"nm"})}),e.jsx(x,{className:"p-1",xs:1,children:e.jsx(w,{variant:"secondary",onClick:()=>{u.setProperty("pixel_size",null)},disabled:!o||(((E=a.properties)==null?void 0:E.pixel_size)??null)===null,children:e.jsx("i",{className:"fa fa-trash"})})})]}),e.jsxs(R,{className:"g-0",children:[e.jsx(x,{className:"p-1 text-nowrap my-auto",xs:2,children:e.jsxs("div",{children:["Sample position (",D,")"," ",d!==null&&e.jsx(L,{id:d==null?void 0:d.id,options:{header:"none",variant:"state"}})]})}),e.jsx(x,{className:"p-1 text-nowrap my-auto",xs:3,children:e.jsx("div",{children:d!==null&&e.jsx(L,{id:d==null?void 0:d.id,options:{header:"none"}})})}),e.jsx(x,{className:"p-1 text-nowrap my-auto",xs:1}),e.jsx(x,{className:"p-1",xs:1,children:e.jsx(w,{style:{visibility:i?"visible":"hidden"},variant:"danger",onClick:()=>{v.call("stop")},disabled:!o,children:e.jsx("i",{className:"fa fa-xmark"})})})]}),e.jsxs(R,{className:"g-0",children:[e.jsx(x,{className:"p-1 text-nowrap my-auto",xs:2,children:e.jsxs("div",{children:["Settle time",e.jsx("br",{}),e.jsx("small",{children:"(used during acquisition)"})]})}),e.jsx(x,{className:"p-1",xs:3,children:e.jsx(G,{value:(F=a.properties)==null?void 0:F.settle_time,onValidate:p=>{u.setProperty("settle_time",p)},readOnly:!o})}),e.jsx(x,{className:"p-1 text-nowrap my-auto",xs:1,children:e.jsx("div",{title:"Second",children:"s"})})]}),e.jsx("h2",{children:"Distances"}),c.length===0&&e.jsx(V,{variant:"warning",children:"No distances are setup"}),c&&c.length>0&&e.jsxs(re,{style:{display:"grid",gridGap:5,gridTemplateColumns:`auto 1fr 1fr ${"2fr ".repeat(c.length)}`},children:[e.jsx("div",{style:{gridColumn:1,gridRow:1},children:" "}),e.jsx("div",{style:{gridColumn:1,gridRow:2},className:"text-end",title:"Distance from the focal plan",children:"Distance"}),e.jsx("div",{style:{gridColumn:1,gridRow:3},className:"text-end",children:"Pixel size"}),e.jsx("div",{style:{gridColumn:1,gridRow:4},className:"text-end",children:"Field of view"}),e.jsxs("div",{style:{gridColumn:1,gridRow:6},className:"text-end",title:"Position in the x-translation axis",children:[D," position"]}),c.map((p,y)=>e.jsx(Ne,{gridColumn:`${y===0?y+2:y+3} / ${y+4}`,distance:p,tomoDetector:m,moveToPosition:b,disabled:!o||a.properties.state!=="READY",sx:d,stabilizing:a.properties.state==="STABILIZING",onEnter:()=>g(!0),onLeave:()=>g(!1),allowMoveOnFocus:t.enable_move_on_focal_plan??!0},y)),e.jsx("img",{className:"w-100 my-auto",alt:"Beam",src:"resources/tomo/holo-beam.svg",style:{gridColumn:`3 / ${c.length+4}`,gridRow:5,height:"8em",zIndex:0,objectFit:"fill"}}),e.jsx(je,{thumbClassName:`${z}`,style:{gridColumn:`2 / ${c.length+3}`,gridRow:5,zIndex:1},thumbStyle:we(_),thumbTitle:"I am the sample",variant:i?"info":"primary",position:(d==null?void 0:d.properties.position)??null,distances:c}),e.jsx(ye,{tomoDetector:m,gridColumn:c.length+3})]})]})}function _e(s){return e.jsx(Ce,{...s})}function Ee(s){const{yamlNode:t,tomoconfig:n,enable_move_on_focal_plan:r,...l}=s;ce(t,"tomoconfig",n),de(t,"enable_move_on_focal_plan",r),ue(t,l);const a={tomoconfig:n,enable_move_on_focal_plan:r};return e.jsx(_e,{options:a})}export{Ee as default};
