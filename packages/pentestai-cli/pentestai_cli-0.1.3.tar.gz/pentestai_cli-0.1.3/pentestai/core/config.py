from __future__ import annotations

import os
from pathlib import Path
from typing import Dict, List, Optional

import yaml
from dotenv import load_dotenv
from pydantic import BaseModel, Field

load_dotenv()
# Models
class ProviderCfg(BaseModel):
    api_key_env: str
    model: str
    base_url: str


class AIConfig(BaseModel):
    default_provider: str
    fallback_providers: List[str] = []
    routing: Dict[str, List[str]] = {}
    providers: Dict[str, ProviderCfg]


class ToolsConfig(BaseModel):
    subfinder: str = "subfinder"
    httpx: str = "httpx"
    nmap: str = "nmap"
    nuclei: str = "nuclei"


class AppConfig(BaseModel):
    # relative path will be mapped to XDG_DATA_HOME
    workspace_root: str = "workspaces"
    safe_mode_default: bool = True
    tools: ToolsConfig = Field(default_factory=ToolsConfig)
    ai: AIConfig


# Path helpers (XDG)
def _expand_path(p: str) -> Path:
    return Path(os.path.expandvars(p)).expanduser().resolve()


def _xdg_config_home() -> Path:
    return _expand_path(os.getenv("XDG_CONFIG_HOME", "~/.config"))


def _xdg_data_home() -> Path:
    return _expand_path(os.getenv("XDG_DATA_HOME", "~/.local/share"))


def _default_config_path() -> Path:
    return (_xdg_config_home() / "pentestai" / "config.yaml").resolve()


# Default config writer
def _write_default_config(cfg_path: Path) -> None:
    """
    Write a default VALID config if it doesn't exist.
    (We do NOT write API keys; only env var names.)
    """
    cfg_path.parent.mkdir(parents=True, exist_ok=True)

    default_yaml = """\
workspace_root: "workspaces"
safe_mode_default: true

tools:
  subfinder: "subfinder"
  httpx: "httpx"
  nmap: "nmap"
  nuclei: "nuclei"

ai:
  default_provider: "openai"
  fallback_providers: ["anthropic", "gemini", "deepseek"]

  routing:
    surface: ["openai", "anthropic", "gemini", "deepseek"]
    triage:  ["anthropic", "openai", "gemini", "deepseek"]
    report:  ["openai", "anthropic", "gemini", "deepseek"]

  providers:
    openai:
      api_key_env: "OPENAI_API_KEY"
      model: "gpt-4.1-mini"
      base_url: "https://api.openai.com/v1"

    anthropic:
      api_key_env: "ANTHROPIC_API_KEY"
      model: "claude-3-5-sonnet-latest"
      base_url: "https://api.anthropic.com"

    gemini:
      api_key_env: "GEMINI_API_KEY"
      model: "gemini-1.5-pro"
      base_url: "https://generativelanguage.googleapis.com"

    deepseek:
      api_key_env: "DEEPSEEK_API_KEY"
      model: "deepseek-chat"
      base_url: "https://api.deepseek.com"
"""
    if not cfg_path.exists():
        cfg_path.write_text(default_yaml, encoding="utf-8")

# Config discovery
def _default_config_candidates() -> List[Path]:
    """
    Lookup order:
      1) $PENTESTAI_CONFIG
      2) XDG config: ~/.config/pentestai/config.yaml  (or $XDG_CONFIG_HOME)
      3) ./config.yaml
    """
    candidates: List[Path] = []

    env_path = os.getenv("PENTESTAI_CONFIG", "").strip()
    if env_path:
        candidates.append(_expand_path(env_path))

    candidates.append(_default_config_path())
    candidates.append(_expand_path("./config.yaml"))
    return candidates

def _pick_config_path(path: Optional[str] = None) -> Path:
    # If caller explicitly passes a path, honor it (and auto-create if missing)
    if path and path.strip():
        p = _expand_path(path.strip())
        if not p.exists():
            _write_default_config(p)
        return p

    # Otherwise try defaults
    for cand in _default_config_candidates():
        if cand.exists():
            return cand
    xdg_cfg = _default_config_path()
    _write_default_config(xdg_cfg)
    return xdg_cfg

# Workspace resolution
def _resolve_workspace_root(raw_ws: str) -> Path:
    """
    - Absolute / ~ / $VAR paths: use as-is
    - Relative paths: XDG_DATA_HOME/pentestai/<raw_ws>
    """
    raw_ws = (raw_ws or "workspaces").strip()

    if not (raw_ws.startswith("/") or raw_ws.startswith("~") or raw_ws.startswith("$")):
        ws_path = (_xdg_data_home() / "pentestai" / raw_ws).resolve()
    else:
        ws_path = _expand_path(raw_ws)

    ws_path.mkdir(parents=True, exist_ok=True)
    return ws_path

# Public API
def load_config(path: str = "") -> AppConfig:
    cfg_path = _pick_config_path(path if path else None)

    with cfg_path.open("r", encoding="utf-8") as f:
        data = yaml.safe_load(f) or {}

    cfg = AppConfig(**data)

    # Normalize workspace root to absolute XDG-safe path
    ws_root = _resolve_workspace_root(cfg.workspace_root)
    cfg.workspace_root = str(ws_root)

    return cfg


def get_api_key(env_name: str) -> str:
    v = os.getenv(env_name, "").strip()
    if not v:
        raise RuntimeError(f"Missing API key: {env_name} (check .env)")
    return v

# Public helpers for CLI (pentestai init-config)
def default_config_path() -> Path:
    """Return the default XDG config path used by PentestAI."""
    return _default_config_path()


def write_default_config(cfg_path: Path) -> None:
    """Write a default config file to cfg_path if missing."""
    _write_default_config(cfg_path)
