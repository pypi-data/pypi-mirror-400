# Copyright 2025 Pasteur Labs. All Rights Reserved.
# SPDX-License-Identifier: Apache-2.0

# Tesseract API module for userhandler
# Generated by tesseract 1.2.1.dev14+g667850bb1.d20251217 on 2025-12-18T14:34:34.613891


import os
import pwd

from pydantic import BaseModel

#
# Schemas
#


class InputSchema(BaseModel):
    pass


class OutputSchema(BaseModel):
    uid: int
    gid: int
    username: str
    home: str
    shell: str


#
# Required endpoints
#


def apply(inputs: InputSchema) -> OutputSchema:
    """A simple Tesseract that fails if the current OS user doesn't have a valid /etc/passwd entry."""
    # Get current user ID
    uid = os.getuid()
    gid = os.getgid()

    # Try to get the passwd entry for the current user
    try:
        pw_entry = pwd.getpwuid(uid)
    except KeyError as exc:
        raise RuntimeError(
            f"Current user (UID: {uid}) does not have an entry in /etc/passwd. "
            "This container should have run addmeplease in the entrypoint."
        ) from exc

    if pw_entry.pw_gid != gid:
        raise RuntimeError(
            f"Current group (GID: {gid}) does not match expected group from /etc/passwd ({pw_entry.pw_gid})."
        )

    # Return the user information
    return OutputSchema(
        uid=pw_entry.pw_uid,
        gid=pw_entry.pw_gid,
        username=pw_entry.pw_name,
        home=pw_entry.pw_dir,
        shell=pw_entry.pw_shell,
    )
