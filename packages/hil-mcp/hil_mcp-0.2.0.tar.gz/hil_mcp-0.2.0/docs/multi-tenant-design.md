# HIL-MCP å¤šç§Ÿæˆ·è®¾è®¡æ–‡æ¡£

> ğŸ“… åˆ›å»ºæ—¥æœŸ: 2026-01-04
> ğŸ“Œ çŠ¶æ€: è®¾è®¡é˜¶æ®µ

## 1. éœ€æ±‚èƒŒæ™¯

å½“å‰ HIL-MCP éƒ¨ç½²ä¸€å¥—æœåŠ¡åªèƒ½æ”¯æŒå•ä¸ªç”¨æˆ·ä½¿ç”¨ã€‚ä¸ºäº†è®©å›¢é˜Ÿæˆå‘˜èƒ½å¤Ÿå…±äº«åŒä¸€å¥—éƒ¨ç½²å¥½çš„æœåŠ¡ï¼Œéœ€è¦æ”¯æŒå¤šç§Ÿæˆ·åŠŸèƒ½ã€‚

### 1.1 æ ¸å¿ƒéœ€æ±‚

1. **å¤šç”¨æˆ·æ¥å…¥**: ä¸€å¥— HIL Server + Worker éƒ¨ç½²ï¼Œæ”¯æŒå¤šä¸ªç”¨æˆ·åŒæ—¶ä½¿ç”¨
2. **ç§Ÿæˆ·éš”ç¦»**: ä¸åŒç”¨æˆ·çš„æ¶ˆæ¯å’Œä¼šè¯å®Œå…¨éš”ç¦»ï¼Œä¸ä¼šäº’ç›¸ä¸²æ‰°
3. **ç‹¬ç«‹é…ç½®**: æ¯ä¸ªç”¨æˆ·å¯ä»¥é…ç½®è‡ªå·±çš„ chat_idã€project_name ç­‰
4. **å‘åå…¼å®¹**: ç°æœ‰ç”¨æˆ·æ— éœ€ä¿®æ”¹é…ç½®å³å¯ç»§ç»­ä½¿ç”¨

### 1.2 ä½¿ç”¨åœºæ™¯

| åœºæ™¯ | æè¿° |
|------|------|
| å›¢é˜Ÿå…±äº« | å›¢é˜Ÿå†…å¤šäººå…±ç”¨ä¸€å¥—æœåŠ¡ï¼Œå„è‡ªä½¿ç”¨ç‹¬ç«‹çš„ä¼å¾®ç¾¤/ç§èŠ |
| å¤šé¡¹ç›® | åŒä¸€ç”¨æˆ·åœ¨ä¸åŒé¡¹ç›®ä¸­ä½¿ç”¨ä¸åŒçš„ç§Ÿæˆ·é…ç½® |
| å¤š Agent | åŒä¸€ç§Ÿæˆ·ä¸‹å¤šä¸ª Agent å¹¶å‘ä½¿ç”¨ï¼ˆå·²æ”¯æŒï¼‰ |

---

## 2. æ–¹æ¡ˆè®¾è®¡

### 2.1 æ–¹æ¡ˆé€‰æ‹©

ç»è®¨è®ºï¼Œé‡‡ç”¨ **éšå¼æ ‡è¯†** æ–¹æ¡ˆï¼š

- **ç§Ÿæˆ· ID ä¸åœ¨æ¶ˆæ¯ä¸­æ˜¾ç¤º**ï¼Œä¿æŒæ¶ˆæ¯ç®€æ´
- æœåŠ¡ç«¯é€šè¿‡å­˜å‚¨ç»“æ„ç®¡ç†ç§Ÿæˆ·éš”ç¦»
- å›è°ƒåŒ¹é…é€šè¿‡ short_idï¼ˆå…¨å±€å”¯ä¸€ï¼‰è¿›è¡Œ

### 2.2 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MCP Servers                             â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ User: Alice   â”‚  â”‚ User: Bob     â”‚  â”‚ User: Alice   â”‚        â”‚
â”‚  â”‚ tenant=alice  â”‚  â”‚ tenant=bob    â”‚  â”‚ tenant=alice  â”‚        â”‚
â”‚  â”‚ chat_id=ç¾¤A   â”‚  â”‚ chat_id=ç¾¤B   â”‚  â”‚ chat_id=ç¾¤C   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚          â”‚                  â”‚                  â”‚                 â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                             â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    HIL Server (å…¬ç½‘)                       â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ MultiTenantStorage                                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                                                       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ sessions: { session_id -> Session(tenant_id, ...) }  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ short_id_map: { short_id -> session_id }             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ chat_sessions: { chat_id -> [session_id] }           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ tenant_sessions: { tenant_id -> {session_id} }       â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                             â”‚                                    â”‚
â”‚                             â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚               DevCloud Worker (å†…ç½‘)                       â”‚  â”‚
â”‚  â”‚  è½¬å‘æ¶ˆæ¯åˆ°ä¼ä¸šå¾®ä¿¡ï¼Œæ¥æ”¶å›è°ƒ                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ•°æ®ç»“æ„è®¾è®¡

### 3.1 Session ç»“æ„

```python
@dataclass
class Session:
    session_id: str       # å”¯ä¸€æ ‡è¯†
    short_id: str         # å‰ 8 ä½ UUIDï¼Œç”¨äºæ¶ˆæ¯æ ‡è¯†
    tenant_id: str        # ç§Ÿæˆ·æ ‡è¯†ï¼ˆæ–°å¢ï¼‰
    chat_id: str          # ç¾¤/ç§èŠ ID
    chat_type: str        # group / single
    message: str          # åŸå§‹æ¶ˆæ¯å†…å®¹
    project_name: str     # é¡¹ç›®åç§°
    status: str           # waiting / replied / timeout
    replies: list[dict]   # ç”¨æˆ·å›å¤åˆ—è¡¨
    created_at: datetime
    expire_at: datetime
```

### 3.2 å­˜å‚¨ç´¢å¼•ç»“æ„

```python
class MultiTenantStorage:
    # ä¸»å­˜å‚¨ï¼šæ‰€æœ‰ä¼šè¯ï¼ˆå…¨å±€ï¼‰
    _sessions: dict[str, Session] = {}  # session_id -> Session
    
    # å…¨å±€ç´¢å¼•ï¼šshort_id å…¨å±€å”¯ä¸€
    _short_id_map: dict[str, str] = {}  # short_id -> session_id
    
    # chat_id ç´¢å¼•ï¼ˆè·¨ç§Ÿæˆ·ï¼‰
    _chat_sessions: dict[str, list[str]] = {}  # chat_id -> [session_id]
    
    # ç§Ÿæˆ·ç´¢å¼•ï¼ˆç”¨äºç§Ÿæˆ·çº§åˆ«çš„æŸ¥è¯¢å’Œæ¸…ç†ï¼‰
    _tenant_sessions: dict[str, set[str]] = {}  # tenant_id -> {session_id}
```

---

## 4. API å˜æ›´

### 4.1 å‘é€æ¶ˆæ¯æ¥å£

**POST /api/send**

```json
{
    "message": "è¯·ç¡®è®¤è¿™ä¸ªä¿®æ”¹...",
    "chat_id": "wokSFfCgAAxxxxxx",
    "tenant_id": "alice",           // æ–°å¢ï¼šç§Ÿæˆ·æ ‡è¯†
    "project_name": "my-project",
    "timeout": 300
}
```

### 4.2 MCP é…ç½®

```json
{
    "mcpServers": {
        "wecom-hil": {
            "command": "python",
            "args": [
                "-m", "mcp_server.server",
                "--service-url", "https://hil.example.com",
                "--tenant-id", "alice",       // æ–°å¢
                "--chat-id", "wokSFfCgAAxxxxxx",
                "--project-name", "my-project"
            ]
        }
    }
}
```

---

## 5. å›è°ƒåŒ¹é…é€»è¾‘

### 5.1 åŒ¹é…æµç¨‹

```python
async def handle_callback(data: dict) -> dict:
    chat_id = data.get("chatid")
    reply, short_id = extract_reply_from_callback(data)
    
    # æ­¥éª¤1: ä¼˜å…ˆç”¨ short_id åŒ¹é…ï¼ˆå…¨å±€å”¯ä¸€ï¼Œè·¨ç§Ÿæˆ·ï¼‰
    if short_id:
        session = await get_session_by_short_id(short_id)
        if session:
            # æ‰¾åˆ°äº†ï¼Œtenant_id è‡ªåŠ¨ç¡®å®š
            return add_reply(session, reply)
    
    # æ­¥éª¤2: å›é€€åˆ° chat_id åŒ¹é…
    waiting_sessions = await get_waiting_sessions_by_chat_id(chat_id)
    
    if len(waiting_sessions) == 0:
        # æ²¡æœ‰ç­‰å¾…ä¸­çš„ä¼šè¯
        return send_chat_id_hint(chat_id)
    
    elif len(waiting_sessions) == 1:
        # åªæœ‰ä¸€ä¸ªç­‰å¾…ä¸­çš„ä¼šè¯ï¼Œç›´æ¥åŒ¹é…
        return add_reply(waiting_sessions[0], reply)
    
    else:
        # å¤šä¸ªä¼šè¯ç­‰å¾…ä¸­ï¼ˆå¯èƒ½æ¥è‡ªä¸åŒç§Ÿæˆ·ï¼‰
        # æç¤ºç”¨æˆ·ä½¿ç”¨å¼•ç”¨å›å¤
        return send_multiple_sessions_hint(chat_id, waiting_sessions)
```

### 5.2 åœºæ™¯å¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|----------|
| ä¸åŒç§Ÿæˆ· + ä¸åŒ chat_id | å®Œå…¨éš”ç¦»ï¼Œå„è‡ªåŒ¹é… âœ… |
| ä¸åŒç§Ÿæˆ· + ç›¸åŒ chat_id | é€šè¿‡å¼•ç”¨å›å¤åŒºåˆ† |
| åŒä¸€ç§Ÿæˆ· + ç›¸åŒ chat_id | é€šè¿‡å¼•ç”¨å›å¤åŒºåˆ†ï¼ˆç°æœ‰é€»è¾‘ï¼‰ |
| æ— ç§Ÿæˆ· ID é…ç½® | ä½¿ç”¨é»˜è®¤ç§Ÿæˆ· `_default` |

---

## 6. å‘åå…¼å®¹

### 6.1 é»˜è®¤ç§Ÿæˆ·

- ä¸ä¼  `tenant_id` æ—¶ï¼Œä½¿ç”¨é»˜è®¤ç§Ÿæˆ· `_default`
- ç°æœ‰ç”¨æˆ·æ— éœ€ä¿®æ”¹é…ç½®

### 6.2 æ¶ˆæ¯æ ¼å¼ä¸å˜

```
[#abc12345 my-project]
è¯·ç¡®è®¤è¿™ä¸ªä¿®æ”¹...
```

ç§Ÿæˆ· ID **ä¸æ˜¾ç¤º** åœ¨æ¶ˆæ¯ä¸­ã€‚

---

## 7. å®ç°è®¡åˆ’

### 7.1 Phase 1: åŸºç¡€å¤šç§Ÿæˆ·æ”¯æŒ

- [ ] ä¿®æ”¹ Session æ•°æ®ç»“æ„ï¼Œæ·»åŠ  tenant_id å­—æ®µ
- [ ] ä¿®æ”¹ Storage ç±»ï¼Œæ”¯æŒå¤šç§Ÿæˆ·ç´¢å¼•
- [ ] ä¿®æ”¹ /api/send æ¥å£ï¼Œæ¥æ”¶ tenant_id å‚æ•°
- [ ] ä¿®æ”¹ MCP Serverï¼Œæ·»åŠ  --tenant-id å‚æ•°

### 7.2 Phase 2: å¢å¼ºåŠŸèƒ½

- [ ] ç§Ÿæˆ·çº§åˆ«çš„ç»Ÿè®¡å’Œç›‘æ§
- [ ] ç§Ÿæˆ·çº§åˆ«çš„è¶…æ—¶é…ç½®
- [ ] ç§Ÿæˆ·ç™½åå•/é»‘åå•

### 7.3 Phase 3: ç®¡ç†åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

- [ ] ç§Ÿæˆ·ç®¡ç† API
- [ ] ç§Ÿæˆ·ä½¿ç”¨é‡ç»Ÿè®¡
- [ ] ç§Ÿæˆ·éš”ç¦»çš„æ¶ˆæ¯å†å²

---

## 8. é£é™©å’Œè€ƒè™‘

### 8.1 æŠ€æœ¯é£é™©

| é£é™© | ç¼“è§£æªæ–½ |
|------|----------|
| åŒä¸€ chat å¤šç§Ÿæˆ·æ··æ·† | æç¤ºç”¨æˆ·ä½¿ç”¨å¼•ç”¨å›å¤ |
| ç§Ÿæˆ· ID æ³„éœ² | ç§Ÿæˆ· ID ä¸åœ¨æ¶ˆæ¯ä¸­æ˜¾ç¤º |
| æ€§èƒ½é—®é¢˜ | ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢ |

### 8.2 ç”¨æˆ·ä½“éªŒ

- ä¿æŒæ¶ˆæ¯ç®€æ´ï¼Œä¸å¢åŠ è§†è§‰è´Ÿæ‹…
- å¤šä¼šè¯å†²çªæ—¶ç»™å‡ºæ¸…æ™°æç¤º
- æä¾›å¼•ç”¨å›å¤çš„æ“ä½œæŒ‡å¼•

---

## 9. é™„å½•

### 9.1 ç¯å¢ƒå˜é‡é…ç½®

```bash
# MCP Server ç¯å¢ƒå˜é‡
HIL_SERVICE_URL=https://hil.example.com
HIL_TENANT_ID=alice
HIL_CHAT_ID=wokSFfCgAAxxxxxx
HIL_PROJECT_NAME=my-project
```

### 9.2 å®Œæ•´ MCP é…ç½®ç¤ºä¾‹

```json
{
    "mcpServers": {
        "wecom-hil-alice": {
            "command": "python",
            "args": [
                "-m", "mcp_server.server",
                "--service-url", "https://hil.example.com",
                "--tenant-id", "alice",
                "--chat-id", "wokSFfCgAAxxxxxx",
                "--project-name", "alice-project"
            ]
        },
        "wecom-hil-bob": {
            "command": "python",
            "args": [
                "-m", "mcp_server.server",
                "--service-url", "https://hil.example.com",
                "--tenant-id", "bob",
                "--chat-id", "wokSFfCgAAyyyyyy",
                "--project-name", "bob-project"
            ]
        }
    }
}
```
