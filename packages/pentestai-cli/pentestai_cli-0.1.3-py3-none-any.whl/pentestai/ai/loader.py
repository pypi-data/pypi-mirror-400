from __future__ import annotations
from typing import Dict, Any
from pentestai.core.config import AppConfig, env_get_required
from pentestai.ai.router import MultiAIRouter
from pentestai.ai.providers.openai_provider import OpenAIProvider
from pentestai.ai.providers.anthropic_provider import AnthropicProvider
from pentestai.ai.providers.gemini_provider import GeminiProvider
from pentestai.ai.providers.deepseek_provider import DeepSeekProvider

def build_router(cfg: AppConfig) -> MultiAIRouter:
    providers = {}

    p = cfg.ai.providers.get("openai")
    if p:
        providers["openai"] = OpenAIProvider(env_get_required(p.api_key_env), p.base_url, p.model)

    p = cfg.ai.providers.get("anthropic")
    if p:
        providers["anthropic"] = AnthropicProvider(env_get_required(p.api_key_env), p.base_url, p.model)

    p = cfg.ai.providers.get("gemini")
    if p:
        providers["gemini"] = GeminiProvider(env_get_required(p.api_key_env), p.base_url, p.model)

    p = cfg.ai.providers.get("deepseek")
    if p:
        providers["deepseek"] = DeepSeekProvider(env_get_required(p.api_key_env), p.base_url, p.model)

    routing = getattr(cfg.ai, "routing", {}) if hasattr(cfg.ai, "routing") else {}
    fallbacks = getattr(cfg.ai, "fallback_providers", []) if hasattr(cfg.ai, "fallback_providers") else []
    default_provider = cfg.ai.default_provider

    return MultiAIRouter(providers, routing, fallbacks, default_provider)
