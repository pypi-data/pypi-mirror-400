Metadata-Version: 2.4
Name: sicoob-sdk
Version: 0.2.14
Summary: A Python SDK for Sicoob API
Author-email: F√°bio Thomaz <fabio@ladder.dev.br>
License-Expression: MIT
Classifier: Development Status :: 3 - Alpha
Classifier: Intended Audience :: Developers
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: requests>=2.25.1
Requires-Dist: python-dotenv>=0.15.0
Requires-Dist: requests-pkcs12>=1.25
Requires-Dist: pypix-api==0.8.0
Requires-Dist: aiohttp>=3.8.0
Requires-Dist: aiofiles>=24.0.0
Requires-Dist: pytest-asyncio>=1.1.0
Requires-Dist: cryptography>=41.0.0
Provides-Extra: dev
Requires-Dist: pytest>=7.0.0; extra == "dev"
Requires-Dist: pytest-mock>=3.6.1; extra == "dev"
Requires-Dist: build>=1.2.2.post1; extra == "dev"
Requires-Dist: twine>=6.1.0; extra == "dev"
Requires-Dist: ruff>=0.4.2; extra == "dev"

# Sicoob SDK Python

SDK Python para integra√ß√£o com a API do Banco Sicoob

## Instala√ß√£o

```bash
pip install -r requirements.txt
# ou
pip install -e .
```

## Configura√ß√£o

Crie um arquivo `.env` na raiz do projeto com as seguintes vari√°veis:

```ini
SICOOB_CLIENT_ID=seu_client_id
SICOOB_CERTIFICADO=caminho/para/certificado.pem
SICOOB_CHAVE_PRIVADA=caminho/para/chave_privada.key
```

## Uso B√°sico

```python
from sicoob import Sicoob

# Inicializa o cliente (usando certificado PEM)
# √â obrigat√≥rio fornecer ou certificado+chave ou PFX+senha em ambiente de produ√ß√£o, mas opcional em ambiente de testes
cliente = Sicoob(
    client_id="seu_client_id",  # Obrigat√≥rio
    certificado="caminho/para/certificado.pem",  # Obrigat√≥rio se n√£o usar PFX [E em produ√ß√£o]
    chave_privada="caminho/para/chave_privada.key",  # Obrigat√≥rio se n√£o usar PFX [E em produ√ß√£o]
    sandbox_mode=False  # Opcional, default False
)

# Alternativa usando certificado PFX
cliente_pfx = Sicoob(
    client_id="seu_client_id",  # Obrigat√≥rio
    certificado_pfx="caminho/para/certificado.pfx",  # Obrigat√≥rio (pode ser path, bytes ou arquivo aberto) [E em produ√ß√£o]
    senha_pfx="senha_do_pfx",  # Obrigat√≥rio se usar PFX [E em produ√ß√£o]
    sandbox_mode=True  # Opcional para ambiente de testes
)

# Exemplo: consulta de extratos
extrato = cliente.conta_corrente.extrato(
    mes=1,  # Obrigat√≥rio (1-12)
    ano=2023,  # Obrigat√≥rio
    dia_inicial=1,  # Obrigat√≥rio (1-31)
    dia_final=31,  # Obrigat√≥rio (1-31)
    numero_conta_corrente="12345",  # Obrigat√≥rio
    agrupar_cnab=False  # Opcional
)
```

## API de Cobran√ßa

### Boletos Banc√°rios

A classe `BoletoAPI` oferece opera√ß√µes completas para gerenciamento de boletos:

```python
from sicoob import Sicoob
from sicoob.exceptions import BoletoError, BoletoNaoEncontradoError

# Inicializa o cliente
cliente = Sicoob(
    client_id="seu_client_id",
    certificado="caminho/para/certificado.pem",
    chave_privada="caminho/para/chave_privada.key"
)

# Opera√ß√µes com boletos
boleto_api = cliente.cobranca.boleto()

try:
    # Emiss√£o
    boleto = boleto_api.emitir_boleto({
        "numeroCliente": 123456,
        "codigoModalidade": 1,
        "numeroContaCorrente": 12345,
        "codigoEspecieDocumento": "DM",
        "dataEmissao": "2024-01-01",
        "nossoNumero": 123456789,
        "seuNumero": "1235512",
        "identificacaoBoletoEmpresa": "4562",
        "identificacaoEmissaoBoleto": 1,
        "identificacaoDistribuicaoBoleto": 1,
        "valor": 156.23,
        "dataVencimento": "2024-12-31",
        "dataLimitePagamento": "2024-12-31",
        "valorAbatimento": 1.0,
        "tipoDesconto": 1,
        "dataPrimeiroDesconto": "2024-06-01",
        "valorPrimeiroDesconto": 1.0,
        "dataSegundoDesconto": "2024-06-15",
        "valorSegundoDesconto": 0.0,
        "dataTerceiroDesconto": "2024-06-30",
        "valorTerceiroDesconto": 0.0,
        "tipoMulta": 1,
        "dataMulta": "2025-01-01",
        "valorMulta": 5.0,
        "tipoJurosMora": 1,
        "dataJurosMora": "2025-01-01",
        "valorJurosMora": 4.0,
        "numeroParcela": 1,
        "aceite": True,
        "codigoNegativacao": 2,
        "numeroDiasNegativacao": 60,
        "codigoProtesto": 1,
        "numeroDiasProtesto": 30,
        "pagador": {
            "numeroCpfCnpj": "98765432185",
            "nome": "Marcelo dos Santos",
            "endereco": "Rua 87 Quadra 1 Lote 1 casa 1",
            "bairro": "Santa Rosa",
            "cidade": "Luzi√¢nia",
            "cep": "72320000",
            "uf": "DF",
            "email": "pagador@dominio.com.br"
        },
        "beneficiarioFinal": {
            "numeroCpfCnpj": "98784978699",
            "nome": "Lucas de Lima"
        },
        "mensagensInstrucao": [
            "Descri√ß√£o da Instru√ß√£o 1",
            "Descri√ß√£o da Instru√ß√£o 2",
            "Descri√ß√£o da Instru√ß√£o 3",
            "Descri√ß√£o da Instru√ß√£o 4",
            "Descri√ß√£o da Instru√ß√£o 5"
        ],
        "gerarPdf": False,
        "rateioCreditos": [
            {
                "numeroBanco": 756,
                "numeroAgencia": 4027,
                "numeroContaCorrente": "987654",
                "contaPrincipal": true,
                "codigoTipoValorRateio": 1,
                "valorRateio": 100,
                "codigoTipoCalculoRateio": 1,
                "numeroCpfCnpjTitular": "98765432185",
                "nomeTitular": "Marcelo dos Santos",
                "codigoFinalidadeTed": 10,
                "codigoTipoContaDestinoTed": "CC",
                "quantidadeDiasFloat": 1,
                "dataFloatCredito": "2020-12-30"
            }
        ],
        "codigoCadastrarPIX": 1,
        "numeroContratoCobranca": 1
    })

    # Consultas
    boleto_consultado = boleto_api.consultar_boleto(
        numero_cliente=123456,  # Obrigat√≥rio
        codigo_modalidade=1,  # Obrigat√≥rio
        nosso_numero="123456789"  # Obrigat√≥rio (ou linha_digitavel ou codigo_barras)
    )
    
    boletos_pagador = boleto_api.consultar_boletos_por_pagador(
        numero_cpf_cnpj="12345678901",  # Obrigat√≥rio
        numero_cliente=123456,  # Obrigat√≥rio
        client_id="seu_client_id"  # Obrigat√≥rio
    )
    
    faixas = boleto_api.consultar_faixas_nosso_numero(
        numero_cliente=123456,  # Obrigat√≥rio
        codigo_modalidade=1,  # Obrigat√≥rio
        quantidade=10,  # Obrigat√≥rio
        client_id="seu_client_id"  # Obrigat√≥rio
    )

    # Webhooks
    boleto_api.cadastrar_webhook(
        webhook={
            "url": "https://meusite.com/webhook",  # Obrigat√≥rio
            "codigoTipoMovimento": 7,  # Obrigat√≥rio (7-Pagamento)
            "codigoPeriodoMovimento": 1  # Obrigat√≥rio
        },
        client_id="seu_client_id"  # Obrigat√≥rio
    )
    
    webhook = boleto_api.consultar_webhook(
        id_webhook=1,  # Obrigat√≥rio
        codigo_tipo_movimento=7,  # Obrigat√≥rio
        client_id="seu_client_id"  # Obrigat√≥rio
    )

except BoletoNaoEncontradoError:
    print("Boleto n√£o encontrado")
except BoletoError as e:
    print(f"Erro na API de boletos: {e}")
```

### PIX

A classe `PixAPI` implementa todas as opera√ß√µes PIX dispon√≠veis:

```python
from sicoob.exceptions import (
    CobrancaPixError, CobrancaPixNaoEncontradaError,
    CobrancaPixVencimentoError, WebhookPixError,
    LoteCobrancaPixError, QrCodePixError
)

# Opera√ß√µes PIX
pix_api = cliente.cobranca.pix()

try:
    # Cobran√ßas imediatas
    cobranca = pix_api.criar_cobranca_pix(
        txid="tx123",  # Obrigat√≥rio (m√°x 35 caracteres)
        dados_cobranca={  # Obrigat√≥rio
            "valor": {"original": "100.50"},  # Obrigat√≥rio
            "chave": "123e4567-e89b-12d3-a456-426614174000",  # Obrigat√≥rio
            "solicitacaoPagador": "Pagamento do pedido 123"  # Opcional
        }
    )

    # Cobran√ßas com vencimento
    cobranca_venc = pix_api.criar_cobranca_pix_com_vencimento(
        txid="tx456",  # Obrigat√≥rio
        dados_cobranca={  # Obrigat√≥rio
            "valor": {"original": "200.00"},  # Obrigat√≥rio
            "calendario": {"dataDeVencimento": "2025-12-31"},  # Obrigat√≥rio
            "chave": "123e4567-e89b-12d3-a456-426614174000"  # Obrigat√≥rio
        }
    )

    # Consulta cobran√ßa
    cobranca_consultada = pix_api.consultar_cobranca_pix(txid="tx123")
    
    # Cancelamento
    pix_api.cancelar_cobranca_pix(txid="tx123")
    
    # QR Code
    qrcode = pix_api.obter_qrcode_pix(txid="tx123")

    # Webhooks PIX
    pix_api.configurar_webhook_pix(
        chave="123e4567-e89b-12d3-a456-426614174000",  # Obrigat√≥rio
        webhook_url="https://meusite.com/pix-webhook"  # Obrigat√≥rio
    )
    
    # Consulta webhook
    webhook = pix_api.consultar_webhook_pix(
        chave="123e4567-e89b-12d3-a456-426614174000"
    )
    
    # Exclus√£o webhook
    pix_api.excluir_webhook_pix(
        chave="123e4567-e89b-12d3-a456-426614174000"
    )

    # Lotes de cobran√ßa
    lote = pix_api.criar_lote_cobranca_pix_com_vencimento(
        id_lote="lote001",
        cobrancas=[{
            "txid": "tx789",
            "valor": {"original": "300.00"},
            "calendario": {"dataDeVencimento": "2025-12-31"},
            "chave": "123e4567-e89b-12d3-a456-426614174000"
        }]
    )
    
    lote_consultado = pix_api.consultar_lote_cobranca_pix_com_vencimento("lote001")

except CobrancaPixNaoEncontradaError:
    print("Cobran√ßa PIX n√£o encontrada")
except CobrancaPixVencimentoError:
    print("Erro em cobran√ßa PIX com vencimento")
except WebhookPixError:
    print("Erro em opera√ß√£o de webhook PIX")
except LoteCobrancaPixError:
    print("Erro em opera√ß√£o com lote de cobran√ßas PIX")
except QrCodePixError:
    print("Erro em opera√ß√£o com QR Code PIX")
except CobrancaPixError as e:
    print(f"Erro na API PIX: {e}")
```

### Tratamento de Erros

O SDK possui exce√ß√µes espec√≠ficas para cada tipo de opera√ß√£o:

```python
from sicoob.exceptions import (
    BoletoError, BoletoNaoEncontradoError,
    PixError, CobrancaPixNaoEncontradaError,
    CobrancaPixVencimentoError, WebhookPixError,
    LoteCobrancaPixError, QrCodePixError,
    ContaCorrenteError, TransferenciaError
)

try:
    boleto = boleto_api.consultar_boleto("123456")
except BoletoNaoEncontradoError:
    print("Boleto n√£o encontrado")
except BoletoError as e:
    print(f"Erro na API de boletos: {e}")

try:
    pix_api.criar_cobranca_pix("tx123", dados)
except CobrancaPixError as e:
    print(f"Erro na API PIX: {e}")
```

## Servi√ßos de Conta Corrente

A classe `ContaCorrenteAPI` oferece opera√ß√µes banc√°rias:

```python
conta_api = cliente.conta_corrente()

# Consultas
extrato = conta_api.extrato(
    mes=6, 
    ano=2025,
    dia_inicial=1,
    dia_final=30,
    numero_conta_corrente="123456"
)

saldo = conta_api.saldo("123456")

# Transfer√™ncias
transferencia = conta_api.transferencia(
    valor=1000.00,  # Obrigat√≥rio
    conta_destino="654321",  # Obrigat√≥rio
    tipo_transferencia="TED",  # Opcional (TED/DOC/PIX)
    descricao="Transfer√™ncia entre contas",  # Opcional
    numero_conta="123456"  # Opcional se j√° configurado no cliente
)
```

## Versionamento e Deploy

O projeto segue [Semantic Versioning](https://semver.org/). Para criar um novo release:

1. Atualize a vers√£o em:
   - `setup.py`
   - `pyproject.toml`
   - `sicoob/__init__.py`

2. Execute os testes:
```bash
make test
```

3. Crie um novo release no GitHub:
   - Acesse "Releases" no reposit√≥rio
   - Clique em "Draft a new release"
   - Defina a tag no formato `vX.Y.Z` (ex: `v0.1.3`)
   - O GitHub Actions ir√° automaticamente:
     - Construir o pacote (`make build`)
     - Publicar no PyPI (`make publish`)

### Comandos √öteis
```bash
# Construir pacote
make build

# Executar testes
make test

# Publicar no PyPI (requer TWINE_USERNAME e TWINE_PASSWORD)
make publish

# Incrementar vers√£o (patch, minor ou major)
make bump-patch   # Incrementa patch version (0.1.2 ‚Üí 0.1.3)
make bump-minor   # Incrementa minor version (0.1.2 ‚Üí 0.2.0)
make bump-major   # Incrementa major version (0.1.2 ‚Üí 1.0.0)
```

### Como Incrementar a Vers√£o
1. Execute o comando apropriado:
```bash
make bump-patch   # Para corre√ß√µes de bugs
make bump-minor   # Para novas funcionalidades compat√≠veis
make bump-major   # Para mudan√ßas incompat√≠veis
```

2. Execute os testes para garantir a qualidade:
```bash
make test
```

3. Verifique as altera√ß√µes nos arquivos:
```bash
git diff
```

4. Commit e push das altera√ß√µes:
```bash
git add .
git commit -m "Bump version to X.Y.Z"
git push
```

5. Crie um novo release no GitHub para disparar a publica√ß√£o autom√°tica no PyPI

## Links √öteis

- [Documenta√ß√£o API Sicoob](https://developers.sicoob.com.br)
- [Portal de Desenvolvedores](https://developers.sicoob.com.br/portal)

## Documenta√ß√£o T√©cnica

### Vis√£o Geral
Biblioteca Python para integra√ß√£o com a API do Banco Sicoob, incluindo:
- Autentica√ß√£o OAuth2
- Cobran√ßa (Boletos e PIX)
- Conta Corrente
- Opera√ß√µes banc√°rias

### √çndice
1. [Classe Principal](#classe-sicoob)
2. [Autentica√ß√£o](#autentica√ß√£o-oauth2)
3. [Servi√ßos](#servi√ßos)
   - [Cobran√ßa](#api-de-cobran√ßa)
     - [Boletos](#boletos-banc√°rios)
     - [PIX](#pix)
   - [Conta Corrente](#servi√ßos-de-conta-corrente)
4. [Classe Base](#classe-base)
5. [Tratamento de Erros](#tratamento-de-erros)
6. [Diagrama de Relacionamentos](#diagrama-de-relacionamentos)
7. [Exemplos de Uso](#exemplos-de-uso)

---

### Classe Sicoob
Cliente principal que fornece acesso a todos os servi√ßos.

**Arquivo:** `sicoob/client.py`

#### M√©todos:
- `__init__(client_id=None, certificado=None, chave_privada=None, certificado_pfx=None, senha_pfx=None, sandbox_mode=False)`
  - Inicializa o cliente com credenciais
  - Par√¢metros:
    - `client_id`: Client ID fornecido pelo Sicoob
    - `certificado`: Caminho para o certificado .pem
    - `chave_privada`: Caminho para a chave privada .key
    - `certificado_pfx`: Caminho (str), bytes ou arquivo aberto (BinaryIO) do certificado PFX (opcional)
    - `sandbox_mode`: Se True, usa ambiente sandbox (default: False)

#### Propriedades:
- `cobranca`: Acesso √†s APIs de Cobran√ßa (Boleto e PIX)
- `conta_corrente`: Acesso √† API de Conta Corrente

---

### Autentica√ß√£o OAuth2
**Arquivo:** `sicoob/auth/oauth.py`

#### Classe: OAuth2Client
Gerencia tokens de acesso com escopos espec√≠ficos.

#### M√©todos:
- `get_access_token(scope=None)`: Obt√©m token para o escopo especificado
- `_is_token_expired(scope)`: Verifica se token expirou (m√©todo interno)

#### Escopos Comuns:
- **Boletos**: `"boletos_inclusao boletos_consulta..."`
- **Conta Corrente**: `"cco_consulta cco_transferencias..."`
- **PIX**: `"cob.write cob.read..."`

---

### Servi√ßos

#### API de Boletos
**Arquivo:** `sicoob/boleto.py`

#### Classe: BoletoAPI
Opera√ß√µes com boletos banc√°rios.

#### M√©todos:
- `emitir_boleto(dados_boleto)`: Emite novo boleto
- `emitir_segunda_via()`: Emite segunda via de um boleto existente
- `consultar_boleto(nosso_numero)`: Consulta boleto existente
- `consultar_boletos_por_pagador()`: Consulta lista de boletos por pagador
- `consultar_faixas_nosso_numero()`: Consulta faixas de nosso n√∫mero dispon√≠veis
- `alterar_boleto()`: Altera dados de um boleto existente
- `alterar_pagador()`: Altera informa√ß√µes do cadastro do pagador
- `baixar_boleto()`: Comanda a baixa de um boleto existente
- `cadastrar_webhook()`: Cadastra um webhook para receber notifica√ß√µes
- `consultar_webhook()`: Consulta os detalhes de um webhook cadastrado
- `atualizar_webhook()`: Atualiza um webhook cadastrado
- `excluir_webhook()`: Remove permanentemente um webhook cadastrado
- `consultar_solicitacoes_webhook()`: Consulta as solicita√ß√µes de notifica√ß√£o

#### API de PIX
**Arquivo:** `sicoob/pix.py`

#### Classe: PixAPI
Opera√ß√µes com PIX.

#### M√©todos Principais:
- `criar_cobranca_pix(txid, dados)`: Cria cobran√ßa imediata
- `consultar_cobranca_pix(txid)`: Consulta cobran√ßa
- `configurar_webhook(chave, url)`: Configura webhook

#### API de Conta Corrente
**Arquivo:** `sicoob/conta_corrente.py`

#### Classe: ContaCorrenteAPI
Opera√ß√µes banc√°rias.

#### M√©todos:
- `extrato()`: Obt√©m extrato por per√≠odo
- `saldo()`: Consulta saldo
- `transferencia()`: Realiza transfer√™ncia

---

### Classe Base
**Arquivo:** `sicoob/api_client.py`

#### Classe: APIClientBase
Fornece funcionalidades comuns a todas as APIs.

#### M√©todos:
- `_get_base_url()`: Retorna URL conforme sandbox/produ√ß√£o
- `_get_headers(scope)`: Retorna headers com autentica√ß√£o

---

### Diagrama de Relacionamentos

```mermaid
classDiagram
    class Sicoob {
        +cobranca
        +conta_corrente
    }
    
    class OAuth2Client {
        +get_access_token()
    }
    
    class APIClientBase {
        <<abstract>>
        +_get_base_url()
        +_get_headers()
    }
    
    class BoletoAPI {
        +emitir_boleto()
        +consultar_boleto()
    }
    
    class PixAPI {
        +criar_cobranca_pix()
        +consultar_cobranca_pix()
    }
    
    class ContaCorrenteAPI {
        +extrato()
        +saldo()
    }
    
    Sicoob --> OAuth2Client
    Sicoob --> BoletoAPI
    Sicoob --> PixAPI
    Sicoob --> ContaCorrenteAPI
    BoletoAPI --|> APIClientBase
    PixAPI --|> APIClientBase
    ContaCorrenteAPI --|> APIClientBase
    APIClientBase --> OAuth2Client
```

---

### Exemplos de Uso

```python
from sicoob import Sicoob
from sicoob.auth import OAuth2Client
import requests

# Configura√ß√£o
oauth = OAuth2Client(client_id, certificado, chave)
session = requests.Session()
sicoob = Sicoob(oauth_client=oauth, session=session)

# Uso dos servi√ßos
extrato = sicoob.conta_corrente.extrato(
    mes=6, ano=2025, dia_inicial=1, dia_final=30, 
    numero_conta_corrente=123456
)

boleto = sicoob.cobranca.boleto.emitir_boleto({
    "numeroCliente": 123456,
    "codigoModalidade": 1,
    "numeroContaCorrente": 12345,
    "codigoEspecieDocumento": "DM",
    "dataEmissao": "2024-01-01",
    "dataVencimento": "2024-12-31",
    "valor": 100.50,
    "seuNumero": "123456789",
    "identificacaoEmissaoBoleto": 1,
    "identificacaoDistribuicaoBoleto": 1,
    "tipoDesconto": 0,
    "tipoMulta": 0,
    "tipoJurosMora": 3,
    "numeroParcela": 1,
    "pagador": {
        "numeroCpfCnpj": "11122233300",
        "nome": "Jo√£o Silva",
        "endereco": "Rua Teste, 123",
        "bairro": "Centro",
        "cidade": "S√£o Paulo",
        "cep": "01001000",
        "uf": "SP"
    }
})

pix = sicoob.cobranca.pix.criar_cobranca_pix(
    "tx123",
    {"valor": {"original": "100.50"}}
)
```

---

## üîß Troubleshooting

### Erro 404 mesmo com boleto criado

**Sintoma:** API retorna 404 mas o boleto existe no banco e aparece no DDA

**Causa:** Comportamento n√£o-padr√£o da API Sicoob em alguns cen√°rios. A API pode retornar status 404 mas incluir os dados do boleto no corpo da resposta.

**Solu√ß√£o:**
- A biblioteca **j√° trata isso automaticamente** desde v0.1.34
- Use `emitir_e_verificar_boleto()` para maior robustez com retry autom√°tico
- Use `emitir_com_recovery()` para idempot√™ncia em reprocessamentos

```python
# M√©todo 1: Com verifica√ß√£o e retry autom√°tico
resultado = client.cobranca.boleto.emitir_e_verificar_boleto(
    dados_boleto,
    max_tentativas=3,  # Tenta verificar at√© 3 vezes
    delay_inicial=1.0  # Delays: 1s, 2s, 4s
)

# M√©todo 2: Com recovery autom√°tico (ideal para retries)
resultado = client.cobranca.boleto.emitir_com_recovery(
    dados_boleto,
    tentar_consulta_em_404=True  # Tenta recuperar se j√° existe
)
```

---

### Delay de propaga√ß√£o no DDA

**Sintoma:** Boleto emitido com sucesso mas n√£o aparece em consulta imediatamente

**Causa:** Delay de propaga√ß√£o entre sistemas internos do Sicoob. O boleto √© registrado mas leva alguns segundos para estar dispon√≠vel via API de consulta.

**Solu√ß√£o:** Use `emitir_e_verificar_boleto()` que implementa retry com exponential backoff

```python
# Aguarda propaga√ß√£o automaticamente
resultado = client.cobranca.boleto.emitir_e_verificar_boleto(
    dados_boleto,
    max_tentativas=3,  # 3 tentativas de verifica√ß√£o
    delay_inicial=1.0  # Delays exponenciais: 1s, 2s, 4s
)
```

---

### Diferen√ßas entre m√©todos de emiss√£o

**Quando usar cada m√©todo:**

| M√©todo | Caso de Uso | Retry | Recovery |
|--------|-------------|-------|----------|
| `emitir_boleto()` | Emiss√£o simples, sem retry | ‚ùå | ‚ùå |
| `emitir_e_verificar_boleto()` | Delay de propaga√ß√£o DDA | ‚úÖ | ‚ùå |
| `emitir_com_recovery()` | Reprocessamento, idempot√™ncia | ‚ùå | ‚úÖ |

**Exemplo de escolha:**

```python
# Caso 1: Emiss√£o normal (primeira vez)
boleto = client.cobranca.boleto.emitir_boleto(dados)

# Caso 2: Emiss√£o com verifica√ß√£o (produ√ß√£o, alto volume)
boleto = client.cobranca.boleto.emitir_e_verificar_boleto(
    dados,
    max_tentativas=2
)

# Caso 3: Reprocessamento de falhas (sistema de retry)
for boleto_pendente in obter_boletos_com_erro():
    try:
        # Tenta emitir, mas se j√° existe, apenas recupera
        resultado = client.cobranca.boleto.emitir_com_recovery(
            boleto_pendente.dados
        )
        if resultado.get('_recovery'):
            print(f"Boleto recuperado: {resultado['resultado']['nossoNumero']}")
    except BoletoEmissaoError:
        marcar_erro_definitivo(boleto_pendente)
```

---

### Vers√£o Async vs Sync

**Diferen√ßas principais:**

| Aspecto | Sync (`Sicoob`) | Async (`AsyncSicoob`) |
|---------|-----------------|------------------------|
| Uso | `with Sicoob(...) as client` | `async with AsyncSicoob(...) as client` |
| Chamadas | `client.cobranca.boleto.emitir_boleto(...)` | `await client.cobranca.boleto.emitir_boleto(...)` |
| Performance | Sequential | Concurrent |
| Melhor para | Scripts simples, CLI | Processamento em lote, APIs |

**M√©todos dispon√≠veis:**

‚úÖ Ambas vers√µes t√™m paridade completa:
- `emitir_boleto()` / `async emitir_boleto()`
- `emitir_e_verificar_boleto()` / `async emitir_e_verificar_boleto()`
- `emitir_com_recovery()` / `async emitir_com_recovery()`
- `consultar_boleto()` / `async consultar_boleto()`

**Exemplo de migra√ß√£o:**

```python
# Sync (antes)
with Sicoob(client_id="...") as client:
    resultado = client.cobranca.boleto.emitir_e_verificar_boleto(dados)

# Async (depois)
async with AsyncSicoob(client_id="...") as client:
    resultado = await client.cobranca.boleto.emitir_e_verificar_boleto(dados)
```

---

### Rate Limiting

**Limites conhecidos:**
- API Sicoob: ~4.5 requisi√ß√µes/segundo
- Recomendado: Implementar rate limiting no lado do cliente

**Exemplo com vers√£o async:**

```python
import asyncio
from asyncio import Semaphore

async def emitir_lote_com_rate_limit(boletos):
    limiter = Semaphore(5)  # Max 5 concurrent

    async def emitir_com_limite(dados):
        async with limiter:
            await asyncio.sleep(1/4.5)  # Rate limit
            return await client.cobranca.boleto.emitir_boleto(dados)

    # Processa em lote respeitando rate limit
    return await asyncio.gather(
        *[emitir_com_limite(b) for b in boletos],
        return_exceptions=True
    )
```

Veja [examples/emissao_lote_async.py](examples/emissao_lote_async.py) para exemplo completo.

---

### Retry Autom√°tico Global (AsyncSicoob)

A vers√£o ass√≠ncrona suporta **retry autom√°tico** para erros de infraestrutura e rate limiting.

**Configura√ß√£o:**

```python
from sicoob.async_client import AsyncSicoob

async with AsyncSicoob(
    client_id="...",
    certificado_pfx="...",
    senha_pfx="...",
    retry_config={
        'max_tentativas': 3,           # N√∫mero m√°ximo de tentativas
        'delay_inicial': 1.0,          # Delay inicial em segundos
        'backoff_exponencial': True,   # Usar exponential backoff
        'codigos_retry': [500, 502, 503, 504, 429],  # C√≥digos HTTP para retry
    }
) as client:
    # Todas as opera√ß√µes usar√£o retry autom√°tico
    resultado = await client.cobranca.boleto.emitir_boleto(dados)
```

**Comportamento:**
- **Exponential backoff**: 1s, 2s, 4s, 8s... (com jitter de ¬±25%)
- **C√≥digos padr√£o para retry**: 500, 502, 503, 504, 429
- **Sem retry por padr√£o**: Para manter compatibilidade, configure `max_tentativas > 1`

**Quando usar:**
- ‚úÖ Erros transit√≥rios de servidor (500, 503)
- ‚úÖ Rate limiting (429)
- ‚úÖ Timeouts e falhas de rede
- ‚ùå Erros de valida√ß√£o (400, 404) - n√£o faz retry

**Exemplo com e sem retry:**

```python
# Sem retry (comportamento padr√£o)
async with AsyncSicoob(client_id="...") as client:
    # Falha imediatamente em erro 503
    resultado = await client.cobranca.boleto.emitir_boleto(dados)

# Com retry autom√°tico
async with AsyncSicoob(
    client_id="...",
    retry_config={'max_tentativas': 3, 'delay_inicial': 0.5}
) as client:
    # Tenta 3x com backoff antes de falhar
    resultado = await client.cobranca.boleto.emitir_boleto(dados)
```

**Combinando com m√©todos especializados:**

O retry global √© diferente de `emitir_e_verificar_boleto()`:
- **Retry global**: Retenta em erros de infraestrutura (500, 503, 429)
- **emitir_e_verificar_boleto()**: Verifica propaga√ß√£o DDA ap√≥s sucesso

Voc√™ pode usar ambos juntos:

```python
async with AsyncSicoob(
    client_id="...",
    retry_config={'max_tentativas': 3}  # Retry em erros de servidor
) as client:
    # Tamb√©m verifica propaga√ß√£o DDA
    resultado = await client.cobranca.boleto.emitir_e_verificar_boleto(
        dados,
        max_tentativas=2  # Retry de verifica√ß√£o DDA
    )
```

---

### Logs e Debugging

**Habilitar logs detalhados:**

```python
import logging

# Configure logging antes de usar o cliente
logging.basicConfig(level=logging.DEBUG)

# Agora os logs mostrar√£o:
# - Requisi√ß√µes HTTP (URL, m√©todo, headers)
# - Respostas (status code, tempo de resposta)
# - Retries e recoveries
# - Erros com stack traces
```

**Opera√ß√µes logadas:**
- `boleto_emissao_request` - Antes de emitir
- `boleto_emissao_response` - Resposta da emiss√£o
- `boleto_emissao_404` - 404 detectado
- `boleto_emissao_404_sucesso` - 404 mas com dados v√°lidos
- `boleto_verificacao_delay` - Aguardando retry
- `boleto_verificacao_sucesso` - Verifica√ß√£o bem-sucedida
- `boleto_recovery` - Tentando recovery
- `boleto_recovery_sucesso` - Recovery bem-sucedido

---

## üìö Recursos Adicionais

- **Guia de Migra√ß√£o Sync ‚Üí Async**: [docs/MIGRATION_GUIDE.md](docs/MIGRATION_GUIDE.md)
- **Exemplos Pr√°ticos**: [examples/](examples/)
- **Documenta√ß√£o Completa**: [docs/](docs/)
- **Issues e Sugest√µes**: [GitHub Issues](https://github.com/laddertech/sicoob-sdk/issues)
