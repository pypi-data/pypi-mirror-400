from __future__ import annotations
from typing import Dict, Iterable, List, Optional

from pentestai.plugins.base import Plugin
from pentestai.plugins.recon_subfinder import SubfinderPlugin
from pentestai.plugins.recon_httpx import HttpxPlugin
from pentestai.plugins.recon_nmap import NmapPlugin
from pentestai.plugins.scan_nuclei import NucleiPlugin


ALL_PLUGINS: List[type[Plugin]] = [
    SubfinderPlugin,
    HttpxPlugin,
    NmapPlugin,
    NucleiPlugin,
]


def default_registry(
    *,
    enable: Optional[Iterable[str]] = None,
    disable: Optional[Iterable[str]] = None,
    stage: Optional[str] = None,
) -> Dict[str, Plugin]:
    """
    enable  : only enable these plugin names
    disable : disable these plugin names
    stage   : filter by stage (recon|scan|validate|post)
    """
    enable_set = set(enable or [])
    disable_set = set(disable or [])

    plugins: Dict[str, Plugin] = {}

    for plugin_cls in ALL_PLUGINS:
        p = plugin_cls()

        if stage and p.stage != stage:
            continue
        if enable_set and p.name not in enable_set:
            continue
        if p.name in disable_set:
            continue

        plugins[p.name] = p

    return plugins
