#!/usr/bin/env bash
# Standalone production run script
# Generated by container-magic: https://github.com/markhedleyjones/container-magic
# Can be run without container-magic installed

set -euo pipefail

IMAGE_NAME="{{ project_name }}"
TAG="latest"
WORKDIR="{{ workdir }}"
WORKSPACE_NAME="{{ workspace_name }}"
SHELL="{{ shell }}"

# Detect runtime backend
{%- if backend == "auto" %}
if command -v podman >/dev/null 2>&1; then
	RUNTIME="podman"
elif command -v docker >/dev/null 2>&1; then
	RUNTIME="docker"
else
	echo "Error: Neither podman nor docker found in PATH"
	exit 1
fi
{%- else %}
RUNTIME="{{ backend }}"
{%- endif %}

# Check if image exists locally to avoid registry prompts
if ! ${RUNTIME} image inspect "${IMAGE_NAME}:${TAG}" &>/dev/null; then
	echo "Error: Image ${IMAGE_NAME}:${TAG} not found locally"
	echo "Build it with: ./build.sh"
	exit 1
fi

# Build base run arguments (common to all commands)
BASE_RUN_ARGS=("--rm")
if [[ -t 0 ]]; then
	BASE_RUN_ARGS+=("--interactive" "--tty")
fi
BASE_RUN_ARGS+=("--hostname" "${IMAGE_NAME}")
{%- if privileged %}
BASE_RUN_ARGS+=("--privileged")
{%- endif %}
{%- if network %}
BASE_RUN_ARGS+=("--net" "{{ network }}")
{%- endif %}

{%- if commands %}

# Custom command handlers
{%- for command_name, command_spec in commands.items() %}

run_{{ command_name }}() {
	{%- if command_spec.standalone %}
	# Delegate to standalone script
	exec "$(dirname "$0")/{{ command_name }}.sh"
	{%- else %}
	{%- if command_spec.description %}
	# {{ command_spec.description }}
	{%- endif %}
	local RUN_ARGS=("${BASE_RUN_ARGS[@]}")

	{%- if command_spec.env %}
	# Environment variables
	{%- for key, value in command_spec.env.items() %}
	RUN_ARGS+=("-e" "{{ key }}={{ value }}")
	{%- endfor %}
	{%- endif %}

	${RUNTIME} run "${RUN_ARGS[@]}" \
		-w "${WORKDIR}" \
		"${IMAGE_NAME}:${TAG}" \
		"${SHELL}" -c "{{ command_spec.command | replace('\"', '\\\"') }}"
	{%- endif %}
}
{%- endfor %}

# Check for custom command
if [ $# -gt 0 ]; then
	case "$1" in
	{%- for command_name in commands.keys() %}
	{{ command_name }})
		shift
		run_{{ command_name }} "$@"
		exit $?
		;;
	{%- endfor %}
	esac
fi
{%- endif %}

# Use base run arguments
RUN_ARGS=("${BASE_RUN_ARGS[@]}")

# Run command or shell
if [ $# -gt 0 ]; then
	# Run specific command
	${RUNTIME} run "${RUN_ARGS[@]}" \
		-w "${WORKDIR}/${WORKSPACE_NAME}" \
		"${IMAGE_NAME}:${TAG}" \
		"${SHELL}" -c "$*"
else
	# Interactive shell
	${RUNTIME} run "${RUN_ARGS[@]}" \
		-w "${WORKDIR}/${WORKSPACE_NAME}" \
		"${IMAGE_NAME}:${TAG}" \
		"${SHELL}"
fi
