# 迭代日志


## 0.7.9 模板子目录重构

- 将 nb 模板从根目录移至 `templates/nb/` 子目录，并统一默认模板常量定义。

## 0.7.10 Theme Frontmatter 配置

- 新增 `theme` 配置组到 frontmatter，包含：
  - `theme.template` - 指定模板文件（替代顶级 `template`）
  - `theme.coverstyle` - 封面样式 ("default" / "report")
  - `theme.overview-fill` - overview 块背景色
- `nb.typ` 模板支持根据 coverstyle 切换封面库

## 0.7.11 模板导入机制简化

- 实现了模板智能解析：
  - 输入 `nb` 自动按顺序查找：`nb.typ`, `nb/nb.typ`, `nb/index.typ`
  - 简化了默认配置配置值为 `nb`
- 重构了 `helper_typst` 依赖处理：
  - 目录式模板（如 `nb/nb.typ`）直接复制整个目录，废弃了复杂的正则依赖解析
  - 移除了 `parse_template_deps` 等废弃函数
  - 仅支持 `theme.template` 格式配置，不再支持顶级 `template`

- **Frontmatter 结构变更**：
  - 将 `font` 和 `titlefont` 从 `pubinfo` 移至 `theme` 配置组。

## 0.7.13 封底样式系统 & Darkbg 封面优化

- **封底样式系统**：
  - 新增 `theme.backcoverstyle` 配置项，支持 `default` / `biglogo` 两种封底样式
  - `default` 封底：底部小 Logo + 出版信息
  - `biglogo` 封底：中央大 Logo + 底部出版信息
  - 新增 `nb-backcover-biglogo-lib.typ` 封底库文件

- **Darkbg 封面 Hero Image 优化**：
  - Hero Image 改用 `place` 固定定位（`dy: 4.1cm`），取代弹性布局
  - 解决了内容变化导致 Hero Image 位置不稳定的问题

## 0.7.14 PDF 压缩命令

- **新增 `compress` 命令**：使用 PyMuPDF 压缩 PDF 文件大小
  - `yakultpdf compress sample.pdf` - 压缩单个文件（覆盖原文件）
  - `yakultpdf compress --all` - 压缩 out 目录下所有 PDF
  - `yakultpdf compress --no-overwrite` - 输出为 `xxx_sm.pdf`
  - `--dpi` 参数预留，用于后续图片 DPI 重采样
- **压缩策略**：
  - `doc.scrub()` 清除元数据、缩略图等
  - `doc.ez_save()` 启用 garbage=3 + deflate 压缩
  - PNG → JPEG 转换（仅 >1MB 且无透明通道的 PNG）
- **依赖**：新增 `pymupdf`

## 0.7.15 NB 模板图片优化

- **Top/Bottom Image 支持**
  - 新增 `<topimage>` (页首出血图) 和 `<bottomimage>` (页尾出血图) 支持
  - 图片按原始比例显示，自动处理页边距和出血
- **Cover 兼容性修复**
  - 修复 `coverbg` 参数在不同封面样式下的兼容性问题
  - 仅 `darkbg`/`dark` 样式传递 `coverbg` 参数，避免其他样式报错

## 0.7.20-21 性能优化

- **Frontmatter 解析优化**
  - 新增 LRU 缓存机制（128 条），基于文件 mtime + size 判定命中
  - 转换流程中 frontmatter 仅解析一次，复用传递到各函数
- **字体路径缓存**
  - 目录级字体文件列表缓存，基于 mtime 失效
  - 避免重复遍历字体目录
- **工具检查优化**
  - `check_pandoc_typst()` 仅首次执行检查
  - 新增 `--skip-tool-check` 选项跳过检查
- **CLI 增强**
  - 新增 `--version` 选项显示版本号
- **批量并发处理**
  - 新增 `--jobs` 参数，支持 `ProcessPoolExecutor` 并发转换多文件
  - 默认 jobs=1 保持串行，可根据机器性能调整
- **OpenCC 实例缓存**
  - 使用 `lru_cache` 缓存 `OpenCC("s2t")` 实例，避免重复创建
  - 懒加载 import，未使用繁体转换时不加载 opencc
- **繁体转换去重**
  - CLI 构建后处理器链时不再加入 `to_traditional_chinese`
  - 繁体转换统一由 core 层 `options.tc` 处理，避免重复执行
- **Markdown 预处理优化**
  - 合并 `@` 和 `$` 字符转义为单次遍历 (`pre_escape_typst_chars`)
  - protected_regions 检查从 O(n*m) 优化为 O(n)
  - 预编译标题相关正则表达式


## 0.7.22 繁体转换修复与重构

- **繁体转换逻辑修复**
  - 修复自定义后处理器可能导致 `tc` 标志失效的问题
  - 确保 `tc=True` 时始终执行繁体转换，且执行顺序在自定义后处理器之后
  - `convert_file` / `convert_directory` / `convert_from_string` 统一增加 `postprocess` 参数支持
- **代码重构**
  - 重构 `process_builder.py`，使用 `load_postprocessor` 统一加载逻辑
  - 移除 `utils.py` 中被废弃的 `convert_to_traditional` 实现（已迁移至 `mark2pdf.helper_utils`）

## 0.7.23 Process Builder 彻底解耦

**处理流程（简化版）**
- CLI 先根据 flags 组装处理器名称：`--removelink` → `remove_links`，`--postprocess` → 指定名称，`--tc` → `to_traditional_chinese`；随后去重并保持顺序。
- `build_postprocessor_chain(names)` 只做加载与组装：返回 `PostprocessBuildResult`，包含 `chain`（可执行链）、`loaded`（成功加载）、`missing`（未找到）。
- CLI 负责输出：若有 `missing`，用 `click.echo(..., err=True)` 警告；`--verbose` 时显示已加载列表。
- 转换逻辑使用 `result.chain` 作为后处理链；非 CLI 场景不会产生任何输出副作用。

**结果对象**
- `chain`: 组合后的后处理函数（可能为 `None`）
- `loaded`: 实际加载成功的处理器名列表
- `missing`: 未找到的处理器名列表

## 0.7.24 代码审查与安全修复

- **安全修复**
  - 修复 `get_output_filename` 路径穿越漏洞：调整检查顺序，先检查原始输入再提取文件名
  - 增加绝对路径前缀检测（`/`, `\`）和空文件名验证

- **异常处理改进**
  - `interfile_manager.py`: `Exception` → `OSError`
  - `coverimg.py`: `Exception` → `OSError`
  - `compress.py`: `Exception` → `OSError`
  - `conversion.py`: 批处理添加 `traceback.print_exc()` 记录完整堆栈

- **代码清理**
  - 删除 `md_preprocess.py` 中 184 行已注释的遗留代码（旧字符串解析方法）

## 0.7.25 run_batch_conversion 重构

- **函数拆分**：将 204 行的 `run_batch_conversion` 拆分为多个子函数（每个 50 行以内）
  - `BatchConfig` dataclass：批量转换配置数据结构
  - `_prepare_postprocessors`：后处理器配置准备
  - `_prepare_batch_config`：配置加载和 frontmatter 合并
  - `_discover_batch_files`：文件发现和排序
  - `_run_sequential`：单线程执行
  - `_run_parallel`：多线程执行
- **默认并发数调整**：`--jobs` 默认值从 1 改为 4

## 0.7.26 CLI convert 命令重构

- **测试加固**：增加参数冲突检测、`--show-config`、Mock 模式调用等 6 个测试用例，覆盖率显著提升
- **函数拆分**：将 162 行的 `convert` 命令拆分为清晰的子函数
  - `_validate_convert_args`：参数合法性校验
  - `_prepare_convert_config`：配置上下文 (`ConvertContext`) 组装
  - `_dispatch_conversion`：根据模式分发执行 (`directory`/`batch`/`single`)
- **Move**: 将 `convert` 命令迁移至 `src/mark2pdf/commands/convert.py` [2026-01-06]
  - 减少 `cli.py` 复杂度，从 345 行减少到约 60 行


