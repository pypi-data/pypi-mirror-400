---
name: 'Test PR'

on:
  pull_request:
    branches:
      - 'main'
      - 'develop'
  workflow_dispatch:

jobs:
  test:
    runs-on: 'ubuntu-latest'

    strategy:
      fail-fast: false
      matrix:
        # this list should be aligned with /tox.ini
        tox-env: [ 'style', 'py310', 'py311' ]
        include:
          - tox-env: 'style'
            python: '3.10'
          - tox-env: 'py310'
            report-coverage: true # set to any one of the above python versions, we don't have version-specific logic
            python: '3.10'
          - tox-env: 'py311'
            python: '3.11'

    steps:
      - name: 'Checkout code'
        uses: actions/checkout@v3

      - name: 'Install Python and uv'
        uses: astral-sh/setup-uv@v7
        with:
          python-version: '${{ matrix.python }}'
          version: '0.7.15'
          enable-cache: true

      - name: 'Install dependencies'
        run: uv sync --frozen --no-progress --color never --extra airflow

      - name: 'Test the library'
        env:
          UV_PYTHON_DOWNLOADS: automatic
        run: uv run tox -e ${{ matrix.tox-env }}

      - name: Coverage Badge
        if: 'matrix.report-coverage'
        uses: tj-actions/coverage-badge-py@v2

      - name: Verify Changed files
        if: 'matrix.report-coverage'
        uses: tj-actions/verify-changed-files@v14
        id: verify-changed-files
        with:
          files: coverage.svg

      - name: Commit and push coverage.svg
        if: (matrix.report-coverage) && (steps.verify-changed-files.outputs.files_changed == 'true')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr checkout ${{ github.event.pull_request.number }}
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add coverage.svg
          git commit -m "chore: update coverage.svg"
          git push
