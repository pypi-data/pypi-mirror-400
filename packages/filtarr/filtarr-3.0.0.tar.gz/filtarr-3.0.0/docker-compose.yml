# Docker Compose configuration for filtarr
# https://github.com/dabigc/filtarr
#
# Quick start:
#   1. Copy docker-compose.yml to your deployment directory
#   2. Copy .env.example to .env and add your API keys:
#      cp .env.example .env
#   3. Run: docker compose up -d
#
# Note: The env_file directive is required to pass environment variables
# to the CONTAINER. While Docker Compose automatically reads .env files
# for variable substitution in this compose file (e.g., ${FILTARR_PORT}),
# the env_file directive is needed to inject those values into the container.
#
# For development/building locally, use: docker compose --profile build up -d

services:
  filtarr:
    image: ghcr.io/dabigc/filtarr:latest
    container_name: filtarr
    restart: unless-stopped
    env_file: .env
    ports:
      - "${FILTARR_PORT:-8080}:8080"
    environment:
      # Required: Radarr configuration
      - FILTARR_RADARR_URL=${FILTARR_RADARR_URL:-http://radarr:7878}
      - FILTARR_RADARR_API_KEY=${FILTARR_RADARR_API_KEY:?Radarr API key required}
      # Required: Sonarr configuration
      - FILTARR_SONARR_URL=${FILTARR_SONARR_URL:-http://sonarr:8989}
      - FILTARR_SONARR_API_KEY=${FILTARR_SONARR_API_KEY:?Sonarr API key required}
      # Optional: Custom tag names
      - FILTARR_TAG_AVAILABLE=${FILTARR_TAG_AVAILABLE:-4k-available}
      - FILTARR_TAG_UNAVAILABLE=${FILTARR_TAG_UNAVAILABLE:-4k-unavailable}
      # Optional: Scheduler (enabled by default)
      - FILTARR_SCHEDULER_ENABLED=${FILTARR_SCHEDULER_ENABLED:-true}
      # Optional: Request timeout (seconds)
      - FILTARR_TIMEOUT=${FILTARR_TIMEOUT:-120}
    volumes:
      # Option 1: Named volume (recommended for simplicity)
      - filtarr_config:/config
      # Option 2: Bind mount (uncomment and remove named volume above)
      # IMPORTANT: Directory must be owned by UID 1000 (the filtarr user)
      #   mkdir -p ./filtarr && chown 1000:1000 ./filtarr
      # - ./filtarr:/config
      # Optional: Mount custom config file (read-only)
      # - ./config.toml:/config/config.toml:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3
    networks:
      - filtarr-net
    # Uncomment to join your existing arr network
    # networks:
    #   - arr-network

  # Optional: Build from source instead of using pre-built image
  # Activate with: docker compose --profile build up -d
  filtarr-dev:
    profiles:
      - build
    build:
      context: .
      dockerfile: Dockerfile
    container_name: filtarr-dev
    restart: unless-stopped
    env_file: .env
    ports:
      - "${FILTARR_DEV_PORT:-8081}:8080"
    environment:
      - FILTARR_RADARR_URL=${FILTARR_RADARR_URL:-http://radarr:7878}
      - FILTARR_RADARR_API_KEY=${FILTARR_RADARR_API_KEY:?Radarr API key required}
      - FILTARR_SONARR_URL=${FILTARR_SONARR_URL:-http://sonarr:8989}
      - FILTARR_SONARR_API_KEY=${FILTARR_SONARR_API_KEY:?Sonarr API key required}
      - FILTARR_TAG_AVAILABLE=${FILTARR_TAG_AVAILABLE:-4k-available}
      - FILTARR_TAG_UNAVAILABLE=${FILTARR_TAG_UNAVAILABLE:-4k-unavailable}
      - FILTARR_SCHEDULER_ENABLED=${FILTARR_SCHEDULER_ENABLED:-true}
    volumes:
      - filtarr_dev_config:/config
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 5s
      retries: 3
    networks:
      - filtarr-net

volumes:
  filtarr_config:
    name: filtarr_config
  filtarr_dev_config:
    name: filtarr_dev_config

networks:
  filtarr-net:
    name: filtarr-net
    driver: bridge
