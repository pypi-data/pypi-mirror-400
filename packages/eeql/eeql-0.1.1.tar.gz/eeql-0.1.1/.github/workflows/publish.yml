name: Publish

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  test-publish:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine tomli
      - name: Get package version
        id: get_version
        run: |
          python - <<'PY'
          import os
          try:
            import tomllib
          except ModuleNotFoundError:  # py310
            import tomli as tomllib
          with open("pyproject.toml", "rb") as f:
            version = tomllib.load(f)["project"]["version"]
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
            f.write(f"version={version}\n")
          PY
      - name: Build package
        run: python -m build
      - name: Validate package
        run: twine check dist/*
      - name: Upload to TestPyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: twine upload --repository-url https://test.pypi.org/legacy/ dist/*
      - name: Comment install instructions
        uses: actions/github-script@v7
        with:
          script: |
            const version = "${{ steps.get_version.outputs.version }}";
            const body = [
              "TestPyPI prerelease published:",
              "",
              "```bash",
              `pip install -i https://test.pypi.org/simple eeql==${version}`,
              "```",
            ].join("\n");
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            });

  prod-publish:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - name: Check version file change
        id: version_change
        run: |
          if git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" | grep -qx "pyproject.toml"; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Set up Python
        if: steps.version_change.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install build tooling
        if: steps.version_change.outputs.changed == 'true'
        run: |
          python -m pip install --upgrade pip
          python -m pip install build twine tomli
      - name: Get package version
        id: get_version
        if: steps.version_change.outputs.changed == 'true'
        run: |
          python - <<'PY'
          import os
          try:
            import tomllib
          except ModuleNotFoundError:  # py310
            import tomli as tomllib
          with open("pyproject.toml", "rb") as f:
            version = tomllib.load(f)["project"]["version"]
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
            f.write(f"version={version}\n")
          PY
      - name: Check if version exists on PyPI
        id: pypi_check
        if: steps.version_change.outputs.changed == 'true'
        env:
          VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          python - <<'PY'
          import json
          import os
          import sys
          import urllib.request
          version = os.environ["VERSION"]
          url = "https://pypi.org/pypi/eeql/json"
          exists = False
          try:
            with urllib.request.urlopen(url) as resp:
              data = json.load(resp)
            exists = version in data.get("releases", {})
          except Exception as exc:
            print(f"warn: failed to check PyPI: {exc}", file=sys.stderr)
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
            f.write(f"exists={str(exists).lower()}\n")
          PY
      - name: Skip publish (version exists)
        if: steps.version_change.outputs.changed == 'true' && steps.pypi_check.outputs.exists == 'true'
        run: |
          echo "Version ${{ steps.get_version.outputs.version }} already exists on PyPI. Skipping." >> "$GITHUB_STEP_SUMMARY"
      - name: Build package
        if: steps.version_change.outputs.changed == 'true' && steps.pypi_check.outputs.exists != 'true'
        run: python -m build
      - name: Validate package
        if: steps.version_change.outputs.changed == 'true' && steps.pypi_check.outputs.exists != 'true'
        run: twine check dist/*
      - name: Upload to PyPI
        if: steps.version_change.outputs.changed == 'true' && steps.pypi_check.outputs.exists != 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: twine upload dist/*
      - name: Report published version
        if: steps.version_change.outputs.changed == 'true' && steps.pypi_check.outputs.exists != 'true'
        run: |
          echo "Published eeql ${{ steps.get_version.outputs.version }} to PyPI." >> "$GITHUB_STEP_SUMMARY"
      - name: Skip publish (no version change)
        if: steps.version_change.outputs.changed != 'true'
        run: |
          echo "No pyproject.toml change detected. Skipping publish." >> "$GITHUB_STEP_SUMMARY"
