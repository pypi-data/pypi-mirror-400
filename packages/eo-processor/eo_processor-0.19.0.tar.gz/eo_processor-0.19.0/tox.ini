[tox]
envlist = py38, py39, py310, py311, py312, py313, py38-bench, py39-bench, py310-bench, py311-bench, py312-bench, py313-bench
skip_missing_interpreters = true
isolated_build = true

# Use a shared build environment to speed up repeated wheel builds across envs
wheel_build_env = .pkg

[testenv]
description = Build the Rust extension with maturin and run the Python test suite
deps =
    maturin>=1.9.6
    pytest>=7.0
    numpy>=1.20.0
    pandas
    pillow>=9.0.0
    scikit-learn>=1.0
    scikit-image>=0.18.0
    xarray>=2023.0.0
    dask>=2023.0.0
setenv =
    RUST_BACKTRACE=1
    PYTHONDONTWRITEBYTECODE=1
    # Uncomment to force a specific rust toolchain
    # RUSTUP_TOOLCHAIN=stable
passenv =
    CARGO_HOME
    RUSTUP_HOME
    # Allow proxy vars and CI indicators
    HTTP_PROXY
    HTTPS_PROXY
    NO_PROXY
    CI
commands =
    # Editable build so incremental Rust changes are picked up quickly
    maturin develop --locked
    pytest -q

[testenv:coverage]
description = Run tests with coverage (Python-only; Rust coverage requires extra tooling)
deps =
    maturin>=1.9.6
    pytest>=7.0
    pytest-cov>=4.0.0
    numpy>=1.20.0
    pandas
    pillow>=9.0.0
    scikit-learn>=1.0
     scikit-image>=0.18.0
     xarray>=2023.0.0
     dask>=2023.0.0
setenv =
    RUST_BACKTRACE=1
commands =
    maturin develop --locked
    # ADDED --cov-report=xml to generate the required file for the badge script
    pytest --cov=eo_processor --cov-report=term-missing --cov-report=xml --cov-fail-under=80


[testenv:lint]
description = Static analysis (Python). Add Rust clippy separately in CI if desired.
deps =
    ruff>=0.4.0
    mypy>=1.8.0
    numpy>=1.20.0
    pillow>=9.0.0
    typing-extensions
commands =
    ruff check python/eo_processor
    mypy python/eo_processor

# Optional: define a clippy env if rust toolchain is available
[testenv:clippy]
skip_install = true
allowlist_externals = cargo
deps =
    maturin>=1.9.6
commands =
    cargo clippy --all-targets -- -D warnings

[pytest]
addopts = -q
testpaths = tests

# Ruff configuration can live here if not already elsewhere
[tool.ruff]
extend-exclude = ["target", ".venv"]
line-length = 100

[testenv:docs]
description = Build Sphinx documentation
deps =
    sphinx>=7.0.0,<8.0.0
    furo>=2024.1.0
    myst-parser>=2.0.0
    sphinx-autodoc-typehints>=2.0.0
    linkify-it-py>=2.0.0
    numpy>=1.20.0
commands =
    sphinx-build -b html docs/source docs/build/html

# ---------------------------------------------------------------------------
# Benchmark environments (per Python version) generate versioned rst outputs:
# docs/source/api/benchmark-py3XX.rst
# These synthetic benchmarks are non-blocking; adjust sizes if runtime is high.
# ---------------------------------------------------------------------------
[testenv:py38-bench]
description = Benchmark eo-processor (Python 3.8) and emit rst/json artifacts
deps =
    maturin>=1.9.6
    numpy>=1.20.0
    scipy>=1.10.0
    scikit-image>=0.18.0
setenv =
    RUST_BACKTRACE=1
commands =
    maturin develop --locked
    python -m benchmarking --group all --compare-numpy --loops 3 --warmups 1 \
        --height 1000 --width 1000 --time 24 --points-a 1000 --points-b 1000 --point-dim 32 \
        --rst-out docs/source/api/benchmark-py38.rst --json-out benchmark-py38.json

[testenv:py39-bench]
description = Benchmark eo-processor (Python 3.9) and emit rst/json artifacts
deps =
    maturin>=1.9.6
    numpy>=1.20.0
    scipy>=1.10.0
setenv =
    RUST_BACKTRACE=1
commands =
    maturin develop --locked
    python -m benchmarking --group all --compare-numpy --loops 3 --warmups 1 \
        --height 1000 --width 1000 --time 24 --points-a 1000 --points-b 1000 --point-dim 32 \
        --rst-out docs/source/api/benchmark-py39.rst --json-out benchmark-py39.json

[testenv:py310-bench]
description = Benchmark eo-processor (Python 3.10) and emit rst/json artifacts
deps =
    maturin>=1.9.6
    numpy>=1.20.0
    scipy>=1.10.0
setenv =
    RUST_BACKTRACE=1
commands =
    maturin develop --locked
    python -m benchmarking --group all --compare-numpy --loops 3 --warmups 1 \
        --height 1000 --width 1000 --time 24 --points-a 1000 --points-b 1000 --point-dim 32 \
        --rst-out docs/source/api/benchmark-py310.rst --json-out benchmark-py310.json

[testenv:py311-bench]
description = Benchmark eo-processor (Python 3.11) and emit rst/json artifacts
deps =
    maturin>=1.9.6
    numpy>=1.20.0
    scipy>=1.10.0
setenv =
    RUST_BACKTRACE=1
commands =
    maturin develop --locked
    python -m benchmarking --group all --compare-numpy --loops 3 --warmups 1 \
        --height 1000 --width 1000 --time 24 --points-a 1000 --points-b 1000 --point-dim 32 \
        --rst-out docs/source/api/benchmark-py311.rst --json-out benchmark-py311.json

[testenv:py312-bench]
description = Benchmark eo-processor (Python 3.12) and emit rst/json artifacts
deps =
    maturin>=1.9.6
    numpy>=1.20.0
    scipy>=1.10.0
setenv =
    RUST_BACKTRACE=1
commands =
    maturin develop --locked
    python -m benchmarking --group all --compare-numpy --loops 3 --warmups 1 \
        --height 1000 --width 1000 --time 24 --points-a 1000 --points-b 1000 --point-dim 32 \
        --rst-out docs/source/api/benchmark-py312.rst --json-out benchmark-py312.json

[testenv:py313-bench]
description = Benchmark eo-processor (Python 3.13) and emit rst/json artifacts
deps =
    maturin>=1.9.6
    numpy>=1.20.0
    scipy>=1.10.0
setenv =
    RUST_BACKTRACE=1
commands =
    maturin develop --locked
    python -m benchmarking --group all --compare-numpy --loops 3 --warmups 1 \
        --height 1000 --width 1000 --time 24 --points-a 1000 --points-b 1000 --point-dim 32 \
        --rst-out docs/source/api/benchmark-py313.rst --json-out benchmark-py313.json
