name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run tests
      run: |
        pytest tests/ -v

  publish:
    needs: test
    if: github.event.release.prerelease == false
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: Build package
      run: python -m build
    
    - name: Get package version
      id: get_version
      run: |
        pip install setuptools-scm
        VERSION=$(python -c "from setuptools_scm import get_version; print(get_version())")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“‹ Package version: $VERSION"

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "ğŸš€ Publishing to PyPI..."
        twine upload dist/* --verbose
        echo "âœ… Published to PyPI successfully!"
    
    - name: Verify PyPI publication
      run: |
        echo "ğŸ” Verifying publication on PyPI..."
        PACKAGE_NAME="redshift-comment-mcp"
        VERSION="${{ steps.get_version.outputs.version }}"
        
        # ç­‰å¾… PyPI æ›´æ–°
        sleep 30
        
        # æª¢æŸ¥å¥—ä»¶æ˜¯å¦å­˜åœ¨æ–¼ PyPI
        for i in {1..5};
        do
          echo "â³ Attempt $i/5: Checking PyPI availability..."
          if curl -f -s "https://pypi.org/pypi/$PACKAGE_NAME/$VERSION/json" > /dev/null;
          then
            echo "âœ… Package $PACKAGE_NAME version $VERSION is available on PyPI!"
            echo "ğŸ”— PyPI URL: https://pypi.org/project/$PACKAGE_NAME/$VERSION/"
            break
          else
            echo "â³ Not yet available, waiting 30 seconds..."
            sleep 30
          fi
          
          if [ $i -eq 5 ];
          then
            echo "âŒ Package not found on PyPI after 5 attempts"
            exit 1
          fi
        done

    - name: Create Release Report
      if: always()
      run: |
        echo "## ğŸ‰ PyPI Release Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Package Name**: redshift-comment-mcp" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **PyPI URL**: https://pypi.org/project/redshift-comment-mcp/${{ steps.get_version.outputs.version }}/" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status == 'success' && 'âœ… Success' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¥ Installation Command" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "pip install redshift-comment-mcp==${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”„ Upgrade Command" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "pip install --upgrade redshift-comment-mcp" >> $GITHUB_STEP_SUMMARY
        echo '```'

    - name: Add comment to release
      if: github.event_name == 'release' && success()
      uses: actions/github-script@v6
      with:
        script: |
          const version = '${{ steps.get_version.outputs.version }}';
          const pypiUrl = `https://pypi.org/project/redshift-comment-mcp/${version}/`;
          const installCmd = `pip install redshift-comment-mcp==${version}`;
          const upgradeCmd = `pip install --upgrade redshift-comment-mcp`;
          
          const body = '## ğŸš€ PyPI ç™¼å¸ƒæˆåŠŸï¼\n\n' +
            '**ç‰ˆæœ¬**: ' + version + '\n' +
            '**PyPI é é¢**: ' + pypiUrl + '\n\n' +
            '### ğŸ“¥ å®‰è£æŒ‡ä»¤\n' +
            '```bash\n' +
            installCmd + '\n' +
            '```\n\n' +
            '### ğŸ”„ å‡ç´šæŒ‡ä»¤\n' +
            '```bash\n' +
            upgradeCmd + '\n' +
            '```\n\n' +
            '### ğŸ“š ä½¿ç”¨æŒ‡å—\n' +
            'æŸ¥çœ‹ [README.md](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '#readme) äº†è§£è©³ç´°çš„ä½¿ç”¨æ–¹å¼ã€‚\n\n' +
            '---\n' +
            'ğŸ¤– *æ­¤è¨Šæ¯ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ*';

          if (context.payload.release.discussion) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.release.discussion.number,
              body: body
            });
          } else {
            console.log("No associated discussion found for this release. Skipping comment.");
          }
