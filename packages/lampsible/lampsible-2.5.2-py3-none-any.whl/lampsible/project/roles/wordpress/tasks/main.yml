---

# https://make.wordpress.org/cli/handbook/guides/quick-start/
- name: Download WP-CLI
  get_url:
    url: https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
    dest: /usr/local/bin/wp
    mode: '0755'

# https://developer.wordpress.org/cli/commands/core/download/
- name: Download WordPress
  # TODO: Maybe parameterize the --force flag, to be on the safe side.
  command:
  args:
    argv:
      - wp
      - core
      - download
      - --allow-root
      - --force
      - "--path={{ apache_document_root }}"
      - "--locale={{ wordpress_locale }}"
      - "--version={{ wordpress_version }}"

# https://developer.wordpress.org/cli/commands/config/create/
- name: Create wp-config.php
  # TODO: We can add --dbcharset and --dbcollate.
  # TODO: Maybe parameterize the --force flag, to be on the safe side.
  command:
  args:
    argv:
      - wp
      - config
      - create
      - --allow-root
      - --force
      - "--path={{ apache_document_root }}"
      - "--dbname={{ database_name }}"
      - "--dbuser={{ database_username }}"
      - "--dbpass={{ database_password }}"
      - "--dbhost={{ database_host }}"
      - "--dbprefix={{ database_table_prefix }}"
      - "--locale={{ wordpress_locale }}"
      - --extra-php
    stdin: "define( 'FS_METHOD', 'direct' );"

# https://developer.wordpress.org/cli/commands/core/install/
- name: Install WordPress
  command:
  args:
    argv:
      - wp
      - core
      - install
      - --allow-root
      - "--path={{ apache_document_root }}"
      - "--url={{ wordpress_url }}"
      - "--title={{ site_title }}"
      - "--admin_user={{ admin_username }}"
      - "--admin_password={{ admin_password }}"
      - "--admin_email={{ admin_email }}"
      - "--locale={{ wordpress_locale }}"

# https://developer.wordpress.org/cli/commands/theme/
- name: Install and activate optional WordPress theme
  command:
  args:
    argv:
      - wp
      - theme
      - install
      - "{{ wordpress_theme }}"
      - --activate
      - --allow-root
      - "--path={{ apache_document_root }}"
  when: wordpress_theme != None


# https://developer.wordpress.org/cli/commands/plugin/
- name: Install and activate any WordPress plugins
  command:
  args:
    argv:
      - wp
      - plugin
      - install
      - "{{ wp_plugin }}"
      - --activate
      - --allow-root
      - "--path={{ apache_document_root }}"
  loop: "{{ wordpress_plugins }}"
  loop_control:
    loop_var: wp_plugin
  when: wordpress_plugins != None and wordpress_plugins | length > 0

- name: Set file ownership for WordPress directory
  file:
    path: "{{ apache_document_root }}"
    state: directory
    recurse: yes
    owner: www-data
    group: www-data

# TODO: It would be really cool if WP-CLI could do this, for example,
# passing a '--harden' flag to the 'config' command.
# However, to my knowledge, it currently can't.
# It might be worth reaching out to them, to contribute that feature.
# If WP-CLI ever does support this, then we can remove this block.
- name: Tighten permissions on wp-config.php
  file:
    path: "{{ apache_document_root }}/wp-config.php"
    mode: '600'
