const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-D87ilqMg.js","assets/index-BkOs2SaT.css"])))=>i.map(i=>d[i]);
import{c as G,u as A,e as L,a as D,B as y,r as h,j as e,Q as B,T as H,U as J,V as Y,L as _,p as I,S as q,f as z,h as E,i as T,k as F,g as k,b as x,W as Z,t as m,Y as ie,I as U,x as de,Z as ue,_ as me,$ as K,G as he,z as Q,a0 as pe,a1 as xe,a2 as ge,a3 as fe,D as je,J as ye,K as ee,C as se,q as ve}from"./index-D87ilqMg.js";import{I as R}from"./library-Cqp4m2hh.js";import{L as re,a as ae,E as we}from"./useLocalStorage-DEoeC3Vt.js";import{C as be,F as Ne,D as te}from"./file-text-Dkjc4zMz.js";import{C as ne,W as V,S as X,I as Ce}from"./ImageSelectorDialog-B6Oj3KZA.js";import{u as Se,a as oe,b as ke}from"./useWorkflows-DOUPJgnh.js";import{u as _e}from"./comfy-hqZb5pXy.js";import{S as Ie}from"./save-BbL542gH.js";import{T as De}from"./trash-2-CTOpWkMI.js";import"./eye-B6DXG3sW.js";import"./ImageBrowser-DL7XfliW.js";import"./library-CemcgxM6.js";const Pe=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],Fe=G("download",Pe);const Le=[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M10.41 10.41a2 2 0 1 1-2.83-2.83",key:"1bzlo9"}],["line",{x1:"13.5",x2:"6",y1:"13.5",y2:"21",key:"1q0aeu"}],["line",{x1:"18",x2:"21",y1:"12",y2:"15",key:"5mozeu"}],["path",{d:"M3.59 3.59A1.99 1.99 0 0 0 3 5v14a2 2 0 0 0 2 2h14c.55 0 1.052-.22 1.41-.59",key:"mmje98"}],["path",{d:"M21 15V5a2 2 0 0 0-2-2H9",key:"43el77"}]],qe=G("image-off",Le);const ze=[["path",{d:"M8 19H5c-1 0-2-1-2-2V7c0-1 1-2 2-2h3",key:"lubmu8"}],["path",{d:"M16 5h3c1 0 2 1 2 2v10c0 1-1 2-2 2h-3",key:"1ag34g"}],["line",{x1:"12",x2:"12",y1:"4",y2:"20",key:"1tx1rr"}]],Ee=G("square-split-horizontal",ze);const Te=[["path",{d:"M12 19h8",key:"baeox8"}],["path",{d:"m4 17 6-6-6-6",key:"1yngyt"}]],$e=G("terminal",Te);async function Me(){const s=await fetch(`${y}/datasets`);if(!s.ok)throw new Error("Failed to fetch datasets");return s.json()}async function Ae(s){const a=await fetch(`${y}/datasets/${s}/items`);if(!a.ok)throw new Error("Failed to fetch dataset items");return a.json()}async function Oe(s){const a=await fetch(`${y}/datasets`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!a.ok)throw new Error("Failed to create dataset");return a.json()}async function Ke(s){if(!(await fetch(`${y}/datasets/${s}`,{method:"DELETE"})).ok)throw new Error("Failed to delete dataset")}async function Re(s){const a=await fetch(`${y}/datasets/${s}/export`,{method:"POST"});if(!a.ok)throw new Error("Failed to export dataset");return a.json()}async function Ve(s){const a=await fetch(`${y}/datasets/${s.datasetId}/items/${s.itemId}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(s.updates)});if(!a.ok)throw new Error("Failed to update dataset item");return a.json()}async function Ge(s){const a=await fetch(`${y}/datasets/${s.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(s.updates)});if(!a.ok)throw new Error("Failed to update dataset");return a.json()}function Qe(){return A({queryKey:["datasets"],queryFn:Me})}function We(){const s=L();return D({mutationFn:Ge,onSuccess:a=>{s.invalidateQueries({queryKey:["dataset",a.id]}),s.invalidateQueries({queryKey:["datasets"]})}})}function Ue(s){return A({queryKey:["dataset-items",s],queryFn:()=>s?Ae(s):Promise.resolve([]),enabled:!!s})}function Be(){const s=L();return D({mutationFn:Oe,onSuccess:()=>{s.invalidateQueries({queryKey:["datasets"]})}})}function He(){const s=L();return D({mutationFn:Ke,onSuccess:()=>{s.invalidateQueries({queryKey:["datasets"]})}})}function Je(){const s=L();return D({mutationFn:Ve,onSuccess:(a,i)=>{s.invalidateQueries({queryKey:["dataset-items",i.datasetId]})}})}function Ye(){return D({mutationFn:Re})}async function Ze(s){const a=await fetch(`${y}/datasets/${s}/caption`,{method:"POST"});if(!a.ok)throw new Error("Failed to start auto-captioning");return a.json()}async function Xe(s){const a=await fetch(`${y}/datasets/${s.datasetId}/items/${s.itemId}/caption`,{method:"POST"});if(!a.ok)throw new Error("Failed to generate caption");return a.json()}function es(){const s=L();return D({mutationFn:Ze,onSuccess:()=>{s.invalidateQueries({queryKey:["captioning-status"]})}})}function ss(){const s=L();return D({mutationFn:Xe,onSuccess:(a,i)=>{s.invalidateQueries({queryKey:["dataset-items",i.datasetId]}),s.invalidateQueries({queryKey:["captioning-status"]})}})}function as(){return A({queryKey:["captioning-models"],queryFn:async()=>{const s=await fetch(`${y}/captioning/models`);if(!s.ok)throw new Error("Failed to fetch captioning models");return s.json()}})}function le(){return A({queryKey:["captioning-status"],queryFn:async()=>{const s=await fetch(`${y}/captioning/status`);if(!s.ok)throw new Error("Failed to fetch captioning status");return s.json()},refetchInterval:2e3})}function ts(){const s=L();return D({mutationFn:async a=>{const i=await fetch(`${y}/captioning/load`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_name:a})});if(!i.ok)throw new Error("Failed to load model");return i.json()},onSuccess:()=>{s.invalidateQueries({queryKey:["captioning-status"]})}})}function ns(){const s=L();return D({mutationFn:async()=>{const a=await fetch(`${y}/captioning/unload`,{method:"POST"});if(!a.ok)throw new Error("Failed to unload model");return a.json()},onSuccess:()=>{s.invalidateQueries({queryKey:["captioning-status"]})}})}function is({dataset:s,open:a,onOpenChange:i}){const n=We(),{data:c,isLoading:d}=as(),{data:l}=le(),o=ts(),g=ns(),[t,u]=h.useState(""),[p,v]=h.useState("caption"),[j,P]=h.useState({});h.useEffect(()=>{if(s.captioning_config)try{const r=JSON.parse(s.captioning_config);u(r.model||"vikhyatk/moondream2"),v(r.mode||"caption");const{model:f,mode:w,...N}=r;P(N)}catch{}else c&&c.length>0&&!t&&u(c[0].id)},[s,c]);const C=c?.find(r=>r.id===t),S=l?.loaded_model===t,$=async()=>{try{await o.mutateAsync(t),m.success(`Model ${C?.name} loaded`)}catch{m.error("Failed to load model")}},O=async()=>{try{await g.mutateAsync(),m.success("Model unloaded")}catch{m.error("Failed to unload model")}},M=async()=>{try{const r={model:t,mode:p,...j};await n.mutateAsync({id:s.id,updates:{captioning_config:JSON.stringify(r)}}),m.success("Settings saved"),i(!1)}catch{m.error("Failed to save settings")}},b=r=>{const f=j[r.name]??r.default??"",w=N=>{P(W=>({...W,[r.name]:N}))};return r.type==="select"?e.jsxs(q,{value:f,onValueChange:w,children:[e.jsx(z,{children:e.jsx(E,{})}),e.jsx(T,{children:r.options?.map(N=>e.jsx(F,{value:N.value.toString(),children:N.label},N.value.toString()))})]}):r.type==="textarea"?e.jsx(ie,{value:f,onChange:N=>w(N.target.value),placeholder:r.placeholder,rows:3}):e.jsx(U,{value:f,onChange:N=>w(N.target.value),placeholder:r.placeholder})};return e.jsx(B,{open:a,onOpenChange:i,children:e.jsxs(H,{className:"max-w-2xl!",children:[e.jsx(J,{children:e.jsx(Y,{children:"Captioning Settings"})}),d?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(_,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{children:"Model"}),e.jsxs(q,{value:t,onValueChange:u,children:[e.jsx(z,{children:e.jsx(E,{placeholder:"Select a model"})}),e.jsx(T,{children:c?.map(r=>e.jsx(F,{value:r.id,children:r.name},r.id))})]}),C?.description&&e.jsx("p",{className:"text-xs text-muted-foreground",children:C.description}),e.jsxs("div",{className:"flex items-center justify-between bg-muted/50 p-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:k("w-2 h-2",S?"bg-green-500":"bg-yellow-500")}),e.jsx("span",{className:"text-xs font-medium",children:S?"Model Loaded":l?.loaded_model?`Other Model Loaded (${l.loaded_model})`:"No Model Loaded"})]}),e.jsx("div",{className:"flex gap-2",children:S?e.jsxs(x,{size:"sm",variant:"outline",onClick:O,disabled:g.isPending,className:"h-7 text-xs",children:[g.isPending&&e.jsx(_,{className:"mr-1 h-3 w-3 animate-spin"}),"Unload"]}):e.jsxs(x,{size:"sm",variant:"secondary",onClick:$,disabled:o.isPending,className:"h-7 text-xs",children:[o.isPending&&e.jsx(_,{className:"mr-1 h-3 w-3 animate-spin"}),"Load Now"]})})]})]}),C&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{children:"Mode"}),e.jsxs(q,{value:p,onValueChange:v,children:[e.jsx(z,{children:e.jsx(E,{})}),e.jsx(T,{children:C.capabilities.map(r=>e.jsx(F,{value:r,children:r.charAt(0).toUpperCase()+r.slice(1)},r))})]})]}),C&&C.options[p]?.map(r=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs(I,{children:[r.label,r.required&&e.jsx("span",{className:"text-destructive ml-1",children:"*"})]}),b(r),r.description&&e.jsx("p",{className:"text-xs text-muted-foreground",children:r.description})]},r.name))]}),e.jsx(Z,{children:e.jsxs(x,{onClick:M,disabled:n.isPending||d,children:[n.isPending&&e.jsx(_,{className:"mr-2 h-4 w-4 animate-spin"}),"Save Settings"]})})]})})}async function rs(){const s=await fetch(`${y}/collections`);if(!s.ok)throw new Error("Failed to fetch collections");return s.json()}function os(){return A({queryKey:["collections"],queryFn:rs})}function ls({open:s,onOpenChange:a}){const[i,n]=h.useState(""),[c,d]=h.useState(""),[l,o]=h.useState("regular"),[g,t]=h.useState(""),{data:u}=os(),p=Be(),v=async j=>{if(j.preventDefault(),!(!i||!g))try{await p.mutateAsync({name:i,description:c,type:l,collection_id:parseInt(g)}),m.success("Dataset created successfully"),a(!1),n(""),d(""),t("")}catch{m.error("Failed to create dataset")}};return e.jsx(B,{open:s,onOpenChange:a,children:e.jsxs(H,{className:"max-w-lg!",children:[e.jsx(J,{children:e.jsx(Y,{children:"Create New Dataset"})}),e.jsxs("form",{onSubmit:v,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"name",children:"Name"}),e.jsx(U,{autoComplete:"off",id:"name",value:i,onChange:j=>n(j.target.value),placeholder:"My Dataset",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"description",children:"Description"}),e.jsx(U,{autoComplete:"off",id:"description",value:c,onChange:j=>d(j.target.value),placeholder:"Optional description"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"type",children:"Type"}),e.jsxs(q,{value:l,onValueChange:j=>o(j),children:[e.jsx(z,{children:e.jsx(E,{})}),e.jsxs(T,{children:[e.jsx(F,{value:"regular",children:"Regular (Images + Captions)"}),e.jsx(F,{value:"image_pair",children:"Image Pair (Input + Target)"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"collection",children:"Source Collection"}),e.jsxs(q,{value:g,onValueChange:t,required:!0,children:[e.jsx(z,{children:e.jsx(E,{placeholder:"Select a collection"})}),e.jsx(T,{children:u?.map(j=>e.jsxs(F,{value:j.id.toString(),children:[j.name," (",j.item_count," items)"]},j.id))})]})]}),e.jsx(Z,{children:e.jsxs(x,{type:"submit",disabled:p.isPending,children:[p.isPending&&e.jsx(_,{className:"mr-2 h-4 w-4 animate-spin"}),"Create Dataset"]})})]})]})})}function cs({dataset:s}){const a=Ye(),i=async()=>{try{const n=await a.mutateAsync(s.id);m.success("Dataset exported",{description:n.message})}catch{m.error("Failed to export dataset")}};return e.jsxs("div",{className:"flex items-center justify-between p-2 border bg-card shrink-0",children:[e.jsx("div",{children:e.jsxs("h2",{className:"text-2xl font-bold flex items-center gap-2",children:[s.name,e.jsx(de,{variant:"secondary",className:"capitalize",children:s.type.replace("_"," ")})]})}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(x,{onClick:i,disabled:a.isPending,size:"sm",children:[a.isPending?e.jsx(_,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(Fe,{className:"mr-2 h-4 w-4"}),"Export"]})})]})}function ds({dataset:s,filter:a,setFilter:i,viewMode:n,setViewMode:c,onOpenSettings:d}){const l=es(),{data:o}=le(),g=o?.loaded_model===JSON.parse(s.captioning_config||"{}").model,t=async()=>{try{await l.mutateAsync(s.id),m.success("Auto-captioning started",{description:"This process runs in the background."})}catch{m.error("Failed to start auto-captioning")}};return e.jsxs("div",{className:"flex items-center gap-2 p-1  bg-muted/30 shrink-0 border",children:[e.jsx(ue,{value:a,onValueChange:u=>i(u),className:"w-auto",children:e.jsxs(me,{className:"h-8",children:[e.jsx(K,{value:"all",className:"text-xs",children:"All"}),e.jsx(K,{value:"missing_caption",className:"text-xs",children:"Missing Caption"}),e.jsx(K,{value:"has_caption",className:"text-xs",children:"Captioned"}),e.jsx(K,{value:"processed",className:"text-xs",children:"Processed"}),s.type==="image_pair"&&e.jsx(K,{value:"paired",className:"text-xs",children:"Paired"})]})}),s.type==="image_pair"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex bg-background/80 backdrop-blur-sm  border shadow-sm gap-1",children:[e.jsx(x,{size:"icon-sm",variant:n==="base"?"outline":"ghost",onClick:()=>c("base"),title:"Show Base Images",children:e.jsx(R,{})}),e.jsx(x,{size:"icon-sm",variant:n==="pair"?"outline":"ghost",onClick:()=>c("pair"),title:"Show Pair Images",children:e.jsx(re,{})})]})}),e.jsx("div",{className:"flex-1"}),g?e.jsx("span",{className:"flex items-center gap-1 text-sm text-green-600 font-medium",children:e.jsx(be,{className:"w-4 h-4"})}):o?.loaded_model?e.jsx("span",{className:"flex items-center gap-1 text-sm text-yellow-600 font-medium",children:e.jsx(ne,{className:"w-4 h-4"})}):e.jsx("span",{className:"flex items-center gap-1 text-sm text-muted-foreground font-medium",children:e.jsx(ne,{className:"w-4 h-4"})}),e.jsx(x,{variant:"ghost",size:"icon-sm",onClick:d,title:"Captioning Settings",children:e.jsx(he,{className:"w-4 h-4"})}),e.jsxs(x,{variant:"outline",size:"sm",className:"h-8",onClick:t,disabled:l.isPending,children:[l.isPending?e.jsx(_,{className:"mr-2 h-3 w-3 animate-spin"}):e.jsx(V,{className:"w-3 h-3 mr-2"}),"Auto-Caption"]})]})}function us({isLoading:s,filteredItems:a,selectedItem:i,setSelectedItem:n,viewMode:c}){const[d]=ae("explore-grid-cols",5),[l]=ae("explore-image-fit","contain");return e.jsx(Q,{className:"h-full",type:"always",children:e.jsx("div",{className:"grid gap-1 pr-4",style:{gridTemplateColumns:`repeat(${d}, minmax(0, 1fr))`},children:s?e.jsx("div",{className:"col-span-full text-center py-8 text-muted-foreground",children:"Loading items..."}):a.length===0?e.jsx("div",{className:"col-span-full text-center py-8 text-muted-foreground",children:"No items match the current filter."}):a.map(o=>{const t=c==="pair"?o.pair_image_path:o.processed_image_path||o.original_path;return e.jsxs("div",{className:k("group relative aspect-square overflow-hidden border bg-muted cursor-pointer transition-all hover:border-primary",i?.id===o.id&&"border-primary"),onClick:()=>n(o),children:[t?e.jsx("img",{src:`${y}/images/file?path=${encodeURIComponent(t)}`,alt:"",className:k("w-full h-full",l==="contain"?"object-contain":"object-cover"),loading:"lazy"}):e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center text-muted-foreground p-2 text-center bg-muted/50",children:[e.jsx(qe,{className:"w-8 h-8 mb-2 opacity-50"}),e.jsx("span",{className:"text-xs font-medium",children:"No Pair Image"})]}),e.jsxs("div",{className:"absolute top-1 right-1 flex flex-col gap-1 pointer-events-none",children:[o.caption&&e.jsx("div",{className:"bg-black/60 text-white p-1 rounded-sm backdrop-blur-sm",title:"Has Caption",children:e.jsx(Ne,{className:"w-3 h-3"})}),o.processed_image_path&&e.jsx("div",{className:"bg-blue-500/80 text-white p-1 rounded-sm backdrop-blur-sm",title:"Processed",children:e.jsx(X,{className:"w-3 h-3"})}),o.pair_image_path&&e.jsx("div",{className:"bg-green-500/80 text-white p-1 rounded-sm backdrop-blur-sm",title:"Paired",children:e.jsx(Ee,{className:"w-3 h-3"})})]}),e.jsx("div",{className:"absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-2",children:e.jsx("p",{className:"text-white text-xs line-clamp-2 w-full font-mono",children:o.caption||"No caption"})})]},o.id)})})})}function ms({value:s,onChange:a,disabled:i}){const{data:n,isLoading:c}=Se();return e.jsxs(q,{value:s?.toString(),onValueChange:d=>a(parseInt(d)),disabled:i||c,children:[e.jsx(z,{children:e.jsx(E,{placeholder:"Select a workflow"})}),e.jsx(T,{children:n?.map(d=>e.jsx(F,{value:d.id.toString(),children:d.name},d.id))})]})}function hs({workflowId:s,value:a,onChange:i,nodeType:n,disabled:c,label:d="Select a node"}){const{data:l,isLoading:o}=oe(s),g=h.useMemo(()=>{if(!l?.data)return[];let t=[];if(l.data.nodes&&Array.isArray(l.data.nodes)?t=l.data.nodes.map(u=>({id:u.id.toString(),type:u.type,title:u.title||u.type})):t=Object.entries(l.data).map(([u,p])=>({id:u,type:p.class_type,title:p._meta?.title||p.class_type})),n){const u=Array.isArray(n)?n:[n];return t.filter(p=>u.includes(p.type))}return t},[l,n]);return e.jsxs(q,{value:a||"",onValueChange:i,disabled:c||o||!s,children:[e.jsx(z,{children:e.jsx(E,{placeholder:d})}),e.jsx(T,{children:g.length===0?e.jsx("div",{className:"p-2 text-sm text-muted-foreground",children:"No matching nodes found"}):g.map(t=>e.jsxs(F,{value:t.id,children:[t.title," (",t.id,")"]},t.id))})]})}function ps({open:s,onOpenChange:a,imagePath:i,imageId:n,onSuccess:c,title:d="Generate Image Pair",description:l="Select a workflow to generate a pair for this image."}){const[o,g]=h.useState(null),[t,u]=h.useState(null),[p,v]=h.useState(!1),j=ke(),{data:P}=oe(o),C=async()=>{if(!(!o||!t)){v(!0);try{let S={};const $=P?.meta?.exposed_inputs?.[t];if($&&"image_id"in $){if(!n){m.error("This workflow requires an Image ID, but none was provided."),v(!1);return}S={[t]:{image_id:n}}}else{m.info("Uploading image to ComfyUI...");const f=await _e(i,void 0,!0);S={[t]:{image:f.name}}}m.info("Running workflow...");const M=await j.mutateAsync({id:o,inputs:S}),b=M.outputs.filter(f=>f.type==="image"),r=M.outputs.filter(f=>f.type==="embeddr_id");if(r.length>0){const f=r[r.length-1].value;try{const w=await xe(f);if(w&&w.path){c(w.path),a(!1),m.success("Generation complete!");return}}catch(w){console.error("Failed to fetch image details",w),m.error("Failed to retrieve generated image details")}}if(b.length>0){const f=b[b.length-1];c(f.filename),a(!1),m.success("Generation complete!")}else m.error("Workflow completed but no image output found.")}catch(S){console.error(S),m.error("Failed to run workflow")}finally{v(!1)}}};return e.jsx(B,{open:s,onOpenChange:a,children:e.jsxs(H,{children:[e.jsxs(J,{children:[e.jsx(Y,{children:d}),e.jsx(pe,{children:l})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(I,{children:"Workflow"}),e.jsx(ms,{value:o,onChange:g})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(I,{children:"Input Node (Load Image)"}),e.jsx(hs,{workflowId:o,value:t,onChange:u,nodeType:["LoadImage","EmbeddrLoadImage","EmbeddrLoadImageID","embeddr.LoadImageID","embeddr.LoadImage"],label:"Select image input node",disabled:!o})]})]}),e.jsxs(Z,{children:[e.jsx(x,{variant:"outline",onClick:()=>a(!1),disabled:p,children:"Cancel"}),e.jsxs(x,{onClick:C,disabled:!o||!t||p,children:[p&&e.jsx(_,{className:"mr-2 h-4 w-4 animate-spin"}),"Generate"]})]})]})})}function xs({dataset:s,selectedItem:a}){const i=Je(),n=ss(),[c,d]=h.useState(""),[l,o]=h.useState("base"),[g,t]=h.useState(!1),[u,p]=h.useState(!1);h.useEffect(()=>{a&&d(a.caption||"")},[a]);const v=async()=>{if(a)try{await i.mutateAsync({datasetId:s.id,itemId:a.id,updates:{caption:c}}),m.success("Caption updated")}catch{m.error("Failed to update caption")}},j=async()=>{if(a)try{const f=await n.mutateAsync({datasetId:s.id,itemId:a.id});d(f.caption),m.success("Caption generated")}catch{m.error("Failed to generate caption")}},P=()=>{t(!0)},C=()=>{p(!0)},S=async f=>{if(a)try{const{fetchLocalImage:w}=await fe(async()=>{const{fetchLocalImage:W}=await import("./index-D87ilqMg.js").then(ce=>ce.aT);return{fetchLocalImage:W}},__vite__mapDeps([0,1])),N=await w(f.id);await i.mutateAsync({datasetId:s.id,itemId:a.id,updates:{pair_image_path:N.path}}),o("pair"),m.success("Pair image updated")}catch(w){console.error(w),m.error("Failed to update pair image")}},$=async f=>{if(a)try{await i.mutateAsync({datasetId:s.id,itemId:a.id,updates:{pair_image_path:f}}),o("pair")}catch{m.error("Failed to update pair image")}};if(!a)return e.jsx("div",{className:"flex items-center justify-center h-full text-muted-foreground",children:"Select an item to edit"});const O=s.type==="image_pair",M=!!a.pair_image_path,b=O?l:"base",r=b==="base"?a.processed_image_path||a.original_path:a.pair_image_path;return e.jsxs("div",{className:"h-full p-2 flex gap-2 shrink-0",children:[e.jsx(ps,{open:g,onOpenChange:t,imagePath:a.processed_image_path||a.original_path,imageId:a.original_image_id,onSuccess:$,title:"Generate Pair Image",description:"Select a workflow to generate the paired image."}),e.jsx(Ce,{open:u,onOpenChange:p,onSelect:S,title:"Select Pair Image",description:"Choose an existing image to use as the pair."}),e.jsxs("div",{className:"aspect-square h-full overflow-hidden border bg-muted relative group flex items-center justify-center",children:[r?e.jsx("img",{src:`${y}/images/file?path=${encodeURIComponent(r)}`,alt:b==="base"?"Base Image":"Pair Image",className:"w-full h-full object-contain"}):e.jsxs("div",{className:"text-center p-4 flex flex-col gap-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"No Pair Image"}),e.jsxs(x,{size:"sm",variant:"outline",onClick:P,children:[e.jsx(V,{className:"w-3 h-3 mr-2"}),"Generate"]}),e.jsxs(x,{size:"sm",variant:"ghost",onClick:C,children:[e.jsx(R,{className:"w-3 h-3 mr-2"}),"Select Existing"]})]}),e.jsx("div",{className:"absolute top-2 left-2 flex gap-1",children:e.jsxs("div",{className:"flex bg-background/80 backdrop-blur-sm gap-1 border shadow-sm p-0.5",children:[e.jsx(x,{size:"icon-sm",variant:b==="base"?"outline":"ghost",className:"h-7 w-7",onClick:()=>o("base"),title:"Base Image",children:e.jsx(R,{className:"w-4 h-4"})}),O&&e.jsx(x,{size:"icon-sm",variant:b==="pair"?"outline":"ghost",className:k("h-7 w-7",!M&&"text-muted-foreground"),onClick:()=>o("pair"),title:"Pair Image",children:e.jsx(re,{className:"w-4 h-4"})})]})}),e.jsxs("div",{className:"absolute top-2 right-2 flex gap-1",children:[b==="base"&&a.original_image_id&&e.jsx(ge,{to:"/images/$imageId",params:{imageId:a.original_image_id.toString()},target:"_blank",title:"View Image Details",children:e.jsx(x,{size:"icon-sm",variant:"secondary",className:"h-7 w-7 opacity-50 hover:opacity-100",children:e.jsx(we,{className:"w-4 h-4"})})}),b==="base"&&a.processed_image_path&&e.jsx("div",{className:"bg-background/80 backdrop-blur-sm px-2 py-1  border text-xs font-medium shadow-sm",children:"Processed"})]}),e.jsxs("div",{className:"absolute bottom-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:[b==="base"&&e.jsx(x,{size:"sm",variant:"secondary",className:"h-8 w-8 p-0",title:"Edit Image",children:e.jsx(X,{className:"w-4 h-4"})}),b==="pair"&&e.jsxs(e.Fragment,{children:[e.jsx(x,{size:"sm",variant:"secondary",className:"h-8 w-8 p-0",title:"Select Existing Pair",onClick:C,children:e.jsx(R,{className:"w-4 h-4"})}),e.jsx(x,{size:"sm",variant:"secondary",className:"h-8 w-8 p-0",title:"Regenerate Pair",onClick:P,children:e.jsx(V,{className:"w-4 h-4"})})]})]})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-1 min-h-0 overflow-hidden",children:[e.jsx(I,{hidden:!0,children:"Caption"}),e.jsx("div",{className:"flex-1 min-h-0 relative",children:e.jsx(Q,{type:"always",variant:"left-border",className:"h-full border bg-card!",children:e.jsx(ie,{className:"flex min-h-full bg-card! h-full w-full resize-none font-mono text-sm border-none focus-visible:ring-0 p-4 border-0! shadow-none",value:c,placeholder:"Enter caption...",onChange:f=>d(f.target.value)})})}),e.jsxs("div",{className:"flex justify-end gap-2 shrink-0 py-1 ",children:[e.jsx(x,{size:"icon-sm",variant:"outline",onClick:j,disabled:n.isPending,children:n.isPending?e.jsx(_,{className:"animate-spin"}):e.jsx(V,{})}),e.jsx(x,{size:"icon-sm",onClick:v,disabled:i.isPending,children:i.isPending?e.jsx(_,{className:"animate-spin"}):e.jsx(Ie,{})})]})]})]})}function gs({isActive:s}){const a=h.useRef(null),{data:i,isLoading:n}=A({queryKey:["system-logs-viewer"],queryFn:()=>je(100),refetchInterval:s?2e3:!1,enabled:s});return h.useEffect(()=>{s&&i&&a.current?.scrollIntoView({behavior:"smooth"})},[i,s]),e.jsxs("div",{className:"h-full w-full flex flex-col min-h-0",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b bg-muted/20 shrink-0",children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground",children:"System Logs (Last 100 lines)"}),n&&e.jsx(_,{className:"h-3 w-3 animate-spin text-muted-foreground"})]}),e.jsx("div",{className:"flex-1 min-h-0 relative",children:e.jsx(Q,{type:"always",variant:"left-border",className:"h-full w-full bg-black/90 text-white font-mono text-xs",children:e.jsxs("div",{className:"p-4",children:[i?.map((c,d)=>e.jsx("div",{className:"whitespace-pre-wrap border-b border-white/10 py-0.5 last:border-0 break-all",children:c},d)),(!i||i.length===0)&&!n&&e.jsx("div",{className:"text-muted-foreground italic py-2",children:"No logs available..."}),e.jsx("div",{ref:a})]})})})]})}function fs({dataset:s,filteredItems:a,isLoading:i,selectedItem:n,setSelectedItem:c,viewMode:d}){const[l,o]=h.useState(null),[g,t]=h.useState(!1),u=p=>{o(l===p?null:p)};return e.jsxs("div",{className:"flex flex-col flex-1 min-h-0",children:[e.jsxs(ye,{orientation:"vertical",className:"flex-1 gap-1",children:[e.jsx(ee,{defaultSize:100,minSize:l==null?100:30,maxSize:100,children:e.jsx(us,{isLoading:i,filteredItems:a,selectedItem:n,setSelectedItem:c,viewMode:d})}),e.jsx(ee,{collapsible:!0,collapsedSize:0,maxSize:50,defaultSize:20,minSize:15,className:k(g&&"min-h-0 transition-all duration-300 ease-in-out",l!==null?"block":"hidden"),children:e.jsxs("div",{className:"h-full overflow-hidden bg-muted/30 border border-b-0",children:[e.jsx("div",{className:k("h-full",l==="editor"?"block":"hidden"),children:e.jsx(xs,{dataset:s,selectedItem:n})}),e.jsx("div",{className:k("h-full",l==="logs"?"block":"hidden"),children:e.jsx(gs,{isActive:l==="logs"&&!g})})]})})]}),e.jsxs("div",{className:k("bg-muted/30 shrink-0 h-9 flex items-center justify-between p-1 border"),children:[e.jsx(x,{variant:"ghost",size:"icon-sm",onClick:()=>u("editor"),className:k("h-full rounded-none  hover:bg-muted border-none!",l==="editor"&&"bg-primary/50! border-none!"),children:e.jsx(X,{})}),e.jsx(x,{variant:"link",size:"icon-sm",onClick:()=>u("logs"),className:k("h-full rounded-none  hover:bg-muted border-none!",l==="logs"&&"bg-primary/50! border-none!"),children:e.jsx($e,{})})]})]})}function js({dataset:s}){const{data:a,isLoading:i}=Ue(s.id),[n,c]=h.useState("all"),[d,l]=h.useState("base"),[o,g]=h.useState(null),[t,u]=h.useState(!1),p=h.useMemo(()=>a?a.filter(v=>n==="all"?!0:n==="missing_caption"?!v.caption:n==="has_caption"?!!v.caption:n==="processed"?!!v.processed_image_path:n==="paired"?!!v.pair_image_path:!0):[],[a,n]);return e.jsxs("div",{className:"flex flex-col h-full  gap-1",children:[e.jsx(is,{dataset:s,open:t,onOpenChange:u}),e.jsx(cs,{dataset:s}),e.jsx(ds,{dataset:s,items:a,filter:n,setFilter:c,viewMode:d,setViewMode:l,onOpenSettings:()=>u(!0)}),e.jsx(fs,{dataset:s,filteredItems:p,isLoading:i,selectedItem:o,setSelectedItem:g,viewMode:d})]})}function ys(){const{data:s,isLoading:a}=Qe(),i=He(),[n,c]=h.useState(null),[d,l]=h.useState(!1),o=s?.find(t=>t.id===n),g=async(t,u)=>{t.stopPropagation(),confirm("Are you sure you want to delete this dataset?")&&(await i.mutateAsync(u),m.success("Dataset deleted"),n===u&&c(null))};return e.jsxs("div",{className:"p-1 w-full grid grid-cols-4 grid-rows-[auto_1fr] md:grid-rows-[1fr] gap-1 h-full overflow-visible",children:[e.jsx("div",{className:"col-span-4 md:col-span-1 shrink-0! overflow-visible h-auto md:h-full border-none ring-0! shadow-none bg-transparent p-0! min-h-0 gap-1",children:e.jsxs(se,{className:"flex-1 h-auto md:h-full p-0! gap-0! shrink-0 flex flex-col overflow-visible min-h-0",children:[e.jsxs("div",{className:"flex items-center justify-between shrink-0 border-b border-foreground/10 p-2 bg-muted/35",children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Datasets"}),e.jsx(x,{size:"icon-sm",variant:"ghost",className:"h-6 w-6",onClick:()=>l(!0),children:e.jsx(ve,{className:"w-4 h-4"})})]}),e.jsx(Q,{className:"flex-1",children:e.jsx("div",{className:"p-2 flex flex-col gap-1",children:a?e.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"Loading..."}):s?.length===0?e.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"No datasets found."}):s?.map(t=>e.jsxs("div",{className:k("group flex items-center justify-between p-2 cursor-pointer hover:bg-accent/50 transition-colors",n===t.id?"bg-accent text-accent-foreground":"text-muted-foreground"),onClick:()=>c(t.id),children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx(te,{className:"w-4 h-4 shrink-0"}),e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("span",{className:"truncate text-sm font-medium",children:t.name}),e.jsxs("span",{className:"text-xs opacity-70 truncate",children:[t.item_count," items"]})]})]}),e.jsx(x,{variant:"ghost",size:"icon-sm",className:"opacity-0 group-hover:opacity-100 h-6 w-6",onClick:u=>g(u,t.id),children:e.jsx(De,{className:"w-3 h-3 text-destructive"})})]},t.id))})})]})}),e.jsx(se,{className:"col-span-4 md:col-span-3 flex grow flex-col overflow-hidden h-full border-none ring-0! shadow-none bg-transparent p-0! min-h-0",children:o?e.jsx(js,{dataset:o}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-muted-foreground",children:[e.jsx(te,{className:"w-12 h-12 mb-4 opacity-20"}),e.jsx("p",{children:"Select a dataset to view details"})]})}),e.jsx(ls,{open:d,onOpenChange:l})]})}const Ls=ys;export{Ls as component};
