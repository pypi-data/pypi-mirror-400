name: CI

on: [pull_request]

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pre-commit~=4.5.0
          python3 -m pre_commit install

      - name: Run pre-commit
        run: pre-commit run --all-files

  test:
    name: Test (Python ${{ matrix.python-version }}, Django ${{ matrix.django-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "3.8"
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
          - "3.14"
        django-version:
          - "4.2"
          - "5.0"
          - "5.1"
          - "5.2"
          - "6.0"
          - "main"
        include:
          # https://docs.djangoproject.com/en/dev/faq/install/#what-python-version-can-i-use-with-django

          # ───── Django 4.2 (LTS) ─────
          - python-version: "3.8"
            django-version: "4.2"
          - python-version: "3.9"
            django-version: "4.2"
          - python-version: "3.10"
            django-version: "4.2"
          - python-version: "3.11"
            django-version: "4.2"
          - python-version: "3.12"
            django-version: "4.2"

          # ───── Django 5.0 ─────
          - python-version: "3.10"
            django-version: "5.0"
          - python-version: "3.11"
            django-version: "5.0"
          - python-version: "3.12"
            django-version: "5.0"

          # ───── Django 5.1 ─────
          - python-version: "3.10"
            django-version: "5.1"
          - python-version: "3.11"
            django-version: "5.1"
          - python-version: "3.12"
            django-version: "5.1"
          - python-version: "3.13"
            django-version: "5.1"

          # ───── Django 5.2 ─────
          - python-version: "3.10"
            django-version: "5.2"
          - python-version: "3.11"
            django-version: "5.2"
          - python-version: "3.12"
            django-version: "5.2"
          - python-version: "3.13"
            django-version: "5.2"
          - python-version: "3.14"
            django-version: "5.2"

          # ───── Django 6.0 ─────
          - python-version: "3.12"
            django-version: "6.0"
          - python-version: "3.13"
            django-version: "6.0"
          - python-version: "3.14"
            django-version: "6.0"

          # ───── Django main ─────
          - python-version: "3.12"
            django-version: "main"
          - python-version: "3.13"
            django-version: "main"
          - python-version: "3.14"
            django-version: "main"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Get pip cache dir
        id: pip-cache
        run: echo "dir=$(pip cache dir)" >> $GITHUB_OUTPUT

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ${{ steps.pip-cache.outputs.dir }}
          key: >
            ${{ matrix.python-version }}-pip-
            ${{ hashFiles('**/pyproject.toml') }}-
            ${{ hashFiles('**/tox.ini') }}
          restore-keys: |
            ${{ matrix.python-version }}-pip-

      - name: Install tox
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade tox tox-gh-actions

      - name: Run tox
        run: tox -v
        env:
          DJANGO: ${{ matrix.django-version }}
