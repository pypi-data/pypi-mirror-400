#!/bin/bash
set -e
# set -x

echo "=== Fetching master ip ==="
MASTER_IP={% if master_address %}{{ master_address }}{% else %}{% raw %}$(hostname -I | awk '{print $1}'){% endraw %}{% endif %}

echo "=== Setting up k3s config ==="
sudo mkdir -p /etc/rancher/k3s
sudo tee /etc/rancher/k3s/config.yaml > /dev/null <<EOF
node-name: $HOSTNAME
EOF

echo "=== Installing K3s master ==="
curl -sfL https://get.k3s.io | {% if k3s_version %}INSTALL_K3S_VERSION={{ k3s_version }}{% endif %} sh -s - server {% if k3s_token %}--token={{ k3s_token }}{% endif %} --tls-san ${MASTER_IP} --cluster-init {{ install_flags }} {{ other_flags }}

echo "=== Preparing Join Command ==="
{% if k3s_token %}
TOKEN="{{ k3s_token }}"
{% else %}
TOKEN=$(sudo cat /var/lib/rancher/k3s/server/node-token)
{% endif %}
JOIN_CMD="curl -sfL https://get.k3s.io | {% if k3s_version %}INSTALL_K3S_VERSION={{ k3s_version }}{% endif %} sh -s - agent --token=${TOKEN} --server https://${MASTER_IP}:6443 {{ other_flags }}"
echo "$JOIN_CMD" > /lxa_k8s/join.sh
chmod +x /lxa_k8s/join.sh
echo "$JOIN_CMD"

echo "=== Setting up Context ==="
# Install pyyaml for Python Dependency

python3 - <<'EOF'
import subprocess, sys
try:
    import yaml
except ImportError:
    subprocess.check_call([sys.executable, "-m", "pip", "install", "pyyaml"])
EOF

# Running python script to setup context

sudo python3 - "$MASTER_IP" "{{ cluster_name}}" <<EOF
import sys, yaml

master_ip = sys.argv[1]
cluster_name = sys.argv[2]

path = "/etc/rancher/k3s/k3s.yaml"

with open(path, "r") as f:
    data = yaml.safe_load(f)

data["clusters"][0]["name"] = f"lxa-{cluster_name}"
data["clusters"][0]["cluster"]["server"] = f"https://{master_ip}:6443"
data["contexts"][0]["name"] = "lxa"
data["contexts"][0]["context"]["cluster"] = f"lxa-{cluster_name}"
data["contexts"][0]["context"]["user"] = f"lxa-{cluster_name}-admin"
data["current-context"] = "lxa"
data["users"][0]["name"] = f"lxa-{cluster_name}-admin"

with open(path, "w") as f:
    yaml.safe_dump(data, f, default_flow_style=False)
EOF

echo "=== Setting up Kube config  ==="
sudo k3s kubectl config view --raw > /lxa_k8s/kubeconfig
mkdir -p ~/.kube
sudo k3s kubectl config view --raw > ~/.kube/config
