# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/01_solar.ipynb.

# %% auto 0
__all__ = ['SolaX', 'SolarWidget']

# %% ../nbs/01_solar.ipynb 2
import os
import json 

from time import time
from fastcore.utils import patch
from fastcore.xtras import dict2obj

from fasthtml.common import *
from monsterui.all import *

from httpx import get as xget, post as xpost

# %% ../nbs/01_solar.ipynb 9
class SolaX:
    base = 'https://global.solaxcloud.com/proxyApp/proxy/api'
    
    def __init__(self, token_id=None, sn=None):
        self.token_id = token_id or os.getenv('SOLAX_TOKEN_ID')
        self.sn = sn or os.getenv('SOLAX_SN')

# %% ../nbs/01_solar.ipynb 11
@patch
def getRealtimeInfo(self:SolaX):
    "Get real-time inverter data (power, yield, battery)"
    r = xget(f'{self.base}/getRealtimeInfo.do', params={'tokenId': self.token_id, 'sn': self.sn})
    return dict2obj(r.json())

# %% ../nbs/01_solar.ipynb 17
def SolarWidget(
    s, 
    capacity=5000, # total capacity installed in W
    xtra_classes='w-[320px]'
):
    r = s.getRealtimeInfo().result
    solar = r.acpower
    grid = r.feedinpower
    consumption = solar - grid
    surplus = grid > 0
    
    hour = int(r.uploadTime.split()[1].split(':')[0])
    is_night = 19 <= hour or hour < 6
    icon = "â˜€ï¸" if (solar > 0 or not is_night) else "ðŸŒ™"
    
    return Div(
        Div(
            Span("SOLAR", cls="font-display text-xs font-bold text-slate-400 uppercase tracking-widest"),
            Span(f"{icon} {100*solar/capacity:.0f}%", cls="text-xl"),
            cls="flex justify-between items-center mb-6"
        ),
        Div(
            Div(
                Span(f"{solar:.0f}W", cls=f"font-display text-4xl {'text-solar-prod' if solar > 0 else 'text-slate-300'} leading-none"),
                Span("producing", cls="text-slate-400 text-sm"),
                cls="flex flex-col"
            ),
            Div(
                Span(f"{consumption:.0f}W", cls=f"font-display text-4xl {'text-temp-real' if surplus else 'text-solar-cons'} leading-none"),
                Span("using", cls="text-slate-400 text-sm"),
                cls="flex flex-col"
            ),
            cls="flex gap-8"
        ),
        Div(
            Span(f"Today: {r.yieldtoday:.1f} kWh", cls="text-slate-400 text-sm"),
            Span(f"{'â†‘ Exporting' if surplus else 'â†“ Importing'} {abs(grid):.0f}W", cls=f"text-sm {'text-green-500' if surplus else 'text-red-400'}"),
            cls="mt-auto flex justify-between"
        ),
        cls=f"bg-white/85 backdrop-blur-xl border border-white/60 rounded-[32px] p-8 shadow-soft flex flex-col transition-transform hover:-translate-y-1 duration-300 aspect-square {xtra_classes}"
    )
