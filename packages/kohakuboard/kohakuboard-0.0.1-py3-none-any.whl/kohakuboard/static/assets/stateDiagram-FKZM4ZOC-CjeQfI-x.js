import"./map-D3rdFka2.js";import"./_initCloneObject-w666mXAM.js";import"./_baseUniq-C1ih6t5I.js";import"./_baseClone-BEd4hvTE.js";import"./_baseEach-BN0HOvWa.js";import"./isArrayLikeObject-CPqL_9mx.js";import"./merge-CBnaWh74.js";import{t as e}from"./dagre-3yDHW5z8.js";import"./now-ByUdnbf_.js";import"./min-4CMQhUj4.js";import"./isEmpty-CdXClx6A.js";import{t}from"./graphlib-IDQiNJ1z.js";import{g as n,h as r,p as i}from"./src-B7JygnXw.js";import{E as a,b as o,c as s,s as c}from"./chunk-ABZYJK2D-I9bTIodh.js";import"./path-l6IWkZE5.js";import"./math-7AeJtYPr.js";import"./array-BSZYAUuL.js";import{E as l,g as u}from"./chunk-S3R3BYOJ-CWAqUOg9.js";import{t as d}from"./line-CbECwyAB.js";import"./dist-jJPhAdbW.js";import"./chunk-JA3XYJ7Z-CRQbsvum.js";import"./chunk-HN2XXSSU-D2jg58eN.js";import"./chunk-CVBHYZKI-DdfVbmKN.js";import"./chunk-55IACEB6-BF3A9DUg.js";import"./chunk-QN33PNHL-DlEKQ_uh.js";import"./chunk-ATLVNIR6-D9y29LP3.js";import"./chunk-JZLCHNYA-CJqJzbaw.js";import"./chunk-QXUST7PY-DdfD2bSs.js";import"./chunk-N4CR4FBY-BFWWCh6M.js";import{i as f,n as p,t as m}from"./chunk-DI55MBZ5-CpYI3paa.js";var h=r(e=>e.append(`circle`).attr(`class`,`start-state`).attr(`r`,o().state.sizeUnit).attr(`cx`,o().state.padding+o().state.sizeUnit).attr(`cy`,o().state.padding+o().state.sizeUnit),`drawStartState`),g=r(e=>e.append(`line`).style(`stroke`,`grey`).style(`stroke-dasharray`,`3`).attr(`x1`,o().state.textHeight).attr(`class`,`divider`).attr(`x2`,o().state.textHeight*2).attr(`y1`,0).attr(`y2`,0),`drawDivider`),_=r((e,t)=>{let n=e.append(`text`).attr(`x`,2*o().state.padding).attr(`y`,o().state.textHeight+2*o().state.padding).attr(`font-size`,o().state.fontSize).attr(`class`,`state-title`).text(t.id),r=n.node().getBBox();return e.insert(`rect`,`:first-child`).attr(`x`,o().state.padding).attr(`y`,o().state.padding).attr(`width`,r.width+2*o().state.padding).attr(`height`,r.height+2*o().state.padding).attr(`rx`,o().state.radius),n},`drawSimpleState`),v=r((e,t)=>{let n=r(function(e,t,n){let r=e.append(`tspan`).attr(`x`,2*o().state.padding).text(t);n||r.attr(`dy`,o().state.textHeight)},`addTspan`),i=e.append(`text`).attr(`x`,2*o().state.padding).attr(`y`,o().state.textHeight+1.3*o().state.padding).attr(`font-size`,o().state.fontSize).attr(`class`,`state-title`).text(t.descriptions[0]).node().getBBox(),a=i.height,s=e.append(`text`).attr(`x`,o().state.padding).attr(`y`,a+o().state.padding*.4+o().state.dividerMargin+o().state.textHeight).attr(`class`,`state-description`),c=!0,l=!0;t.descriptions.forEach(function(e){c||(n(s,e,l),l=!1),c=!1});let u=e.append(`line`).attr(`x1`,o().state.padding).attr(`y1`,o().state.padding+a+o().state.dividerMargin/2).attr(`y2`,o().state.padding+a+o().state.dividerMargin/2).attr(`class`,`descr-divider`),d=s.node().getBBox(),f=Math.max(d.width,i.width);return u.attr(`x2`,f+3*o().state.padding),e.insert(`rect`,`:first-child`).attr(`x`,o().state.padding).attr(`y`,o().state.padding).attr(`width`,f+2*o().state.padding).attr(`height`,d.height+a+2*o().state.padding).attr(`rx`,o().state.radius),e},`drawDescrState`),y=r((e,t,n)=>{let r=o().state.padding,i=2*o().state.padding,a=e.node().getBBox(),s=a.width,c=a.x,l=e.append(`text`).attr(`x`,0).attr(`y`,o().state.titleShift).attr(`font-size`,o().state.fontSize).attr(`class`,`state-title`).text(t.id),u=l.node().getBBox().width+i,d=Math.max(u,s);d===s&&(d+=i);let f,p=e.node().getBBox();t.doc,f=c-r,u>s&&(f=(s-d)/2+r),Math.abs(c-p.x)<r&&u>s&&(f=c-(u-s)/2);let m=1-o().state.textHeight;return e.insert(`rect`,`:first-child`).attr(`x`,f).attr(`y`,m).attr(`class`,n?`alt-composit`:`composit`).attr(`width`,d).attr(`height`,p.height+o().state.textHeight+o().state.titleShift+1).attr(`rx`,`0`),l.attr(`x`,f+r),u<=s&&l.attr(`x`,c+(d-i)/2-u/2+r),e.insert(`rect`,`:first-child`).attr(`x`,f).attr(`y`,o().state.titleShift-o().state.textHeight-o().state.padding).attr(`width`,d).attr(`height`,o().state.textHeight*3).attr(`rx`,o().state.radius),e.insert(`rect`,`:first-child`).attr(`x`,f).attr(`y`,o().state.titleShift-o().state.textHeight-o().state.padding).attr(`width`,d).attr(`height`,p.height+3+2*o().state.textHeight).attr(`rx`,o().state.radius),e},`addTitleAndBox`),b=r(e=>(e.append(`circle`).attr(`class`,`end-state-outer`).attr(`r`,o().state.sizeUnit+o().state.miniPadding).attr(`cx`,o().state.padding+o().state.sizeUnit+o().state.miniPadding).attr(`cy`,o().state.padding+o().state.sizeUnit+o().state.miniPadding),e.append(`circle`).attr(`class`,`end-state-inner`).attr(`r`,o().state.sizeUnit).attr(`cx`,o().state.padding+o().state.sizeUnit+2).attr(`cy`,o().state.padding+o().state.sizeUnit+2)),`drawEndState`),x=r((e,t)=>{let n=o().state.forkWidth,r=o().state.forkHeight;if(t.parentId){let e=n;n=r,r=e}return e.append(`rect`).style(`stroke`,`black`).style(`fill`,`black`).attr(`width`,n).attr(`height`,r).attr(`x`,o().state.padding).attr(`y`,o().state.padding)},`drawForkJoinState`),S=r((e,t,n,r)=>{let i=0,a=r.append(`text`);a.style(`text-anchor`,`start`),a.attr(`class`,`noteText`);let s=e.replace(/\r\n/g,`<br/>`);s=s.replace(/\n/g,`<br/>`);let l=s.split(c.lineBreakRegex),u=1.25*o().state.noteMargin;for(let e of l){let r=e.trim();if(r.length>0){let e=a.append(`tspan`);if(e.text(r),u===0){let t=e.node().getBBox();u+=t.height}i+=u,e.attr(`x`,t+o().state.noteMargin),e.attr(`y`,n+i+1.25*o().state.noteMargin)}}return{textWidth:a.node().getBBox().width,textHeight:i}},`_drawLongText`),C=r((e,t)=>{t.attr(`class`,`state-note`);let n=t.append(`rect`).attr(`x`,0).attr(`y`,o().state.padding),r=t.append(`g`),{textWidth:i,textHeight:a}=S(e,0,0,r);return n.attr(`height`,a+2*o().state.noteMargin),n.attr(`width`,i+o().state.noteMargin*2),n},`drawNote`),w=r(function(e,t){let n=t.id,r={id:n,label:t.id,width:0,height:0},i=e.append(`g`).attr(`id`,n).attr(`class`,`stateGroup`);t.type===`start`&&h(i),t.type===`end`&&b(i),(t.type===`fork`||t.type===`join`)&&x(i,t),t.type===`note`&&C(t.note.text,i),t.type===`divider`&&g(i),t.type===`default`&&t.descriptions.length===0&&_(i,t),t.type===`default`&&t.descriptions.length>0&&v(i,t);let a=i.node().getBBox();return r.width=a.width+2*o().state.padding,r.height=a.height+2*o().state.padding,r},`drawState`),T=0,E=r(function(e,t,i){let s=r(function(e){switch(e){case m.relationType.AGGREGATION:return`aggregation`;case m.relationType.EXTENSION:return`extension`;case m.relationType.COMPOSITION:return`composition`;case m.relationType.DEPENDENCY:return`dependency`}},`getRelationType`);t.points=t.points.filter(e=>!Number.isNaN(e.y));let f=t.points,p=d().x(function(e){return e.x}).y(function(e){return e.y}).curve(l),h=e.append(`path`).attr(`d`,p(f)).attr(`id`,`edge`+T).attr(`class`,`transition`),g=``;if(o().state.arrowMarkerAbsolute&&(g=a(!0)),h.attr(`marker-end`,`url(`+g+`#`+s(m.relationType.DEPENDENCY)+`End)`),i.title!==void 0){let r=e.append(`g`).attr(`class`,`stateLabel`),{x:a,y:s}=u.calcLabelPosition(t.points),l=c.getRows(i.title),d=0,f=[],p=0,m=0;for(let e=0;e<=l.length;e++){let t=r.append(`text`).attr(`text-anchor`,`middle`).text(l[e]).attr(`x`,a).attr(`y`,s+d),i=t.node().getBBox();p=Math.max(p,i.width),m=Math.min(m,i.x),n.info(i.x,a,s+d),d===0&&(d=t.node().getBBox().height,n.info(`Title height`,d,s)),f.push(t)}let h=d*l.length;if(l.length>1){let e=(l.length-1)*d*.5;f.forEach((t,n)=>t.attr(`y`,s+n*d-e)),h=d*l.length}let g=r.node().getBBox();r.insert(`rect`,`:first-child`).attr(`class`,`box`).attr(`x`,a-p/2-o().state.padding/2).attr(`y`,s-h/2-o().state.padding/2-3.5).attr(`width`,p+o().state.padding).attr(`height`,h+o().state.padding),n.info(g)}T++},`drawEdge`),D,O={},k=r(function(){},`setConf`),A=r(function(e){e.append(`defs`).append(`marker`).attr(`id`,`dependencyEnd`).attr(`refX`,19).attr(`refY`,7).attr(`markerWidth`,20).attr(`markerHeight`,28).attr(`orient`,`auto`).append(`path`).attr(`d`,`M 19,7 L9,13 L14,7 L9,1 Z`)},`insertMarkers`),j=r(function(e,t,r,a){D=o().state;let c=o().securityLevel,l;c===`sandbox`&&(l=i(`#i`+t));let u=i(c===`sandbox`?l.nodes()[0].contentDocument.body:`body`),d=c===`sandbox`?l.nodes()[0].contentDocument:document;n.debug(`Rendering diagram `+e);let f=u.select(`[id='${t}']`);A(f);let p=a.db.getRootDoc();N(p,f,void 0,!1,u,d,a);let m=D.padding,h=f.node().getBBox(),g=h.width+m*2,_=h.height+m*2,v=g*1.75;s(f,_,v,D.useMaxWidth),f.attr(`viewBox`,`${h.x-D.padding}  ${h.y-D.padding} `+g+` `+_)},`draw`),M=r(e=>e?e.length*D.fontSizeFactor:1,`getLabelWidth`),N=r((r,i,a,o,s,l,u)=>{let d=new t({compound:!0,multigraph:!0}),f,p=!0;for(f=0;f<r.length;f++)if(r[f].stmt===`relation`){p=!1;break}a?d.setGraph({rankdir:`LR`,multigraph:!0,compound:!0,ranker:`tight-tree`,ranksep:p?1:D.edgeLengthFactor,nodeSep:p?1:50,isMultiGraph:!0}):d.setGraph({rankdir:`TB`,multigraph:!0,compound:!0,ranksep:p?1:D.edgeLengthFactor,nodeSep:p?1:50,ranker:`tight-tree`,isMultiGraph:!0}),d.setDefaultEdgeLabel(function(){return{}});let m=u.db.getStates(),h=u.db.getRelations(),g=Object.keys(m);for(let e of g){let t=m[e];a&&(t.parentId=a);let n;if(t.doc){let e=i.append(`g`).attr(`id`,t.id).attr(`class`,`stateGroup`);n=N(t.doc,e,t.id,!o,s,l,u);{e=y(e,t,o);let r=e.node().getBBox();n.width=r.width,n.height=r.height+D.padding/2,O[t.id]={y:D.compositTitleSize}}}else n=w(i,t,d);if(t.note){let e={descriptions:[],id:t.id+`-note`,note:t.note,type:`note`},r=w(i,e,d);t.note.position===`left of`?(d.setNode(n.id+`-note`,r),d.setNode(n.id,n)):(d.setNode(n.id,n),d.setNode(n.id+`-note`,r)),d.setParent(n.id,n.id+`-group`),d.setParent(n.id+`-note`,n.id+`-group`)}else d.setNode(n.id,n)}n.debug(`Count=`,d.nodeCount(),d);let _=0;h.forEach(function(e){_++,n.debug(`Setting edge`,e),d.setEdge(e.id1,e.id2,{relation:e,width:M(e.title),height:D.labelHeight*c.getRows(e.title).length,labelpos:`c`},`id`+_)}),e(d),n.debug(`Graph after layout`,d.nodes());let v=i.node();d.nodes().forEach(function(e){e!==void 0&&d.node(e)!==void 0?(n.warn(`Node `+e+`: `+JSON.stringify(d.node(e))),s.select(`#`+v.id+` #`+e).attr(`transform`,`translate(`+(d.node(e).x-d.node(e).width/2)+`,`+(d.node(e).y+(O[e]?O[e].y:0)-d.node(e).height/2)+` )`),s.select(`#`+v.id+` #`+e).attr(`data-x-shift`,d.node(e).x-d.node(e).width/2),l.querySelectorAll(`#`+v.id+` #`+e+` .divider`).forEach(e=>{let t=e.parentElement,n=0,r=0;t&&(t.parentElement&&(n=t.parentElement.getBBox().width),r=parseInt(t.getAttribute(`data-x-shift`),10),Number.isNaN(r)&&(r=0)),e.setAttribute(`x1`,0-r+8),e.setAttribute(`x2`,n-r-8)})):n.debug(`No Node `+e+`: `+JSON.stringify(d.node(e)))});let b=v.getBBox();d.edges().forEach(function(e){e!==void 0&&d.edge(e)!==void 0&&(n.debug(`Edge `+e.v+` -> `+e.w+`: `+JSON.stringify(d.edge(e))),E(i,d.edge(e),d.edge(e).relation))}),b=v.getBBox();let x={id:a||`root`,label:a||`root`,width:0,height:0};return x.width=b.width+2*D.padding,x.height=b.height+2*D.padding,n.debug(`Doc rendered`,x,d),x},`renderDoc`),P={parser:p,get db(){return new m(1)},renderer:{setConf:k,draw:j},styles:f,init:r(e=>{e.state||={},e.state.arrowMarkerAbsolute=e.arrowMarkerAbsolute},`init`)};export{P as diagram};