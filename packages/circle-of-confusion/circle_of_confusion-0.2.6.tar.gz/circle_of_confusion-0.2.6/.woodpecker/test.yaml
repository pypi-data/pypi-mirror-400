when:
  event: [push, manual]
  path:
    include:
      - '**/*.rs'
      - '**/*.toml'
      - '**/*.yaml'
      - '**/*.py'
      - '**/*.proto'


steps:
  test_rust:
    image: rust:trixie
    commands:
      - apt update && apt install -y cmake protobuf-compiler
      - rustup target add wasm32-wasip1
      - curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
      - cargo binstall wasmtime-cli
      - cargo test --release
      - cargo test --target wasm32-wasip1

  build_python:
    image: rust:trixie
    commands:
      - apt update && apt install -y cmake protobuf-compiler rustup
      - rustup target add wasm32-unknown-unknown
      - curl -LsSf https://astral.sh/uv/install.sh | sh
      - . $HOME/.local/bin/env
      - uv build

  test_python:
    image: ghcr.io/astral-sh/uv:trixie
    commands:
      - uv run --isolated --no-project --with $(printf "%s[recommended]" dist/*.whl) --managed-python -p 3.9 --with pytest pytest
      - uv run --isolated --no-project --with $(printf "%s[recommended]" dist/*.whl) --managed-python -p 3.10 --with pytest pytest
      - uv run --isolated --no-project --with $(printf "%s[recommended]" dist/*.whl) --managed-python -p 3.11 --with pytest pytest
      - uv run --isolated --no-project --with $(printf "%s[recommended]" dist/*.whl) --managed-python -p 3.12 --with pytest pytest
      - uv run --isolated --no-project --with $(printf "%s[recommended]" dist/*.whl) --managed-python -p 3.13 --with pytest pytest
      - uv run --isolated --no-project --with $(printf "%s[recommended]" dist/*.whl) --managed-python -p 3.14 --with pytest pytest
      - uv run --isolated --no-project --with dist/*.whl --managed-python -p 3.14 --with pytest pytest

