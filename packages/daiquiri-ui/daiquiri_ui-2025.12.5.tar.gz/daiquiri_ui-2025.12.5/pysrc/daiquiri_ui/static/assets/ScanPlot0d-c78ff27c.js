var O=Object.defineProperty;var I=(c,n,s)=>n in c?O(c,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):c[n]=s;var S=(c,n,s)=>(I(c,typeof n!="symbol"?n+"":n,s),s);import{r as b,an as L,j as e,g as z,R as v,C as x,B as m,F as C,l as j,ao as w,ap as M,I as P,p as V,aq as W,y as $,w as F,c as H,s as p,ar as U,U as X,as as B,q as Y}from"./index-4cf586ed.js";import{F as q,z as T,E as G,c as K}from"./index-19c84627.js";import{h as J,i as Q,H as Z}from"./H5WebCurvePlot-acd3b964.js";import{D as _}from"./DropdownButton-9a594aef.js";import{m as ee}from"./ConnectUtils-bd734a4a.js";import"./types-0be7083b.js";const se=[0,1];function te(c){const{x:n,y:s,dataValues:t,size:a,colorMap:l,title:h,onClick:y}=c,A=q(t)||se,g=t.length,N=T(n,g),k=T(s,g),r=b.useMemo(()=>L(t),[t]);return e.jsx(G,{abscissaParams:{value:N},ordinateParams:{value:k},dataArray:r,domain:A,colorMap:l,size:a,onPointClick:y,title:h})}function ae(c){const{data:n,onClick:s}=c,[t]=n;if(t===void 0)return e.jsx("div",{children:"No data. Please select a scan."});const{marker:a,x:l,y:h}=t,{color:y,colorscale:A,size:g}=a;return J(y)?e.jsx(te,{x:l,y:h,dataValues:y,colorMap:A,size:g,onClick:s,title:t.name}):e.jsx("div",{children:"Values are undefined. Please select a series."})}function ce(c){const{data:n,onClick:s}=c;return n.length===0?e.jsx("div",{children:"No data to display"}):Q(n)?e.jsx(ae,{data:n,onClick:s}):e.jsx(Z,{data:n,insetLegend:!0,onClick:s,curveType:K.LineAndGlyphs})}function ne(c){const n=s=>{c.onChange({type:s.target.name,axis:s.target.value})};return e.jsx(_,{title:"Axes",children:e.jsxs(z,{className:"series-select",children:[e.jsxs(v,{children:[e.jsx(x,{xs:1,children:e.jsx(m,{size:"sm",onClick:()=>c.unselectAxes("x"),className:"mx-auto",children:"x"})}),e.jsx(x,{xs:1,children:e.jsx(m,{size:"sm",onClick:()=>c.unselectAxes("y"),className:"mx-auto",children:"y"})}),e.jsx(x,{className:"text-end",children:e.jsx(m,{size:"sm",onClick:()=>c.resetAxes(),children:"Reset"})})]}),c.series.map(s=>e.jsxs(v,{children:[e.jsx(x,{xs:1,children:e.jsx(C.Check,{checked:s===c.selected.x,name:"x",type:"radio",onChange:n,value:s,className:"my-auto"})}),e.jsx(x,{xs:1,children:e.jsx(C.Check,{checked:s===c.selected.y,name:"y",type:"radio",onChange:n,value:s,className:"my-auto"})}),e.jsx(C.Label,{column:!0,className:"justify-content-start col-10",children:s})]},s))]})})}function ie(c){const n=s=>{c.onChange(s.target.name,s.target.checked)};return e.jsx(_,{title:"Series",children:e.jsxs(z,{className:"series-select",children:[e.jsx("div",{className:"text-end",children:e.jsx(m,{size:"sm",onClick:()=>c.resetSeries(),children:"Reset"})}),c.series.map(s=>e.jsx(C.Check,{className:"justify-content-start",checked:s in c.selected,type:"checkbox",id:`${s}-check`,label:s,onChange:n,name:s},s))]})})}function re(c,n){return c.length===n.length?{xData:c,yData:n}:c.length>n.length?{xData:c.slice(0,n.length),yData:n}:{xData:c,yData:n.slice(0,c.length)}}let oe=class extends b.Component{constructor(s){super(s);S(this,"doSetPageSize");S(this,"doSetPage");S(this,"pageRef");S(this,"onClick",s=>{s!==void 0&&this.props.actions.selectPoint(s)});S(this,"setPageSize",s=>{this.doSetPage(1),this.doSetPageSize(Number.parseInt(s.target.value,10))});S(this,"setPage",s=>{this.doSetPage(Number.parseInt(s.target.value,10),!0)});S(this,"selectSeries",(s,t)=>{t?this.props.actions.selectSeries(s):this.props.actions.unselectSeries(s)});this.doSetPageSize=j.debounce(this.props.actions.setPageSize,500),this.doSetPage=j.debounce(this.props.actions.setPage,500),this.pageRef=b.createRef()}componentDidMount(){const{options:s={},actions:t}=this.props,{preSelectedXAxis:a,preSelectedSeries:l}=s;t.setFollow(),a&&t.selectAxes({type:"x",axis:a}),l&&(Array.isArray(l)?l.forEach(h=>t.selectSeries(h)):t.selectSeries(l))}componentDidUpdate(s){const t=this.props.data[this.props.selectedScan]||{},a=s.data[s.selectedScan]||{};t.page!==a.page&&this.pageRef.current&&(this.pageRef.current.value=`${t.page||1}`),s.selectedSeries!==this.props.selectedSeries&&this.props.actions.setParams({scalars:[...this.props.selectedAxes.x?[this.props.selectedAxes.x]:[],...this.props.selectedAxes.y?[this.props.selectedAxes.y]:[],...Object.keys(this.props.selectedSeries)]},!0),s.selectedAxes!==this.props.selectedAxes&&this.props.actions.setParams({scalars:[...this.props.selectedAxes.x?[this.props.selectedAxes.x]:[],...this.props.selectedAxes.y?[this.props.selectedAxes.y]:[],...Object.keys(this.props.selectedSeries)]},!0)}render(){const s=w(this.props.scans);if(s===null)return e.jsx("span",{children:"No scan loaded."});const t=this.props.selectedScan||s,a=this.props.data[t]||{};if(!a.data)return e.jsx("span",{children:"Waiting for scan data"});const l=Object.keys(this.props.selectedSeries).length>0?Object.keys(this.props.selectedSeries):a.axes.ys.scalars.filter(r=>!r.startsWith("timer")).slice(0,2),h=[];if(a.axes.xs.length===2&&!this.props.selectedAxes.x||this.props.selectedAxes.x&&this.props.selectedAxes.y){let r=[],i=[];if(this.props.selectedAxes.x&&this.props.selectedAxes.y){const o=a.data[this.props.selectedAxes.x],d=a.data[this.props.selectedAxes.y];if(!o||!d)return e.jsxs("span",{children:["The selected axes are not valid for the current scan"," ",e.jsx(m,{size:"sm",onClick:()=>this.props.actions.resetAxes(),children:"Reset"})]});r=o.data,i=d.data}else{const o=a.data[a.axes.xs[0]],d=a.data[a.axes.xs[1]];r=o?o.data:[],i=d?d.data:[]}j.each(l,o=>{var f;if(!a.axes.ys.scalars.includes(o))return;const d=a.data[o];if(d){const u={x:r,y:i,type:"scattergl",name:d.name,mode:"markers",text:(f=d.data)==null?void 0:f.map(E=>E.toPrecision(4)),marker:{size:10,color:d.data&&[...d.data],colorscale:"Viridis"}};h.push(u)}})}else{const r=this.props.selectedScans?[...Object.values(this.props.selectedScans).map(i=>this.props.data[i])]:[a];try{j.each(r,i=>{let o;if(i.axes.xs.length===0&&!this.props.selectedAxes.x)o={data:[0],name:"index",shape:[1]};else{const f=this.props.selectedAxes.x||i.axes.xs[0];o=i.data[f]}const d=this.props.scans[i.scanid];if(!o)throw new Error("The selected axes are not valid for the current scan(s)");if(o.data.length===0)throw new Error("Waiting for data for the selected axes");j.each(l,f=>{if(!i.axes.ys.scalars.includes(f))return;const u=i.data[f];if(!u)return;if(!u.data){console.log(`Data for ${i.scanid} series ${u.name} not loaded yet`);return}o.name==="index"&&(o.data=j.range(u.data.length));const{xData:E,yData:R}=re(o.data,u.data),D={x:[...E],y:R,type:"scattergl",name:i.scanid===t&&d?u.name:`${M.unix(d.start_timestamp).format("DD-MM-YYYY HH:mm:ss")}: ${u.name}`};h.push(D)})})}catch(i){if(i instanceof Error)return e.jsxs("span",{children:[i.message,e.jsx(m,{style:{marginLeft:"1rem"},size:"sm",onClick:()=>this.props.actions.resetAxes(),children:"Reset"})]})}}const{options:A}=this.props,{preSelectedXAxis:g,preSelectedSeries:N}=A,{backend:k="h5web"}=A;return e.jsxs("div",{className:"plot1d-container",children:[e.jsx(z,{children:e.jsxs(v,{children:[e.jsx(x,{xs:"auto",className:"gx-1",children:e.jsx(ne,{onChange:r=>this.props.actions.selectAxes(r),series:[...a.axes.xs,...a.axes.ys.scalars],selected:this.props.selectedAxes,resetAxes:this.props.actions.resetAxes,unselectAxes:this.props.actions.unselectAxes})}),e.jsx(x,{xs:"auto",className:"gx-1",children:e.jsx(ie,{onChange:this.selectSeries,series:a.axes.ys.scalars,selected:this.props.selectedSeries,resetSeries:this.props.actions.resetSeries})}),e.jsx(x,{xs:"auto",className:"gx-1",children:e.jsxs(P,{children:[e.jsx(P.Text,{children:"Points"}),e.jsxs(C.Control,{as:"select",onChange:this.setPageSize,value:this.props.pageSize,children:[[5,10,25,100,1e3].map(r=>a.npoints===null||r<a.npoints?e.jsx("option",{value:r,children:r},r):null),a.npoints!==null&&e.jsx("option",{value:a.npoints,children:`All (${a.npoints})`})]})]})}),e.jsx(x,{xs:"auto",className:"gx-1",children:e.jsxs(P,{children:[e.jsx(P.Text,{children:"Page"}),e.jsx(m,{size:"sm",onClick:()=>this.doSetPage(a.page-1,!0),disabled:a.page===1,children:e.jsx("i",{className:"fa fa-caret-left"})}),e.jsx(C.Control,{ref:this.pageRef,type:"number",onChange:this.setPage,defaultValue:a.page,max:a.pages,min:1}),e.jsx(m,{size:"sm",onClick:()=>this.doSetPage(a.page+1,!0),disabled:a.page===a.pages,children:e.jsx("i",{className:"fa fa-caret-right"})})]})}),this.props.fetching&&e.jsx(x,{xs:"auto",children:e.jsx("i",{className:"fa fa-spin fa-spinner"})})]})}),e.jsx(V,{children:k==="h5web"?e.jsx(W,{children:e.jsx(ce,{data:h,onClick:this.onClick})}):e.jsx($,{data:h,layout:{},onClick:r=>{var i;return this.onClick((i=r.points[0])==null?void 0:i.pointNumber)}})}),(g||N)&&e.jsxs("span",{children:[N," vs. ",g]})]})}};function le(c,n,s){const{data:t,list:a}=n.providers.scans;return{data:t.selector("results",c),scans:a.selector("results",c),pageSize:t.selector("per_page",c)||25,fetching:t.selector("fetching",c),selectedSeries:p.selector("selectedDataSeries",c),selectedAxes:p.selector("selectedDataAxes",c),selectedScan:p.selector("selectedScan",c),selectedScans:p.selector("selectedScans",c)}}function de(c,n){return{actions:{selectPoint:t=>p.dispatch("SCAN_CURRENT_POINT",Number.parseInt(t.toString(),10)),setPageSize:t=>n.providers.scans.data.setPageSize(t,!0),setPage:(t,a)=>n.providers.scans.data.setPage(t,a),setParams:(t,a)=>n.providers.scans.data.setParams(t,a),fetchScanSpectra:t=>n.providers.scans.spectra.fetch(t),selectSeries:t=>p.dispatch("SCAN_DATA_SELECT_SERIES",t),unselectSeries:t=>p.dispatch("SCAN_DATA_UNSELECT_SERIES",t),resetSeries:t=>p.dispatch("SCAN_DATA_RESET_SERIES",t),selectAxes:t=>p.dispatch("SCAN_DATA_SELECT_AXES",t),unselectAxes:t=>p.dispatch("SCAN_DATA_UNSELECT_AXES",t),resetAxes:t=>p.dispatch("SCAN_DATA_RESET_AXES",t),setFollow:()=>{n.selectedScan===void 0&&p.dispatch("RESET_SCAN_SELECTION")}}}}const pe=F({scans:p})(H(ee(le),de)(oe));function je(c){const{providers:n,yamlNode:s,backend:t,preSelectedXAxis:a,preSelectedSeries:l,...h}=c;return U(s,"backend",t),X(s,"preSelectedXAxis",a),B(s,"preSelectedSeries",l),Y(s,h),e.jsx(pe,{providers:n,options:{backend:t,preSelectedXAxis:a,preSelectedSeries:l}})}export{je as default};
