from __future__ import annotations

import os
from pathlib import Path
from typing import Dict, List, Optional

import yaml
from dotenv import load_dotenv
from pydantic import BaseModel

load_dotenv()


class ProviderCfg(BaseModel):
    api_key_env: str
    model: str
    base_url: str


class AIConfig(BaseModel):
    default_provider: str
    fallback_providers: List[str] = []
    routing: Dict[str, List[str]] = {}
    providers: Dict[str, ProviderCfg]


class AppConfig(BaseModel):
    # keep default value for backward-compat;
    # if left as relative, we'll map it to XDG data home.
    workspace_root: str = "workspaces"
    safe_mode_default: bool = True
    ai: AIConfig


def _expand_path(p: str) -> Path:
    """Expand ~ and env vars, then resolve to absolute Path."""
    return Path(os.path.expandvars(p)).expanduser().resolve()


def _xdg_config_home() -> Path:
    return _expand_path(os.getenv("XDG_CONFIG_HOME", "~/.config"))


def _xdg_data_home() -> Path:
    return _expand_path(os.getenv("XDG_DATA_HOME", "~/.local/share"))


def _default_config_candidates() -> List[Path]:
    """
    Config lookup order (highest priority first):
      1) $PENTESTAI_CONFIG
      2) $XDG_CONFIG_HOME/pentestai/config.yaml  (default: ~/.config/pentestai/config.yaml)
      3) ./config.yaml                           (project-local)
    """
    candidates: List[Path] = []

    env_path = os.getenv("PENTESTAI_CONFIG", "").strip()
    if env_path:
        candidates.append(_expand_path(env_path))

    candidates.append((_xdg_config_home() / "pentestai" / "config.yaml").resolve())
    candidates.append(_expand_path("./config.yaml"))

    return candidates


def _pick_config_path(path: Optional[str] = None) -> Path:
    # If caller explicitly passes a path, honor it (but expand it)
    if path and path.strip():
        return _expand_path(path.strip())

    # Otherwise try defaults
    for cand in _default_config_candidates():
        if cand.exists():
            return cand

    tried = "\n  - " + "\n  - ".join(str(p) for p in _default_config_candidates())
    raise RuntimeError(
        "Missing config.yaml. Tried:" + tried
        + "\nTip: put config at ~/.config/pentestai/config.yaml "
        + "(or set XDG_CONFIG_HOME), or set PENTESTAI_CONFIG=/path/to/config.yaml"
    )


def _resolve_workspace_root(raw_ws: str) -> Path:
    """
    Workspace resolution (XDG-friendly):
      - If workspace_root is absolute or starts with ~ or $ -> expand.
      - If it is relative (e.g. 'workspaces') -> place under XDG data:
          $XDG_DATA_HOME/pentestai/<raw_ws>
        default XDG_DATA_HOME is ~/.local/share
    """
    raw_ws = (raw_ws or "workspaces").strip()

    # relative path => XDG_DATA_HOME/pentestai/<raw_ws>
    if not (raw_ws.startswith("/") or raw_ws.startswith("~") or raw_ws.startswith("$")):
        ws_path = (_xdg_data_home() / "pentestai" / raw_ws).resolve()
    else:
        ws_path = _expand_path(raw_ws)

    ws_path.mkdir(parents=True, exist_ok=True)
    return ws_path


def load_config(path: str = "") -> AppConfig:
    cfg_path = _pick_config_path(path if path else None)

    with cfg_path.open("r", encoding="utf-8") as f:
        data = yaml.safe_load(f) or {}

    cfg = AppConfig(**data)

    # Resolve workspace_root to stable absolute location and auto-create it
    ws_root = _resolve_workspace_root(cfg.workspace_root)
    cfg.workspace_root = str(ws_root)

    return cfg


def get_api_key(env_name: str) -> str:
    v = os.getenv(env_name, "").strip()
    if not v:
        raise RuntimeError(f"Missing API key: {env_name} (check .env)")
    return v
