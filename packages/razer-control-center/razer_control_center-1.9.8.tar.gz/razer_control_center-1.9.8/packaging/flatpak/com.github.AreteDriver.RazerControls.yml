app-id: com.github.AreteDriver.RazerControls
runtime: org.kde.Platform
runtime-version: '6.9'
sdk: org.kde.Sdk
command: razer-control-center

finish-args:
  # X11 + Wayland
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  # D-Bus for OpenRazer and system services
  - --socket=session-bus
  - --socket=system-bus
  # Device access for evdev input devices
  - --device=all
  # Home directory for config
  - --filesystem=~/.config/razer-control-center:create
  # For systemd user services
  - --filesystem=~/.config/systemd/user:create
  - --filesystem=~/.local/bin:create
  # Talk to OpenRazer daemon
  - --talk-name=org.razer

modules:
  # Python evdev
  - name: python3-evdev
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} evdev --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/63/fe/a17c106a1f4061ce83f04d14bcedcfb2c38c7793ea56bfb906a6fadae8cb/evdev-1.9.2.tar.gz
        sha256: 5d3278892ce1f92a74d6bf888cc8525d9f68af85dbe336c95d1c87fb8f423069

  # Python pydbus
  - name: python3-pydbus
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} pydbus --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/58/56/3e84f2c1f2e39b9ea132460183f123af41e3b9c8befe222a35636baa6a5a/pydbus-0.6.0.tar.gz
        sha256: 4207162eff54223822c185da06c1ba8a34137a9602f3da5a528eedf3f78d0f2c

  # Python python-xlib (required by pynput on Linux)
  - name: python3-xlib
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} python-xlib --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/fc/b8/ff33610932e0ee81ae7f1269c890f697d56ff74b9f5b2ee5d9b7fa2c5355/python_xlib-0.33-py2.py3-none-any.whl
        sha256: c3534038d42e0df2f1392a1b30a15a4ff5fdc2b86cfa94f072bf11b10a164398

  # Python pynput
  - name: python3-pynput
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} pynput --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/59/4f/ac3fa906ae8a375a536b12794128c5efacade9eaa917a35dfd27ce0c7400/pynput-1.8.1-py2.py3-none-any.whl
        sha256: 42dfcf27404459ca16ca889c8fb8ffe42a9fe54f722fd1a3e130728e59e768d2

  # Main application (pydantic installed via pip from PyPI during build)
  - name: razer-control-center
    buildsystem: simple
    build-options:
      build-args:
        - --share=network
    build-commands:
      - pip3 install --verbose --prefix=${FLATPAK_DEST} pydantic PySide6 PyYAML
      - pip3 install --verbose --no-index --find-links="file://${PWD}"
        --prefix=${FLATPAK_DEST} . --no-build-isolation --no-deps
      # Copy data directories for device layouts and images
      - cp -r data ${FLATPAK_DEST}/lib/python3.12/site-packages/
      - install -Dm644 packaging/flatpak/com.github.AreteDriver.RazerControls.metainfo.xml
        ${FLATPAK_DEST}/share/metainfo/com.github.AreteDriver.RazerControls.metainfo.xml
      - install -Dm644 packaging/flatpak/com.github.AreteDriver.RazerControls.desktop
        ${FLATPAK_DEST}/share/applications/com.github.AreteDriver.RazerControls.desktop
      - install -Dm644 packaging/flatpak/icons/hicolor/scalable/apps/com.github.AreteDriver.RazerControls.svg
        ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/com.github.AreteDriver.RazerControls.svg
    sources:
      - type: dir
        path: ../..
