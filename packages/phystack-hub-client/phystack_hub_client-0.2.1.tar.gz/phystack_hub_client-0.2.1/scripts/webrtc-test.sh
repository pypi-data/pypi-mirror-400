#!/bin/bash
#
# Python WebRTC Two-Host Test Runner
#
# Tests Python hub-client communication between two hosts:
# - Local machine runs as initiator
# - Remote Linux host runs as responder
#
# Usage:
#   ./scripts/webrtc-test.sh setup    # Configure credentials
#   ./scripts/webrtc-test.sh run      # Run the test
#   ./scripts/webrtc-test.sh clean    # Clean up remote host
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
ENV_FILE="$PROJECT_DIR/.env.webrtc-test"
REMOTE_LOG="/tmp/python-responder.log"
LOCAL_LOG="/tmp/python-initiator.log"
DEFAULT_REMOTE_PATH="/tmp/python-hub-client-test"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Load environment file
load_env() {
    if [[ ! -f "$ENV_FILE" ]]; then
        log_error "Environment file not found: $ENV_FILE"
        log_info "Run './scripts/webrtc-test.sh setup' to create it"
        exit 1
    fi
    source "$ENV_FILE"

    # Validate required variables
    local missing=()
    [[ -z "$DEVICE_A_ID" ]] && missing+=("DEVICE_A_ID")
    [[ -z "$DEVICE_A_KEY" ]] && missing+=("DEVICE_A_KEY")
    [[ -z "$DEVICE_A_TWIN_ID" ]] && missing+=("DEVICE_A_TWIN_ID")
    [[ -z "$DEVICE_B_ID" ]] && missing+=("DEVICE_B_ID")
    [[ -z "$DEVICE_B_KEY" ]] && missing+=("DEVICE_B_KEY")
    [[ -z "$DEVICE_B_TWIN_ID" ]] && missing+=("DEVICE_B_TWIN_ID")
    [[ -z "$REMOTE_HOST" ]] && missing+=("REMOTE_HOST")

    if [[ ${#missing[@]} -gt 0 ]]; then
        log_error "Missing required variables: ${missing[*]}"
        exit 1
    fi

    # Set defaults
    REMOTE_PATH="${REMOTE_PATH:-$DEFAULT_REMOTE_PATH}"
    PHYHUB_REGION="${PHYHUB_REGION:-eu}"
}

# Setup wizard
cmd_setup() {
    log_info "Python WebRTC Test Setup Wizard"
    echo ""

    # Load existing values if file exists
    if [[ -f "$ENV_FILE" ]]; then
        source "$ENV_FILE"
        log_info "Loading existing configuration from $ENV_FILE"
    fi

    echo "Enter credentials for Device A (local initiator):"
    read -p "  Device A ID [${DEVICE_A_ID:-}]: " input
    DEVICE_A_ID="${input:-$DEVICE_A_ID}"

    read -p "  Device A Access Key [${DEVICE_A_KEY:+****}]: " input
    DEVICE_A_KEY="${input:-$DEVICE_A_KEY}"

    read -p "  Device A Twin ID [${DEVICE_A_TWIN_ID:-}]: " input
    DEVICE_A_TWIN_ID="${input:-$DEVICE_A_TWIN_ID}"

    echo ""
    echo "Enter credentials for Device B (remote responder):"
    read -p "  Device B ID [${DEVICE_B_ID:-}]: " input
    DEVICE_B_ID="${input:-$DEVICE_B_ID}"

    read -p "  Device B Access Key [${DEVICE_B_KEY:+****}]: " input
    DEVICE_B_KEY="${input:-$DEVICE_B_KEY}"

    read -p "  Device B Twin ID [${DEVICE_B_TWIN_ID:-}]: " input
    DEVICE_B_TWIN_ID="${input:-$DEVICE_B_TWIN_ID}"

    echo ""
    echo "Enter remote host configuration:"
    read -p "  Remote Host (user@host) [${REMOTE_HOST:-}]: " input
    REMOTE_HOST="${input:-$REMOTE_HOST}"

    read -p "  Remote Path [${REMOTE_PATH:-$DEFAULT_REMOTE_PATH}]: " input
    REMOTE_PATH="${input:-${REMOTE_PATH:-$DEFAULT_REMOTE_PATH}}"

    read -p "  PhyHub Region (eu/us) [${PHYHUB_REGION:-eu}]: " input
    PHYHUB_REGION="${input:-${PHYHUB_REGION:-eu}}"

    # Write environment file
    cat > "$ENV_FILE" << EOF
# Python WebRTC Test Configuration
# Generated by webrtc-test.sh setup

# Device A (local initiator)
DEVICE_A_ID=$DEVICE_A_ID
DEVICE_A_KEY=$DEVICE_A_KEY
DEVICE_A_TWIN_ID=$DEVICE_A_TWIN_ID

# Device B (remote responder)
DEVICE_B_ID=$DEVICE_B_ID
DEVICE_B_KEY=$DEVICE_B_KEY
DEVICE_B_TWIN_ID=$DEVICE_B_TWIN_ID

# Remote host configuration
REMOTE_HOST=$REMOTE_HOST
REMOTE_PATH=$REMOTE_PATH

# PhyHub configuration
PHYHUB_REGION=$PHYHUB_REGION
EOF

    chmod 600 "$ENV_FILE"
    log_success "Configuration saved to $ENV_FILE"

    # Add to gitignore if not already there
    GITIGNORE="$PROJECT_DIR/.gitignore"
    if ! grep -q ".env.webrtc-test" "$GITIGNORE" 2>/dev/null; then
        echo ".env.webrtc-test" >> "$GITIGNORE"
        log_info "Added .env.webrtc-test to .gitignore"
    fi
}

# Sync code to remote host
sync_to_remote() {
    log_info "Syncing code to $REMOTE_HOST:$REMOTE_PATH..."

    # Create remote directory
    ssh "$REMOTE_HOST" "mkdir -p $REMOTE_PATH"

    # Sync project files (exclude venv to preserve remote installation)
    rsync -avz \
        --exclude '__pycache__' \
        --exclude '*.pyc' \
        --exclude '.git' \
        --exclude '*.log' \
        --exclude '.env.webrtc-test' \
        --exclude 'venv' \
        --exclude '.venv' \
        --exclude '*.egg-info' \
        --delete --exclude 'venv' \
        "$PROJECT_DIR/" "$REMOTE_HOST:$REMOTE_PATH/"

    log_success "Code synced to remote host"
}

# Install dependencies on remote
install_remote_deps() {
    log_info "Installing Python dependencies on remote host..."

    # Create virtual environment if it doesn't exist
    ssh "$REMOTE_HOST" "cd $REMOTE_PATH && ([ -d venv ] || python3 -m venv venv)"

    # Install dependencies in venv
    ssh "$REMOTE_HOST" "cd $REMOTE_PATH && ./venv/bin/pip install -e . 2>&1" || {
        log_error "Failed to install dependencies on remote"
        exit 1
    }

    log_success "Dependencies installed on remote"
}

# Start responder on remote host
start_remote_responder() {
    log_info "Starting Python responder on remote host..."

    # Kill any existing responder process
    ssh "$REMOTE_HOST" "pkill -f 'test_communication.py' 2>/dev/null || true"
    sleep 1

    # Copy env file to remote
    scp -q "$ENV_FILE" "$REMOTE_HOST:$REMOTE_PATH/.env.webrtc-test"

    # Create wrapper script that sources the env file
    local tmp_script="/tmp/run-python-responder-$$.sh"
    cat > "$tmp_script" << EOF
#!/bin/bash
cd $REMOTE_PATH
source .env.webrtc-test
export PHYHUB_DIRECT=true
export DEVICE_ID="\$DEVICE_B_ID"
export ACCESS_KEY="\$DEVICE_B_KEY"
export PEER_TWIN_ID="\$DEVICE_A_TWIN_ID"
export PHYHUB_REGION="\$PHYHUB_REGION"
export ROLE=responder
./venv/bin/python tests/test_communication.py
EOF
    scp -q "$tmp_script" "$REMOTE_HOST:$REMOTE_PATH/run-responder.sh"
    rm -f "$tmp_script"

    ssh "$REMOTE_HOST" "chmod +x $REMOTE_PATH/run-responder.sh"

    # Start responder in background
    ssh -f "$REMOTE_HOST" "nohup bash $REMOTE_PATH/run-responder.sh > $REMOTE_LOG 2>&1 &"

    # Wait for responder to be ready
    log_info "Waiting for responder to connect..."
    sleep 8

    # Check remote log
    if ssh "$REMOTE_HOST" "grep -q 'Connected to PhyHub' $REMOTE_LOG 2>/dev/null"; then
        log_success "Responder connected and ready"
    elif ssh "$REMOTE_HOST" "grep -q 'Connecting' $REMOTE_LOG 2>/dev/null"; then
        log_info "Responder is connecting..."
        sleep 3
    else
        log_warn "Responder may not be ready yet"
        log_info "Current remote log:"
        ssh "$REMOTE_HOST" "tail -20 $REMOTE_LOG 2>/dev/null || echo 'No log yet'"
    fi
}

# Run initiator locally
run_local_initiator() {
    log_info "Running Python initiator locally..."

    cd "$PROJECT_DIR"

    PHYHUB_DIRECT=true \
    DEVICE_ID="$DEVICE_A_ID" \
    ACCESS_KEY="$DEVICE_A_KEY" \
    PEER_TWIN_ID="$DEVICE_B_TWIN_ID" \
    PHYHUB_REGION="$PHYHUB_REGION" \
    ROLE=initiator \
    python tests/test_communication.py 2>&1 | tee "$LOCAL_LOG"
}

# Collect and display results
collect_results() {
    echo ""
    log_info "Test completed. Collecting results..."
    echo ""

    echo "=== Remote Responder Log ==="
    ssh "$REMOTE_HOST" "cat $REMOTE_LOG 2>/dev/null || echo 'No log available'"
    echo ""

    echo "=== Local Initiator Log ==="
    cat "$LOCAL_LOG" 2>/dev/null || echo "No log available"
    echo ""
}

# Clean up
cleanup() {
    log_info "Cleaning up..."

    # Kill remote responder
    ssh "$REMOTE_HOST" "pkill -f 'test_communication.py' 2>/dev/null || true"

    # Clean remote logs
    ssh "$REMOTE_HOST" "rm -f $REMOTE_LOG 2>/dev/null || true"

    # Clean local logs
    rm -f "$LOCAL_LOG" 2>/dev/null || true

    log_success "Cleanup complete"
}

# Clean remote installation
cmd_clean() {
    load_env

    log_info "Cleaning up remote host..."

    ssh "$REMOTE_HOST" "pkill -f 'test_communication.py' 2>/dev/null || true"
    ssh "$REMOTE_HOST" "rm -rf $REMOTE_PATH 2>/dev/null || true"
    ssh "$REMOTE_HOST" "rm -f $REMOTE_LOG 2>/dev/null || true"

    log_success "Remote host cleaned"
}

# Run the test
cmd_run() {
    load_env

    echo ""
    log_info "${CYAN}Python WebRTC Two-Host Test${NC}"
    echo "=============================================="
    echo "  Local (Initiator):  Device A - Twin $DEVICE_A_TWIN_ID"
    echo "  Remote (Responder): Device B - Twin $DEVICE_B_TWIN_ID @ $REMOTE_HOST"
    echo "  PhyHub Region:      $PHYHUB_REGION"
    echo "=============================================="
    echo ""

    # Set up trap for cleanup
    trap cleanup EXIT

    # Sync and install
    sync_to_remote
    install_remote_deps

    # Start responder on remote
    start_remote_responder

    # Run initiator locally
    run_local_initiator

    # Collect results
    collect_results
}

# Show usage
cmd_help() {
    echo "Python WebRTC Two-Host Test Runner"
    echo ""
    echo "Usage: $0 <command>"
    echo ""
    echo "Commands:"
    echo "  setup    Configure test credentials and remote host"
    echo "  run      Run the communication test"
    echo "  clean    Clean up remote host installation"
    echo "  help     Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 setup    # First time setup"
    echo "  $0 run      # Run test"
    echo "  $0 clean    # Clean up"
}

# Main
case "${1:-}" in
    setup)
        cmd_setup
        ;;
    run)
        cmd_run
        ;;
    clean)
        cmd_clean
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        cmd_help
        exit 1
        ;;
esac
