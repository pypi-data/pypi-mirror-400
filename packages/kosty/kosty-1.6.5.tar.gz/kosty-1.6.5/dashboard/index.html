<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kosty - AWS Cost Optimization Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const ServiceIcon = ({ service }) => {
            const icons = {
                ec2: 'fas fa-server', rds: 'fas fa-database', s3: 'fas fa-cloud',
                lambda: 'fas fa-bolt', ebs: 'fas fa-hdd', vpc: 'fas fa-network-wired',
                cloudwatch: 'fas fa-chart-line', elasticache: 'fas fa-memory',
                iam: 'fas fa-users-cog', cloudfront: 'fas fa-globe',
                backup: 'fas fa-archive', apigateway: 'fas fa-exchange-alt',
                default: 'fas fa-cube'
            };
            return <i className={`${icons[service] || icons.default} text-lg`}></i>;
        };

        const StatCard = ({ title, value, icon, color, trend, subtitle }) => (
            <div className={`bg-white rounded-xl p-6 card-shadow border-l-4 ${color} hover:shadow-lg transition-shadow`}>
                <div className="flex items-center justify-between">
                    <div>
                        <p className="text-sm font-medium text-gray-600">{title}</p>
                        <p className="text-3xl font-bold text-gray-900 mt-2">{value}</p>
                        {subtitle && <p className="text-sm text-gray-500 mt-1">{subtitle}</p>}
                        {trend && <p className="text-sm text-green-600 mt-1">{trend}</p>}
                    </div>
                    <div>
                        <i className={`${icon} text-3xl ${color.replace('border-l-', 'text-')}`}></i>
                    </div>
                </div>
            </div>
        );

        const IssueCard = ({ service, items, count, type, onIssueClick, onViewAll, severityColors }) => {
            const typeColors = {
                cost: 'border-orange-500',
                security: 'border-red-500',
                Cost: 'border-orange-500',
                Security: 'border-red-500'
            };

            return (
                <div className={`bg-white rounded-lg p-4 border-l-4 ${typeColors[type] || typeColors.cost} card-shadow hover:shadow-lg transition-shadow`}>
                    <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center space-x-3">
                            <ServiceIcon service={service} />
                            <div>
                                <h3 className="font-semibold text-gray-900 uppercase text-sm">{service}</h3>
                                <p className="text-xs text-gray-600 capitalize">{type} Issues</p>
                            </div>
                        </div>
                        <span className="bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-0.5 rounded-full">
                            {count}
                        </span>
                    </div>
                    
                    {items && items.length > 0 && (
                        <div className="mt-3 space-y-2">
                            {items.slice(0, 3).map((item, idx) => (
                                <div key={idx} className="text-sm bg-gray-50 p-3 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors" onClick={() => onIssueClick(item)}>
                                    <div className="flex items-center justify-between">
                                        <span className="font-medium text-gray-900">
                                            {item.ResourceName || item.BucketName || item.InstanceId || item.ResourceId}
                                        </span>
                                        {(item.severity || item.Severity) && (
                                            <span className={`text-xs font-medium px-2 py-1 rounded-full ${severityColors[item.severity || item.Severity] || 'bg-gray-100 text-gray-800'}`}>
                                                {item.severity || item.Severity}
                                            </span>
                                        )}
                                    </div>
                                    <p className="text-xs text-gray-600 mt-1">{item.Issue}</p>
                                    {item.Region && (
                                        <p className="text-xs text-gray-500 mt-1">
                                            <i className="fas fa-map-marker-alt mr-1"></i>
                                            {item.Region}
                                        </p>
                                    )}
                                    {item.monthly_cost && (
                                        <p className="text-xs text-green-600 font-semibold mt-1">
                                            <i className="fas fa-dollar-sign mr-1"></i>
                                            ${item.monthly_cost.toFixed(2)}/month
                                        </p>
                                    )}
                                    <p className="text-xs text-blue-600 mt-1">
                                        <i className="fas fa-info-circle mr-1"></i>
                                        Click for details
                                    </p>
                                </div>
                            ))}
                            {items.length > 3 && (
                                <button 
                                    onClick={() => onViewAll(service, type, items)}
                                    className="w-full text-xs text-blue-600 hover:text-blue-800 font-medium py-2 hover:bg-blue-50 rounded transition-colors"
                                >
                                    <i className="fas fa-eye mr-1"></i>
                                    View all {items.length} issues
                                </button>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const Dashboard = () => {
            const [data, setData] = useState(null);
            const [showDemo, setShowDemo] = useState(false);
            
            // Demo data for preview
            const demoData = {
                "scan_timestamp": "2024-01-15T14:30:22.123456",
                "total_issues": 42,
                "results": {
                    "123456789012": {
                        "ec2": {
                            "audit": {
                                "count": 8,
                                "items": [
                                    {
                                        "AccountId": "123456789012",
                                        "Region": "us-east-1",
                                        "Service": "EC2",
                                        "ResourceId": "i-0123456789abcdef0",
                                        "ResourceName": "web-server-prod-01",
                                        "Issue": "Oversized instance with low CPU utilization",
                                        "Type": "Cost",
                                        "Severity": "High",
                                        "Description": "Instance running at 5% CPU for 30 days"
                                    }
                                ]
                            }
                        },
                        "s3": {
                            "audit": {
                                "count": 12,
                                "items": [
                                    {
                                        "AccountId": "123456789012",
                                        "Region": "us-east-1",
                                        "Service": "S3",
                                        "ResourceId": "company-logs-archive",
                                        "ResourceName": "company-logs-archive",
                                        "Issue": "Objects without lifecycle policy",
                                        "Type": "Cost",
                                        "Severity": "Medium",
                                        "Description": "2.5TB of logs older than 90 days"
                                    }
                                ]
                            }
                        },
                        "rds": {
                            "audit": {
                                "count": 6,
                                "items": [
                                    {
                                        "AccountId": "123456789012",
                                        "Region": "us-east-1",
                                        "Service": "RDS",
                                        "ResourceId": "prod-mysql-cluster",
                                        "ResourceName": "prod-mysql-cluster",
                                        "Issue": "Oversized RDS instance with low CPU",
                                        "Type": "Cost",
                                        "Severity": "High",
                                        "Description": "db.r5.2xlarge running at 8% CPU"
                                    }
                                ]
                            }
                        },
                        "iam": {
                            "audit": {
                                "count": 16,
                                "items": [
                                    {
                                        "AccountId": "123456789012",
                                        "Region": "us-east-1",
                                        "Service": "IAM",
                                        "ResourceId": "root",
                                        "ResourceName": "root",
                                        "Issue": "Root account has access keys",
                                        "Type": "Security",
                                        "Severity": "Critical",
                                        "Description": "Root account with active access keys"
                                    }
                                ]
                            }
                        }
                    }
                }
            };
            const [loading, setLoading] = useState(false);
            const [selectedIssue, setSelectedIssue] = useState(null);
            const [viewAllModal, setViewAllModal] = useState(null);
            const [filters, setFilters] = useState({
                type: 'all',
                severity: 'all',
                service: 'all'
            });
            const chartRef = useRef(null);
            const pieChartRef = useRef(null);
            const severityChartRef = useRef(null);

            const severityColors = {
                critical: 'bg-red-100 text-red-800',
                high: 'bg-orange-100 text-orange-800',
                medium: 'bg-yellow-100 text-yellow-800',
                low: 'bg-green-100 text-green-800',
                Critical: 'bg-red-100 text-red-800',
                High: 'bg-orange-100 text-orange-800',
                Medium: 'bg-yellow-100 text-yellow-800',
                Low: 'bg-green-100 text-green-800'
            };

            useEffect(() => {
                const currentData = data || (showDemo ? demoData : null);
                if (currentData && chartRef.current && pieChartRef.current && severityChartRef.current) {
                    createCharts();
                }
            }, [data, showDemo, chartRef.current, pieChartRef.current, severityChartRef.current]);

            const createCharts = () => {
                const currentData = data || (showDemo ? demoData : null);
                if (!currentData) return;
                
                // Clear existing charts
                if (chartRef.current) {
                    const existingChart = Chart.getChart(chartRef.current);
                    if (existingChart) existingChart.destroy();
                }
                if (pieChartRef.current) {
                    const existingChart = Chart.getChart(pieChartRef.current);
                    if (existingChart) existingChart.destroy();
                }
                if (severityChartRef.current) {
                    const existingChart = Chart.getChart(severityChartRef.current);
                    if (existingChart) existingChart.destroy();
                }
                
                // Services Chart
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    const serviceData = getServiceData(currentData);
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: serviceData.labels,
                            datasets: [{
                                label: 'Issues Found',
                                data: serviceData.values,
                                backgroundColor: 'rgba(99, 102, 241, 0.8)',
                                borderColor: 'rgba(99, 102, 241, 1)',
                                borderWidth: 1,
                                borderRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `${context.parsed.y} issues`
                                    }
                                }
                            },
                            scales: { 
                                y: { beginAtZero: true },
                                x: { ticks: { maxRotation: 45 } }
                            }
                        }
                    });
                }

                // Type Distribution Chart
                if (pieChartRef.current) {
                    const ctx = pieChartRef.current.getContext('2d');
                    const typeData = getTypeDistribution(currentData);
                    
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: typeData.labels,
                            datasets: [{
                                data: typeData.values,
                                backgroundColor: ['#EF4444', '#F59E0B', '#3B82F6'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'bottom' },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `${context.label}: ${context.parsed} issues`
                                    }
                                }
                            }
                        }
                    });
                }

                // Severity Chart
                if (severityChartRef.current) {
                    const ctx = severityChartRef.current.getContext('2d');
                    const severityData = getSeverityData(currentData);
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: severityData.labels,
                            datasets: [{
                                label: 'Issues by Severity',
                                data: severityData.values,
                                backgroundColor: [
                                    '#DC2626', // Critical - Red
                                    '#EA580C', // High - Orange
                                    '#D97706', // Medium - Yellow
                                    '#059669'  // Low - Green
                                ],
                                borderRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                }
            };

            // Helper function to normalize data format
            const normalizeData = (currentData) => {
                if (!currentData || !currentData.results) return { results: {} };
                
                const normalized = { ...currentData, results: {} };
                
                Object.entries(currentData.results).forEach(([accountId, account]) => {
                    // Check if it's flat format (array) or nested format (object)
                    if (Array.isArray(account)) {
                        // Flat format - convert to nested
                        normalized.results[accountId] = {};
                        account.forEach(item => {
                            const service = (item.Service || 'unknown').toLowerCase();
                            if (!normalized.results[accountId][service]) {
                                normalized.results[accountId][service] = {
                                    audit: { count: 0, items: [] }
                                };
                            }
                            normalized.results[accountId][service].audit.items.push(item);
                            normalized.results[accountId][service].audit.count++;
                        });
                    } else {
                        // Already nested format
                        normalized.results[accountId] = account;
                    }
                });
                
                return normalized;
            };

            const getServiceData = (currentData) => {
                const services = {};
                if (!currentData) return { labels: [], values: [] };
                
                const normalizedData = normalizeData(currentData);
                
                Object.values(normalizedData.results).forEach(account => {
                    Object.entries(account).forEach(([service, commands]) => {
                        const totalIssues = Object.values(commands).reduce((sum, cmd) => sum + cmd.count, 0);
                        if (totalIssues > 0) {
                            services[service.toUpperCase()] = (services[service.toUpperCase()] || 0) + totalIssues;
                        }
                    });
                });
                
                const sorted = Object.entries(services).sort(([,a], [,b]) => b - a);
                return {
                    labels: sorted.map(([service]) => service),
                    values: sorted.map(([,count]) => count)
                };
            };

            const getTypeDistribution = (currentData) => {
                const types = { 'Cost': 0, 'Security': 0, 'Other': 0 };
                if (!currentData) return { labels: [], values: [] };
                
                const normalizedData = normalizeData(currentData);
                
                Object.values(normalizedData.results).forEach(account => {
                    Object.entries(account).forEach(([service, commands]) => {
                        Object.entries(commands).forEach(([command, details]) => {
                            if (details.items) {
                                details.items.forEach(item => {
                                    // Handle both uppercase and lowercase type fields
                                    const type = item.Type || item.type || 'Other';
                                    const normalizedType = type.charAt(0).toUpperCase() + type.slice(1).toLowerCase();
                                    
                                    if (types.hasOwnProperty(normalizedType)) {
                                        types[normalizedType]++;
                                    } else {
                                        types['Other']++;
                                    }
                                });
                            }
                        });
                    });
                });

                return {
                    labels: Object.keys(types).filter(key => types[key] > 0),
                    values: Object.values(types).filter(val => val > 0)
                };
            };

            const getSeverityData = (currentData) => {
                const severities = { 'Critical': 0, 'High': 0, 'Medium': 0, 'Low': 0 };
                if (!currentData) return { labels: [], values: [] };
                
                const normalizedData = normalizeData(currentData);
                
                Object.values(normalizedData.results).forEach(account => {
                    Object.entries(account).forEach(([service, commands]) => {
                        Object.entries(commands).forEach(([command, details]) => {
                            if (details.items) {
                                details.items.forEach(item => {
                                    const severity = item.severity || item.Severity || 'low';
                                    const normalizedSeverity = severity.toLowerCase();
                                    
                                    if (normalizedSeverity === 'critical') {
                                        severities['Critical']++;
                                    } else if (normalizedSeverity === 'high') {
                                        severities['High']++;
                                    } else if (normalizedSeverity === 'medium') {
                                        severities['Medium']++;
                                    } else {
                                        severities['Low']++;
                                    }
                                });
                            }
                        });
                    });
                });

                return {
                    labels: Object.keys(severities).filter(key => severities[key] > 0),
                    values: Object.values(severities).filter(val => val > 0)
                };
            };

            const getGroupedIssues = () => {
                const grouped = {};
                const dataToUse = data || (showDemo ? demoData : null);
                if (!dataToUse) return [];
                
                const normalizedData = normalizeData(dataToUse);
                
                Object.entries(normalizedData.results).forEach(([accountId, account]) => {
                    Object.entries(account).forEach(([service, commands]) => {
                        Object.entries(commands).forEach(([command, details]) => {
                            if (details.count > 0 && details.items) {
                                // Group by service and type
                                const costItems = details.items.filter(item => {
                                    const type = (item.Type || item.type || '').toLowerCase();
                                    return type === 'cost';
                                });
                                const securityItems = details.items.filter(item => {
                                    const type = (item.Type || item.type || '').toLowerCase();
                                    return type === 'security';
                                });

                                if (costItems.length > 0) {
                                    const key = `${service}-cost`;
                                    if (!grouped[key]) {
                                        grouped[key] = {
                                            service,
                                            type: 'Cost',
                                            items: [],
                                            count: 0
                                        };
                                    }
                                    grouped[key].items.push(...costItems);
                                    grouped[key].count += costItems.length;
                                }

                                if (securityItems.length > 0) {
                                    const key = `${service}-security`;
                                    if (!grouped[key]) {
                                        grouped[key] = {
                                            service,
                                            type: 'Security',
                                            items: [],
                                            count: 0
                                        };
                                    }
                                    grouped[key].items.push(...securityItems);
                                    grouped[key].count += securityItems.length;
                                }
                            }
                        });
                    });
                });

                return Object.values(grouped).sort((a, b) => b.count - a.count);
            };

            const getFilteredIssues = (issues) => {
                return issues.filter(issue => {
                    // Type filter
                    if (filters.type !== 'all' && issue.type.toLowerCase() !== filters.type.toLowerCase()) {
                        return false;
                    }
                    
                    // Service filter
                    if (filters.service !== 'all' && issue.service.toLowerCase() !== filters.service.toLowerCase()) {
                        return false;
                    }
                    
                    // Severity filter
                    if (filters.severity !== 'all') {
                        const hasSeverity = issue.items.some(item => {
                            const severity = item.severity || item.Severity || '';
                            return severity.toLowerCase() === filters.severity.toLowerCase();
                        });
                        if (!hasSeverity) return false;
                    }
                    
                    return true;
                });
            };

            const getAvailableServices = () => {
                const services = new Set();
                const dataToUse = data || (showDemo ? demoData : null);
                if (!dataToUse) return [];
                
                const normalizedData = normalizeData(dataToUse);
                
                Object.values(normalizedData.results).forEach(account => {
                    Object.keys(account).forEach(service => {
                        if (account[service].audit && account[service].audit.count > 0) {
                            services.add(service.toUpperCase());
                        }
                    });
                });
                return Array.from(services).sort();
            };

            const getStats = () => {
                let costIssues = 0;
                let securityIssues = 0;
                let criticalIssues = 0;
                let highIssues = 0;
                let totalMonthlySavings = 0;
                let servicesWithIssues = new Set();
                const dataToUse = data || (showDemo ? demoData : null);
                if (!dataToUse) return { costIssues: 0, securityIssues: 0, criticalIssues: 0, highIssues: 0, servicesWithIssues: 0, totalMonthlySavings: 0 };
                
                const normalizedData = normalizeData(dataToUse);
                
                Object.values(normalizedData.results).forEach(account => {
                    Object.entries(account).forEach(([service, commands]) => {
                        let serviceHasIssues = false;
                        Object.entries(commands).forEach(([command, details]) => {
                            if (details.items) {
                                details.items.forEach(item => {
                                    const type = (item.Type || item.type || '').toLowerCase();
                                    const severity = (item.severity || item.Severity || '').toLowerCase();
                                    
                                    if (type === 'cost') {
                                        costIssues++;
                                        if (item.monthly_cost) {
                                            totalMonthlySavings += item.monthly_cost;
                                        }
                                    }
                                    if (type === 'security') securityIssues++;
                                    if (severity === 'critical') criticalIssues++;
                                    if (severity === 'high') highIssues++;
                                    serviceHasIssues = true;
                                });
                            }
                        });
                        if (serviceHasIssues) servicesWithIssues.add(service);
                    });
                });

                return { costIssues, securityIssues, criticalIssues, highIssues, servicesWithIssues: servicesWithIssues.size, totalMonthlySavings };
            };

            const loadJsonFile = (event) => {
                const file = event.target.files[0];
                if (file) {
                    setLoading(true);
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            setData(jsonData);
                            setTimeout(() => setLoading(false), 1000);
                        } catch (error) {
                            alert('Invalid JSON file. Please upload a valid Kosty report.');
                            setLoading(false);
                        }
                    };
                    reader.readAsText(file);
                }
            };

            const formatDate = (timestamp) => {
                return new Date(timestamp).toLocaleString();
            };

            if (!data && !showDemo) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center max-w-md">
                            <div className="gradient-bg text-white p-8 rounded-xl card-shadow mb-8">
                                <i className="fas fa-chart-line text-6xl mb-4"></i>
                                <h1 className="text-3xl font-bold mb-2">ðŸ’° Kosty Dashboard</h1>
                                <p className="text-blue-100">AWS Cost Optimization Analysis</p>
                            </div>
                            
                            <div className="space-y-4">
                                <input
                                    type="file"
                                    accept=".json"
                                    onChange={loadJsonFile}
                                    className="hidden"
                                    id="json-upload"
                                />
                                <label
                                    htmlFor="json-upload"
                                    className="bg-blue-600 text-white px-8 py-4 rounded-lg font-medium cursor-pointer hover:bg-blue-700 transition-colors inline-block shadow-lg w-full"
                                >
                                    <i className="fas fa-upload mr-2"></i>
                                    Load JSON Report
                                </label>
                                
                                <button
                                    onClick={() => setShowDemo(true)}
                                    className="bg-green-600 text-white px-8 py-4 rounded-lg font-medium cursor-pointer hover:bg-green-700 transition-colors shadow-lg w-full"
                                >
                                    <i className="fas fa-eye mr-2"></i>
                                    View Demo Dashboard
                                </button>
                            </div>
                            
                            <p className="text-gray-600 mt-4">
                                Upload your <code className="bg-gray-200 px-2 py-1 rounded">kosty audit --output json</code> file<br/>
                                or view the demo to see how it works
                            </p>
                        </div>
                    </div>
                );
            }

            const currentData = data || (showDemo ? demoData : null);
            if (!currentData) return null;
            
            const groupedIssues = getGroupedIssues();
            const stats = getStats();
            const totalAccounts = Object.keys(currentData.results).length;

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="gradient-bg text-white">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-4xl font-bold flex items-center">
                                        <i className="fas fa-chart-line mr-3"></i>
                                        ðŸ’° Kosty Dashboard
                                    </h1>
                                    <p className="text-blue-100 mt-2">AWS Cost Optimization Analysis</p>
                                    <p className="text-sm text-blue-200 mt-1">
                                        <i className="fas fa-clock mr-1"></i>
                                        Last scan: {formatDate(currentData.scan_timestamp)}
                                    </p>
                                </div>
                                <div className="text-right">
                                    <input
                                        type="file"
                                        accept=".json"
                                        onChange={loadJsonFile}
                                        className="hidden"
                                        id="json-upload"
                                    />
                                    <label
                                        htmlFor="json-upload"
                                        className="bg-white text-blue-600 px-4 py-2 rounded-lg font-medium cursor-pointer hover:bg-blue-50 transition-colors"
                                    >
                                        <i className="fas fa-upload mr-2"></i>
                                        Load New Report
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {loading && (
                            <div className="text-center py-12">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                                <p className="mt-4 text-gray-600">Analyzing your AWS infrastructure...</p>
                            </div>
                        )}

                        {!loading && (
                            <>
                                {/* Cost Summary Card - Full Width */}
                                {stats.totalMonthlySavings > 0 && (
                                    <div className="mb-8">
                                        <div className="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-8 card-shadow text-white">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center space-x-6">
                                                    <div className="bg-white bg-opacity-20 rounded-full p-4">
                                                        <i className="fas fa-piggy-bank text-4xl"></i>
                                                    </div>
                                                    <div>
                                                        <h2 className="text-3xl font-bold mb-2">ðŸ’° Total Estimated Savings</h2>
                                                        <div className="flex items-center space-x-8">
                                                            <div>
                                                                <p className="text-green-100 text-sm font-medium">Monthly Savings</p>
                                                                <p className="text-4xl font-bold">${stats.totalMonthlySavings.toFixed(2)}</p>
                                                            </div>
                                                            <div>
                                                                <p className="text-green-100 text-sm font-medium">Annual Savings</p>
                                                                <p className="text-4xl font-bold">${(stats.totalMonthlySavings * 12).toFixed(2)}</p>
                                                            </div>
                                                        </div>
                                                        <p className="text-green-100 text-sm mt-2">
                                                            <i className="fas fa-chart-line mr-1"></i>
                                                            Based on {stats.costIssues} cost optimization opportunities
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="bg-white bg-opacity-20 rounded-lg p-4">
                                                        <i className="fas fa-calculator text-3xl mb-2"></i>
                                                        <p className="text-sm font-medium">ROI Calculator</p>
                                                        <p className="text-xs text-green-100">Immediate impact</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Stats Cards */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                                    <StatCard
                                        title="Total Issues"
                                        value={currentData.total_issues}
                                        icon="fas fa-exclamation-triangle"
                                        color="border-l-red-500"
                                        subtitle="Optimization opportunities"
                                    />
                                    <StatCard
                                        title="Cost Issues"
                                        value={stats.costIssues}
                                        icon="fas fa-dollar-sign"
                                        color="border-l-orange-500"
                                        subtitle="Potential savings"
                                    />
                                    <StatCard
                                        title="Security Issues"
                                        value={stats.securityIssues}
                                        icon="fas fa-shield-alt"
                                        color="border-l-red-500"
                                        subtitle="Security risks"
                                    />
                                    <StatCard
                                        title="Critical Issues"
                                        value={stats.criticalIssues}
                                        icon="fas fa-fire"
                                        color="border-l-red-600"
                                        subtitle="Immediate attention"
                                    />
                                    <StatCard
                                        title="Services Affected"
                                        value={stats.servicesWithIssues}
                                        icon="fas fa-cogs"
                                        color="border-l-blue-500"
                                        subtitle={`of ${totalAccounts} accounts`}
                                    />
                                </div>

                                {/* Charts */}
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                                    <div className="bg-white rounded-xl p-6 card-shadow">
                                        <h3 className="text-lg font-semibold text-gray-900 mb-4">
                                            <i className="fas fa-chart-bar mr-2"></i>
                                            Issues by Service
                                        </h3>
                                        <div style={{ height: '300px' }}>
                                            <canvas ref={(el) => {
                                                chartRef.current = el;
                                                if (el && data) {
                                                    setTimeout(() => createCharts(), 100);
                                                }
                                            }}></canvas>
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-xl p-6 card-shadow">
                                        <h3 className="text-lg font-semibold text-gray-900 mb-4">
                                            <i className="fas fa-chart-pie mr-2"></i>
                                            Issue Types
                                        </h3>
                                        <div style={{ height: '300px' }}>
                                            <canvas ref={pieChartRef}></canvas>
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-xl p-6 card-shadow">
                                        <h3 className="text-lg font-semibold text-gray-900 mb-4">
                                            <i className="fas fa-exclamation-triangle mr-2"></i>
                                            Severity Distribution
                                        </h3>
                                        <div style={{ height: '300px' }}>
                                            <canvas ref={severityChartRef}></canvas>
                                        </div>
                                    </div>
                                </div>

                                {/* Issues Grid */}
                                <div className="bg-white rounded-xl card-shadow">
                                    <div className="px-6 py-4 border-b border-gray-200">
                                        <div className="flex items-center justify-between mb-4">
                                            <div>
                                                <h3 className="text-lg font-semibold text-gray-900">
                                                    <i className="fas fa-list-ul mr-2"></i>
                                                    Optimization Opportunities
                                                </h3>
                                                <p className="text-sm text-gray-600 mt-1">
                                                    Issues grouped by service and type
                                                </p>
                                            </div>
                                        </div>
                                        
                                        {/* Filters */}
                                        <div className="flex flex-wrap gap-4">
                                            <div className="flex items-center space-x-2">
                                                <label className="text-sm font-medium text-gray-700">Type:</label>
                                                <select 
                                                    value={filters.type} 
                                                    onChange={(e) => setFilters({...filters, type: e.target.value})}
                                                    className="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                >
                                                    <option value="all">All Types</option>
                                                    <option value="cost">Cost</option>
                                                    <option value="security">Security</option>
                                                </select>
                                            </div>
                                            
                                            <div className="flex items-center space-x-2">
                                                <label className="text-sm font-medium text-gray-700">Severity:</label>
                                                <select 
                                                    value={filters.severity} 
                                                    onChange={(e) => setFilters({...filters, severity: e.target.value})}
                                                    className="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                >
                                                    <option value="all">All Severities</option>
                                                    <option value="critical">Critical</option>
                                                    <option value="high">High</option>
                                                    <option value="medium">Medium</option>
                                                    <option value="low">Low</option>
                                                </select>
                                            </div>
                                            
                                            <div className="flex items-center space-x-2">
                                                <label className="text-sm font-medium text-gray-700">Service:</label>
                                                <select 
                                                    value={filters.service} 
                                                    onChange={(e) => setFilters({...filters, service: e.target.value})}
                                                    className="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                >
                                                    <option value="all">All Services</option>
                                                    {currentData && getAvailableServices().map(service => (
                                                        <option key={service} value={service.toLowerCase()}>{service}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            
                                            {(filters.type !== 'all' || filters.severity !== 'all' || filters.service !== 'all') && (
                                                <button
                                                    onClick={() => setFilters({type: 'all', severity: 'all', service: 'all'})}
                                                    className="text-sm text-blue-600 hover:text-blue-800 font-medium"
                                                >
                                                    <i className="fas fa-times mr-1"></i>
                                                    Clear Filters
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                    <div className="p-6">
                                        {(() => {
                                            const filteredIssues = getFilteredIssues(groupedIssues);
                                            return filteredIssues.length > 0 ? (
                                                <>
                                                    <div className="mb-4 text-sm text-gray-600">
                                                        Showing {filteredIssues.length} of {groupedIssues.length} issue groups
                                                    </div>
                                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                        {filteredIssues.map((issue, idx) => (
                                                            <IssueCard 
                                                                key={idx} 
                                                                {...issue} 
                                                                onIssueClick={setSelectedIssue} 
                                                                onViewAll={(service, type, items) => setViewAllModal({service, type, items})}
                                                                severityColors={severityColors} 
                                                            />
                                                        ))}
                                                    </div>
                                                </>
                                            ) : groupedIssues.length > 0 ? (
                                                <div className="text-center py-12">
                                                    <i className="fas fa-filter text-6xl text-gray-400 mb-4"></i>
                                                    <h3 className="text-xl font-semibold text-gray-900 mb-2">
                                                        No Issues Match Filters
                                                    </h3>
                                                    <p className="text-gray-600 mb-4">
                                                        Try adjusting your filter criteria.
                                                    </p>
                                                    <button
                                                        onClick={() => setFilters({type: 'all', severity: 'all', service: 'all'})}
                                                        className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                                    >
                                                        Clear All Filters
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="text-center py-12">
                                                    <i className="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                                                    <h3 className="text-xl font-semibold text-gray-900 mb-2">
                                                        ðŸŽ‰ No Issues Found!
                                                    </h3>
                                                    <p className="text-gray-600">
                                                        Your AWS infrastructure is well optimized.
                                                    </p>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                    
                    {/* View All Issues Modal */}
                    {viewAllModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 backdrop-blur-sm" onClick={() => setViewAllModal(null)}>
                            <div className="bg-white rounded-2xl shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden" onClick={(e) => e.stopPropagation()}>
                                <div className="bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-4">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center space-x-3">
                                            <ServiceIcon service={viewAllModal.service} />
                                            <div>
                                                <h3 className="text-xl font-bold text-white uppercase">{viewAllModal.service}</h3>
                                                <p className="text-blue-100 text-sm capitalize">{viewAllModal.type} Issues ({viewAllModal.items.length})</p>
                                            </div>
                                        </div>
                                        <button onClick={() => setViewAllModal(null)} className="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-colors">
                                            <i className="fas fa-times text-xl"></i>
                                        </button>
                                    </div>
                                </div>
                                <div className="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {viewAllModal.items.map((item, idx) => (
                                            <div key={idx} className="bg-gray-50 p-4 rounded-lg hover:bg-gray-100 transition-colors cursor-pointer" onClick={() => setSelectedIssue(item)}>
                                                <div className="flex items-center justify-between mb-2">
                                                    <span className="font-medium text-gray-900 text-sm">
                                                        {item.ResourceName || item.BucketName || item.ResourceId}
                                                    </span>
                                                    {(item.severity || item.Severity) && (
                                                        <span className={`text-xs font-medium px-2 py-1 rounded-full ${severityColors[item.severity || item.Severity] || 'bg-gray-100 text-gray-800'}`}>
                                                            {item.severity || item.Severity}
                                                        </span>
                                                    )}
                                                </div>
                                                <p className="text-xs text-gray-600 mb-2">{item.Issue}</p>
                                                {item.Region && (
                                                    <p className="text-xs text-gray-500 mb-1">
                                                        <i className="fas fa-map-marker-alt mr-1"></i>
                                                        {item.Region}
                                                    </p>
                                                )}
                                                {item.monthly_cost && (
                                                    <p className="text-xs text-green-600 font-semibold mb-1">
                                                        <i className="fas fa-dollar-sign mr-1"></i>
                                                        ${item.monthly_cost.toFixed(2)}/month
                                                    </p>
                                                )}
                                                <p className="text-xs text-blue-600">
                                                    <i className="fas fa-info-circle mr-1"></i>
                                                    Click for details
                                                </p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Premium Modal for issue details */}
                    {selectedIssue && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 backdrop-blur-sm" onClick={() => setSelectedIssue(null)}>
                            <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden" onClick={(e) => e.stopPropagation()}>
                                {/* Header with gradient */}
                                <div className="bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-4">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center space-x-3">
                                            <div className="bg-white bg-opacity-20 rounded-lg p-2">
                                                <i className="fas fa-exclamation-triangle text-white text-xl"></i>
                                            </div>
                                            <div>
                                                <h3 className="text-xl font-bold text-white">Issue Details</h3>
                                                <p className="text-blue-100 text-sm">{selectedIssue.Service} â€¢ {selectedIssue.Type}</p>
                                            </div>
                                        </div>
                                        <button onClick={() => {
                                            setSelectedIssue(null);
                                            if (!viewAllModal) setViewAllModal(null);
                                        }} className="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-colors">
                                            <i className="fas fa-arrow-left text-xl"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Content */}
                                <div className="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                                    {/* Status Banner */}
                                    <div className={`mb-6 p-4 rounded-xl border-l-4 ${
                                        selectedIssue.Type === 'Security' ? 'bg-red-50 border-red-500' : 'bg-orange-50 border-orange-500'
                                    }`}>
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center space-x-3">
                                                <i className={`fas ${
                                                    selectedIssue.Type === 'Security' ? 'fa-shield-alt text-red-600' : 'fa-dollar-sign text-orange-600'
                                                } text-2xl`}></i>
                                                <div>
                                                    <h4 className="font-semibold text-gray-900">{selectedIssue.Issue}</h4>
                                                    <p className={`text-sm ${
                                                        selectedIssue.Type === 'Security' ? 'text-red-700' : 'text-orange-700'
                                                    }`}>{selectedIssue.Type} Issue</p>
                                                </div>
                                            </div>
                                            <span className={`text-sm font-bold px-3 py-1 rounded-full ${severityColors[selectedIssue.severity || selectedIssue.Severity] || 'bg-gray-100 text-gray-800'}`}>
                                                {selectedIssue.severity || selectedIssue.Severity}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    {/* Resource Information */}
                                    <div className="bg-gray-50 rounded-xl p-5 mb-6">
                                        <h5 className="font-semibold text-gray-900 mb-4 flex items-center">
                                            <i className="fas fa-server text-blue-600 mr-2"></i>
                                            Resource Information
                                        </h5>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="bg-white rounded-lg p-3">
                                                <label className="text-xs font-medium text-gray-500 uppercase tracking-wide">Resource Name</label>
                                                <p className="text-gray-900 font-semibold mt-1">{selectedIssue.ResourceName || selectedIssue.BucketName || selectedIssue.ResourceId || 'N/A'}</p>
                                            </div>
                                            <div className="bg-white rounded-lg p-3">
                                                <label className="text-xs font-medium text-gray-500 uppercase tracking-wide">Service</label>
                                                <p className="text-gray-900 font-semibold mt-1 uppercase">{selectedIssue.Service || 'S3'}</p>
                                            </div>
                                            <div className="bg-white rounded-lg p-3">
                                                <label className="text-xs font-medium text-gray-500 uppercase tracking-wide">Region</label>
                                                <p className="text-gray-900 font-semibold mt-1 flex items-center">
                                                    <i className="fas fa-map-marker-alt text-green-600 mr-2"></i>
                                                    {selectedIssue.Region || 'Global'}
                                                </p>
                                            </div>
                                            <div className="bg-white rounded-lg p-3">
                                                <label className="text-xs font-medium text-gray-500 uppercase tracking-wide">Account ID</label>
                                                <p className="text-gray-900 font-semibold mt-1 font-mono">{selectedIssue.AccountId || 'N/A'}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Description */}
                                    <div className="bg-blue-50 rounded-xl p-5 mb-6">
                                        <h5 className="font-semibold text-gray-900 mb-3 flex items-center">
                                            <i className="fas fa-info-circle text-blue-600 mr-2"></i>
                                            Description
                                        </h5>
                                        <p className="text-gray-700 leading-relaxed">{selectedIssue.Description}</p>
                                        {selectedIssue.monthly_cost && (
                                            <div className="mt-4 bg-green-100 border-l-4 border-green-500 p-4 rounded">
                                                <div className="flex items-center justify-between">
                                                    <div>
                                                        <p className="text-sm font-semibold text-green-900">ðŸ’° Potential Monthly Savings</p>
                                                        <p className="text-2xl font-bold text-green-700 mt-1">${selectedIssue.monthly_cost.toFixed(2)}</p>
                                                        <p className="text-xs text-green-600 mt-1">Annual: ${(selectedIssue.monthly_cost * 12).toFixed(2)}</p>
                                                    </div>
                                                    <i className="fas fa-piggy-bank text-4xl text-green-600"></i>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Technical Details */}
                                    {selectedIssue.ARN && (
                                        <div className="bg-gray-900 rounded-xl p-5 mb-6">
                                            <h5 className="font-semibold text-white mb-3 flex items-center">
                                                <i className="fas fa-code text-green-400 mr-2"></i>
                                                Amazon Resource Name (ARN)
                                            </h5>
                                            <div className="bg-gray-800 rounded-lg p-3">
                                                <p className="text-green-400 font-mono text-sm break-all">{selectedIssue.ARN}</p>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Additional Details */}
                                    {selectedIssue.Details && (
                                        <div className="bg-purple-50 rounded-xl p-5">
                                            <h5 className="font-semibold text-gray-900 mb-3 flex items-center">
                                                <i className="fas fa-list-ul text-purple-600 mr-2"></i>
                                                Additional Details
                                            </h5>
                                            <div className="text-gray-700 leading-relaxed">
                                                {typeof selectedIssue.Details === 'object' ? (
                                                    <div className="space-y-2">
                                                        {Object.entries(selectedIssue.Details).map(([key, value]) => (
                                                            <div key={key} className="flex justify-between py-1 border-b border-purple-200 last:border-b-0">
                                                                <span className="font-medium text-purple-800">{key}:</span>
                                                                <span className="text-gray-700">{String(value)}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <p>{selectedIssue.Details}</p>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>