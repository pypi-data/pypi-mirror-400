.if-on-protected-tag: &if-on-protected-tag
    if: $CI_COMMIT_TAG && $CI_COMMIT_REF_PROTECTED == "true"
.if-on-default-branch: &if-on-default-branch
    if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
.if-on-merge-request: &if-on-merge-request
    if: $CI_PIPELINE_SOURCE == 'merge_request_event'

workflow:
    rules:
        - *if-on-merge-request
        - *if-on-default-branch
        - *if-on-protected-tag

include:
  - component: $CI_SERVER_HOST/gitlab-ci/code-quality/ruff@1
    rules:
      - *if-on-merge-request
      - *if-on-default-branch
  - component: $CI_SERVER_FQDN/python-libs/ci-component/build@~latest
    inputs:
      python_version: "3.13"
  - component: $CI_SERVER_FQDN/python-libs/ci-component/upload-pypi@~latest
    rules:
      - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH && $CI_COMMIT_TAG == null
    inputs:
      registry_token_var: $TESTPYPI_REGISTRY_TOKEN
      dependencies: [ "build:python" ]
      registry_name: "testpypi"
  - component: $CI_SERVER_FQDN/python-libs/ci-component/upload-pypi@~latest
    rules:
      - if: $CI_COMMIT_TAG && $CI_COMMIT_REF_PROTECTED
    inputs:
      registry_token_var: $PYPI_REGISTRY_TOKEN
      registry_name: "pypi"
      dependencies: [ "build:python" ]
  - component: $CI_SERVER_FQDN/python-libs/ci-component/upload-pypi@~latest
    rules:
      - if: $CI_COMMIT_TAG && $CI_COMMIT_REF_PROTECTED && $CI_SERVER_HOST
    inputs:
      registry_token_var: $CI_JOB_TOKEN
      registry_name: "$CI_SERVER_HOST"
      dependencies: [ "build:python" ]


"test:odoo:all":
  stage: test
  tags:
    - odoo
  rules:
    - *if-on-merge-request
    - *if-on-default-branch
  parallel:
    matrix:
      - ODOO_VERSION:
          - "12.0"
          - "13.0"
          - "14.0"
          - "15.0"
          - "16.0"
          - "17.0"
          - "18.0"
  image:
    name: registry.mangono.io/odoo-cloud/container:$ODOO_VERSION
    entrypoint: [ "" ]
  before_script:
    - pip install pytest pytest-cov pytest-mock environ-odoo-config
  script:
    - pip install .
    - pytest --cov --cov-report=xml --no-cov-on-fail --junit-xml=report.xml
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: ./coverage.xml
      junit: report.xml

# If we are tagging a release according protected rules and all
# previous checks succeeded, we proceed with creating a release automatically.
publish:release:
  tags: ["lint"]
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script: echo "Creating release $CI_COMMIT_TAG"
  rules:
    - if: $CI_COMMIT_TAG && $CI_COMMIT_REF_PROTECTED
  release:
    tag_name: $CI_COMMIT_TAG
    description: "Release $CI_COMMIT_TAG of components repository $CI_PROJECT_PATH"
