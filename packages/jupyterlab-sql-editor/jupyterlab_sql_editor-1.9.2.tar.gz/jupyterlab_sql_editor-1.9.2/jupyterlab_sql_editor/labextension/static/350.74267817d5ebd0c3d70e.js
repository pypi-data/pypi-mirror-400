"use strict";(self.webpackChunkjupyterlab_sql_editor=self.webpackChunkjupyterlab_sql_editor||[]).push([[350],{350:(t,e,r)=>{r.r(e),r.d(e,{default:()=>w});var o,s=r(460),a=r(23),i=r(723),n=r(389),l=r(223),c=r(827),d=r(474);!function(t){t.SHORT_PLUGIN_NAME="jupyterlab-sql-editor",t.FORMAT_COMMAND=`${t.SHORT_PLUGIN_NAME}:format_cell`,t.FORMAT_COMMAND_DOCUMENT=`${t.SHORT_PLUGIN_NAME}:format_document`,t.LONG_PLUGIN_NAME=`${t.SHORT_PLUGIN_NAME}`,t.SETTINGS_SECTION=`${t.LONG_PLUGIN_NAME}:plugin`}(o||(o={}));var h=r(697);const p="[0-9a-zA-Z\\._]+",g="-[a-z]",m="--[_a-zA-Z]+",u=`(?: |${g} ${p}|${m} ${p}|${g}|${m})*`;function f(t){return new h.RegExpForeignCodeExtractor({language:t,pattern:`(?:^|\n)%${t}${u}([^\n]*)`,foreignCaptureGroups:[1],isStandalone:!0,fileExtension:t})}function C(t){return new h.RegExpForeignCodeExtractor({language:t,pattern:`^%%(${t})( .*?)?\n([^]*)`,foreignCaptureGroups:[3],isStandalone:!0,fileExtension:t})}function k(t,e,r){return new h.RegExpForeignCodeExtractor({language:r,pattern:`${t}.*?\n([\\S\\s]*)${e}`,foreignCaptureGroups:[1],isStandalone:!0,fileExtension:r})}class M{constructor(t,e,r,o){this.dialect=t,this.formatTabWidth=e,this.formatUseTabs=r,this.formatKeywordCase=o}format(t){return(0,d.format)(t||"",{language:this.dialect,tabWidth:this.formatTabWidth,useTabs:this.formatUseTabs,keywordCase:this.formatKeywordCase,linesBetweenQueries:2})}}class x{constructor(t,e){this.working=!1,this.notebookTracker=t,this.extractors=[],this.extractors.push({dialect:"sparksql",extractor:C("sparksql")}),this.extractors.push({dialect:"trino",extractor:C("trino")}),this.formatters=e}setFormatters(t){this.formatters=t}pushExtractors(t,e,r,o){this.extractors.push({dialect:"sparksql",extractor:k(t,e,"sparksql")}),this.extractors.push({dialect:"trino",extractor:k(r,o,"trino")})}async formatAction(){return this.formatCells(!0)}async formatSelectedCodeCells(t){return this.formatCells(!0,t)}getCodeCells(t=!0,e){var r,o;if(!(null===(r=this.notebookTracker)||void 0===r?void 0:r.currentWidget))return[];const s=[];return(e=e||(null===(o=this.notebookTracker)||void 0===o?void 0:o.currentWidget.content)).widgets.forEach((r=>{"code"===r.model.type&&(t&&!(null==e?void 0:e.isSelectedOrActive(r))||s.push(r))})),s}tryReplacing(t,e,r){const o=r.extractor.extractForeignCode(e),s=t.editor;if(s&&o&&o.length>0&&o[0].foreignCode&&o[0].range){const e=this.formatters.get(r.dialect);if(!e)return;const a=e.format(o[0].foreignCode)+"\n";t.model.sharedModel.updateSource((null==s?void 0:s.getOffsetAt(o[0].range.start))||0,(null==s?void 0:s.getOffsetAt(o[0].range.end))||0,a)}}async formatCells(t,e){if(!this.working&&this.applicable())try{this.working=!0;const r=this.getCodeCells(t,e);if(r.length>0){const t=r.map((t=>t.model.sharedModel.getSource()));for(let e=0;e<r.length;++e){const o=r[e],s=t[e];if(o.model.sharedModel.getSource()===s)for(let t=0;t<this.extractors.length;++t)this.tryReplacing(o,s,this.extractors[t])}}}catch(t){await(0,c.showErrorMessage)("Jupyterlab Code Formatter Error",t)}finally{this.working=!1}}applicable(){const t=this.getCodeCells();if(t.length>0){const e=t.map((t=>t.model.sharedModel.getSource()));let r=0;return e.forEach((t=>{this.extractors.find((e=>e.extractor.hasForeignCode(t)))&&r++})),r==t.length}return!1}}class y{constructor(t,e){this.working=!1,this.editorTracker=t,this.sqlFormatter=e}setFormatter(t){this.sqlFormatter=t}formatAction(){if(this.working)return;const t=this.editorTracker.currentWidget;if(t)try{this.working=!0;const e=t.content.editor,r=null==e?void 0:e.model.sharedModel.getSource(),o=this.sqlFormatter.format(r);t.content.editor.model.sharedModel.setSource(o)}finally{this.working=!1}}}class b{constructor(t,e,r,o,s){this.app=t,this.tracker=e,this.editorTracker=r,this.notebookCodeFormatter=new x(this.tracker,o),this.fileEditorCodeFormatter=new y(this.editorTracker,s),this.setupCommands(),this.setupContextMenu()}setFormatters(t,e){this.notebookCodeFormatter.setFormatters(t),this.fileEditorCodeFormatter.setFormatter(e)}pushExtractors(t,e,r,o){this.notebookCodeFormatter.pushExtractors(t,e,r,o)}setupContextMenu(){this.app.contextMenu.addItem({command:o.FORMAT_COMMAND,selector:".jp-CodeCell"}),this.app.contextMenu.addItem({command:o.FORMAT_COMMAND_DOCUMENT,selector:".jp-FileEditor"})}setupCommands(){this.app.commands.addCommand(o.FORMAT_COMMAND,{execute:async()=>{await this.notebookCodeFormatter.formatSelectedCodeCells()},isVisible:()=>this.notebookCodeFormatter.applicable(),label:"Format SQL Cell"}),this.app.commands.addCommand(o.FORMAT_COMMAND_DOCUMENT,{execute:async()=>{await this.fileEditorCodeFormatter.formatAction()},label:"Format SQL Document"})}}const E="jupyterlab-sql-editor:plugin",w={id:E,description:"SQL editor support for formatting, syntax highlighting and code completion of SQL in cell magic, line magic, python string and file editor.",autoStart:!0,optional:[],requires:[l.ISettingRegistry,i.ILSPCodeExtractorsManager,n.INotebookTracker,a.IEditorTracker,s.IEditorLanguageRegistry],activate:(t,e,o,s,a,i)=>{const n=(t,e)=>{const r=t.get("formatTabWidth").composite,s=t.get("formatUseTabs").composite,a=t.get("formatKeywordCase").composite,i=t.get("sparksqlStartMarker").composite,n=t.get("sparksqlEndMarker").composite,l=t.get("trinoStartMarker").composite,c=t.get("trinoEndMarker").composite,d=new Map;d.set("sparksql",new M("spark",r,s,a)),d.set("trino",new M("trino",r,s,a));const h=new M("sql",r,s,a);o.register(k(i,n,"sparksql"),"python"),o.register(k(l,c,"trino"),"python"),e.setFormatters(d,h),e.pushExtractors(i,n,l,c),console.log("jupyterlab-sql-editor SQL code formatter registered")};t.restored.then((()=>{i.addLanguage({name:"sparksql",displayName:"Spark language server",mime:["application/sparksql","text/x-sparksql"],extensions:["sparksql"],load:async()=>(await Promise.all([r.e(277),r.e(580)]).then(r.bind(r,277))).sql()}),i.addLanguage({name:"trino",displayName:"Trino language server",mime:["application/trino","text/x-trino"],extensions:["trino"],load:async()=>(await Promise.all([r.e(277),r.e(580)]).then(r.bind(r,277))).sql()}),console.log("jupyterlab-sql-editor: languages added for syntax highlighting"),o.register(f("sparksql"),"python"),o.register(C("sparksql"),"python"),o.register(f("trino"),"python"),o.register(C("trino"),"python"),console.log("jupyterlab-sql-editor: LSP extractors registered");const l=!1,c="upper",d=new Map;d.set("sparksql",new M("spark",4,l,c)),d.set("trino",new M("trino",4,l,c));const h=new M("sql",4,l,c),p=new b(t,s,a,d,h);console.log("jupyterlab-sql-editor: sqlCodeFormatter initialized"),e.load(E).then((t=>{n(t,p),t.changed.connect((t=>{n(t,p)}))})).catch(console.error)})).catch(console.error),console.log("jupyterlab-sql-editor is activated")}}}}]);