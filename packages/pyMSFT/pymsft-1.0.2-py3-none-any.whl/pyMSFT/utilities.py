import numpy as np
from . import xp, GPU_USED

__all__ = ['colormap_turbo_white']

def to_shape(a, shape):
    y_, x_ = shape
    y, x = a.shape
    y_pad = (y_-y)
    x_pad = (x_-x)
    return np.pad(a, ((y_pad//2, y_pad//2 + y_pad % 2), (x_pad//2, x_pad//2 + x_pad % 2)), mode='constant')


def is_iterable(obj):
    try:
        iter(obj)
    except Exception:
        return False
    else:
        return True

def get_q_axis(npix_real: int, npix_fft: int, box_size: float, k: float = None,  wavelength: float = None, photon_energy: float = None) -> (xp.ndarray, xp.ndarray, xp.ndarray):
    k = get_k_from_input(k, wavelength, photon_energy)
    box_delta = box_size / (npix_real - 1)
    Q_CUT = xp.fft.fftshift(xp.fft.fftfreq(npix_fft, d=box_delta / (2 * xp.pi)))

    Q_X, Q_Y = xp.meshgrid(Q_CUT, Q_CUT, indexing='ij')
    if GPU_USED:
        Q_Z = k - xp.sqrt(k ** 2 - Q_X ** 2 - Q_Y ** 2)
    else:
        Q_Z = k - np.emath.sqrt(k ** 2 - Q_X ** 2 - Q_Y ** 2)
    return Q_X, Q_Y, Q_Z


def get_q_axis_and_angle(npix_real: int, npix_fft: int, box_size: float, k: float = None,  wavelength: float = None, photon_energy: float = None) -> (xp.ndarray, xp.ndarray, xp.ndarray, xp.ndarray, xp.ndarray):
    k = get_k_from_input(k, wavelength, photon_energy)
    Q_X, Q_Y, Q_Z = get_q_axis(npix_real, npix_fft, box_size, k=k)
    Q = xp.sqrt(Q_X ** 2 + Q_Y ** 2 + Q_Z ** 2)
    Q_angle = 2 * xp.real(xp.arcsin(Q / (2 * k)))
    return Q_X, Q_Y, Q_Z, Q, Q_angle


def get_k_from_input(k: float = None,  wavelength: float = None, photon_energy: float = None) -> float:
    if [x is not None for x in (k, wavelength, photon_energy)].count(True) > 1:
        raise AttributeError('Define either a wavelength=..., photon_energy=..., or a k=...!')
    elif wavelength is not None:
        k = 2 * np.pi / wavelength
    elif photon_energy is not None:
        k = 2 * np.pi / (1239.84193 / photon_energy)
    elif k is not None:
        pass  # k=k
    return k


colormap_turbo_white =  [[1, 1, 1], [1, 1, 1], [1, 1, 1], [0.996981382528000, 0.998348431846400, 1],
             [0.992601476875000, 0.992671348750000, 1], [0.986875504048000, 0.984679466713600, 1],
             [0.979879623163000, 0.974641052805200, 1], [0.971688360448000, 0.962810752844800, 1],
             [0.962374609243000, 0.949429889436400, 1], [0.952009630000000, 0.934726760000000, 1],
             [0.940663050283000, 0.918916934803600, 1], [0.928402864768000, 0.902203554995200, 1],
             [0.915295435243000, 0.884777630634800, 1], [0.901405490608000, 0.866818338726400, 1],
             [0.886796126875000, 0.848493321250000, 1], [0.871528807168000, 0.829958983193600, 1],
             [0.855663361723000, 0.811360790585200, 1], [0.839257987888000, 0.792833568524800, 1],
             [0.822369250123000, 0.774501799216400, 1], [0.805052080000000, 0.756479920000000, 1],
             [0.787359776203000, 0.738872621383600, 1], [0.769344004528000, 0.721775145075200, 1],
             [0.751054797883000, 0.705273582014800, 1], [0.732540556288000, 0.689445170406400, 1],
             [0.713848046875000, 0.674358593750000, 1], [0.695022403888000, 0.660074278873600, 1],
             [0.676107128683000, 0.646644693965200, 1], [0.657144089728000, 0.634114646604800, 1],
             [0.638173522603000, 0.622521581796400, 1], [0.619234030000000, 0.611895880000000, 1],
             [0.600362581723000, 0.602261155163600, 1], [0.581594514688000, 0.593634552755200, 1],
             [0.562963532923000, 0.586027047794800, 1], [0.544501707568000, 0.579443742886400, 1],
             [0.526239476875000, 0.573884166250000, 0.999215718250000],
             [0.508205646208000, 0.569342569753600, 0.998437802547200],
             [0.490427388043000, 0.565808226945200, 0.997531929061200],
             [0.472930241968000, 0.563265731084800, 0.996492111731200],
             [0.455738114683000, 0.561695293176400, 0.995312534637200],
             [0.438873280000000, 0.561073040000000, 0.993987552000000],
             [0.422356378843000, 0.561371312143600, 0.992511688181200],
             [0.406206419248000, 0.562558962035200, 0.990879637683200],
             [0.390440776363000, 0.564601651974800, 0.989086265149200],
             [0.375075192448000, 0.567462152166400, 0.987126605363200],
             [0.360123776875000, 0.571100638750000, 0.984995863250000],
             [0.345599006128000, 0.575474991833600, 0.982689413875200],
             [0.331511723803000, 0.580541093525200, 0.980202802445200],
             [0.317871140608000, 0.586253125964800, 0.977531744307200],
             [0.304684834363000, 0.592563869356400, 0.974672124949200],
             [0.291958750000000, 0.599425000000001, 0.971620000000000],
             [0.279697199563000, 0.606787388323599, 0.968371595229200],
             [0.267902862208000, 0.614601396915200, 0.964923306547200],
             [0.256576784203000, 0.622817178554800, 0.961271700005200],
             [0.245718378928000, 0.631384974246398, 0.957413511795200],
             [0.235325426875000, 0.640255411249999, 0.953345648250000],
             [0.225394075648000, 0.649379801113599, 0.949065185843200],
             [0.215918839963000, 0.658710437705199, 0.944569371189200],
             [0.206892601648000, 0.668200895244798, 0.939855621043200],
             [0.198306609643000, 0.677806326336399, 0.934921522301200],
             [0.190150480000000, 0.687483760000001, 0.929764832000000],
             [0.182412195883000, 0.697750000000000, 0.924383477317200],
             [0.175078107568000, 0.707320000000000, 0.918775555571200],
             [0.168132932443000, 0.716800000000000, 0.912939334221200],
             [0.161559755008000, 0.726200000000000, 0.906873250867200],
             [0.155340026875000, 0.735510000000000, 0.900575913250000],
             [0.149453566768000, 0.744720000000000, 0.894046099251200],
             [0.143878560523000, 0.753810000000000, 0.887282756893200],
             [0.138591561088000, 0.762790000000000, 0.880285004339200],
             [0.132780000000000, 0.771650000000000, 0.873052129893200],
             [0.126980000000000, 0.780370000000000, 0.865583592000000],
             [0.121510000000000, 0.788960000000000, 0.857879019245200],
             [0.116390000000000, 0.797400000000000, 0.849938210355200],
             [0.111670000000000, 0.805690000000000, 0.841761134197200],
             [0.107380000000000, 0.813810000000000, 0.833347929779200],
             [0.103570000000000, 0.821770000000000, 0.824698906250000],
             [0.100260000000000, 0.829550000000000, 0.813890000000000],
             [0.0975000000000000, 0.837140000000000, 0.803420000000000],
             [0.0953200000000000, 0.844550000000000, 0.792990000000000],
             [0.0937700000000000, 0.851750000000000, 0.782640000000000],
             [0.0928700000000000, 0.858750000000000, 0.772400000000000],
             [0.0926700000000000, 0.865540000000000, 0.762300000000000],
             [0.0932000000000000, 0.872110000000000, 0.752370000000000],
             [0.0945100000000000, 0.878440000000000, 0.742650000000000],
             [0.0966200000000000, 0.884540000000000, 0.733160000000000],
             [0.0995800000000000, 0.890400000000000, 0.723930000000000],
             [0.103420000000000, 0.896000000000000, 0.715000000000000],
             [0.108150000000000, 0.901420000000000, 0.705990000000000],
             [0.113740000000000, 0.906730000000000, 0.696510000000000],
             [0.120140000000000, 0.911930000000000, 0.686600000000000],
             [0.127330000000000, 0.917010000000000, 0.676270000000000],
             [0.135260000000000, 0.921970000000000, 0.665560000000000],
             [0.143910000000000, 0.926800000000000, 0.654480000000000],
             [0.153230000000000, 0.931510000000000, 0.643080000000000],
             [0.163190000000000, 0.936090000000000, 0.631370000000000],
             [0.173770000000000, 0.940530000000000, 0.619380000000000],
             [0.184910000000000, 0.944840000000000, 0.607130000000000],
             [0.196590000000000, 0.949010000000000, 0.594660000000000],
             [0.208770000000000, 0.953040000000000, 0.581990000000000],
             [0.221420000000000, 0.956920000000000, 0.569140000000000],
             [0.234490000000000, 0.960650000000000, 0.556140000000000],
             [0.247970000000000, 0.964230000000000, 0.543030000000000],
             [0.261800000000000, 0.967650000000000, 0.529810000000000],
             [0.275970000000000, 0.970920000000000, 0.516530000000000],
             [0.290420000000000, 0.974030000000000, 0.503210000000000],
             [0.305130000000000, 0.976970000000000, 0.489870000000000],
             [0.320060000000000, 0.979740000000000, 0.476540000000000],
             [0.335170000000000, 0.982340000000000, 0.463250000000000],
             [0.350430000000000, 0.984770000000000, 0.450020000000000],
             [0.365810000000000, 0.987020000000000, 0.436880000000000],
             [0.381270000000000, 0.989090000000000, 0.423860000000000],
             [0.396780000000000, 0.990980000000000, 0.410980000000000],
             [0.412290000000000, 0.992680000000000, 0.398260000000000],
             [0.427780000000000, 0.994190000000000, 0.385750000000000],
             [0.443210000000000, 0.995510000000000, 0.373450000000000],
             [0.458540000000000, 0.996630000000000, 0.361400000000000],
             [0.473750000000000, 0.997550000000000, 0.349630000000000],
             [0.488790000000000, 0.998280000000000, 0.338160000000000],
             [0.503620000000000, 0.998790000000000, 0.327010000000000],
             [0.518220000000000, 0.999100000000000, 0.316220000000000],
             [0.532550000000000, 0.999190000000000, 0.305810000000000],
             [0.546580000000000, 0.999070000000000, 0.295810000000000],
             [0.560260000000000, 0.998730000000000, 0.286230000000000],
             [0.573570000000000, 0.998170000000000, 0.277120000000000],
             [0.586460000000000, 0.997390000000000, 0.268490000000000],
             [0.598910000000000, 0.996380000000000, 0.260380000000000],
             [0.610880000000000, 0.995140000000000, 0.252800000000000],
             [0.622330000000000, 0.993660000000000, 0.245790000000000],
             [0.633230000000000, 0.991950000000000, 0.239370000000000],
             [0.643620000000000, 0.989990000000000, 0.233560000000000],
             [0.653940000000000, 0.987750000000000, 0.228350000000000],
             [0.664280000000000, 0.985240000000000, 0.223700000000000],
             [0.674620000000000, 0.982460000000000, 0.219600000000000],
             [0.684940000000000, 0.979410000000000, 0.216020000000000],
             [0.695250000000000, 0.976100000000000, 0.212940000000000],
             [0.705530000000000, 0.972550000000000, 0.210320000000000],
             [0.715770000000000, 0.968750000000000, 0.208150000000000],
             [0.725960000000000, 0.964700000000000, 0.206400000000000],
             [0.736100000000000, 0.960430000000000, 0.205040000000000],
             [0.746170000000000, 0.955930000000000, 0.204060000000000],
             [0.756170000000000, 0.951210000000000, 0.203430000000000],
             [0.766080000000000, 0.946270000000000, 0.203110000000000],
             [0.775910000000000, 0.941130000000000, 0.203100000000000],
             [0.785630000000000, 0.935790000000000, 0.203360000000000],
             [0.795240000000000, 0.930250000000000, 0.203860000000000],
             [0.804730000000000, 0.924520000000000, 0.204590000000000],
             [0.814100000000000, 0.918610000000000, 0.205520000000000],
             [0.823330000000000, 0.912530000000000, 0.206630000000000],
             [0.832410000000000, 0.906270000000000, 0.207880000000000],
             [0.841330000000000, 0.899860000000000, 0.209260000000000],
             [0.850100000000000, 0.893280000000000, 0.210740000000000],
             [0.858680000000000, 0.886550000000000, 0.212300000000000],
             [0.867090000000000, 0.879680000000000, 0.213910000000000],
             [0.875300000000000, 0.872670000000000, 0.215550000000000],
             [0.883310000000000, 0.865530000000000, 0.217190000000000],
             [0.891120000000000, 0.858260000000000, 0.218800000000000],
             [0.898700000000000, 0.850870000000000, 0.220380000000000],
             [0.906050000000000, 0.843370000000000, 0.221880000000000],
             [0.913170000000000, 0.835760000000000, 0.223280000000000],
             [0.920040000000000, 0.828060000000000, 0.224560000000000],
             [0.926660000000000, 0.820250000000000, 0.225700000000000],
             [0.933010000000000, 0.812360000000000, 0.226670000000000],
             [0.939090000000000, 0.804390000000000, 0.227440000000000],
             [0.944890000000000, 0.796340000000000, 0.228000000000000],
             [0.950390000000000, 0.788230000000000, 0.228310000000000],
             [0.955600000000000, 0.780050000000000, 0.228360000000000],
             [0.960490000000000, 0.771810000000000, 0.228110000000000],
             [0.965070000000000, 0.763520000000000, 0.227540000000000],
             [0.969310000000000, 0.755190000000000, 0.226630000000000],
             [0.973230000000000, 0.746820000000000, 0.225360000000000],
             [0.976790000000000, 0.738420000000000, 0.223690000000000],
             [0.980000000000000, 0.730000000000000, 0.221610000000000],
             [0.982890000000000, 0.721400000000000, 0.219180000000000],
             [0.985490000000000, 0.712500000000000, 0.216500000000000],
             [0.987810000000000, 0.703300000000000, 0.213580000000000],
             [0.989860000000000, 0.693820000000000, 0.210430000000000],
             [0.991630000000000, 0.684080000000000, 0.207060000000000],
             [0.993140000000000, 0.674080000000000, 0.203480000000000],
             [0.994380000000000, 0.663860000000000, 0.199710000000000],
             [0.995350000000000, 0.653410000000000, 0.195770000000000],
             [0.996070000000000, 0.642770000000000, 0.191650000000000],
             [0.996540000000000, 0.631930000000000, 0.187380000000000],
             [0.996750000000000, 0.620930000000000, 0.182970000000000],
             [0.996720000000000, 0.609770000000000, 0.178420000000000],
             [0.996440000000000, 0.598460000000000, 0.173760000000000],
             [0.995930000000000, 0.587030000000000, 0.168990000000000],
             [0.995170000000000, 0.575490000000000, 0.164120000000000],
             [0.994190000000000, 0.563860000000000, 0.159180000000000],
             [0.992970000000000, 0.552140000000000, 0.154170000000000],
             [0.991530000000000, 0.540360000000000, 0.149100000000000],
             [0.989870000000000, 0.528540000000000, 0.143980000000000],
             [0.987990000000000, 0.516670000000000, 0.138830000000000],
             [0.985900000000000, 0.504790000000000, 0.133670000000000],
             [0.983600000000000, 0.492910000000000, 0.128490000000000],
             [0.981080000000000, 0.481040000000000, 0.123320000000000],
             [0.978370000000000, 0.469200000000000, 0.118170000000000],
             [0.975450000000000, 0.457400000000000, 0.113050000000000],
             [0.972340000000000, 0.445650000000000, 0.107970000000000],
             [0.969040000000000, 0.433990000000000, 0.102940000000000],
             [0.965550000000000, 0.422410000000000, 0.0979800000000000],
             [0.961870000000000, 0.410930000000000, 0.0931000000000000],
             [0.958010000000000, 0.399580000000000, 0.0883100000000000],
             [0.953980000000000, 0.388360000000000, 0.0836200000000000],
             [0.949770000000000, 0.377290000000000, 0.0790500000000000],
             [0.945380000000000, 0.366380000000000, 0.0746100000000000],
             [0.940840000000000, 0.355660000000000, 0.0703100000000000],
             [0.936120000000000, 0.345130000000000, 0.0661600000000000],
             [0.931250000000000, 0.334820000000000, 0.0621800000000000],
             [0.926230000000000, 0.324730000000000, 0.0583700000000000],
             [0.921050000000000, 0.314890000000000, 0.0547500000000000],
             [0.915720000000000, 0.305300000000000, 0.0513400000000000],
             [0.910240000000000, 0.295990000000000, 0.0481400000000000],
             [0.904630000000000, 0.286960000000000, 0.0451600000000000],
             [0.898880000000000, 0.278240000000000, 0.0424300000000000],
             [0.892980000000000, 0.269810000000000, 0.0399300000000000],
             [0.886910000000000, 0.261520000000000, 0.0375300000000000],
             [0.880660000000000, 0.253340000000000, 0.0352100000000000],
             [0.874220000000000, 0.245260000000000, 0.0329700000000000],
             [0.867600000000000, 0.237300000000000, 0.0308200000000000],
             [0.860790000000000, 0.229450000000000, 0.0287500000000000],
             [0.853800000000000, 0.221700000000000, 0.0267700000000000],
             [0.846620000000000, 0.214070000000000, 0.0248700000000000],
             [0.839260000000000, 0.206540000000000, 0.0230500000000000],
             [0.831720000000000, 0.199120000000000, 0.0213100000000000],
             [0.823990000000000, 0.191820000000000, 0.0196600000000000],
             [0.816080000000000, 0.184620000000000, 0.0180900000000000],
             [0.807990000000000, 0.177530000000000, 0.0166000000000000],
             [0.799710000000000, 0.170550000000000, 0.0152000000000000],
             [0.791250000000000, 0.163680000000000, 0.0138700000000000],
             [0.782600000000000, 0.156930000000000, 0.0126400000000000],
             [0.773770000000000, 0.150280000000000, 0.0114800000000000],
             [0.764760000000000, 0.143740000000000, 0.0104100000000000],
             [0.755560000000000, 0.137310000000000, 0.00942000000000000],
             [0.746170000000000, 0.130980000000000, 0.00851000000000000],
             [0.736610000000000, 0.124770000000000, 0.00769000000000000],
             [0.726860000000000, 0.118670000000000, 0.00695000000000000],
             [0.716920000000000, 0.112680000000000, 0.00629000000000000],
             [0.706800000000000, 0.106800000000000, 0.00571000000000000],
             [0.696500000000000, 0.101020000000000, 0.00522000000000000],
             [0.686020000000000, 0.0953600000000000, 0.00481000000000000],
             [0.675350000000000, 0.0898000000000000, 0.00449000000000000],
             [0.664490000000000, 0.0843600000000000, 0.00424000000000000],
             [0.653450000000000, 0.0790200000000000, 0.00408000000000000],
             [0.642230000000000, 0.0738000000000000, 0.00401000000000000],
             [0.630820000000000, 0.0686800000000000, 0.00401000000000000],
             [0.619230000000000, 0.0636700000000000, 0.00410000000000000],
             [0.607460000000000, 0.0587800000000000, 0.00427000000000000],
             [0.595500000000000, 0.0539900000000000, 0.00453000000000000],
             [0.583360000000000, 0.0493100000000000, 0.00486000000000000],
             [0.571030000000000, 0.0447400000000000, 0.00529000000000000],
             [0.558520000000000, 0.0402800000000000, 0.00579000000000000],
             [0.545830000000000, 0.0359300000000000, 0.00638000000000000],
             [0.532950000000000, 0.0316900000000000, 0.00705000000000000],
             [0.519890000000000, 0.0275600000000000, 0.00780000000000000],
             [0.506640000000000, 0.0235400000000000, 0.00863000000000000],
             [0.493210000000000, 0.0196300000000000, 0.00955000000000000],
             [0.479600000000000, 0.0158300000000000, 0.0105500000000000]]

