stages:
#    - test
    - test
    - build
#    - load

#tox:
#    stage: test
#    script:
#        - tox -p all
#    artifacts:
#        paths:
#        - .tox/py39-numpy121/log
#        when: always
#        expire_in: 4 week

example:
    image: debian:latest
    before_script:
        - apt update
        - apt --assume-yes install libsuitesparse-dev
        - apt --assume-yes install pkg-config
        - apt update
        - apt --assume-yes install libhdf5-dev
        - apt --assume-yes install python3
        - apt --assume-yes install python3-pip
        - apt --assume-yes install python3-venv
        - apt --assume-yes install git
    stage: test
    script:
        - python3 -m venv gwalk
        - source gwalk/bin/activate; python3 -m pip install tox pytest pytest-cov build numpy setuptools h5py
        - source gwalk/bin/activate; make unit_tests
    only:
        - master
        - merge_requests
    artifacts:
        paths:
        - ./example_out.txt
    after_script:
        - echo "All CI tasks run"

#aligned3d_source:
#    stage: load
#    script:
#        - python3 ./tests/test_aligned3d_source.py | tee ./aligned3d_source_best_fits.txt
#    only:
#        - master
#        - merge_requests
#    artifacts:
#        paths:
#        - ./aligned3d_source_best_fits.txt
#

linux:
    image: python:3.12
    stage: build
    services:
      - name: docker:dind
        entrypoint: ["env", "-u", "DOCKER_HOST"]
        command: ["dockerd-entrypoint.sh"]
    variables:
      DOCKER_HOST: tcp://docker:2375/
      DOCKER_DRIVER: overlay2
      # Disable TLS for simplicity in the CI environment
      DOCKER_TLS_CERTDIR: ""
    script:
      # Install cibuildwheel
      - curl -sSL https://get.docker.com/ | sh
      - python3 -m pip install -U pip
      - python -m pip install cibuildwheel
      # Run cibuildwheel to build wheels
      - cibuildwheel --output-dir wheelhouse
    artifacts:
      paths:
        - wheelhouse/

macos:
    image: macos-14-xcode-15
    stage: build
    before_script:
      - python3 -m pip install cibuildwheel==3.3.1
    script:
      - python3 -m cibuildwheel --outputdir wheelhouse
    artifacts:
      paths:
        - wheelhouse
    tags:
      -  saas-macos-large-m2pro 
