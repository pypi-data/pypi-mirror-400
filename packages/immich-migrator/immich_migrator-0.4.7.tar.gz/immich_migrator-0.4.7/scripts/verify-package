#!/usr/bin/env bash
# Verify package contents and structure
# Usage: ./scripts/verify-package

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

cd "${PROJECT_ROOT}"

if [[ ! -d "dist" ]]; then
    echo "‚ùå ERROR: dist/ directory not found. Run ./scripts/build first."
    exit 1
fi

echo "üîç Verifying wheel contents..."
wheel_files=$(unzip -l dist/*.whl 2>/dev/null || true)
if ! echo "$wheel_files" | grep -q 'py.typed'; then
    echo "‚ùå ERROR: Missing py.typed in wheel"
    exit 1
fi
if ! echo "$wheel_files" | grep -q 'METADATA'; then
    echo "‚ùå ERROR: Missing METADATA in wheel"
    exit 1
fi
if ! echo "$wheel_files" | grep -q 'LICENSE'; then
    echo "‚ùå ERROR: Missing LICENSE in wheel"
    exit 1
fi

echo "üîç Verifying sdist contents..."
sdist_files=$(tar -tzf dist/*.tar.gz 2>/dev/null || true)
if ! echo "$sdist_files" | grep -q 'py.typed'; then
    echo "‚ùå ERROR: Missing py.typed in sdist"
    exit 1
fi
if ! echo "$sdist_files" | grep -q 'README.md'; then
    echo "‚ùå ERROR: Missing README.md in sdist"
    exit 1
fi
if ! echo "$sdist_files" | grep -q 'LICENSE'; then
    echo "‚ùå ERROR: Missing LICENSE in sdist"
    exit 1
fi
if ! echo "$sdist_files" | grep -q 'tests/'; then
    echo "‚ùå ERROR: Missing tests/ directory in sdist"
    exit 1
fi

echo "‚úÖ Package contents verified"

echo ""
echo "üì¶ Package summary:"
echo "  Wheel: $(ls -lh dist/*.whl | awk '{print $9, "(" $5 ")"}')"
echo "  Sdist: $(ls -lh dist/*.tar.gz | awk '{print $9, "(" $5 ")"}')"
