# Dockerfile
# Generated by container-magic: https://github.com/markhedleyjones/container-magic
# Source config: cm.yaml or container-magic.yaml
# Install: pip install container-magic
# Update: cm update

{% for stage in stages %}
{% if not loop.first %}

{% endif %}
################################################################################
# Stage: {{ stage.name }}
################################################################################
FROM {{ stage.from }} AS {{ stage.name }}
{% if stage.needs_user_args %}

# User configuration
ARG USER_GID={{ stage.user_gid }} \
    USER_UID={{ stage.user_uid }} \
    USER_NAME={{ stage.user }} \
    USER_HOME={{ stage.user_home }}
{% endif %}
{% if loop.first %}

# Setup workspace (only in base stage, inherited by others)
ARG WORKSPACE_NAME={{ workspace_name }}
ARG USER_HOME={{ stage.user_home }}
ENV WORKDIR=${USER_HOME}
ENV WORKSPACE=${USER_HOME}/${WORKSPACE_NAME}
WORKDIR ${USER_HOME}
{% endif %}
{% if stage.env_vars %}

# Environment variables
{% for key, value in stage.env_vars.items() %}
ENV {{ key }}={{ value }}
{% endfor %}
{% endif %}
{% for step in stage.ordered_steps %}
{% if step.type == "system_packages" %}
# Install system packages
{% if stage.apt_packages %}
{% if stage.package_manager == "apt" %}
RUN apt-get update && \
    apt-get install --yes --no-install-recommends{% for package in stage.apt_packages %} \
        {{ package }}{% endfor %} && \
    rm -rf /var/lib/apt/lists/*
{% elif stage.package_manager == "apk" %}
RUN apk add --no-cache{% for package in stage.apt_packages %} \
        {{ package }}{% endfor %}

{% elif stage.package_manager == "dnf" %}
RUN dnf install -y{% for package in stage.apt_packages %} \
        {{ package }}{% endfor %} && \
    dnf clean all

{% endif %}
{% endif %}
{% elif step.type == "pip_packages" %}
# Install Python pip packages
{% if stage.pip_packages %}
RUN pip install --no-cache-dir{% for package in stage.pip_packages %} \
        {{ package }}{% endfor %}

{% endif %}
{% elif step.type == "create_user" %}
# Create user account (handles renaming if UID exists with different name)
{% if stage.user_creation_style == "alpine" %}
RUN if [ "${USER_NAME}" != "root" ]; then \
        # Check if the user already exists with exact match (name + uid + gid)
        if getent passwd "${USER_UID}" | grep -q "^${USER_NAME}:"; then \
            echo "User ${USER_NAME} with UID ${USER_UID} already exists, skipping creation"; \
        else \
            # Check if UID exists with a different name
            EXISTING_USER=$(getent passwd "${USER_UID}" | cut -d: -f1 || echo ""); \
            if [ -n "${EXISTING_USER}" ] && [ "${EXISTING_USER}" != "${USER_NAME}" ]; then \
                # Rename the existing user to our desired name
                echo "Renaming user ${EXISTING_USER} to ${USER_NAME}"; \
                deluser "${EXISTING_USER}"; \
                addgroup -g ${USER_GID} ${USER_NAME} 2>/dev/null || true; \
                adduser -D -u ${USER_UID} -G ${USER_GID} -h ${USER_HOME} ${USER_NAME}; \
            else \
                # Create new user
                if ! getent group ${USER_GID} >/dev/null 2>&1; then \
                    addgroup -g ${USER_GID} ${USER_NAME}; \
                fi && \
                adduser -D -u ${USER_UID} -G ${USER_GID} -h ${USER_HOME} ${USER_NAME}; \
            fi \
        fi \
    fi
{% else %}
RUN if [ "${USER_NAME}" != "root" ]; then \
        # Check if the user already exists with exact match (name + uid + gid)
        if getent passwd "${USER_UID}" | grep -q "^${USER_NAME}:"; then \
            echo "User ${USER_NAME} with UID ${USER_UID} already exists, skipping creation"; \
        else \
            # Check if UID exists with a different name
            EXISTING_USER=$(getent passwd "${USER_UID}" | cut -d: -f1 || echo ""); \
            if [ -n "${EXISTING_USER}" ] && [ "${EXISTING_USER}" != "${USER_NAME}" ]; then \
                # Rename the existing user to our desired name
                echo "Renaming user ${EXISTING_USER} to ${USER_NAME}"; \
                usermod -l ${USER_NAME} ${EXISTING_USER} && \
                usermod -d ${USER_HOME} -m ${USER_NAME} || true; \
            else \
                # Create new user
                if ! getent group ${USER_GID} >/dev/null 2>&1; then \
                    groupadd --gid ${USER_GID} ${USER_NAME}; \
                fi && \
                useradd --uid ${USER_UID} --gid ${USER_GID} --home-dir ${USER_HOME} --create-home ${USER_NAME}; \
            fi \
        fi \
    fi
{% endif %}
{% elif step.type == "switch_user" %}
# Switch to user
USER ${USER_NAME}
{% elif step.type == "switch_root" %}
# Switch to root
USER root
{% elif step.type == "cached_assets" %}
# Copy cached assets
{% for asset in stage.cached_assets %}
{% if stage.needs_user_args %}
COPY --chown=${USER_UID}:${USER_GID} {{ asset.source }} {{ asset.dest }}
{% else %}
COPY {{ asset.source }} {{ asset.dest }}
{% endif %}
{% endfor %}
{% elif step.type == "copy_workspace" %}
# Copy workspace into image
{% if stage.needs_user_args %}
COPY --chown=${USER_UID}:${USER_GID} {{ workspace_name }} ${WORKSPACE}
{% else %}
COPY {{ workspace_name }} ${WORKSPACE}
{% endif %}
{% elif step.type == "custom" %}
{% if step.command.startswith('COPY ') or step.command.startswith('ADD ') or step.command.startswith('ENV ') or step.command.startswith('WORKDIR ') or step.command.startswith('USER ') or step.command.startswith('LABEL ') or step.command.startswith('EXPOSE ') or step.command.startswith('VOLUME ') or step.command.startswith('RUN ') %}
{{ step.command }}
{% else %}
RUN {{ step.command }}
{% endif %}
{% endif %}
{% endfor %}
{% endfor %}
