name: Validate Version
description: Validates that the git tag version matches the version in code

inputs:
  tag-prefix:
    description: 'Prefix to strip from the tag (e.g., "client-v" or "service-v")'
    required: true
  version-file:
    description: 'Path to the file containing __version__ (e.g., "pylon_client/__init__.py")'
    required: true

outputs:
  version:
    description: 'The extracted version from the tag'
    value: ${{ steps.extract.outputs.VERSION }}

runs:
  using: composite
  steps:
    - name: Extract version from tag
      id: extract
      shell: bash
      run: |
        TAG="${GITHUB_REF#refs/tags/}"
        VERSION="${TAG#${{ inputs.tag-prefix }}}"
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Get version from code
      id: code_version
      shell: bash
      run: |
        CODE_VERSION=$(sed -n 's/^__version__ = "\(.*\)"/\1/p' ${{ inputs.version-file }})
        echo "CODE_VERSION=$CODE_VERSION" >> $GITHUB_OUTPUT
        echo "Version in ${{ inputs.version-file }}: $CODE_VERSION"

    - name: Validate version match
      shell: bash
      run: |
        TAG_VERSION="${{ steps.extract.outputs.VERSION }}"
        CODE_VERSION="${{ steps.code_version.outputs.CODE_VERSION }}"

        if [ "$TAG_VERSION" != "$CODE_VERSION" ]; then
          echo "::error::Version mismatch! Tag version ($TAG_VERSION) does not match code version ($CODE_VERSION)"
          echo "Please update ${{ inputs.version-file }} to match the tag version."
          exit 1
        fi

        echo "Version validation passed: $TAG_VERSION"
