import{p as ot,F as jt,g as t,m as g,e as i,v as lt,l as Y,H as Et,b as zt,i as nt,f as k,k as x,n as m,w as T,C as tt,h as M,t as w,G as it,r as f,Q as Tt,c as dt,J as Z,N as q,I as et,Y as Ot,M as St,O as At,U as rt,X as at,S as st}from"../chunks/tJ-1PvYF.js";import{_ as Dt}from"../chunks/PPVm8Dsz.js";import{B as Lt}from"../chunks/DZ5Aek4G.js";import{D as Rt}from"../chunks/BRt1D930.js";import{w as ct,f as Ct}from"../chunks/DAWgyOON.js";import{P as Zt}from"../chunks/Ba3EtZVA.js";var qt=k('<div class="text-sm text-blue-600"> </div>'),Nt=k('<div class="text-sm text-red-600 mb-3"> </div>'),Gt=k("<span>Saving...</span>"),Jt=k("<span>Save Perm Transforms</span>"),Ut=k("<div> </div>"),Wt=k('<tr><td class="border border-border p-2"> </td><td class="border border-border p-2"><input type="number" step="0.01" class="w-full px-2 py-1 border border-border rounded"/></td><td class="border border-border p-2"><input type="number" step="0.01" class="w-full px-2 py-1 border border-border rounded"/></td></tr>'),Bt=k('<div class="font-semibold mb-2">Fitted Parameters</div> <div class="text-sm text-muted-foreground mb-3">Edit a and b parameters to update the fitted curves.</div> <div class="bg-surface rounded p-3"><table class="w-full border-collapse border border-border"><thead><tr class="bg-muted"><th class="border border-border p-2 text-left">Rock Flag</th><th class="border border-border p-2 text-left">a</th><th class="border border-border p-2 text-left">b</th></tr></thead><tbody></tbody></table></div>',1),Mt=k('<div class="ws-perm-transform"><div class="mb-2"><div class="font-semibold">Permeability Transform</div> <div class="text-sm text-muted-foreground">Fit poro-perm curves per ROCK_FLAG and calculate transformed permeability.</div></div> <!> <div class="bg-panel rounded p-3 mb-3"><!> <div class="flex-1"><div class="flex gap-2 items-end"><!></div> <!> <!></div> <div class="font-semibold mb-2">Poro-Perm Crossplot with Fitted Curves</div> <div class="text-sm text-muted-foreground mb-3">Plot porosity vs permeability with fitted curves per ROCK_FLAG.</div> <div class="bg-surface rounded p-3 min-h-[400px]"><div class="w-full h-[500px] mx-auto"></div></div></div></div>');function Kt(N,O){ot(O,!1);let v=jt(O,"projectId",8,null),I=g(!1),_=g(null),S=g(!1),P=g(null),c=g(null),n=g(null),$=g({enabled:!1,zones:[]}),G=g(null),j=null,E=0,pt=120,F=g(null);const ut=1e3,ft=ct.subscribe(e=>{e?.zoneFilter&&(t($).enabled!==e.zoneFilter.enabled||JSON.stringify(t($).zones)!==JSON.stringify(e.zoneFilter.zones))&&i($,{...e.zoneFilter})});lt(()=>{ft(),j&&clearInterval(j)});function z(){j&&(clearInterval(j),j=null),i(F,null)}function mt(){if(!t(c))return null;const e=t(c).phit.map((a,o)=>({phit:a,perm:t(c).perm[o],zone:t(c).zones[o],well_name:t(c).well_names[o],depth:t(c).depths[o],rock_flag:t(c).rock_flags[o]})),r=Ct(e,t($));return console.log("Applying zone filter:",e.length,t($),r.length),{phit:r.map(a=>a.phit),perm:r.map(a=>a.perm),zones:r.map(a=>a.zone),well_names:r.map(a=>a.well_name),depths:r.map(a=>a.depth),rock_flags:r.map(a=>a.rock_flag)}}let A=null,D=g(null);const L="http://localhost:6312";async function vt(){if(A)return A;const e=await Dt(()=>import("../chunks/BJMC0GYJ.js").then(r=>r.p),[],import.meta.url);return A=e.default||e,A}async function bt(){if(v()){i(S,!0),i(P,null),z();try{i(F,"Initiating FZI data generation...");const e=await _t(),{task_id:r,result:a}=e;let o;if(a?o=a:(i(F,"Waiting for FZI data..."),o=await ht(r)),!o||typeof o!="object")throw new Error("Unexpected data format from backend");i(c,o),console.log("Loaded data:",t(c));const p=`${L}/quick_pp/database/projects/${v()}/poroperm_fits`,s=await fetch(p);if(!s.ok)throw new Error(await s.text());const l=await s.json();i(n,l.fits),console.log("Loaded fits:",t(n))}catch(e){i(P,e.message||"Failed to load data"),i(c,null),i(n,null)}finally{i(S,!1),i(F,null),z()}}}async function _t(){const e=await fetch(`${L}/quick_pp/database/projects/${v()}/fzi_data/generate`,{method:"POST"});if(!e.ok)throw new Error(await e.text());const r=await e.json();if(!r.task_id)throw new Error("No task_id returned from server");return{task_id:r.task_id,result:r.result}}async function ht(e){const r=`${L}/quick_pp/database/projects/${v()}/fzi_data/result/${e}`;return new Promise((a,o)=>{E=0;const p=async()=>{if(E>=pt){const s="FZI generation timed out after 2 minutes";console.error(s),z(),o(new Error(s));return}try{const s=await fetch(r);if(!s.ok)throw new Error(`Poll failed with status ${s.status}`);const l=await s.json();l.status==="success"?(z(),a(l.result)):l.status==="error"?(z(),o(new Error(l.error||"Task failed with unknown error"))):l.status==="pending"?(i(F,`Loading FZI data... (${E}s)`),E++):(z(),o(new Error(`Unknown task status: ${l.status}`)))}catch(s){console.error("Poll request failed:",s),i(F,`Retrying... (attempt ${E})`),E++}};p(),j=window.setInterval(p,ut)})}function gt(){const e=mt();if(!e||!t(D)||!t(n))return;const{phit:r,perm:a,rock_flags:o}=e,p=new Array,s={};o.forEach((d,b)=>{if(d===null)return;const y=d.toFixed(1);s[y]||(s[y]={phit:[],perm:[]}),s[y].phit.push(r[b]),s[y].perm.push(a[b])});const l=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"];Object.keys(s).sort((d,b)=>parseInt(d)-parseInt(b)).forEach(d=>{const b=s[d];p.push({x:b.phit,y:b.perm,mode:"markers",type:"scatter",name:`Rock Flag ${d}`,marker:{color:l[(parseInt(d)-1)%l.length],size:4,symbol:"circle"}})});const u=new Array;for(let d=0;d<=50;d++)u.push(d*.01);Object.keys(t(n)||{}).forEach(d=>{const{a:b,b:y}=t(n)[d],R=u.map(C=>b*Math.pow(C,y));p.push({x:u,y:R,mode:"lines",type:"scatter",name:`Fit RF ${d} (a=${b.toFixed(2)}, b=${y.toFixed(2)})`,line:{dash:"solid",color:l[(parseInt(d)-1)%l.length]}})});const h={title:"Poro-Perm Crossplot with Fitted Curves",xaxis:{title:"Porosity (fraction)",range:[-.05,.5],autorange:!1},yaxis:{title:"Permeability (mD)",type:"log",autorange:!0},showlegend:!0,margin:{l:60,r:60,t:60,b:60}};vt().then(d=>{d.newPlot(t(D),p,h,{responsive:!0})})}async function wt(){if(!(!t(c)||!t(n)||!v())){i(I,!0),i(_,null);try{const e=t(c).phit.map((p,s)=>{const l=t(c).rock_flags[s];let u=null;if(l!==null&&t(n)&&t(n)[l.toFixed(1)]){const{a:h,b:d}=t(n)[l.toFixed(1)];u=h*Math.pow(p,d)}return{well_name:t(c).well_names[s],depth:t(c).depths[s],perm_trans:u}}),r=`${L}/quick_pp/database/projects/${v()}/save_perm_trans`,a=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({perm_trans_pairs:e})});if(!a.ok)throw new Error(await a.text());const o=await a.json();i(_,`Success: ${o.message}`)}catch(e){i(_,`Error: ${e.message}`)}finally{i(I,!1)}}}Y(()=>(Et(v()),t(G)),()=>{v()&&v()!==t(G)&&(i(G,v()),bt())}),Y(()=>(t(c),t(n),t($)),()=>{t(c)&&t(n)&&t($)&&gt()}),zt(),nt();var J=Mt(),K=x(m(J),2);Rt(K,{});var V=x(K,2),H=m(V);{var yt=e=>{var r=qt(),a=m(r,!0);f(r),Z(()=>q(a,t(F)?t(F):"Loading data...")),w(e,r)},xt=e=>{var r=tt(),a=M(r);{var o=p=>{var s=Nt(),l=m(s,!0);f(s),Z(()=>q(l,t(P))),w(p,s)};T(a,p=>{t(P)&&p(o)},!0)}w(e,r)};T(H,e=>{t(S)?e(yt):e(xt,!1)})}var U=x(H,2),W=m(U),kt=m(W);{let e=it(()=>t(I)||!t(c));Lt(kt,{onclick:wt,get disabled(){return t(e)},children:(r,a)=>{var o=tt(),p=M(o);{var s=u=>{var h=Gt();w(u,h)},l=u=>{var h=Jt();w(u,h)};T(p,u=>{t(I)?u(s):u(l,!1)})}w(r,o)},$$slots:{default:!0}})}f(W);var Q=x(W,2);{var Pt=e=>{var r=Ut(),a=m(r,!0);f(r),Z(o=>{Ot(r,1,`text-sm ${o??""}`),q(a,t(_))},[()=>(t(_),et(()=>t(_).startsWith("Error")?"text-red-600":"text-green-600"))]),w(e,r)};T(Q,e=>{t(_)&&e(Pt)})}var Ft=x(Q,2);{var $t=e=>{var r=Bt(),a=x(M(r),4),o=m(a),p=x(m(o));St(p,5,()=>(t(n),et(()=>Object.keys(t(n)).sort((s,l)=>parseInt(s)-parseInt(l)))),At,(s,l)=>{var u=Wt(),h=m(u),d=m(h,!0);f(h);var b=x(h),y=m(b);rt(y),f(b);var R=x(b),C=m(R);rt(C),f(R),f(u),Z(()=>q(d,t(l))),at(y,()=>t(n)[t(l)].a,B=>st(n,t(n)[t(l)].a=B)),at(C,()=>t(n)[t(l)].b,B=>st(n,t(n)[t(l)].b=B)),w(s,u)}),f(p),f(o),f(a),w(e,r)};T(Ft,e=>{t(n)&&e($t)})}f(U);var X=x(U,6),It=m(X);Tt(It,e=>i(D,e),()=>t(D)),f(X),f(V),f(J),w(N,J),dt()}var Vt=k('<div slot="left"><!></div>');function re(N,O){ot(O,!1);let v=g(null);const I=ct.subscribe(_=>{i(v,_?.project??null)});lt(()=>I()),nt(),Zt(N,{get project(){return t(v)},$$slots:{left:(_,S)=>{var P=Vt(),c=m(P);{let n=it(()=>t(v)?.project_id??null);Kt(c,{get projectId(){return t(n)}})}f(P),w(_,P)}}}),dt()}export{re as component};
