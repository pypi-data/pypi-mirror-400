<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AIChat 管理后台</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 p-6 text-slate-700">
    <div id="app" class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-6 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-2xl font-bold text-indigo-600">AIChat 管理</h1>
                <p class="text-slate-400 text-sm">全参数调节：包含触发\API、模板与记忆</p>
            </div>
            <button @click="save" class="bg-indigo-600 text-white px-8 py-2 rounded-xl hover:bg-indigo-700 transition-all font-bold shadow-lg shadow-indigo-100">保存</button>
        </header>

        <div class="flex gap-6">
            <nav class="w-64 space-y-2 font-medium">
                <button @click="tab='prompt'" :class="tab==='prompt'?'bg-indigo-600 text-white shadow-md':'bg-white text-slate-500 hover:bg-slate-100'" class="w-full text-left p-4 rounded-xl transition-all">设定与模板</button>
                <button @click="tab='model'" :class="tab==='model'?'bg-indigo-600 text-white shadow-md':'bg-white text-slate-500 hover:bg-slate-100'" class="w-full text-left p-4 rounded-xl transition-all">模型与 API</button>
                <button @click="tab='mem'" :class="tab==='mem'?'bg-indigo-600 text-white shadow-md':'bg-white text-slate-500 hover:bg-slate-100'" class="w-full text-left p-4 rounded-xl transition-all">记忆库管理</button>
                <button @click="tab='mapping'" :class="tab==='mapping'?'bg-indigo-600 text-white shadow-md':'bg-white text-slate-500 hover:bg-slate-100'" class="w-full text-left p-4 rounded-xl transition-all">角色与群组</button>
            </nav>

            <main class="flex-1 bg-white p-8 rounded-2xl shadow-sm border border-slate-200 min-h-[600px]">
                
                <div v-if="tab==='prompt'" class="space-y-6">
                    <h2 class="text-lg font-bold text-slate-800 border-l-4 border-indigo-600 pl-3">交互机制配置</h2>
                    <div class="grid grid-cols-2 gap-6 max-w-2xl">
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-bold text-slate-400 uppercase">自动回复概率 (0.0~1.0)</label>
                            <input v-model.number="data.config.reply_probability" type="number" step="0.1" class="border p-3 rounded-lg bg-slate-50 outline-none focus:bg-white focus:ring-2 focus:ring-indigo-100">
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-bold text-slate-400 uppercase">命令触发前缀 (如 # 或 /)</label>
                            <input v-model="data.config.command_prefix" class="border p-3 rounded-lg bg-slate-50 outline-none focus:bg-white focus:ring-2 focus:ring-indigo-100 font-mono" placeholder="# ">
                        </div>
                    </div>

                    <h2 class="text-lg font-bold text-slate-800 border-l-4 border-indigo-600 pl-3 pt-4">角色设定 (System Prompt)</h2>
                    <textarea v-model="data.config.system_prompt" class="w-full h-48 border p-4 rounded-xl bg-slate-50 text-sm leading-relaxed outline-none focus:bg-white focus:ring-2 focus:ring-indigo-100 font-mono"></textarea>
                    
                    <h2 class="text-lg font-bold text-slate-800 border-l-4 border-indigo-600 pl-3 pt-4">消息模板 (Templates)</h2>
                    <div class="space-y-4">
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-bold text-slate-400 uppercase">说话人记忆模板 ({nickname}, {memory_content})</label>
                            <input v-model="data.config.speaker_memory_template" class="border p-3 rounded-lg bg-slate-50 text-sm outline-none focus:bg-white focus:ring-2 focus:ring-indigo-100">
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-bold text-slate-400 uppercase">回复前缀模板 ({nickname}, {groupname})</label>
                            <input v-model="data.config.reply_prefix_template" class="border p-3 rounded-lg bg-slate-50 text-sm outline-none focus:bg-white focus:ring-2 focus:ring-indigo-100">
                        </div>
                    </div>
                </div>

                <div v-if="tab==='model'" class="space-y-6">
                    <h2 class="text-lg font-bold text-slate-800 border-l-4 border-indigo-600 pl-3">API 访问配置</h2>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-bold text-slate-400 uppercase">API 端点 (URL)</label>
                            <input v-model="data.config.api_url" class="border p-3 rounded-lg bg-slate-50 text-sm outline-none">
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-bold text-slate-400 uppercase">API 密钥 (Key)</label>
                            <input v-model="data.config.api_key" type="password" class="border p-3 rounded-lg bg-slate-50 text-sm outline-none">
                        </div>
                    </div>

                    <h2 class="text-lg font-bold text-slate-800 border-l-4 border-indigo-600 pl-3 pt-4">大模型生成参数 (Generation)</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div v-for="(v, k) in data.config.model_settings" :key="k" class="flex flex-col gap-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">{{ k }}</label>
                            <input v-model="data.config.model_settings[k]" class="border px-3 py-2 rounded-lg bg-slate-50 text-sm outline-none focus:bg-white focus:ring-2 focus:ring-indigo-100">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase font-bold text-indigo-500">上下文最大历史轮数</label>
                            <input v-model.number="data.config.max_chat_history" type="number" class="border px-3 py-2 rounded-lg bg-slate-50 text-sm outline-none focus:ring-2 focus:ring-indigo-100">
                        </div>
                    </div>
                </div>

                <div v-if="tab==='mem'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-slate-800 border-l-4 border-indigo-600 pl-3">长期记忆内容</h2>
                        <button @click="addMem" class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-100">+ 添加记忆词</button>
                    </div>
                    <div class="grid grid-cols-1 gap-4 overflow-y-auto max-h-[500px] pr-2">
                        <div v-for="(v, k) in data.memory" :key="k" class="p-4 bg-slate-50 rounded-xl border border-slate-100 relative group">
                            <button @click="del('memory', k)" class="absolute top-4 right-4 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">删除</button>
                            <div class="font-bold text-indigo-600 mb-2">{{ k }}</div>
                            <textarea v-model="data.memory[k].content" class="w-full p-3 border rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-indigo-100"></textarea>
                            <div class="mt-2 flex items-center gap-2">
                                <span class="text-[10px] text-slate-400 font-bold uppercase">权重 (Weight):</span>
                                <input v-model.number="data.memory[k].weight" type="number" step="0.1" class="w-20 border px-2 py-1 rounded text-xs">
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="tab==='mapping'" class="space-y-10 overflow-y-auto max-h-[600px] pr-2">
                    <section>
                        <h2 class="text-lg font-bold text-slate-800 border-l-4 border-indigo-600 pl-3 mb-4">角色称呼 (User ID → 称呼)</h2>
                        <div class="grid grid-cols-2 gap-3">
                            <div v-for="(v, k) in data.characters" :key="k" class="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-100 group">
                                <span class="text-[10px] font-mono text-slate-400 w-24 truncate px-2 text-center">{{ k }}</span>
                                <input v-model="data.characters[k]" class="flex-1 bg-white border rounded px-2 py-1 text-sm outline-none focus:ring-1 focus:ring-indigo-300">
                                <button @click="del('characters', k)" class="text-slate-300 hover:text-red-500 px-2 opacity-0 group-hover:opacity-100">×</button>
                            </div>
                        </div>
                        <button @click="add('characters')" class="mt-4 w-full border border-dashed border-slate-300 text-slate-400 rounded-lg py-2 hover:bg-slate-50 text-xs transition-all">+ 添加新角色映射</button>
                    </section>

                    <section>
                        <h2 class="text-lg font-bold text-slate-800 border-l-4 border-indigo-600 pl-3 mb-4">群组名称 (Group ID → 群名)</h2>
                        <div class="grid grid-cols-2 gap-3">
                            <div v-for="(v, k) in data.groups" :key="k" class="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-100 group">
                                <span class="text-[10px] font-mono text-slate-400 w-24 truncate px-2 text-center">{{ k }}</span>
                                <input v-model="data.groups[k]" class="flex-1 bg-white border rounded px-2 py-1 text-sm outline-none focus:ring-1 focus:ring-indigo-300">
                                <button @click="del('groups', k)" class="text-slate-300 hover:text-red-500 px-2 opacity-0 group-hover:opacity-100">×</button>
                            </div>
                        </div>
                        <button @click="add('groups')" class="mt-4 w-full border border-dashed border-slate-300 text-slate-400 rounded-lg py-2 hover:bg-slate-50 text-xs transition-all">+ 添加新群组映射</button>
                    </section>
                </div>

            </main>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue
        createApp({
            setup() {
                const tab = ref('prompt')
                const data = ref({ config: { model_settings: {} }, memory: {}, characters: {}, groups: {} })

                const load = async () => {
                    try {
                        const res = await fetch('/api/aichat/all_data')
                        const resData = await res.json()
                        // 确保必要的嵌套对象存在
                        if (!resData.config.model_settings) resData.config.model_settings = {}
                        // 默认值兜底，防止前端渲染报错
                        if (!resData.config.command_prefix) resData.config.command_prefix = '#'
                        if (!resData.config.energy_drop) resData.config.energy_drop = 7.5
                        
                        data.value = resData
                    } catch (e) { alert('无法加载后端数据，请检查网络或重启 Bot') }
                }

                const save = async () => {
                    const res = await fetch('/api/aichat/save', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data.value)
                    })
                    const result = await res.json()
                    if (result.status === 'success') alert('✅ 配置已保存，请手动重启机器人以生效')
                    else alert('❌ 保存失败：' + result.message)
                }

                const addMem = () => {
                    const k = prompt('输入记忆关键词 (建议是具体的名词):')
                    if(k) data.value.memory[k] = { content: "", weight: 0.9 }
                }

                const add = (type) => {
                    const k = prompt(`输入新 ID (QQ号或群号):`)
                    if(k) data.value[type][k] = ""
                }

                const del = (type, k) => {
                    if(confirm(`确定删除 ${k} 吗？`)) delete data.value[type][k]
                }

                onMounted(load)
                return { tab, data, save, addMem, add, del }
            }
        }).mount('#app')
    </script>
</body>
</html>