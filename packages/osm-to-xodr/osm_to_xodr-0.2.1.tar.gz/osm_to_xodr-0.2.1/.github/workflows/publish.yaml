name: Publish to PyPI

on:
  release:
    types: [published]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# Deny all permissions by default for security
permissions: {}

jobs:
  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    # Grant minimal permissions required for PyPI trusted publishing
    permissions:
      actions: read # Required for SBOM action to find workflow artifacts when attaching release assets
      contents: write # Required to upload release artifacts
      id-token: write # Required for trusted publishing
      attestations: write # Required for generating attestations
    environment:
      name: pypi
      url: https://pypi.org/p/osm-to-xodr

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
        with:
          version: "latest"
          enable-cache: false # avoids cache poisoning upon build and publish
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-groups

      - name: Build package
        run: uv run just build

      - name: Verify package contents
        run: uv run just verify

      - name: Generate SHA256 checksums
        run: |
          cd dist
          sha256sum ./* > SHA256SUMS
          cat SHA256SUMS

      - name: Generate SBOM
        uses: anchore/sbom-action@a930d0ac434e3182448fe678398ba5713717112a # v0.21.0
        with:
          path: ./
          artifact-name: sbom.spdx.json
          output-file: dist/sbom.spdx.json
          format: spdx-json
          upload-artifact: true
          upload-release-assets: false
          dependency-snapshot: true

      - name: Attest SBOM
        uses: actions/attest-sbom@4651f806c01d8637787e274ac3bdf724ef169f34 # v3.0.0
        with:
          subject-path: "dist/*.whl"
          sbom-path: "dist/sbom.spdx.json"

      - name: Generate build provenance attestations
        id: attest
        uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
        with:
          subject-path: "dist/*"

      - name: Publish to PyPI with trusted publishing
        run: uv publish

      - name: Capture build metadata
        id: build-meta
        run: |
          {
            echo "python_version=$(uv run python --version | cut -d' ' -f2)"
            echo "uv_version=$(uv --version | cut -d' ' -f2)"
            echo "build_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: |
            dist/*.whl
            dist/*.tar.gz
            dist/sbom.spdx.json
            dist/SHA256SUMS
            LICENSE
          generate_release_notes: false
          append_body: true
          # yamllint disable rule:line-length
          body: |

            ---

            ## üìù Release Notes

            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md) for detailed release notes.

            ---

            ### üî® Build Information
            - **Python:** ${{ steps.build-meta.outputs.python_version }}
            - **uv:** ${{ steps.build-meta.outputs.uv_version }}
            - **Built:** ${{ steps.build-meta.outputs.build_time }}
            - **Commit:** ${{ github.sha }}

            ### üîê Verification

            ![SLSA 3](https://slsa.dev/images/gh-badge-level3.svg)

            This release achieves [SLSA Build Level 3](https://slsa.dev/spec/v1.0/levels) with cryptographic attestations.

            #### Quick Verification (GitHub CLI)
            ```bash
            # Verify build provenance attestation
            gh attestation verify osm_to_xodr-*.whl --owner ${{ github.repository_owner }}

            # Verify SBOM attestation
            gh attestation verify osm_to_xodr-*.whl --owner ${{ github.repository_owner }} --sbom
            ```

            #### Manual Verification
            ```bash
            # Download checksums and wheel
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/SHA256SUMS
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/osm_to_xodr-*.whl

            # Verify integrity
            sha256sum -c SHA256SUMS
            ```

            üìú [View SLSA Provenance](${{ steps.attest.outputs.attestation-url }})
          # yamllint enable rule:line-length
