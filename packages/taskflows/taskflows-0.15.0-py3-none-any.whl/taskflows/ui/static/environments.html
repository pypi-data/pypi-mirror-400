<!DOCTYPE html>
<html>
  <head>
    <title>Taskflows - Environments</title>
    <link href="/static/main.css" rel="stylesheet">
    <link href="/static/main.css" rel="stylesheet">
    <script src="/static/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/preline@2.0.3/dist/preline.min.js"></script>
  </head>
  <body>
    <div class="" data-component="sidebar_layout" id="3">
      <div class="sticky top-0 inset-x-0 z-20 bg-white border-y border-gray-200 px-4 sm:px-6 lg:px-8 lg:hidden dark:bg-neutral-800 dark:border-neutral-700">
        <div class="flex items-center py-2">
          <button aria-controls="hs-sidebar-3" aria-expanded="false" aria-haspopup="dialog" aria-label="Toggle navigation" class="size-8 flex justify-center items-center gap-x-2 border border-gray-200 text-gray-800 hover:text-gray-500 rounded-lg focus:outline-hidden focus:text-gray-500 disabled:opacity-50 disabled:pointer-events-none dark:border-neutral-700 dark:text-neutral-200 dark:hover:text-neutral-500 dark:focus:text-neutral-500" data-hs-overlay="#hs-sidebar-3" type="button">
            <span class="sr-only">Toggle Navigation</span><svg class="shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M15 3v18"/><path d="m8 9 3 3-3 3"/></svg>
          </button>
          <ol class="ms-3 flex items-center whitespace-nowrap">
            <li aria-current="page" class="text-sm font-semibold text-gray-800 truncate dark:text-neutral-400">Environments</li>
          </ol>
        </div>
      </div>
      <div aria-label="Sidebar" class="hs-overlay [--auto-close:lg]
            hs-overlay-open:translate-x-0
            -translate-x-full transition-all duration-300 transform
            w-65 h-full
            hidden
            fixed inset-y-0 start-0 z-60
            bg-electric-blue
            lg:block lg:translate-x-0 lg:end-auto lg:bottom-0
            dark:bg-neutral-800 dark:border-neutral-700" id="hs-sidebar-3" role="dialog" tabindex="-1">
        <div class="relative flex flex-col h-full max-h-full">
          <div class="px-8 pt-4">
            <a aria-label="Taskflows" class="flex-none rounded-xl text-xl inline-block font-semibold focus:outline-hidden focus:opacity-80" href="/"><span class="text-2xl font-bold text-white">Taskflows</span></a>
          </div>
          <div class="h-full overflow-y-auto [&amp;::-webkit-scrollbar]:w-2 [&amp;::-webkit-scrollbar-thumb]:rounded-full [&amp;::-webkit-scrollbar-track]:bg-gray-100 [&amp;::-webkit-scrollbar-thumb]:bg-gray-300 dark:[&amp;::-webkit-scrollbar-track]:bg-neutral-700 dark:[&amp;::-webkit-scrollbar-thumb]:bg-neutral-500">
            <nav class="hs-accordion-group p-3 w-full flex flex-col flex-wrap" data-hs-accordion-always-open="">
              <ul class="flex flex-col space-y-1">
                <li>
                  <a class="w-full flex items-center gap-x-3.5 py-2 px-2.5 text-sm text-white rounded-lg hover:bg-white/10 focus:outline-hidden focus:bg-white/10 dark:bg-neutral-800 dark:text-neutral-400 dark:hover:text-neutral-300 dark:focus:text-neutral-300" href="/"><svg class="shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    <span>Dashboard</span>
                  </a>
                </li>
                <li>
                  <a class="w-full flex items-center gap-x-3.5 py-2 px-2.5 text-sm text-white rounded-lg hover:bg-white/10 focus:outline-hidden focus:bg-white/10 dark:bg-neutral-800 dark:text-neutral-400 dark:hover:text-neutral-300 dark:focus:text-neutral-300" href="/logs"><svg class="shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                    <span>Logs</span>
                  </a>
                </li>
                <li>
                  <a class="w-full flex items-center gap-x-3.5 py-2 px-2.5 bg-white/10 text-sm text-white rounded-lg hover:bg-white/10 focus:outline-hidden focus:bg-white/10 dark:bg-neutral-700 dark:text-white" href="/environments"><svg class="shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                    <span>Environments</span>
                  </a>
                </li>
                <li>
                  <a class="w-full flex items-center gap-x-3.5 py-2 px-2.5 text-sm text-white rounded-lg hover:bg-white/10 focus:outline-hidden focus:bg-white/10 dark:bg-neutral-800 dark:text-neutral-400 dark:hover:text-neutral-300 dark:focus:text-neutral-300" href="#"><svg class="shrink-0 mt-0.5 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="15" r="3"/><circle cx="9" cy="7" r="4"/><path d="M10 15H6a4 4 0 0 0-4 4v2"/><path d="m21.7 16.4-.9-.3"/><path d="m15.2 13.9-.9-.3"/><path d="m16.6 18.7.3-.9"/><path d="m19.1 12.2.3-.9"/><path d="m19.6 18.7-.4-1"/><path d="m16.8 12.3-.4-1"/><path d="m14.3 16.6 1-.4"/><path d="m20.7 13.8 1-.4"/></svg>
                    <span>Logout</span>
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>
      <div class="w-full pt-10 px-4 sm:px-6 md:px-8 lg:ps-72" id="3-content">
        <div class="mb-6 flex justify-between items-center">
          <div>
            <h1 class="text-3xl font-bold text-gray-800">Named Environments</h1>
            <p class="text-gray-600 mt-2">Manage reusable environment configurations</p>
          </div>
          <a class="btn btn-primary" href="/environments/create">+ Create Environment</a>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white border border-gray-300 rounded-lg overflow-hidden" id="environments-table">
            <thead class="bg-gray-100 border-b border-gray-300">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Name</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Type</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Description</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Created</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200" id="environments-tbody"></tbody>
          </table>
        </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    loadEnvironments();
});

async function loadEnvironments() {
    try {
        const token = localStorage.getItem('access_token');
        const res = await fetch('/api/environments', {
            headers: {'Authorization': 'Bearer ' + token}
        });

        if (!res.ok) throw new Error('Failed to load environments');

        const environments = await res.json();
        renderEnvironments(environments);
    } catch (err) {
        console.error('Error loading environments:', err);
        showError('Failed to load environments');
    }
}

function renderEnvironments(environments) {
    const tbody = document.getElementById('environments-tbody');
    tbody.innerHTML = '';

    if (environments.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.className = 'px-4 py-8 text-center text-gray-500';
        td.textContent = 'No environments found. Create one to get started.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
    }

    environments.forEach(env => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';

        // Name
        const tdName = document.createElement('td');
        tdName.className = 'px-4 py-3 text-sm font-medium text-gray-900';
        tdName.textContent = env.name;
        tr.appendChild(tdName);

        // Type
        const tdType = document.createElement('td');
        tdType.className = 'px-4 py-3 text-sm';
        const typeBadge = document.createElement('span');
        typeBadge.className = 'px-2 py-1 rounded-full text-xs font-semibold';
        if (env.type === 'venv') {
            typeBadge.classList.add('bg-blue-100', 'text-blue-700');
            typeBadge.textContent = 'Venv';
        } else {
            typeBadge.classList.add('bg-purple-100', 'text-purple-700');
            typeBadge.textContent = 'Docker';
        }
        tdType.appendChild(typeBadge);
        tr.appendChild(tdType);

        // Description
        const tdDesc = document.createElement('td');
        tdDesc.className = 'px-4 py-3 text-sm text-gray-700';
        tdDesc.textContent = env.description || '-';
        tr.appendChild(tdDesc);

        // Created
        const tdCreated = document.createElement('td');
        tdCreated.className = 'px-4 py-3 text-sm text-gray-700';
        tdCreated.textContent = new Date(env.created_at).toLocaleDateString();
        tr.appendChild(tdCreated);

        // Actions
        const tdActions = document.createElement('td');
        tdActions.className = 'px-4 py-3 text-sm space-x-2';

        const editBtn = document.createElement('a');
        editBtn.href = `/environments/edit?name=${encodeURIComponent(env.name)}`;
        editBtn.textContent = 'Edit';
        editBtn.className = 'btn btn-primary text-xs px-3 py-1';
        tdActions.appendChild(editBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.className = 'btn btn-danger text-xs px-3 py-1';
        deleteBtn.onclick = () => deleteEnvironment(env.name);
        tdActions.appendChild(deleteBtn);

        tr.appendChild(tdActions);

        tbody.appendChild(tr);
    });
}

async function deleteEnvironment(name) {
    const confirmed = await confirm(
        `Are you sure you want to delete environment "${name}"?`,
        'Delete',
        'Cancel'
    );
    if (!confirmed) return;

    try {
        const token = localStorage.getItem('access_token');
        const res = await fetch(`/api/environments/${encodeURIComponent(name)}`, {
            method: 'DELETE',
            headers: {'Authorization': 'Bearer ' + token}
        });

        if (!res.ok) {
            const error = await res.json();
            throw new Error(error.detail || 'Failed to delete environment');
        }

        showSuccess('Environment deleted successfully');
        loadEnvironments();
    } catch (err) {
        console.error('Error deleting environment:', err);
        showError('Failed to delete environment: ' + err.message);
    }
}
</script>

      </div>
    </div>
  </body>
</html>