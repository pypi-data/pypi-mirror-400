import{c as X,j as e,ai as W,p as C,S as ce,f as oe,h as de,i as he,k as N,a8 as Fe,a7 as ss,r as l,am as as,an as ls,b as h,x as ue,ao as ts,I as xe,aw as De,z as ge,g as b,ax as Te,d as ns,e as rs,ay as is,F as cs,u as me,av as os,C as Me,Z as Oe,_ as qe,$ as F,ac as w,Q as ds,az as hs,q as Le,T as ms,U as us,V as xs,a0 as gs,W as fs,aA as ps,t as G,X as js,s as R,aB as vs,E as ys,aC as Ns}from"./index-D87ilqMg.js";import{S as Ke,a as A,b as _e,f as ws,s as Ss,d as Cs,L as ze,F as bs,c as Is,P as U}from"./useLocalStorage-DEoeC3Vt.js";import{I as ks}from"./ImageDetailDialog-QqQfbpJL.js";import{a as Ps}from"./library-CemcgxM6.js";import{I as Fs}from"./info-CbHhWaqt.js";import{F as Ae}from"./folder-plus-BRARusOr.js";import{S as Ds}from"./settings-2-D-cav7o9.js";import"./eye-B6DXG3sW.js";const Ts=[["path",{d:"M5 7a2 2 0 0 0-2 2v11",key:"1yhqjt"}],["path",{d:"M5.803 18H5a2 2 0 0 0 0 4h9.5a.5.5 0 0 0 .5-.5V21",key:"edzzo5"}],["path",{d:"M9 15V4a2 2 0 0 1 2-2h9.5a.5.5 0 0 1 .5.5v14a.5.5 0 0 1-.5.5H11a2 2 0 0 1 0-4h10",key:"1nwzrg"}]],Ms=X("book-copy",Ts);const Os=[["path",{d:"M12 6v6l3.644 1.822",key:"1jmett"}],["path",{d:"M16 19h6",key:"xwg31i"}],["path",{d:"M19 16v6",key:"tddt3s"}],["path",{d:"M21.92 13.267a10 10 0 1 0-8.653 8.653",key:"1u0osk"}]],qs=X("clock-plus",Os);const Ls=[["path",{d:"M9 20H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v.5",key:"1dkoa9"}],["path",{d:"M12 10v4h4",key:"1czhmt"}],["path",{d:"m12 14 1.535-1.605a5 5 0 0 1 8 1.5",key:"lvuxfi"}],["path",{d:"M22 22v-4h-4",key:"1ewp4q"}],["path",{d:"m22 18-1.535 1.605a5 5 0 0 1-8-1.5",key:"14ync0"}]],_s=X("folder-sync",Ls);const zs=[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]],As=X("tag",zs);function Ks({gridCols:j,setGridCols:u,imageFit:S,setImageFit:D,autoGrid:x,setAutoGrid:v,useOriginalImages:T,setUseOriginalImages:n,mediaType:d,setMediaType:I,showArchived:r,setShowArchived:m}){return e.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium leading-none",children:"View Settings"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Customize how images are displayed."})]}),e.jsx(W,{}),e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(C,{htmlFor:"media-type",children:"Media Type"}),e.jsxs(ce,{value:d,onValueChange:i=>I(i),children:[e.jsx(oe,{id:"media-type",children:e.jsx(de,{placeholder:"Select media type"})}),e.jsxs(he,{children:[e.jsx(N,{value:"all",children:"All Media"}),e.jsx(N,{value:"image",children:"Images Only"}),e.jsx(N,{value:"video",children:"Videos Only"})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(C,{htmlFor:"archive-status",children:"Archive Status"}),e.jsxs(ce,{value:r===null?"all":r?"archived":"active",onValueChange:i=>{m(i==="all"?null:i==="archived")},children:[e.jsx(oe,{id:"archive-status",children:e.jsx(de,{placeholder:"Select status"})}),e.jsxs(he,{children:[e.jsx(N,{value:"active",children:"Active Only"}),e.jsx(N,{value:"archived",children:"Archived Only"}),e.jsx(N,{value:"all",children:"All Items"})]})]})]}),e.jsx(W,{}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(C,{htmlFor:"auto-grid",children:"Auto Grid Layout"}),e.jsx(Fe,{id:"auto-grid",checked:x,onCheckedChange:v})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(C,{htmlFor:"use-original",children:"Full Size Images"}),e.jsx(Fe,{id:"use-original",checked:T,onCheckedChange:n})]}),!x&&e.jsxs("div",{className:"grid gap-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(C,{htmlFor:"grid-cols",children:"Grid Columns"}),e.jsx("span",{className:"w-12 rounded-md border border-transparent px-2 py-0.5 text-right text-sm text-muted-foreground hover:border-border",children:j})]}),e.jsx(ss,{id:"grid-cols",max:10,min:1,step:1,value:[j],onValueChange:i=>u(i[0]),className:"**:[[role=slider]]:h-4 **:[[role=slider]]:w-4"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(C,{htmlFor:"image-fit",children:"Image Fit"}),e.jsxs(ce,{value:S,onValueChange:i=>D(i),children:[e.jsx(oe,{id:"image-fit",children:e.jsx(de,{placeholder:"Select fit"})}),e.jsxs(he,{children:[e.jsx(N,{value:"cover",children:"Cover"}),e.jsx(N,{value:"contain",children:"Contain"})]})]})]})]})]})}function Vs({tags:j,selectedTags:u,onToggleTag:S,onClearTags:D,onSoloTag:x}){const[v,T]=l.useState(""),[n,d]=l.useState(!1),I=l.useMemo(()=>v?j.filter(r=>r.name.toLowerCase().includes(v.toLowerCase())):j,[j,v]);return e.jsxs(as,{open:n,onOpenChange:d,children:[e.jsx(ls,{asChild:!0,children:e.jsxs(h,{variant:u.length>0?"secondary":"outline",size:"sm",className:"h-8 gap-2 border-dashed",children:[e.jsx(As,{className:"h-4 w-4"}),"Tags",u.length>0&&e.jsx(ue,{variant:"secondary",className:"ml-1 h-5 px-1.5 rounded-sm",children:u.length})]})}),e.jsxs(ts,{align:"start",className:"w-[300px] p-0",children:[e.jsx("div",{className:"p-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(Ke,{className:"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(xe,{placeholder:"Search tags...",value:v,onChange:r=>T(r.target.value),className:"pl-8 h-9",onKeyDown:r=>r.stopPropagation()})]})}),e.jsx(De,{}),e.jsx(ge,{className:"h-[300px]",children:e.jsxs("div",{className:"p-2 flex flex-wrap gap-1",children:[I.length===0&&e.jsx("div",{className:"w-full text-center text-sm text-muted-foreground py-4",children:"No tags found"}),I.map(r=>{const m=u.includes(r.name);return e.jsxs(h,{variant:m?"default":"outline",size:"sm",className:b("h-7 text-xs px-2",m?"hover:bg-primary/90":"hover:bg-muted"),onClick:i=>{i.preventDefault(),i.stopPropagation(),(i.ctrlKey||i.metaKey)&&x?x(r.name):S(r.name)},children:[r.name,e.jsx("span",{className:b("ml-1.5 text-[10px]",m?"text-primary-foreground/80":"text-muted-foreground"),children:r.count})]},r.name)})]})}),u.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(De,{}),e.jsx("div",{className:"p-2",children:e.jsx(h,{variant:"ghost",size:"sm",className:"w-full justify-center h-8",onClick:()=>{D()},children:"Clear filters"})})]})]})]})}const Bs=()=>{const{openImage:j,closeImage:u}=Te(),{selectedModel:S}=ns(),D=rs(),{imageId:x}=is.useSearch(),v={user:{id:"local",name:"Local User",username:"local"}},T=!1,[n,d]=l.useState("new"),[I,r]=l.useState("folders"),[m,i]=A("explore-show-sidebar",!0),[M,Es]=l.useState(null),[fe,pe]=l.useState(null),[g,O]=l.useState(null),[je,Z]=l.useState(""),[y,J]=l.useState(""),[o,Y]=l.useState(null),[c,ee]=l.useState(null),[ve,ye]=l.useState(""),[Ve,Ne]=l.useState(!1),[we,se]=l.useState(null),[f,Be]=l.useState("all"),[k,Ee]=l.useState(!1),[P,K]=l.useState([]),[q,$e]=A("explore-grid-cols",5),[L,Qe]=A("explore-auto-grid",!0),[_,He]=A("explore-use-original-images",!1),[z,Ge]=A("explore-image-fit","contain"),Se=cs(),{data:Re}=me({queryKey:["library-paths"],queryFn:Ps}),{data:Ue,refetch:Ce}=me({queryKey:["collections"],queryFn:ys}),{data:We}=me({queryKey:["tags"],queryFn:Ns});l.useEffect(()=>{x&&(O(x),d("search"),Z(""),J(""))},[x]),l.useEffect(()=>{},[v,T,Se]);const V=s=>{console.log("[ExplorePage] handleSearchByImage FIRED:",s),Z(""),J(""),O(s.id),d("search"),u()},{data:ae,fetchNextPage:B,hasNextPage:E,isFetchingNextPage:le,isLoading:te}=_e({queryKey:["items",n,o,c,P,f,k],queryFn:({pageParam:s})=>{if(c)return os(c,s,50);let a="new";return n==="new"&&(a="new"),n==="random"&&(a="random"),ws({offset:s,limit:50,sort:a,libraryId:o,tags:P,mediaType:f==="all"?void 0:f,isArchived:k})},initialPageParam:0,getNextPageParam:(s,a)=>{if(!(s.length<50))return a.length*50}}),$=l.useMemo(()=>{if(!ae)return[];const s=ae.pages.flat(),a=new Set;return s.filter(t=>a.has(t.id)?!1:(a.add(t.id),!0))},[ae]),{data:ne,isLoading:Xe,fetchNextPage:be,hasNextPage:Ie,isFetchingNextPage:Ze}=_e({queryKey:["search",y,g,o,c,S,f,k],queryFn:({pageParam:s})=>g?Ss(g,50,s,o,S,c,k,f==="all"?void 0:f):Cs(y,50,s,o,S,c,k,f==="all"?void 0:f),initialPageParam:0,getNextPageParam:(s,a)=>{if(!(s.length<50))return a.length*50},enabled:n==="search"&&(y.length>0||g!==null)}),re=l.useMemo(()=>{if(!ne)return[];const s=ne.pages.flat(),a=new Set;return s.filter(t=>a.has(t.id)?!1:(a.add(t.id),!0))},[ne]),{setGalleryImages:ke,currentGallery:Pe}=Te(),p=n==="search"?re:$,Je=n==="search"?be:B,ie=n==="search"?Ie:E;l.useEffect(()=>{if(Pe?.id==="virtual-gallery"&&p.length>0){const s=p.map(t=>({src:t.image_url,title:t.prompt,metadata:t,media_type:t.media_type==="video"?"video":"image"})),a=ie?p.length+100:p.length;ke(s,!0,void 0,a)}},[p,Pe?.id,ke,ie]);const Q=s=>{pe(s.id.toString())},H=s=>{const a=p.findIndex(t=>t.id===s.id);a!==-1&&j(s.image_url,{id:"virtual-gallery",images:p.map(t=>({src:t.image_url,title:t.prompt,metadata:t,media_type:t.media_type==="video"?"video":"image"})),fetchMore:()=>Je(),totalImages:ie?p.length+100:p.length},a)},Ye=s=>{s.key==="Enter"&&(O(null),J(je),d("search"))},es=async()=>{try{await vs({name:ve}),ye(""),Ne(!1),Ce(),G.success("Collection created")}catch{G.error("Failed to create collection")}};return e.jsxs("div",{className:"w-full h-full overflow-hidden flex p-1",children:[e.jsx("div",{className:b("flex flex-col overflow-hidden h-full border-none ring-0! shadow-none bg-transparent p-0! min-h-0 transition-all duration-300 ease-in-out",m?"w-80 opacity-100 translate-x-0 mr-1":"w-0 opacity-0 -translate-x-4 mr-0"),children:e.jsx("div",{className:"w-80 h-full flex flex-col gap-1",children:e.jsx(Me,{className:"flex-1 p-0! gap-0! flex flex-col overflow-visible min-h-0",children:e.jsxs(Oe,{value:I,onValueChange:s=>r(s),className:"h-full flex flex-col w-full! min-h-0 gap-1! space-y-0!",children:[e.jsx("div",{className:"flex items-center justify-between shrink-0 border-b border-foreground/10 p-1 bg-muted/35",children:e.jsxs(qe,{className:b("flex gap-1 w-full justify-start"),children:[e.jsx(F,{value:"folders",className:"max-w-fit items-center gap-2",children:e.jsx(Ms,{className:"h-4 w-4"})}),e.jsx(F,{value:"collections",className:"max-w-fit items-center gap-2",children:e.jsx(ze,{className:"h-4 w-4"})}),e.jsx(F,{value:"details",className:"ml-auto max-w-fit items-center gap-2",disabled:!M,children:e.jsx(Fs,{className:"h-4 w-4"})}),e.jsx(F,{value:"config",className:"max-w-fit items-center gap-2",children:e.jsx(bs,{className:"h-4 w-4"})})]})}),e.jsx(w,{value:"collections",className:"flex-1 m-0 overflow-hidden flex flex-col",children:e.jsxs(ge,{className:"flex-1",children:[e.jsxs("div",{className:"p-2 flex flex-row items-center justify-between space-y-0",children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Collections"}),e.jsxs(ds,{open:Ve,onOpenChange:Ne,children:[e.jsx(hs,{asChild:!0,children:e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",children:e.jsx(Le,{className:"h-4 w-4"})})}),e.jsxs(ms,{className:"max-w-lg",children:[e.jsxs(us,{children:[e.jsx(xs,{children:"Create Collection"}),e.jsx(gs,{children:"Create a new collection to organize your images."})]}),e.jsx("div",{className:"grid gap-4 py-4",children:e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(C,{htmlFor:"name",className:"text-right",children:"Name"}),e.jsx(xe,{id:"name",autoComplete:"off",value:ve,onChange:s=>ye(s.target.value),className:"col-span-3"})]})}),e.jsx(fs,{children:e.jsx(h,{onClick:es,children:"Create"})})]})]})]}),e.jsx(W,{}),e.jsx("div",{className:"p-2 space-y-1",children:Ue?.map(s=>e.jsxs(h,{variant:c===s.id||we===s.id?"secondary":"ghost",className:b("w-full justify-between font-normal h-9 transition-all",we===s.id&&"ring-2 ring-primary ring-inset scale-[1.02]"),onClick:()=>{ee(s.id),Y(null),n==="search"&&!y&&!g&&d("new")},onDragOver:a=>{a.preventDefault(),se(s.id)},onDragLeave:()=>se(null),onDrop:async a=>{a.preventDefault(),se(null);const t=a.dataTransfer.getData("application/embeddr-image-id");if(t)try{await ps(s.id,parseInt(t)),G.success(`Added to ${s.name}`),Ce()}catch{G.error("Failed to add to collection")}},children:[e.jsxs("div",{className:"flex items-center gap-2 truncate",children:[e.jsx(ze,{className:"h-4 w-4 shrink-0"}),e.jsx("span",{className:"truncate",children:s.name})]}),e.jsx(ue,{variant:"secondary",className:"text-[10px] h-5 px-1.5 min-w-5 justify-center",children:s.item_count})]},s.id))})]})}),e.jsxs(w,{value:"folders",className:"flex-1 m-0 overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"p-2 flex flex-row items-center justify-between space-y-0",children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Libraries"}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Se({to:"/settings",search:{tab:"library"}}),children:e.jsx(Le,{className:"h-4 w-4"})})]}),e.jsx(W,{}),e.jsx(ge,{className:"flex-1",children:e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsx(h,{variant:o===null&&c===null?"secondary":"ghost",className:"w-full justify-between font-normal h-9",onClick:()=>{Y(null),ee(null)},children:e.jsxs("span",{className:"flex items-center gap-2 truncate",children:[e.jsx(Ae,{className:"h-4 w-4 text-muted-foreground"}),"All Images"]})}),Re?.map(s=>e.jsxs(h,{variant:o===s.id?"secondary":"ghost",className:"w-full justify-between font-normal h-9",onClick:()=>{Y(s.id),ee(null),n==="search"&&!y&&!g&&d("new")},children:[e.jsxs("span",{className:"flex items-center gap-2 truncate",title:s.path,children:[e.jsx(Ae,{className:"h-4 w-4 text-muted-foreground"}),s.name||s.path.split("/").pop()]}),e.jsx(ue,{variant:"secondary",className:"text-xs h-5 px-1.5",children:s.image_count})]},s.id))]})})]}),e.jsx(w,{value:"details",className:"flex-1 m-0 overflow-hidden flex flex-col"}),e.jsx(w,{value:"config",className:"flex-1 m-0 overflow-hidden",children:e.jsx(Ks,{gridCols:q,setGridCols:$e,imageFit:z,setImageFit:Ge,autoGrid:L,setAutoGrid:Qe,useOriginalImages:_,setUseOriginalImages:He,mediaType:f,setMediaType:Be,showArchived:k,setShowArchived:Ee})})]})})})}),e.jsx(Me,{className:b("flex-1 flex flex-col overflow-visible h-full border-none ring-0! shadow-none bg-transparent p-0! min-h-0"),children:e.jsxs(Oe,{defaultValue:"new",value:n,onValueChange:s=>{d(s),s!=="search"&&O(null)},className:"h-full flex flex-col w-full! min-h-0 gap-1! space-y-0!",children:[e.jsxs("div",{className:"flex items-center shrink-0 border border-foreground/10 p-1 bg-card gap-1",children:[e.jsx(h,{variant:"outline",size:"icon",className:b("border ring-0!",m&&"bg-foreground/20!"),onClick:()=>i(s=>!s),children:e.jsx(Ds,{})}),e.jsxs(qe,{className:"grid grid-cols-4 border border-foreground/0 bg-card gap-1",children:[e.jsx(F,{value:"new",children:e.jsx(qs,{className:"h-4 w-4"})}),e.jsx(F,{value:"random",onPointerDown:()=>{n==="random"&&D.invalidateQueries({queryKey:["items","random"]})},children:e.jsx(_s,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"ml-auto",children:e.jsx(Vs,{tags:We||[],selectedTags:P,onToggleTag:s=>{P.includes(s)?K(P.filter(a=>a!==s)):K([...P,s])},onClearTags:()=>K([]),onSoloTag:s=>K([s])})}),e.jsx("div",{className:"flex items-center gap-2 h-full",children:e.jsxs("div",{className:"relative w-50 md:w-75 h-full",children:[e.jsx(Ke,{className:"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(xe,{placeholder:"Search prompts...",className:"pl-8 h-full dark:bg-input/30",value:je,onChange:s=>Z(s.target.value),onKeyDown:Ye})]})})]}),g&&e.jsxs("div",{className:"flex items-center justify-between bg-primary/5 px-1 pl-2 py-1.5 border border-foreground/10 animate-in fade-in slide-in-from-top-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Is,{className:"h-4 w-4 text-primary"}),e.jsxs("span",{className:"text-xs font-medium",children:["Showing images similar to"," ",e.jsxs("span",{className:"text-muted-foreground",children:["#",g]})]})]}),e.jsxs(h,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs hover:bg-primary/10",onClick:()=>{O(null),y||d("random")},children:[e.jsx(js,{className:"h-3 w-3 mr-1"}),"Clear"]})]}),e.jsx(w,{value:"search",className:"flex-1 m-0 overflow-hidden",children:n==="search"&&(Xe?e.jsx("div",{className:"flex items-center justify-center h-full flex-col",children:e.jsx(R,{})}):re.length===0?e.jsxs("div",{className:"flex items-center justify-center h-full flex-col text-muted-foreground",children:['No results found for "',y||"Image Search",'"']}):e.jsx(U,{posts:re,fetchNextPage:be,hasNextPage:Ie,isFetchingNextPage:Ze,onSelect:H,onOpenDetails:Q,onSearchByImage:V,selectedId:M?.id,queryKey:["search",y,g],gridCols:L?null:q,imageFit:z,useOriginalImages:_}))}),e.jsx(w,{value:"random",className:"flex-1 m-0 overflow-hidden",children:n==="random"&&(te?e.jsx("div",{className:"flex items-center justify-center h-full flex-col",children:e.jsx(R,{})}):e.jsx(U,{posts:$,fetchNextPage:B,hasNextPage:E,isFetchingNextPage:le,onSelect:H,onOpenDetails:Q,onSearchByImage:V,selectedId:M?.id,queryKey:["items","random",o,c],gridCols:L?null:q,imageFit:z,useOriginalImages:_},`random-${o}-${c}`))}),e.jsx(w,{value:"new",className:"flex-1 m-0 overflow-hidden",children:n==="new"&&(te?e.jsx("div",{className:"flex items-center justify-center h-full flex-col",children:e.jsx(R,{})}):e.jsx(U,{posts:$,fetchNextPage:B,hasNextPage:E,isFetchingNextPage:le,onSelect:H,onOpenDetails:Q,onSearchByImage:V,selectedId:M?.id,queryKey:["items","new",o,c],gridCols:L?null:q,imageFit:z,useOriginalImages:_},`new-${o}-${c}`))}),e.jsx(w,{value:"following",className:"flex-1 m-0 overflow-hidden",children:n==="following"&&(te?e.jsx("div",{className:"flex items-center justify-center h-full flex-col",children:e.jsx(R,{})}):e.jsx(U,{posts:$,fetchNextPage:B,hasNextPage:E,isFetchingNextPage:le,onSelect:H,onOpenDetails:Q,onSearchByImage:V,selectedId:M?.id,queryKey:["items","following",o,c],gridCols:L?null:q,imageFit:z,useOriginalImages:_},`following-${o}-${c}`))})]})}),e.jsx(ks,{imageId:fe,open:!!fe,onOpenChange:s=>!s&&pe(null)})]})},Js=Bs;export{Js as component};
