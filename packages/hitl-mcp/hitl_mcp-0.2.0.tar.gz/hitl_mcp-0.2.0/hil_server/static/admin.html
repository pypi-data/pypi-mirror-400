<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HIL-MCP ç»Ÿä¸€ç®¡ç†å°</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Noto+Sans+SC:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-card: #16161e;
            --border-color: #2a2a3a;
            --text-primary: #e8e8f0;
            --text-secondary: #8888a0;
            --text-muted: #555566;
            --accent-green: #4ade80;
            --accent-blue: #60a5fa;
            --accent-orange: #fbbf24;
            --accent-red: #f87171;
            --accent-purple: #a78bfa;
            --accent-cyan: #22d3ee;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(at 20% 80%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(at 80% 20%, rgba(168, 139, 250, 0.1) 0%, transparent 50%);
        }

        /* ============== ç™»å½•é¡µé¢ ============== */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            position: relative;
            overflow: hidden;
        }

        .login-box::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-1);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo .icon {
            width: 64px;
            height: 64px;
            background: var(--gradient-1);
            border-radius: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-bottom: 16px;
        }

        .login-logo h1 {
            font-size: 24px;
            font-weight: 600;
            background: linear-gradient(135deg, #fff 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-logo p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--gradient-1);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            color: var(--accent-red);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            display: none;
        }

        /* ============== ä¸»é¡µé¢ ============== */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            width: 48px;
            height: 48px;
            background: var(--gradient-1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            background: linear-gradient(135deg, #fff 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .mode-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .mode-relay {
            background: rgba(96, 165, 250, 0.15);
            color: var(--accent-blue);
            border: 1px solid rgba(96, 165, 250, 0.3);
        }

        .mode-direct {
            background: rgba(74, 222, 128, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(74, 222, 128, 0.3);
        }

        .btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--border-color);
            border-color: var(--accent-purple);
        }

        .btn-primary {
            background: var(--gradient-1);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            border-color: rgba(248, 113, 113, 0.5);
            color: var(--accent-red);
        }

        .btn-danger:hover {
            background: rgba(248, 113, 113, 0.15);
            border-color: var(--accent-red);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            font-size: 13px;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            background: var(--gradient-1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .timestamp {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* æœåŠ¡çŠ¶æ€å¡ç‰‡ */
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .service-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .service-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .service-card.hil::before { background: var(--gradient-1); }
        .service-card.worker::before { background: var(--gradient-3); }
        .service-card.forward::before { background: var(--gradient-2); }

        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .service-name {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .service-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .service-icon.hil { background: rgba(102, 126, 234, 0.2); }
        .service-icon.worker { background: rgba(79, 172, 254, 0.2); }
        .service-icon.forward { background: rgba(240, 147, 251, 0.2); }

        .service-title { font-size: 16px; font-weight: 600; }
        .service-version { font-size: 12px; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-indicator.online { background: rgba(74, 222, 128, 0.15); color: var(--accent-green); }
        .status-indicator.offline { background: rgba(248, 113, 113, 0.15); color: var(--accent-red); }
        .status-indicator.warning { background: rgba(251, 191, 36, 0.15); color: var(--accent-orange); }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.online { background: var(--accent-green); }
        .status-dot.offline { background: var(--accent-red); }
        .status-dot.warning { background: var(--accent-orange); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .service-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .metric {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 14px;
        }

        .metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* æ•°æ®è¡¨æ ¼åŒºåŸŸ */
        .data-section { margin-bottom: 32px; }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: "";
            width: 4px;
            height: 20px;
            background: var(--gradient-1);
            border-radius: 2px;
        }

        .tabs {
            display: flex;
            gap: 8px;
        }

        .tab {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .tab:hover { color: var(--text-primary); }

        .tab.active {
            background: var(--gradient-1);
            border-color: transparent;
            color: white;
        }

        .data-table {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .table-header {
            display: grid;
            padding: 14px 20px;
            background: var(--bg-tertiary);
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }

        .sessions-header { grid-template-columns: 100px 200px 1fr 120px 100px 140px; }
        .logs-header { grid-template-columns: 160px 120px 200px 1fr 100px 80px; }
        .rules-header { grid-template-columns: 200px 1fr 150px 150px 120px; }

        .table-row {
            display: grid;
            padding: 14px 20px;
            font-size: 13px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .table-row:last-child { border-bottom: none; }
        .table-row:hover { background: var(--bg-tertiary); }

        .sessions-row { grid-template-columns: 100px 200px 1fr 120px 100px 140px; }
        .logs-row { grid-template-columns: 160px 120px 200px 1fr 100px 80px; }
        .rules-row { grid-template-columns: 200px 1fr 150px 150px 120px; }

        .cell {
            display: flex;
            align-items: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .cell-code { font-family: 'JetBrains Mono', monospace; font-size: 12px; }
        .cell-message { color: var(--text-secondary); }

        .status-tag {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-tag.waiting { background: rgba(251, 191, 36, 0.15); color: var(--accent-orange); }
        .status-tag.replied { background: rgba(74, 222, 128, 0.15); color: var(--accent-green); }
        .status-tag.timeout { background: rgba(248, 113, 113, 0.15); color: var(--accent-red); }
        .status-tag.success { background: rgba(74, 222, 128, 0.15); color: var(--accent-green); }
        .status-tag.error { background: rgba(248, 113, 113, 0.15); color: var(--accent-red); }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .error-banner {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            color: var(--accent-red);
            padding: 14px 20px;
            border-radius: 10px;
            margin-bottom: 24px;
            display: none;
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        .modal-close:hover { color: var(--text-primary); }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        /* å“åº”å¼ */
        @media (max-width: 1200px) {
            .services-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .container { padding: 16px; }
            .header-left h1 { display: none; }
            .service-metrics { grid-template-columns: 1fr; }
            .table-header, .table-row { font-size: 11px; padding: 10px 12px; }
        }

        .hidden { display: none !important; }

        /* Worker åˆ—è¡¨æ ·å¼ */
        .worker-list {
            border-top: 1px solid var(--border-color);
            padding-top: 12px;
        }

        .worker-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .worker-item:hover {
            border-color: var(--accent-blue);
            transform: translateX(4px);
        }

        .worker-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .worker-item-id {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: var(--accent-cyan);
        }

        .worker-item-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(74, 222, 128, 0.2);
            color: var(--accent-green);
        }

        .worker-item-status.offline {
            background: rgba(248, 113, 113, 0.2);
            color: var(--accent-red);
        }

        .worker-item-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            font-size: 12px;
        }

        .worker-detail-item {
            display: flex;
            gap: 4px;
        }

        .worker-detail-label {
            color: var(--text-muted);
        }

        .worker-detail-value {
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Forward Service é…ç½®è¡¨å• */
        .forward-config-section {
            margin-top: 16px;
            border-top: 1px solid var(--border-color);
            padding-top: 16px;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-color);
        }

        .config-item:last-child {
            border-bottom: none;
        }

        .config-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .config-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--accent-cyan);
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="login-page" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <div class="icon">âš¡</div>
                <h1>JARVIS</h1>
                <p>HIL-MCP ç»Ÿä¸€ç®¡ç†å°</p>
            </div>
            <div id="login-error" class="login-error"></div>
            <form id="login-form">
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="login-btn" id="login-btn">ç™»å½•</button>
            </form>
        </div>
    </div>

    <!-- ä¸»é¡µé¢ -->
    <div id="main-page" class="container hidden">
        <header>
            <div class="header-left">
                <div class="logo">âš¡</div>
                <div>
                    <h1>JARVIS</h1>
                    <div class="timestamp" id="last-update">æœ€åæ›´æ–°: --</div>
                </div>
            </div>
            <div class="header-right">
                <div id="mode-badge" class="mode-badge mode-relay">RELAY</div>
                <div class="user-info">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <span id="current-user">admin</span>
                </div>
                <button class="btn" onclick="refreshAll()">ğŸ”„ åˆ·æ–°</button>
                <button class="btn btn-danger" onclick="logout()">é€€å‡º</button>
            </div>
        </header>

        <div id="error-banner" class="error-banner"></div>

        <!-- æœåŠ¡çŠ¶æ€å¡ç‰‡ -->
        <div class="services-grid">
            <div class="service-card hil">
                <div class="service-header">
                    <div class="service-name">
                        <div class="service-icon hil">ğŸ¯</div>
                        <div>
                            <div class="service-title">HIL Server</div>
                            <div class="service-version" id="hil-version">v2.0.0</div>
                        </div>
                    </div>
                    <div id="hil-status" class="status-indicator online">
                        <span class="status-dot online"></span>è¿è¡Œä¸­
                    </div>
                </div>
                <div class="service-metrics">
                    <div class="metric">
                        <div class="metric-value" id="hil-active-sessions">-</div>
                        <div class="metric-label">æ´»è·ƒä¼šè¯</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="hil-total-sessions">-</div>
                        <div class="metric-label">æ€»ä¼šè¯æ•°</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="hil-port">-</div>
                        <div class="metric-label">ç«¯å£</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="hil-mode">-</div>
                        <div class="metric-label">æ¨¡å¼</div>
                    </div>
                </div>
            </div>

            <div class="service-card worker" id="worker-card">
                <div class="service-header">
                    <div class="service-name">
                        <div class="service-icon worker">ğŸ”Œ</div>
                        <div>
                            <div class="service-title">DevCloud Worker</div>
                            <div class="service-version">Relay ä»£ç†</div>
                        </div>
                    </div>
                    <div id="worker-status" class="status-indicator offline">
                        <span class="status-dot offline"></span>æœªè¿æ¥
                    </div>
                </div>
                <div class="service-metrics">
                    <div class="metric">
                        <div class="metric-value" id="worker-count">-</div>
                        <div class="metric-label">è¿æ¥æ•°</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="worker-alive">-</div>
                        <div class="metric-label">æ´»è·ƒ</div>
                    </div>
                </div>
                <!-- Worker åˆ—è¡¨è¯¦æƒ… -->
                <div id="worker-list" class="worker-list" style="margin-top: 16px; display: none;">
                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">è¿æ¥çš„ Worker:</div>
                    <div id="worker-items"></div>
                </div>
                <button class="btn" style="margin-top: 12px; width: 100%;" onclick="toggleWorkerList()">
                    <span id="worker-toggle-text">å±•å¼€è¯¦æƒ… â–¼</span>
                </button>
            </div>

            <div class="service-card forward">
                <div class="service-header">
                    <div class="service-name">
                        <div class="service-icon forward">ğŸ”€</div>
                        <div>
                            <div class="service-title">Forward Service</div>
                            <div class="service-version" id="forward-version">v1.1.0</div>
                        </div>
                    </div>
                    <div id="forward-status" class="status-indicator offline">
                        <span class="status-dot offline"></span>æœªé…ç½®
                    </div>
                </div>
                <div class="service-metrics">
                    <div class="metric">
                        <div class="metric-value" id="forward-requests">-</div>
                        <div class="metric-label">æ€»è¯·æ±‚</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="forward-success">-</div>
                        <div class="metric-label">æˆåŠŸ</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="forward-rules">-</div>
                        <div class="metric-label">è½¬å‘è§„åˆ™</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="forward-timeout">-</div>
                        <div class="metric-label">è¶…æ—¶(s)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®è¡¨æ ¼ -->
        <div class="data-section">
            <div class="section-header">
                <div class="section-title">æ•°æ®è¯¦æƒ…</div>
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('sessions')">HIL ä¼šè¯</div>
                    <div class="tab" onclick="switchTab('logs')">Forward æ—¥å¿—</div>
                    <div class="tab" onclick="switchTab('rules')">è½¬å‘è§„åˆ™</div>
                    <div class="tab" onclick="switchTab('idle-hint')">ç©ºé—²æç¤ºé…ç½®</div>
                </div>
            </div>

            <!-- HIL ä¼šè¯ -->
            <div id="sessions-panel" class="data-table">
                <div class="table-header sessions-header">
                    <div>Short ID</div>
                    <div>Chat ID</div>
                    <div>æ¶ˆæ¯å†…å®¹</div>
                    <div>é¡¹ç›®</div>
                    <div>çŠ¶æ€</div>
                    <div>åˆ›å»ºæ—¶é—´</div>
                </div>
                <div id="sessions-body"><div class="loading">åŠ è½½ä¸­...</div></div>
            </div>

            <!-- Forward æ—¥å¿— -->
            <div id="logs-panel" class="data-table" style="display: none;">
                <div class="table-header logs-header">
                    <div>æ—¶é—´</div>
                    <div>ç”¨æˆ·</div>
                    <div>Chat ID</div>
                    <div>å†…å®¹</div>
                    <div>çŠ¶æ€</div>
                    <div>è€—æ—¶</div>
                </div>
                <div id="logs-body"><div class="loading">åŠ è½½ä¸­...</div></div>
            </div>

            <!-- è½¬å‘è§„åˆ™ -->
            <div id="rules-panel" class="data-table" style="display: none;">
                <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: var(--text-secondary); font-size: 13px;">ç®¡ç† Forward Service çš„è½¬å‘è§„åˆ™</span>
                    <button class="btn btn-primary" onclick="showAddRuleModal()">+ æ·»åŠ è§„åˆ™</button>
                </div>
                <div class="table-header rules-header">
                    <div>Chat ID</div>
                    <div>URL æ¨¡æ¿</div>
                    <div>Agent ID</div>
                    <div>API Key</div>
                    <div>æ“ä½œ</div>
                </div>
                <div id="rules-body"><div class="loading">åŠ è½½ä¸­...</div></div>
            </div>

            <!-- ç©ºé—²æç¤ºé…ç½® -->
            <div id="idle-hint-panel" class="data-table" style="display: none;">
                <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-color);">
                    <span style="color: var(--text-secondary); font-size: 13px;">é…ç½®å½“ç”¨æˆ·å‘é€æ¶ˆæ¯ä½†æœºå™¨äººæœªåœ¨ç­‰å¾…å›å¤æ—¶çš„è‡ªåŠ¨å›å¤æ¶ˆæ¯ï¼ˆæ”¯æŒçƒ­æ›´æ–°ï¼‰</span>
                </div>

                <!-- å…¨å±€é»˜è®¤é…ç½® -->
                <div style="padding: 20px; border-bottom: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="font-size: 14px; font-weight: 600; color: var(--text-primary);">å…¨å±€é»˜è®¤é…ç½®</h3>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); cursor: pointer;">
                                <input type="checkbox" id="default-enabled" checked style="cursor: pointer;">
                                <span>å¯ç”¨</span>
                            </label>
                            <button class="btn btn-primary" onclick="saveDefaultConfig()">ä¿å­˜å…¨å±€é…ç½®</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æ¶ˆæ¯æ¨¡æ¿ï¼ˆæ”¯æŒå˜é‡ï¼š{user_name}, {chat_id}, {chat_type}, {timestamp}ï¼‰</label>
                        <textarea id="default-template" rows="12" style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 13px; line-height: 1.6; resize: vertical;">ğŸ‘‹ ä½ å¥½ {user_name}ï¼

å½“å‰æ²¡æœ‰ç­‰å¾…ä¸­çš„ä¼šè¯éœ€è¦ä½ å›å¤ã€‚

å¦‚æœä½ æƒ³é…ç½® MCP ä½¿ç”¨æ­¤{chat_type}ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹ä¿¡æ¯ï¼š

ğŸ“‹ **Chat ID**: `{chat_id}`
ğŸ“Œ **ä¼šè¯ç±»å‹**: {chat_type}
ğŸ• **æ—¶é—´**: {timestamp}

ä½ å¯ä»¥å°†æ­¤ Chat ID é…ç½®åˆ° MCP çš„ç¯å¢ƒå˜é‡ä¸­ï¼š
```
DEFAULT_CHAT_ID={chat_id}
```</textarea>
                    </div>
                    <div style="margin-top: 12px; padding: 12px; background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; font-size: 12px; color: var(--accent-blue);">
                        ğŸ’¡ æç¤ºï¼šé…ç½®ä¿å­˜åç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡
                    </div>
                </div>

                <!-- Chat ID ç‰¹å®šé…ç½® -->
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="font-size: 14px; font-weight: 600; color: var(--text-primary);">Chat ID ç‰¹å®šé…ç½®</h3>
                        <button class="btn btn-primary" onclick="showAddIdleHintModal()">+ æ·»åŠ é…ç½®</button>
                    </div>
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 12px;">
                        ä¸ºç‰¹å®šçš„ Chat ID é…ç½®è‡ªå®šä¹‰æ¶ˆæ¯ï¼Œä¼˜å…ˆçº§é«˜äºå…¨å±€é»˜è®¤é…ç½®
                    </div>
                    <div class="table-header" style="grid-template-columns: 1.2fr 3fr 0.8fr 0.8fr;">
                        <div>Chat ID</div>
                        <div>æ¶ˆæ¯æ¨¡æ¿</div>
                        <div>çŠ¶æ€</div>
                        <div>æ“ä½œ</div>
                    </div>
                    <div id="idle-hint-configs-body"><div class="loading">åŠ è½½ä¸­...</div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘è§„åˆ™æ¨¡æ€æ¡† -->
    <div id="rule-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="rule-modal-title">æ·»åŠ è½¬å‘è§„åˆ™</div>
                <button class="modal-close" onclick="closeRuleModal()">&times;</button>
            </div>
            <form id="rule-form">
                <div class="form-group">
                    <label>Chat ID *</label>
                    <input type="text" id="rule-chat-id" required placeholder="ä¼å¾®ç¾¤/ç§èŠ ID">
                </div>
                <div class="form-group">
                    <label>URL æ¨¡æ¿ *</label>
                    <input type="text" id="rule-url" required placeholder="https://api.example.com/a2a/{agent_id}/messages">
                </div>
                <div class="form-group">
                    <label>Agent ID</label>
                    <input type="text" id="rule-agent-id" placeholder="ç”¨äºæ›¿æ¢ URL ä¸­çš„ {agent_id}">
                </div>
                <div class="form-group">
                    <label>API Key</label>
                    <input type="password" id="rule-api-key" placeholder="Bearer Token è®¤è¯">
                </div>
                <div class="form-group">
                    <label>åç§°ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="rule-name" placeholder="ä¾¿äºè¯†åˆ«çš„åç§°">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeRuleModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Worker é…ç½®ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="worker-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">ç¼–è¾‘ Worker é…ç½®</div>
                <button class="modal-close" onclick="closeWorkerModal()">&times;</button>
            </div>
            <form id="worker-form">
                <div class="form-group">
                    <label>Worker ID</label>
                    <input type="text" id="worker-modal-id" readonly style="background: var(--bg-primary); color: var(--text-muted);">
                </div>
                <div class="form-group">
                    <label>BOT_KEY *</label>
                    <input type="text" id="worker-modal-bot-key" required placeholder="ä¼å¾®æœºå™¨äºº Webhook Key">
                </div>
                <div class="form-group">
                    <label>HIL_URL</label>
                    <input type="text" id="worker-modal-hil-url" placeholder="ws://...">
                </div>
                <div class="form-group">
                    <label>å›è°ƒç«¯å£</label>
                    <input type="number" id="worker-modal-callback-port" placeholder="8082">
                </div>
                <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 12px; color: var(--accent-orange);">
                    âš ï¸ ä¿®æ”¹é…ç½®åéœ€è¦é‡å¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆ
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeWorkerModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜é…ç½®</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç©ºé—²æç¤ºé…ç½®æ¨¡æ€æ¡† -->
    <div id="idle-hint-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="idle-hint-modal-title">æ·»åŠ  Chat ID é…ç½®</div>
                <button class="modal-close" onclick="closeIdleHintModal()">&times;</button>
            </div>
            <form id="idle-hint-form">
                <div class="form-group">
                    <label>Chat ID *</label>
                    <input type="text" id="idle-hint-chat-id" required placeholder="ä¼å¾®ç¾¤/ç§èŠ ID">
                </div>
                <div class="form-group">
                    <label>æ¶ˆæ¯æ¨¡æ¿ *</label>
                    <textarea id="idle-hint-template" rows="10" required style="width: 100%; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 13px; line-height: 1.6; resize: vertical;" placeholder="æ”¯æŒå˜é‡ï¼š{user_name}, {chat_id}, {chat_type}, {timestamp}"></textarea>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="idle-hint-enabled" checked style="cursor: pointer;">
                        <span>å¯ç”¨æ­¤é…ç½®</span>
                    </label>
                </div>
                <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 12px; color: var(--accent-blue);">
                    ğŸ’¡ æ­¤é…ç½®ä¼šè¦†ç›–å…¨å±€é»˜è®¤é…ç½®ï¼Œä»…å¯¹æŒ‡å®šçš„ Chat ID ç”Ÿæ•ˆ
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeIdleHintModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let authToken = localStorage.getItem('jarvis_token');
        let currentMode = 'relay';
        let editingChatId = null;
        let currentWorkers = [];
        let workerListExpanded = false;

        // ============== è®¤è¯ç›¸å…³ ==============
        async function login(username, password) {
            try {
                const response = await fetch(`${API_BASE}/admin/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ç™»å½•å¤±è´¥');
                }
                
                const data = await response.json();
                authToken = data.token;
                localStorage.setItem('jarvis_token', authToken);
                return true;
            } catch (error) {
                throw error;
            }
        }

        function logout() {
            authToken = null;
            localStorage.removeItem('jarvis_token');
            showLoginPage();
        }

        async function checkAuth() {
            if (!authToken) return false;
            
            try {
                const response = await fetch(`${API_BASE}/admin/api/verify`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                return response.ok;
            } catch {
                return false;
            }
        }

        function showLoginPage() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('main-page').classList.add('hidden');
        }

        function showMainPage() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-page').classList.remove('hidden');
            refreshAll();
        }

        // ============== API è¯·æ±‚ ==============
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.status === 401) {
                    logout();
                    throw new Error('ç™»å½•å·²è¿‡æœŸ');
                }
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Failed to fetch ${endpoint}:`, error);
                throw error;
            }
        }

        async function postData(endpoint, data) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify(data)
            });
            
            if (response.status === 401) {
                logout();
                throw new Error('ç™»å½•å·²è¿‡æœŸ');
            }
            
            return await response.json();
        }

        async function deleteData(endpoint) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            
            if (response.status === 401) {
                logout();
                throw new Error('ç™»å½•å·²è¿‡æœŸ');
            }
            
            return await response.json();
        }

        // ============== ç•Œé¢æ›´æ–° ==============
        function showError(message) {
            const banner = document.getElementById('error-banner');
            banner.textContent = `âš ï¸ ${message}`;
            banner.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-banner').style.display = 'none';
        }

        function updateTimestamp() {
            document.getElementById('last-update').textContent = 
                `æœ€åæ›´æ–°: ${new Date().toLocaleString('zh-CN')}`;
        }

        // ============== Worker åˆ—è¡¨ç›¸å…³ ==============
        function toggleWorkerList() {
            workerListExpanded = !workerListExpanded;
            const list = document.getElementById('worker-list');
            const toggleText = document.getElementById('worker-toggle-text');
            
            if (workerListExpanded) {
                list.style.display = 'block';
                toggleText.textContent = 'æ”¶èµ·è¯¦æƒ… â–²';
            } else {
                list.style.display = 'none';
                toggleText.textContent = 'å±•å¼€è¯¦æƒ… â–¼';
            }
        }

        function renderWorkerList() {
            const container = document.getElementById('worker-items');
            if (!container) return;
            
            if (currentWorkers.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">æš‚æ— è¿æ¥çš„ Worker</div>';
                return;
            }
            
            container.innerHTML = currentWorkers.map(w => `
                <div class="worker-item" onclick="showWorkerDetail('${w.worker_id}')">
                    <div class="worker-item-header">
                        <span class="worker-item-id">${w.worker_id}</span>
                        <span class="worker-item-status ${w.is_alive ? '' : 'offline'}">${w.is_alive ? 'æ´»è·ƒ' : 'ç¦»çº¿'}</span>
                    </div>
                    <div class="worker-item-details">
                        <div class="worker-detail-item">
                            <span class="worker-detail-label">IP:</span>
                            <span class="worker-detail-value">${w.ip_address || '-'}</span>
                        </div>
                        <div class="worker-detail-item">
                            <span class="worker-detail-label">å›è°ƒç«¯å£:</span>
                            <span class="worker-detail-value">${w.callback_port || '-'}</span>
                        </div>
                        <div class="worker-detail-item">
                            <span class="worker-detail-label">BOT_KEY:</span>
                            <span class="worker-detail-value">${w.bot_key || '-'}</span>
                        </div>
                        <div class="worker-detail-item">
                            <span class="worker-detail-label">Forward:</span>
                            <span class="worker-detail-value">${w.forward_service_url || '-'}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showWorkerDetail(workerId) {
            const worker = currentWorkers.find(w => w.worker_id === workerId);
            if (!worker) return;
            
            // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
            editingWorkerId = workerId;
            document.getElementById('worker-modal-id').value = worker.worker_id;
            document.getElementById('worker-modal-bot-key').value = worker.bot_key || '';
            document.getElementById('worker-modal-hil-url').value = worker.hil_url || '';
            document.getElementById('worker-modal-callback-port').value = worker.callback_port || '';
            document.getElementById('worker-modal').classList.add('active');
        }

        function closeWorkerModal() {
            document.getElementById('worker-modal').classList.remove('active');
            editingWorkerId = null;
        }

        let editingWorkerId = null;

        // Worker é…ç½®ä¿å­˜
        document.getElementById('worker-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!editingWorkerId) return;
            
            const botKey = document.getElementById('worker-modal-bot-key').value.trim();
            const hilUrl = document.getElementById('worker-modal-hil-url').value.trim();
            const callbackPort = document.getElementById('worker-modal-callback-port').value;
            
            try {
                const payload = {};
                if (botKey) payload.bot_key = botKey;
                if (hilUrl) payload.hil_url = hilUrl;
                if (callbackPort) payload.callback_port = parseInt(callbackPort);
                
                const response = await fetch(`${API_BASE}/admin/api/workers/${editingWorkerId}/config`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… é…ç½®å·²ä¿å­˜ï¼\n\nè¯·é‡å¯ Worker æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆï¼š\nsystemctl restart hil-worker');
                    closeWorkerModal();
                    loadOverview();
                } else {
                    alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        });

        async function loadOverview() {
            try {
                const data = await fetchData('/admin/api/overview');
                currentMode = data.mode;

                const modeBadge = document.getElementById('mode-badge');
                modeBadge.textContent = data.mode.toUpperCase();
                modeBadge.className = `mode-badge mode-${data.mode}`;

                // HIL Server
                const hil = data.hil_server || {};
                document.getElementById('hil-version').textContent = `v${hil.version || '2.0.0'}`;
                document.getElementById('hil-active-sessions').textContent = hil.sessions?.active || 0;
                document.getElementById('hil-total-sessions').textContent = hil.sessions?.total || 0;
                document.getElementById('hil-port').textContent = hil.port || '-';
                document.getElementById('hil-mode').textContent = hil.mode || '-';

                // Worker
                const workerCard = document.getElementById('worker-card');
                if (data.mode === 'relay' && data.worker) {
                    workerCard.style.display = 'block';
                    const worker = data.worker;
                    const workerStatus = document.getElementById('worker-status');
                    
                    if (worker.connected) {
                        workerStatus.className = 'status-indicator online';
                        workerStatus.innerHTML = '<span class="status-dot online"></span>å·²è¿æ¥';
                    } else {
                        workerStatus.className = 'status-indicator offline';
                        workerStatus.innerHTML = '<span class="status-dot offline"></span>æœªè¿æ¥';
                    }
                    
                    document.getElementById('worker-count').textContent = worker.count || 0;
                    document.getElementById('worker-alive').textContent = 
                        worker.workers?.filter(w => w.is_alive).length || 0;
                    
                    // ä¿å­˜ Worker æ•°æ®å¹¶æ¸²æŸ“åˆ—è¡¨
                    currentWorkers = worker.workers || [];
                    renderWorkerList();
                } else {
                    workerCard.style.display = 'none';
                }

                // Forward Service
                const forward = data.forward_service || {};
                const forwardStatus = document.getElementById('forward-status');
                
                if (forward.error) {
                    forwardStatus.className = 'status-indicator warning';
                    forwardStatus.innerHTML = '<span class="status-dot warning"></span>' + 
                        (forward.error.includes('not configured') ? 'æœªé…ç½®' : 'ç¦»çº¿');
                    document.getElementById('forward-requests').textContent = '-';
                    document.getElementById('forward-success').textContent = '-';
                    document.getElementById('forward-rules').textContent = '-';
                    document.getElementById('forward-timeout').textContent = '-';
                } else {
                    forwardStatus.className = 'status-indicator online';
                    forwardStatus.innerHTML = '<span class="status-dot online"></span>è¿è¡Œä¸­';
                    document.getElementById('forward-version').textContent = `v${forward.version || '1.1.0'}`;
                    document.getElementById('forward-requests').textContent = forward.stats?.total_requests || 0;
                    document.getElementById('forward-success').textContent = forward.stats?.recent_success || 0;
                    document.getElementById('forward-rules').textContent = forward.config?.rules_count || 0;
                    document.getElementById('forward-timeout').textContent = forward.config?.timeout || '-';
                }

                updateTimestamp();
                hideError();
            } catch (error) {
                showError('æ— æ³•åŠ è½½æœåŠ¡çŠ¶æ€');
            }
        }

        async function loadSessions() {
            const container = document.getElementById('sessions-body');
            try {
                const data = await fetchData('/admin/api/hil/sessions');
                const sessions = data.sessions || [];

                if (sessions.length === 0) {
                    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ“­</div><div>æš‚æ— ä¼šè¯è®°å½•</div></div>`;
                    return;
                }

                let html = '';
                for (const session of sessions) {
                    const statusClass = session.status === 'waiting' ? 'waiting' : 
                                       (session.status === 'replied' ? 'replied' : 'timeout');
                    const time = new Date(session.created_at).toLocaleString('zh-CN');
                    
                    html += `
                        <div class="table-row sessions-row">
                            <div class="cell cell-code">#${session.short_id}</div>
                            <div class="cell cell-code" title="${session.chat_id}">${session.chat_id.slice(0, 20)}...</div>
                            <div class="cell cell-message" title="${session.message}">${session.message}</div>
                            <div class="cell">${session.project_name || '-'}</div>
                            <div class="cell"><span class="status-tag ${statusClass}">${session.status}</span></div>
                            <div class="cell cell-code">${time}</div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="empty-state" style="color: var(--accent-red);"><div class="icon">âŒ</div><div>åŠ è½½å¤±è´¥</div></div>`;
            }
        }

        async function loadLogs() {
            const container = document.getElementById('logs-body');
            try {
                const data = await fetchData('/admin/api/forward/logs?limit=20');
                
                if (data.error) {
                    container.innerHTML = `<div class="empty-state"><div class="icon">âš ï¸</div><div>${data.error}</div></div>`;
                    return;
                }

                const logs = data.logs || [];
                if (logs.length === 0) {
                    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ“­</div><div>æš‚æ— è¯·æ±‚æ—¥å¿—</div></div>`;
                    return;
                }

                let html = '';
                for (const log of logs) {
                    const statusClass = log.status === 'success' ? 'success' : 'error';
                    const time = new Date(log.timestamp).toLocaleString('zh-CN');
                    
                    html += `
                        <div class="table-row logs-row">
                            <div class="cell cell-code">${time}</div>
                            <div class="cell">${log.from_user || '-'}</div>
                            <div class="cell cell-code" title="${log.chat_id}">${(log.chat_id || '').slice(0, 18)}...</div>
                            <div class="cell cell-message" title="${log.content}">${log.content || '-'}</div>
                            <div class="cell"><span class="status-tag ${statusClass}">${log.status}</span></div>
                            <div class="cell cell-code">${log.duration_ms || 0}ms</div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="empty-state" style="color: var(--accent-red);"><div class="icon">âŒ</div><div>åŠ è½½å¤±è´¥</div></div>`;
            }
        }

        async function loadRules() {
            const container = document.getElementById('rules-body');
            try {
                const data = await fetchData('/admin/api/forward/rules');
                
                if (data.error) {
                    container.innerHTML = `<div class="empty-state"><div class="icon">âš ï¸</div><div>${data.error}</div></div>`;
                    return;
                }

                const rules = data.rules || {};
                if (Object.keys(rules).length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ“‹</div>
                            <div>æš‚æ— è½¬å‘è§„åˆ™é…ç½®</div>
                            <div style="margin-top: 8px; font-size: 12px;">é»˜è®¤ URL: ${data.default_url || 'æœªé…ç½®'}</div>
                        </div>
                    `;
                    return;
                }

                let html = '';
                for (const [chatId, rule] of Object.entries(rules)) {
                    html += `
                        <div class="table-row rules-row">
                            <div class="cell cell-code" title="${chatId}">${chatId.length > 18 ? chatId.slice(0, 18) + '...' : chatId}</div>
                            <div class="cell cell-code" style="color: var(--accent-blue);" title="${rule.url_template}">${rule.url_template || '-'}</div>
                            <div class="cell cell-code">${rule.agent_id || '-'}</div>
                            <div class="cell cell-code">${rule.api_key ? '****' + rule.api_key.slice(-4) : '-'}</div>
                            <div class="cell">
                                <button class="btn" style="padding: 4px 10px; font-size: 11px;" onclick="editRule('${chatId}')">ç¼–è¾‘</button>
                                <button class="btn btn-danger" style="padding: 4px 10px; font-size: 11px; margin-left: 8px;" onclick="deleteRule('${chatId}')">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="empty-state" style="color: var(--accent-red);"><div class="icon">âŒ</div><div>åŠ è½½å¤±è´¥</div></div>`;
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('sessions-panel').style.display = tab === 'sessions' ? 'block' : 'none';
            document.getElementById('logs-panel').style.display = tab === 'logs' ? 'block' : 'none';
            document.getElementById('rules-panel').style.display = tab === 'rules' ? 'block' : 'none';
            document.getElementById('idle-hint-panel').style.display = tab === 'idle-hint' ? 'block' : 'none';

            if (tab === 'sessions') loadSessions();
            else if (tab === 'logs') loadLogs();
            else if (tab === 'rules') loadRules();
            else if (tab === 'idle-hint') loadIdleHintConfigs();
        }

        async function refreshAll() {
            await loadOverview();
            const activeTab = document.querySelector('.tab.active');
            if (activeTab.textContent.includes('ä¼šè¯')) loadSessions();
            else if (activeTab.textContent.includes('æ—¥å¿—')) loadLogs();
            else if (activeTab.textContent.includes('è§„åˆ™')) loadRules();
        }

        // ============== è§„åˆ™ç®¡ç† ==============
        function showAddRuleModal() {
            editingChatId = null;
            document.getElementById('rule-modal-title').textContent = 'æ·»åŠ è½¬å‘è§„åˆ™';
            document.getElementById('rule-form').reset();
            document.getElementById('rule-chat-id').disabled = false;
            document.getElementById('rule-modal').classList.add('active');
        }

        async function editRule(chatId) {
            editingChatId = chatId;
            document.getElementById('rule-modal-title').textContent = 'ç¼–è¾‘è½¬å‘è§„åˆ™';
            
            try {
                const data = await fetchData('/admin/api/forward/rules');
                const rule = data.rules?.[chatId];
                
                if (rule) {
                    document.getElementById('rule-chat-id').value = chatId;
                    document.getElementById('rule-chat-id').disabled = true;
                    document.getElementById('rule-url').value = rule.url_template || '';
                    document.getElementById('rule-agent-id').value = rule.agent_id || '';
                    document.getElementById('rule-api-key').value = rule.api_key || '';
                    document.getElementById('rule-name').value = rule.name || '';
                }
                
                document.getElementById('rule-modal').classList.add('active');
            } catch (error) {
                alert('è·å–è§„åˆ™å¤±è´¥: ' + error.message);
            }
        }

        function closeRuleModal() {
            document.getElementById('rule-modal').classList.remove('active');
            editingChatId = null;
        }

        async function deleteRule(chatId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${chatId} çš„è½¬å‘è§„åˆ™å—ï¼Ÿ`)) return;
            
            try {
                const result = await deleteData(`/admin/api/forward/rules/${encodeURIComponent(chatId)}`);
                if (result.success) {
                    loadRules();
                    loadOverview();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // ============== åˆå§‹åŒ– ==============
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('login-btn');
            const errorEl = document.getElementById('login-error');
            
            btn.disabled = true;
            btn.textContent = 'ç™»å½•ä¸­...';
            errorEl.style.display = 'none';
            
            try {
                await login(username, password);
                showMainPage();
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç™»å½•';
            }
        });

        document.getElementById('rule-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const chatId = document.getElementById('rule-chat-id').value;
            const ruleData = {
                chat_id: chatId,
                url_template: document.getElementById('rule-url').value,
                agent_id: document.getElementById('rule-agent-id').value,
                api_key: document.getElementById('rule-api-key').value,
                name: document.getElementById('rule-name').value
            };
            
            try {
                const endpoint = editingChatId 
                    ? `/admin/api/forward/rules/${encodeURIComponent(editingChatId)}`
                    : '/admin/api/forward/rules';
                
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    method: editingChatId ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(ruleData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeRuleModal();
                    loadRules();
                    loadOverview();
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        });

        // ============== ç©ºé—²æç¤ºé…ç½®ç›¸å…³ ==============
        let editingIdleHintChatId = null;

        async function loadIdleHintConfigs() {
            try {
                const data = await fetchData('/admin/api/idle-hint-config');
                if (!data.success) {
                    alert('åŠ è½½é…ç½®å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    return;
                }
                
                const configs = data.data || {};
                
                // åŠ è½½å…¨å±€é»˜è®¤é…ç½®
                const defaultConfig = configs.default || {};
                document.getElementById('default-template').value = defaultConfig.template || '';
                document.getElementById('default-enabled').checked = defaultConfig.enabled !== false;
                
                // åŠ è½½ Chat ID ç‰¹å®šé…ç½®
                const chatConfigs = configs.chat_configs || {};
                const container = document.getElementById('idle-hint-configs-body');
                
                if (Object.keys(chatConfigs).length === 0) {
                    container.innerHTML = `<div class="empty-state"><div class="icon">ğŸ“</div><div>æš‚æ—  Chat ID ç‰¹å®šé…ç½®</div></div>`;
                    return;
                }
                
                let html = '';
                for (const [chatId, config] of Object.entries(chatConfigs)) {
                    const statusBadge = config.enabled !== false 
                        ? '<span style="color: var(--accent-green);">âœ“ å¯ç”¨</span>'
                        : '<span style="color: var(--text-muted);">âœ— ç¦ç”¨</span>';
                    const templatePreview = (config.template || '').substring(0, 100) + (config.template && config.template.length > 100 ? '...' : '');
                    
                    html += `
                        <div class="table-row" style="grid-template-columns: 1.2fr 3fr 0.8fr 0.8fr;">
                            <div class="cell cell-code" title="${chatId}">${chatId.slice(0, 20)}...</div>
                            <div class="cell" style="font-family: 'JetBrains Mono', monospace; font-size: 11px; white-space: pre-wrap; word-break: break-all;" title="${config.template || ''}">${templatePreview}</div>
                            <div class="cell">${statusBadge}</div>
                            <div class="cell">
                                <button class="btn" style="padding: 4px 10px; font-size: 11px;" onclick="editIdleHintConfig('${chatId}')">ç¼–è¾‘</button>
                                <button class="btn btn-danger" style="padding: 4px 10px; font-size: 11px; margin-left: 8px;" onclick="deleteIdleHintConfig('${chatId}')">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                }
                container.innerHTML = html;
            } catch (error) {
                document.getElementById('idle-hint-configs-body').innerHTML = `<div class="empty-state" style="color: var(--accent-red);"><div class="icon">âŒ</div><div>åŠ è½½å¤±è´¥</div></div>`;
            }
        }

        async function saveDefaultConfig() {
            const template = document.getElementById('default-template').value;
            const enabled = document.getElementById('default-enabled').checked;
            
            if (!template.trim()) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯æ¨¡æ¿');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/api/idle-hint-config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        template: template,
                        enabled: enabled,
                        chat_id: null  // null è¡¨ç¤ºæ›´æ–°å…¨å±€é»˜è®¤é…ç½®
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… å…¨å±€é…ç½®å·²ä¿å­˜ï¼Œç«‹å³ç”Ÿæ•ˆ');
                    loadIdleHintConfigs();
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        function showAddIdleHintModal() {
            editingIdleHintChatId = null;
            document.getElementById('idle-hint-modal-title').textContent = 'æ·»åŠ  Chat ID é…ç½®';
            document.getElementById('idle-hint-chat-id').value = '';
            document.getElementById('idle-hint-chat-id').readOnly = false;
            document.getElementById('idle-hint-template').value = '';
            document.getElementById('idle-hint-enabled').checked = true;
            document.getElementById('idle-hint-modal').style.display = 'flex';
        }

        async function editIdleHintConfig(chatId) {
            editingIdleHintChatId = chatId;
            document.getElementById('idle-hint-modal-title').textContent = 'ç¼–è¾‘ Chat ID é…ç½®';
            document.getElementById('idle-hint-chat-id').value = chatId;
            document.getElementById('idle-hint-chat-id').readOnly = true;
            
            try {
                const data = await fetchData('/admin/api/idle-hint-config');
                const config = data.data?.chat_configs?.[chatId];
                if (config) {
                    document.getElementById('idle-hint-template').value = config.template || '';
                    document.getElementById('idle-hint-enabled').checked = config.enabled !== false;
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
            
            document.getElementById('idle-hint-modal').style.display = 'flex';
        }

        function closeIdleHintModal() {
            document.getElementById('idle-hint-modal').style.display = 'none';
            editingIdleHintChatId = null;
        }

        async function deleteIdleHintConfig(chatId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${chatId} çš„é…ç½®å—ï¼Ÿ\nåˆ é™¤åå°†ä½¿ç”¨å…¨å±€é»˜è®¤é…ç½®ã€‚`)) return;
            
            try {
                const result = await deleteData(`/admin/api/idle-hint-config/${encodeURIComponent(chatId)}`);
                if (result.success) {
                    alert('âœ… é…ç½®å·²åˆ é™¤');
                    loadIdleHintConfigs();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // ç©ºé—²æç¤ºé…ç½®è¡¨å•æäº¤
        document.getElementById('idle-hint-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const chatId = document.getElementById('idle-hint-chat-id').value.trim();
            const template = document.getElementById('idle-hint-template').value;
            const enabled = document.getElementById('idle-hint-enabled').checked;
            
            if (!chatId || !template.trim()) {
                alert('è¯·å¡«å†™ Chat ID å’Œæ¶ˆæ¯æ¨¡æ¿');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/api/idle-hint-config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        template: template,
                        enabled: enabled,
                        chat_id: chatId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(editingIdleHintChatId ? 'âœ… é…ç½®å·²æ›´æ–°' : 'âœ… é…ç½®å·²æ·»åŠ ');
                    closeIdleHintModal();
                    loadIdleHintConfigs();
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        });

        // å¯åŠ¨
        (async function init() {
            if (await checkAuth()) {
                showMainPage();
            } else {
                showLoginPage();
            }
        })();

        // è‡ªåŠ¨åˆ·æ–°
        setInterval(() => {
            if (!document.getElementById('main-page').classList.contains('hidden')) {
                refreshAll();
            }
        }, 30000);
    </script>
</body>
</html>
