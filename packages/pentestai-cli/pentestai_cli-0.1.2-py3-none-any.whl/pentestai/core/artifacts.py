from __future__ import annotations
import json, os, datetime
from pathlib import Path
from typing import Any, Dict, Optional
from pydantic import BaseModel

class Artifact(BaseModel):
    kind: str
    created_at: str
    data: Dict[str, Any]
    meta: Dict[str, Any] = {}

def now_iso() -> str:
    return datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z"

def save_artifact(path: Path, artifact: Artifact) -> None:
    path.parent.mkdir(parents=True, exist_ok=True)
    with open(path, "w", encoding="utf-8") as f:
        json.dump(artifact.model_dump(), f, ensure_ascii=False, indent=2)

def load_artifact(path: Path) -> Artifact:
    with open(path, "r", encoding="utf-8") as f:
        return Artifact(**json.load(f))

def ws_paths(workspace: Path) -> Dict[str, Path]:
    return {
        "workspace": workspace,
        "artifacts": workspace / "artifacts",
        "reports": workspace / "reports",
        "inputs": workspace / "inputs",
        "logs": workspace / "logs",
    }
