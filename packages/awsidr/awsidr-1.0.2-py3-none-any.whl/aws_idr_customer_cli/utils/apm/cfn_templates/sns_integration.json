{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "This CloudFormation Template deploys the AWS resouces needed to ingest alarms to Incident Detection and Response from an SNS topic. Prerequisite AWS resources include an already created SNS topic. The AWS resources deployed are below. - Custom Event Bus - Lambda subscription to existing SNS topic - Lambda execution role - Lambda transform function - Lambda resource-based policy permission",
    "Parameters": {
        "APMNameParameter": {
            "Type": "String",
            "Description": "Enter the name of the Application Performance Monitoring (APM) tool without any spaces. e.g. Prometheus, Grafana.",
            "AllowedPattern": "^[a-zA-Z0-9]*$",
            "ConstraintDescription": "The pattern allows only lowercase and uppercase alphabetical characters and numerals (^[a-zA-Z0-9]*$)."
        },
        "TriggerSNSParameter": {
            "Type": "String",
            "Description": "Enter the SNS topic of your APM. Example arn:aws:sns:eu-west-1:012345678912:grafana-sns"
        }
    },
    "Resources": {
        "CustomEventBus": {
            "Type": "AWS::Events::EventBus",
            "Properties": {
                "Name": {
                    "Fn::Sub": "${APMNameParameter}-AWSIncidentDetectionResponse-EventBus"
                }
            }
        },
        "TransformLambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Description": "IAM Role for Transform Lambda function to create logs and put events for customer Event Bus",
                "Policies": [
                    {
                        "PolicyName": {
                            "Fn::Sub": "IDR-TransformLambdaExecutionRolePolicy"
                        },
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": "logs:CreateLogGroup",
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": {
                                        "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${APMNameParameter}-AWSIncidentDetectionResponse-Lambda-Transform:*"
                                    }
                                },
                                {
                                    "Effect": "Allow",
                                    "Action": "events:PutEvents",
                                    "Resource": {
                                        "Fn::GetAtt": "CustomEventBus.Arn"
                                    }
                                }
                            ]
                        }
                    }
                ],
                "RoleName": {
                    "Fn::Sub": "IDR-TransformLambdaExecutionRole-${AWS::Region}"
                }
            },
            "DependsOn": [
                "CustomEventBus"
            ]
        },
        "TransformLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${APMNameParameter}-AWSIncidentDetectionResponse-Lambda-Transform"
                },
                "Description": "This function adds the necessary key:value pairs to the APM payload so that events can be ingested by AWS Incident Detection and Response.",
                "Runtime": "python3.12",
                "Timeout": 8,
                "Role": {
                    "Fn::GetAtt": "TransformLambdaExecutionRole.Arn"
                },
                "Environment": {
                    "Variables": {
                        "EnvEventBusName": {
                            "Ref": "CustomEventBus"
                        },
                        "INCIDENT_PATH": "alert[\"labels\"][\"alertname\"]"
                    }
                },
                "Handler": "index.lambda_handler",
                "Code": {
                    "ZipFile": "{{LAMBDA_CODE_PLACEHOLDER}}"
                }
            },
            "DependsOn": [
                "TransformLambdaExecutionRole"
            ]
        },
        "SNSSubscription": {
            "Type": "AWS::SNS::Subscription",
            "Properties": {
                "Protocol": "lambda",
                "Endpoint": {
                    "Fn::GetAtt": "TransformLambdaFunction.Arn"
                },
                "TopicArn": {
                    "Ref": "TriggerSNSParameter"
                }
            },
            "DependsOn": [
                "TransformLambdaFunction"
            ]
        },
        "TransformLambdaPermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "FunctionName": {
                    "Ref": "TransformLambdaFunction"
                },
                "Principal": "sns.amazonaws.com",
                "SourceArn": {
                    "Ref": "TriggerSNSParameter"
                },
                "SourceAccount": {
                    "Ref": "AWS::AccountId"
                }
            },
            "DependsOn": [
                "TransformLambdaFunction",
                "SNSSubscription"
            ]
        }
    }
}
