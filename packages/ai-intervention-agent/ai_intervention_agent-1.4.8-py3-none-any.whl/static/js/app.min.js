;(function redirectZeroHostToLoopback(){try{const url=new URL(window.location.href)
if(url.hostname==='0.0.0.0'){url.hostname='127.0.0.1'
console.warn(`æ£€æµ‹åˆ°è®¿é—®åœ°å€ä¸º 0.0.0.0ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢ä¸º ${url.origin}ï¼ˆé¿å…æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜ï¼‰`)
window.location.replace(url.toString())}}catch(e){}})()
let config=null
let hourglassAnimation=null
function initHourglassAnimation(){const container=document.getElementById('hourglass-lottie')
if(!container){console.warn('åŠ¨ç”»å®¹å™¨æœªæ‰¾åˆ°')
return}
if(typeof lottie==='undefined'){console.warn('Lottie åº“æœªåŠ è½½ï¼Œæ˜¾ç¤ºå¤‡ç”¨å›¾æ ‡')
container.textContent='ğŸŒ±'
return}
try{if(hourglassAnimation){hourglassAnimation.destroy()}
hourglassAnimation=lottie.loadAnimation({container:container,renderer:'svg',loop:true,autoplay:true,path:'/static/lottie/sprout.json',rendererSettings:{preserveAspectRatio:'xMidYMid meet'}})
hourglassAnimation.addEventListener('DOMLoaded',()=>{updateLottieAnimationColor()})
hourglassAnimation.addEventListener('error',()=>{console.warn('Lottie åŠ¨ç”»åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå¤‡ç”¨å›¾æ ‡')
container.textContent='ğŸŒ±'})
console.log('âœ… å«©èŠ½åŠ¨ç”»åˆå§‹åŒ–æˆåŠŸ')}catch(error){console.error('Lottie åŠ¨ç”»åˆå§‹åŒ–å¤±è´¥:',error)
container.textContent='ğŸŒ±'}}
function updateLottieAnimationColor(){const container=document.getElementById('hourglass-lottie')
if(!container)return
const isLightTheme=document.documentElement.getAttribute('data-theme')==='light'
if(isLightTheme){container.style.filter='none'}else{container.style.filter='invert(1)'}
console.log('âœ… Lottie åŠ¨ç”»é¢œè‰²å·²æ›´æ–°:',isLightTheme?'æµ…è‰²æ¨¡å¼ï¼ˆåŸè‰²ï¼‰':'æ·±è‰²æ¨¡å¼ï¼ˆåè½¬ï¼‰')}
window.addEventListener('theme-changed',event=>{console.log('ä¸»é¢˜å˜æ›´äº‹ä»¶:',event.detail)
setTimeout(updateLottieAnimationColor,50)})
function renderMarkdownContent(element,content,isMarkdown=false){requestAnimationFrame(()=>{if(content){let htmlContent=content
if(isMarkdown&&typeof marked!=='undefined'){try{htmlContent=marked.parse(content)}catch(e){console.warn('marked.js è§£æå¤±è´¥:',e)}}
const fragment=document.createDocumentFragment()
const tempDiv=document.createElement('div')
tempDiv.innerHTML=htmlContent
while(tempDiv.firstChild){fragment.appendChild(tempDiv.firstChild)}
element.innerHTML=''
element.appendChild(fragment)
processCodeBlocks(element)
processStrikethrough(element)
const textContent=element.textContent||''
if(window.loadMathJaxIfNeeded){window.loadMathJaxIfNeeded(element,textContent)}else if(window.MathJax&&window.MathJax.typesetPromise){window.MathJax.typesetPromise([element]).catch(err=>{console.warn('MathJax æ¸²æŸ“å¤±è´¥:',err)})}}else{element.textContent='åŠ è½½ä¸­...'}})}
function processCodeBlocks(container){const codeBlocks=container.querySelectorAll('pre')
codeBlocks.forEach(pre=>{if(pre.parentElement&&pre.parentElement.classList.contains('code-block-container')){return}
const codeContainer=document.createElement('div')
codeContainer.className='code-block-container'
pre.parentNode.insertBefore(codeContainer,pre)
codeContainer.appendChild(pre)
const codeElement=pre.querySelector('code')
let language='text'
if(codeElement&&codeElement.className){const langMatch=codeElement.className.match(/language-(\w+)/)
if(langMatch){language=langMatch[1]}}
const toolbar=document.createElement('div')
toolbar.className='code-toolbar'
if(language!=='text'){const langLabel=document.createElement('span')
langLabel.className='language-label'
langLabel.textContent=language.toUpperCase()
toolbar.appendChild(langLabel)}
const copyButton=DOMSecurity.createCopyButton(pre.textContent||'')
toolbar.appendChild(copyButton)
codeContainer.appendChild(toolbar)})}
async function copyCodeToClipboard(preElement,button){const checkIconSvg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" style="width: 14px; height: 14px; margin-right: 4px; vertical-align: middle;"><path fill-rule="evenodd" clip-rule="evenodd" d="M13.7803 4.21967C14.0732 4.51256 14.0732 4.98744 13.7803 5.28033L6.78033 12.2803C6.48744 12.5732 6.01256 12.5732 5.71967 12.2803L2.21967 8.78033C1.92678 8.48744 1.92678 8.01256 2.21967 7.71967C2.51256 7.42678 2.98744 7.42678 3.28033 7.71967L6.25 10.6893L12.7197 4.21967C13.0126 3.92678 13.4874 3.92678 13.7803 4.21967Z"/></svg>'
const errorIconSvg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" style="width: 14px; height: 14px; margin-right: 4px; vertical-align: middle;"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.21967 4.21967C4.51256 3.92678 4.98744 3.92678 5.28033 4.21967L8 6.93934L10.7197 4.21967C11.0126 3.92678 11.4874 3.92678 11.7803 4.21967C12.0732 4.51256 12.0732 4.98744 11.7803 5.28033L9.06066 8L11.7803 10.7197C12.0732 11.0126 12.0732 11.4874 11.7803 11.7803C11.4874 12.0732 11.0126 12.0732 10.7197 11.7803L8 9.06066L5.28033 11.7803C4.98744 12.0732 4.51256 12.0732 4.21967 11.7803C3.92678 11.4874 3.92678 11.0126 4.21967 10.7197L6.93934 8L4.21967 5.28033C3.92678 4.98744 3.92678 4.51256 4.21967 4.21967Z"/></svg>'
try{const codeElement=preElement.querySelector('code')
const textToCopy=codeElement?codeElement.textContent:preElement.textContent
await navigator.clipboard.writeText(textToCopy)
const originalHTML=button.innerHTML
button.innerHTML=checkIconSvg+'å·²å¤åˆ¶'
button.classList.add('copied')
setTimeout(()=>{button.innerHTML=originalHTML
button.classList.remove('copied')},2000)}catch(err){console.error('å¤åˆ¶å¤±è´¥:',err)
const originalHTML=button.innerHTML
button.innerHTML=errorIconSvg+'å¤åˆ¶å¤±è´¥'
button.classList.add('error')
setTimeout(()=>{button.innerHTML=originalHTML
button.classList.remove('error')},2000)}}
function processStrikethrough(container){const walker=document.createTreeWalker(container,NodeFilter.SHOW_TEXT,{acceptNode:function(node){const parent=node.parentElement
if(parent&&(parent.tagName==='CODE'||parent.tagName==='PRE'||parent.tagName==='SCRIPT'||parent.tagName==='STYLE'||parent.closest('pre, code, script, style'))){return NodeFilter.FILTER_REJECT}
return NodeFilter.FILTER_ACCEPT}})
const textNodes=[]
let node
while((node=walker.nextNode())){textNodes.push(node)}
textNodes.forEach(textNode=>{const text=textNode.textContent
const strikethroughRegex=/~~([^~\n]+?)~~/g
if(strikethroughRegex.test(text)){const newHTML=text.replace(strikethroughRegex,'<del>$1</del>')
const tempDiv=document.createElement('div')
tempDiv.innerHTML=newHTML
const fragment=document.createDocumentFragment()
while(tempDiv.firstChild){fragment.appendChild(tempDiv.firstChild)}
textNode.parentNode.replaceChild(fragment,textNode)}})}
async function loadConfig(){try{const response=await fetch('/api/config')
config=await response.json()
if(!config.has_content){showNoContentPage()
return}
showContentPage()
const descriptionElement=document.getElementById('description')
renderMarkdownContent(descriptionElement,config.prompt_html||config.prompt)
if(config.predefined_options&&config.predefined_options.length>0){const optionsContainer=document.getElementById('options-container')
const separator=document.getElementById('separator')
config.predefined_options.forEach((option,index)=>{const optionDiv=document.createElement('div')
optionDiv.className='option-item'
const checkbox=document.createElement('input')
checkbox.type='checkbox'
checkbox.id=`option-${index}`
checkbox.value=option
const label=document.createElement('label')
label.htmlFor=`option-${index}`
label.textContent=option
optionDiv.appendChild(checkbox)
optionDiv.appendChild(label)
optionsContainer.appendChild(optionDiv)})
optionsContainer.style.display='block'
separator.style.display='block'}}catch(error){console.error('åŠ è½½é…ç½®å¤±è´¥:',error)
showStatus('åŠ è½½é…ç½®å¤±è´¥','error')
throw error}}
function showNoContentPage(){document.getElementById('content-container').style.display='none'
document.getElementById('no-content-container').style.display='flex'
document.body.classList.add('no-content-mode')
const taskTabsContainer=document.getElementById('task-tabs-container')
if(taskTabsContainer){taskTabsContainer.classList.add('hidden')}
if(config){document.getElementById('no-content-buttons').style.display='block'}}
function showContentPage(){document.getElementById('content-container').style.display='block'
document.getElementById('no-content-container').style.display='none'
document.body.classList.remove('no-content-mode')
enableSubmitButton()}
function disableSubmitButton(){const submitBtn=document.getElementById('submit-btn')
const insertBtn=document.getElementById('insert-code-btn')
const feedbackText=document.getElementById('feedback-text')
if(submitBtn){submitBtn.disabled=true
submitBtn.style.backgroundColor='#3a3a3c'
submitBtn.style.color='#8e8e93'
submitBtn.style.cursor='not-allowed'}
if(insertBtn){insertBtn.disabled=true
insertBtn.style.backgroundColor='#3a3a3c'
insertBtn.style.color='#8e8e93'
insertBtn.style.cursor='not-allowed'}
if(feedbackText){feedbackText.disabled=true
feedbackText.style.backgroundColor='#2c2c2e'
feedbackText.style.color='#8e8e93'
feedbackText.style.cursor='not-allowed'}}
function enableSubmitButton(){const submitBtn=document.getElementById('submit-btn')
const insertBtn=document.getElementById('insert-code-btn')
const feedbackText=document.getElementById('feedback-text')
if(submitBtn){submitBtn.disabled=false
submitBtn.style.backgroundColor='#0a84ff'
submitBtn.style.color='#ffffff'
submitBtn.style.cursor='pointer'}
if(insertBtn){insertBtn.disabled=false
insertBtn.style.backgroundColor='#48484a'
insertBtn.style.color='#ffffff'
insertBtn.style.cursor='pointer'}
if(feedbackText){feedbackText.disabled=false
feedbackText.style.backgroundColor='rgba(255, 255, 255, 0.03)'
feedbackText.style.color='#f5f5f7'
feedbackText.style.cursor='text'}}
function showStatus(message,type){const noContentContainer=document.getElementById('no-content-container')
const isNoContentPage=noContentContainer&&noContentContainer.style.display==='flex'
if(!isNoContentPage&&type!=='error'){console.log(`[showStatus] è·³è¿‡éé”™è¯¯æç¤º: ${message} (${type})`)
return}
const statusElement=isNoContentPage?document.getElementById('no-content-status-message'):document.getElementById('status-message')
if(!statusElement)return
statusElement.textContent=message
statusElement.className=`status-message status-${type}`
statusElement.style.display='block'
if(type==='success'){setTimeout(()=>{statusElement.style.display='none'},3000)}}
async function insertCodeFromClipboard(){try{const text=await navigator.clipboard.readText()
if(text){const textarea=document.getElementById('feedback-text')
const cursorPos=textarea.selectionStart
const currentText=textarea.value
const textBefore=currentText.substring(0,cursorPos)
const textAfter=currentText.substring(cursorPos)
let codeBlock=`\n\`\`\`\n${text}\n\`\`\``
if(cursorPos===0){codeBlock=`\`\`\`\n${text}\n\`\`\``}
textarea.value=textBefore+codeBlock+textAfter
const newCursorPos=textBefore.length+codeBlock.length
textarea.setSelectionRange(newCursorPos,newCursorPos)
textarea.focus()
showStatus('ä»£ç å·²æ’å…¥','success')}else{showStatus('å‰ªè´´æ¿ä¸ºç©º','error')}}catch(error){console.error('è¯»å–å‰ªè´´æ¿å¤±è´¥:',error)
showStatus('æ— æ³•è¯»å–å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´ä»£ç ','error')}}
async function submitFeedback(){const feedbackText=document.getElementById('feedback-text').value.trim()
const selectedOptions=[]
const optionsContainer=document.getElementById('options-container')
if(optionsContainer){const checkboxes=optionsContainer.querySelectorAll('input[type="checkbox"]:checked')
checkboxes.forEach(checkbox=>{if(checkbox.value){selectedOptions.push(checkbox.value)}})}
if(!feedbackText&&selectedOptions.length===0&&selectedImages.length===0){showStatus('è¯·è¾“å…¥åé¦ˆå†…å®¹ã€é€‰æ‹©é¢„å®šä¹‰é€‰é¡¹æˆ–ä¸Šä¼ å›¾ç‰‡','error')
return}
try{const submitBtn=document.getElementById('submit-btn')
submitBtn.disabled=true
submitBtn.innerHTML='æäº¤ä¸­...'
const formData=new FormData()
formData.append('feedback_text',feedbackText)
formData.append('selected_options',JSON.stringify(selectedOptions))
selectedImages.forEach((img,index)=>{if(img.file){formData.append(`image_${index}`,img.file)}})
const currentTaskId=window.activeTaskId
const submitUrl=currentTaskId?`/api/tasks/${currentTaskId}/submit`:'/api/submit'
console.log(`ä½¿ç”¨æäº¤ç«¯ç‚¹: ${submitUrl}`)
const response=await fetch(submitUrl,{method:'POST',body:formData})
const result=await response.json()
if(response.ok){showStatus(result.message,'success')
document.getElementById('feedback-text').value=''
document.querySelectorAll('input[type="checkbox"]').forEach(cb=>(cb.checked=false))
clearAllImages()
if(currentTaskId){if(typeof taskTextareaContents!=='undefined'){delete taskTextareaContents[currentTaskId]}
if(typeof taskOptionsStates!=='undefined'){delete taskOptionsStates[currentTaskId]}
if(typeof taskImages!=='undefined'){delete taskImages[currentTaskId]}}
if(typeof refreshTasksList==='function'){console.log('è°ƒç”¨ refreshTasksList åˆ·æ–°ä»»åŠ¡åˆ—è¡¨...')
await refreshTasksList()}else{if(config){config.has_content=false
console.log('åé¦ˆæäº¤åï¼Œæœ¬åœ°çŠ¶æ€å·²æ›´æ–°ä¸ºæ— å†…å®¹')}
showNoContentPage()}}else{showStatus(result.message||'æäº¤å¤±è´¥','error')}}catch(error){console.error('æäº¤å¤±è´¥:',error)
showStatus('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•','error')}finally{const submitBtn=document.getElementById('submit-btn')
submitBtn.disabled=false
submitBtn.innerHTML=`
      <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M3.29289 3.29289C3.68342 2.90237 4.31658 2.90237 4.70711 3.29289L10.7071 9.29289C11.0976 9.68342 11.0976 10.3166 10.7071 10.7071L4.70711 16.7071C4.31658 17.0976 3.68342 17.0976 3.29289 16.7071C2.90237 16.3166 2.90237 15.6834 3.29289 15.2929L8.58579 10L3.29289 4.70711C2.90237 4.31658 2.90237 3.68342 3.29289 3.29289ZM9.29289 3.29289C9.68342 2.90237 10.3166 2.90237 10.7071 3.29289L16.7071 9.29289C17.0976 9.68342 17.0976 10.3166 16.7071 10.7071L10.7071 16.7071C10.3166 17.0976 9.68342 17.0976 9.29289 16.7071C8.90237 16.3166 8.90237 15.6834 9.29289 15.2929L14.5858 10L9.29289 4.70711C8.90237 4.31658 8.90237 3.68342 9.29289 3.29289Z"/>
      </svg>
      å‘é€è¯·æ±‚
    `}}
async function closeInterface(){try{showStatus('æ­£åœ¨å…³é—­æœåŠ¡...','info')
stopContentPolling()
const response=await fetch('/api/close',{method:'POST',headers:{'Content-Type':'application/json'}})
const result=await response.json()
if(response.ok){showStatus('æœåŠ¡å·²å…³é—­ï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...','success')}else{showStatus('å…³é—­å¤±è´¥ï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...','error')}}catch(error){console.error('å…³é—­ç•Œé¢å¤±è´¥:',error)
showStatus('å…³é—­ç•Œé¢å¤±è´¥ï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...','error')}
setTimeout(()=>{refreshPageSafely()},2000)}
function refreshPageSafely(){console.log('æ­£åœ¨åˆ·æ–°é¡µé¢...')
try{window.location.reload()}catch(reloadError){console.error('é¡µé¢åˆ·æ–°å¤±è´¥:',reloadError)
try{window.location.href=window.location.origin}catch(redirectError){console.error('é¡µé¢è·³è½¬å¤±è´¥:',redirectError)
try{window.location.href='about:blank'}catch(blankError){console.error('æ‰€æœ‰é¡µé¢æ“ä½œéƒ½å¤±è´¥:',blankError)}}}}
function stopContentPolling(){console.log('[app.js] stopContentPolling è¢«è°ƒç”¨ï¼Œä½†è½®è¯¢å·²åœç”¨')}
let selectedImages=[]
class NotificationManager{constructor(){this.isSupported='Notification'in window
this.permission=this.isSupported?Notification.permission:'denied'
this.audioContext=null
this.audioBuffers=new Map()
this.config={enabled:true,webEnabled:true,soundEnabled:true,soundVolume:0.8,soundMute:false,autoRequestPermission:true,timeout:5000,icon:'/icons/icon.svg',mobileOptimized:true,mobileVibrate:true}
this.init()}
async init(){console.log('åˆå§‹åŒ–é€šçŸ¥ç®¡ç†å™¨...')
if(!this.isSupported){console.warn('æµè§ˆå™¨ä¸æ”¯æŒWeb Notification API')
return}
if(this.config.autoRequestPermission&&this.permission==='default'){await this.requestPermission()}
await this.initAudio()
console.log('é€šçŸ¥ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ')}
async requestPermission(){if(!this.isSupported){console.warn('æµè§ˆå™¨ä¸æ”¯æŒWeb Notification API')
return false}
try{if(Notification.requestPermission.length===0){this.permission=await Notification.requestPermission()}else{this.permission=await new Promise(resolve=>{Notification.requestPermission(resolve)})}
console.log(`é€šçŸ¥æƒé™çŠ¶æ€: ${this.permission}`)
return this.permission==='granted'}catch(error){console.error('è¯·æ±‚é€šçŸ¥æƒé™å¤±è´¥:',error)
return false}}
async initAudio(){try{const AudioContextClass=window.AudioContext||window.webkitAudioContext||window.mozAudioContext
if(!AudioContextClass){console.warn('æµè§ˆå™¨ä¸æ”¯æŒWeb Audio API')
return}
this.audioContext=new AudioContextClass()
await this.loadAudioFile('default','/sounds/deng[å™”].mp3')
console.log('éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ')}catch(error){console.warn('éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:',error)
this.config.soundEnabled=false}}
async loadAudioFile(name,url){if(!this.audioContext)return false
try{const response=await fetch(url)
const arrayBuffer=await response.arrayBuffer()
const audioBuffer=await this.audioContext.decodeAudioData(arrayBuffer)
this.audioBuffers.set(name,audioBuffer)
console.log(`éŸ³é¢‘æ–‡ä»¶åŠ è½½æˆåŠŸ: ${name}`)
return true}catch(error){console.warn(`éŸ³é¢‘æ–‡ä»¶åŠ è½½å¤±è´¥ ${name}:`,error)
return false}}
async showNotification(title,message,options={}){if(!this.config.enabled||!this.config.webEnabled){console.log('Webé€šçŸ¥å·²ç¦ç”¨')
return null}
if(!this.isSupported){console.warn('æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ')
this.showFallbackNotification(title,message)
return null}
if(this.permission!=='granted'){console.warn('æ²¡æœ‰é€šçŸ¥æƒé™')
if(this.config.autoRequestPermission){await this.requestPermission()
if(this.permission!=='granted'){this.showFallbackNotification(title,message)
return null}}else{this.showFallbackNotification(title,message)
return null}}
try{const notificationOptions={body:message,icon:options.icon||this.config.icon,badge:options.badge||this.config.icon,tag:options.tag||'ai-intervention-agent',requireInteraction:options.requireInteraction||false,silent:options.silent||false,...options}
const notification=new Notification(title,notificationOptions)
if(this.config.timeout>0){setTimeout(()=>{notification.close()},this.config.timeout)}
notification.onclick=()=>{window.focus()
notification.close()
if(options.onClick){options.onClick()}}
if(this.config.mobileVibrate&&'vibrate'in navigator){navigator.vibrate([200,100,200])}
console.log('é€šçŸ¥å·²æ˜¾ç¤º:',title)
return notification}catch(error){console.error('æ˜¾ç¤ºé€šçŸ¥å¤±è´¥:',error)
return null}}
async playSound(soundName='default',volume=null,retryCount=0){if(!this.config.enabled||!this.config.soundEnabled||this.config.soundMute){console.log('å£°éŸ³é€šçŸ¥å·²ç¦ç”¨')
return false}
if(!this.audioContext){console.warn('éŸ³é¢‘ä¸Šä¸‹æ–‡æœªåˆå§‹åŒ–ï¼Œå°è¯•é™çº§æ–¹æ¡ˆ')
this.recordFallbackEvent('audio',{reason:'no_audio_context',soundName})
return this.playSoundFallback(soundName)}
if(this.audioContext.state==='suspended'){try{await this.audioContext.resume()
console.log('éŸ³é¢‘ä¸Šä¸‹æ–‡å·²æ¢å¤')}catch(error){console.warn('æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡å¤±è´¥:',error)
this.recordFallbackEvent('audio',{reason:'resume_failed',error:error.message,soundName})
return this.playSoundFallback(soundName)}}
const audioBuffer=this.audioBuffers.get(soundName)
if(!audioBuffer){console.warn(`éŸ³é¢‘æ–‡ä»¶æœªæ‰¾åˆ°: ${soundName}`)
if(soundName!=='default'){console.log('å°è¯•ä½¿ç”¨é»˜è®¤éŸ³é¢‘æ–‡ä»¶')
return this.playSound('default',volume,retryCount)}
this.recordFallbackEvent('audio',{reason:'buffer_not_found',soundName})
return this.playSoundFallback(soundName)}
try{const source=this.audioContext.createBufferSource()
const gainNode=this.audioContext.createGain()
source.buffer=audioBuffer
source.connect(gainNode)
gainNode.connect(this.audioContext.destination)
const finalVolume=volume!==null?volume:this.config.soundVolume
gainNode.gain.value=Math.max(0,Math.min(1,finalVolume))
source.addEventListener('ended',()=>{console.log(`å£°éŸ³æ’­æ”¾å®Œæˆ: ${soundName}`)})
source.addEventListener('error',error=>{console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:',error)
this.recordFallbackEvent('audio',{reason:'playback_error',error:error.message,soundName})})
source.start(0)
console.log(`æ’­æ”¾å£°éŸ³: ${soundName}`)
return true}catch(error){console.error('æ’­æ”¾å£°éŸ³å¤±è´¥:',error)
this.recordFallbackEvent('audio',{reason:'playback_failed',error:error.message,soundName})
if(retryCount<2){console.log(`é‡è¯•æ’­æ”¾å£°éŸ³ (${retryCount + 1}/2): ${soundName}`)
await new Promise(resolve=>setTimeout(resolve,500))
return this.playSound(soundName,volume,retryCount+1)}
return this.playSoundFallback(soundName)}}
playSoundFallback(soundName){console.log(`ä½¿ç”¨éŸ³é¢‘é™çº§æ–¹æ¡ˆ: ${soundName}`)
try{const audio=new Audio(`/sounds/${soundName === 'default' ? 'deng[å™”].mp3' : soundName + '.mp3'}`)
audio.volume=this.config.soundVolume
const playPromise=audio.play()
if(playPromise!==undefined){playPromise.then(()=>{console.log('HTML5 Audioæ’­æ”¾æˆåŠŸ')}).catch(error=>{console.warn('HTML5 Audioæ’­æ”¾å¤±è´¥:',error)
this.vibrateFallback()})}
return true}catch(error){console.warn('HTML5 Audioé™çº§å¤±è´¥:',error)
return this.vibrateFallback()}}
vibrateFallback(){if(this.config.mobileVibrate&&'vibrate'in navigator){try{navigator.vibrate([200,100,200])
console.log('ä½¿ç”¨æŒ¯åŠ¨æé†’')
return true}catch(error){console.warn('æŒ¯åŠ¨æé†’å¤±è´¥:',error)}}
console.log('æ‰€æœ‰éŸ³é¢‘é™çº§æ–¹æ¡ˆéƒ½å¤±è´¥äº†')
return false}
async sendNotification(title,message,options={}){const results=[]
const promises=[]
if(this.config.webEnabled){promises.push(this.showNotification(title,message,options).then(notification=>({type:'web',success:notification!==null})))}
if(this.config.soundEnabled){promises.push(this.playSound(options.sound).then(soundSuccess=>({type:'sound',success:soundSuccess})))}
if(promises.length>0){try{const promiseResults=await Promise.all(promises)
results.push(...promiseResults)}catch(error){console.warn('é€šçŸ¥æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:',error)}}
return results}
showFallbackNotification(title,message,options={}){console.log(`é™çº§é€šçŸ¥: ${title} - ${message}`)
if(typeof showStatus==='function'){showStatus(`${title}: ${message}`,'info')}
this.flashTitle(title)
if(!this.isSupported||this.permission==='denied'){this.showInPageNotification(title,message,options)}
console.log(`%cğŸ”” ${title}`,'color: #0084ff; font-weight: bold; font-size: 14px;')
console.log(`%c${message}`,'color: #666; font-size: 12px;')
this.recordFallbackEvent('notification',{title,message,reason:options.reason||'unknown'})}
flashTitle(message){const originalTitle=document.title
let flashCount=0
const maxFlashes=6
const flashInterval=setInterval(()=>{document.title=flashCount%2===0?`ğŸ”” ${message}`:originalTitle
flashCount++
if(flashCount>=maxFlashes){clearInterval(flashInterval)
document.title=originalTitle}},1000)}
updateConfig(newConfig){this.config={...this.config,...newConfig}
console.log('é€šçŸ¥é…ç½®å·²æ›´æ–°:',this.config)}
getStatus(){return{supported:this.isSupported,permission:this.permission,audioContext:this.audioContext?this.audioContext.state:'unavailable',config:this.config}}
showInPageNotification(title,message,options={}){const notification=DOMSecurity.createNotification(title,message)
notification.style.cssText=`
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(30, 30, 40, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      padding: 1rem;
      max-width: 300px;
      z-index: 10000;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      color: #f5f5f7;
      font-family: inherit;
    `
const titleEl=notification.querySelector('.in-page-notification-title')
const messageEl=notification.querySelector('.in-page-notification-message')
const closeEl=notification.querySelector('.in-page-notification-close')
titleEl.style.cssText='font-weight: 600; margin-bottom: 0.5rem; font-size: 1rem;'
messageEl.style.cssText='font-size: 0.9rem; line-height: 1.4; color: rgba(245, 245, 247, 0.8);'
closeEl.style.cssText=`
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: none;
      border: none;
      color: rgba(245, 245, 247, 0.6);
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0.25rem;
      border-radius: 4px;
      transition: all 0.2s ease;
    `
document.body.appendChild(notification)
closeEl.addEventListener('click',()=>{notification.style.transform='translateX(100%)'
notification.style.opacity='0'
setTimeout(()=>{if(notification.parentNode){notification.parentNode.removeChild(notification)}},300)})
closeEl.addEventListener('mouseenter',()=>{closeEl.style.background='rgba(255, 255, 255, 0.1)'
closeEl.style.color='#f5f5f7'})
closeEl.addEventListener('mouseleave',()=>{closeEl.style.background='none'
closeEl.style.color='rgba(245, 245, 247, 0.6)'})
notification.style.transform='translateX(100%)'
notification.style.transition='all 0.3s ease-out'
setTimeout(()=>{notification.style.transform='translateX(0)'},10)
setTimeout(()=>{if(notification.parentNode){closeEl.click()}},options.timeout||5000)
return notification}
recordFallbackEvent(type,data){const event={type,data,timestamp:Date.now(),userAgent:navigator.userAgent,url:window.location.href}
try{const storageKey='ai-intervention-fallback-events'
const events=JSON.parse(localStorage.getItem(storageKey)||'[]')
const sevenDaysAgo=Date.now()-7*24*60*60*1000
const validEvents=events.filter(e=>e.timestamp>sevenDaysAgo)
validEvents.push(event)
if(validEvents.length>50){validEvents.splice(0,validEvents.length-50)}
localStorage.setItem(storageKey,JSON.stringify(validEvents))
this.monitorLocalStorageUsage(storageKey)}catch(error){console.warn('æ— æ³•è®°å½•é™çº§äº‹ä»¶:',error)
this.cleanupLocalStorage()}
if(this.config.debug){console.log('é™çº§äº‹ä»¶è®°å½•:',event)}}
monitorLocalStorageUsage(key){try{const data=localStorage.getItem(key)
if(data){const sizeInBytes=new Blob([data]).size
const sizeInKB=(sizeInBytes/1024).toFixed(2)
if(sizeInBytes>100*1024){console.warn(`localStorageäº‹ä»¶è®°å½•è¿‡å¤§: ${sizeInKB}KBï¼Œå»ºè®®æ¸…ç†`)}
if(this.config.debug){console.log(`localStorageäº‹ä»¶è®°å½•å¤§å°: ${sizeInKB}KB`)}}}catch(error){console.warn('æ— æ³•ç›‘æ§localStorageä½¿ç”¨æƒ…å†µ:',error)}}
cleanupLocalStorage(){try{const storageKey='ai-intervention-fallback-events'
const events=JSON.parse(localStorage.getItem(storageKey)||'[]')
const oneDayAgo=Date.now()-24*60*60*1000
const recentEvents=events.filter(e=>e.timestamp>oneDayAgo)
if(recentEvents.length>20){recentEvents.splice(0,recentEvents.length-20)}
localStorage.setItem(storageKey,JSON.stringify(recentEvents))
console.log(`localStorageæ¸…ç†å®Œæˆï¼Œä¿ç•™ ${recentEvents.length} ä¸ªäº‹ä»¶`)}catch(error){console.error('localStorageæ¸…ç†å¤±è´¥:',error)
try{localStorage.removeItem('ai-intervention-fallback-events')
console.log('å·²æ¸…ç©ºlocalStorageäº‹ä»¶è®°å½•')}catch(clearError){console.error('æ— æ³•æ¸…ç©ºlocalStorage:',clearError)}}}}
const notificationManager=new NotificationManager()
class SettingsManager{constructor(){this.storageKey='ai-intervention-agent-settings'
this.defaultSettings={enabled:true,webEnabled:true,autoRequestPermission:true,soundEnabled:true,soundMute:false,soundVolume:80,mobileOptimized:true,mobileVibrate:true,barkEnabled:false,barkUrl:'https://api.day.app/push',barkDeviceKey:'',barkIcon:'',barkAction:'none'}
this.initialized=false}
async init(){if(this.initialized)return
this.settings=await this.loadSettings()
this.initEventListeners()
this.initialized=true
console.log('SettingsManager åˆå§‹åŒ–å®Œæˆ')}
async loadSettings(){try{const response=await fetch('/api/get-notification-config')
if(response.ok){const result=await response.json()
if(result.status==='success'){const serverConfig=result.config
const settings={enabled:serverConfig.enabled??this.defaultSettings.enabled,webEnabled:serverConfig.web_enabled??this.defaultSettings.webEnabled,autoRequestPermission:serverConfig.auto_request_permission??this.defaultSettings.autoRequestPermission,soundEnabled:serverConfig.sound_enabled??this.defaultSettings.soundEnabled,soundMute:serverConfig.sound_mute??this.defaultSettings.soundMute,soundVolume:serverConfig.sound_volume??this.defaultSettings.soundVolume,mobileOptimized:serverConfig.mobile_optimized??this.defaultSettings.mobileOptimized,mobileVibrate:serverConfig.mobile_vibrate??this.defaultSettings.mobileVibrate,barkEnabled:serverConfig.bark_enabled??this.defaultSettings.barkEnabled,barkUrl:serverConfig.bark_url??this.defaultSettings.barkUrl,barkDeviceKey:serverConfig.bark_device_key??this.defaultSettings.barkDeviceKey,barkIcon:serverConfig.bark_icon??this.defaultSettings.barkIcon,barkAction:serverConfig.bark_action??this.defaultSettings.barkAction}
console.log('ä»æœåŠ¡å™¨åŠ è½½é…ç½®æˆåŠŸ')
return settings}}}catch(error){console.warn('ä»æœåŠ¡å™¨åŠ è½½é…ç½®å¤±è´¥ï¼Œå°è¯•localStorage:',error)}
try{const stored=localStorage.getItem(this.storageKey)
if(stored){const parsed=JSON.parse(stored)
return{...this.defaultSettings,...parsed}}}catch(error){console.warn('åŠ è½½è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®:',error)}
return{...this.defaultSettings}}
saveSettings(){try{localStorage.setItem(this.storageKey,JSON.stringify(this.settings))
console.log('è®¾ç½®å·²ä¿å­˜')}catch(error){console.error('ä¿å­˜è®¾ç½®å¤±è´¥:',error)}}
updateSetting(key,value){this.settings[key]=value
this.saveSettings()
this.applySettings()
console.log(`è®¾ç½®å·²æ›´æ–°: ${key} = ${value}`)}
applySettings(){if(notificationManager){notificationManager.updateConfig({enabled:this.settings.enabled,webEnabled:this.settings.webEnabled,autoRequestPermission:this.settings.autoRequestPermission,soundEnabled:this.settings.soundEnabled,soundMute:this.settings.soundMute,soundVolume:this.settings.soundVolume/100,mobileOptimized:this.settings.mobileOptimized,mobileVibrate:this.settings.mobileVibrate,barkEnabled:this.settings.barkEnabled,barkUrl:this.settings.barkUrl,barkDeviceKey:this.settings.barkDeviceKey,barkIcon:this.settings.barkIcon,barkAction:this.settings.barkAction})}
this.syncConfigToBackend()}
async syncConfigToBackend(){try{const response=await fetch('/api/update-notification-config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(this.settings)})
const result=await response.json()
if(response.ok&&result.status==='success'){console.log('åç«¯é€šçŸ¥é…ç½®å·²åŒæ­¥')}else{console.warn('åŒæ­¥åç«¯é…ç½®å¤±è´¥:',result.message)}}catch(error){console.error('åŒæ­¥åç«¯é…ç½®å¤±è´¥:',error)}}
resetSettings(){this.settings={...this.defaultSettings}
this.saveSettings()
this.updateUI()
this.applySettings()
console.log('è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼')}
updateUI(){document.getElementById('notification-enabled').checked=this.settings.enabled
document.getElementById('web-notification-enabled').checked=this.settings.webEnabled
document.getElementById('auto-request-permission').checked=this.settings.autoRequestPermission
document.getElementById('sound-notification-enabled').checked=this.settings.soundEnabled
document.getElementById('sound-mute').checked=this.settings.soundMute
document.getElementById('sound-volume').value=this.settings.soundVolume
document.querySelector('.volume-value').textContent=`${this.settings.soundVolume}%`
document.getElementById('mobile-optimized').checked=this.settings.mobileOptimized
document.getElementById('mobile-vibrate').checked=this.settings.mobileVibrate
document.getElementById('bark-notification-enabled').checked=this.settings.barkEnabled
document.getElementById('bark-url').value=this.settings.barkUrl
document.getElementById('bark-device-key').value=this.settings.barkDeviceKey
document.getElementById('bark-icon').value=this.settings.barkIcon
document.getElementById('bark-action').value=this.settings.barkAction}
getStatusIcon(type){const icons={success:`<svg class="status-icon status-icon-success" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px; color: #4CAF50;"><polyline points="20 6 9 17 4 12"></polyline></svg>`,error:`<svg class="status-icon status-icon-error" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px; color: #F44336;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,warning:`<svg class="status-icon status-icon-warning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px; color: #FF9800;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,paused:`<svg class="status-icon status-icon-paused" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px; color: #9E9E9E;"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`}
return icons[type]||icons.warning}
updateStatus(){const browserSupportHtml=notificationManager.isSupported?this.getStatusIcon('success')+'æ”¯æŒ':this.getStatusIcon('error')+'ä¸æ”¯æŒ'
let permissionHtml
if(notificationManager.permission==='granted'){permissionHtml=this.getStatusIcon('success')+'å·²æˆæƒ'}else if(notificationManager.permission==='denied'){permissionHtml=this.getStatusIcon('error')+'å·²æ‹’ç»'}else{permissionHtml=this.getStatusIcon('warning')+'æœªè¯·æ±‚'}
let audioStateHtml=this.getStatusIcon('error')+'ä¸å¯ç”¨'
if(notificationManager.audioContext){const state=notificationManager.audioContext.state
switch(state){case'running':audioStateHtml=this.getStatusIcon('success')+'è¿è¡Œä¸­'
break
case'suspended':audioStateHtml=this.getStatusIcon('paused')+'å·²æš‚åœ'
break
case'closed':audioStateHtml=this.getStatusIcon('error')+'å·²å…³é—­'
break
default:audioStateHtml=this.getStatusIcon('warning')+state}}
document.getElementById('browser-support-status').innerHTML=browserSupportHtml
document.getElementById('notification-permission-status').innerHTML=permissionHtml
document.getElementById('audio-status').innerHTML=audioStateHtml}
initEventListeners(){const settingsBtn=document.getElementById('settings-btn')
const settingsCloseBtn=document.getElementById('settings-close-btn')
const testNotificationBtn=document.getElementById('test-notification-btn')
const testBarkNotificationBtn=document.getElementById('test-bark-notification-btn')
const resetSettingsBtn=document.getElementById('reset-settings-btn')
if(settingsBtn){settingsBtn.addEventListener('click',e=>{e.stopPropagation()
this.showSettings()})}
if(settingsCloseBtn){settingsCloseBtn.addEventListener('click',()=>this.hideSettings())}
if(testNotificationBtn){testNotificationBtn.addEventListener('click',()=>this.testNotification())}
if(testBarkNotificationBtn){testBarkNotificationBtn.addEventListener('click',()=>this.testBarkNotification())}
if(resetSettingsBtn){resetSettingsBtn.addEventListener('click',()=>this.resetSettings())}
document.addEventListener('click',e=>{if(e.target.id==='settings-panel'){this.hideSettings()}})
document.addEventListener('change',e=>{const settingMap={'notification-enabled':'enabled','web-notification-enabled':'webEnabled','auto-request-permission':'autoRequestPermission','sound-notification-enabled':'soundEnabled','sound-mute':'soundMute','mobile-optimized':'mobileOptimized','mobile-vibrate':'mobileVibrate','bark-notification-enabled':'barkEnabled'}
if(settingMap[e.target.id]){this.updateSetting(settingMap[e.target.id],e.target.checked)}else if(e.target.id==='sound-volume'){this.updateSetting('soundVolume',parseInt(e.target.value))
document.querySelector('.volume-value').textContent=`${e.target.value}%`}else if(e.target.id==='bark-url'){this.updateSetting('barkUrl',e.target.value)}else if(e.target.id==='bark-device-key'){this.updateSetting('barkDeviceKey',e.target.value)}else if(e.target.id==='bark-icon'){this.updateSetting('barkIcon',e.target.value)}else if(e.target.id==='bark-action'){this.updateSetting('barkAction',e.target.value)}})}
async showSettings(){if(!this.initialized){try{await this.init()}catch(e){console.warn('SettingsManager åˆå§‹åŒ–å¤±è´¥ï¼ˆæ‰“å¼€è®¾ç½®é¢æ¿æ—¶ï¼‰:',e)}}
const panel=document.getElementById('settings-panel')
if(panel){const container=document.querySelector('.container')
if(container){container.style.overflow='visible'}
panel.classList.remove('hidden')
panel.style.display='flex'
this.applySettingsTheme()}
try{this.settings=await this.loadSettings()}catch(e){console.warn('æ‰“å¼€è®¾ç½®é¢æ¿æ—¶åˆ·æ–°é…ç½®å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨å½“å‰è®¾ç½®:',e)}
this.updateUI()
this.updateStatus()}
applySettingsTheme(){const theme=document.documentElement.getAttribute('data-theme')
if(!document.getElementById('settings-light-theme-styles')){const style=document.createElement('style')
style.id='settings-light-theme-styles'
style.textContent=`
        [data-theme="light"] .settings-panel {
          background: rgba(0, 0, 0, 0.7) !important;
        }
        [data-theme="light"] .settings-content {
          background: #faf9f5 !important;
          border: 1px solid rgba(0, 0, 0, 0.12) !important;
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2), 0 10px 20px rgba(0, 0, 0, 0.1) !important;
        }
        [data-theme="light"] .settings-body {
          background: #faf9f5 !important;
        }
        [data-theme="light"] .setting-group {
          background: #ffffff !important;
          border: 1px solid rgba(0, 0, 0, 0.1) !important;
        }
        [data-theme="light"] .setting-subgroup {
          background: #f8f8f5 !important;
        }
        [data-theme="light"] .settings-header {
          border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
          background: #f2f1ec !important;
        }
        [data-theme="light"] .status-row {
          background: rgba(0, 0, 0, 0.02) !important;
          border-color: rgba(0, 0, 0, 0.08) !important;
          color: #141413 !important;
        }
        [data-theme="light"] .status-row span:first-child {
          color: rgba(20, 20, 19, 0.85) !important;
        }
        [data-theme="light"] .status-row span:last-child {
          color: #141413 !important;
        }
        [data-theme="light"] .setting-description {
          color: rgba(20, 20, 19, 0.65) !important;
        }
        [data-theme="light"] .setting-item:hover .setting-description {
          color: rgba(20, 20, 19, 0.75) !important;
        }
        [data-theme="light"] .setting-label:hover .setting-title {
          color: rgba(20, 20, 19, 0.9) !important;
        }
        [data-theme="light"] .setting-input::placeholder {
          color: rgba(20, 20, 19, 0.5) !important;
        }
        [data-theme="light"] .setting-label,
        [data-theme="light"] .setting-subgroup-title,
        [data-theme="light"] .settings-main-title,
        [data-theme="light"] #settings-title {
          color: #141413 !important;
        }
        [data-theme="light"] .setting-input {
          background: #ffffff !important;
          border-color: rgba(0, 0, 0, 0.15) !important;
          color: #141413 !important;
        }
        [data-theme="light"] .setting-select {
          background: #ffffff !important;
          border-color: rgba(0, 0, 0, 0.15) !important;
          color: #141413 !important;
        }
      `
document.head.appendChild(style)}}
hideSettings(){const panel=document.getElementById('settings-panel')
if(panel){const container=document.querySelector('.container')
if(container){container.style.overflow=''}
panel.classList.add('hidden')
panel.style.display='none'}}
async testNotification(){try{await notificationManager.sendNotification('è®¾ç½®æµ‹è¯•','è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯å½“å‰è®¾ç½®æ˜¯å¦æ­£å¸¸å·¥ä½œ',{tag:'settings-test',requireInteraction:false})
showStatus('æµ‹è¯•é€šçŸ¥å·²å‘é€','success')}catch(error){console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:',error)
showStatus('æµ‹è¯•é€šçŸ¥å¤±è´¥: '+error.message,'error')}}
async testBarkNotification(){try{if(!this.settings.barkEnabled){showStatus('è¯·å…ˆå¯ç”¨ Bark é€šçŸ¥','warning')
return}
if(!this.settings.barkUrl||!this.settings.barkDeviceKey){showStatus('è¯·å…ˆé…ç½® Bark URL å’Œ Device Key','warning')
return}
showStatus('æ­£åœ¨å‘é€ Bark æµ‹è¯•é€šçŸ¥...','info')
const response=await fetch('/api/test-bark',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bark_url:this.settings.barkUrl,bark_device_key:this.settings.barkDeviceKey,bark_icon:this.settings.barkIcon,bark_action:this.settings.barkAction})})
const result=await response.json()
if(response.ok&&result.status==='success'){showStatus(result.message,'success')
console.log('Bark é€šçŸ¥å‘é€æˆåŠŸ:',result)}else{showStatus(result.message||'Bark é€šçŸ¥å‘é€å¤±è´¥','error')
console.error('Bark é€šçŸ¥å‘é€å¤±è´¥:',result)}}catch(error){console.error('Bark æµ‹è¯•é€šçŸ¥å¤±è´¥:',error)
showStatus('Bark æµ‹è¯•é€šçŸ¥å¤±è´¥: '+error.message,'error')}}}
const settingsManager=new SettingsManager()
function debounce(func,wait){let timeout
return function executedFunction(...args){const later=()=>{clearTimeout(timeout)
func(...args)}
clearTimeout(timeout)
timeout=setTimeout(later,wait)}}
function throttle(func,limit){let inThrottle
return function(...args){if(!inThrottle){func.apply(this,args)
inThrottle=true
setTimeout(()=>(inThrottle=false),limit)}}}
function rafUpdate(callback){if(window.requestAnimationFrame){requestAnimationFrame(callback)}else{setTimeout(callback,16)}}
const SUPPORTED_IMAGE_TYPES=['image/jpeg','image/jpg','image/png','image/gif','image/webp','image/bmp','image/svg+xml']
const MAX_IMAGE_SIZE=10*1024*1024
const MAX_IMAGE_COUNT=10
const MAX_IMAGE_DIMENSION=1920
const COMPRESS_QUALITY=0.8
function validateImageFile(file){if(typeof ValidationUtils!=='undefined'){const result=ValidationUtils.validateImageFile(file)
return result.errors}
const errors=[]
if(!file||!file.type){errors.push('æ— æ•ˆçš„æ–‡ä»¶å¯¹è±¡')
return errors}
if(!SUPPORTED_IMAGE_TYPES.includes(file.type)){errors.push(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${file.type}`)}
if(file.size>MAX_IMAGE_SIZE){errors.push(`æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶: ${(file.size / 1024 / 1024).toFixed(2)}MB > 10MB`)}
if(file.name&&file.name.length>255){errors.push('æ–‡ä»¶åè¿‡é•¿')}
return errors}
function sanitizeFileName(fileName){if(typeof ValidationUtils!=='undefined'){return ValidationUtils.sanitizeFilename(fileName,100)}
return fileName.replace(/[<>:"/\\|?*]/g,'').replace(/\s+/g,'_').trim().substring(0,100)}
let objectURLs=new Set()
let urlToFileMap=new WeakMap()
let urlCreationTime=new Map()
function createObjectURL(file){try{const url=URL.createObjectURL(file)
objectURLs.add(url)
urlToFileMap.set(file,url)
urlCreationTime.set(url,Date.now())
setTimeout(()=>{if(objectURLs.has(url)){console.warn(`è‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„URLå¯¹è±¡: ${url}`)
revokeObjectURL(url)}},30*60*1000)
return url}catch(error){console.error('åˆ›å»ºObject URLå¤±è´¥:',error)
return null}}
function revokeObjectURL(url){if(!url)return
try{if(objectURLs.has(url)){URL.revokeObjectURL(url)
objectURLs.delete(url)
urlCreationTime.delete(url)
console.debug(`å·²æ¸…ç†URLå¯¹è±¡: ${url}`)}}catch(error){console.error('æ¸…ç†URLå¯¹è±¡å¤±è´¥:',error)}}
function cleanupAllObjectURLs(){console.log(`å¼€å§‹æ¸…ç† ${objectURLs.size} ä¸ªURLå¯¹è±¡`)
const startTime=performance.now()
objectURLs.forEach(url=>{try{URL.revokeObjectURL(url)}catch(error){console.error(`æ¸…ç†URLå¤±è´¥: ${url}`,error)}})
objectURLs.clear()
urlCreationTime.clear()
const endTime=performance.now()
console.log(`URLå¯¹è±¡æ¸…ç†å®Œæˆï¼Œè€—æ—¶: ${(endTime - startTime).toFixed(2)}ms`)}
function startPeriodicCleanup(){setInterval(()=>{const now=Date.now()
const expiredUrls=[]
urlCreationTime.forEach((creationTime,url)=>{if(now-creationTime>20*60*1000){expiredUrls.push(url)}})
if(expiredUrls.length>0){console.log(`å®šæœŸæ¸…ç† ${expiredUrls.length} ä¸ªè¿‡æœŸURLå¯¹è±¡`)
expiredUrls.forEach(url=>revokeObjectURL(url))}},5*60*1000)}
function compressImage(file){return new Promise(resolve=>{if(file.type==='image/svg+xml'||file.type==='image/gif'){resolve(file)
return}
const MAX_RETURN_BYTES=2*1024*1024
const forceCompress=file.size>MAX_RETURN_BYTES
const isLargeFile=file.size>5*1024*1024
const canvas=document.createElement('canvas')
const ctx=canvas.getContext('2d',{alpha:file.type==='image/png',willReadFrequently:false})
if(!ctx){resolve(file)
return}
const img=new Image()
const objectURL=createObjectURL(file)
img.onload=()=>{let{width,height}=img
const originalArea=width*height
let maxDimension=MAX_IMAGE_DIMENSION
if(forceCompress||isLargeFile||originalArea>4000000){maxDimension=Math.min(MAX_IMAGE_DIMENSION,1200)}
if(width>maxDimension||height>maxDimension){const ratio=Math.min(maxDimension/width,maxDimension/height)
width=Math.floor(width*ratio)
height=Math.floor(height*ratio)}
let currentWidth=width
let currentHeight=height
canvas.width=currentWidth
canvas.height=currentHeight
ctx.imageSmoothingEnabled=true
ctx.imageSmoothingQuality='high'
let quality=COMPRESS_QUALITY
if(isLargeFile){quality=Math.max(0.6,COMPRESS_QUALITY-0.2)}
if(forceCompress){quality=Math.min(quality,0.75)}
const mimeCandidates=[]
if(file.type==='image/png'){if(forceCompress||isLargeFile||originalArea>4000000){mimeCandidates.push('image/webp','image/jpeg')}else{mimeCandidates.push('image/png')}}else if(file.type==='image/webp'){mimeCandidates.push('image/webp','image/jpeg')}else{if(forceCompress){mimeCandidates.push('image/webp','image/jpeg')}else{mimeCandidates.push('image/jpeg')}}
const getExtensionForMime=mimeType=>{if(mimeType==='image/png')return'.png'
if(mimeType==='image/webp')return'.webp'
if(mimeType==='image/jpeg')return'.jpg'
return null}
const replaceExtension=(filename,newExt)=>{if(!filename||!newExt)return filename
const safeName=sanitizeFileName(filename)
const withoutExt=safeName.replace(/\.[^/.]+$/,'')
return`${withoutExt}${newExt}`}
const logCompression=(blob,finalName)=>{try{const ratio=((1-blob.size/file.size)*100).toFixed(1)
console.log(`å›¾ç‰‡å‹ç¼©: ${file.name} ${(file.size / 1024).toFixed(2)}KB â†’ ${(
              blob.size / 1024
            ).toFixed(2)}KB (å‹ç¼©ç‡: ${ratio}%) è¾“å‡º: ${finalName}`)}catch(_){}}
let attempt=0
const MAX_ATTEMPTS=8
const tryToBlob=mimeIndex=>{const outType=mimeCandidates[mimeIndex]
if(!outType){resolve(file)
return}
canvas.toBlob(blob=>{if(!blob)return tryToBlob(mimeIndex+1)
if(!blob.type)return tryToBlob(mimeIndex+1)
const finalMimeType=blob.type||outType
const ext=getExtensionForMime(finalMimeType)
const finalName=ext?replaceExtension(file.name,ext):file.name
const compressedFile=new File([blob],finalName,{type:finalMimeType,lastModified:file.lastModified})
if(!forceCompress){if(blob.size<file.size){logCompression(blob,finalName)
resolve(compressedFile)}else{resolve(file)}
return}
if(blob.size<=MAX_RETURN_BYTES){logCompression(blob,finalName)
resolve(compressedFile)
return}
attempt++
if(attempt>=MAX_ATTEMPTS){console.warn(`å›¾ç‰‡å‹ç¼©ï¼šå·²è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œä½†ä»è¶…è¿‡ ${(MAX_RETURN_BYTES / 1024 / 1024).toFixed(
                  1
                )}MBï¼Œå°†è¿”å›å½“å‰å‹ç¼©ç‰ˆæœ¬`)
logCompression(blob,finalName)
resolve(compressedFile)
return}
if(quality>0.55){quality=Math.max(0.55,quality-0.1)
return tryToBlob(0)}
const nextWidth=Math.max(320,Math.floor(currentWidth*0.85))
const nextHeight=Math.max(320,Math.floor(currentHeight*0.85))
if(nextWidth===currentWidth&&nextHeight===currentHeight){logCompression(blob,finalName)
resolve(compressedFile)
return}
currentWidth=nextWidth
currentHeight=nextHeight
canvas.width=currentWidth
canvas.height=currentHeight
ctx.imageSmoothingEnabled=true
ctx.imageSmoothingQuality='high'
rafUpdate(()=>{ctx.drawImage(img,0,0,currentWidth,currentHeight)
tryToBlob(0)})},outType,quality)}
rafUpdate(()=>{ctx.drawImage(img,0,0,currentWidth,currentHeight)
revokeObjectURL(objectURL)
tryToBlob(0)})}
img.onerror=()=>{revokeObjectURL(objectURL)
resolve(file)}
img.src=objectURL})}
async function addImageToList(file){if(selectedImages.length>=MAX_IMAGE_COUNT){showStatus(`æœ€å¤šåªèƒ½ä¸Šä¼  ${MAX_IMAGE_COUNT} å¼ å›¾ç‰‡`,'error')
return false}
const errors=validateImageFile(file)
if(errors.length>0){showStatus(errors.join('; '),'error')
return false}
const isDuplicate=selectedImages.some(img=>img.name===file.name&&img.size===file.size&&img.lastModified===file.lastModified)
if(isDuplicate){showStatus('è¯¥å›¾ç‰‡å·²ç»æ·»åŠ è¿‡äº†','error')
return false}
const imageId=Date.now()+Math.random()
try{const timestamp=Date.now()
const imageItem={id:imageId,file:file,name:file.name,size:file.size,base64:null,timestamp:timestamp,lastModified:file.lastModified}
selectedImages.push(imageItem)
renderImagePreview(imageItem,true)
updateImageCounter()
const processedFile=await compressImage(file)
imageItem.file=processedFile
imageItem.size=processedFile.size
const previewUrl=createObjectURL(processedFile)
if(previewUrl){imageItem.previewUrl=previewUrl}else{throw new Error('åˆ›å»ºé¢„è§ˆURLå¤±è´¥')}
renderImagePreview(imageItem,false)
console.log('å›¾ç‰‡æ·»åŠ æˆåŠŸ:',file.name,`(${(imageItem.size / 1024).toFixed(2)}KB)`)
return true}catch(error){console.error('å›¾ç‰‡å¤„ç†å¤±è´¥:',error)
showStatus('å›¾ç‰‡å¤„ç†å¤±è´¥: '+error.message,'error')
try{const failed=selectedImages.find(img=>img.id===imageId)
if(failed&&failed.previewUrl&&failed.previewUrl.startsWith('blob:')){revokeObjectURL(failed.previewUrl)}}catch(_){}
selectedImages=selectedImages.filter(img=>img.id!==imageId)
const previewElement=document.getElementById(`preview-${imageId}`)
if(previewElement){previewElement.remove()}
updateImageCounter()
updateImagePreviewVisibility()
return false}}
let domUpdateQueue=[]
let domUpdateScheduled=false
function scheduleDOMUpdate(callback){domUpdateQueue.push(callback)
if(!domUpdateScheduled){domUpdateScheduled=true
rafUpdate(()=>{const fragment=document.createDocumentFragment()
domUpdateQueue.forEach(callback=>callback(fragment))
domUpdateQueue=[]
domUpdateScheduled=false})}}
function renderImagePreview(imageItem,isLoading=false){rafUpdate(()=>{const previewContainer=document.getElementById('image-previews')
if(!previewContainer){console.error('å›¾ç‰‡é¢„è§ˆå®¹å™¨ #image-previews æœªæ‰¾åˆ°ï¼Œæ— æ³•æ¸²æŸ“é¢„è§ˆ')
return}
let previewElement=document.getElementById(`preview-${imageItem.id}`)
if(!previewElement){previewElement=document.createElement('div')
previewElement.id=`preview-${imageItem.id}`
previewElement.className='image-preview-item'
previewContainer.appendChild(previewElement)}
const replacePreviewChildren=(container,built)=>{const fragment=document.createDocumentFragment()
while(built.firstChild){fragment.appendChild(built.firstChild)}
DOMSecurity.replaceContent(container,fragment)}
const newPreviewElement=DOMSecurity.createImagePreview(imageItem,isLoading)
replacePreviewChildren(previewElement,newPreviewElement)
if(!isLoading&&imageItem.previewUrl){const img=new Image()
img.onload=()=>{rafUpdate(()=>{const updatedPreviewElement=DOMSecurity.createImagePreview(imageItem,false)
replacePreviewChildren(previewElement,updatedPreviewElement)})}
img.src=imageItem.previewUrl}})}
function sanitizeText(text){const div=document.createElement('div')
div.textContent=text
return div.innerHTML}
function removeImage(imageId){const imageToRemove=selectedImages.find(img=>img.id==imageId)
if(imageToRemove&&imageToRemove.previewUrl&&imageToRemove.previewUrl.startsWith('blob:')){revokeObjectURL(imageToRemove.previewUrl)}
selectedImages=selectedImages.filter(img=>img.id!=imageId)
const previewElement=document.getElementById(`preview-${imageId}`)
if(previewElement){previewElement.remove()}
updateImageCounter()
updateImagePreviewVisibility()}
function clearAllImages(){selectedImages.forEach(img=>{if(img.previewUrl&&img.previewUrl.startsWith('blob:')){revokeObjectURL(img.previewUrl)}})
selectedImages=[]
const previewContainer=document.getElementById('image-previews')
DOMSecurity.clearContent(previewContainer)
updateImageCounter()
updateImagePreviewVisibility()
if(window.gc&&typeof window.gc==='function'){setTimeout(()=>window.gc(),1000)}
console.log('æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤ï¼Œå†…å­˜å·²é‡Šæ”¾')}
function cleanupOnUnload(){cleanupAllObjectURLs()
clearAllImages()}
window.addEventListener('beforeunload',cleanupOnUnload)
window.addEventListener('pagehide',cleanupOnUnload)
function updateImageCounter(){const countElement=document.getElementById('image-count')
if(countElement){countElement.textContent=selectedImages.length}}
function updateImagePreviewVisibility(){const container=document.getElementById('image-preview-container')
if(!container)return
if(selectedImages.length>0){container.classList.remove('hidden')
container.classList.add('visible')}else{container.classList.add('hidden')
container.classList.remove('visible')}}
async function handleFileUpload(files){const fileArray=Array.from(files)
const maxConcurrent=3
let processed=0
let successful=0
if(fileArray.length>1){showStatus(`æ­£åœ¨å¤„ç† ${fileArray.length} ä¸ªæ–‡ä»¶...`,'info')}
for(let i=0;i<fileArray.length;i+=maxConcurrent){const batch=fileArray.slice(i,i+maxConcurrent)
const batchPromises=batch.map(async file=>{try{const success=await addImageToList(file)
if(success)successful++
processed++
if(fileArray.length>1){showStatus(`å¤„ç†è¿›åº¦: ${processed}/${fileArray.length}`,'info')}
return success}catch(error){console.error('æ–‡ä»¶å¤„ç†å¤±è´¥:',file.name,error)
processed++
return false}})
await Promise.all(batchPromises)
if(i+maxConcurrent<fileArray.length){await new Promise(resolve=>setTimeout(resolve,50))}}
updateImagePreviewVisibility()
if(fileArray.length>1){showStatus(`å®Œæˆå¤„ç†: ${successful}/${fileArray.length} ä¸ªæ–‡ä»¶æˆåŠŸ`,successful>0?'success':'error')}else if(fileArray.length===1){showStatus(successful>0?'æ–‡ä»¶å¤„ç†æˆåŠŸ':'æ–‡ä»¶å¤„ç†å¤±è´¥',successful>0?'success':'error')}}
function initializeDragAndDrop(){const textarea=document.getElementById('feedback-text')
const dragOverlay=document.getElementById('drag-overlay')
let dragCounter=0
let dragTimer=null;['dragenter','dragover','dragleave','drop'].forEach(eventName=>{document.addEventListener(eventName,preventDefaults,{passive:false})})
function preventDefaults(e){e.preventDefault()
e.stopPropagation()}
const throttledDragEnter=throttle(e=>{dragCounter++
if(e.dataTransfer.types.includes('Files')){rafUpdate(()=>{dragOverlay.style.display='flex'
textarea.classList.add('textarea-drag-over')})}},100)
const throttledDragLeave=throttle(e=>{dragCounter--
if(dragCounter<=0){dragCounter=0
clearTimeout(dragTimer)
dragTimer=setTimeout(()=>{rafUpdate(()=>{dragOverlay.style.display='none'
textarea.classList.remove('textarea-drag-over')})},100)}},50)
const throttledDragOver=throttle(e=>{if(e.dataTransfer.types.includes('Files')){e.dataTransfer.dropEffect='copy'}},50)
document.addEventListener('dragenter',throttledDragEnter)
document.addEventListener('dragleave',throttledDragLeave)
document.addEventListener('dragover',throttledDragOver)
document.addEventListener('drop',function(e){dragCounter=0
clearTimeout(dragTimer)
rafUpdate(()=>{dragOverlay.style.display='none'
textarea.classList.remove('textarea-drag-over')})
if(e.dataTransfer.files.length>0){const totalFiles=selectedImages.length+e.dataTransfer.files.length
if(totalFiles>MAX_IMAGE_COUNT){showStatus(`æœ€å¤šåªèƒ½ä¸Šä¼  ${MAX_IMAGE_COUNT} å¼ å›¾ç‰‡`,'error')
return}
handleFileUpload(e.dataTransfer.files)}})}
function initializePasteFunction(){const textarea=document.getElementById('feedback-text')
const dataUriToFile=dataUri=>{try{const match=/^data:(image\/[a-zA-Z0-9.+-]+);base64,(.+)$/.exec(dataUri)
if(!match)return null
const mime=match[1]
const base64=match[2].replace(/\s+/g,'')
if(base64.length>15*1024*1024){console.warn('å‰ªè´´æ¿å›¾ç‰‡è¿‡å¤§ï¼ˆdata uriï¼‰ï¼Œå·²è·³è¿‡')
return null}
const binaryString=atob(base64)
const bytes=new Uint8Array(binaryString.length)
for(let i=0;i<binaryString.length;i++){bytes[i]=binaryString.charCodeAt(i)}
let ext='png'
if(mime==='image/jpeg')ext='jpg'
else if(mime==='image/webp')ext='webp'
else if(mime==='image/png')ext='png'
const filename=`pasted-image-${Date.now()}.${ext}`
return new File([bytes],filename,{type:mime,lastModified:Date.now()})}catch(err){console.warn('è§£æå‰ªè´´æ¿ data uri å›¾ç‰‡å¤±è´¥:',err)
return null}}
try{if(window.__aiInterventionAgentPasteHandler){document.removeEventListener('paste',window.__aiInterventionAgentPasteHandler)}}catch(_){}
const pasteHandler=async function(e){const clipboardData=e.clipboardData
if(!clipboardData)return
if(!textarea||document.activeElement!==textarea)return
const filesToAdd=[]
const items=Array.from(clipboardData.items||[])
for(const item of items){if(!item)continue
if(item.kind!=='file')continue
if(!item.type||!item.type.startsWith('image/'))continue
const file=item.getAsFile()
if(file)filesToAdd.push(file)}
if(filesToAdd.length===0){const files=Array.from(clipboardData.files||[])
for(const file of files){if(file&&file.type&&file.type.startsWith('image/')){filesToAdd.push(file)}}}
if(filesToAdd.length===0){const html=clipboardData.getData('text/html')||''
const text=clipboardData.getData('text/plain')||clipboardData.getData('text')||''
const combined=`${html}\n${text}`
const dataUriRegex=/data:image\/[a-zA-Z0-9.+-]+;base64,[A-Za-z0-9+/=\s]+/g
const matches=combined.match(dataUriRegex)||[]
for(const dataUri of matches.slice(0,MAX_IMAGE_COUNT)){const file=dataUriToFile(dataUri)
if(file)filesToAdd.push(file)}}
if(filesToAdd.length===0)return
const pastedText=(clipboardData.getData('text/plain')||clipboardData.getData('text')||'').trim()
if(!pastedText){e.preventDefault()}
let added=0
for(const file of filesToAdd){const ok=await addImageToList(file)
if(ok)added++}
updateImagePreviewVisibility()
if(added>0){showStatus(`ä»å‰ªè´´æ¿æ·»åŠ äº† ${added} å¼ å›¾ç‰‡`,'success')}}
window.__aiInterventionAgentPasteHandler=pasteHandler
document.addEventListener('paste',pasteHandler)}
function initializeFileSelection(){const fileInput=document.getElementById('file-upload-input')
const uploadBtn=document.getElementById('upload-image-btn')
uploadBtn.addEventListener('click',()=>{fileInput.click()})
fileInput.addEventListener('change',e=>{if(e.target.files.length>0){handleFileUpload(e.target.files)
e.target.value=''}})}
function openImageModal(base64,name,size){const modal=document.getElementById('image-modal')
const modalImage=document.getElementById('modal-image')
const modalInfo=document.getElementById('modal-info')
modalImage.src=base64
modalImage.alt=name
modalInfo.textContent=`${name} (${(size / 1024).toFixed(2)}KB)`
modal.classList.add('show')
document.addEventListener('keydown',handleModalKeydown)
modal.addEventListener('click',function(e){if(e.target===modal){closeImageModal()}})}
function closeImageModal(){const modal=document.getElementById('image-modal')
modal.classList.remove('show')
document.removeEventListener('keydown',handleModalKeydown)}
function handleModalKeydown(event){if(event.key==='Escape'){closeImageModal()}}
function isMobileDevice(){return(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||(navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&/MacIntel/.test(navigator.platform)))}
function detectPlatform(){const platform=navigator.platform.toLowerCase()
const userAgent=navigator.userAgent.toLowerCase()
if(platform.includes('mac')||userAgent.includes('mac')){return'mac'}else if(platform.includes('win')||userAgent.includes('win')){return'windows'}else if(platform.includes('linux')||userAgent.includes('linux')){return'linux'}
return'windows'}
function getShortcutText(platform){const shortcuts={mac:['âŒ˜+Enter  æäº¤åé¦ˆ','âŒ¥+C      æ’å…¥ä»£ç ','âŒ˜+V      ç²˜è´´å›¾ç‰‡','âŒ˜+U      ä¸Šä¼ å›¾ç‰‡','Delete   æ¸…é™¤å›¾ç‰‡'],windows:['Ctrl+Enter æäº¤åé¦ˆ','Alt+C      æ’å…¥ä»£ç ','Ctrl+V     ç²˜è´´å›¾ç‰‡','Ctrl+U     ä¸Šä¼ å›¾ç‰‡','Delete     æ¸…é™¤å›¾ç‰‡'],linux:['Ctrl+Enter æäº¤åé¦ˆ','Alt+C      æ’å…¥ä»£ç ','Ctrl+V     ç²˜è´´å›¾ç‰‡','Ctrl+U     ä¸Šä¼ å›¾ç‰‡','Delete     æ¸…é™¤å›¾ç‰‡']}
const lines=shortcuts[platform]||shortcuts.windows
return lines.join('\n')}
function initializeShortcutTooltip(){if(!isMobileDevice()){const platform=detectPlatform()
updateShortcutDisplay(platform)
console.log(`æ£€æµ‹åˆ°æ¡Œé¢å¹³å°: ${platform}ï¼Œå·²è®¾ç½®å¯¹åº”å¿«æ·é”®`)}else{console.log('æ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡ï¼Œå·²éšè—å¿«æ·é”®éƒ¨åˆ†')}}
function updateShortcutDisplay(platform){const isMac=platform==='mac'
const ctrlOrCmd=isMac?'Cmd':'Ctrl'
const altOrOption=isMac?'Option':'Alt'
const shortcuts={'shortcut-submit':`${ctrlOrCmd}+Enter`,'shortcut-code':`${altOrOption}+C`,'shortcut-paste':`${ctrlOrCmd}+V`,'shortcut-upload':`${ctrlOrCmd}+U`,'shortcut-delete':'Delete'}
Object.entries(shortcuts).forEach(([id,shortcut])=>{const element=document.getElementById(id)
if(element){element.textContent=shortcut}})}
function checkBrowserCompatibility(){const features={fileAPI:!!(window.File&&window.FileReader&&window.FileList&&window.Blob),dragDrop:'ondragstart'in document.createElement('div'),canvas:!!document.createElement('canvas').getContext,webWorker:!!window.Worker,requestAnimationFrame:!!(window.requestAnimationFrame||window.webkitRequestAnimationFrame),objectURL:!!(window.URL&&window.URL.createObjectURL),clipboard:!!(navigator.clipboard&&navigator.clipboard.read)}
console.log('æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹:',features)
if(!features.fileAPI){showStatus('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶APIï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨','warning')
return false}
if(!features.canvas){showStatus('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒCanvasï¼Œå›¾ç‰‡å‹ç¼©åŠŸèƒ½å°†è¢«ç¦ç”¨','warning')}
return true}
function setupFeatureFallbacks(){if(!window.requestAnimationFrame){window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){return setTimeout(callback,16)}}
if(!navigator.clipboard){console.warn('å‰ªè´´æ¿APIä¸å¯ç”¨ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ')}
if(!Object.assign){Object.assign=function(target,...sources){sources.forEach(source=>{if(source){Object.keys(source).forEach(key=>{target[key]=source[key]})}})
return target}}}
function initializeImageFeatures(){if(!checkBrowserCompatibility()){console.error('æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥å¤±è´¥')
return}
setupFeatureFallbacks()
try{initializeDragAndDrop()
initializePasteFunction()
initializeFileSelection()
const clearBtn=document.getElementById('clear-all-images-btn')
if(clearBtn){clearBtn.addEventListener('click',clearAllImages)}
console.log('å›¾ç‰‡åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ')}catch(error){console.error('å›¾ç‰‡åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥:',error)
showStatus('å›¾ç‰‡åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•','error')}}
function initializeApp(){initHourglassAnimation()
loadConfig().then(()=>{console.log('âœ… é…ç½®åŠ è½½å®Œæˆ')
console.log('å½“å‰é…ç½®:',{has_content:config.has_content,persistent:config.persistent,prompt_length:config.prompt?config.prompt.length:0})
if(typeof initMultiTaskSupport==='function'){initMultiTaskSupport()}}).catch(error=>{console.error('âŒ é…ç½®åŠ è½½å¤±è´¥:',error)
setTimeout(()=>{console.log('ğŸ”„ é…ç½®åŠ è½½å¤±è´¥ï¼Œå»¶è¿Ÿåˆå§‹åŒ–å¤šä»»åŠ¡æ”¯æŒ...')
if(typeof initMultiTaskSupport==='function'){initMultiTaskSupport()}},3000)})
initializeImageFeatures()
startPeriodicCleanup()
initializeShortcutTooltip()
settingsManager.init().catch(error=>{console.warn('è®¾ç½®ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:',error)})
notificationManager.init().then(()=>{console.log('é€šçŸ¥ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ')
settingsManager.applySettings()}).catch(error=>{console.warn('é€šçŸ¥ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:',error)})
document.getElementById('insert-code-btn').addEventListener('click',insertCodeFromClipboard)
document.getElementById('submit-btn').addEventListener('click',submitFeedback)
document.getElementById('close-btn').addEventListener('click',closeInterface)
document.addEventListener('keydown',event=>{const isMac=detectPlatform()==='mac'
const ctrlOrCmd=isMac?event.metaKey:event.ctrlKey
const altOrOption=isMac?event.altKey:event.altKey
if(ctrlOrCmd&&event.key==='Enter'){event.preventDefault()
submitFeedback()}else if(altOrOption&&event.key==='c'){event.preventDefault()
insertCodeFromClipboard()}else if(ctrlOrCmd&&event.key==='v'){console.log(`å¿«æ·é”®: ${isMac ? 'Cmd' : 'Ctrl'}+V ç²˜è´´`)}else if(ctrlOrCmd&&event.key==='u'){event.preventDefault()
document.getElementById('upload-image-btn').click()
console.log(`å¿«æ·é”®: ${isMac ? 'Cmd' : 'Ctrl'}+U ä¸Šä¼ å›¾ç‰‡`)}else if(event.key==='Delete'&&selectedImages.length>0){event.preventDefault()
clearAllImages()
console.log('å¿«æ·é”®: Delete æ¸…é™¤æ‰€æœ‰å›¾ç‰‡')}else if(ctrlOrCmd&&event.shiftKey&&event.key==='N'){event.preventDefault()
testNotification()
console.log(`å¿«æ·é”®: ${isMac ? 'Cmd' : 'Ctrl'}+Shift+N æµ‹è¯•é€šçŸ¥`)}})
function enableAudioOnFirstInteraction(){if(notificationManager.audioContext&&notificationManager.audioContext.state==='suspended'){notificationManager.audioContext.resume().then(()=>{console.log('éŸ³é¢‘ä¸Šä¸‹æ–‡å·²å¯ç”¨')}).catch(error=>{console.warn('å¯ç”¨éŸ³é¢‘ä¸Šä¸‹æ–‡å¤±è´¥:',error)})}}
document.addEventListener('click',enableAudioOnFirstInteraction,{once:true})
document.addEventListener('keydown',enableAudioOnFirstInteraction,{once:true})
document.addEventListener('touchstart',enableAudioOnFirstInteraction,{once:true})
async function testNotification(){try{await notificationManager.sendNotification('é€šçŸ¥æµ‹è¯•','è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯é€šçŸ¥åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ',{tag:'test-notification',requireInteraction:false})
showStatus('æµ‹è¯•é€šçŸ¥å·²å‘é€','success')}catch(error){console.error('æµ‹è¯•é€šçŸ¥å¤±è´¥:',error)
showStatus('æµ‹è¯•é€šçŸ¥å¤±è´¥','error')}}}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initializeApp)}else{initializeApp()}