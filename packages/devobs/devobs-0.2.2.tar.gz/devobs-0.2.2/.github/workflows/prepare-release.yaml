name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Semver-style tag for release (e.g., v1.0.0)
        required: true

jobs:
  create-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
      pull-requests: write
    steps:
      # TODO(lasuillard): Validate tag format more strictly (semver)
      - name: Check tag format
        run: |
          if [[ ! "${{ inputs.tag }}" =~ ^v ]]; then
            echo "Tag must start with 'v'"
            exit 1
          fi

      - uses: actions/checkout@v6

      # https://github.com/killercup/cargo-edit/issues/864
      - name: Set version
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew install cargo-edit
          tag="${{ inputs.tag }}"
          tag_no_v="${tag#v}"
          cargo set-version "$tag_no_v"

      - name: Generate GitHub App token
        uses: actions/create-github-app-token@v2
        id: generate-token
        with:
          app-id: ${{ vars.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Create pull request
        uses: peter-evans/create-pull-request@v8.0.0
        with:
          token: ${{ steps.generate-token.outputs.token }}
          sign-commits: true
          title: Release ${{ inputs.tag }}
          branch: release/${{ inputs.tag }}
          delete-branch: true
