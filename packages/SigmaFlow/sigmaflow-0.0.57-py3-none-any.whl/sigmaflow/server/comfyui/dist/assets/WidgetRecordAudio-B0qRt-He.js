var J=Object.defineProperty;var e=(u,s)=>J(u,"name",{value:s,configurable:!0});import{markRaw as Q,openBlock as b,createElementBlock as k,createElementVNode as h,ref as p,nextTick as X,onUnmounted as F,defineComponent as Y,computed as N,onMounted as Z,createVNode as V,unref as a,withCtx as ee,createTextVNode as te,toDisplayString as B,Fragment as ae,renderList as oe,normalizeStyle as ne,createCommentVNode as U}from"vue";import{Button as re}from"primevue";import{u as ie}from"./useWidgetValue-BBcazAQ2.js";import{r as q,t as _,L as le,y as O}from"./index-6STX4Oia.js";import{u as $}from"./audioService-k6JHBynD.js";import{ck as ue,cl as se}from"./vendor-other-_sromytg.js";import{f as ce}from"./audioUtils-j6qvA_Je.js";import"@primevue/themes";import"@primevue/themes/aura";import"./vendor-vue-CrN17A9b.js";import"primevue/config";import"primevue/confirmationservice";import"primevue/toastservice";import"primevue/tooltip";import"primevue/button";import"vue-i18n";import"primevue/message";import"primevue/skeleton";import"primevue/multiselect";import"primevue/inputtext";import"primevue/select";import"primevue/checkbox";import"primevue/divider";import"primevue/scrollpanel";import"primevue/usetoast";import"primevue/card";import"primevue/listbox";import"primevue/progressbar";import"primevue/floatlabel";import"@primevue/forms";import"@primevue/forms/resolvers/zod";import"primevue/password";import"primevue/progressspinner";import"primevue/tag";import"primevue/inputnumber";import"primevue/tabpanels";import"primevue/tabs";import"primevue/iconfield";import"primevue/inputicon";import"primevue/badge";import"primevue/chip";import"primevue/tabpanel";import"primevue/toggleswitch";import"primevue/colorpicker";import"primevue/radiobutton";import"primevue/knob";import"primevue/slider";import"primevue/panel";import"primevue/tabmenu";import"primevue/popover";import"primevue/tab";import"primevue/tablist";import"primevue/autocomplete";import"primevue/dropdown";import"./vendor-xterm-DV1MVhAx.js";import"./vendor-three-zdhtZbSm.js";import"primevue/galleria";import"primevue/tabview";import"primevue/contextmenu";import"primevue/tree";import"primevue/toolbar";import"primevue/selectbutton";import"primevue/dialog";import"primevue/confirmpopup";import"primevue/useconfirm";import"primevue/confirmdialog";import"./vendor-tiptap-D1RRboMA.js";import"primevue/blockui";const de={viewBox:"0 0 24 24",width:"1.2em",height:"1.2em"};function me(u,s){return b(),k("svg",de,s[0]||(s[0]=[h("g",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2"},[h("path",{d:"M12 19v3m7-12v2a7 7 0 0 1-14 0v-2"}),h("rect",{width:"6",height:"13",x:"9",y:"2",rx:"3"})],-1)]))}e(me,"render");const ve=Q({name:"lucide-mic",render:me});function pe(u,s={}){const i=p(!1),v=p(0),c=p(null);async function t(){if(!u.value)return!1;try{return await u.value.play(),i.value=!0,!0}catch(y){return console.warn("Audio playback failed:",y),i.value=!1,!1}}e(t,"play");function n(){u.value&&(u.value.pause(),u.value.currentTime=0),i.value=!1,s.onPlaybackEnded&&s.onPlaybackEnded()}e(n,"stop");function r(){i.value=!1,s.onPlaybackEnded&&s.onPlaybackEnded()}e(r,"onPlaybackEnded");function o(){u.value?.duration&&s.onMetadataLoaded&&s.onMetadataLoaded(u.value.duration)}e(o,"onMetadataLoaded");async function d(){v.value+=1,await X()}e(d,"resetAudioElement");function f(){return u.value?.currentTime||0}e(f,"getCurrentTime");function C(){return u.value?.duration||0}return e(C,"getDuration"),{isPlaying:i,audioElementKey:v,play:t,stop:n,onPlaybackEnded:r,onMetadataLoaded:o,resetAudioElement:d,getCurrentTime:f,getDuration:C,playbackTimerInterval:c}}e(pe,"useAudioPlayback");function fe(u={}){const s=p(!1),i=p(null),v=p([]),c=p(null),t=p(null);async function n(){try{t.value?.startsWith("blob:")&&URL.revokeObjectURL(t.value),v.value=[],t.value=null,await $().registerWavEncoder(),c.value=await navigator.mediaDevices.getUserMedia({audio:!0}),i.value=new ue(c.value,{mimeType:"audio/wav"}),i.value.ondataavailable=f=>{v.value.push(f.data)},i.value.onstop=async()=>{const f=new Blob(v.value,{type:"audio/wav"});t.value?.startsWith("blob:")&&URL.revokeObjectURL(t.value),t.value=URL.createObjectURL(f),u.onRecordingComplete&&await u.onRecordingComplete(f),o()},i.value.start(100),s.value=!0}catch(f){throw u.onError&&u.onError(f),f}}e(n,"startRecording");function r(){i.value&&i.value.state!=="inactive"?i.value.stop():o()}e(r,"stopRecording");function o(){s.value=!1,c.value&&(c.value.getTracks().forEach(f=>f.stop()),c.value=null)}e(o,"cleanup");function d(){r(),t.value&&(URL.revokeObjectURL(t.value),t.value=null)}return e(d,"dispose"),F(()=>{d()}),{isRecording:s,recordedURL:t,mediaRecorder:i,startRecording:n,stopRecording:r,dispose:d}}e(fe,"useAudioRecorder");function ge(u={}){const{barCount:s=18,minHeight:i=4,maxHeight:v=32}=u,c=p(Array.from({length:s},()=>({height:16}))),t=p(null),n=p(null),r=p(null),o=p(null),d=p(null);function f(){c.value=Array.from({length:s},()=>({height:Math.random()*(v-i)+i}))}e(f,"initWaveform");function C(g){g.value&&(n.value&&r.value?y():w(),o.value=requestAnimationFrame(()=>C(g)))}e(C,"updateWaveform");function y(){if(!n.value||!r.value)return;n.value.getByteFrequencyData(r.value);const g=Math.floor(r.value.length/s);c.value=c.value.map((z,I)=>{let S=0;for(let E=0;E<g;E++)S+=r.value[I*g+E]||0;return{height:S/g/255*(v-i)+i}})}e(y,"updateWaveformFromAudio");function w(){c.value=c.value.map(g=>({height:Math.max(i,Math.min(v,g.height+(Math.random()-.5)*4))}))}e(w,"updateWaveformRandom");async function W(){t.value&&t.value.state!=="closed"&&await t.value.close(),t.value=null,d.value=null}e(W,"setupAudioContext");async function x(g){t.value=new window.AudioContext,n.value=t.value.createAnalyser(),t.value.createMediaStreamSource(g).connect(n.value),n.value.fftSize=256,r.value=new Uint8Array(n.value.frequencyBinCount)}e(x,"setupRecordingVisualization");async function M(g){return t.value&&t.value.state!=="closed"&&await t.value.close(),d.value=null,g?(t.value=new window.AudioContext,n.value=t.value.createAnalyser(),d.value=t.value.createMediaElementSource(g),d.value.connect(n.value),n.value.connect(t.value.destination),n.value.fftSize=256,r.value=new Uint8Array(n.value.frequencyBinCount),!0):!1}e(M,"setupPlaybackVisualization");function P(){o.value&&(cancelAnimationFrame(o.value),o.value=null)}e(P,"stopWaveform");function L(){P(),t.value&&t.value.state!=="closed"&&t.value.close(),t.value=null,d.value=null}return e(L,"dispose"),F(()=>{L()}),{waveformBars:c,initWaveform:f,updateWaveform:C,setupAudioContext:W,setupRecordingVisualization:x,setupPlaybackVisualization:M,stopWaveform:P,dispose:L}}e(ge,"useAudioWaveform");const ye={class:"relative"},he={class:"mb-4"},be={key:0,class:"flex h-14 w-[413px] items-center gap-4 rounded-lg px-4 bg-node-component-surface text-text-secondary"},ke={class:"flex min-w-30 items-center gap-2"},we={class:"min-w-20 text-xs"},xe={class:"min-w-10 text-sm"},Re={class:"flex h-8 flex-1 items-center gap-2 overflow-x-clip"},_e=["title"],Ae=["title"],Ce=["title"],Pe=["title"],Ee=["src"],qt=Y({__name:"WidgetRecordAudio",props:{widget:{},readonly:{type:Boolean},modelValue:{},nodeId:{}},emits:["update:modelValue"],setup(u,{emit:s}){const i=s,v=u,c=p();let t="";const n=fe({onRecordingComplete:I,onError:e(()=>{O().addAlert(_("g.micPermissionDenied")||"Microphone permission denied")},"onError")}),r=ge({barCount:18,minHeight:4,maxHeight:32}),o=pe(c,{onPlaybackEnded:H,onMetadataLoaded:e(m=>{!x.value&&!y.value&&(d.value=Math.floor(m))},"onMetadataLoaded")}),d=p(0),{pause:f,resume:C}=se(()=>{d.value+=1},1e3,{immediate:!1}),{isRecording:y,recordedURL:w}=n,{waveformBars:W}=r,{isPlaying:x,audioElementKey:M}=o,P=N(()=>y.value||x.value),{localValue:L,onChange:g}=ie(v.widget,v.modelValue,i),z=N(()=>!v.nodeId||!q.rootGraph?null:q.rootGraph.getNodeById(v.nodeId));async function I(m){try{const l=await $().convertBlobToFileAndSubmit(m);L.value=l,t=l,g(l)}catch{O().addAlert("Failed to upload recorded audio")}}e(I,"handleRecordingComplete");async function S(){if(!v.readonly)try{if(await r.setupAudioContext(),await n.startRecording(),n.mediaRecorder.value){const m=n.mediaRecorder.value.stream;m&&await r.setupRecordingVisualization(m)}d.value=0,C(),r.initWaveform(),r.updateWaveform(P)}catch(m){console.error("Failed to start recording:",m)}}e(S,"handleStartRecording");function j(){n.stopRecording(),f(),r.stopWaveform()}e(j,"handleStopRecording");async function D(){if(!w.value||(d.value=0,await o.resetAudioElement(),await new Promise(A=>setTimeout(A,50)),!c.value)||!await r.setupPlaybackVisualization(c.value))return;await o.play(),r.initWaveform(),r.updateWaveform(P);const l=setInterval(()=>{d.value=Math.floor(o.getCurrentTime())},100);o.playbackTimerInterval.value=l}e(D,"handlePlayRecording");function E(){o.stop(),H()}e(E,"handleStopPlayback");function H(){r.stopWaveform(),o.playbackTimerInterval.value!==null&&(clearInterval(o.playbackTimerInterval.value),o.playbackTimerInterval.value=null);const m=o.getDuration();m?d.value=Math.floor(m):d.value=0}e(H,"handlePlaybackEnded");async function G(){return y.value&&n.mediaRecorder.value&&(n.mediaRecorder.value.stop(),await new Promise((m,l)=>{let A=0;const R=50,T=e(()=>{!y.value&&v.modelValue?m(void 0):++A>=R?l(new Error("Recording serialization timeout after 5 seconds")):setTimeout(T,100)},"checkRecording");T()})),v.modelValue||t||""}e(G,"serializeValue");function K(){const m=z.value;if(!m?.widgets)return;const l=m.widgets.find(A=>A.name==="audio");l&&(l.serializeValue=G)}return e(K,"registerWidgetSerialization"),Z(()=>{r.initWaveform(),K()}),F(()=>{o.playbackTimerInterval.value!==null&&(clearInterval(o.playbackTimerInterval.value),o.playbackTimerInterval.value=null)}),(m,l)=>{const A=ve;return b(),k("div",ye,[h("div",he,[V(a(re),{class:"text-text-secondary w-[413px] border-0 bg-secondary-background hover:bg-secondary-background-hover",disabled:a(y)||m.readonly,onClick:S},{default:ee(()=>[te(B(a(_)("g.startRecording","Start Recording"))+" ",1),V(A,{class:"ml-1"})]),_:1},8,["disabled"])]),a(y)||a(x)||a(w)?(b(),k("div",be,[h("div",ke,[h("span",we,B(a(y)?a(_)("g.listening","Listening..."):a(x)?a(_)("g.playing","Playing..."):a(w)?a(_)("g.ready","Ready"):""),1),h("span",xe,B(a(ce)(d.value)),1)]),h("div",Re,[(b(!0),k(ae,null,oe(a(W),(R,T)=>(b(),k("div",{key:T,class:"max-h-8 min-h-1 w-0.75 rounded-[1.5px] bg-slate-100 transition-all duration-100",style:ne({height:R.height+"px"}),title:`Bar ${T+1}: ${R.height}px`},null,12,_e))),128))]),a(y)?(b(),k("button",{key:0,title:a(_)("g.stopRecording","Stop Recording"),class:"flex size-8 animate-pulse items-center justify-center rounded-full border-0 bg-smoke-500/33 transition-colors",onClick:j},l[2]||(l[2]=[h("div",{class:"size-2.5 rounded-sm bg-danger-100"},null,-1)]),8,Ae)):!a(y)&&a(w)&&!a(x)?(b(),k("button",{key:1,title:a(_)("g.playRecording")||"Play Recording",class:"flex size-8 items-center justify-center rounded-full border-0 bg-smoke-500/33 transition-colors",onClick:D},l[3]||(l[3]=[h("i",{class:"text-text-secondary icon-[lucide--play] size-4"},null,-1)]),8,Ce)):a(x)?(b(),k("button",{key:2,title:a(_)("g.stopPlayback")||"Stop Playback",class:"flex size-8 items-center justify-center rounded-full border-0 bg-smoke-500/33 transition-colors",onClick:E},l[4]||(l[4]=[h("i",{class:"text-text-secondary icon-[lucide--square] size-4"},null,-1)]),8,Pe)):U("",!0)])):U("",!0),a(w)?(b(),k("audio",{ref_key:"audioRef",ref:c,key:a(M),src:a(w),class:"hidden",onEnded:l[0]||(l[0]=(...R)=>a(o).onPlaybackEnded&&a(o).onPlaybackEnded(...R)),onLoadedmetadata:l[1]||(l[1]=(...R)=>a(o).onMetadataLoaded&&a(o).onMetadataLoaded(...R))},null,40,Ee)):U("",!0),V(le)])}}});export{qt as default};
//# sourceMappingURL=WidgetRecordAudio-B0qRt-He.js.map
