name: Build Multi-Platform Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.1.0)'
        required: true

permissions:
  contents: write

jobs:
  build-python:
    name: Build Python Wheel
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Build wheel
        run: uv build

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: python-wheel
          path: dist/

  build-deb:
    name: Build Debian Package
    runs-on: ubuntu-latest
    needs: build-python
    steps:
      - uses: actions/checkout@v4

      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: python-wheel
          path: dist/

      - name: Install fpm
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential
          sudo gem install fpm

      - name: Build .deb
        run: |
          fpm -s python -t deb \
            --python-bin python3 \
            --python-pip pip3 \
            --python-package-name-prefix python3 \
            -n gloom \
            --version ${{ needs.build-python.outputs.version }} \
            --description "High-performance CLI for Google Cloud Context & ADC Switching" \
            --url "https://github.com/${{ github.repository }}" \
            --license "MIT" \
            --maintainer "${{ github.repository_owner }}" \
            dist/*.whl

      - name: Upload .deb
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: "*.deb"

  build-rpm:
    name: Build RPM Package
    runs-on: ubuntu-latest
    needs: build-python
    steps:
      - uses: actions/checkout@v4

      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: python-wheel
          path: dist/

      - name: Install fpm
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev build-essential rpm
          sudo gem install fpm

      - name: Build .rpm
        run: |
          fpm -s python -t rpm \
            --python-bin python3 \
            --python-pip pip3 \
            --python-package-name-prefix python3 \
            -n gloom \
            --version ${{ needs.build-python.outputs.version }} \
            --description "High-performance CLI for Google Cloud Context & ADC Switching" \
            --url "https://github.com/${{ github.repository }}" \
            --license "MIT" \
            --maintainer "${{ github.repository_owner }}" \
            dist/*.whl

      - name: Upload .rpm
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: "*.rpm"

  upload-release:
    name: Upload to Release
    runs-on: ubuntu-latest
    needs: [build-python, build-deb, build-rpm]
    if: github.event_name == 'release'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            python-wheel/*
            deb-package/*.deb
            rpm-package/*.rpm

  update-homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: build-python
    if: github.event_name == 'release'
    steps:
      - name: Trigger Homebrew tap update
        run: |
          echo "TODO: Update homebrew-tap repository with new formula"
          echo "Version: ${{ needs.build-python.outputs.version }}"
          # You can use repository_dispatch to trigger updates in your homebrew-tap repo
