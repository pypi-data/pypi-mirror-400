from __future__ import annotations

from typing import Dict, List

from pentestai.ai.multi_router import MultiAIRouter
from pentestai.core.config import get_api_key
from pentestai.ai.providers.base import AIProvider
from pentestai.ai.providers.openai_provider import OpenAIProvider
from pentestai.ai.providers.anthropic_provider import AnthropicProvider
from pentestai.ai.providers.gemini_provider import GeminiProvider
from pentestai.ai.providers.deepseek_provider import DeepSeekProvider


class AIRouter:
    """
    Compatibility wrapper used by cli.py and tasks.py.
    Internally uses MultiAIRouter with providers loaded from config.yaml + .env.
    """

    def __init__(self, cfg):
        self.cfg = cfg

        ai_cfg = getattr(cfg, "ai", None)
        if ai_cfg is None:
            raise RuntimeError("Missing ai config section")

        providers_cfg = getattr(ai_cfg, "providers", {})
        default_provider: str = getattr(ai_cfg, "default_provider", "openai")
        fallbacks: List[str] = getattr(ai_cfg, "fallback_providers", []) or []

        routing = getattr(ai_cfg, "routing", None) or {
            "surface": [default_provider] + fallbacks,
            "triage": [default_provider] + fallbacks,
            "report": [default_provider] + fallbacks,
        }

        providers: Dict[str, AIProvider] = {}

        # openai
        if "openai" in providers_cfg:
            p = providers_cfg["openai"]
            providers["openai"] = OpenAIProvider(
                api_key=get_api_key(p.api_key_env),
                base_url=p.base_url,
                model=p.model,
            )

        # anthropic (Claude)
        if "anthropic" in providers_cfg:
            p = providers_cfg["anthropic"]
            providers["anthropic"] = AnthropicProvider(
                api_key=get_api_key(p.api_key_env),
                base_url=p.base_url,
                model=p.model,
            )

        # gemini
        if "gemini" in providers_cfg:
            p = providers_cfg["gemini"]
            providers["gemini"] = GeminiProvider(
                api_key=get_api_key(p.api_key_env),
                base_url=p.base_url,
                model=p.model,
            )

        # deepseek
        if "deepseek" in providers_cfg:
            p = providers_cfg["deepseek"]
            providers["deepseek"] = DeepSeekProvider(
                api_key=get_api_key(p.api_key_env),
                base_url=p.base_url,
                model=p.model,
            )

        if not providers:
            raise RuntimeError("No AI providers configured. Check config.yaml (ai.providers) and .env keys.")

        self._router = MultiAIRouter(
            providers=providers,
            routing=routing,
            fallbacks=fallbacks,
            default_provider=default_provider,
        )

    async def run(
        self,
        task: str,
        system: str,
        user: str,
        temperature: float = 0.2,
        max_tokens: int = 1400,
    ) -> str:
        return await self._router.run(task, system, user, temperature=temperature, max_tokens=max_tokens)
