var g=Object.defineProperty;var d=(a,r,s)=>r in a?g(a,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[r]=s;var e=(a,r,s)=>(d(a,typeof r!="symbol"?r+"":r,s),s);import{P as c,X as u}from"./index-4cf586ed.js";import{C as b,f as m}from"./CanvasEnhancer-abaa5025.js";class f extends b{constructor(s){super(s);e(this,"onMouseWheel",s=>{const t=this.clampZoom(this.fabric.getZoom()+-1*s.e.deltaY/200);this.props.onZoomChange(t),this.fabric.zoomToPoint({x:s.e.offsetX,y:s.e.offsetY},t),this.clampViewPort(),this.fimg.setCoords(),s.e.preventDefault(),s.e.stopPropagation()});e(this,"onMouseDown",s=>{const{e:t}=s;this.isDragging=!0,this.lastPosX=t.clientX,this.lastPosY=t.clientY});e(this,"onMouseMove",s=>{if(this.isDragging){const{e:t}=s;this.fabric.viewportTransform[4]+=t.clientX-this.lastPosX,this.fabric.viewportTransform[5]+=t.clientY-this.lastPosY,this.clampViewPort(),this.fimg.setCoords(),this.fabric.requestRenderAll(),this.lastPosX=t.clientX,this.lastPosY=t.clientY}});e(this,"onMouseUp",()=>{this.isDragging=!1});this.markings=[],this.img=new u,this.img.onload=this.onLoad.bind(this),this.img.onerror=this.onError.bind(this),this.img.onprogress=this.onProgress.bind(this),this.first=!0,this.state.lastZoom=null}drawMarkings(){var t;this.markings&&this.markings.forEach(i=>{this.fabric.remove(i[0]),this.fabric.remove(i[1])}),this.markings=[];const s="yellow";(t=this.props.markings)==null||t.forEach(i=>{const o=new m.fabric.Line([i.x,0,i.x,this.img.height],{stroke:s,strokeWidth:1,hasBorders:!1}),h=new m.fabric.Line([0,i.y,this.img.width,i.y],{stroke:s,strokeWidth:1,hasBorders:!1});this.fabric.add(o),this.fabric.add(h),this.markings.push([o,h])})}onError(s,t,i){let o="";const h=new TextDecoder("utf-8");if(i.response){o=h.decode(i.response);try{const n=JSON.parse(o);o=n.error||n.message}catch{console.log("Error response was not json")}}this.props.onError?this.props.onError(s,t,o):console.error("Error while loading image",s,t,o),this.img.src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==",this.setState({lastError:!0},()=>{this.onLoad(!0)})}onLoad(s){this.fimg.setSrc(this.img.src,()=>{this.drawMarkings(),this.fabric.renderAll();const t=this.state.width/this.fimg.width;(this.state.lastZoom===null||this.state.lastError)&&this.fabric.setZoom(t),this.clampViewPort(),this.props.onLoadProgress(100),(this.state.lastZoom===null||this.state.lastError)&&(this.props.onZoomChange(t),this.setState({lastZoom:t}))},{left:0,top:0,angle:0}),s||this.setState({lastError:!1})}onProgress(s){this.props.onLoadProgress(s)}loadImage(){this.fabric&&this.props.url&&this.img.load(this.props.url)}componentDidMount(){super.componentDidMount(),this.first=!0}componentDidUpdate(s){super.componentDidUpdate(s),(s.url!==this.props.url||this.first)&&(this.loadImage(),this.first=!1)}componentWillUnmount(){this.img.onload=()=>{},this.img.onprogress=()=>{},this.fabric&&this.fabric.dispose()}initFabric(){super.initFabric(),this.fabric.selection=!1,this.fimg=new m.fabric.Image,this.fabric.add(this.fimg),this.fabric.on("mouse:wheel",this.onMouseWheel),this.fabric.on("mouse:down",this.onMouseDown),this.fabric.on("mouse:move",this.onMouseMove),this.fabric.on("mouse:up",this.onMouseUp),this.props.onReady&&this.props.onReady()}clampZoom(s){const t=this.state.width/this.fimg.width;return Math.min(Math.max(s,t),this.props.maxZoom)}clampViewPort(){const s=this.fimg.width*this.fabric.getZoom(),t=this.fimg.height*this.fabric.getZoom(),i=s-this.state.width,o=t-this.state.height,h=Math.max((this.state.width-s)/2,0),n=Math.max((this.state.height-t)/2,0),l=this.fabric.viewportTransform[4];this.fabric.viewportTransform[4]=Math.min(Math.max(l,-i),h);const p=this.fabric.viewportTransform[5];this.fabric.viewportTransform[5]=Math.min(Math.max(p,-o),n)}}e(f,"propTypes",{maxZoom:c.number,onError:c.func,markings:c.arrayOf(c.object)}),e(f,"defaultProps",{maxZoom:2,onError:void 0,lastError:!1});export{f as Z};
