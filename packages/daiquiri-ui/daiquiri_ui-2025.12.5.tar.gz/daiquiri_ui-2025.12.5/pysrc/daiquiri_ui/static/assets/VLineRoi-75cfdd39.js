var R=Object.defineProperty;var A=(a,e,s)=>e in a?R(a,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[e]=s;var d=(a,e,s)=>(A(a,typeof e!="symbol"?e+"":e,s),s);import{r as m,bD as I,aa as b,an as v,j as n}from"./index-4cf586ed.js";import{m as j,p as S,g as z,e as D}from"./hooks-e7539055.js";import{S as x}from"./ScreenScale-fdd43179.js";import{D as C,S as N,Z as $,A as F}from"./DraggableRect-8e897252.js";function P(a,e){if(a===void 0)return e;const s=new e.constructor(a.length+e.length);return s.set(a),s.set(e,a.length),s}function w(a,e,s){return e===0&&a.length===s?a:a.subarray(e,s)}class L{constructor(e,s){d(this,"isAborted");d(this,"isFetching");d(this,"isInitialized");d(this,"cache");d(this,"updateCallback");d(this,"scanId");d(this,"description");d(this,"pendingRequest");this.isAborted=!1,this.isFetching=!1,this.isInitialized=!1,this.pendingRequest=void 0,this.description=void 0,this.updateCallback=e,this.scanId=s,this.cache={};const r=this.initializeLater();Promise.all([r])}async initializeLater(){const e=this.scanId;await I(1e3);try{const s=await b.get(`/scans/data/${e}`,{headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}});this.setupScan(s.data),this.isInitialized=!0}catch(s){this.updateCallback({loading:!1,data:{},errors:[`Error while requesting the scan ${this.scanId}`,`${s}`]}),this.isAborted=!0}}setupScan(e){this.description=e,this.pendingRequest&&this.fetchPendingRequest()}async fetchData(e,s){for(;!this.isInitialized;){if(this.isAborted)return;await I(1e3)}const r={...e,scanId:this.scanId,errors:s},c=[];this.updateCallback({loading:!0,data:Object.fromEntries(e.channelNames.map(i=>{var t;return[i,(t=this.cache[i])==null?void 0:t.ndarray]})),request:r}),e.channelNames.forEach(i=>{var t;if(!(i in this.cache)){const o=(t=this.description)==null?void 0:t.data[i];if(o!==void 0){const u=o.dtype,g=o.shape;j(g);const p=g.reduce((y,h)=>y*h,1);u!==void 0&&(this.cache[i]={dtype:S(u),safeDtype:S(z(u)),shape:g,elementSize:p,raw:void 0,ndarray:void 0,nbItems:0})}}});const l=e.channelNames.map(async i=>{const t=this.cache[i];if(!t||!t.safeDtype){c.push(`channel name '${i}' in not part of the scan`);return}if(e.stop<=e.start){t.ndarray=void 0;return}const o=t.nbItems??0;if(e.stop<=o){const h=w(t.raw,e.start,e.stop);t.ndarray=v(h,[e.stop-e.start,...t.shape]);return}const u=await b.get(`/scans/data/binary/${this.scanId}`,{channel:i,selection:`${o}:${e.stop}`,dtype:"safe"},!0,"arraybuffer").then(h=>h.data).catch(h=>{const E=h instanceof Error?h.message:String(h);c.push(`Error while fetching '${i}': ${E}`)});if(u===void 0)return;const g=D(u,t.safeDtype.numpy),p=P(t.raw,g);if(t.raw=p,t.nbItems=p.length/t.elementSize,t.nbItems<=e.start){t.ndarray=void 0;return}const y=w(p,e.start*t.elementSize,t.nbItems*t.elementSize);t.ndarray=v(y,[t.nbItems-e.start,...t.shape])});await Promise.all(l);const f=c.length===0?void 0:c;this.pendingRequest===void 0?(this.updateCallback({loading:!1,data:Object.fromEntries(e.channelNames.map(i=>{var t;return[i,(t=this.cache[i])==null?void 0:t.ndarray]})),request:r,errors:f}),this.isFetching=!1):this.fetchPendingRequest(f)}fetchPendingRequest(e){if(this.pendingRequest){const s=this.pendingRequest;this.pendingRequest=void 0,this.fetchData(s,e)}}fetch(e){this.isAborted||(this.description!==void 0&&!this.isFetching?(this.isFetching=!0,this.fetchData(e)):this.pendingRequest=e)}abort(){this.isAborted=!0}}function V(a){const[e,s]=m.useState({loading:a.scanId!==void 0,data:{}}),{scanId:r,channelNames:c,start:l,stop:f}=a,i=m.useMemo(()=>{if(r!==void 0)return new L(s,r)},[r]);return m.useEffect(()=>()=>{i&&i.abort()},[i]),m.useEffect(()=>{i&&c&&l!==void 0&&f!==void 0&&i.fetch({channelNames:c,start:l,stop:f})},[i,JSON.stringify(c),l,f]),e}function H(a){const{geometry:e,lineWidth:s=2,color:r="blue",opacity:c=1,zIndex:l=1,visible:f=!0,readOnly:i=a.onGeometryChanged===void 0}=a,[t,o]=m.useState(!1);return f?n.jsxs("group",{position:[e.x,0,l],children:[n.jsx(x,{children:n.jsx(C,{pos:[e.x,0],size:[N,999999],pointer:"ew-resize",zIndex:l+$,enabled:!i,onPositionChanged:(u,g)=>{var p;(p=a.onGeometryChanged)==null||p.call(a,{x:u[0]},g)},onEnter:()=>{o(!0)},onLeave:()=>{o(!1)}})}),n.jsx("group",{children:n.jsx(x,{children:n.jsxs("mesh",{children:[n.jsx("ambientLight",{}),n.jsx("planeGeometry",{attach:"geometry",args:[t?F:s,999999,1,1]}),n.jsx("meshBasicMaterial",{attach:"material",transparent:!0,color:r,opacity:c})]})})})]}):n.jsx(n.Fragment,{})}export{H as V,V as u};
