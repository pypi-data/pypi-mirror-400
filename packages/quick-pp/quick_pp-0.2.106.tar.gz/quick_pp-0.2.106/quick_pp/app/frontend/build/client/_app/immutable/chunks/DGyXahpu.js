import{_ as ge}from"./PPVm8Dsz.js";import{y as we,p as ye,F as C,o as be,v as te,l as N,b as Se,i as Pe,f as D,n as x,w as V,Q as Re,J as G,R as xe,g as r,t as E,c as ke,s as ze,m as g,e as o,d as re,H as k,S as Ie,k as z,U as le,z as Ee,r as I,V as $e,X as Oe,N as ae,C as Fe,h as Ae}from"./tJ-1PvYF.js";import{g as Ne,c as De,z as Te,d as Le}from"./DAWgyOON.js";import{D as je}from"./BRt1D930.js";var Je=D('<label class="text-sm">Interval (ms): <input type="number" class="input w-24 ml-2"/></label>'),qe=D('<div class="text-sm text-blue-600"> </div>'),Ue=D('<div class="text-sm text-red-500"> </div>'),We=D('<div class="ws-well-plot"><!> <div class="mb-2 flex items-center gap-2"><button class="btn px-3 py-1 text-sm bg-gray-800 text-white rounded" aria-label="Refresh plot">Refresh</button> <label class="text-sm flex items-center gap-1"><input type="checkbox"/> Auto-refresh</label> <!></div> <!> <div></div></div>');function Me(ne,$){ye($,!1);const p=()=>re(Le,"$depthFilter",K),m=()=>re(Te,"$zoneFilter",K),[K,oe]=ze();let s=C($,"projectId",8),d=C($,"wellName",8),f=null,i=g(null),ie=C($,"minWidth",8,"480px"),O=g(!1),F=g(null),b=g(!1),T=g(5e3),y=null,L=g(null),j=g(null),A=g(!1),S=null,se=120,v=g(null),_=0;const M="http://localhost:6312",ce=1e3,de=3,fe=2e3;async function X(){if(f)return f;const e=await ge(()=>import("./BJMC0GYJ.js").then(t=>t.p),[],import.meta.url);return f=e.default||e,f}async function Y(e=0){let t=`${M}/quick_pp/plotter/projects/${s()}/wells/${encodeURIComponent(String(d()))}/log/generate`;const l=new URLSearchParams;if(p()?.enabled&&(p().minDepth!==null&&l.append("min_depth",String(p().minDepth)),p().maxDepth!==null&&l.append("max_depth",String(p().maxDepth))),m()?.enabled&&Array.isArray(m().zones)&&m().zones.length>0){const n=m().zones.map(a=>String(a)).join(",");l.append("zones",n)}l.toString()&&(t+="?"+l.toString());try{const n=await fetch(t,{method:"POST"});if(!n.ok)throw new Error(`Failed to initiate plot generation: ${n.statusText}`);const a=await n.json();if(!a.task_id)throw new Error("No task_id returned from server");return{task_id:a.task_id,result:a.result}}catch(n){if(e<de)return console.warn(`Initiation attempt ${e+1} failed, retrying...`,n),await new Promise(a=>setTimeout(a,fe)),Y(e+1);throw n}}async function ue(e,t){const l=`${M}/quick_pp/plotter/projects/${s()}/wells/${encodeURIComponent(String(d()))}/log/result/${e}`;return new Promise((n,a)=>{let c=0;const R=async()=>{if(c>=se){const u="Plot generation timed out after 2 minutes";console.error(u),t===_&&P(t),a(new Error(u));return}try{const u=await fetch(l);if(!u.ok)throw new Error(`Poll failed with status ${u.status}`);const h=await u.json();h.status==="success"?t===_?(P(t),n(h.result)):console.debug("Stale poll result ignored for session",t):h.status==="error"?t===_?(P(t),a(new Error(h.error||"Task failed with unknown error"))):console.debug("Stale poll error ignored for session",t):h.status==="pending"?(t===_&&o(v,`Generating plot... (${c}s)`),c++):t===_?(P(t),a(new Error(`Unknown task status: ${h.status}`))):console.debug("Stale poll unknown status ignored for session",t)}catch(u){console.error("Poll request failed:",u),t===_&&o(v,`Retrying... (attempt ${c})`),c++}};R(),S&&clearInterval(S),S=window.setInterval(R,ce)})}function P(e){S&&(clearInterval(S),S=null),(typeof e>"u"||e===_)&&o(v,null)}function Z(e){if(!r(i))return;const t={...e.config||{},responsive:!0,scrollZoom:!0},l={...e.layout||{},dragmode:e.layout?.dragmode??"zoom"};if(f.react?f.react(r(i),e.data,l,t):f.newPlot(r(i),e.data,l,t),typeof ResizeObserver<"u"){if(r(i)?._plotlyResizeObserver)try{r(i)._plotlyResizeObserver.disconnect()}catch{}const n=new ResizeObserver(()=>{try{f.Plots&&f.Plots.resize&&f.Plots.resize(r(i))}catch{}});n.observe(r(i)),Ie(i,r(i)._plotlyResizeObserver=n)}}async function w(e=!1){if(!s()||!d()||!r(A)||!r(i))return;const t=++_;P(),o(O,!0),o(F,null),o(v,null);try{const l=JSON.stringify({depth:p(),zone:m()}),n=`${s()}-${d()}-${l}`;let a;const c=Ne(s(),n);if(!e&&c)a=c.data,await X(),Z(a);else{if(await X(),!f)throw new Error("Failed to load Plotly library");o(v,"Initiating plot generation...");const R=await Y(),{task_id:u,result:h}=R;console.log("Plot generation task initiated with ID:",u),h?(console.log("Sync fallback: result received immediately"),a=h):(o(v,"Waiting for plot generation..."),a=await ue(u,t)),De(s(),n,a),Z(a)}}catch(l){console.error("Failed to render well plot",l),o(F,String(l?.message??l))}finally{t===_&&(o(O,!1),o(v,null))}}function pe(){try{y&&(clearInterval(y),y=null),r(b)&&typeof window<"u"&&(y=window.setInterval(()=>{w()},Number(r(T))||5e3))}catch{}}be(()=>{o(A,!0),w()}),te(()=>{try{r(i)&&r(i)._plotlyResizeObserver&&(r(i)._plotlyResizeObserver.disconnect(),delete r(i)._plotlyResizeObserver),y&&(clearInterval(y),y=null),P()}catch{}});{const e=t=>{try{const l=t.detail;if(!l)return;String(l.projectId)===String(s())&&String(l.wellName)===String(d())&&w(!0)}catch{}};window.addEventListener("qpp:data-updated",e),te(()=>window.removeEventListener("qpp:data-updated",e))}N(()=>(k(s()),k(d())),()=>{s()&&d()&&w()}),N(()=>(r(A),r(b)),()=>{r(A)&&(pe(),r(b)&&w())}),N(()=>(p(),r(L),k(s()),k(d())),()=>{p()&&JSON.stringify(p())!==JSON.stringify(r(L))&&(o(L,{...p()}),s()&&d()&&w())}),N(()=>(m(),r(j),k(s()),k(d())),()=>{m()&&JSON.stringify(m())!==JSON.stringify(r(j))&&(o(j,{...m()}),s()&&d()&&w())}),Se(),Pe();var J=We(),B=x(J);je(B,{});var q=z(B,2),U=x(q);U.__click=()=>w(!0);var W=z(U,2),H=x(W);le(H),Ee(),I(W);var me=z(W,2);{var ve=e=>{var t=Je(),l=z(x(t));le(l),I(t),Oe(l,()=>r(T),n=>o(T,n)),E(e,t)};V(me,e=>{r(b)&&e(ve)})}I(q);var Q=z(q,2);{var _e=e=>{var t=qe(),l=x(t,!0);I(t),G(()=>ae(l,r(v)?r(v):"Loading well logâ€¦")),E(e,t)},he=e=>{var t=Fe(),l=Ae(t);{var n=a=>{var c=Ue(),R=x(c);I(c),G(()=>ae(R,`Error: ${r(F)??""}`)),E(a,c)};V(l,a=>{r(F)&&a(n)},!0)}E(e,t)};V(Q,e=>{r(O)?e(_e):e(he,!1)})}var ee=z(Q,2);Re(ee,e=>o(i,e),()=>r(i)),I(J),G(()=>{U.disabled=r(O),$e(ee,`width:100%; min-width: ${ie()??""}; height:900px;`)}),xe(H,()=>r(b),e=>o(b,e)),E(ne,J),ke(),oe()}we(["click"]);export{Me as default};
