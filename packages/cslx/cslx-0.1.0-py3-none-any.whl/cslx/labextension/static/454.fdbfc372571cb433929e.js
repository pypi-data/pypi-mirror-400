"use strict";(self.webpackChunkcslx=self.webpackChunkcslx||[]).push([[454],{454:(e,t,s)=>{s.r(t),s.d(t,{default:()=>u});var n=s(827),i=s(366),a=s(389),c=s(247),l=s(602);class o extends c.Widget{constructor(e){var t;super(),this.addNewRequested=new l.Signal(this),this.addExistingRequested=new l.Signal(this),this.connectRequested=new l.Signal(this),this.disconnectRequested=new l.Signal(this),this._busy=new Map,this._kernels=[{id:"nexus-dev-mode",name:"Nexus Dev mode",status:"available",metadata:["Lightweight kernel for low-performance and exploratory tasks."],url:"http://localhost:8080",token:""},{id:"kernel-5",name:"Kernel 5",status:"available",metadata:["Nodes - 1 | Cores - 39 | Memory-100GB","Cluster 1"],url:"http://localhost:8080",token:""}],this._app=e,this.id="cybershuttle-kernel-list",this.addClass("csKernelPanel"),this._app.serviceManager.kernelspecs.refreshSpecs(),console.log("CyberShuttlePanel initialized with kernelspecs "),console.log(this._app.serviceManager.kernelspecs.specs);const s=this._app.serviceManager.kernelspecs.specs;for(const e of Object.keys((null==s?void 0:s.kernelspecs)||{})){console.log(` - ${e}: `,null==s?void 0:s.kernelspecs[e]);const n=null==s?void 0:s.kernelspecs[e],i=null===(t=null==n?void 0:n.metadata)||void 0===t?void 0:t.kernel_provisioner;i&&"object"==typeof i&&!Array.isArray(i)&&"cspyk-provisioner"===i.provisioner_name&&(console.log(` --\x3e Found CyberShuttle provisioner for kernel spec: ${e}`),this._kernels.find((t=>t.id===e))?this.updateKernelSpecStatus(e,"connected"):this.addKernelSpecItem({id:e,name:e,status:"connected",metadata:[""],url:"sfsdf",token:"dsffs"}))}this._render()}setBusy(e,t){t?this._busy.set(e,!0):this._busy.delete(e),this._render()}addKernelSpecItem(e){this._kernels.unshift(e),this._render()}updateKernelSpecStatus(e,t){const s=this._kernels.find((t=>t.id===e));s&&(s.status=t,this._render())}_render(){this.node.textContent="",this.node.appendChild(this._build())}onKernelConnectClicked(e){console.log("[KernelList] connect clicked for",e);const t=this._kernels.find((t=>t.id===e));t?this.connectRequested.emit(t):console.warn("[KernelList] could not find kernel to connect:",e)}_build(){const e=document.createElement("div");e.className="csRoot",e.appendChild(this._topBar()),e.appendChild(this._intro());const t=document.createElement("div");t.className="csSectionHeader",t.appendChild(this._el("div","KERNELS"));const s=document.createElement("button");s.className="csAddNew",s.type="button",s.textContent="+ Add new",s.onclick=()=>this.addNewRequested.emit(void 0),t.appendChild(s);const n=document.createElement("button");n.className="csAddExisting",n.type="button",n.textContent="+ Add existing",n.onclick=()=>this.addExistingRequested.emit(void 0),t.appendChild(n),e.appendChild(t),e.appendChild(this._subhead(`Connected Kernel Specs (${this._kernels.filter((e=>"connected"===e.status)).length})`)),e.appendChild(this._card(this._kernels.filter((e=>"connected"===e.status)).map((e=>this._row(e.name,"Disconnect",(()=>this.disconnectRequested.emit(e))))))),e.appendChild(this._subhead(`Available Kernel Specs (${this._kernels.filter((e=>"available"===e.status)).length})`)),e.appendChild(this._card(this._kernels.filter((e=>"available"===e.status)).map((e=>this._kernelBlock(e,"Connect",(()=>this.onKernelConnectClicked(e.id)),!0)))));const i=this._kernels.filter((e=>"pending"===e.status||"rejected"===e.status));return e.appendChild(this._subhead(`Pending/Rejected Kernel Specs (${i.length})`)),e.appendChild(this._card(i.map((e=>this._kernelBlock(e,void 0,void 0,"pending"!==e.status))))),e}_topBar(){const e=document.createElement("div");e.className="csTopBar",e.appendChild(this._el("div","CYBERSHUTTLE","csTopTitle"));const t=this._el("div","i","csInfo");return t.title="Info",e.appendChild(t),e}_intro(){return this._el("div","Manage and create kernels using your approved CyberShuttle compute allocations, directly inside JupyterLab.","csIntro")}_subhead(e){return this._el("div",e,"csSubhead")}_card(e){const t=document.createElement("div");return t.className="csCard",e.forEach((e=>t.appendChild(e))),t}_row(e,t,s){const n=document.createElement("div");n.className="csRow",n.appendChild(this._el("div",e,"csRowTitle"));const i=document.createElement("button");if(i.className="csBtn",i.type="button",i.textContent=t,this._busy.get(e)?(i.disabled=!0,i.style.opacity="0.6"):i.onclick=s,n.appendChild(i),this._busy.get(e)){const e=document.createElement("span");e.className="csSpinner",n.appendChild(e)}return n}_kernelBlock(e,t,s,n){var i;const a=document.createElement("div");a.className="csKernelBlock";const c=document.createElement("div");if(c.className="csKLeft",c.appendChild(this._el("div",e.name,"csKName")),null===(i=e.metadata)||void 0===i?void 0:i.length){const t=document.createElement("ul");t.className="csMeta",e.metadata.forEach((e=>{const s=document.createElement("li");s.textContent=e,t.appendChild(s)})),c.appendChild(t)}const l=document.createElement("div");if(l.className="csKRight",n){const t=document.createElement("button");t.className="csTrash",t.type="button",t.title="Delete",t.textContent="ðŸ—‘",t.onclick=()=>console.log("delete",e.name),l.appendChild(t)}if("pending"===e.status||"rejected"===e.status){const t=document.createElement("span");t.className=`csPill csPill-${e.status}`,t.textContent="pending"===e.status?"Pending":"Rejected",l.appendChild(t)}else if(t&&s){const n=document.createElement("button");if(n.className="csBtnPrimary",n.type="button",n.textContent=t,this._busy.get(e.name)?(n.disabled=!0,n.style.opacity="0.6"):n.onclick=s,l.appendChild(n),this._busy.get(e.name)){const e=document.createElement("span");e.className="csSpinner",l.appendChild(e)}}return a.appendChild(c),a.appendChild(l),a}_el(e,t,s){const n=document.createElement(e);return s&&(n.className=s),n.textContent=t,n}}class d extends c.Widget{constructor(){super(),this.backRequested=new l.Signal(this),this.cancelRequested=new l.Signal(this),this.requestSubmitted=new l.Signal(this),this.id="cybershuttle-request-form",this.addClass("csKernelPanel"),this.hide(),this._render()}_render(){this.node.textContent="",this.node.appendChild(this._build())}_build(){var e;const t=document.createElement("div");t.className="csRoot csFormRoot";const s=document.createElement("div");s.className="csFormTop";const n=document.createElement("button");n.className="csBackBtn",n.type="button",n.textContent="â† Back",n.onclick=()=>this.backRequested.emit(void 0);const i=document.createElement("div");i.className="csFormTitle",i.textContent="Requesting a new Kernel",s.appendChild(n),s.appendChild(i),t.appendChild(s);const a=document.createElement("div");a.className="csForm",this._name=document.createElement("input"),this._name.className="csInput",this._name.placeholder="Add a Name",a.appendChild(this._rowNum(1,this._name)),this._allocation=this._select(["Select an Allocation","Allocation A","Allocation B"]),a.appendChild(this._rowNum(2,this._allocation)),this._compute=this._select(["Select a Compute Resource","CPU","GPU"]),a.appendChild(this._rowNum(3,this._compute)),this._queue=this._select(["gpu-shared","cpu-shared","gpu-dedicated"]);const c=this._rowNum(4,this._queue,"Select a Queue :"),l=document.createElement("div");l.className="csRightHint",l.textContent="Expanse GPU (NV)",null===(e=c.querySelector(".csRowRight"))||void 0===e||e.appendChild(l),a.appendChild(c),this._nodes=this._numInput(1),a.appendChild(this._stepRow(5,"Node count :",this._nodes,1,"Max Allowed Nodes = 1")),this._cores=this._numInput(1),a.appendChild(this._stepRow(6,"Total Core Count :",this._cores,39,"Max Allowed Cores = 39. There are 39 cores per node.")),this._wall=this._numInput(0),a.appendChild(this._stepRow(7,"Wall Time Limit :",this._wall,0,"Max Allowed Wall Time = 0 minutes","Minutes")),this._mem=this._numInput(0),a.appendChild(this._stepRow(8,"Total Physical Memory",this._mem,128e3,"Max Physical Memory = 128000 MB","MB")),t.appendChild(a);const o=document.createElement("div");o.className="csFormFooter";const d=document.createElement("button");d.className="csCancel",d.type="button",d.textContent="Cancel",d.onclick=()=>this.cancelRequested.emit(void 0);const r=document.createElement("button");return r.className="csRequest",r.type="button",r.textContent="Request",r.onclick=()=>this._submit(),o.appendChild(d),o.appendChild(r),t.appendChild(o),t}_submit(){const e={name:this._name.value.trim()||"Unnamed Kernel",allocation:this._allocation.value,computeResource:this._compute.value,queue:this._queue.value,nodeCount:Number(this._nodes.value||0),coreCount:Number(this._cores.value||0),wallMinutes:Number(this._wall.value||0),memoryMB:Number(this._mem.value||0)};this.requestSubmitted.emit(e)}_rowNum(e,t,s){const n=document.createElement("div");n.className="csFormRow";const i=document.createElement("div");i.className="csRowNum",i.textContent=`${e}.`;const a=document.createElement("div");if(a.className="csRowRight",s){const e=document.createElement("div");e.className="csLabel",e.textContent=s,a.appendChild(e)}return a.appendChild(t),n.appendChild(i),n.appendChild(a),n}_stepRow(e,t,s,n,i,a){const c=document.createElement("div");c.className="csFormRow";const l=document.createElement("div");l.className="csRowNum",l.textContent=`${e}.`;const o=document.createElement("div");o.className="csRowRight";const d=document.createElement("div");d.className="csLabel",d.textContent=t;const r=document.createElement("div");r.className="csStepper";const h=document.createElement("div");if(h.className="csStepperFieldWrap",a){const e=document.createElement("div");e.className="csUnit",e.textContent=a,h.appendChild(e)}h.appendChild(s);const u=document.createElement("button");u.className="csStepBtn",u.type="button",u.textContent="âˆ’",u.onclick=()=>this._bump(s,-1,n);const m=document.createElement("button");m.className="csStepBtn",m.type="button",m.textContent="+",m.onclick=()=>this._bump(s,1,n),r.appendChild(h),r.appendChild(u),r.appendChild(m);const p=document.createElement("div");return p.className="csHelp",p.textContent=i,o.appendChild(d),o.appendChild(r),o.appendChild(p),c.appendChild(l),c.appendChild(o),c}_bump(e,t,s){const n=Number(e.value||0),i=Math.max(0,Math.min(s,n+t));e.value=String(i)}_numInput(e){const t=document.createElement("input");return t.className="csInput csNum",t.type="number",t.min="0",t.value=String(e),t}_select(e){const t=document.createElement("select");return t.className="csSelect",e.forEach((e=>{const s=document.createElement("option");s.value=e,s.textContent=e,t.appendChild(s)})),t}}class r extends c.Widget{constructor(){super(),this.backRequested=new l.Signal(this),this.cancelRequested=new l.Signal(this),this.connectSubmitted=new l.Signal(this),this.id="cs-add-existing-form",this.addClass("csKernelPanel"),this.hide(),this._render()}_render(){this.node.textContent="",this.node.appendChild(this._build())}_build(){const e=document.createElement("div");e.className="csRoot csFormRoot";const t=document.createElement("div");t.className="csFormTop";const s=document.createElement("button");s.className="csBackBtn",s.type="button",s.textContent="â† Back",s.onclick=()=>this.backRequested.emit(void 0);const n=document.createElement("div");n.className="csFormTitle",n.textContent="Add an Existing Kernel",t.appendChild(s),t.appendChild(n),e.appendChild(t);const i=document.createElement("div");i.className="csInstructions",i.innerHTML="\n      <strong>Instructions</strong>\n      <ul>\n        <li>If you already have a running kernel outside CyberShuttle, you can connect it here.</li>\n        <li>Provide the kernel's URL and access token to authenticate.</li>\n        <li>Once connected, the kernel will appear and can be used like any other JupyterLab kernel.</li>\n      </ul>",e.appendChild(i);const a=document.createElement("div");a.className="csForm",this._kernelName=document.createElement("input"),this._kernelName.className="csInput",this._kernelName.placeholder="Kernel name (optional)",a.appendChild(this._fieldRow(this._kernelName)),this._url=document.createElement("input"),this._url.className="csInput",this._url.placeholder="URL",a.appendChild(this._fieldRow(this._url)),this._token=document.createElement("input"),this._token.className="csInput",this._token.placeholder="Access token",a.appendChild(this._fieldRow(this._token)),e.appendChild(a);const c=document.createElement("div");c.className="csFormFooter";const l=document.createElement("button");l.className="csCancel",l.type="button",l.textContent="Cancel",l.onclick=()=>this.cancelRequested.emit(void 0);const o=document.createElement("button");return o.className="csRequest",o.type="button",o.textContent="Connect",o.onclick=()=>this._onConnect(),c.appendChild(l),c.appendChild(o),e.appendChild(c),this._progress=document.createElement("div"),this._progress.className="csConnectProgress",this._progress.style.display="none",this._progress.innerHTML='\n      <div class="csConnectingText">Connecting...</div>\n      <div class="csProgressBar"><div class="csProgressFill" style="width:0%"></div></div>\n    ',e.appendChild(this._progress),e}_fieldRow(e){const t=document.createElement("div");t.className="csFormRow";const s=document.createElement("div");s.className="csRowNum",s.textContent="";const n=document.createElement("div");return n.className="csRowRight",n.appendChild(e),t.appendChild(s),t.appendChild(n),t}async _onConnect(){const e={url:this._url.value.trim(),token:this._token.value.trim()||void 0,name:this._kernelName.value.trim()||void 0};this._progress.style.display="block";const t=this._progress.querySelector(".csProgressFill");let s=0;const n=setInterval((()=>{s=Math.min(90,s+Math.floor(20*Math.random())+10),t.style.width=`${s}%`}),300);try{this.connectSubmitted.emit(e)}finally{clearInterval(n),t.style.width="100%",setTimeout((()=>this._progress.style.display="none"),500)}}showProgress(e){this._progress.style.display="block",this._progress.querySelector(".csProgressFill").style.width=`${e}%`}}class h extends c.StackedPanel{constructor(e){super(),this._app=e,this.id="cybershuttle-panel",this.title.label="CyberShuttle",this.title.closable=!0,this.addClass("csShell"),this._list=new o(e),this._form=new d,this._existingForm=new r,this.addWidget(this._list),this.addWidget(this._form),this.addWidget(this._existingForm),this._showList(),this._list.addNewRequested.connect((()=>this._showForm())),this._list.addExistingRequested.connect((()=>this._showExistingForm())),this._list.connectRequested.connect(((e,t)=>{(async()=>{try{this._list.setBusy(t.id,!0);const e=this._getXsrfToken(),s=await fetch("/cslx/api/install-kernelspec",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json",...e?{"X-XSRFToken":e}:{}},body:JSON.stringify({name:t.name,id:t.id,url:t.url,token:t.token})});console.log("Install response:",s),await this._app.serviceManager.kernelspecs.refreshSpecs(),this._list.updateKernelSpecStatus(t.id,"connected"),this._list.setBusy(t.id,!1)}catch(e){console.error("[CyberShuttle] failed to start kernel from connect click",e),this._list.setBusy(t.id,!1)}})()})),this._list.disconnectRequested.connect(((e,t)=>{(async()=>{try{console.log("[CyberShuttle] disconnecting kernel ",t.id," with name ",t.name),this._list.setBusy(t.id,!0);try{const e=this._getXsrfToken(),s=await fetch("/cslx/api/uninstall-kernelspec",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json",...e?{"X-XSRFToken":e}:{}},body:JSON.stringify({name:t.name,id:t.id})});if(s.ok){const e=await s.json();console.log("[CyberShuttle] uninstall result",e)}else{const e=await s.text();console.warn("[CyberShuttle] uninstall kernelspec failed",s.status,e)}}catch(e){console.error("[CyberShuttle] uninstall kernelspec request failed",e)}await this._app.serviceManager.kernelspecs.refreshSpecs(),this._list.updateKernelSpecStatus(t.id,"available"),this._list.setBusy(t.id,!1)}catch(e){console.error("[CyberShuttle] failed to disconnect kernel",e),this._list.setBusy(t.id,!1)}})()})),this._form.backRequested.connect((()=>this._showList())),this._form.cancelRequested.connect((()=>this._showList())),this._existingForm.backRequested.connect((()=>this._showList())),this._existingForm.cancelRequested.connect((()=>this._showList())),this._existingForm.connectSubmitted.connect(((e,t)=>{this._existingForm.showProgress(30);const s=`External: ${t.name&&t.name.trim()?t.name.trim():t.url?new URL(t.url).hostname:`external-${Date.now()}`}`;setTimeout((()=>{const e={id:`external-${Date.now()}`,name:s,status:"available",metadata:[""],url:t.url||"",token:t.token||""};this._list.addKernelSpecItem(e),this._showList()}),100)})),this._form.requestSubmitted.connect(((e,t)=>{console.log("[CyberShuttle] request submitted",t),this._showList()}))}_getXsrfToken(){if("undefined"==typeof document||!document.cookie)return"";const e=document.cookie.match(/(?:^|; )(_xsrf|XSRF-TOKEN)=([^;]+)/);return e&&e.length>2?decodeURIComponent(e[2]):""}_showList(){this._list.show(),this._form.hide(),this._existingForm.hide(),this._list.activate()}_showForm(){this._form.show(),this._existingForm.hide(),this._list.hide(),this._form.activate()}_showExistingForm(){this._existingForm.show(),this._list.hide(),this._existingForm.activate()}}const u={id:"cslx:plugin",description:"A JupyterLab extension for Cybershuttle",autoStart:!0,requires:[n.ICommandPalette],optional:[i.ILauncher,a.INotebookTracker],activate:(e,t,s,i)=>{if(console.log("JupyterLab extension cslx is activated!"),!i)return void console.warn("INotebookTracker is not available.");const a=new h(e),c=new n.MainAreaWidget({content:a});e.shell.add(c,"right",{rank:200}),e.shell.activateById(c.id)}}}}]);