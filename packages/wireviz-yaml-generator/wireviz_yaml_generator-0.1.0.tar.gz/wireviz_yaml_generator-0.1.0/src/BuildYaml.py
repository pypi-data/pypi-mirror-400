"""
YAML View Layer.

This module is responsible for complying with the WireViz YAML schema.
It acts as a 'View' layer, converting internal Domain Models (`Connector`,
`Cable`, `Connection`) into the specific dictionary structure that WireViz
expects for generation.

It uses Pure Functions for conversion to ensure testability.
"""

import yaml
from typing import List, Dict, Any, Optional
from models import Connector, Cable, Connection

# --- Pure Conversion Functions ---

def _clean_dict(d: Dict[str, Any]) -> Dict[str, Any]:
    """
    Recursively removes None values and empty containers from a dictionary.
    
    This results in a cleaner YAML file (omitting fields that aren't set),
    which is preferred by WireViz.
    """
    cleaned = {}
    for k, v in d.items():
        if isinstance(v, dict):
            nested = _clean_dict(v)
            if nested:
                cleaned[k] = nested
        elif isinstance(v, list):
            if v:
                cleaned[k] = v
        elif v is not None:
            cleaned[k] = v
    return cleaned

def connector_to_dict(c: Connector) -> Dict[str, Any]:
    """
    Converts a Connector domain object to a WireViz dictionary structure.

    Args:
        c (Connector): The source domain connector.

    Returns:
        Dict[str, Any]: A dictionary matching the 'connectors' section of WireViz YAML.
    """
    d = {
        "mpn": c.mpn,
        "pincount": c.pincount,
        # Only include flags if they deviate from default to reduce noise
        "show_pincount": c.show_pincount if not c.show_pincount else None, 
        "hide_disconnected_pins": c.hide_disconnected_pins if c.hide_disconnected_pins else None,
        "notes": c.notes,
    }
    
    if c.image_src:
        d["image"] = {
            "src": c.image_src,
            "caption": c.image_caption,
            "height": 50 
        }
    
    return _clean_dict(d)

def cable_to_dict(c: Cable) -> Dict[str, Any]:
    """
    Converts a Cable domain object to a WireViz dictionary structure.

    Args:
        c (Cable): The source domain cable.

    Returns:
        Dict[str, Any]: A dictionary matching the 'cables' section of WireViz YAML.
    """
    d = {
        "wirecount": c.wire_count,
        "category": c.category,
        "gauge": c.gauge,
        "gauge_unit": c.gauge_unit,
        "notes": c.notes,
        "wirelabels": c.wire_labels
    }
    return _clean_dict(d)

def connection_to_list(c: Connection) -> List[Dict[str, Any]]:
    """
    Converts a Connection domain object to a WireViz connection list.

    Format: [ {From: Pin}, {Via: Pin}, {To: Pin} ]

    Args:
        c (Connection): The source connection.

    Returns:
        List[Dict[str, Any]]: The list structure required by WireViz.
    """
    from_node = {c.from_designator: c.from_pin}
    via_node = {c.via_cable: c.via_pin}
    to_node = {c.to_designator: c.to_pin}
    
    return [from_node, via_node, to_node]


# --- Main Builder ---

def build_yaml_file(
    connectors: List[Connector],
    cables: List[Cable],
    connections: List[Connection],
    yaml_filepath: str
) -> None:
    """
    Orchestrates the creation of the final YAML file.

    Steps:
    1.  Converts all Domain Objects to Dicts using pure converters.
    2.  Assembles the final root dictionary.
    3.  Writes to filesystem using PyYAML.

    Args:
        connectors: List of Connector objects.
        cables: List of Cable objects.
        connections: List of Connection objects.
        yaml_filepath: Destination path string.
    """
    
    # 1. Convert to Dicts
    formatted_connectors = {
        c.designator: connector_to_dict(c) 
        for c in connectors
    }
    
    formatted_cables = {
        c.designator: cable_to_dict(c)
        for c in cables
    }
    
    formatted_connections = [
        connection_to_list(c)
        for c in connections
    ]

    # 2. Assemble Final Structure
    final_data = {}
    if formatted_connectors:
        final_data['connectors'] = formatted_connectors
    if formatted_cables:
        final_data['cables'] = formatted_cables
    if formatted_connections:
        final_data['connections'] = formatted_connections

    # 3. Write Output
    with open(yaml_filepath, "w", encoding="utf-8") as f:
        f.write("# WireViz YAML file generated by WireViz YAML Generator v01\n\n")
        yaml.dump(final_data, f, sort_keys=False, default_flow_style=False, allow_unicode=True)

    print(f"âœ… YAML file successfully created at: {yaml_filepath}")