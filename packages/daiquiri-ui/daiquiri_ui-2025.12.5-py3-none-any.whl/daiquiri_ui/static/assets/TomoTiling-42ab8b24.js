import{bF as re,j as t,ay as F,g as ve,R as A,aj as E,B as N,r as g,a6 as O,a7 as w,an as Ke,a8 as fe,a9 as Wt,aa as et,aL as q,l as Te,ab as T,b9 as St,ax as k,C as L,x as ce,O as wt,au as bt,aU as H,aP as G,aM as Xt,aO as Qt,a_ as Jt,aN as Kt,b8 as en,aY as Fe,bG as tn,u as zt,bH as Re,Q as de,b as V,aQ as Ee,aZ as nn,bI as on,bJ as sn,am as an,bK as rn,bL as cn,bM as ln,aX as dn,b4 as un,bN as mn,b3 as xn,bA as fn,bB as gn,a1 as hn,aw as tt,q as yn}from"./index-4cf586ed.js";import{a as ge,b as vn,Q as jn,O as pn,j as Sn,t as wn,u as Le,w as nt,r as bn}from"./index-19c84627.js";import{b as Ae,L as zn,u as Cn,T as Mn,D as Dn,S as ie,V as ot}from"./UseMouseModeInteraction-9b6c111c.js";import{A as ae,u as Ct,a as Rn}from"./colormap-0981f7dc.js";import{L as st,S as Nn,b as In,I as Pn,u as kn,A as Tn}from"./AutoscaleOption-e2ee098d.js";import{C as Fn,f as it,a as at,H as rt,L as En,V as ct}from"./VisViewpointRestore-3a80fbce.js";import{s as Ln,k as An,n as On,t as _n}from"./hooks-e7539055.js";import{L as Y}from"./Label-7daca8b6.js";import{p as K,a as X,f as te,r as he,t as Mt}from"./geometry-252a228f.js";import{H as lt,r as ke}from"./HSegment-26c3fd51.js";import{V as ye}from"./VSegment-5d77576e.js";import{C as Vn}from"./CrossMarker-cc495eca.js";import{R as je}from"./RectRoi-a627d206.js";import{P as Oe}from"./SelectionPoint-7fbd4e1f.js";import{a as $n,R as Bn}from"./RulerButton-ebbb7ca3.js";import{c as Gn}from"./colors-5bf0897d.js";import{S as Dt}from"./StackedNameState-94be4a7b.js";import{g as Hn}from"./TomoScans-82e1e23b.js";import{N as _e}from"./NewScanButton-3ccc3031.js";import{D as Yn}from"./DropdownButton-9a594aef.js";import{u as Un,a as Zn,b as qn,D as Wn}from"./DropdownDetector-705d3a9d.js";import{H as Xn}from"./HistogramDomainSlider-9c6d3e2d.js";import{W as dt}from"./WorldScale-862ee5ba.js";import"./Image-c1578ac2.js";import"./ScreenScale-fdd43179.js";import"./Anchor-f3716b7b.js";import"./DraggableRect-8e897252.js";import"./QtyHelper-8429914f.js";import"./types-0be7083b.js";import"./ConnectUtils-bd734a4a.js";function Z(e,n,o,s){if(n)return re(e,n);if(o){const a=`${o}.${s}`;return re(e,a)}return null}function pe(e,n){const o=n.tomoconfig??"ACTIVE_TOMOCONFIG.ref",s=Z(e,n.sampleStageId,o,"sample_stage"),a=Z(e,n.syId,o,"sample_stage.sy"),i=Z(e,n.sampxId,o,"sample_stage.sampx"),l=Z(e,n.sampyId,o,"sample_stage.sampy"),r=Z(e,n.sampuId,o,"sample_stage.sampu"),c=Z(e,n.sampvId,o,"sample_stage.sampv"),u=Z(e,n.szId,o,"sample_stage.sz"),m=Z(e,n.somegaId,o,"sample_stage.somega"),d=Z(e,n.detectorId,o,"detectors.active_detector.detector"),x=Z(e,n.tomoDetectorId,o,"detectors.active_detector");return{sy:a,sampx:i,sampy:l,sampu:r,sampv:c,sz:u,somega:m,detector:d,tomoDetector:x,sampleStage:s}}function Qn(e){const{as:n=void 0,variant:o="secondary"}=e;function s(c,u){const d=e.lut===c?"primary":"secondary";return t.jsx(N,{variant:d,onClick:()=>{e.onSelectLut(c)},className:"text-nowrap",title:u,size:"sm",children:t.jsx(st,{name:c})})}function a(){const c=e.isInverted?"primary":"secondary";return t.jsxs(N,{variant:c,onClick:()=>{e.onSelectInvertion(!e.isInverted)},size:"sm",children:[t.jsx("i",{className:"fa fa-fw fa-arrows-alt-v"})," Inverted LUT"]})}function i(c,u){const d=e.norm===c?"primary":"secondary";return t.jsx(N,{variant:d,onClick:()=>{e.onSelectNorm(c)},size:"sm",children:u})}function l(c){const u=e.autoscaleMode===c,m=u&&e.autoscale?"primary":u?"warning":"secondary",x={[ae.Minmax]:"Minmax",[ae.StdDev3]:"3×std",[ae.None]:"Manual"}[c];return t.jsx(N,{variant:m,onClick:()=>{var h,f;(h=e.onSelectAutoscaleMode)==null||h.call(e,c),e.autoscale||(f=e.onSelectAutoscale)==null||f.call(e,!0)},size:"sm",children:x})}function r(){const c=e.autoscale?"primary":"secondary";return t.jsxs(N,{variant:c,onClick:()=>{var u;(u=e.onSelectAutoscale)==null||u.call(e,!e.autoscale)},size:"sm",children:[t.jsx("i",{className:"fa-solid fa-circle-half-stroke fa-fw fa-lg"})," Auto scale enabled"]})}return t.jsxs(F,{as:n,className:`${e.dropDirection==="up"?"dropup":""}`,children:[t.jsxs(F.Toggle,{id:"dropdown-basic",variant:o,className:"d-flex align-items-center",children:[t.jsx(st,{name:e.lut}),t.jsx(Nn,{scale:e.norm}),e.autoscale&&t.jsx(In,{autoscale:e.autoscaleMode})]}),t.jsx(F.Menu,{className:"dropdown-menu-center",children:t.jsx("div",{className:"ms-1 me-1",children:t.jsxs(ve,{children:[t.jsx(A,{children:t.jsx("h6",{className:"flex-grow-1 text-center",children:"Lookup table"})}),t.jsx(A,{children:t.jsxs(E,{className:"flex-grow-1",children:[s("Greys","Gray"),s("Viridis","Viridis"),s("Cividis","Cividis"),s("Magma","Magma"),s("Inferno","Inferno"),s("Plasma","Plasma")]})}),t.jsx(A,{children:t.jsx(E,{className:"flex-grow-1 mt-1",children:a()})}),e.onSelectAutoscale&&t.jsxs(t.Fragment,{children:[t.jsx(A,{className:"mt-2",children:t.jsx("h6",{className:"flex-grow-1 text-center",children:"Autoscale"})}),t.jsx(A,{children:t.jsxs(E,{className:"flex-grow-1",children:[l(ae.Minmax),l(ae.StdDev3)]})}),t.jsx(A,{children:t.jsx(E,{className:"flex-grow-1 mt-1 mb-2",children:r()})})]}),t.jsx(A,{className:"mt-2",children:t.jsx("h6",{className:"flex-grow-1 text-center",children:"Normalization"})}),t.jsx(A,{children:t.jsxs(E,{className:"flex-grow-1",children:[i(ge.Linear,"Linear"),i(ge.Log,"Log"),i(ge.SymLog,"SymLog"),i(ge.Sqrt,"Sqrt")]})})]})})})]})}function Jn(e,n){const[o,s]=g.useState(!1),[a,i]=g.useState(!1),[l,r]=g.useState(void 0),[c,u]=g.useState(void 0),[m,d]=g.useState(),[x,h]=g.useState(new O(new w,new w(1,1))),[f,y]=g.useState(new O(new w,new w(1,1))),v=g.useCallback(()=>{r(void 0),u(void 0),d(void 0),h(new O(new w,new w(1,1))),y(new O(new w,new w(1,1)))},[r,u,d,h,y]);return g.useEffect(()=>{const b={width:256,height:256};if(e){if(e.defaults.baseURL==="mock"){const p=new Fn({width:2048,height:4096},b);r(p),u(p),d(void 0),h(new O(new w(-50,-100),new w(50,100))),y(new O(new w(-50,-100),new w(50,100)));return}if(!n){v();return}e.get(`/image_tiling/${n}`).then(p=>{const{status:j,output:M}=p.data;if(j!=="done"&&j!=="running")throw new Error("Status is not done");if(M.length!==2)throw new Error("Error in retrieve tiling information");const{location:S,hdf5_entry:C}=M[0],{location:D,hdf5_entry:I}=M[1];if(!S||!C)throw new Error("Error in retrieved tiling locations");return Promise.all([it(e,S,C),it(e,D,I),at(e,S,"/sequence/histogram/count"),at(e,S,"/sequence/histogram/bin_edges")])}).catch(p=>v()).then(p=>{if(!p){v();return}const{layers:j,yDomain:M,zDomain:S}=p[0];r(new rt(b,j)),h(new O(new w(M[0],S[0]),new w(M[1],S[1])));const{layers:C,yDomain:D,zDomain:I}=p[1];u(new rt(b,C)),y(new O(new w(D[0],I[0]),new w(D[1],I[1])));const R=Ln({values:p[2].data,bins:p[3].data});d({values:Ke(new Float64Array(R.values),[R.values.length]),bins:Ke(new Float64Array(R.bins),[R.bins.length])})})}},[n,e,o,v]),g.useEffect(()=>{if(!a)return()=>{};if(!c||!l)return v(),s(j=>!j),i(!1),()=>{};if(c.getPendingTilesCount()+l.getPendingTilesCount()===0)return v(),s(j=>!j),i(!1),()=>{};const p=setInterval(()=>{v(),s(j=>!j),i(!1)},1e3);return()=>{clearInterval(p)}},[c,l,a,v]),{apiFront:l,apiSide:c,histogram:m,tilingBoxFront:x,tilingBoxSide:f,invalidate:()=>{v(),s(b=>!b)},lazyRefresh:()=>{i(!0)}}}function Kn(e,n){const[o,s]=g.useState(void 0);return g.useEffect(()=>{if(!e&&!n){s(void 0);return}if(e==="mock"){s(()=>fe.create({baseURL:e}));return}s(n?()=>fe.create({baseURL:new URL(n,Wt()).toString(),...et.getOptions()}):void 0),e&&fe.get("status",{baseURL:e,timeout:3e3}).then(a=>s(()=>fe.create({baseURL:e}))).catch(()=>{})},[e,n,et.token]),o}const ut=q("daiquiri.services.TomovisService");function eo(e,n,o){const[s,a]=g.useState([]),[i,l]=g.useState(null),[r,c]=g.useState("UNKNOWN"),u=g.useCallback(f=>{let y=0;f.forEach(v=>{v.status!=="done"&&(y+=1),v.id===n&&(v.status==="done"||v.status==="running")&&l(n)}),c(y?"PROCESSING":"READY")},[n,i,c]),m=g.useCallback(()=>{e&&(e.defaults.baseURL==="mock"&&a([{id:"chessboard",status:"done",create_time:"1871-03-18"}]),e.get("/image_tiling/").then(f=>{const y=f.data.items;if(y===void 0)throw new Error("No items field received.");u(y),a(v=>Te.isEqual(v,y)?v:y)}).catch(f=>{f.response.status===404?c("OFFLINE"):(c("FAILED"),console.error("Error while reading available tomovis tiling",f))}))},[e,i,n,u,c]);g.useEffect(()=>{m()},[m]);const d=g.useCallback(f=>{e&&e.delete(`/image_tiling/${f}`).then(y=>{const v=s.filter(b=>b.id!==f);return a(v),null}).catch(y=>{console.error('Error while requesting tiling deletion: "%s"',f,y)})},[e,s]),[x,h]=g.useState(o);return g.useEffect(()=>{const f=setInterval(()=>{m()},x);return()=>clearInterval(f)},[m,x]),g.useEffect(()=>{n&&n!==i||r==="PROCESSING"?o>2e3&&(ut("Polling every %sms",2e3),h(2e3)):(ut("Polling every %sms",o),h(o))},[i,n,o,r]),{imageTilings:s,lastReadyImageTiling:i,updateImageTilings:m,deleteImageTiling:d,state:r}}function le(e){const{startPoint:n,endPoint:o,lineWidth:s=1,lineColor:a="black",gapColor:i,gapSize:l,dashSize:r,opacity:c=1,zIndex:u=1}=e;return t.jsxs(t.Fragment,{children:[t.jsx(lt,{y:n[1],x1:n[0],x2:o[0],zIndex:u,color:a,gapColor:i,gapSize:l,dashSize:r,opacity:c,lineWidth:s}),t.jsx(lt,{y:o[1],x1:n[0],x2:o[0],zIndex:u,color:a,gapColor:i,gapSize:l,dashSize:r,opacity:c,lineWidth:s}),t.jsx(ye,{x:n[0],y1:n[1],y2:o[1],zIndex:u,color:a,gapColor:i,gapSize:l,dashSize:r,opacity:c,lineWidth:s}),t.jsx(ye,{x:o[0],y1:n[1],y2:o[1],zIndex:u,color:a,gapColor:i,gapSize:l,dashSize:r,opacity:c,lineWidth:s})]})}const to=q("daiquiri.components.tomo.tiling.ActualDetectorLocation");function no(e){const n=(e.rotation+e.projRotation)/180*Math.PI,{x:o,y:s,fov:a}=e,i=Math.abs(Math.cos(n)*a[0]*.5),l=a[1]*.5,r=[o-a[0]*.5,s-a[1]*.5],c=[o+a[0]*.5,s+a[1]*.5],u=t.jsx(t.Fragment,{children:t.jsx(le,{startPoint:r,endPoint:c,lineColor:T.danger,gapColor:T.light,dashSize:4,gapSize:4,lineWidth:1,zIndex:2})});return i<.001?t.jsxs(t.Fragment,{children:[u,t.jsx(ye,{x:o,y1:s-l,y2:s+l,color:T.danger,lineWidth:2,zIndex:2})]}):t.jsxs(t.Fragment,{children:[u,t.jsx(le,{startPoint:[o-i,s-l],endPoint:[o+i,s+l],lineColor:T.danger,lineWidth:2,zIndex:2})]})}function oo(e){const{xAxisDelta:n,y:o,fov:s,detectorX:a}=e,i=s?s[1]*.5:50;function l(h){const{startPoint:f,endPoint:y}=h;return t.jsx(ye,{x:f.x,y1:f.y,y2:y.y,dashSize:8,gapSize:4,color:T.danger,gapColor:T.light})}const r=a+n;if(s===null){const h=new k(r,o-i),f=new k(r,o+i);return t.jsxs(t.Fragment,{children:[t.jsx(Y,{datapos:[r+1,o-i],color:T.danger,text:"Axis"}),t.jsx(l,{startPoint:h,endPoint:f})]})}if(Math.abs(n)*2>s[0]){const h=s[0]*.5,f=new k(r,o-h-i),y=new k(r,o+h+i);return t.jsxs(t.Fragment,{children:[t.jsx(Y,{datapos:[r+1,o-i],color:T.danger,text:"Axis"}),t.jsx(l,{startPoint:f,endPoint:y})]})}const c=s[1]*.5,u=new k(r,o-c),m=new k(r,o-c-i),d=new k(r,o+c),x=new k(r,o+c+i);return t.jsxs(t.Fragment,{children:[t.jsx(Y,{datapos:[r+1,o-c-i],color:T.danger,text:"Axis"}),t.jsx(l,{startPoint:u,endPoint:m}),t.jsx(l,{startPoint:d,endPoint:x})]})}function so(e){const{tomoHardware:n}=e,{sy:o,sz:s,somega:a,sampu:i,sampv:l,tomoDetector:r,detector:c,sampleStage:u}=n;if(o===null||s===null)return to("Skipped: one of sy, sz is missing."),t.jsx(t.Fragment,{});function m(I){if(I===null)return null;const{position:R}=I.properties;if(R===null)return R;const _=St(I)?1:-1;return R*_}const d=(u==null?void 0:u.properties.detector_center)??[0,0],x=d[0]??0,h=d[1]??0,f=K(s),y=X(i)??0,v=X(l)??0,b=K(o),p=m(a),j=te(r,c);function M(){const I=e.projRotation*Math.PI/180;return-Math.sin(I)*y+Math.cos(I)*v+b}const S=M()-x,C=f-h,D=b-x;return t.jsxs(t.Fragment,{children:[t.jsx(Vn,{x:S,y:C,color:T.danger,sizeInScreen:20,lineWidth:2,zIndex:2}),t.jsx(Y,{datapos:[S-(j?j[0]*.5:0)+1,C-(j?j[1]*.5:0)],color:T.danger,text:(c==null?void 0:c.name)??"Detector"}),p!==null&&j!==null&&t.jsx(no,{x:S,y:C,fov:j,rotation:p,projRotation:e.projRotation}),t.jsx(oo,{xAxisDelta:D,y:C,fov:j,detectorX:S})]})}function Ve(e,n){if(e===null||n===null)return null;const o=e.properties.sample_pixel_size,s=n.properties.size;if(s===null||o===null)return null;const a=o/1e3;return[s[0]*a,s[1]*a]}function Rt(e,n){const{sy:o,sz:s,sampu:a,sampv:i,tomoDetector:l,detector:r}=e;if(s===null)return{motorBox:new O,visibleBox:new O,maxBox:new O};const c=n*Math.PI/180,u=o?K(o):0,[m,d]=he(o),[x,h]=he(a),[f,y]=he(i),[v,b]=he(s),p=-Math.sin(c)*x+Math.cos(c)*f+u,j=-Math.sin(c)*h+Math.cos(c)*y+u,M=Ve(l,r),[S,C]=M||[0,0],{sampleStage:D}=e,I=(D==null?void 0:D.properties.detector_center)??[0,0],R=I[0]??0,_=I[1]??0,$=new O().setFromPoints([new w(p-R,v-_),new w(j-R,b-_)]),B=$.clone().expandByVector(new w(S*.5,C*.5)),z=new O().setFromPoints([new w(x+f+m-R,v-_),new w(h+y+d-R,b-_)]).expandByVector(new w(S*.5,C*.5));return{motorBox:$,visibleBox:B,maxBox:z}}function Se(e){const{sz:n,sampu:o,sampv:s}=e;if(n===null)return;const a=X(o)??0,i=X(s)??0,l=K(n),{sampleStage:r}=e,c=(r==null?void 0:r.properties.detector_center)??[0,0],u=c[0]??0,m=c[1]??0;return new k(a-u,i-u,l-m)}function io(e){const{projRotation:n,tomoHardware:o}=e,{motorBox:s,visibleBox:a}=Rt(o,n);return t.jsxs(t.Fragment,{children:[!s.isEmpty()&&t.jsxs(t.Fragment,{children:[t.jsx(Y,{datapos:a.min,color:T.info,text:"Visible limit"}),t.jsx(le,{startPoint:[a.min.x,a.min.y],endPoint:[a.max.x,a.max.y],lineColor:T.info,dashSize:8,gapSize:4})]}),!a.isEmpty()&&t.jsxs(t.Fragment,{children:[t.jsx(Y,{datapos:s.min,color:T.info,text:"Motor limit"}),t.jsx(le,{startPoint:[s.min.x,s.min.y],endPoint:[s.max.x,s.max.y],lineColor:T.info,dashSize:2,gapSize:2})]})]})}const ao=2;function Nt(e){return t.jsxs(A,{className:"flex-nowrap",xs:12,children:[t.jsx(L,{xs:3,children:e.title}),t.jsx(L,{className:"text-end",xs:6,children:e.value.toFixed(ao)}),t.jsx(L,{className:"text-start",xs:3,children:e.unit})]})}function Ne(e){const{motor:n}=e,[o,s]=Mt(n,e.position),a=(n==null?void 0:n.alias)??(n==null?void 0:n.name)??e.defaultName;return t.jsx(Nt,{title:a,value:o,unit:s})}function ro(e){const{tomoHardware:n,value:o}=e,{sampleStage:s}=n,a=(s==null?void 0:s.properties.detector_center)??[0,0],i=a[0]??0,l=a[1]??0,r=n.sy?K(n.sy):0;return t.jsxs(ve,{children:[e.x!==void 0&&t.jsx(Ne,{motor:n.sampu,position:e.x-r+i,defaultName:"sample-u-axis"}),e.y!==void 0&&t.jsx(Ne,{motor:n.sampv,position:e.y-r+i,defaultName:"sample-v-axis"}),e.z!==void 0&&t.jsx(Ne,{motor:n.sz,position:e.z+l,defaultName:"z-axis"}),t.jsx(Nt,{title:"intensity",value:o,unit:""})]})}function co(e,n){return e.expandByVector(e.getSize(new w).multiplyScalar(n*.5))}function lo(e){return{x:[e.min.x,e.max.x],y:[e.min.y,e.max.y]}}function uo(e){const{task:n,view:o,dragTomoScanRoi:s,readOnly:a=!1}=e,{active:i,roi:l}=n,{centerZ:r,width:c,height:u}=l,{x:m,y:d}=l.center,x=g.useCallback((v,b)=>{const p=(v.x1+v.x2)*.5,j=(v.y1+v.y2)*.5;s(n.id,o==="front"?p:m,o==="front"?d:p,j)},[o,s,m,d,r]);if(c===null||u===null||c===null||u===null)return null;const h=o==="front"?m:d,f=new w(h-c/2,r-u/2),y=new w(h+c/2,r+u/2);return t.jsx(je,{geometry:{x1:f.x,y1:f.y,x2:y.x,y2:y.y},color:T.info,lineWidth:2,readOnly:!i,onGeometryChanged:x})}function mt(e,n){return n[0]<n[1]?n[0]<=e&&e<=n[1]:n[1]<=e&&e<=n[0]}function mo(e,n){return mt(e.x,n.xVisibleDomain)&&mt(e.y,n.yVisibleDomain)}function xo(e,n){const o=e===null||n===null?null:new k(e,n),{dataToHtml:s,getVisibleDomains:a}=vn();return jn(i=>{if(o===null)return null;const l=a(i);return{isVisible:mo(o,l),displayedCoords:s(i,o)}},[e,n])}const fo=q("daiquiri.components.tomo.tiling.MotorMarker"),go=g.forwardRef((e,n)=>{const{popper:o,children:s,show:a,displayed:i,displayedCoords:l,...r}=e;return g.useEffect(()=>{o&&o.scheduleUpdate()},[s,o]),g.useEffect(()=>{o&&o.scheduleUpdate()},[l,o]),t.jsx(ce,{ref:n,body:!0,...r,children:s})});function Ie(e){const{motor:o}=e,[s,a]=Mt(o,e.position),i=(o==null?void 0:o.alias)??(o==null?void 0:o.name)??e.defaultName;return t.jsxs(A,{className:"flex-nowrap text-nowrap",xs:12,children:[t.jsx(L,{xs:3,children:i}),t.jsx(L,{className:"text-end",xs:6,children:s.toFixed(2)}),t.jsx(L,{className:"text-start",xs:3,children:t.jsx("span",{className:"text-nowrap",children:a})})]})}function ho(e){const{tomoHardware:n,projRotation:o,variant:s="primary"}=e,[a,i]=g.useState(!1),l=g.useRef(null);function r(){if(o===0){const[M,S,C]=e.coords;return[S,C]}else if(o===-90){const[M,S,C]=e.coords;return[M,C]}return console.error(`Unimplemented projRotation ${o}`),[null,null]}const[c,u]=r(),m=xo(c,u);if(c===null||u===null)return fo("Skipped: projected pixel size is null."),t.jsx(t.Fragment,{});const[d,x,h]=e.coords,f=n.sy?K(n.sy):0,{sampleStage:y}=n,v=(y==null?void 0:y.properties.detector_center)??[0,0],b=v[0]??0,p=v[1]??0,j=t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"text-end mb-2",children:t.jsx(N,{size:"sm",variant:"light",onClick:()=>{e.onDelete&&e.onDelete(s)},title:"Remove the marker",children:t.jsx("i",{className:"fa fa-fw fa-trash fa-lg"})})}),t.jsxs(ve,{children:[d!==null&&t.jsx(Ie,{motor:n.sampu,position:d-f+b,defaultName:"sample-u-axis"}),x!==null&&t.jsx(Ie,{motor:n.sampv,position:x-f+b,defaultName:"sample-v-axis"}),h!==null&&t.jsx(Ie,{motor:n.sz,position:h+p,defaultName:"z-axis"}),(e.onDelete||e.onMove)&&t.jsx(A,{className:"g-0 mt-2 justify-content-center",children:t.jsxs(E,{children:[t.jsx(N,{size:"sm",variant:"danger",title:"Move the sample stage at this location",onClick:()=>{e.onMove&&e.onMove(s)},children:"Move motors"}),t.jsx(N,{size:"sm",variant:"secondary",title:"Copy bliss command to clipboard",onClick:()=>{e.onCopyToClipboard&&e.onCopyToClipboard(s)},children:t.jsx("i",{className:"fa fa-fw fa-clipboard"})})]})})]})]});return t.jsx(t.Fragment,{children:t.jsx(pn,{x:c,y:u,children:t.jsx(wt,{trigger:"click",rootClose:!0,overlay:t.jsx(go,{id:"popover-contained",show:a&&!(m!=null&&m.isVisible),displayed:a,displayedCoords:(m==null?void 0:m.displayedCoords)??null,children:j}),children:t.jsx(bt,{bg:"none",onClick:()=>i(!a),style:{pointerEvents:"auto",top:"50%",left:"50%",position:"relative",transform:"translate(-100%, -100%)"},children:t.jsx("i",{ref:l,style:{cursor:"pointer"},className:`fa fa-map-marker fa-3x text-${s}`})})})})})}function yo(e){const{getCenter:n}=e,[o,s]=H("tomo/tiling/markers",{}),a=g.useCallback((i,l,r,c)=>{const u=n()??{x:null,y:null,z:null},m=o[i]??[null,null,null],d={...o},x=l===null&&r===null&&c===null;d[i]=x?[null,null,null]:[l??m[0]??u.x,r??m[1]??u.y,c??m[2]??u.z],s(d)},[s,o]);return[o,a]}function vo(e){return t.jsx(t.Fragment,{children:Te.map(e.markers,(n,o)=>t.jsx(ho,{projRotation:e.projRotation,tomoHardware:e.tomoHardware,variant:o,coords:n,onDelete:s=>{e.setMarker(s,null,null,null)},onMove:s=>{const a=e.markers[s],i=e.computeSampleStageAtPlotLocation(a[0],a[1],a[2]);ke(i)},onCopyToClipboard:s=>{const a=e.markers[s],i=e.computeSampleStageAtPlotLocation(a[0],a[1],a[2]);function l(c,u,m){if(m===void 0||u===null)return;const d=m.to(u.properties.unit).scalar;c.push(`${u.alias??u.name}`,`${d.toFixed(4)}`)}const r=[];l(r,e.tomoHardware.sz,i.sz),l(r,e.tomoHardware.sampu,i.sampu),l(r,e.tomoHardware.sampv,i.sampv),navigator.clipboard.writeText(`umv(${r.join(", ")})`)}},o))})}function jo(e){const{disabled:n,projRotation:o,selectedMarker:s,setMarker:a}=e,i=g.useCallback(l=>{if(n){console.error("Unexpected click action");return}o===0?a(s,null,l.dataPt.x,l.dataPt.y):o===-90?a(s,l.dataPt.x,null,l.dataPt.y):console.error(`Unexpected projRotation ${o}`)},[n,o,a,s]);return t.jsx(t.Fragment,{children:!n&&t.jsx(Oe,{onClick:i})})}const It=q("daiquiri.components.tomo.tiling.TilingInteraction");function po(e){const{disabled:n,onActionRequested:o,projRotation:s,computeSampleStageAtPlotLocation:a,sampleStage:i}=e,{sy:l}=i,r=g.useCallback(c=>{if(o(),s===0){const u=c.dataPt.x,m=c.dataPt.y,d=a(null,u,m);ke(d)}else if(s===-90){const u=c.dataPt.x,m=c.dataPt.y,d=a(u,null,m);ke(d)}else console.error(`Unexpected projRotation ${s}`)},[l,a,o]);return n?(It("MoveMotorInteraction disabled."),t.jsx(t.Fragment,{})):t.jsx(Oe,{onClick:r})}function So(e){const{disabled:n,roiFov:o,projRotation:s,actions:a,onActionRequested:i}=e,l=g.useCallback((c,u,m)=>{o&&a.createScanTask({x:new G(c,"mm"),y:new G(u,"mm"),z:new G(m,"mm"),detector:o.detector,magnification:o.magnification,fov:[new G(o.fov[0],"mm"),new G(o.fov[1],"mm")],pixelSize:[new G(o.pixelSize[0],"um"),new G(o.pixelSize[1],"um")],active:!0})},[o,a]),r=g.useCallback(c=>{i(),s===0?l(c.dataPt.x,0,c.dataPt.y):s===-90?l(0,c.dataPt.x,c.dataPt.y):console.error(`Unexpected projRotation ${s}`)},[l,i,s]);return n||o===null?(It("CreateRoiInteraction disabled."),t.jsx(t.Fragment,{})):t.jsx(Oe,{onClick:r})}function wo(e){const{projRotation:n,mouseMode:o,resetMouseMode:s,actions:a,computeSampleStageAtPlotLocation:i,operator:l,sampleStage:r,roiFov:c,markerName:u,setMarker:m,mouseOverlay:d}=e;return t.jsxs(t.Fragment,{children:[t.jsx($n,{mouseMode:o,disabled:d!==void 0,plotUnit:"mm"}),t.jsx(So,{projRotation:n,disabled:d!==void 0||o!=="create",roiFov:c,actions:a,onActionRequested:()=>s()}),t.jsx(po,{projRotation:n,disabled:d!==void 0||!l||o!=="move-motors",computeSampleStageAtPlotLocation:i,sampleStage:r,onActionRequested:()=>s()}),t.jsx(jo,{projRotation:n,disabled:d!==void 0||o!=="mark-position",selectedMarker:u,setMarker:m})]})}function bo(e){const{api:n,box:o,renderTooltip:s,...a}=e;if(!n||o.isEmpty())return null;const i=o.getSize(new w),l=o.getCenter(new w);return t.jsxs("group",{position:[l.x,l.y,0],children:[t.jsx(Sn,{api:n,size:{width:i.x,height:i.y},...a}),s&&t.jsx(wn,{size:i,renderTooltip:s})]})}class zo extends Qt{constructor(){super({uniforms:{color:{value:new Jt},size:{value:new w},nbCells:{value:new w},overlap:{value:new w},scaleX:{value:0},scaleY:{value:0},lineWidth:{value:0}},vertexShader:`
uniform float scaleX; // signed scale
uniform float scaleY; // signed scale
out vec2 pixelCoord;
// out vec2 dataCoord;

void main() {
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    vec2 pixelScale = abs(vec2(scaleX, scaleY));
    // dataCoord = vec2(position.x, position.y);
    pixelCoord = vec2(position.x, position.y) / pixelScale;
}
      `,fragmentShader:`
uniform vec4 color;
uniform vec4 gapColor;
uniform float gapSize;
uniform float dashSize;
uniform float lineWidth;
uniform float scaleX;  // signed scale
uniform float scaleY;  // signed scale
uniform vec2 size;
uniform vec2 nbCells;
uniform vec2 overlap;
in vec2 pixelCoord;

/**
 * @param position: pixel position
 * @param size: size of the rectangle
 * @param nbCells: number of cells
 * @param overlap: size of the overlap in ratio of a cell
 *                 (0.5 means same size with the cell)
 */
float sdf_grid(in vec2 position, in vec2 size, in vec2 nbCells, in vec2 overlap) {
    vec2 maxSize = size / (nbCells - overlap * (nbCells - 1.0));
    vec2 tableDist = min(abs(abs(position) - size * 0.5), maxSize);
    vec2 overlapSize = maxSize * overlap;
    vec2 cellSize = maxSize - overlapSize;
    vec2 p = position - cellSize * 0.5 * (1.0 - mod(nbCells, 2.0));
    vec2 gridDist = abs(abs(mod(p, cellSize)) - cellSize * 0.5);
    gridDist -= overlapSize * 0.5;
    gridDist = max(gridDist, cellSize  - tableDist);
    return min(gridDist.x, gridDist.y);
}

void main() {
    vec2 scale = abs(vec2(scaleX, scaleY));
    float d = sdf_grid(pixelCoord, size / scale, nbCells, overlap);

    //#define DEBUG_DIST
    #ifdef DEBUG_DIST
        vec2 n = size / nbCells / scale;
        float c = d / min(n.x, n.y);
        gl_FragColor = vec4(max(-c, 0.0), abs(c), max(c, 0.0), 1.0);
        return;
    #endif

    if (d > lineWidth) {
      discard;
    }
    float alpha;
    if (lineWidth >= 1.0) {
        alpha = smoothstep(1.0, 0.0, d - lineWidth * 0.5);
    } else {
        // simulate line thiner than 1px with alpha
        alpha = lineWidth;
    }
    gl_FragColor = vec4(color.rgb, color.a * alpha);
}
      `})}}Xt({GridDashMaterial:zo});function Pt(e){const{center:n,size:o,nbCells:s,overlap:a=[0,0],lineWidth:i=1,color:l="black",opacity:r=1,zIndex:c=0}=e,u=g.useRef(null),m=An();return g.useEffect(()=>{const d=Gn(l,r);if(u.current){const x=u.current.uniforms;x.color.value=d,x.size.value=o,x.nbCells.value=s,x.overlap.value=a,x.lineWidth.value=i,Kt()}},[l,o,s,a,r,i]),en(({camera:d})=>{if(u.current===null)return;const x=d.scale.x/m.sx,h=d.scale.y/m.sy,f=u.current.uniforms;f.scaleX.value=x,f.scaleY.value=h}),t.jsx("group",{position:[n[0],n[1],c],children:t.jsxs("mesh",{children:[t.jsx("ambientLight",{}),t.jsx("planeGeometry",{attach:"geometry",args:[o[0],o[1],1,1]}),t.jsx("gridDashMaterial",{attach:"material",transparent:!0,ref:u})]})})}const Co=q("daiquiri.components.tomo.tiling.rois.CubeRoi");function xt(e,n){return n===0?new w(e.y,e.z):n===-90?new w(e.x,e.z):(console.error(`Unimplemented projRotation ${n}`),null)}function Mo(e,n){return n===void 0?{}:e===0?{nbRow:n.z,nbCol:n.y}:e===-90?{nbRow:n.z,nbCol:n.x}:{}}function Do(e,n,o){if(e===null)return{box:new O};const s=xt(e.start,n),a=xt(e.stop,n);if(s===null||a===null)return{box:new O};const i=Mo(n,o);return{box:new O().setFromPoints([s,a]),...i}}function kt(e,n,o){function s(a,i,l){return l===0?new k((a==null?void 0:a.x)??0,i.x,i.y):l===-90?new k(i.x,(a==null?void 0:a.y)??0,i.y):(console.error(`Unexpected projRotation ${l}`),a)}return{start:s(e.start,new w(n.x1,n.y1),o),stop:s(e.stop,new w(n.x2,n.y2),o)}}function ft(e,n,o){const s={x1:n[0].x,y1:n[0].y,x2:n[1].x,y2:n[1].y};return kt(e,s,o)}function Ro(e){const n=Se(e),{tomoDetector:o,detector:s}=e,a=te(o,s)??[1,1];return n?{start:new k(n.x-a[0]*1.4,n.y-a[0]*1.4,n.z-a[1]*1.4),stop:new k(n.x+a[0]*1.4,n.y+a[0]*1.4,n.z+a[1]*1.4)}:(console.error("oups center",n),Co("Roi reset skipped: center is undefined."),null)}function No(e){const{roi:n,projRotation:o,maxCellSize:s=[0,0]}=e,a=g.useCallback((x,h)=>{const f=kt(n,x,o);h?e.onDragMove&&e.onDragMove(f):e.onDragEnd&&e.onDragEnd(f)},[n,e.onDragMove,e.onDragEnd,o]),{box:i,nbRow:l,nbCol:r}=Do(n,o,e.grid),c=new w;i.getSize(c);const u=new w;i.getCenter(u);function m(){if(e.readOnly)return;const[x,h]=s,f=Math.ceil(c.x/x),y=Math.ceil(c.y/h),v=(x*f-c.x)/(f-1),b=(h*y-c.y)/(y-1),p=f<=1?0:v/x,j=y<=1?0:b/h;return[p,j]}const d=m();return t.jsxs(t.Fragment,{children:[t.jsx(Y,{datapos:[(i.min.x+i.max.x)*.5,i.min.y],text:e.label??"",color:e.color,anchor:"bottom"}),t.jsx(Pt,{center:[u.x,u.y],size:[c.x,c.y],color:e.color,opacity:.25,nbCells:[r??1,l??1],overlap:d,lineWidth:1,zIndex:.5}),t.jsx(je,{geometry:{x1:i.min.x,y1:i.min.y,x2:i.max.x,y2:i.max.y},readOnly:e.readOnly,onGeometryChanged:a,color:e.color})]})}function Io(e,n,o){return g.useMemo(()=>{const s=te(n,o);if(s===null)return;const a=new k;return a.add(e.start),a.sub(e.stop),[new k(Math.ceil(Math.abs(a.x)/s[0]),Math.ceil(Math.abs(a.y)/s[0]),Math.ceil(Math.abs(a.z)/s[1])),s]},[e,n])}function Po(e){const[n,o]=Io(e.roi,e.tomoDetector,e.detector)??[void 0,void 0];return t.jsx(No,{roi:e.roi,grid:n,maxCellSize:o,onDragEnd:e.onDragEnd,onDragMove:e.onDragMove,projRotation:e.projRotation,color:T.success,label:"Tiling",readOnly:e.readOnly})}function ko(e){const{disabled:n,projRotation:o,geometry:s,onGeometryChanged:a,sampleStage:i,resetMouseMode:l}=e,r=Ae();return t.jsx(Le,{id:e.id,disabled:n||(r==null?void 0:r.overlayCursor)!==void 0,onSelectionStart:()=>{r==null||r.actions.captureMouseInteraction()},onSelectionEnd:()=>{r==null||r.actions.releaseMouseInteraction(),l()},onSelectionChange:c=>{if(c===void 0)return;function u(){return s||Ro(i)}const m=u();if(m===null)return;const d=ft(m,c.data,o);a(d)},onValidSelection:c=>{if(s===null)return;const u=ft(s,c.data,o);a(u)},children:c=>t.jsx(t.Fragment,{})})}q("daiquiri.components.tomo.tiling.FlatLocation");function To(e){const{x:n,y:o,fov:s}=e,a=s[0]*.5,i=s[1]*.5;return t.jsx(le,{startPoint:[n-a,o-i],endPoint:[n+a,o+i],lineColor:T.secondary,lineWidth:2,zIndex:2})}function gt(e,n){return g.useMemo(()=>{if(n===null||e===void 0)return null;for(const o of e){const s=o.axisRef.slice(9);if(s===n.alias||s===n.id||s===n.name)return o}return null},[e,n==null?void 0:n.alias,n==null?void 0:n.name,n==null?void 0:n.id])}function Fo(e){const{tomoHardware:n,tomoFlatMotion:o}=e,{sy:s,sz:a,sampu:i,sampv:l,tomoDetector:r,detector:c,sampleStage:u}=n,m=gt(o==null?void 0:o.properties.motion,s),d=gt(o==null?void 0:o.properties.motion,a);if(m===null&&d===null)return t.jsx(t.Fragment,{});const x=(u==null?void 0:u.properties.detector_center)??[0,0],h=x[0]??0,f=x[1]??0,y=X(a),v=X(i)??0,b=X(l)??0,p=X(s),j=te(r,c);if(j===null)return t.jsx(t.Fragment,{});function M(){const z=e.projRotation*Math.PI/180;return y===null||p===null?null:[-Math.sin(z)*v+Math.cos(z)*b+p-h,y-f]}const S=(d==null?void 0:d.absolute_position)??null,C=(d==null?void 0:d.relative_position)??null,D=(m==null?void 0:m.absolute_position)??null,I=(m==null?void 0:m.relative_position)??null;function R(){if(D!==null&&S!==null)return[D,S];const z=M();if(z===null)return null;const P=D??z[0]+(I??0),Q=S??z[1]+(C??0);return[P,Q]}const _=R();if(_===null)return t.jsx(t.Fragment,{});const[$,B]=_;return t.jsxs(t.Fragment,{children:[t.jsx(Y,{vmargin:0,hmargin:0,anchor:"center",datapos:[$,B],color:T.primary,text:"Flat"}),t.jsx(To,{x:$,y:B,fov:j})]})}const Eo=q("daiquiri.components.tomo.Point3DRoi");function Lo(e,n){return e===null?{x:0,y:0}:n===0?{x:e.y,y:e.z}:n===-90?{x:e.x,y:e.z}:(console.error(`Unimplemented projRotation ${n}`),{x:0,y:0})}function Ao(e,n,o){const s=(n.x1+n.x2)*.5,a=(n.y1+n.y2)*.5;return o===0?{x:e.x,y:s,z:a}:o===-90?{x:s,y:e.y,z:a}:(console.error(`Unimplemented projRotation ${o}`),{x:0,y:0,z:0})}function ht(e,n,o){const{x:s,y:a}=n[1];return o===0?{x:e.x,y:s,z:a}:o===-90?{x:s,y:e.y,z:a}:(console.error(`Unexpected projRotation ${o}`),e)}function Oo(e){const n=Se(e);return n?{x:n.x,y:n.y,z:n.z}:(Eo("Roi reset skipped: center is undefined."),null)}function _o(e){const{roi:n,projRotation:o,cellSize:s=[0,0]}=e,a=g.useCallback((l,r)=>{const c=Ao(n,l,o);r?e.onDragMove&&e.onDragMove(c):e.onDragEnd&&e.onDragEnd(c)},[n,e.onDragMove,e.onDragEnd,o]),i=Lo(n,o);return t.jsxs(t.Fragment,{children:[t.jsx(Y,{datapos:[i.x,i.y-s[1]*.5],text:e.label??"",color:e.color,anchor:"bottom"}),t.jsx(je,{geometry:{x1:i.x-s[0]*.5,y1:i.y-s[1]*.5,x2:i.x+s[0]*.5,y2:i.y+s[1]*.5},readOnly:e.readOnly,onGeometryChanged:a,color:e.color})]})}function Vo(e){const n=g.useMemo(()=>te(e.tomoDetector,e.detector),[e.tomoDetector,e.detector]);return t.jsx(_o,{roi:e.roi,cellSize:n??void 0,onDragEnd:e.onDragEnd,onDragMove:e.onDragMove,projRotation:e.projRotation,color:T.success,label:"Tomo",readOnly:e.readOnly})}function $o(e){const{disabled:n,projRotation:o,geometry:s,onGeometryChanged:a,sampleStage:i,resetMouseMode:l}=e,r=Ae();return t.jsx(Le,{id:e.id,disabled:n||(r==null?void 0:r.overlayCursor)!==void 0,onSelectionStart:()=>{r==null||r.actions.captureMouseInteraction()},onSelectionEnd:()=>{r==null||r.actions.releaseMouseInteraction(),l()},onSelectionChange:c=>{if(c===void 0)return;function u(){return s||Oo(i)}const m=u();if(m===null)return;const d=ht(m,c.data,o);a(d)},onValidSelection:c=>{if(s===null)return;const u=ht(s,c.data,o);a(u)},children:c=>t.jsx(t.Fragment,{})})}const Bo=q("daiquiri.components.tomo.Point3DRoi");function Go(e,n){return e===null?{x:0,ystart:0,ystop:0}:n===0?{x:e.y,ystart:e.zstart,ystop:e.zstop}:n===-90?{x:e.x,ystart:e.zstart,ystop:e.zstop}:(console.error(`Unimplemented projRotation ${n}`),{x:0,ystart:0,ystop:0})}function Ho(e,n,o){const s=(n.x1+n.x2)*.5;return(n.y1+n.y2)*.5,o===0?{x:e.x,y:s,zstart:n.y1,zstop:n.y2}:o===-90?{x:s,y:e.y,zstart:n.y1,zstop:n.y2}:(console.error(`Unimplemented projRotation ${o}`),{x:0,y:0,zstart:0,zstop:0})}function yt(e,n,o){const{x:s,y:a}=n[0];return o===0?{x:e.x,y:s,zstart:n[0].y,zstop:n[1].y}:o===-90?{x:s,y:e.y,zstart:n[0].y,zstop:n[1].y}:(console.error(`Unexpected projRotation ${o}`),e)}function Yo(e){const n=Se(e),{tomoDetector:o,detector:s}=e,a=Ve(o,s)??[1,1];return n?{x:n.x,y:n.y,zstart:n.z-a[0]*.5,zstop:n.z-a[0]*.5}:(Bo("Roi reset skipped: center is undefined."),null)}function Uo(e){const{roi:n,projRotation:o,cellSize:s=[0,0]}=e,a=g.useCallback((x,h)=>{const f=Ho(n,x,o);h?e.onDragMove&&e.onDragMove(f):e.onDragEnd&&e.onDragEnd(f)},[n,e.onDragMove,e.onDragEnd,o]),i=Go(n,o),l=Math.abs(i.ystop-i.ystart),r=(i.ystart+i.ystop)*.5,c=s[1],u=Math.ceil(l/c);function m(){if(e.readOnly)return;const x=(c*u-l)/(u-1);return[0,u<=1?0:x/c]}const d=m();return t.jsxs(t.Fragment,{children:[t.jsx(Y,{datapos:[i.x,Math.min(i.ystart,i.ystop)],text:e.label??"",color:e.color,anchor:"bottom"}),t.jsx(Y,{datapos:[i.x,i.ystart],text:"Start",color:e.color,anchor:"top"}),t.jsx(Y,{datapos:[i.x,i.ystop],text:"Stop",color:e.color,anchor:"top"}),t.jsx(Pt,{center:[i.x,r],size:[s[0],l],color:e.color,opacity:.25,nbCells:[1,u??1],overlap:d,lineWidth:1,zIndex:.5}),t.jsx(je,{geometry:{x1:i.x-s[0]*.5,y1:i.ystart,x2:i.x+s[0]*.5,y2:i.ystop},readOnly:e.readOnly,onGeometryChanged:a,color:e.color})]})}function Zo(e){const n=g.useMemo(()=>te(e.tomoDetector,e.detector),[e.tomoDetector,e.detector]);return t.jsx(Uo,{roi:e.roi,cellSize:n??void 0,onDragEnd:e.onDragEnd,onDragMove:e.onDragMove,projRotation:e.projRotation,color:T.success,label:"Zseries",readOnly:e.readOnly})}function qo(e){const{disabled:n,projRotation:o,geometry:s,onGeometryChanged:a,sampleStage:i,resetMouseMode:l}=e,r=Ae();return t.jsx(Le,{id:e.id,disabled:n||(r==null?void 0:r.overlayCursor)!==void 0,onSelectionStart:()=>{r==null||r.actions.captureMouseInteraction()},onSelectionEnd:()=>{r==null||r.actions.releaseMouseInteraction(),l()},onSelectionChange:c=>{if(c===void 0)return;function u(){return s||Yo(i)}const m=u();if(m===null)return;const d=yt(m,c.data,o);a(d)},onValidSelection:c=>{if(s===null)return;const u=yt(s,c.data,o);a(u)},children:c=>t.jsx(t.Fragment,{})})}function Wo(e){const{color:n="black",domainX:o,domainY:s,zIndex:a=0}=e,i=Math.abs(o[1]-o[0]),l=(o[0]+o[1])*.5,r=Math.abs(s[1]-s[0]),c=(s[0]+s[1])*.5;return t.jsxs(t.Fragment,{children:[t.jsxs("mesh",{position:[l-i,c,a],children:[t.jsx("ambientLight",{}),t.jsx("planeGeometry",{attach:"geometry",args:[i,r*10,1,1]}),t.jsx("meshBasicMaterial",{attach:"material",color:n,opacity:1})]}),t.jsxs("mesh",{position:[l+i,c,a],children:[t.jsx("ambientLight",{}),t.jsx("planeGeometry",{attach:"geometry",args:[i,r*10,1,1]}),t.jsx("meshBasicMaterial",{attach:"material",color:n,opacity:1})]}),t.jsxs("mesh",{position:[l,c-r,a],children:[t.jsx("ambientLight",{}),t.jsx("planeGeometry",{attach:"geometry",args:[i*10,r,1,1]}),t.jsx("meshBasicMaterial",{attach:"material",color:n,opacity:1})]}),t.jsxs("mesh",{position:[l,c+r,a],children:[t.jsx("ambientLight",{}),t.jsx("planeGeometry",{attach:"geometry",args:[i*10,r,1,1]}),t.jsx("meshBasicMaterial",{attach:"material",color:n,opacity:1})]})]})}function Xo(e,n){const o=Fe(e);return g.useMemo(()=>{const{maxBox:s}=Rt(o,n);return lo(co(s,.1))},[o])}function vt(e){const{projRotation:n,config:o,api:s,tilingBox:a,actions:i,tasks:l,computeSampleStageAtPlotLocation:r,operator:c,roiFov:u,markerName:m,children:d,mouseModeInteraction:x,setMarker:h,markers:f,editScanRoi:y,tomoFlatMotion:v,...b}=e,p=Xo(e.sampleStage,n),{mouseMode:j,resetMouseMode:M}=x,S=Fe(e.sampleStage),{tomoDetector:C,detector:D}=S,I=g.useCallback((P,Q,ne,ue)=>i.moveScanTaskRoi(P,new G(Q,"mm"),new G(ne,"mm"),new G(ue,"mm")),[]),R=n===0?"front":"side",_=g.useCallback(P=>(s==null?void 0:s.layerDType)===En.Float16?On(P):P,[s]),$=g.useMemo(()=>({"create-tiling-roi":"crosshair","move-motors":"crosshair",create:"crosshair","measure-distance":"crosshair","mark-position":"crosshair","edit-tiling-roi":"crosshair"}),[]),[B,z]=g.useState(void 0);return t.jsxs(zn,{abscissaConfig:{visDomain:p.x,flip:R==="front"},ordinateConfig:{visDomain:p.y,flip:!0},aspect:"equal",title:`${Te.capitalize(R)} (in mm)`,showAxes:o.displayAxes,mouseMode:j,onMouseInteractionOverlayChanged:z,cursors:$,children:[t.jsx(Wo,{domainX:p.x,domainY:p.y,color:T.light}),e.tilingRoi&&t.jsx(Po,{roi:e.tilingRoi,tomoDetector:C,detector:D,onDragMove:e.setTilingRoi,onDragEnd:e.setTilingRoi,projRotation:n,readOnly:y!=="tiling"}),e.scanRoi&&t.jsx(Vo,{roi:e.scanRoi,tomoDetector:C,detector:D,onDragMove:e.setScanRoi,onDragEnd:e.setScanRoi,projRotation:n,readOnly:y!=="scan"}),e.zseriesRoi&&t.jsx(Zo,{roi:e.zseriesRoi,tomoDetector:C,detector:D,onDragMove:e.setZseriesRoi,onDragEnd:e.setZseriesRoi,projRotation:n,readOnly:y!=="zseries"}),t.jsx(ko,{id:"tiling-roi-selection-tool",disabled:B!==void 0||j!=="create-tiling-roi"||y!=="tiling",geometry:e.tilingRoi,onGeometryChanged:e.setTilingRoi,projRotation:n,sampleStage:S,resetMouseMode:M}),t.jsx($o,{id:"scan-roi-selection-tool",disabled:B!==void 0||j!=="create-tiling-roi"||y!=="scan",geometry:e.scanRoi,onGeometryChanged:e.setScanRoi,projRotation:n,sampleStage:S,resetMouseMode:M}),t.jsx(qo,{id:"zseries-roi-selection-tool",disabled:B!==void 0||j!=="create-tiling-roi"||y!=="zseries",geometry:e.zseriesRoi,onGeometryChanged:e.setZseriesRoi,projRotation:n,sampleStage:S,resetMouseMode:M}),t.jsx(wo,{mouseOverlay:B,projRotation:n,mouseMode:j,resetMouseMode:x.resetMouseMode,roiFov:u,actions:i,computeSampleStageAtPlotLocation:r,sampleStage:S,markerName:m,operator:c,setMarker:h}),t.jsx(bo,{api:s,box:a,renderTooltip:(P,Q,ne)=>t.jsx(ro,{projRotation:n,x:R==="side"?P:void 0,y:R==="front"?P:void 0,z:Q,tomoHardware:S,value:_(ne)}),...b}),l.map(P=>t.jsx(uo,{task:P,view:R,readOnly:j!=="pan"&&j!=="zoom",dragTomoScanRoi:I},P.id)),S&&t.jsxs(t.Fragment,{children:[t.jsx(io,{projRotation:n,tomoHardware:S}),t.jsx(so,{projRotation:n,tomoHardware:S}),t.jsx(Fo,{projRotation:n,tomoHardware:S,tomoFlatMotion:v})]}),t.jsx(vo,{projRotation:n,tomoHardware:S,markers:f,setMarker:h,computeSampleStageAtPlotLocation:r}),d]})}function Qo(e){const{tomovisRestService:n,tomovisService:o}=e;function s(){if(!n)return["secondary","UNDECLARED","Tomovis service not declared at the Daiquiri server config. No tiling can be retrieved"];const r=n.defaults.baseURL;return o?[{OFFLINE:"secondary",READY:"success",FAILED:"danger",UNKNOWN:"secondary",PROCESSING:"warning"}[o.state],o.state,`Tomovis service is declared at ${r}`]:["danger","OFFLINE",`Tomovis service can be setup at ${r}`]}const[a,i,l]=s();return t.jsx(Dt,{className:e.className,name:"Tomovis",state:i,stateVariant:a,description:l})}function Jo(e){const n=tn()??{state:"NONE"},[o,s]=Hn(n.state);return t.jsx(Dt,{className:e.className,name:"Scan",state:o,stateVariant:s,description:"Tiling scan state"})}function Ko(e){const{as:n=void 0,onSelect:o,value:s,variant:a}=e,i=["primary","success","info","warning","danger","dark"];return t.jsx(E,{as:n,id:"bg-vertical-dropdown-3",variant:a,children:i.map((l,r)=>{const c=s!==null&&l===s;return t.jsx(N,{variant:c?"primary":"secondary",onClick:()=>{o(l)},children:t.jsx("i",{className:`fa fa-map-marker fa-lg text-${c&&l==="primary"?"secondary":l}`})},r)})})}function es(e){const{mouseModeInteraction:n,dropDirection:o="down",showRoiTools:s=!0}=e,{mouseMode:a,setOrResetMouseMode:i}=n,l=a==="mark-position",[r,c]=g.useState(!1),u=zt();g.useEffect(()=>{c(l)},[l]);const m=t.jsx(ce,{id:"popover-container",body:!0,children:t.jsx(Ko,{value:e.markerName,onSelect:e.onSelectMarkerName})});function d(x){return x==="up"?"top":"bottom"}return t.jsxs(t.Fragment,{children:[t.jsx(wt,{trigger:"click",placement:d(o),overlay:m,children:t.jsx(N,{variant:a==="mark-position"?"primary":"secondary",title:"Pin a position in the sample stage",onClick:()=>{i("mark-position")},children:t.jsx("i",{className:"fa fa-map-marker fa-fw fa-lg"})})}),t.jsx(N,{variant:a==="move-motors"?"danger":"secondary",title:"Click on the scene to move the active detector at a specific location",disabled:!u,onClick:()=>{i("move-motors")},size:"sm",children:t.jsx("i",{className:"fad fam-move-samplestage fa-fw fa-2x"})}),s&&t.jsx(N,{variant:a==="create"?"primary":"secondary",title:"Click on the scene to create a new scan ROI",onClick:()=>{i("create")},size:"sm",children:t.jsx("i",{className:"fa fam-roi-new fa-fw fa-lg"})})]})}function ts(e){const{tilingRoi:n,clearTilingRoi:o,mouseModeInteraction:s,tomoConfigId:a}=e,{mouseMode:i,setOrResetMouseMode:l}=s,r=i==="create-tiling-roi",c=g.useCallback(()=>{if(n===null)return;const m=de.getState().hardware,d=pe(m,a),{sampleStage:x}=d,h=(x==null?void 0:x.properties.detector_center)??[0,0],f=h[0]??0,y=h[1]??0;return{start_x:V(n.start.x+f,3),end_x:V(n.stop.x+f,3),start_y:V(n.start.y+f,3),end_y:V(n.stop.y+f,3),start_z:V(n.start.z+y,3),end_z:V(n.stop.z+y,3)}},[n,a]);return t.jsxs(Ee,{direction:"horizontal",children:[t.jsx("div",{className:"text-dark p-2",children:"Tiling:"}),t.jsxs(E,{className:e.className,children:[t.jsx(N,{variant:r?"primary":"secondary",title:"Initialize the location of the ROI",onClick:()=>{l("create-tiling-roi")},children:t.jsx("i",{className:"fa fam-roi-new fa-fw"})}),t.jsx(N,{variant:"secondary",title:"Initialize the location of the ROI",onClick:()=>{o()},disabled:n===null,children:t.jsx("i",{className:"fa fa-trash-can fa-fw"})}),t.jsx(_e,{button:t.jsxs("span",{className:"text-nowrap",children:[t.jsx("i",{className:"fa fa-plus",title:"Launch a new tiling scan"})," New Scan"]}),disabled:n===null,options:{tags:["tomo-tiling-roi"],providers:{metadata:{datacollections:{namespace:"tilingview"}}}},additionalFormData:c})]})]})}function ns(e){const{scanRoi:n,clearScanRoi:o,mouseModeInteraction:s,tomoConfigId:a}=e,{mouseMode:i,setOrResetMouseMode:l}=s,r=i==="create-tiling-roi",c=g.useCallback(()=>{if(n===null)return;const m=de.getState().hardware,d=pe(m,a),{sampleStage:x}=d,h=(x==null?void 0:x.properties.detector_center)??[0,0],f=h[0]??0,y=h[1]??0;return{x:V(n.x+f,3),y:V(n.y+f,3),z:V(n.z+y,3)}},[n,a]);return t.jsxs(Ee,{direction:"horizontal",children:[t.jsx("div",{className:"text-dark p-2",children:"Tomo:"}),t.jsxs(E,{className:e.className,children:[t.jsx(N,{variant:r?"primary":"secondary",title:"Initialize the location of the ROI",onClick:()=>{l("create-tiling-roi")},children:t.jsx("i",{className:"fa fam-roi-new fa-fw"})}),t.jsx(N,{variant:"secondary",title:"Initialize the location of the ROI",onClick:()=>{o()},disabled:n===null,children:t.jsx("i",{className:"fa fa-trash-can fa-fw"})}),t.jsx(_e,{button:t.jsxs("span",{className:"text-nowrap",children:[t.jsx("i",{className:"fa fa-plus",title:"Launch a new tiling scan"})," New Scan"]}),disabled:n===null,options:{tags:["tomo-tomo-roi"],providers:{metadata:{datacollections:{namespace:"tilingview"}}}},additionalFormData:c})]})]})}function os(e){const{zseriesRoi:n,clearZseriesRoi:o,mouseModeInteraction:s,tomoConfigId:a}=e,{mouseMode:i,setOrResetMouseMode:l}=s,r=i==="create-tiling-roi",c=g.useCallback(()=>{if(n===null)return;const m=de.getState().hardware,d=pe(m,a),{sampleStage:x,tomoDetector:h,detector:f}=d,y=(x==null?void 0:x.properties.detector_center)??[0,0],v=y[0]??0,b=y[1]??0,p=Math.sign(n.zstop-n.zstart),j=Ve(h,f);if(j===null)return;const M=j[1]*.5,S=n.zstart+b+p*M,C=n.zstop+b-p*M,D=C-S;return{x:V(n.x+v,3),y:V(n.y+v,3),z_start:V(S,3),z_stop:V(C,3),z_height:V(Math.abs(D)+j[1],3),z_direction:p>0?"Down":"Up"}},[n,a]);return t.jsxs(Ee,{direction:"horizontal",children:[t.jsx("div",{className:"text-dark p-2",children:"Zseries:"}),t.jsxs(E,{className:e.className,children:[t.jsx(N,{variant:r?"primary":"secondary",title:"Initialize the location of the ROI",onClick:()=>{l("create-tiling-roi")},children:t.jsx("i",{className:"fa fam-roi-new fa-fw"})}),t.jsx(N,{variant:"secondary",title:"Initialize the location of the ROI",onClick:()=>{o()},disabled:n===null,children:t.jsx("i",{className:"fa fa-trash-can fa-fw"})}),t.jsx(_e,{button:t.jsxs("span",{className:"text-nowrap",children:[t.jsx("i",{className:"fa fa-plus",title:"Launch a new tiling scan"})," New Scan"]}),disabled:n===null,options:{tags:["tomo-zseries-roi"],providers:{metadata:{datacollections:{namespace:"tilingview"}}}},additionalFormData:c})]})]})}function ss(e){const{editScanRoi:n,setEditScanRoi:o}=e,s=g.useRef(null),a=g.useRef(null),i=g.useRef(null);function l(r){o(c=>c===r?null:r)}return t.jsxs(t.Fragment,{children:[t.jsxs(E,{className:e.className,children:[t.jsx(N,{ref:s,variant:n==="tiling"?"primary":"secondary",title:"ROI for tiling scan",onClick:()=>{l("tiling")},children:t.jsx("i",{className:"fa fam-roi-rect-tile fa-fw fa-lg"})}),t.jsx(N,{ref:a,variant:n==="scan"?"primary":"secondary",title:"ROI for tomo scan",onClick:()=>{l("scan")},children:t.jsx("i",{className:"fa fam-roi-rect fa-fw fa-lg"})}),t.jsx(N,{ref:i,variant:n==="zseries"?"primary":"secondary",title:"ROI for zseries scan",onClick:()=>{l("zseries")},children:t.jsx("i",{className:"fa fam-roi-rect-tile-v fa-fw fa-lg"})})]}),t.jsx(Re,{show:n==="tiling",placement:"bottom",container:s.current,target:s.current,containerPadding:20,children:t.jsx(ce,{id:"popover-tiling-contained",children:t.jsx(ts,{...e,className:void 0})})}),t.jsx(Re,{show:n==="scan",placement:"bottom",container:a.current,target:a.current,containerPadding:20,children:t.jsx(ce,{id:"popover-scan-contained",children:t.jsx(ns,{...e,className:void 0})})}),t.jsx(Re,{show:n==="zseries",placement:"bottom",container:i.current,target:i.current,containerPadding:20,children:t.jsx(ce,{id:"popover-zseries-contained",children:t.jsx(os,{...e,className:void 0})})})]})}function is(e,n){if(n===void 0)return[];const o=[];return Object.keys(n).map(a=>[a,n[a].tomo_detector_id]).forEach(a=>{const[i,l]=a,r=re(e,l),c=re(e,`${l}.detector`);if(r===null||c===null){console.debug(`${l} not there`);return}if(!on(c)||!sn(c)||!r.properties.state||!r.properties.sample_pixel_size_mode)return;function u(){return!r||!r.online||r.properties.state==="OFFLINE"?"DETECTOR_OFFLINE":"READY"}const m=u();if(r.properties.sample_pixel_size_mode==="USER")r.properties.user_sample_pixel_size!==null&&o.push({detector:i,state:m,size:c.properties.size,userPixelSize:r.properties.user_sample_pixel_size});else{const x=re(e,`${l}.optic`);if(x===null){console.debug(`${r.properties.optic} not there`);return}if(!x.properties.available_magnifications){console.debug(`${r.properties.optic} no magnifications`);return}x.properties.available_magnifications.forEach(h=>{o.push({detector:i,state:m,size:r.properties.actual_size,autoPixelSize:{magnification:h,cameraPixelSize:r.properties.camera_pixel_size}})})}}),o}function as(){const e=nn(),n=de(o=>o.hardware);return g.useMemo(()=>is(n,e),[n,e])}function Tt(e,n){return[n[0]*e.size[0]*.001,n[1]*e.size[1]*.001]}function Ft(e){if(e.userPixelSize!==void 0)return[e.userPixelSize,e.userPixelSize];if(e.autoPixelSize!==void 0){const n=e.autoPixelSize.magnification,o=e.autoPixelSize.cameraPixelSize;return[o[0]/n,o[1]/n]}throw new Error("Unsupported TomoAvailableFieldOfView state")}function rs(e){const{eventKey:n,isSelected:o,data:s}=e,a=Ft(s),i=Tt(s,a);function l(){if(s.userPixelSize!==void 0)return"user";if(s.autoPixelSize!==void 0)return`×${s.autoPixelSize.magnification}`;throw new Error("Unsupported TomoAvailableFieldOfView state")}return t.jsxs(F.Item,{eventKey:n,children:[t.jsxs("div",{children:[s.detector," ",l()]}),t.jsxs("div",{className:"fw-bold",children:[i[0],"mm ",a[0],"µm"]})]})}function cs(e){const{as:n=void 0,onSelect:o,value:s,variant:a}=e,i=as();function l(u){if(u===null)return"No detector/optic selected";function m(){return u===null?"":u.magnification===null?"user":`×${u.magnification}`}return`${u.detector} ${m()} ${u.pixelSize[0]}µm ${u.fov[0]}mm`}const r=l(s);function c(u){var y;if(u===null){o(null);return}const m=Number.parseInt(u),d=i[m];d.size;const x=Ft(d),h=Tt(d,x),f={detector:d.detector,magnification:((y=d.autoPixelSize)==null?void 0:y.magnification)??null,fov:h,pixelSize:x};o(f)}return t.jsx(Yn,{as:n,title:r,id:"bg-vertical-dropdown-3",onSelect:c,variant:a,children:i.map((u,m)=>{var x;const d=s!==null&&u.detector===s.detector&&(((x=u.autoPixelSize)==null?void 0:x.magnification)??null)===s.magnification;return t.jsx(rs,{eventKey:m,isSelected:d,data:u},m)})})}function ls(e){return t.jsx(cs,{...e})}function Pe(e){return e<9?`0${e}`:e}function ds(e){const o=Date.now()-e.valueOf();if(o<50*1e3)return"Few seconds ago";if(o<80*1e3)return"1 minute ago";if(o<90*60*1e3)return`${Math.round(o/6e4)} minutes ago`;if(o<7*24*60*60*1e3){const s=new Date;if(e.getDate()===s.getDate())return`Today at ${e.getHours()}:${Pe(e.getMinutes())}`;const a=new Date(s);if(a.setDate(a.getDate()-1),e.getDate()===a.getDate())return`Yesterday at ${e.getHours()}:${Pe(e.getMinutes())}`;const i=new Date(s);if(i.setDate(i.getDate()-s.getDay()),i.setHours(0),i.setMinutes(0),i.setSeconds(0),i.setMilliseconds(0),e>=i)return`${e.toLocaleString("default",{weekday:"long"})} at ${e.getHours()}:${Pe(e.getMinutes())}`}return e.toLocaleDateString()}function us(e){const{imageTiling:n,isSelected:o}=e,s=o?"fa fa-fw fa-dot-circle-o":"fa fa-fw fa-circle-o",a=n.status==="done"?"success":"warning",i=new Date(Date.parse(n.create_time));return t.jsxs(F.Item,{className:"d-flex",style:{alignItems:"center"},eventKey:n.id,active:o,children:[t.jsx("i",{className:s})," ",t.jsx("span",{className:"ms-2 me-auto pr-2",title:i.toLocaleString(),children:ds(i)})," ",t.jsx(bt,{className:"me-2",bg:a,children:n.status.toUpperCase()})," ",t.jsx(N,{size:"sm",variant:"danger",onClick:l=>{l.stopPropagation(),e.onDelete(n.id)},children:t.jsx("i",{className:"fa fa-fw fa-trash"})})]})}function ms(e){const{as:n=void 0,onSelect:o,selected:s,variant:a,tomovisService:i}=e,l=i.imageTilings;return t.jsxs(F,{className:`me-1 ${e.dropDirection==="up"?"dropup":""}`,as:n,onSelect:r=>{o(r)},onToggle:r=>{r&&i.updateImageTilings()},children:[t.jsxs(F.Toggle,{id:"dropdown-basic",variant:a,title:s?`Tiling selected: ${s}`:"No tiling selected",children:[t.jsx("i",{className:"fa fa-th fa-fw"}),(s===null||l.length===0)&&t.jsx("div",{className:"indicator",children:t.jsx("i",{className:"fa fa-xs fa-circle text-warning",title:"No tiling selected"})})]}),t.jsxs(F.Menu,{className:"dropdown-menu-center",children:[l.length===0&&t.jsx(F.Item,{disabled:!0,children:"No tiling available"}),l.map((r,c)=>{const u=s===r.id;return t.jsx(us,{isSelected:u,imageTiling:r,onDelete:m=>{i.deleteImageTiling(m),u&&o(null)}},c)})]})]})}const jt=q("daiquiri.components.tomo.tiling.ActualDetectorLocation");function pt(e){var I;const{detectorConfig:n,projRotation:o,clockWiseRotation:s}=e;if(Ct({statistics:(I=e.detectorArray)==null?void 0:I.statistics,...n}),e.detectorArray===null)return t.jsx(t.Fragment,{});const{displayArray:a,imagePosition:i,detectorSize:l,imagePixelSize:r,szPosition:c,imageSomegaPosition:u,detectorCenterY:m,detectorCenterZ:d}=e.detectorArray;if(c===null||l===null||r===null||u===null)return jt("Skipped: one of imagePosition, szPosition, detectorSize, imagePixelSize, imageSomegaPosition is missing."),t.jsx(t.Fragment,{});const x=(m==null?void 0:m.to("mm").scalar)??0,h=(d==null?void 0:d.to("mm").scalar)??0,f=c.to("mm").scalar,y=i?i.to("mm").scalar:0,v=u.scalar*(s?1:-1),b=r.to("mm").scalar,p=.01;function j(R,_){const $=(R-_)%360;return $<0?360+$:$}const M=j(v,o),S=M<p||M>360-p,C=M>180-p&&M<180+p;if(!S&&!C)return jt(`Skipped: rot ${v} does not match to the projRotation ${o}.`),t.jsx(t.Fragment,{});const D=S?-1:1;return t.jsx(Pn,{values:a,domain:n.scaleDomain,colorMap:n.colorMap,invertColorMap:n.invertColorMap,scaleType:n.scaleType,position:[-D*(y-x),f-h,2],scale:[D*b,b,1],size:l})}function xs(e){const{resetZoomEnabled:n,actions:o}=e;return t.jsxs(F,{as:E,children:[t.jsx(N,{title:"Reset zoom (sample stage overview)",variant:"secondary",disabled:!n,onClick:()=>{o.resetZoom()},children:t.jsx("i",{className:"fa fa-expand fa-fw fa-lg"})}),t.jsx(F.Toggle,{split:!0,id:"dropdown-split-basic",variant:"secondary"}),t.jsxs(F.Menu,{children:[t.jsx(F.Item,{onClick:()=>{o.setScale(1)},children:"×1 (overview)"}),t.jsx(F.Item,{onClick:()=>{o.setScale(2)},children:"×2"}),t.jsx(F.Item,{onClick:()=>{o.setScale(10)},children:"×10"}),t.jsx(F.Item,{onClick:()=>{o.setScale(100)},children:"×100"})]})]})}function fs(){const e=kn({name:"tomo/tilingcolormap",lut:"Greys"}),[n,o]=H("tomo/tilingview/layout-view","front-side"),[s,a]=H("tomo/tilingview/axes",!0),[i,l]=H("tomo/tilingview/colorbar-visible",!0),[r,c]=H("tomo/tilingview/crosshair",!1),[u,m]=H("tomo/tilingview/toolbarlocation","top"),[d,x]=H("tomo/tilingview/detectordisplayed",!1);return{layoutView:n,setLayoutView:o,colorbarVisible:i,setColorbarVisible:l,displayAxes:s,setDisplayAxes:a,crossHair:r,setCrossHair:c,toolbarLocation:u,setToolbarLocation:m,...e,isDetectorDisplayed:d,setDetectorDisplayed:x}}function gs(e,n){return e===n?"primary":"secondary"}function U(e){return t.jsx(N,{variant:gs(e.var,e.value),onClick:()=>{e.setter(e.value)},className:"text-nowrap",size:"sm",children:e.children})}function hs(e){const{as:n=void 0,variant:o="secondary",config:s}=e;return t.jsxs(F,{as:n,className:`${e.dropDirection==="up"?"dropup":""}`,children:[t.jsx(F.Toggle,{id:"dropdown-basic",variant:o,className:"d-flex align-items-center",children:t.jsx("i",{className:"fa fa-sliders fa-fw fa-lg"})}),t.jsx(F.Menu,{className:"dropdown-menu-center",children:t.jsx("div",{className:"ms-1 me-1",style:{minWidth:"300px"},children:t.jsxs(ve,{children:[t.jsxs(A,{children:[t.jsx(L,{className:"my-auto",children:"Display axes"}),t.jsx(L,{xs:7,children:t.jsxs(E,{children:[t.jsx(U,{var:s.displayAxes,value:!0,setter:s.setDisplayAxes,children:"Yes"}),t.jsx(U,{var:s.displayAxes,value:!1,setter:s.setDisplayAxes,children:"No"})]})})]}),t.jsxs(A,{className:"mt-1",children:[t.jsx(L,{className:"my-auto",children:"Layout"}),t.jsx(L,{xs:7,children:t.jsxs(E,{children:[t.jsx(U,{var:s.layoutView,value:"front",setter:s.setLayoutView,children:"Front"}),t.jsx(U,{var:s.layoutView,value:"side",setter:s.setLayoutView,children:"Side"}),t.jsx(U,{var:s.layoutView,value:"front-side",setter:s.setLayoutView,children:"Both"})]})})]}),t.jsxs(A,{className:"mt-1",children:[t.jsx(L,{className:"my-auto",children:"Color bar"}),t.jsx(L,{xs:7,children:t.jsxs(E,{children:[t.jsx(U,{var:s.colorbarVisible,value:!0,setter:s.setColorbarVisible,children:"Displayed"}),t.jsx(U,{var:s.colorbarVisible,value:!1,setter:s.setColorbarVisible,children:"Hide"})]})})]}),t.jsxs(A,{className:"mt-1",children:[t.jsx(L,{className:"my-auto",children:"Crosshair"}),t.jsx(L,{xs:7,children:t.jsxs(E,{children:[t.jsx(U,{var:s.crossHair,value:!0,setter:s.setCrossHair,children:"Yes"}),t.jsx(U,{var:s.crossHair,value:!1,setter:s.setCrossHair,children:"No"})]})})]}),t.jsxs(A,{className:"mt-1",children:[t.jsx(L,{className:"my-auto",children:"Toolbar"}),t.jsx(L,{xs:7,children:t.jsxs(E,{children:[t.jsx(U,{var:s.toolbarLocation,value:"top",setter:s.setToolbarLocation,children:"Top"}),t.jsx(U,{var:s.toolbarLocation,value:"bottom",setter:s.setToolbarLocation,children:"Bottom"})]})})]})]})})})]})}const ys=an()(rn(e=>({setFrontViewpoint:n=>{const{center:o,scale:s}=n;e({y:o.x,z:o.y,scale:s.x})},setSideViewpoint:n=>{const{center:o,scale:s}=n;e({x:o.x,z:o.y,scale:s.x})}}),{name:"tomotiling-viewpoint",storage:cn(()=>sessionStorage)}));function vs(){const{x:e,y:n,z:o,scale:s,setFrontViewpoint:a,setSideViewpoint:i}=ys();let l;Number.isFinite(n)&&Number.isFinite(o)&&Number.isFinite(s)&&(l={center:new k(n,o,0),scale:new k(s,s,1)});let r;return Number.isFinite(e)&&Number.isFinite(o)&&Number.isFinite(s)&&(r={center:new k(e,o,0),scale:new k(s,s,1)}),{frontViewpoint:l,setFrontViewpoint:a,sideViewpoint:r,setSideViewpoint:i}}function js(e){const{toolbarLocation:n}=e;return t.jsxs("div",{className:e.className,style:e.style,children:[n==="top"&&e.toolbar,e.children,n==="bottom"&&e.toolbar]})}q("daiquiri.components.tomo.TomoTilingtiling");function ps(){const e=g.useRef(null),n=g.useRef(null);function o(i,l){if(e.current){const{getCameraViewpoint:r,updateCameraViewpoint:c}=e.current,u=r();c({center:new k(u.center.x,i.y),scale:l})}}function s(i,l){if(n.current){const{getCameraViewpoint:r,updateCameraViewpoint:c}=n.current,u=r();c({center:new k(u.center.x,i.y),scale:l})}}const a=g.useMemo(()=>({resetZoom:()=>{var i,l;(i=e.current)==null||i.resetZoom(),(l=n.current)==null||l.resetZoom()},setScale:i=>{var l,r;(l=e.current)==null||l.setScale(1/i),(r=n.current)==null||r.setScale(1/i)}}),[e,n]);return{handleFrameFront:s,handleFrameSide:o,frontRef:e,sideRef:n,actions:a}}function Ss(e){const{actions:n,tasks:o,options:s}=e,{showrois:a=!0,showlaunchscan:i=!0,tomoconfig:l}=s,r=ln(),[c,u]=g.useState(null),m=zt(),d=fs(),x=dn(l??""),[h,f]=H("tomo/tilingroi/roi",null),[y,v]=H("tomo/scanroi/roi",null),[b,p]=H("tomo/zseriesroi/roi",null),[j,M]=H("tomo/tilingview/refreshperiod",30),{frontViewpoint:S,setFrontViewpoint:C,sideViewpoint:D,setSideViewpoint:I}=vs(),R=un(),{tomovis_url:_,tomovis_proxy_url:$}=R,B=Kn(_,$),z=Un(),P=eo(B,r,3e4),{apiFront:Q,apiSide:ne,histogram:ue,tilingBoxFront:Et,tilingBoxSide:Lt,invalidate:At,lazyRefresh:$e}=Jn(B,c),we=Rn(ue);Ct({statistics:we,...d}),g.useEffect(()=>{let W=null;return P.state==="READY"?$e():P.state==="PROCESSING"&&j&&(W=setInterval(()=>{$e()},j*1e3)),()=>{W&&clearInterval(W)}},[P.state,j]);const J=Cn("zoom"),{mouseMode:be,resetMouseMode:Ot}=J,Be=Fe(x),_t=g.useCallback(()=>Se(Be),[Be]),Ge=mn(`${l}.flat_motion`),[He,Ye]=yo({getCenter:_t}),Vt=Zn({sampleStageRefs:x}),ze=qn({detector:Vt,sampleStageRefs:x,profile:z.profile,normalization:z.scaleType,autoscale:z.autoscale,autoscaleMode:z.autoscaleMode,domain:z.scaleDomain,enabled:d.isDetectorDisplayed,minRefreshPeriod:.5}).data;g.useEffect(()=>{P.lastReadyImageTiling&&u(P.lastReadyImageTiling)},[P.lastReadyImageTiling]),g.useEffect(()=>{!m&&be==="move-motors"&&Ot()},[be,m]);const[me,$t]=H("tomo/tilingroi/fov",null),[Ce,Bt]=H("tomo/tilingmarker/selection","primary"),[Me,Gt]=g.useState(null),oe=ps(),Ue=g.useCallback((W,xe,We)=>{const Ht=de.getState().hardware,se=pe(Ht,l),{sampleStage:De}=se,Xe=(De==null?void 0:De.properties.detector_center)??[0,0],Qe=Xe[0]??0,Yt=Xe[1]??0,Je=se.sy?K(se.sy):0;function Ut(){return se.sampu===null||se.sampv===null?[void 0,void 0]:[W===null?void 0:new G(W-Je+Qe,"mm"),xe===null?void 0:new G(xe-Je+Qe,"mm")]}const[Zt,qt]=Ut();return{sz:We===null?void 0:new G(We+Yt,"mm"),sampu:Zt,sampv:qt}},[]),ee=d.toolbarLocation==="top"?"down":"up",Ze=xn((x==null?void 0:x.somega)??null),qe=Ze?St(Ze):!0;return t.jsx(js,{className:"w-100 h-100",style:{flex:"1 1 0%",display:"flex",flexDirection:"column"},toolbarLocation:d.toolbarLocation,toolbar:t.jsxs(Mn,{align:"center",style:{zIndex:1},children:[t.jsx(Dn,{mouseModeInteraction:J}),t.jsx(xs,{resetZoomEnabled:!0,actions:oe.actions}),t.jsx(ie,{}),t.jsx(Bn,{mouseModeInteraction:J,dropDirection:ee}),t.jsx(es,{mouseModeInteraction:J,showRoiTools:a,markerName:Ce,onSelectMarkerName:Bt,dropDirection:ee}),t.jsx(Wn,{variant:d.isDetectorDisplayed?"primary":"secondary",isInverted:z.invertColorMap,onSelectInvertion:z.setInvertColorMap,isDisplayed:d.isDetectorDisplayed,onSelectDisplayed:d.setDetectorDisplayed,lut:z.colorMap,onSelectLut:z.setColorMap,norm:z.scaleType,onSelectNorm:z.setScaleType,autoscale:z.autoscale,onSelectAutoscale:z.setAutoscale,autoscaleMode:z.autoscaleMode,onSelectAutoscaleMode:z.setAutoscaleMode,profile:z.profile,onSelectProfile:z.setProfile,array:ze,dropDirection:ee}),a&&t.jsx(ls,{value:me,onSelect:$t,variant:be==="create"?me===null?"danger":"primary":"secondary"}),t.jsx(ie,{}),t.jsx(Jo,{className:"me-1 d-none d-lg-block"}),i&&t.jsx(ss,{className:"d-none d-lg-block",mouseModeInteraction:J,editScanRoi:Me,setEditScanRoi:Gt,tomoConfigId:l,tilingRoi:h,clearTilingRoi:()=>{f(null)},zseriesRoi:b,clearZseriesRoi:()=>{p(null)},scanRoi:y,clearScanRoi:()=>{v(null)}}),t.jsx(ie,{}),t.jsx(Qo,{className:"me-1 d-none d-lg-block",tomovisRestService:B,tomovisService:P}),t.jsx(ms,{variant:"secondary",tomovisService:P,selected:c,onSelect:u,dropDirection:ee}),t.jsx(N,{variant:"secondary",disabled:c===null,title:P.state==="PROCESSING"?`Auto refresh the tiling every ${j.toFixed(1)} seconds`:"Reload current tiling",onClick:At,children:t.jsx("i",{className:`fa fa-rotate-right fa-solid ${P.state==="PROCESSING"?"fa-spin":""}`})}),t.jsx(ie,{}),t.jsx(Qn,{lut:d.colorMap,onSelectLut:d.setColorMap,norm:_n(d.scaleType),autoscale:d.autoscale,autoscaleMode:d.autoscaleMode,onSelectNorm:d.setScaleType,isInverted:d.invertColorMap,onSelectInvertion:d.setInvertColorMap,onSelectAutoscale:d.setAutoscale,onSelectAutoscaleMode:d.setAutoscaleMode,dropDirection:ee}),t.jsx(Tn,{disabled:we===void 0,...d}),t.jsx(Xn,{disabled:we===void 0,histogram:ue,...d}),t.jsx(ie,{}),t.jsx(hs,{config:d,dropDirection:ee})]}),children:t.jsxs("div",{style:{flex:"1 1 auto",display:"flex",margin:0,minHeight:0},children:[(d.layoutView==="front"||d.layoutView==="front-side")&&t.jsxs(vt,{config:d,projRotation:0,api:Q,tilingBox:Et,actions:n,computeSampleStageAtPlotLocation:Ue,tasks:o,sampleStage:x,operator:m,domain:d.scaleDomain,colorMap:d.colorMap,invertColorMap:d.invertColorMap,scaleType:d.scaleType,roiFov:me,markerName:Ce,mouseModeInteraction:J,markers:He,setMarker:Ye,tilingRoi:h,setTilingRoi:f,scanRoi:y,setScanRoi:v,zseriesRoi:b,setZseriesRoi:p,editScanRoi:Me,tomoFlatMotion:Ge,children:[d.isDetectorDisplayed&&t.jsx(pt,{clockWiseRotation:qe,projRotation:0,detectorArray:ze,detectorConfig:z}),t.jsx(ot,{ref:oe.frontRef,onVisViewpointChange:oe.handleFrameFront}),t.jsx(ct,{viewpoint:S,setViewpoint:C}),t.jsx(dt,{children:t.jsx(nt,{guides:d.crossHair?"both":void 0,renderTooltip:(W,xe)=>t.jsx(t.Fragment,{})})})]}),d.layoutView==="front-side"&&!d.displayAxes&&t.jsx("div",{style:{minWidth:"1em"},className:"p-2 bg-light"}),(d.layoutView==="side"||d.layoutView==="front-side")&&t.jsxs(vt,{config:d,projRotation:-90,api:ne,tilingBox:Lt,actions:n,computeSampleStageAtPlotLocation:Ue,tasks:o,sampleStage:x,operator:m,domain:d.scaleDomain,colorMap:d.colorMap,invertColorMap:d.invertColorMap,scaleType:d.scaleType,roiFov:me,markerName:Ce,mouseModeInteraction:J,markers:He,setMarker:Ye,tilingRoi:h,setTilingRoi:f,scanRoi:y,setScanRoi:v,zseriesRoi:b,setZseriesRoi:p,editScanRoi:Me,tomoFlatMotion:Ge,children:[d.isDetectorDisplayed&&t.jsx(pt,{clockWiseRotation:qe,projRotation:-90,detectorArray:ze,detectorConfig:z}),t.jsx(ot,{ref:oe.sideRef,onVisViewpointChange:oe.handleFrameSide}),t.jsx(ct,{viewpoint:D,setViewpoint:I}),t.jsx(dt,{children:t.jsx(nt,{guides:d.crossHair?"both":void 0,renderTooltip:(W,xe)=>t.jsx(t.Fragment,{})})})]}),d.colorbarVisible&&t.jsx(bn,{domain:d.scaleDomain,scaleType:d.scaleType,colorMap:d.colorMap,invertColorMap:d.invertColorMap,withBounds:!0})]})})}function ws(){return gn(e=>e.scanTasks)}function bs(e){const n=fn(),o=ws();return t.jsx(Ss,{...e,actions:n,tasks:o})}function oi(e){const{yamlNode:n,showrois:o,showlaunchscan:s,tomoconfig:a,...i}=e;hn(n,"tomoconfig",a),tt(n,"showrois",o),tt(n,"showlaunchscan",s),yn(n,i);const l={showrois:o,showlaunchscan:s,tomoconfig:a};return t.jsx(bs,{options:l})}export{oi as default};
