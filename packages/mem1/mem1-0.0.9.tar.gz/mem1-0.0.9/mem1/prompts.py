"""提示词模板 - 通用记忆系统

记忆框架与业务场景解耦设计：
- 记忆框架（MarkdownMemory）：通用的存储、检索、更新能力
- 业务场景（ProfileTemplate）：可插拔的画像模板和提示词

使用方式：
1. 使用默认模板：直接使用 MarkdownMemory
2. 自定义业务场景：创建 ProfileTemplate 实例，传入 MarkdownMemory
"""

from typing import Optional


class ProfileTemplate:
    """用户画像模板 - 可自定义以适配不同业务场景
    
    记忆框架与业务场景解耦的核心：
    - 记忆框架只负责存储和检索
    - 业务场景通过 ProfileTemplate 定义画像结构和提示词
    """
    
    # 默认通用模板
    DEFAULT_SECTIONS = """## 基本信息
- 姓名/称呼：
- 身份/角色：
- 所属组织：
- 背景信息：

## 偏好习惯
- 沟通风格：（详细/简洁、正式/随意等）
- 关注重点：
- 特殊要求：

## 周期性任务
（固定日程和重复性工作，格式：[周期] 任务内容）
- 例：[每周一] 提交周报、[每周五] 制定下周计划、[每月底] 月度汇总

## 关键数据
（重要的数字、金额、数量，用加粗标记）
- 例：处置 **97起** 案件、涉及金额 **230万元**、完成 **365个** 检查点

## 任务时间线
（用户提到的计划、截止日期、里程碑，格式：[YYYY-MM-DD] 事项）

## 待办事项
（用户提出但未完成的请求，格式：- [ ] 事项（MM-DD 提出））

## 待澄清事项
（用户前后矛盾或模糊的信息，需要下次确认，格式：⚠️ 矛盾描述）

## 用户反馈
- 正向反馈：（满意的地方）
- 负向反馈：（不满意的地方、需改进的问题）

## 注意事项
（需要规避的话题、曾经的误解、用户不喜欢的做法等）"""

    def __init__(
        self,
        sections: Optional[str] = None,
        description: str = "从对话中整理的用户信息",
        update_prompt: Optional[str] = None,
        compress_prompt: Optional[str] = None
    ):
        """
        Args:
            sections: 自定义画像章节结构（Markdown 格式）
            description: 画像描述
            update_prompt: 自定义画像更新提示词（可选）
            compress_prompt: 自定义画像压缩提示词（可选）
        """
        self.sections = sections or self.DEFAULT_SECTIONS
        self.description = description
        self._update_prompt = update_prompt
        self._compress_prompt = compress_prompt
    
    def render(self, user_id: str, timestamp: str) -> str:
        """渲染初始画像模板"""
        return f"""# {user_id} 用户画像

> {self.description}

{self.sections}

---
*最后更新: {timestamp}*
"""
    
    def get_update_prompt(self) -> str:
        """获取画像更新提示词"""
        return self._update_prompt or DEFAULT_PROFILE_UPDATE_PROMPT
    
    def get_compress_prompt(self) -> str:
        """获取画像压缩提示词"""
        return self._compress_prompt or DEFAULT_PROFILE_COMPRESS_PROMPT


# ============ 默认提示词模板（通用） ============

DEFAULT_PROFILE_UPDATE_PROMPT = """你是用户画像分析专家。从对话记录中提取用户信息，更新用户画像。

## 对话记录
{normal_content}

## 现有用户画像
{import_content}

## 任务
分析对话记录，提取关于用户的重要信息，更新用户画像。

## 输出格式
直接输出完整的 Markdown 格式用户画像，保持现有画像的章节结构。

## 整理原则
1. 不能丢失现有画像中的信息，除非对话中明确否定
2. 新信息是补充，不是替换
3. 用户反馈（表扬或批评）必须保留
4. 只记录用户明确表达的信息，不要推测
5. 如果某个章节没有信息，保留标题但内容留空

## 周期性任务提取
6. 识别固定日程：用户提到"每周一"、"每周五"、"每天"、"每月"等周期性任务
7. 记录到「周期性任务」章节，格式：[周期] 任务内容
8. 示例：[每周一] 提交周报、[每周五] 制定下周计划

## 关键数字保留【重要】
9. 所有具体数字必须原样保留并用 **加粗** 标记，禁止概括为"多个"、"若干"、"大量"
10. 记录到「关键数据」章节，格式：事项描述 **数字**
11. 正确示例：处置 **97起** 案件、涉及金额 **230万元** ✓
12. 错误示例：处置多起案件、涉及大额资金 ✗

## 时间敏感信息提取
13. 任务时间线：提取用户提到的日期、截止时间、计划安排、里程碑，记录到「任务时间线」
14. 待办事项：识别用户说"下次"、"回头"、"先这样"、"稍后"、"改天"等挂起信号，将未完成的请求记录到「待办事项」
15. 已完成事项：如果对话中确认某个待办已完成，将其从「待办事项」移除或标记为 [x]

## 矛盾检测
16. 发现用户前后说法矛盾时（如偏好、身份、需求不一致），不要直接覆盖旧信息
17. 将矛盾记录到「待澄清事项」，格式：⚠️ 用户曾说"..."（日期），但又说"..."（日期）
18. 只有用户明确澄清后，才能更新对应信息并移除待澄清标记

---
*最后更新: {timestamp}*
"""

DEFAULT_PROFILE_COMPRESS_PROMPT = """你是用户画像压缩专家。当前用户画像过长，需要精简。

## 当前用户画像
{profile_content}

## 任务
将用户画像压缩到 {max_chars} 字符以内，保留最重要的信息。

## 压缩原则
1. 保留核心身份信息
2. 保留关键偏好（最重要的 2-3 条）
3. 合并相似条目
4. 删除过时信息
5. 保留负向反馈

## 输出格式
直接输出压缩后的完整 Markdown 格式用户画像。

---
*最后更新: {timestamp}*
*（已压缩）*
"""


# ============ 回忆判断提示词（通用） ============

RECALL_DECISION_PROMPT = """判断用户的问题是否需要查阅历史对话记录。

**需要查阅的情况：**
- 用户询问之前聊过的内容（"上次说的..."、"之前提到的..."）
- 用户想回顾历史对话
- 用户引用过去的对话

**不需要查阅的情况：**
- 新的问题或请求
- 基于用户画像就能回答的问题
- 通用知识类问题

## 用户问题
{query}

## 输出
只输出：`true`（需要查阅历史）或 `false`（不需要）"""


# ============ 助手回复摘要提示词 ============

ASSISTANT_SUMMARY_PROMPT = """你是对话摘要专家。将助手的长回复压缩为简短摘要，保留关键信息。

## 原始回复
{content}

## 摘要要求
1. 保留回复的核心结论和关键数据
2. 保留用户可能需要回顾的重要信息
3. 删除冗余的解释、示例、格式化内容
4. 摘要长度控制在 {max_chars} 字符以内
5. 如果是报告/文档类内容，只保留标题和主要结论

## 输出格式
直接输出摘要内容，开头标注 [摘要]"""


# ============ 渐进式检索判断提示词 ============

CONTEXT_SUFFICIENT_PROMPT = """判断当前信息是否足够回答用户问题。

## 用户问题
{query}

## 用户画像
{profile}

## 已检索的对话记录（最近 {days} 天）
{conversations}

## 判断标准
- 如果画像或对话中包含回答问题所需的信息，输出 `true`
- 如果问题涉及的时间、事件、数据在已有信息中找不到，输出 `false`
- 如果是通用问题（不依赖历史记录），输出 `true`

## 输出
只输出：`true`（信息足够）或 `false`（需要检索更早的记录）"""


# ============ 图片搜索提示词（通用） ============

IMAGE_SEARCH_PROMPT = """根据用户查询，从图片列表中找出匹配的图片。

## 图片列表
{images_desc}

## 用户查询
{query}

## 输出格式
只输出匹配图片的索引号，每行一个。如果没有匹配的图片，输出"无"。
"""


# ============ 业务场景模板示例 ============

# 舆情行业模板
YUQING_PROFILE_TEMPLATE = ProfileTemplate(
    description="舆情行业用户画像",
    sections="""## 基本信息
- 姓名/称呼：
- 职位/角色：
- 所属机构：
- 职责范围：

## 偏好习惯
- 报告风格：（详细/简洁、图表/文字等）
- 沟通方式：（直接/委婉、正式/随意等）
- 关注重点：（时效性/准确性/全面性等）
- 图表偏好：

## 周期性任务
（固定日程和重复性工作，格式：[周期] 任务内容）
- 例：[每周一] 提交周报、[每周五] 制定下周计划、[每月底] 月度汇总

## 关键数据
（重要的数字、金额、数量，用加粗标记）
- 例：处置 **97起** 案件、涉及金额 **230万元**

## 任务时间线
（报告截止日期、汇报计划、定期任务，格式：[YYYY-MM-DD] 事项）

## 待办事项
（用户提出但未完成的请求，格式：- [ ] 事项（MM-DD 提出））

## 待澄清事项
（用户前后矛盾或模糊的信息，需要下次确认）

## 用户反馈
- 正向反馈：
- 负向反馈：

## 注意事项
（敏感话题、规避要点、历史问题等）"""
)


# 电商客服模板
ECOMMERCE_PROFILE_TEMPLATE = ProfileTemplate(
    description="电商客户画像",
    sections="""## 基本信息
- 称呼：
- 会员等级：
- 常用收货地址：

## 购物偏好
- 常购品类：
- 价格敏感度：
- 品牌偏好：

## 服务记录
- 历史订单问题：
- 退换货记录：
- 投诉记录：

## 待办事项
（未处理的售后、待跟进的问题，格式：- [ ] 事项（MM-DD 提出））

## 待澄清事项
（用户前后矛盾的需求，如地址、商品规格不一致等）

## 沟通偏好
- 响应速度要求：
- 沟通风格：

## 注意事项
（特殊需求、敏感话题等）"""
)


# 医疗助手模板
MEDICAL_PROFILE_TEMPLATE = ProfileTemplate(
    description="患者健康档案摘要",
    sections="""## 基本信息
- 称呼：
- 年龄段：
- 主要健康关注：

## 健康背景
- 已知病史：
- 过敏信息：
- 用药情况：

## 任务时间线
（复诊日期、用药周期、检查计划，格式：[YYYY-MM-DD] 事项）

## 待办事项
（待预约的检查、待确认的用药调整等）

## 待澄清事项
（症状描述前后不一致、用药信息矛盾等，需下次确认）

## 咨询偏好
- 信息详细程度：
- 关注重点：

## 注意事项
（沟通禁忌、敏感话题等）"""
)


# ============ 兼容旧接口 ============
# 保持向后兼容，旧代码仍可使用这些变量名

PROFILE_UPDATE_PROMPT = DEFAULT_PROFILE_UPDATE_PROMPT
PROFILE_COMPRESS_PROMPT = DEFAULT_PROFILE_COMPRESS_PROMPT
