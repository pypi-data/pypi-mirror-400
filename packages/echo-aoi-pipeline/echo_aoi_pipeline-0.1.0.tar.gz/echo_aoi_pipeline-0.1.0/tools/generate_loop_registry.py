#!/usr/bin/env python3
"""Generate loop_registry.yaml with type/scope/maturity tags."""

from __future__ import annotations

import argparse
from pathlib import Path

ROOT = Path(__file__).resolve().parents[1]
REGISTRY = ROOT / "loop_registry.yaml"


def detect_type(name: str) -> str:
    if "judgment" in name.lower():
        return "judgment"
    if "forget" in name.lower():
        return "judgment"
    return "execution"


def detect_scope(path: Path) -> str:
    parts = {p.lower() for p in path.parts}
    if "project_vault" in parts or "tasks" in parts:
        return "project"
    if "world" in parts:
        return "world"
    if "tool" in parts or "tools" in parts:
        return "tooling"
    if "proof_archive" in parts:
        return "proof"
    return "system"


def detect_maturity(name: str) -> str:
    lower = name.lower()
    if "final" in lower or "v1" in lower or "complete" in lower:
        return "sealed"
    return "draft"


def gather_entries() -> list[dict]:
    entries = []
    for loop_file in sorted(ROOT.rglob("*LOOP*.yaml")):
        rel = loop_file.relative_to(ROOT)
        name = rel.name
        loop_type = detect_type(name)
        entries.append(
            {
                "path": str(rel),
                "type": loop_type,
                "scope": detect_scope(rel),
                "maturity": detect_maturity(name),
                "judgment_only": loop_type == "judgment",
            }
        )
    return entries


def write_registry(entries: list[dict]) -> None:
    with REGISTRY.open("w", encoding="utf-8") as fh:
        fh.write("# Auto-generated by tools/generate_loop_registry.py\n")
        fh.write("loop_registry:\n")
        for entry in entries:
            fh.write("  - path: {}\n".format(entry["path"]))
            fh.write("    type: {}\n".format(entry["type"]))
            fh.write("    scope: {}\n".format(entry["scope"]))
            fh.write("    maturity: {}\n".format(entry["maturity"]))
            fh.write("    judgment_only: {}\n".format(str(entry["judgment_only"]).lower()))


def main() -> None:
    parser = argparse.ArgumentParser(description="Generate loop registry.")
    parser.add_argument("--dry-run", action="store_true", help="Print summary instead of writing file.")
    args = parser.parse_args()

    entries = gather_entries()
    if args.dry_run:
        print(f"Would write {len(entries)} entries to {REGISTRY}")
    else:
        write_registry(entries)
        print(f"Wrote {len(entries)} entries to {REGISTRY}")


if __name__ == "__main__":
    main()
