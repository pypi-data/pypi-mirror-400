from __future__ import annotations
from pathlib import Path
import json
from pentestai.ai.router import AIRouter
from pentestai.ai.prompts import SURFACE_SYSTEM, TRIAGE_SYSTEM, REPORT_SYSTEM
from pentestai.core.artifacts import Artifact, now_iso, save_artifact, ws_paths

async def surface_analyze(router: AIRouter, workspace: Path, target: str) -> Artifact:
    paths = ws_paths(workspace)
    live = json.loads((paths["artifacts"] / "recon_live.json").read_text(encoding="utf-8"))
    nmap_exists = (paths["artifacts"] / "recon_nmap.json").exists()

    user = {
        "target": target,
        "live_urls": live["data"].get("urls", []),
        "httpx_count": live["data"].get("count", 0),
        "nmap_available": nmap_exists,
    }
    out = await router.run("surface", SURFACE_SYSTEM, f"Analyze attack surface:\n{json.dumps(user, indent=2)}")

    art = Artifact(kind="ai.surface", created_at=now_iso(), data={"analysis": out})
    save_artifact(paths["artifacts"] / "ai_surface.json", art)
    return art

async def triage_findings(router: AIRouter, workspace: Path) -> Artifact:
    paths = ws_paths(workspace)
    findings = json.loads((paths["artifacts"] / "scan_findings.json").read_text(encoding="utf-8"))
    user = {"findings": findings["data"].get("findings", [])[:200]}  # cap to keep prompts sane
    out = await router.run("triage", TRIAGE_SYSTEM, f"Triage these findings:\n{json.dumps(user, indent=2)}")

    art = Artifact(kind="ai.triage", created_at=now_iso(), data={"triage": out})
    save_artifact(paths["artifacts"] / "ai_triage.json", art)
    return art

async def build_report(router: AIRouter, workspace: Path, target: str) -> Artifact:
    paths = ws_paths(workspace)
    surface = json.loads((paths["artifacts"] / "ai_surface.json").read_text(encoding="utf-8"))
    triage = json.loads((paths["artifacts"] / "ai_triage.json").read_text(encoding="utf-8")) if (paths["artifacts"] / "ai_triage.json").exists() else {}

    user = {"target": target, "surface": surface["data"], "triage": triage.get("data", {})}
    out = await router.run("report", REPORT_SYSTEM, f"Write a report:\n{json.dumps(user, indent=2)}")

    (paths["reports"]).mkdir(parents=True, exist_ok=True)
    report_md = paths["reports"] / "report.md"
    report_md.write_text(out, encoding="utf-8")

    art = Artifact(kind="ai.report", created_at=now_iso(), data={"report_md": str(report_md)})
    save_artifact(paths["artifacts"] / "ai_report.json", art)
    return art
