import{c as k,r as f,j as e,b as w,C as Y,g as T,L as W,q as G,J as q,K as I,M as K}from"./index-D87ilqMg.js";import{L as $,u as X}from"./useLocalStorage-DEoeC3Vt.js";import{I as O}from"./ImageBrowser-DL7XfliW.js";import{I as U}from"./info-CbHhWaqt.js";import"./eye-B6DXG3sW.js";import"./library-CemcgxM6.js";import"./library-Cqp4m2hh.js";const F=[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]],J=k("chevron-up",F);const A=[["path",{d:"M5 12h14",key:"1ays0h"}]],Q=k("minus",A);const V=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],Z=k("rotate-ccw",V),ee=f.memo(({data:t,selected:j,onToggleStack:b})=>{const{image:l,stackCount:i,isStack:c,stackId:d}=t;return e.jsxs("div",{className:"relative group",children:[c&&i&&i>1&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute top-2 left-2 w-full h-full bg-card border border-border rounded-lg -z-10 shadow-sm"}),e.jsx("div",{className:"absolute top-1 left-1 w-full h-full bg-card border border-border rounded-lg -z-10 shadow-sm"}),e.jsx("div",{className:"absolute -top-2 -right-2 z-10 bg-primary text-primary-foreground text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full shadow-md border-2 border-background",children:i})]}),!c&&d&&e.jsx("div",{className:"absolute -top-3 right-0 z-10",children:e.jsx(w,{variant:"secondary",size:"icon-sm",className:"h-6 w-6 rounded-full shadow-md border border-border",onClick:o=>{o.stopPropagation(),b?.()},title:"Collapse Stack",children:e.jsx(J,{className:"h-3 w-3"})})}),e.jsx("div",{className:"absolute -top-1 left-1/2 -translate-x-1/2 w-2 h-2 rounded-full bg-muted-foreground opacity-50"}),e.jsxs(Y,{className:T("w-[240px] overflow-hidden transition-all duration-200 border-2",j?"border-primary ring-2 ring-primary/20":"border-border hover:border-primary/50",!c&&d&&"border-dashed border-primary/40"),children:[e.jsxs("div",{className:"aspect-square relative bg-muted",children:[e.jsx("img",{src:l.thumb_url||l.image_url,alt:l.prompt,className:"w-full h-full object-cover",loading:"lazy",draggable:!1}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-2",children:e.jsx("p",{className:"text-xs text-white line-clamp-2",children:l.prompt})}),c&&e.jsx("div",{className:"absolute top-2 right-2 bg-black/50 p-1 rounded-md backdrop-blur-sm",children:e.jsx($,{className:"w-3 h-3 text-white"})})]}),e.jsx("div",{className:"p-2 bg-card",children:e.jsxs("div",{className:"flex items-center justify-between text-xs text-muted-foreground",children:[e.jsxs("span",{children:["ID: ",l.id]}),e.jsx("span",{children:new Date(l.created_at).toLocaleDateString()})]})})]}),e.jsx("div",{className:"absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 rounded-full bg-muted-foreground opacity-50"})]})}),v=240,L=300,se=()=>{const{nodes:t,edges:j,isLoading:b,selectImage:l,selectedImageId:i,toggleStackExpansion:c}=X(),d=f.useRef(null),[o,m]=f.useState({x:0,y:0,scale:1}),[D,M]=f.useState(!1),[S,z]=f.useState({x:0,y:0});f.useEffect(()=>{if(t.length>0&&d.current){const{width:s,height:a}=d.current.getBoundingClientRect(),r=Math.min(...t.map(p=>p.position.x)),n=Math.max(...t.map(p=>p.position.x+v)),h=Math.min(...t.map(p=>p.position.y)),u=Math.max(...t.map(p=>p.position.y+L)),x=n-r,y=u-h,g=(s-100)/x,E=(a-100)/y,N=Math.min(Math.max(Math.min(g,E),.1),1),H=(r+n)/2,B=(h+u)/2;m({x:s/2-H*N,y:a/2-B*N,scale:N})}},[t]);const _=s=>{if(s.ctrlKey||s.metaKey){s.preventDefault();const r=Math.min(Math.max(o.scale-s.deltaY*.001,.1),3),n=d.current?.getBoundingClientRect();if(n){const h=s.clientX-n.left,u=s.clientY-n.top,x=r-o.scale,y=o.x-(h-o.x)*(x/o.scale),g=o.y-(u-o.y)*(x/o.scale);m({x:y,y:g,scale:r})}}else m(a=>({...a,x:a.x-s.deltaX,y:a.y-s.deltaY}))},P=s=>{(s.button===0||s.button===1)&&(M(!0),z({x:s.clientX,y:s.clientY}))},R=s=>{if(D){const a=s.clientX-S.x,r=s.clientY-S.y;m(n=>({...n,x:n.x+a,y:n.y+r})),z({x:s.clientX,y:s.clientY})}},C=()=>{M(!1)};return b&&t.length===0?e.jsxs("div",{className:"flex items-center justify-center h-full w-full text-muted-foreground",children:[e.jsx(W,{className:"w-8 h-8 animate-spin mr-2"}),"Loading lineage..."]}):t.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full text-muted-foreground p-8 text-center",children:[e.jsx(U,{className:"w-12 h-12 mb-4 opacity-50"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No Lineage Selected"}),e.jsx("p",{className:"max-w-md",children:"Select an image from the sidebar to view its generation family tree. This will show parents (source images) and children (variations/upscales)."})]}):e.jsxs("div",{ref:d,className:"w-full h-full bg-muted/10 overflow-hidden relative cursor-grab active:cursor-grabbing",onWheel:_,onMouseDown:P,onMouseMove:R,onMouseUp:C,onMouseLeave:C,children:[e.jsxs("div",{className:"absolute bottom-4 right-4 flex flex-col gap-2 z-50",children:[e.jsx(w,{size:"icon",variant:"secondary",onClick:()=>m(s=>({...s,scale:Math.min(s.scale+.1,3)})),children:e.jsx(G,{className:"w-4 h-4"})}),e.jsx(w,{size:"icon",variant:"secondary",onClick:()=>m(s=>({...s,scale:Math.max(s.scale-.1,.1)})),children:e.jsx(Q,{className:"w-4 h-4"})}),e.jsx(w,{size:"icon",variant:"secondary",onClick:()=>{m({x:0,y:0,scale:1})},children:e.jsx(Z,{className:"w-4 h-4"})})]}),e.jsxs("div",{style:{transform:`translate(${o.x}px, ${o.y}px) scale(${o.scale})`,transformOrigin:"0 0",width:"100%",height:"100%",position:"absolute",top:0,left:0,willChange:"transform"},children:[e.jsxs("svg",{className:"absolute top-0 left-0 overflow-visible pointer-events-none",style:{width:"100%",height:"100%"},children:[e.jsx("defs",{children:e.jsx("marker",{id:"arrowhead",markerWidth:"10",markerHeight:"7",refX:"9",refY:"3.5",orient:"auto",children:e.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:"#ff0000"})})}),j.map(s=>{const a=t.find(g=>g.id===s.source),r=t.find(g=>g.id===s.target);if(!a||!r)return null;const n=a.position.x+v/2,h=a.position.y+L-10,u=r.position.x+v/2,x=r.position.y-5,y=`M ${n} ${h} C ${n} ${h+50}, ${u} ${x-50}, ${u} ${x}`;return e.jsx("path",{d:y,stroke:"#ff0000",strokeWidth:"3",fill:"none",markerEnd:"url(#arrowhead)"},s.id)})]}),t.map(s=>e.jsx("div",{style:{position:"absolute",transform:`translate(${s.position.x}px, ${s.position.y}px)`,width:v},onClick:a=>{a.stopPropagation(),s.data.isStack&&s.data.stackId?c(s.data.stackId):l(s.id)},children:e.jsx(ee,{data:s.data,selected:i===s.id,onToggleStack:()=>{s.data.stackId&&c(s.data.stackId)}})},s.id))]})]})},te=()=>{const{loadLineage:t,toggleStacking:j,stackByPHash:b}=X(),l=f.useCallback(i=>{t(i.id.toString())},[t]);return e.jsx("div",{className:"h-[calc(100vh)] p-1  w-full overflow-hidden bg-background",children:e.jsxs(q,{direction:"horizontal",className:"border",children:[e.jsx(I,{defaultSize:"25%",minSize:"20%",maxSize:"40%",children:e.jsxs("div",{className:"h-full border-r bg-card",children:[e.jsxs("div",{className:"p-4 border-b",children:[e.jsx("h2",{className:"font-semibold",children:"Image Browser"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Select an image to view lineage"})]}),e.jsx("div",{className:"h-[calc(100%-5rem)] overflow-y-auto p-4",children:e.jsx(O,{onSelect:l})})]})}),e.jsx(K,{}),e.jsx(I,{defaultSize:75,children:e.jsxs("div",{className:"h-full w-full relative",children:[e.jsx("div",{className:"absolute top-4 left-4 z-10",children:e.jsxs(Y,{className:"p-2 bg-background/80 backdrop-blur border-border/50 flex items-center gap-2",children:[e.jsx("h1",{className:"text-lg font-bold",children:"Lineage Graph"}),e.jsxs(w,{variant:b?"default":"outline",size:"sm",onClick:j,title:"Toggle PHash Stacking",children:[e.jsx($,{className:"w-4 h-4 mr-2"}),b?"Stacked":"Stack"]})]})}),e.jsx(se,{})]})})]})})},de=te;export{de as component};
