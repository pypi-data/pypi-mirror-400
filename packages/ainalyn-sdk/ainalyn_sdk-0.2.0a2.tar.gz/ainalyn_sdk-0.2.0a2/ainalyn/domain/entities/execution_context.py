"""
Execution Context for Runtime Wrapper.

This module defines the ExecutionContext and related entities that
represent the context passed from Platform Core to SDK Runtime.

According to v0.2 specification (05_platform_core_API_EIP_extension_standard.md),
the Worker Invocation Payload has a specific structure:
- meta: executionId, agentId, version, attempt, mode
- security: userSub, parentExecutionId
- input: user-defined input data
- infra: resultTableName (ASYNC mode only)

IMPORTANT: This is for SDK Runtime to PARSE incoming events from
Platform Core. The SDK does NOT generate these contexts.
"""

from __future__ import annotations

from dataclasses import dataclass
from enum import Enum
from typing import Any


class ExecutionMode(Enum):
    """
    Execution mode for Platform Core routing.

    Determines the communication pattern between Platform Core and Worker.

    Attributes:
        SYNC: Synchronous execution via Lite Route.
            - Direct Lambda invoke (RequestResponse)
            - Platform Core waits for result
            - Suitable for executions < 15 minutes
        ASYNC: Asynchronous execution via Heavy Route.
            - Event-based invoke
            - Worker writes result directly to DynamoDB
            - Suitable for long-running executions
    """

    SYNC = "SYNC"
    ASYNC = "ASYNC"


@dataclass(frozen=True, slots=True)
class ExecutionMeta:
    """
    Metadata about the current execution.

    This information is provided by Platform Core and should not
    be modified by the SDK Runtime.

    Attributes:
        execution_id: Unique identifier for this execution (exec-XXXXX-XXXXX).
            Generated by Platform Core. Used for tracking and billing.
        agent_id: The Agent being executed (matches AgentDefinition.name).
        version: The Agent version being executed.
        attempt: Retry attempt number (starts at 1).
        mode: Execution mode (SYNC or ASYNC).
        start_time: ISO 8601 timestamp when execution started.
    """

    execution_id: str
    agent_id: str
    version: str
    attempt: int
    mode: ExecutionMode
    start_time: str | None = None


@dataclass(frozen=True, slots=True)
class SecurityContext:
    """
    Security context for the execution.

    Contains identity and authorization information from Platform Core.

    Attributes:
        user_sub: Cognito user ID of the requesting user.
        permissions: List of permission scopes granted to this execution.
            Example: ["agent:execute", "storage:read"]
        parent_execution_id: If this is a sub-execution (nested call),
            the ID of the parent execution. Used for billing aggregation.
    """

    user_sub: str
    permissions: tuple[str, ...] = ()
    parent_execution_id: str | None = None


@dataclass(frozen=True, slots=True)
class InfraContext:
    """
    Infrastructure context for ASYNC executions.

    Contains AWS resource information needed for the Worker to
    report results directly to DynamoDB (ASYNC mode only).

    Attributes:
        result_table_name: DynamoDB table name for writing results.
            Example: "ainalyn-core-executions-prod"
    """

    result_table_name: str


@dataclass(frozen=True, slots=True)
class ExecutionContext:
    """
    Complete execution context passed from Platform Core to Worker.

    ExecutionContext is the parsed representation of the Worker
    Invocation Payload. It contains all information the SDK Runtime
    needs to execute the user's handler and report results.

    IMPORTANT: This context is READ-ONLY. The SDK must not modify
    execution metadata or security context.

    Attributes:
        meta: Execution metadata (ID, agent, version, mode).
        security: Security context (user identity, parent execution).
        input_data: User-provided input for the handler.
        infra: Infrastructure context (ASYNC mode only).

    Example:
        >>> # Parsed from Platform Core event:
        >>> context = ExecutionContext(
        ...     meta=ExecutionMeta(
        ...         execution_id="exec-12345-abcde",
        ...         agent_id="pdf-parser",
        ...         version="1.0.0",
        ...         attempt=1,
        ...         mode=ExecutionMode.SYNC,
        ...     ),
        ...     security=SecurityContext(
        ...         user_sub="cognito-user-123",
        ...     ),
        ...     input_data={"file_url": "s3://bucket/file.pdf"},
        ... )
    """

    meta: ExecutionMeta
    security: SecurityContext
    input_data: dict[str, Any]
    infra: InfraContext | None = None
