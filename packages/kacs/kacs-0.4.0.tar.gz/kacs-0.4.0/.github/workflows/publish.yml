name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build

    - name: Build package
      run: python -m build

    - name: Generate changelog
      env:
        ASK2API_API_KEY: ${{ secrets.ASK2API_API_KEY }}
        TAG_NAME: ${{ github.ref_name }}
      run: |
        pip install -e .
        # Get previous tag for changelog generation
        TAGS=$(git tag --sort=-creatordate)
        PREV_TAG=$(echo "$TAGS" | sed -n '2p')
        if [ -z "$PREV_TAG" ]; then
          echo "No previous tag found. Creating initial changelog."
          printf "## [%s]\n\nInitial release.\n" "$TAG_NAME" > CHANGELOG.md
        else
          kacs --from-tag "$PREV_TAG" --to-tag "$TAG_NAME" --output CHANGELOG.md
        fi
    - name: Extract changelog
      id: changelog
      env:
        TAG_NAME: ${{ github.ref_name }}
      run: |
        python <<'PY'
        import os
        import pathlib
        import re

        tag = os.environ["TAG_NAME"]
        version = tag[1:] if tag.startswith("v") else tag

        changelog_path = pathlib.Path("CHANGELOG.md")
        if changelog_path.exists():
          changelog = changelog_path.read_text()
          pattern = re.compile(rf"^## \[{re.escape(version)}\][^\n]*\n(.*?)(?=\n## \[|\Z)", re.DOTALL | re.MULTILINE)
          section = pattern.search(changelog)
          body = section.group(1).strip() if section else f"Release {version}"
        else:
          body = f"Release {version}"

        if not body:
          body = f"Release {version}"

        output = pathlib.Path("release_notes.md")
        output.write_text(body + "\n")
        print(body)
        PY

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        body_path: release_notes.md
        generate_release_notes: false

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
