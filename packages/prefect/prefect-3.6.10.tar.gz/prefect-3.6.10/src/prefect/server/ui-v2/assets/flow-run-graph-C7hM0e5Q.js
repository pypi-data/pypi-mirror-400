import{r as a,j as e}from"./vendor-tanstack-BVzzyDEt.js";import{T as O,u as c,l as L,h as z,f as B,p as q,m as M,g as U,y as $,a as F,d as K,b as I,i as Q,v as J,x as X,c as V,_ as W,e as A}from"./vendor-graphs-DzwXylWd.js";import{dN as G,bP as k,bQ as S,q as h,I as _,bR as N,a3 as D,j as g,A as b,cH as Y,cI as Z,cJ as ee,z as te}from"./index-BJkJ93Lr.js";import{p as d}from"./vendor-date-2jFo9aCm.js";import"./vendor-react-Bce9NwRC.js";import"./vendor-radix-CTAic6HB.js";import"./vendor-recharts-Mwm2qLZp.js";import"./vendor-forms-BN3tpxM2.js";async function se(t){const{data:s}=await(await G()).GET("/flow_runs/{id}/graph-v2",{params:{path:{id:t}}});if(!s)throw new Error("No data returned from API");return ae(s)}async function re({since:t,until:s,nodeId:n}){const{data:i}=await(await G()).POST("/events/filter",{body:{filter:{any_resource:{id:[`prefect.flow-run.${n}`]},event:{exclude_prefix:["prefect.log.write","prefect.task-run."]},occurred:{since:t.toISOString(),until:s.toISOString()},order:"ASC"},limit:200}});if(!i)throw new Error("No data returned from API");return ne(i)}function ae(t){if(!t.start_time)throw new Error("Start time is required");return{root_node_ids:t.root_node_ids,start_time:d(t.start_time),end_time:t.end_time?d(t.end_time):null,nodes:new Map(t.nodes.map(s=>ie(s)))}}function ne(t){return t.events.map(s=>{if(!s.received)throw new Error("Received is required");return{id:s.id,received:d(s.received),occurred:d(s.occurred),event:s.event,resource:s.resource,payload:s.payload,related:s.related??[]}})}function ie([t,s]){if(!s.start_time)throw new Error("Start time is required");return[t,{kind:s.kind,id:s.id,label:s.label,state_type:s.state_type,start_time:d(s.start_time),end_time:s.end_time?d(s.end_time):null,parents:s.parents,children:s.children,artifacts:s.artifacts.map(le)}]}function le(t){if(!t.type)throw new Error("Artifact type is required");return t.type==="progress"&&typeof t.data=="number"?{id:t.id,created:d(t.created),key:t.key??void 0,type:t.type,data:t.data}:{id:t.id,created:d(t.created),key:t.key??void 0,type:t.type}}const T={COMPLETED:"#219D4B",RUNNING:"#09439B",SCHEDULED:"#E08504",PENDING:"#554B58",FAILED:"#DE0529",CANCELLED:"#333333",CANCELLING:"#333333",CRASHED:"#EA580C",PAUSED:"#554B58"};function H(t){return!t||!(t instanceof HTMLElement)?!1:["INPUT","TEXTAREA","SELECT"].includes(t.tagName)}const R=()=>{O({animate:!0})};function ce(){return a.useEffect(()=>{const t=new AbortController;return document.addEventListener("keydown",s=>{H(s.target)||s.metaKey||s.ctrlKey||s.key==="c"&&R()},{signal:t.signal}),()=>t.abort()},[]),e.jsxs(k,{children:[e.jsx(S,{asChild:!0,children:e.jsx(h,{variant:"outline",size:"icon",onClick:R,children:e.jsx(_,{id:"Crosshair",className:"size-4"})})}),e.jsx(N,{children:"Recenter (c)"})]})}function oe({fullscreen:t,onFullscreenChange:s}){const n=a.useCallback(()=>{s(!t)},[t,s]);return a.useEffect(()=>{const i=new AbortController;return document.addEventListener("keydown",l=>{if(!(H(l.target)||l.metaKey||l.ctrlKey)){if(l.key==="f"){n();return}if(l.key==="Escape"){n();return}}},{signal:i.signal}),()=>i.abort()},[n]),e.jsxs(k,{children:[e.jsx(S,{asChild:!0,children:e.jsx(h,{variant:"outline",size:"icon",onClick:n,children:e.jsx(_,{id:"Expand",className:"size-4"})})}),e.jsx(N,{children:"Fullscreen (f)"})]})}const de=[{label:"Temporal dependency",value:"temporal_nearest-parent"},{label:"Temporal sequence",value:"temporal_waterfall"},{label:"Dependency grid",value:"dependency_nearest-parent"},{label:"Sequential grid",value:"dependency_waterfall"},{label:"Comparative duration",value:"left-aligned_duration-sorted"}],ue=()=>{const t=I+1,s=c.horizontalScaleMultiplier*t;F(s)},he=()=>{const t=Math.abs(I-1),s=c.horizontalScaleMultiplier*t;F(s)},pe=()=>{K()};function fe(t){const[s,n]=t.split("_");return L(s)&&z(n)}function me(){const[t,s]=a.useState(`${c.horizontal}_${c.vertical}`),[n,i]=a.useState(c.disableEdges),[l,v]=a.useState(c.disableArtifacts),[E,y]=a.useState(c.disableEvents),f=a.useCallback(r=>{if(!fe(r))return;const[u,m]=r.split("_");!L(u)||!z(m)||(s(r),B(u),q(m))},[]),p=a.useCallback(r=>{i(r),M(r)},[]),j=a.useCallback(r=>{v(r),U(r)},[]),C=a.useCallback(r=>{y(r),$(r)},[]);return e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(D,{variant:"bodyLarge",children:"Layout"}),e.jsx("div",{className:"flex flex-col gap-2",children:de.map(r=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"radio",id:r.value,name:"layout",value:r.value,checked:t===r.value,onChange:u=>f(u.target.value)}),e.jsx(g,{htmlFor:r.value,children:r.label})]},r.value))})]}),(c.isTemporal()||c.isLeftAligned())&&e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx(D,{variant:"bodyLarge",children:"Scaling"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:he,title:"Decrease scale (-)",children:"-"}),e.jsx(h,{variant:"outline",size:"sm",onClick:ue,title:"Increase scale (+)",children:"+"}),e.jsx(h,{variant:"outline",size:"sm",onClick:pe,children:"Reset"})]})]}),e.jsx("hr",{className:"my-4"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{id:"hideEdges",checked:n,onCheckedChange:p}),e.jsx(g,{htmlFor:"hideEdges",children:"Hide dependency arrows"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{id:"hideArtifacts",checked:l,onCheckedChange:j}),e.jsx(g,{htmlFor:"hideArtifacts",children:"Hide artifacts"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{id:"hideEvents",checked:E,onCheckedChange:C}),e.jsx(g,{htmlFor:"hideEvents",children:"Hide events"})]})]})]})}function xe(){return e.jsxs(Y,{children:[e.jsx(Z,{children:e.jsxs(k,{children:[e.jsx(S,{asChild:!0,children:e.jsx(h,{variant:"outline",size:"icon",children:e.jsx(_,{id:"Cog",className:"size-4"})})}),e.jsx(N,{children:"Settings"})]})}),e.jsx(ee,{children:e.jsx(me,{})})]})}function ge({fullscreen:t,onFullscreenChange:s}){return e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ce,{}),e.jsx(oe,{fullscreen:t,onFullscreenChange:s}),e.jsx(xe,{})]})}function Se({flowRunId:t,viewport:s,onViewportChange:n,selected:i,onSelectedChange:l,className:v,style:E,fullscreen:y,onFullscreenChange:f}){const p=a.useRef(null),[j,C]=a.useState(!1),{resolvedTheme:r}=te(),u=y??j,m=a.useCallback(o=>{C(o),f?.(o)},[f]),x=a.useMemo(()=>({runId:t,fetch:se,fetchEvents:re,styles:()=>({node:o=>({background:T[o.state_type]}),state:o=>({background:T[o.type]})}),theme:r==="dark"?"dark":"light"}),[t,r]);return a.useEffect(()=>{Q(x)},[x]),a.useEffect(()=>{if(!p.current)throw new Error("Stage does not exist");return J({stage:p.current,config:x}),()=>{X()}},[x]),a.useEffect(()=>{V(i??null)},[i]),a.useEffect(()=>{W(s)},[s]),a.useEffect(()=>{const o=A.on("itemSelected",w=>l?.(w??void 0)),P=A.on("viewportDateRangeUpdated",w=>n?.(w));return()=>{o(),P()}},[l,n]),e.jsxs("div",{className:`${u?"fixed h-screen w-screen z-20":"relative h-[500px] w-full "} ${v??""}`,style:E,children:[e.jsx("div",{ref:p,className:"size-full [&>canvas]:size-full"}),e.jsx("div",{className:"absolute bottom-0 right-0",children:e.jsx(ge,{fullscreen:u,onFullscreenChange:m})})]})}export{Se as FlowRunGraph};
//# sourceMappingURL=flow-run-graph-C7hM0e5Q.js.map
