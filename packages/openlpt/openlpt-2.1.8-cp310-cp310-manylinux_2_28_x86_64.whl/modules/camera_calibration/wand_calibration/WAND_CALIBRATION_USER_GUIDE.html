<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wand Calibration User Guide</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #e0e0e0;
            background-color: #1e1e1e;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: #00bcd4;
            border-bottom: 2px solid #00bcd4;
            padding-bottom: 10px;
        }

        h2 {
            color: #4dd0e1;
            margin-top: 40px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        h3 {
            color: #80deea;
            margin-top: 25px;
        }

        img {
            max-width: 100%;
            border: 1px solid #444;
            border-radius: 5px;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .container {
            background-color: #252526;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        ul,
        ol {
            padding-left: 25px;
        }

        li {
            margin-bottom: 8px;
        }

        strong {
            color: #ffffff;
        }

        code {
            background-color: #333;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: Consolas, monospace;
            color: #ff9800;
        }

        .step-block {
            margin-bottom: 20px;
            padding-left: 15px;
            border-left: 3px solid #00bcd4;
        }

        .highlight {
            background-color: #2d2d30;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #3e3e42;
        }

        .important {
            color: #ff5252;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>Wand Calibration User Guide</h1>
        <p>This guide walks you through the camera calibration process using a calibration wand in OpenLPT. The process
            consists of two main stages: <strong>Point Detection</strong> and <strong>Calibration</strong>.</p>

        <div class="highlight">
            <span class="important">Note on Refracted Interfaces:</span>
            <p style="margin-top: 5px;">The implemented calibration model assumes a homogeneous medium without
                refractive interfaces. For experimental setups involving observation windows (e.g., glass or acrylic),
                it is critical that the cameras are oriented as close to the surface normal (orthogonal) as possible.
                Furthermore, it is assumed that the paraxial approximation is valid within the reconstructed volume
                (i.e., small-angle observation) to maintain geometric accuracy.</p>
        </div>

        <!-- Point Detection Section -->
        <h2>1. Point Detection</h2>
        <p>First, select the <strong>Wand Calibration</strong> tab and ensure you are on the <strong>Point
                Detection</strong> sub-tab.</p>

        <img src="wand_detection_ui.png" alt="Point Detection Interface">

        <div class="step-block">
            <h3>Step 1: Configure Settings</h3>
            <p>Set the detection parameters in the <strong>Detection Settings</strong> panel on the right:</p>
            <ul>
                <li><strong>Num Cameras</strong>: Enter the number of cameras in your setup (e.g., <code>2</code>).</li>
                <li><strong>Wand Type</strong>: Choose <strong>Dark on Bright</strong> (dark balls on a bright
                    background) or <strong>Bright on Dark</strong>.</li>
                <li><strong>Radius Range</strong>: Adjust the slider to cover the expected radius (in pixels) of the
                    wand balls in your images (e.g., <code>45</code> to <code>120</code>).</li>
                <li><strong>Sensitivity</strong>: Set the detection sensitivity (default is around <code>0.85</code>).
                </li>
            </ul>
        </div>

        <div class="step-block">
            <h3>Step 2: Load Camera Images</h3>
            <p>In the <strong>Camera Images</strong> table:</p>
            <ol>
                <li>For each <strong>Cam ID</strong>, load the corresponding folder of calibration images (click the
                    cell or a load button if available).</li>
                <li>Enter the initial <strong>Focal Length (px)</strong> (e.g., <code>9000</code>).</li>
                <li>Enter the detection <strong>Width</strong> and <strong>Height</strong> (e.g., <code>1280</code> x
                    <code>800</code>).
                </li>
            </ol>
        </div>

        <div class="step-block">
            <h3>Step 3: Verify and Process</h3>
            <ol>
                <li>Select a frame from the <strong>Frame List</strong>.</li>
                <li>Click <strong>Test Detect (Current Frame)</strong>.
                    <ul>
                        <li><em>Verification</em>: Look at the image view on the left. You should see <strong>green
                                circles</strong> identifying the two balls on the wand. If not, adjust the <em>Radius
                                Range</em> or <em>Sensitivity</em>.</li>
                    </ul>
                </li>
                <li>Once satisfied with the detection test, click <strong>Process All Frames / Resume</strong> to detect
                    points in all loaded images.</li>
            </ol>
        </div>

        <hr style="border-color: #444; margin: 40px 0;">

        <!-- Calibration Section -->
        <h2>2. Calibration</h2>
        <p>After extracting points, switch to the <strong>Calibration</strong> sub-tab.</p>

        <!-- Updated Image -->
        <img src="wand_calibration_ui_v2.png" alt="Calibration Interface">

        <div class="step-block">
            <h3>Step 4: Calibration Settings</h3>
            <p>Configure the physical model in <strong>Calibration Settings</strong>:</p>
            <ul>
                <li><strong>Camera Model</strong>: Select <strong>Pinhole</strong> (standard).</li>
                <li><strong>Wand Length</strong>: Enter the exact physical distance between the centers of the two wand
                    balls (e.g., <code>10.00 mm</code>). <span style="color: #ff5252;"><strong>Accurate measurement is
                            critical.</strong></span></li>
                <li><strong>Dist Coeffs</strong>: Number of distortion coefficients to optimize (typically
                    <code>0</code> for initial testing, or higher for complex lenses).
                </li>
            </ul>
        </div>

        <!-- NEW Step: Precalibration -->
        <div class="step-block">
            <h3>Step 5: Precalibration & Data Cleaning</h3>
            <p>Before running the full optimization, it is crucial to clean your data to remove outliers (errors in
                detection).</p>
            <ol>
                <li>Click the orange <strong>Precalibrate to Check</strong> button.</li>
                <li>The system will perform a fast, global optimization to estimate the error of each frame.</li>
                <li>Check the <strong>Error Analysis</strong> table usage below:
                    <ul>
                        <li>High <strong>Reprojection Errors</strong> (red) indicate bad detections.</li>
                        <li>High <strong>Length Errors</strong> indicate points that don't match the physical wand
                            length.</li>
                    </ul>
                </li>
                <li><strong>Visual Verification</strong>:
                    <ul>
                        <li>Click on any cell in the table (e.g., a high error value).</li>
                        <li>Look at the <strong>Left View</strong>: It will show the original camera image overlaid with
                            the detected points (green circles).</li>
                        <li>Check if the detection is correct. If the system detected a reflection or noise instead of a
                            wand, click the checkbox in the <strong>Del</strong> column to mark it for removal.</li>
                    </ul>
                </li>
                <li><strong>Iterative Cleaning</strong>:
                    <ul>
                        <li>Use the filter buttons (e.g., "Delete when proj error > X") or manual Del checkboxes to
                            exclude bad frames.</li>
                        <li>Click <strong>Precalibrate to Check</strong> AGAIN.</li>
                        <li>Repeat until errors are low (e.g., &lt; 1.0 px).</li>
                    </ul>
                </li>
            </ol>
        </div>

        <div class="step-block">
            <h3>Step 6: Run Full Calibration</h3>
            <ol>
                <li>Click the blue <strong>Run Calibration</strong> button.</li>
                <li>The system will perform the final Bundle Adjustment (BA) with 4-stage optimization (Geometry Init ->
                    Intrinsics -> Triangulation -> Final Tune).</li>
                <li>The <strong>3D View</strong> on the left will visualize the optimized camera positions and wand
                    points.</li>
            </ol>
        </div>

        <div class="step-block">
            <h3>Step 7: Final Analysis</h3>
            <p>Review the final results in the <strong>Error Analysis</strong> table:</p>
            <ul>
                <li><strong>Reprojection Error</strong>: Should be very low (e.g., &lt; 0.5 px).</li>
                <li><strong>Length Error</strong>: Should be close to 0.</li>
            </ul>
            <div class="highlight">
                <strong>Stopping & Refining:</strong>
                <ul>
                    <li>If the process takes too long or results look wrong, click the <strong>Stop</strong> button to
                        get partial results.</li>
                    <li>If errors are still high, perform another round of cleaning (Step 5) or adjust the <em>Wand
                            Length</em> setting.</li>
                </ul>
            </div>
        </div>

        <div class="step-block">
            <h3>Step 8: Save Results</h3>
            <p>When the "Calibration Successful" message appears, your parameters are ready. You can save the intrinsic
                and extrinsic parameters to file for use in tracking.</p>
        </div>

    </div>

</body>

</html>