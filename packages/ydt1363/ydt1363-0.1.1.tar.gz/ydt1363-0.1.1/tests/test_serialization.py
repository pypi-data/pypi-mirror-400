"""
Serialization test
"""

import binascii
from ydt1363 import BMSProtocol
import ydt1363

PACKETS = [
    # pylint: disable=line-too-long
    b"3e3232303138343834453030323031464432420d",
    b"3e323230313835383534304330303146373833313436353030354630303634373031343735333037353330303033463130304343303043424630434330304343313043433230434330304342463043424530434243304342453043424530434245304342463043433130434333304342443034303037383030383230303843303038323030383230303936443030303030303030303032303030303030303030303233303030303030303233393233303230303036304343333043424330303936303037383438343434453230443438450d",
    b"3e3232303238343834453030323032464432390d",
    b"3e323230323835383534304330303246373930313436363030334330303634343732303735333037353330303033383130304343313043433230434330304343313043433030434331304342463043424530434245304343313043424630434332304343313043433230434246304343313034303037383030373830303645303037383030373830303832443030303030303030303032303030303030303030303233303030303030303233393233303230303036304343323043424530303832303036453438343434453230443444350d",
    b"3e3232303338343834453030323033464432370d",
    b"3e3232303438343834453030323034464432350d",
    b"3e3232303538343834453030323035464432330d",
    b"3e3232303638343834453030323036464432310d",
    b"3e3232303738343834453030323037464431460d",
    b"3e3232303838343834453030323038464431440d",
    b"3e3232303938343834453030323039464431420d",
    b"3e3232304138343834453030323041464430420d",
    b"3e3232304238343834453030323042464430390d",
    b"3e3232304338343834453030323043464430370d",
    b"3e3232304438343834453030323044464430350d",
    b"3e3232304538343834453030323045464430330d",
    b"3e3232304638343834453030323046464430310d",
    b"3e323230313835383534304330303146374134313436343030354630303634373030463735333037353330303033463130304343303043433030434246304343313043433130434330304342463043424330434242304342463043424530434245304342453043433130434331304342453034303037383030383230303843303038323030383230303936443030303030303030303032303030303030303030303233303030303030303233393233303230303036304343313043424230303936303037383438343434453230443437430d",
    b"3e323230323835383534304330303246373938313436363030334330303634343731423735333037353330303033383130304342463043433230434330304343313043424630434330304342463043433030434246304343303043424630434331304343313043433230434246304343303034303037383030373830303645303037383030383230303832443030303030303030303032303030303030303030303233303030303030303233393233303230303036304343323043424630303832303036453438343434453230443441450d",
    b"3e323230313835383534304330303146374137313436343030354630303634373030413735333037353330303033463130304343313043424530434331304342463043433230434244304343303043424230434243304342443043424630434243304343303043433030434333304342433034303037383030383230303843303038323030383230303936443030303030303030303032303030303030303030303233303030303030303233393233303230303036304343333043424230303936303037383438343434453230443438300d",
    b"3e323230323835383534304330303246373937313436363030334330303634343731363735333037353330303033383130304343313043433130434332304342463043433030434246304343303043424330434246304342463043433030434330304343323043433030434331304342453034303037383030373830303645303037383030373830303832443030303030303030303032303030303030303030303233303030303030303233393233303230303036304343323043424330303832303036453438343434453230443442440d",
    b"3e323230313835383534304330303146374638313439373030353730303634363645443735333037353330303034303130304344453043444630434445304345303043453030434446304344453043444630434439304344463043444230434445304344453043453130434531304345303034303038323030383230303832303038323030384330304130443030303030303030303032303030303030303030303233303030303030303233393233303230303036304345313043443930304130303038323438343434453230443434370d"
    b"3e323230323835383534304330303246373742313439383030344630303634354344353735333037353330303033393130304344453043453230434445304345303043444530434531304344453043453030434445304345313043444430434531304344463043453230434444304345313034303038323030383230303738303038323030384330303936443030303030303030303032303030303030303030303233303030303030303233393233303230303036304345323043444430303936303037383438343434453230443435310d",
    b"3e3232303938343834453030323039464431420d3e3232304138343834453030323041464430420d3e3232304238343834453030323042464430390d",
]


def test_serialization():
    """Test that serialization works both ways."""
    p = BMSProtocol()

    for packet in PACKETS:
        reencoded = b""
        data = p.feed_data(binascii.unhexlify(packet))
        print(f"Data: {data}")
        for frame in data:
            new_frame = p.build_frame(
                adr=frame.adr, cid1=frame.cid1, cid2=frame.cid2, info=frame.info
            )
            reencoded += new_frame
        p2 = BMSProtocol()
        data2 = p2.feed_data(reencoded)
        print(f"Re-decoded Data: {data2}")
        assert data2 == data
        assert binascii.unhexlify(packet) == reencoded


def test_serialization_no_soi():
    """Test that packets without SOI are ignored."""
    p = BMSProtocol()

    # No SOI
    frames = p.feed_data(binascii.unhexlify(b"3232303138343834453030323031464432420d"))
    assert len(frames) == 0
    # SOI is not at the beginning
    frames = p.feed_data(
        binascii.unhexlify(
            # pylint: disable=line-too-long
            b"3232303938343834453030323039464431420d3e3232304138343834453030323041464430420d3e3232304238343834453030323042464430390d"
        )
    )
    assert len(frames) == 2


def test_serialization_no_eoi():
    """Test that packets without EOI are buffered until complete."""
    p = BMSProtocol()

    # No EOI
    frames = p.feed_data(binascii.unhexlify(b"3e323230313834383445303032303146443242"))
    assert len(frames) == 0
    frames = p.feed_data(binascii.unhexlify(b"0d"))
    assert len(frames) == 1


def test_packet_too_short():
    """Test that too short packets are ignored."""
    p = BMSProtocol()

    frames = p.feed_data(binascii.unhexlify(b"3e3232300d"))
    assert len(frames) == 0


def test_packet_wrong_checksum():
    """Test that packets with wrong checksum are ignored."""
    p = BMSProtocol()

    frames = p.feed_data(binascii.unhexlify(b"3e3232303138343834453030323031464432410d"))
    assert len(frames) == 0


def test_invalid_version():
    """Test that packets with invalid version are ignored."""
    p = BMSProtocol()

    body = binascii.unhexlify(b"3233303138343834453030323031")
    chksum = ydt1363.utils.calculate_chksum(body)

    frames = p.feed_data(b">" + body + chksum + b"\r")
    assert len(frames) == 0
