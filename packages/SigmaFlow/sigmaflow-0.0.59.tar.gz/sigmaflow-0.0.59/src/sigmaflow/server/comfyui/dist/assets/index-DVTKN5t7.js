var dt=Object.defineProperty;var u=(n,e)=>dt(n,"name",{value:e,configurable:!0});import{r as p,cL as T,cM as Je,cN as b,aq as I,au as R,cO as ct,ai as J,aO as X,cP as ut,cQ as pt,bk as Qe,a8 as gt,w as ft,f as S,a0 as ht,t as D,p as te,am as mt,by as yt,at as wt,cR as vt,cS as bt,cT as L,cU as P,b4 as Nt,cV as be,cW as Ct,cX as It,cY as kt,cZ as Dt,c_ as Le,c$ as oe,d0 as F,d1 as B,aE as de,d2 as Ze,d3 as xt,d4 as _t,d5 as Tt,d6 as W,B as St,a as E,D as Mt,d7 as Et,d8 as et,d9 as Ot,aA as At,aF as Pt,e as ee,da as $,cJ as re,db as Lt,cI as ce,dc as De,dd as xe,de as Gt,u as tt,cH as Wt,df as ot,dg as Rt,T as Ge,dh as Ft,c3 as Ut,di as Bt,dj as Vt,dk as $t,dl as zt}from"./index-BupDt9kP.js";import{bz as jt,cD as We,d4 as H,n as _e,eF as Ht}from"./vendor-other-PcOcwbNM.js";import{_ as Te}from"./Load3D.vue_vue_type_script_setup_true_lang-BjlySciI.js";import{g as ue,s as nt}from"./audioUtils-CiZ70ee-.js";import{u as Z}from"./audioService-B4nm0-8_.js";import"./vendor-primevue-6nO4LMK3.js";import"./vendor-vue-Cz2Pyvdp.js";import"./vendor-xterm-CWYFmgbN.js";import"./vendor-three-Bbe9LX3q.js";import"./vendor-tiptap-BsEBJZ_K.js";class M extends Je{static{u(this,"ClipspaceDialog")}static items=[];static instance=null;static registerButton(e,i,s){const t=b("button",{type:"button",textContent:e,contextPredicate:i,onclick:s});M.items.push(t)}static invalidatePreview(){if(T.clipspace&&T.clipspace.imgs&&T.clipspace.imgs.length>0){const e=document.getElementById("clipspace_preview");e&&(e.src=T.clipspace.imgs[T.clipspace.selectedIndex].src,e.style.maxHeight="100%",e.style.maxWidth="100%")}}static invalidate(){if(M.instance){const e=M.instance,i=b("div.comfy-modal-content",[e.createImgSettings(),...e.createButtons()]);e.element?(e.element.firstChild&&e.element.removeChild(e.element.firstChild),e.element.appendChild(i)):e.element=b("div.comfy-modal",{parent:document.body},[i]),e.element.children[0].children.length<=1&&e.element.children[0].appendChild(b("p",{},["Unable to find the features to edit content of a format stored in the current Clipspace."])),M.invalidatePreview()}}constructor(){super()}createButtons(){const e=[];for(let i in M.items){const s=M.items[i];(!s.contextPredicate||s.contextPredicate())&&e.push(M.items[i])}return e.push(b("button",{type:"button",textContent:"Close",onclick:u(()=>{this.close()},"onclick")})),e}createImgSettings(){if(T.clipspace?.imgs){const e=[],i=T.clipspace.imgs;for(let d=0;d<i.length;d++)e.push(b("option",{value:d},[`${d}`]));const s=b("select",{id:"clipspace_img_selector",onchange:u(d=>{d.target&&T.clipspace&&(T.clipspace.selectedIndex=d.target.selectedIndex,M.invalidatePreview())},"onchange")},e),t=b("tr",{},[b("td",{},[b("font",{color:"white"},["Select Image"])]),b("td",{},[s])]),o=b("select",{id:"clipspace_img_paste_mode",onchange:u(d=>{d.target&&T.clipspace&&(T.clipspace.img_paste_mode=d.target.value)},"onchange")},[b("option",{value:"selected"},"selected"),b("option",{value:"all"},"all")]);o.value=T.clipspace.img_paste_mode;const r=b("tr",{},[b("td",{},[b("font",{color:"white"},["Paste Mode"])]),b("td",{},[o])]),a=b("td",{align:"center",width:"100px",height:"100px",colSpan:"2"},[b("img",{id:"clipspace_preview",ondragstart:u(()=>!1,"ondragstart")},[])]),l=b("tr",{},[a]);return b("table",{},[t,r,l])}else return[]}createImgPreview(){return T.clipspace?.imgs?b("img",{id:"clipspace_preview",ondragstart:u(()=>!1,"ondragstart")}):[]}show(){M.invalidate(),this.element.style.display="block"}}p.registerExtension({name:"Comfy.Clipspace",init(n){n.openClipspace=function(){M.instance||(M.instance=new M,T.clipspace_invalidate_handler=M.invalidate),T.clipspace?M.instance.show():n.ui.dialog.show("Clipspace is Empty!")}}});window.comfyAPI=window.comfyAPI||{};window.comfyAPI.clipspace=window.comfyAPI.clipspace||{};window.comfyAPI.clipspace.ClipspaceDialog=M;const qt={name:"Comfy.ContextMenuFilter",init(){const n=I.ContextMenu;I.ContextMenu=function(e,i){const s=new n(e,i);if(i?.className==="dark"&&e?.length>4){const t=document.createElement("input");t.classList.add("comfy-context-menu-filter"),t.placeholder="Filter list",s.root.prepend(t);const o=Array.from(s.root.querySelectorAll(".litemenu-entry"));let r=[...o],a=r.length;requestAnimationFrame(()=>{const d=R.active_canvas.current_node?.widgets?.filter(h=>ct(h)&&h.options.values?.length===e.length).find(h=>h.options.values?.every((m,y)=>m===e[y]))?.value;let c=d?e.findIndex(h=>h===d):0;c<0&&(c=0);let f=r[c];v();function v(){f?.style.setProperty("background-color",""),f?.style.setProperty("color",""),f=r[c],f?.style.setProperty("background-color","#ccc","important"),f?.style.setProperty("color","#000","important")}u(v,"updateSelected");const g=u(()=>{if(s.root.getBoundingClientRect().top<0){const m=1-s.root.getBoundingClientRect().height/s.root.clientHeight,y=s.root.clientHeight*m/2;s.root.style.top=-y+"px"}},"positionList");t.addEventListener("keydown",h=>{switch(h.key){case"ArrowUp":h.preventDefault(),c===0?c=a-1:c--,v();break;case"ArrowRight":h.preventDefault(),c=a-1,v();break;case"ArrowDown":h.preventDefault(),c===a-1?c=0:c++,v();break;case"ArrowLeft":h.preventDefault(),c=0,v();break;case"Enter":f?.click();break;case"Escape":s.close();break}}),t.addEventListener("input",()=>{const h=t.value.toLocaleLowerCase();if(r=o.filter(m=>{const y=!h||m.textContent?.toLocaleLowerCase().includes(h);return m.style.display=y?"block":"none",y}),c=0,r.includes(f)&&(c=r.findIndex(m=>m===f)),a=r.length,v(),i.event){let m=i.event.clientY-10;const y=document.body.getBoundingClientRect(),w=s.root.getBoundingClientRect();y.height&&m>y.height-w.height-10&&(m=Math.max(0,y.height-w.height-10)),s.root.style.top=m+"px",g()}}),requestAnimationFrame(()=>{t.focus(),g()})})}return s},I.ContextMenu.prototype=n.prototype}};p.registerExtension(qt);function Yt(n=[]){if(!this.outputs[0].links?.length||!this.graph)return;const e=[...this.outputs[0].links.map(s=>this.graph.links[s]),...n];let i=this.widgets?.[0].value;for(const s of e){const t=this.graph?.getNodeById(s.target_id),o=t?.inputs[s.target_slot];if(!o){console.warn("Unable to resolve node or input for link",s);continue}const r=o.widget?.name;if(!r){console.warn("Invalid widget or widget name",o.widget);continue}const a=t.widgets?.find(l=>l.name===r);if(!a){console.warn(`Unable to find widget "${r}" on node [${t.id}]`);continue}a.value=i,a.callback?.(a.value,p.canvas,t,p.canvas.graph_mouse,{})}}u(Yt,"applyToGraph");function Xt(){this.applyToGraph=J(this.applyToGraph,Yt);const n=this.widgets[0],e=jt([]);n.options.values=e;const i=u(()=>{e.splice(0,e.length,...this.widgets.filter(t=>t.name.startsWith("option")&&t.value).map(t=>`${t.value}`)),!p.configuringGraph&&(e.includes(`${n.value}`)||(n.value=e[0]??"",n.callback?.(n.value)))},"updateCombo");n.callback=J(n.callback,()=>this.applyToGraph());function s(t){if(!t.widgets)return;const o=t.widgets.length-1;t.addWidget("string",`option${o}`,"",()=>{});const r=t.widgets.at(-1);if(!r)return;let a="";Object.defineProperty(r,"value",{get(){return a},set(l){if(a=l,i(),!t.widgets)return;const d=t.widgets.at(-1);if(d===this){l&&s(t);return}l||t.widgets.at(-2)!==this||d?.value||(t.widgets.pop(),t.computeSize(t.size),this.callback(l))}})}u(s,"addOption"),s(this)}u(Xt,"onNodeCreated");p.registerExtension({name:"Comfy.CustomCombo",beforeRegisterNodeDef(n,e){e?.name==="CustomCombo"&&(n.prototype.onNodeCreated=J(n.prototype.onNodeCreated,Xt))}});X().registerExtension({name:"Comfy.DynamicPrompts",nodeCreated(n){if(n.widgets){const e=n.widgets.filter(i=>i.dynamicPrompts);for(const i of e)i.serializeValue=(s,t)=>{if(typeof i.value!="string")return i.value;const o=ut(i.value);return s?.widgets_values&&(s.widgets_values[t]=o),o}}}});p.registerExtension({name:"Comfy.EditAttention",init(){const n=p.ui.settings.addSetting({id:"Comfy.EditAttention.Delta",category:["Comfy","EditTokenWeight","Delta"],name:"Ctrl+up/down precision",type:"slider",attrs:{min:.01,max:.5,step:.01},defaultValue:.05});function e(o,r){const a=parseFloat(o);if(isNaN(a))return o;const l=a+r;return String(Number(l.toFixed(10)))}u(e,"incrementWeight");function i(o,r){let a=r,l=r,d=0,c=0;for(;a>=0&&(a--,!(o[a]==="("&&d===c));)o[a]==="("&&d++,o[a]===")"&&c++;if(a<0)return null;for(d=0,c=0;l<o.length&&!(o[l]===")"&&d===c);)o[l]==="("&&d++,o[l]===")"&&c++,l++;return l===o.length?null:{start:a+1,end:l}}u(i,"findNearestEnclosure");function s(o){const r=/^\((.*)\)$/,a=o.match(r),l=/:([+-]?(\d*\.)?\d+([eE][+-]?\d+)?)/,d=o.match(l);return a&&!d?`(${a[1]}:1.0)`:o}u(s,"addWeightToParentheses");function t(o){const r=o.composedPath()[0],a=parseFloat(n.value);if(r.tagName!=="TEXTAREA"||!(o.key==="ArrowUp"||o.key==="ArrowDown")||!o.ctrlKey&&!o.metaKey)return;o.preventDefault();let l=r.selectionStart,d=r.selectionEnd,c=r.value.substring(l,d);if(!c){const g=i(r.value,l);if(g)l=g.start,d=g.end,c=r.value.substring(l,d);else{const h=" .,\\/!?%^*;:{}=-_`~()\r\n	";for(;!h.includes(r.value[l-1])&&l>0;)l--;for(;!h.includes(r.value[d])&&d<r.value.length;)d++;if(c=r.value.substring(l,d),!c)return}}c[c.length-1]===" "&&(c=c.substring(0,c.length-1),d-=1),r.value[l-1]==="("&&r.value[d]===")"&&(l-=1,d+=1,c=r.value.substring(l,d)),(c[0]!=="("||c[c.length-1]!==")")&&(c=`(${c})`),c=s(c);const f=o.key==="ArrowUp"?a:-a,v=c.replace(/\((.*):([+-]?\d+(?:\.\d+)?)\)/,(g,h,m)=>(m=e(m,f),m==1?h:`(${h}:${m})`));r.setSelectionRange(l,d),document.execCommand("insertText",!1,v),r.setSelectionRange(l,l+v.length)}u(t,"editAttention"),window.addEventListener("keydown",t)}});const Kt={validationPathSuffix:"/20250115/cpython-3.10.16+20250115-aarch64-apple-darwin-debug-full.tar.zst.sha256"},me=u(async n=>pt(n)&&await Qe().NetWork.canAccessUrl(n),"checkMirrorReachable");(async()=>{if(!gt())return;const n=Qe(),e=await n.getElectronVersion(),i=ft(),s=S(),{staticUrls:t,buildDocsUrl:o}=ht(),r=u((a,l)=>{l!==void 0&&a!==l&&n.restartApp("Restart ComfyUI to apply changes.",1500)},"onChangeRestartApp");p.registerExtension({name:"Comfy.ElectronAdapter",settings:[{id:"Comfy-Desktop.AutoUpdate",category:["Comfy-Desktop","General","AutoUpdate"],name:"Automatically check for updates",type:"boolean",defaultValue:!0,onChange:r},{id:"Comfy-Desktop.SendStatistics",category:["Comfy-Desktop","General","Send Statistics"],name:"Send anonymous usage metrics",type:"boolean",defaultValue:!0,onChange:r},{id:"Comfy-Desktop.WindowStyle",category:["Comfy-Desktop","General","Window Style"],name:"Window Style",tooltip:"Custom: Replace the system title bar with ComfyUI's Top menu",type:"combo",experimental:!0,defaultValue:"default",options:["default","custom"],onChange:u((a,l)=>{l&&n.Config.setWindowStyle(a)},"onChange")},{id:"Comfy-Desktop.UV.PythonInstallMirror",name:"Python Install Mirror",tooltip:"Managed Python installations are downloaded from the Astral python-build-standalone project. This variable can be set to a mirror URL to use a different source for Python installations. The provided URL will replace https://github.com/astral-sh/python-build-standalone/releases/download in, e.g., https://github.com/astral-sh/python-build-standalone/releases/download/20240713/cpython-3.12.4%2B20240713-aarch64-apple-darwin-install_only.tar.gz. Distributions can be read from a local directory by using the file:// URL scheme.",type:"url",defaultValue:"",attrs:{validateUrlFn(a){return me(a+Kt.validationPathSuffix)}}},{id:"Comfy-Desktop.UV.PypiInstallMirror",name:"Pypi Install Mirror",tooltip:"Default pip install mirror",type:"url",defaultValue:"",attrs:{validateUrlFn:me}},{id:"Comfy-Desktop.UV.TorchInstallMirror",name:"Torch Install Mirror",tooltip:"Pip install mirror for pytorch",type:"url",defaultValue:"",attrs:{validateUrlFn:me}}],commands:[{id:"Comfy-Desktop.Folders.OpenLogsFolder",label:"Open Logs Folder",icon:"pi pi-folder-open",function(){n.openLogsFolder()}},{id:"Comfy-Desktop.Folders.OpenModelsFolder",label:"Open Models Folder",icon:"pi pi-folder-open",function(){n.openModelsFolder()}},{id:"Comfy-Desktop.Folders.OpenOutputsFolder",label:"Open Outputs Folder",icon:"pi pi-folder-open",function(){n.openOutputsFolder()}},{id:"Comfy-Desktop.Folders.OpenInputsFolder",label:"Open Inputs Folder",icon:"pi pi-folder-open",function(){n.openInputsFolder()}},{id:"Comfy-Desktop.Folders.OpenCustomNodesFolder",label:"Open Custom Nodes Folder",icon:"pi pi-folder-open",function(){n.openCustomNodesFolder()}},{id:"Comfy-Desktop.Folders.OpenModelConfig",label:"Open extra_model_paths.yaml",icon:"pi pi-file",function(){n.openModelConfig()}},{id:"Comfy-Desktop.OpenDevTools",label:"Open DevTools",icon:"pi pi-code",function(){n.openDevTools()}},{id:"Comfy-Desktop.OpenUserGuide",label:"Desktop User Guide",icon:"pi pi-book",function(){window.open(o("/installation/desktop",{includeLocale:!0,platform:!0}),"_blank")}},{id:"Comfy-Desktop.CheckForUpdates",label:"Check for Updates",icon:"pi pi-sync",async function(){try{const a=await n.checkForUpdates({disableUpdateReadyAction:!0});if(!a.isUpdateAvailable){s.add({severity:"info",summary:D("desktopUpdate.noUpdateFound"),life:5e3});return}if(await te().confirm({title:D("desktopUpdate.updateFoundTitle",{version:a.version}),message:D("desktopUpdate.updateAvailableMessage"),type:"default"}))try{n.restartAndInstall()}catch(d){We.error("Error installing update:",d),s.add({severity:"error",summary:D("g.error"),detail:D("desktopUpdate.errorInstallingUpdate"),life:1e4})}}catch(a){We.error("Error checking for updates:",a),s.add({severity:"error",summary:D("g.error"),detail:D("desktopUpdate.errorCheckingUpdate"),life:1e4})}}},{id:"Comfy-Desktop.Reinstall",label:"Reinstall",icon:"pi pi-refresh",async function(){await te().confirm({message:D("desktopMenu.confirmReinstall"),title:D("desktopMenu.reinstall"),type:"reinstall"})&&n.reinstall()}},{id:"Comfy-Desktop.Restart",label:"Restart",icon:"pi pi-refresh",function(){n.restartApp()}},{id:"Comfy-Desktop.Quit",label:"Quit",icon:"pi pi-sign-out",async function(){i.modifiedWorkflows.length>0&&!await te().confirm({message:D("desktopMenu.confirmQuit"),title:D("desktopMenu.quit"),type:"default"})||n.quit()}}],menuCommands:[{path:["Help"],commands:["Comfy-Desktop.OpenUserGuide"]},{path:["Help"],commands:["Comfy-Desktop.OpenDevTools"]},{path:["Help","Open Folder"],commands:["Comfy-Desktop.Folders.OpenLogsFolder","Comfy-Desktop.Folders.OpenModelsFolder","Comfy-Desktop.Folders.OpenOutputsFolder","Comfy-Desktop.Folders.OpenInputsFolder","Comfy-Desktop.Folders.OpenCustomNodesFolder","Comfy-Desktop.Folders.OpenModelConfig"]},{path:["Help"],commands:["Comfy-Desktop.CheckForUpdates","Comfy-Desktop.Reinstall"]}],keybindings:[{commandId:"Workspace.CloseWorkflow",combo:{key:"w",ctrl:!0}}],aboutPageBadges:[{label:"ComfyUI_desktop v"+e,url:t.githubElectron,icon:"pi pi-github"}]})})();const Ne=new Image;Ne.src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='9' fill='none' stroke='oklch(83.01%25 0.163 83.16)' stroke-width='2'/%3E%3Cpath fill='none' stroke='oklch(83.01%25 0.163 83.16)' stroke-linecap='round' stroke-width='2' d='M12 7v5l3 2'/%3E%3C/svg%3E";const Jt=u(()=>{function n(o){return o?o<1e3?`${Math.round(o)}ms`:`${(o/1e3).toFixed(2)}s`:"0ms"}u(n,"getExecutionTimeText");function e(o){return(typeof o=="function"?o():o).icon?.image===Ne}u(e,"isExecutionTimeBadge");const i=mt();function s(o){const r=i.completedActivePalette.light_theme,a=n(o);return new yt({text:a,iconOptions:{image:Ne,size:8},fgColor:i.completedActivePalette.colors.litegraph_base.BADGE_FG_COLOR,bgColor:r?wt("#4A90D9",{lightness:.5}):"#4A90D9"})}u(s,"getExecutionTimeBadge");function t(o,r){o.badges||(o.badges=[]);const a=o.badges.findIndex(d=>e(d));if(r==null){a!==-1&&o.badges.splice(a,1);return}const l=s(r);a!==-1?o.badges[a]=l:o.badges.push(l)}return u(t,"updateOrAddExecutionTimeBadge"),{getExecutionTimeBadge:s,getExecutionTimeText:n,isExecutionTimeBadge:e,updateOrAddExecutionTimeBadge:t}},"useExecutionTimeBadge"),Re="__comfy_execution_time__";X().registerExtension({name:"Comfy.ExecutionTime",async nodeCreated(n){n[Re]=0,n.badges||(n.badges=[]);const e=Jt();e.updateOrAddExecutionTimeBadge(n,0);const i=n.onExecuted;n.onExecuted=function(s){if(i?.call(this,s),!s||typeof s!="object")return;const t=s;`${this.id}`,Object.keys(t);let o;typeof t.execution_time=="number"?o=t.execution_time:typeof t.exec_time=="number"?o=t.exec_time:typeof t.time=="number"&&(o=t.time),o&&typeof o=="number"&&o>0&&(this[Re]=o,e.updateOrAddExecutionTimeBadge(this,o),p.canvas?.setDirty(!0,!0))}}});class Qt extends vt{static{u(this,"ExecutableGroupNodeChildDTO")}groupNodeHandler;constructor(e,i,s,t,o){super(e,i,s,t),this.groupNodeHandler=o}resolveInput(e){if(this.id.split(":").length>2)throw new Error("Group nodes inside subgraphs are not supported. Please convert the group node to a subgraph instead.");const i=this.node.getInputNode(e);if(!i)return;const s=this.node.getInputLink(e);if(!s)throw new Error("Failed to get input link");const t=String(i.id);let o=this.nodesByExecutionId?.get(t);if(!o){const r=t.split(":").at(-1);r!==void 0&&(o=this.nodesByExecutionId?.get(r))}if(!o)throw new Error(`Failed to get input node ${t} for group node child ${this.id} with slot ${e}`);return{node:o,origin_id:t,origin_slot:s.origin_slot}}}const ye=Symbol();function it(n,e){if(typeof n=="object"&&typeof e=="object")for(const i in e){const s=e[i];if(typeof s=="object"){let t=n[i];t||(t=n[i]={}),it(t,e[i])}else n[i]=s}return n}u(it,"merge");class st extends bt{static{u(this,"ManageGroupDialog")}tabs;selectedNodeIndex;selectedTab="Inputs";selectedGroup;modifications={};nodeItems;app;groupNodeType;groupNodeDef;groupData;innerNodesList;widgetsPage;inputsPage;outputsPage;draggable;get selectedNodeInnerIndex(){return+this.nodeItems[this.selectedNodeIndex].dataset.nodeindex}constructor(e){super(),this.app=e,this.element=b("dialog.comfy-group-manage",{parent:document.body})}changeTab(e){this.tabs[this.selectedTab].tab.classList.remove("active"),this.tabs[this.selectedTab].page.classList.remove("active"),this.tabs[e].tab.classList.add("active"),this.tabs[e].page.classList.add("active"),this.selectedTab=e}changeNode(e,i){!i&&this.selectedNodeIndex===e||(this.selectedNodeIndex!=null&&this.nodeItems[this.selectedNodeIndex].classList.remove("selected"),this.nodeItems[e].classList.add("selected"),this.selectedNodeIndex=e,!this.buildInputsPage()&&this.selectedTab==="Inputs"&&this.changeTab("Widgets"),!this.buildWidgetsPage()&&this.selectedTab==="Widgets"&&this.changeTab("Outputs"),!this.buildOutputsPage()&&this.selectedTab==="Outputs"&&this.changeTab("Inputs"),this.changeTab(this.selectedTab))}getGroupData(){this.groupNodeType=I.registered_node_types[`${L}${P}`+this.selectedGroup],this.groupNodeDef=this.groupNodeType.nodeData,this.groupData=U.getGroupData(this.groupNodeType)}changeGroup(e,i=!0){this.selectedGroup=e,this.getGroupData();const s=this.groupData.nodeData.nodes;if(this.nodeItems=s.map((o,r)=>b("li.draggable-item",{dataset:{nodeindex:o.index+""},onclick:u(()=>{this.changeNode(r)},"onclick")},[b("span.drag-handle"),b("div",{textContent:o.title??o.type},o.title?b("span",{textContent:o.type}):[])])),this.innerNodesList.replaceChildren(...this.nodeItems),i)this.selectedNodeIndex=null,this.changeNode(0);else{let r=this.draggable.getAllItems().findIndex(a=>a.classList.contains("selected"));r===-1&&(r=this.selectedNodeIndex),this.changeNode(r,!0)}const t=[...s];this.draggable?.dispose(),this.draggable=new Nt(this.innerNodesList,"li"),this.draggable.addEventListener("dragend",({detail:{oldPosition:o,newPosition:r}})=>{if(o!==r){t.splice(r,0,t.splice(o,1)[0]);for(let a=0;a<t.length;a++)this.storeModification({nodeIndex:t[a].index,section:ye,prop:"order",value:a})}})}storeModification(e){const{nodeIndex:i,section:s,prop:t,value:o}=e,r=this.modifications[this.selectedGroup]??={},a=r.nodes??={},l=a[i??this.selectedNodeInnerIndex]??={},d=l[s]??={};if(typeof o=="object"){const c=d[t]??={};Object.assign(c,o)}else d[t]=o}getEditElement(e,i,s,t,o,r=!0){s===t&&(s="");const a=this.modifications[this.selectedGroup]?.nodes?.[this.selectedNodeInnerIndex]?.[e]?.[i];return a&&(a.name!=null&&(s=a.name),a.visible!=null&&(o=a.visible)),b("div",[b("input",{value:s,placeholder:t,type:"text",onchange:u(l=>{this.storeModification({section:e,prop:i,value:{name:l.target.value}})},"onchange")}),b("label",{textContent:"Visible"},[b("input",{type:"checkbox",checked:o,disabled:!r,onchange:u(l=>{this.storeModification({section:e,prop:i,value:{visible:!!l.target.checked}})},"onchange")})])])}buildWidgetsPage(){const e=this.groupData.oldToNewWidgetMap[this.selectedNodeInnerIndex],i=Object.keys(e??{}),t=p.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.widgetsPage.replaceChildren(...i.map(o=>this.getEditElement("input",o,e[o],o,t?.[o]?.visible!==!1))),!!i.length}buildInputsPage(){const e=this.groupData.nodeInputs[this.selectedNodeInnerIndex],i=Object.keys(e??{}),t=p.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.inputsPage.replaceChildren(...i.map(o=>{let r=e[o];if(r)return this.getEditElement("input",o,r,o,t?.[o]?.visible!==!1)}).filter(Boolean)),!!i.length}buildOutputsPage(){const e=this.groupData.nodeData.nodes,i=this.groupData.getNodeDef(e[this.selectedNodeInnerIndex]),s=i?.output??[],t=this.groupData.oldToNewOutputMap[this.selectedNodeInnerIndex],r=p.rootGraph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.output,l=this.groupData.nodeData.nodes[this.selectedNodeInnerIndex].type!=="PrimitiveNode";return this.outputsPage.replaceChildren(...s.map((d,c)=>{const f=t?.[c],v=i.output_name?.[c]??d;let g=r?.[c]?.name;const h=r?.[c]?.visible||f!=null;return(!g||g===v)&&(g=""),this.getEditElement("output",c,g,v,h,l)}).filter(Boolean)),!!s.length}show(e){const i=Object.keys(p.rootGraph.extra?.groupNodes??{}).sort((o,r)=>o.localeCompare(r));this.innerNodesList=b("ul.comfy-group-manage-list-items"),this.widgetsPage=b("section.comfy-group-manage-node-page"),this.inputsPage=b("section.comfy-group-manage-node-page"),this.outputsPage=b("section.comfy-group-manage-node-page");const s=b("div",[this.widgetsPage,this.inputsPage,this.outputsPage]);this.tabs=[["Inputs",this.inputsPage],["Widgets",this.widgetsPage],["Outputs",this.outputsPage]].reduce((o,[r,a])=>(o[r]={tab:b("a",{onclick:u(()=>{this.changeTab(r)},"onclick"),textContent:r}),page:a},o),{});const t=b("div.comfy-group-manage-outer",[b("header",[b("h2","Group Nodes"),b("select",{onchange:u(o=>{this.changeGroup(o.target.value)},"onchange")},i.map(o=>b("option",{textContent:o,selected:`${L}${P}${o}`===e,value:o})))]),b("main",[b("section.comfy-group-manage-list",this.innerNodesList),b("section.comfy-group-manage-node",[b("header",Object.values(this.tabs).map(o=>o.tab)),s])]),b("footer",[b("button.comfy-btn",{onclick:u(()=>{if(p.rootGraph.nodes.find(r=>r.type===`${L}${P}`+this.selectedGroup)){S().addAlert("This group node is in use in the current workflow, please first remove these.");return}confirm(`Are you sure you want to remove the node: "${this.selectedGroup}"`)&&(delete p.rootGraph.extra.groupNodes[this.selectedGroup],I.unregisterNodeType(`${L}${P}`+this.selectedGroup)),this.show()},"onclick")},"Delete Group Node"),b("button.comfy-btn",{onclick:u(async()=>{let o,r=[];const a={};for(const l in this.modifications){const d=p.rootGraph.extra.groupNodes[l];let c=d.config??={},f=this.modifications[l]?.nodes;if(f){const g=Object.keys(f);if(f[g[0]][ye]){const h=[],m={},y={};for(const w of g){const N=f[w][ye].order;h[N]=d.nodes[+w],m[N]=f[w],h[N].index=N}for(const w of d.links)w[0]!=null&&(w[0]=d.nodes[w[0]].index),w[2]!=null&&(w[2]=d.nodes[w[2]].index);if(d.external)for(const w of d.external)w[0]=d.nodes[w[0]];for(const w of g)c[w]&&(y[d.nodes[w].index]=c[w]),delete c[w];d.nodes=h,f=m,d.config=c=y}it(c,f)}a[l]=d,o||(o=p.rootGraph.nodes.reduce((g,h)=>(g[h.type]??=[],g[h.type].push(h),g),{}));const v=o[`${L}${P}`+l];v&&r.push(...v)}await Y.registerFromWorkflow(a,{});for(const l of r)l.recreate();this.modifications={},this.app.canvas.setDirty(!0,!0),this.changeGroup(this.selectedGroup,!1)},"onclick")},"Save"),b("button.comfy-btn",{onclick:u(()=>this.element.close(),"onclick")},"Close")])]);this.element.replaceChildren(t),this.changeGroup(e?i.find(o=>`${L}${P}${o}`===e)??i[0]:i[0]),this.element.showModal(),this.element.addEventListener("close",()=>{this.draggable?.dispose(),this.element.remove()})}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.groupNodeManage=window.comfyAPI.groupNodeManage||{};window.comfyAPI.groupNodeManage.ManageGroupDialog=st;const Zt=new Set(["default","forceInput","defaultInput","control_after_generate","multiline","tooltip","dynamicPrompts"]),Fe=u(n=>{const e=n.min??-1/0,i=n.max??1/0;return{min:e,max:i}},"getRange"),eo=u((n,e)=>{const i=n[0],s=n[1]??{},t=e[1]??{},o=Fe(s),r=Fe(t);if(o.min>r.max||o.max<r.min)return null;const a=s.step??1,l=t.step??1,d={min:Math.max(o.min,r.min),max:Math.min(o.max,r.max),step:Dt(a,l)};return Se([i,{...s,...d}],[i,{...t,...d}])},"mergeNumericInputSpec"),to=u((n,e)=>{const i=n[1]??{},s=e[1]??{},t=Le(n),o=Le(e),r=H.intersection(t,o);return r.length===0?null:Se(["COMBO",{...i,options:r}],["COMBO",{...s,options:r}])},"mergeComboInputSpec"),Se=u((n,e)=>{const i=be(n),s=n[1]??{},t=e[1]??{};return H.union(H.keys(s),H.keys(t)).filter(a=>!Zt.has(a)).every(a=>{const l=s[a],d=t[a];return l===d||H.isNil(l)&&H.isNil(d)})?[i,{...s,...t}]:null},"mergeCommonInputSpec"),oo=u((n,e)=>{const i=be(n),s=be(e);return i!==s?null:Ct(n)||It(n)?eo(n,e):kt(n)?to(n,e):Se(n,e)},"mergeInputSpec"),no=u(n=>n.type==="PrimitiveNode","isPrimitiveNode"),we="Run widget replace on values";class Ce extends de{static{u(this,"PrimitiveNode")}controlValues;lastType;static category;constructor(e){super(e),this.addOutput("connect to widget input","*"),this.serialize_widgets=!0,this.isVirtualNode=!0,(!this.properties||!(we in this.properties))&&this.addProperty(we,!1,"boolean")}applyToGraph(e=[]){if(!this.outputs[0].links?.length||!this.graph)return;const i=[...this.outputs[0].links.map(t=>this.graph.links[t]),...e];let s=this.widgets?.[0].value;s&&this.properties[we]&&(s=Ze(this.graph,s));for(const t of i){const o=this.graph?.getNodeById(t.target_id),r=o?.inputs[t.target_slot];if(!r){console.warn("Unable to resolve node or input for link",t);continue}const a=r.widget?.name;if(!a){console.warn("Invalid widget or widget name",r.widget);continue}const l=o.widgets?.find(d=>d.name===a);if(!l){console.warn(`Unable to find widget "${a}" on node [${o.id}]`);continue}l.value=s,l.callback?.(l.value,p.canvas,o,p.canvas.graph_mouse,{})}}refreshComboInNode(){const e=this.widgets?.[0];e?.type==="combo"&&(e.options.values=this.outputs[0].widget[F]()[0],e.options.values.includes(e.value)||(e.value=e.options.values[0],e.callback(e.value)))}onAfterGraphConfigured(){if(this.outputs[0].links?.length&&!this.widgets?.length){if(this.#e(),this.widgets&&this.widgets_values)for(let e=0;e<this.widgets_values.length;e++){const i=this.widgets[e];i&&(i.value=this.widgets_values[e])}this.#t()}}onConnectionsChange(e,i,s){if(p.configuringGraph)return;const t=this.outputs[0].links;s?t?.length&&!this.widgets?.length&&this.#e():(this.#t(),t?.length||this.onLastDisconnect())}onConnectOutput(e,i,s,t,o){if(!s.widget&&!(s.type in B))return!1;if(this.outputs[e].links?.length){const r=this.#o(s);return r&&this.applyToGraph([{target_id:t.id,target_slot:o}]),r}return!0}#e(e){if(!this.outputs[0].links||!this.graph){this.onLastDisconnect();return}const i=this.outputs[0].links[0],s=this.graph.links[i];if(!s)return;const t=this.graph.getNodeById(s.target_id);if(!t||!t.inputs)return;const o=t.inputs[s.target_slot];if(!o)return;let r;if(o.widget)r=o.widget;else{if(!(o.type in B))return;r={name:o.name,[F]:()=>[o.type,{}]}}const a=r[F]?.();if(!a)return;const{type:l}=so(a);this.outputs[0].type=l,this.outputs[0].name=l,this.outputs[0].widget=r,this.#i(r[oe]??a,t,r.name,e)}#i(e,i,s,t){let o=e[0];o instanceof Array&&(o="COMBO");const[r,a]=this.size;let l;if(xt(o)?l=(B[o](this,"value",e,p)||{}).widget:l=this.addWidget(o,"value",null,()=>{},{}),i?.widgets&&l){const c=i.widgets.find(f=>f.name===s);c&&(l.value=c.value)}if(!e?.[1]?.control_after_generate&&(l.type==="number"||l.type==="combo")){let c=this.widgets_values?.[1];c||(c="fixed"),_t(this,l,c,void 0,e),this.widgets?.[1]&&(l.linkedWidgets=[this.widgets[1]]);let f=this.widgets_values?.[2];f&&this.widgets&&this.widgets.length===3&&(this.widgets[2].value=f)}const d=this.controlValues;if(this.widgets&&this.lastType===this.widgets[0]?.type&&d?.length===this.widgets.length-1)for(let c=0;c<d.length;c++)this.widgets[c+1].value=d[c];if(l.callback=J(l.callback,()=>{this.applyToGraph()}),this.setSize([Math.max(this.size[0],r),Math.max(this.size[1],a)]),!t){const c=this.computeSize();this.size[0]<c[0]&&(this.size[0]=c[0]),this.size[1]<c[1]&&(this.size[1]=c[1]),requestAnimationFrame(()=>{this.onResize?.(this.size)})}}recreateWidget(){const e=this.widgets?.map(i=>i.value);if(this.#n(),this.#e(!0),e?.length&&this.widgets)for(let i=0;i<this.widgets.length;i++)this.widgets[i].value=e[i];return this.widgets?.[0]}#t(){const e=this.outputs[0],i=e.links??[],s=!!e.widget?.[oe];if(s&&delete e.widget?.[oe],i?.length<2&&s){i.length&&this.recreateWidget();return}const t=e.widget?.[F]?.();if(!(!t||!(t[0]==="INT"||t[0]==="FLOAT")||!this.graph))for(const r of i){const a=this.graph.links[r];if(!a)continue;const l=this.graph.getNodeById(a.target_id);if(!l)continue;const d=l.inputs[a.target_slot];this.#o(d,s)}}#o(e,i){const s=this.outputs?.[0],t=e.widget?.[F]?.();return t?!!ae.call(this,s,t,i,this.recreateWidget):!1}#n(){if(this.widgets){for(const e of this.widgets)e.onRemove&&e.onRemove();this.controlValues=[],this.lastType=this.widgets[0]?.type;for(let e=1;e<this.widgets.length;e++)this.controlValues.push(this.widgets[e].value);setTimeout(()=>{delete this.lastType,delete this.controlValues},15),this.widgets.length=0}}onLastDisconnect(){this.outputs[0].type="*",this.outputs[0].name="connect to widget input",delete this.outputs[0].widget,this.#n()}}function Me(n){return n.widget?.[oe]??n.widget?.[F]?.()??["*",{}]}u(Me,"getWidgetConfig");function Ue(n){const{nodeData:e}=this.constructor;return e?.input?.required?.[n]??e?.input?.optional?.[n]}u(Ue,"getConfig");function io(n,e){return console.warn("Please remove call to convertToInput. Widget to socket conversion is no longer necessary, as they co-exist now."),n.inputs.find(i=>i.widget?.name===e.name)}u(io,"convertToInput");function so(n){let e=n[0];return e instanceof Array&&(e="COMBO"),{type:e}}u(so,"getWidgetType");function Ie(n,e){if(!n.widget||(e?n.widget[F]=()=>e:delete n.widget,!(n instanceof Tt)))return;const i=n.node.graph;if(!i)return;const s=i.links[n.link??-1];if(!s)return;const t=i.getNodeById(s.origin_id);!t||!no(t)||(e?t.recreateWidget():p.configuringGraph||(t.disconnectOutput(0),t.onLastDisconnect()))}u(Ie,"setWidgetConfig");function ae(n,e,i,s,t){t||(t=Me(n));const o=oo(t,e);if(o||i){o&&(n.widget[oe]=o);const r=s?.call(this);if(r){const a=r.options.min,l=r.options.max;a!=null&&r.value<a&&(r.value=a),l!=null&&r.value>l&&(r.value=l),r.callback(r.value)}}return{customConfig:o?.[1]??{}}}u(ae,"mergeIfValid");p.registerExtension({name:"Comfy.WidgetInputs",async beforeRegisterNodeDef(n,e,i){n.prototype.convertWidgetToInput=function(){return console.warn("Please remove call to convertWidgetToInput. Widget to socket conversion is no longer necessary, as they co-exist now."),!1},n.prototype.onGraphConfigured=J(n.prototype.onGraphConfigured,function(){if(this.inputs){this.widgets??=[];for(const t of this.inputs)if(t.widget){const o=t.widget.name;t.widget[F]||(t.widget[F]=()=>Ue.call(this,o)),this.widgets?.find(a=>a.name===o)||this.removeInput(this.inputs.findIndex(a=>a===t))}}}),n.prototype.onConfigure=J(n.prototype.onConfigure,function(){if(!i.configuringGraph&&this.inputs){for(const t of this.inputs)if(t.widget&&!t.widget[F]){const o=t.widget.name;t.widget[F]=()=>Ue.call(this,o)}}});const s=n.prototype.onInputDblClick;n.prototype.onInputDblClick=function(...[t,...o]){const r=s?.apply(this,[t,...o]),a=this.inputs[t];if(!a.widget&&!(a.type in B)&&!(a.widget?.[F]?.()?.[0]instanceof Array))return r;const l=I.createNode("PrimitiveNode"),d=i.canvas.graph;if(!l||!d)return r;d?.add(l);const c=[this.pos[0]-l.size[0]-30,this.pos[1]];for(;d.getNodeOnPos(c[0],c[1],d.nodes);)c[1]+=I.NODE_TITLE_HEIGHT;return l.pos=c,l.connect(0,this,t),l.title=a.name,r}},registerCustomNodes(){I.registerNodeType("PrimitiveNode",Object.assign(Ce,{title:"Primitive"})),Ce.category="utils"}});window.comfyAPI=window.comfyAPI||{};window.comfyAPI.widgetInputs=window.comfyAPI.widgetInputs||{};window.comfyAPI.widgetInputs.PrimitiveNode=Ce;window.comfyAPI.widgetInputs.getWidgetConfig=Me;window.comfyAPI.widgetInputs.convertToInput=io;window.comfyAPI.widgetInputs.setWidgetConfig=Ie;window.comfyAPI.widgetInputs.mergeIfValid=ae;const q={InUse:{Free:0,Registered:1,InWorkflow:2},isInUseGroupNode(n){const e=`${L}${P}${n}`;return p.rootGraph.extra?.groupNodes?.[n]?p.rootGraph.nodes.find(i=>i.type===e)?q.InUse.InWorkflow:q.InUse.Registered:q.InUse.Free},storeGroupNode(n,e){let i=p.rootGraph.extra;i||(p.rootGraph.extra=i={});let s=i.groupNodes;s||(i.groupNodes=s={}),s[n]=e}};class Be{static{u(this,"GroupNodeBuilder")}nodes;nodeData;constructor(e){this.nodes=e}async build(){const e=await this.getName();if(e)return this.sortNodes(),this.nodeData=this.getNodeData(),q.storeGroupNode(e,this.nodeData),{name:e,nodeData:this.nodeData}}async getName(){const e=await te().prompt({title:D("groupNode.create"),message:D("groupNode.enterName"),defaultValue:""});if(!e)return;switch(q.isInUseGroupNode(e)){case q.InUse.InWorkflow:S().addAlert("An in use group node with this name already exists embedded in this workflow, please remove any instances or use a new name.");return;case q.InUse.Registered:if(!confirm("A group node with this name already exists embedded in this workflow, are you sure you want to overwrite it?"))return;break}return e}sortNodes(){const e=p.rootGraph.computeExecutionOrder(!1);this.nodes=this.nodes.map(i=>({index:e.indexOf(i),node:i})).sort((i,s)=>i.index-s.index||i.node.id-s.node.id).map(({node:i})=>i)}getNodeData(){const e=u(s=>{for(const t of s.links){const r=p.rootGraph.getNodeById(t[4]).outputs[t[1]].type;t.push(r)}},"storeLinkTypes"),i=u(s=>{s.external=[];for(let t=0;t<this.nodes.length;t++){const o=this.nodes[t];if(o.outputs?.length)for(let r=0;r<o.outputs.length;r++){let a=!1;const l=o.outputs[r];let d=l.type;if(l.links?.length){for(const c of l.links){const f=p.rootGraph.links[c];if(f&&(d==="*"&&(d=f.type),!p.canvas.selected_nodes[f.target_id])){a=!0;break}}a&&s.external.push([t,r,d])}}}},"storeExternalLinks");{const s=Ot(this.nodes,p.canvas?.graph),t=JSON.parse(s);return e(t),i(t),t}}}class Y{static{u(this,"GroupNodeConfig")}name;nodeData;inputCount;oldToNewOutputMap;newToOldOutputMap;oldToNewInputMap;oldToNewWidgetMap;newToOldWidgetMap;primitiveDefs;widgetToPrimitive;primitiveToWidget;nodeInputs;outputVisibility;nodeDef;inputs;linksFrom;linksTo;externalFrom;constructor(e,i){this.name=e,this.nodeData=i,this.getLinks(),this.inputCount=0,this.oldToNewOutputMap={},this.newToOldOutputMap={},this.oldToNewInputMap={},this.oldToNewWidgetMap={},this.newToOldWidgetMap={},this.primitiveDefs={},this.widgetToPrimitive={},this.primitiveToWidget={},this.nodeInputs={},this.outputVisibility=[]}async registerType(e=L){this.nodeDef={output:[],output_name:[],output_is_list:[],output_node:!1,name:e+P+this.name,display_name:this.name,category:"group nodes"+(P+e),input:{required:{}},description:`Group node combining ${this.nodeData.nodes.map(t=>t.type).join(", ")}`,python_module:"custom_nodes."+this.name,[W]:this},this.inputs=[];const i={},s={};for(let t=0;t<this.nodeData.nodes.length;t++){const o=this.nodeData.nodes[t];o.index=t,this.processNode(o,i,s)}for(const t of this.#e)t();this.#e=null,this.nodeDef&&(await p.registerNodeDef(`${L}${P}`+this.name,this.nodeDef),Mt().addNodeDef(this.nodeDef))}getLinks(){this.linksFrom={},this.linksTo={},this.externalFrom={};for(const e of this.nodeData.links){const[i,s,t,o]=e;i!=null&&(this.linksFrom[i]||(this.linksFrom[i]={}),this.linksFrom[i][s]||(this.linksFrom[i][s]=[]),this.linksFrom[i][s].push(e),this.linksTo[t]||(this.linksTo[t]={}),this.linksTo[t][o]=e)}if(this.nodeData.external)for(const e of this.nodeData.external)this.externalFrom[e[0]]?this.externalFrom[e[0]][e[1]]=e[2]:this.externalFrom[e[0]]={[e[1]]:e[2]}}processNode(e,i,s){const t=this.getNodeDef(e);if(!t)return;const o={...t.input?.required,...t.input?.optional};this.inputs.push(this.processNodeInputs(e,i,o)),t.output?.length&&this.processNodeOutputs(e,s,t)}getNodeDef(e){const i=ne[e.type];if(i)return i;const s=this.linksFrom[e.index];if(e.type==="PrimitiveNode"){if(!s)return;let t=s[0][0][5];if(t==="COMBO"){const r=e.outputs[0].widget.name,a=this.nodeData.nodes[s[0][0][2]].type,l=ne[a];t=(l.input.required[r]??l.input.optional[r])[0]}return this.primitiveDefs[e.index]={input:{required:{value:[t,{}]}},output:[t],output_name:[],output_is_list:[]}}else if(e.type==="Reroute"){const t=this.linksTo[e.index];if(t&&s&&!this.externalFrom[e.index]?.[0])return null;let o={},r="*";if(s)for(const[,,a,l]of s[0]){const d=this.nodeData.nodes[a],c=d.inputs[l];if(r==="*"&&(r=c.type),c.widget){const f=ne[d.type],v=f.input.required[c.widget.name]??f.input.optional[c.widget.name],g=[v[0],o];o=ae({widget:g},v,!1,null,g)?.customConfig??o}}else if(t){const[a,l]=t[0];r=this.nodeData.nodes[a].outputs[l].type}else{for(const a of this.nodeData.links)if(a[2]===e.index){r=a[5];break}if(r==="*"){const a=this.externalFrom[e.index]?.[0];a&&(r=a)}}return o.forceInput=!0,{input:{required:{[r]:[r,o]}},output:[r],output_name:[],output_is_list:[]}}console.warn("Skipping virtual node "+e.type+" when building group node "+this.name)}getInputConfig(e,i,s,t,o){const r=this.nodeData.config?.[e.index]?.input?.[i];let a=r?.name??e.inputs?.find(c=>c.name===i)?.label??i,l=a,d="";return(e.type==="PrimitiveNode"&&e.title||a in s)&&(d=`${e.title??e.type} `,l=a=`${d}${i}`,a in s&&(a=`${d}${s[a]} ${i}`)),s[l]=(s[l]??1)+1,(i==="seed"||i==="noise_seed")&&(o||(o={}),o.control_after_generate=`${d}control_after_generate`),t[0]==="IMAGEUPLOAD"&&(o||(o={}),o.widget=this.oldToNewWidgetMap[e.index]?.[t[1]?.widget??"image"]??"image"),o&&(t=[t[0],{...t[1],...o}]),{name:a,config:t,customConfig:r}}processWidgetInputs(e,i,s,t){const o=[],r=new Map,a=this.oldToNewWidgetMap[i.index]={};for(const l of s)if(Et().inputIsWidget(e[l])){const d=i.inputs?.findIndex(c=>c.name===l&&c.widget?.name===l);if(d>-1)r.set(d,l),a[l]=null;else{const{name:c,config:f}=this.getInputConfig(i,l,t,e[l]);this.nodeDef.input.required[c]=f,a[l]=c,this.newToOldWidgetMap[c]={node:i,inputName:l}}}else o.push(l);return{converted:r,slots:o}}checkPrimitiveConnection(e,i,s){if(this.nodeData.nodes[e[0]].type==="PrimitiveNode"){const[o,r,a,l]=e,d=this.primitiveDefs[o],c=s[i],f=d.input.required.value,g=ae({widget:f},c,!1,null,f);f[1]=g?.customConfig??s[i][1]?{...s[i][1]}:{};let h=this.oldToNewWidgetMap[o].value;h=h.substr(0,h.length-6),f[1].control_after_generate=!0,f[1].control_prefix=h;let m=this.widgetToPrimitive[a];m||(m=this.widgetToPrimitive[a]={}),m[i]&&m[i].push(o),m[i]=o;let y=this.primitiveToWidget[o];y||(y=this.primitiveToWidget[o]=[]),y.push({nodeId:a,inputName:i})}}processInputSlots(e,i,s,t,o,r){this.nodeInputs[i.index]={};for(let a=0;a<s.length;a++){const l=s[a];if(t[a]){this.checkPrimitiveConnection(t[a],l,e);continue}const{name:d,config:c,customConfig:f}=this.getInputConfig(i,l,r,e[l]);this.nodeInputs[i.index][l]=d,f?.visible!==!1&&(this.nodeDef.input.required[d]=c,o[a]=this.inputCount++)}}processConvertedWidgets(e,i,s,t,o,r,a){const l=[...t.keys()].sort().map(d=>t.get(d));for(let d=0;d<l.length;d++){const c=l[d];if(o[s.length+d]){this.checkPrimitiveConnection(o[s.length+d],c,e);continue}const{name:f,config:v}=this.getInputConfig(i,c,a,e[c],{defaultInput:!0});this.nodeDef.input.required[f]=v,this.newToOldWidgetMap[f]={node:i,inputName:c},this.oldToNewWidgetMap[i.index]||(this.oldToNewWidgetMap[i.index]={}),this.oldToNewWidgetMap[i.index][c]=f,r[s.length+d]=this.inputCount++}}#e=[];processNodeInputs(e,i,s){const t=[],o=Object.keys(s);if(!o.length)return;const{converted:r,slots:a}=this.processWidgetInputs(s,e,o,i),l=this.linksTo[e.index]??{},d=this.oldToNewInputMap[e.index]={};return this.processInputSlots(s,e,a,l,d,i),this.#e.push(()=>this.processConvertedWidgets(s,e,a,r,l,d,i)),t}processNodeOutputs(e,i,s){const t=this.oldToNewOutputMap[e.index]={};for(let o=0;o<s.output.length;o++){const a=this.linksFrom[e.index]?.[o]&&!this.externalFrom[e.index]?.[o],l=this.nodeData.config?.[e.index]?.output?.[o],d=l?.visible??!a;if(this.outputVisibility.push(d),!d)continue;t[o]=this.nodeDef.output.length,this.newToOldOutputMap[this.nodeDef.output.length]={node:e,slot:o},this.nodeDef.output.push(s.output[o]),this.nodeDef.output_is_list.push(s.output_is_list[o]);let c=l?.name;if(!c){c=s.output_name?.[o]??s.output[o];const v=e.outputs.find(g=>g.name===c);v?.label&&(c=v.label)}let f=c;if(f in i){const v=`${e.title??e.type} `;f=`${v}${c}`,f in i&&(f=`${v}${e.index} ${c}`)}i[f]=1,this.nodeDef.output_name.push(f)}}static async registerFromWorkflow(e,i){for(const s in e){const t=e[s];let o=!1;for(const a of t.nodes)a.type in I.registered_node_types||(i.push({type:a.type,hint:` (In group node '${L}${P}${s}')`}),i.push({type:`${L}${P}`+s,action:{text:"Remove from workflow",callback:u(l=>{delete e[s],l.target.textContent="Removed",l.target.style.pointerEvents="none",l.target.style.opacity=.7},"callback")}}),o=!0);if(o)continue;await new Y(s,t).registerType()}}}class U{static{u(this,"GroupNodeHandler")}node;groupData;innerNodes;constructor(e){this.node=e,this.groupData=e.constructor?.nodeData?.[W],this.node.setInnerNodes=g=>{this.innerNodes=g;for(let h=0;h<this.innerNodes.length;h++){const m=this.innerNodes[h];m.graph??=this.node.graph;for(const y of m.widgets??[])y.type==="converted-widget"&&(y.serializeValue=y.origSerializeValue);m.index=h,m.getInputNode=y=>{const w=this.groupData.oldToNewInputMap[m.index]?.[y];if(w!=null)return this.node.getInputNode(w);const N=this.groupData.linksTo[m.index]?.[y];if(!N)return null;const C=g[N[0]];return C.type==="PrimitiveNode"?null:C},m.getInputLink=y=>{const w=this.groupData.oldToNewInputMap[m.index]?.[y];if(w!=null){const C=this.node.inputs[w].link;let k=p.rootGraph.links[C];return k={...k,target_id:m.id,target_slot:+y},k}let N=this.groupData.linksTo[m.index]?.[y];return N?(N={origin_id:g[N[0]].id,origin_slot:N[1],target_id:m.id,target_slot:+y},N):null}}},this.node.updateLink=g=>{g={...g};const h=this.groupData.newToOldOutputMap[g.origin_slot];let m=this.innerNodes[h.node.index],y;for(;m?.type==="Reroute";)y=m.getInputLink(0),m=m.getInputNode(0);return m?y&&U.isGroupNode(m)?m.updateLink(y):(g.origin_id=m.id,g.origin_slot=y?.origin_slot??h.slot,g):null},this.node.getInnerNodes=(g,h=[],m=[],y=new Set)=>{if(y.has(this.node))throw new Error("RecursionError: while flattening subgraph");y.add(this.node),this.innerNodes||this.node.setInnerNodes(this.groupData.nodeData.nodes.map((C,k)=>{const x=I.createNode(C.type);return x.configure(C),x.id=`${this.node.id}:${k}`,x.graph=this.node.graph,x})),this.updateInnerWidgets();const w=[...h,this.node.id],N=this.node.graph?.getNodeById(h.at(-1))??void 0;for(const C of this.innerNodes){C.graph??=this.node.graph;const k=String(C.id);C.id=k.split(":").at(-1);const x=new Qt(C,w,g,N);C.id=k,x.groupNodeHandler=this,m.push(x)}return m},this.node.recreate=async()=>{const g=this.node.id,h=this.node.size,m=this.node.convertToNodes(),y=I.createNode(this.node.type);y.id=g,y.setInnerNodes(m),y[W].populateWidgets(),p.rootGraph.add(y),y.setSize([Math.max(y.size[0],h[0]),Math.max(y.size[1],h[1])]);const N=new Be(m).getNodeData();return y[W].groupData.nodeData.links=N.links,y[W].replaceNodes(m),y},this.node.convertToNodes=()=>{const g=u(()=>{const y={...this.groupData.nodeData};y.nodes=[...y.nodes];const w=this.node.getInnerNodes();let N=[];for(let A=0;A<y.nodes.length;A++){let K=w?.[A]?.id;K==null||isNaN(K)?K=void 0:N.push(K),y.nodes[A]={...y.nodes[A],id:K}}et(JSON.stringify(y),p.canvas);const[C,k]=this.node.pos;let x,_;const O=N.length?N:Object.keys(p.canvas.selected_nodes),j=[];for(let A=0;A<O.length;A++){const K=O[A],z=p.rootGraph.getNodeById(K),Oe=w[A];if(j.push(z),(_==null||z.pos[0]<_)&&(_=z.pos[0]),(x==null||z.pos[1]<x)&&(x=z.pos[1]),!z.widgets)continue;const ge=this.groupData.oldToNewWidgetMap[Oe.index];if(ge){const lt=Object.keys(ge);for(const Ae of lt){const Pe=ge[Ae];if(!Pe)continue;const fe=this.node.widgets.findIndex(V=>V.name===Pe);if(fe!==-1)if(Oe.type==="PrimitiveNode")for(let V=0;V<z.widgets.length;V++)z.widgets[V].value=this.node.widgets[fe+V].value;else{const V=this.node.widgets[fe],he=z.widgets.find(Q=>Q.name===Ae);if(!he)continue;he.value=V.value;for(let Q=0;Q<V.linkedWidgets?.length;Q++)he.linkedWidgets[Q].value=V.linkedWidgets[Q].value}}}}for(const A of j)A.pos[0]-=_-C,A.pos[1]-=x-k;return{newNodes:j,selectedIds:O}},"addInnerNodes"),h=u(y=>{for(const w in this.groupData.oldToNewInputMap){const N=y[w],C=p.rootGraph.getNodeById(N),k=this.groupData.oldToNewInputMap[w];for(const x in k){const _=k[x];if(_==null)continue;const O=e.inputs[_];if(O.link==null)continue;const j=p.rootGraph.links[O.link];if(!j)continue;p.rootGraph.getNodeById(j.origin_id).connect(j.origin_slot,C,+x)}}},"reconnectInputs"),m=u(y=>{for(let w=0;w<e.outputs?.length;w++){const N=e.outputs[w];if(!N.links)continue;const C=[...N.links];for(const k of C){const x=this.groupData.newToOldOutputMap[w],_=p.rootGraph.links[k],O=p.rootGraph.getNodeById(_.target_id);p.rootGraph.getNodeById(y[x.node.index]).connect(x.slot,O,_.target_slot)}}},"reconnectOutputs");p.canvas.emitBeforeChange();try{const{newNodes:y,selectedIds:w}=g();return h(w),m(w),p.rootGraph.remove(this.node),y}finally{p.canvas.emitAfterChange()}};const i=this.node.getExtraMenuOptions;this.node.getExtraMenuOptions=function(g,h){i?.apply(this,arguments);let m=h.findIndex(y=>y?.content==="Outputs");m===-1?m=h.length:m++,h.splice(m,0,null,{content:"Convert to nodes",callback:u(()=>this.convertToNodes(),"callback")},{content:"Manage Group Node",callback:u(()=>ke(this.type),"callback")})};const s=this.node.onDrawTitleBox;this.node.onDrawTitleBox=function(g,h){s?.apply(this,arguments);const m=g.fillStyle;g.beginPath(),g.rect(11,-h+11,2,2),g.rect(14,-h+11,2,2),g.rect(17,-h+11,2,2),g.rect(11,-h+14,2,2),g.rect(14,-h+14,2,2),g.rect(17,-h+14,2,2),g.rect(11,-h+17,2,2),g.rect(14,-h+17,2,2),g.rect(17,-h+17,2,2),g.fillStyle=this.boxcolor||I.NODE_DEFAULT_BOXCOLOR,g.fill(),g.fillStyle=m};const t=e.onDrawForeground,o=this.groupData.nodeData;e.onDrawForeground=function(g){t?.apply?.(this,arguments);const h=St().nodeProgressStates[this.id];if(h&&h.state==="running"&&this.runningInternalNodeId!==null){const m=o.nodes[this.runningInternalNodeId];if(!m)return;const y=`Running ${m.title||m.type} (${this.runningInternalNodeId}/${o.nodes.length})`;g.save(),g.font="12px sans-serif";const w=g.measureText(y);g.fillStyle=e.boxcolor||I.NODE_DEFAULT_BOXCOLOR,g.beginPath(),g.roundRect(0,-I.NODE_TITLE_HEIGHT-20,w.width+12,20,5),g.fill(),g.fillStyle="#fff",g.fillText(y,6,-I.NODE_TITLE_HEIGHT-6),g.restore()}};const r=this.node.onExecutionStart;this.node.onExecutionStart=function(){return this.resetExecution=!0,r?.apply(this,arguments)};const a=this,l=this.node.onNodeCreated;this.node.onNodeCreated=function(){if(!this.widgets)return;const g=a.groupData.nodeData.config;if(g)for(const h in g){const m=g[h]?.input;for(const y in m){if(m[y].visible!==!1)continue;const w=a.groupData.oldToNewWidgetMap[h][y],N=this.widgets.find(C=>C.name===w);N&&(N.type="hidden",N.computeSize=()=>[0,-4])}}return l?.apply(this,arguments)};function d(g,h,m){const y=u(({detail:w})=>{const N=h(w);if(!N||p.rootGraph.getNodeById(N))return;const k=this.innerNodes?.findIndex(x=>x.id==N);k>-1&&(this.node.runningInternalNodeId=k,E.dispatchCustomEvent(g,m(w,`${this.node.id}`,this.node)))},"handler");return E.addEventListener(g,y),y}u(d,"handleEvent");const c=d.call(this,"executing",g=>g,(g,h)=>h),f=d.call(this,"executed",g=>g?.display_node||g?.node,(g,h,m)=>({...g,node:h,display_node:h,merge:!m.resetExecution})),v=e.onRemoved;this.node.onRemoved=function(){v?.apply(this,arguments),E.removeEventListener("executing",c),E.removeEventListener("executed",f)},this.node.refreshComboInNode=g=>{for(const h in this.groupData.newToOldWidgetMap){const m=this.node.widgets.find(y=>y.name===h);if(m?.type==="combo"){const y=this.groupData.newToOldWidgetMap[h],w=g[y.node.type],N=w?.input?.required?.[y.inputName]??w?.input?.optional?.[y.inputName];if(!N)continue;m.options.values=N[0],y.inputName!=="image"&&!m.options.values.includes(m.value)&&(m.value=m.options.values[0],m.callback(m.value))}}}}updateInnerWidgets(){for(const e in this.groupData.newToOldWidgetMap){const i=this.node.widgets.find(a=>a.name===e);if(!i)continue;const s=i.value,t=this.groupData.newToOldWidgetMap[e];let o=this.innerNodes[t.node.index];if(o.type==="PrimitiveNode"){o.primitiveValue=s;const a=this.groupData.primitiveToWidget[t.node.index];for(const l of a??[]){const c=this.innerNodes[l.nodeId].widgets.find(f=>f.name===l.inputName);c&&(c.value=s)}continue}else if(o.type==="Reroute"){const a=this.groupData.linksFrom[t.node.index];if(a)for(const[l,,d,c]of a[0]){const f=this.innerNodes[d],v=f.inputs[c];if(v.widget){const g=f.widgets?.find(h=>h.name===v.widget.name);g&&(g.value=s)}}}const r=o.widgets?.find(a=>a.name===t.inputName);r&&(r.value=s)}}populatePrimitive(e,i,s){const t=this.groupData.widgetToPrimitive[i]?.[s];if(t==null)return;const o=this.groupData.oldToNewWidgetMap[t].value,r=this.node.widgets.findIndex(a=>a.name===o);if(r>-1){const a=this.innerNodes[t];let l=a.widgets.length;l-1!==this.node.widgets[r].linkedWidgets?.length&&(l=1);for(let d=0;d<l;d++)this.node.widgets[r+d].value=a.widgets[d].value}return!0}populateReroute(e,i,s){if(e.type!=="Reroute")return;const t=this.groupData.linksFrom[i]?.[0]?.[0];if(!t)return;const[,,o,r]=t,a=this.groupData.nodeData.nodes[o],l=a.inputs;if(!l?.[r]?.widget)return;const c=l.length-(a.widgets_values?.length??0),f=a.widgets_values?.[r-c];if(f==null)return;const v=Object.values(s)[0],g=this.node.widgets.find(h=>h.name===v);g&&(g.value=f)}populateWidgets(){if(this.node.widgets)for(let e=0;e<this.groupData.nodeData.nodes.length;e++){const i=this.groupData.nodeData.nodes[e],s=this.groupData.oldToNewWidgetMap[e]??{},t=Object.keys(s);if(!i.widgets_values?.length){this.populateReroute(i,e,s);continue}let o=0;for(let r=0;r<t.length;r++){const a=t[r],l=s[a],d=this.node.widgets.findIndex(f=>f.name===l),c=this.node.widgets[d];if(this.populatePrimitive(i,e,a)||d===-1){const f=this.innerNodes[e].widgets?.find(v=>v.name===a);o+=f?.linkedWidgets?.length??0}if(d!==-1){c.value=i.widgets_values[r+o];for(let f=0;f<c.linkedWidgets?.length;f++)this.node.widgets[d+f+1].value=i.widgets_values[r+ ++o]}}}}replaceNodes(e){let i,s;for(let t=0;t<e.length;t++){const o=e[t];(s==null||o.pos[0]<s)&&(s=o.pos[0]),(i==null||o.pos[1]<i)&&(i=o.pos[1]),this.linkOutputs(o,t),p.rootGraph.remove(o),o.id=`${this.node.id}:${t}`}this.linkInputs(),this.node.pos=[s,i]}linkOutputs(e,i){if(e.outputs)for(const s of e.outputs){if(!s.links)continue;const t=[...s.links];for(const o of t){const r=p.rootGraph.links[o];if(!r)continue;const a=p.rootGraph.getNodeById(r.target_id),l=this.groupData.oldToNewOutputMap[i]?.[r.origin_slot];l!=null&&this.node.connect(l,a,r.target_slot)}}}linkInputs(){for(const e of this.groupData.nodeData.links??[]){const[,i,s,t,o]=e,r=p.rootGraph.getNodeById(o);r&&r.connect(i,this.node.id,this.groupData.oldToNewInputMap[s][t])}}static getGroupData(e){return(e.nodeData??e.constructor?.nodeData)?.[W]}static isGroupNode(e){return!!e.constructor?.nodeData?.[W]}static async fromNodes(e){const i=new Be(e),s=await i.build();if(!s)return;const{name:t,nodeData:o}=s;await new Y(t,o).registerType();const a=I.createNode(`${L}${P}${t}`);return a.setInnerNodes(i.nodes),a[W].populateWidgets(),p.rootGraph.add(a),a[W].replaceNodes(i.nodes),a}}const ro=u(n=>{for(const e of n)typeof e.type=="string"&&e.type.startsWith("workflow/")&&(e.type=e.type.replace(/^workflow\//,`${L}${P}`))},"replaceLegacySeparators");async function ve(){const n=Object.values(p.canvas.selected_nodes??{});if(n.length===0)throw new Error("No nodes selected");if(n.length===1)throw new Error("Please select multiple nodes to convert to group node");for(const e of n){if(e instanceof At)throw new Error("Selected nodes contain a subgraph node");if(U.isGroupNode(e))throw new Error("Selected nodes contain a group node")}return await U.fromNodes(n)}u(ve,"convertSelectedNodesToGroupNode");const Ve=u(n=>n.length<2||!!n.find(e=>U.isGroupNode(e)),"convertDisabled");function ao(){const n=Object.values(p.canvas.selected_nodes??{});for(const e of n)U.isGroupNode(e)&&e.convertToNodes?.()}u(ao,"ungroupSelectedGroupNodes");function ke(n){new st(p).show(n)}u(ke,"manageGroupNodes");const lo="Comfy.GroupNode";let ne;const co={name:lo,commands:[{id:"Comfy.GroupNode.ConvertSelectedNodesToGroupNode",label:"Convert selected nodes to group node",icon:"pi pi-sitemap",versionAdded:"1.3.17",function:u(()=>ve(),"function")},{id:"Comfy.GroupNode.UngroupSelectedGroupNodes",label:"Ungroup selected group nodes",icon:"pi pi-sitemap",versionAdded:"1.3.17",function:u(()=>ao(),"function")},{id:"Comfy.GroupNode.ManageGroupNodes",label:"Manage group nodes",icon:"pi pi-cog",versionAdded:"1.3.17",function:u((...n)=>ke(n[0]),"function")}],keybindings:[{commandId:"Comfy.GroupNode.ConvertSelectedNodesToGroupNode",combo:{alt:!0,key:"g"}},{commandId:"Comfy.GroupNode.UngroupSelectedGroupNodes",combo:{alt:!0,shift:!0,key:"G"}}],getCanvasMenuItems(n){const e=[],i=Object.values(n.selected_nodes??{}),s=!Ve(i);e.push({content:"Convert to Group Node (Deprecated)",disabled:!s,callback:u(()=>ve(),"callback")});const t=n.graph?.extra?.groupNodes,o=!t||!Object.keys(t).length;return e.push({content:"Manage Group Nodes",disabled:o,callback:u(()=>ke(),"callback")}),e},getNodeMenuItems(n){if(U.isGroupNode(n))return[];const e=Object.values(p.canvas.selected_nodes??{});return[{content:"Convert to Group Node (Deprecated)",disabled:!!Ve(e),callback:u(()=>ve(),"callback")}]},async beforeConfigureGraph(n,e){const i=n?.extra?.groupNodes;i&&(ro(n.nodes),await Y.registerFromWorkflow(i,e))},addCustomNodeDefs(n){ne=n},nodeCreated(n){U.isGroupNode(n)&&(n[W]=new U(n),n.title&&n[W]?.groupData?.nodeData&&q.storeGroupNode(n.title,n[W].groupData.nodeData))},async refreshComboInNodes(n){Object.assign(ne,n);const e=p.rootGraph.extra?.groupNodes;e&&await Y.registerFromWorkflow(e,{})}};p.registerExtension(co);window.comfyAPI=window.comfyAPI||{};window.comfyAPI.groupNode=window.comfyAPI.groupNode||{};window.comfyAPI.groupNode.GroupNodeConfig=Y;window.comfyAPI.groupNode.GroupNodeHandler=U;function G(n,e){n.mode=e,n.graph?.change()}u(G,"setNodeMode");function $e(n,e){const i=ee().get("Comfy.GroupSelectedNodes.Padding");n.resizeTo([...n.children,...e],i)}u($e,"addNodesToGroup");const uo={name:"Comfy.GroupOptions",getCanvasMenuItems(n){const e=[],i=n.graph.getGroupOnPos(n.graph_mouse[0],n.graph_mouse[1]);if(!i)return n.selectedItems.size>0&&e.push({content:"Add Group For Selected Nodes",callback:u(()=>{const o=new Pt;$e(o,n.selectedItems),n.graph.add(o),n.graph.change(),o.recomputeInsideNodes()},"callback")}),e;i.recomputeInsideNodes();const s=i.nodes;if(e.push({content:"Add Selected Nodes To Group",disabled:!n.selectedItems?.size,callback:u(()=>{$e(i,n.selectedItems),n.graph.change()},"callback")}),s.length===0)return e;e.push(null);let t=!0;for(let o=1;o<s.length;o++)if(s[o].mode!==s[0].mode){t=!1;break}if(e.push({content:"Fit Group To Nodes",callback:u(()=>{i.recomputeInsideNodes();const o=ee().get("Comfy.GroupSelectedNodes.Padding");i.resizeTo(i.children,o),n.graph.change()},"callback")}),e.push({content:"Select Nodes",callback:u(()=>{n.selectNodes(s),n.graph.change(),n.canvas.focus()},"callback")}),t)switch(s[0].mode){case 0:e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const r of s)G(r,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const r of s)G(r,4)},"callback")});break;case 2:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const r of s)G(r,0)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const r of s)G(r,4)},"callback")});break;case 4:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const r of s)G(r,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const r of s)G(r,2)},"callback")});break;default:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const r of s)G(r,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const r of s)G(r,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const r of s)G(r,4)},"callback")});break}else e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const o of s)G(o,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const o of s)G(o,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const o of s)G(o,4)},"callback")});return e}};p.registerExtension(uo);X().registerExtension({name:"Comfy.ImageCompare",async nodeCreated(n){if(n.constructor.comfyClass!=="ImageCompare")return;const[e,i]=n.size;n.setSize([Math.max(e,400),Math.max(i,350)]);const s=n.onExecuted;n.onExecuted=function(t){s?.call(this,t);const o=t.a_images,r=t.b_images,a=p.getRandParam(),l=o&&o.length>0?E.apiURL(`/view?${new URLSearchParams(o[0])}${a}`):"",d=r&&r.length>0?E.apiURL(`/view?${new URLSearchParams(r[0])}${a}`):"",c=n.widgets?.find(f=>f.type==="imagecompare");c&&(c.value={before:l,after:d},c.callback?.(c.value))}}});const po=[{label:"GLB",value:"glb"},{label:"OBJ",value:"obj"},{label:"STL",value:"stl"}];function pe(n){return[null,{content:"Save",has_submenu:!0,callback:u((e,i,s,t)=>{const o=po.map(r=>({content:r.label,callback:u(()=>{(async()=>{try{await n.exportModel(r.value),S().add({severity:"success",summary:D("toastMessages.exportSuccess",{format:r.label})})}catch(a){console.error("Export failed:",a),S().addAlert(D("toastMessages.failedToExportModel",{format:r.label}))}})()},"callback")}));new I.ContextMenu(o,{event:s,parentMenu:t})},"callback")}]}u(pe,"createExportMenuItems");window.comfyAPI=window.comfyAPI||{};window.comfyAPI.exportMenuHelper=window.comfyAPI.exportMenuHelper||{};window.comfyAPI.exportMenuHelper.createExportMenuItems=pe;class Ee{static{u(this,"Load3DConfiguration")}constructor(e,i){this.load3d=e,this.properties=i}configureForSaveMesh(e,i){this.setupModelHandlingForSaveMesh(i,e),this.setupDefaultProperties()}configure(e){this.setupModelHandling(e.modelWidget,e.loadFolder,e.cameraState),this.setupTargetSize(e.width,e.height),this.setupDefaultProperties(e.bgImagePath)}setupTargetSize(e,i){e&&i&&(this.load3d.setTargetSize(e.value,i.value),e.callback=s=>{this.load3d.setTargetSize(s,i.value)},i.callback=s=>{this.load3d.setTargetSize(e.value,s)})}setupModelHandlingForSaveMesh(e,i){const s=this.createModelUpdateHandler(i);e&&s(e)}setupModelHandling(e,i,s){const t=this.createModelUpdateHandler(i,s);e.value&&t(e.value);const o=e.callback;let r=e.value;Object.defineProperty(e,"value",{get(){return r},set(a){r=a,e.callback&&a!==void 0&&a!==""&&e.callback(a)},enumerable:!0,configurable:!0}),e.callback=a=>{t(a),o&&o(a)}}setupDefaultProperties(e){const i=this.loadSceneConfig();this.applySceneConfig(i,e);const s=this.loadCameraConfig();this.applyCameraConfig(s);const t=this.loadLightConfig();this.applyLightConfig(t)}loadSceneConfig(){return this.properties&&"Scene Config"in this.properties?this.properties["Scene Config"]:{showGrid:ee().get("Comfy.Load3D.ShowGrid"),backgroundColor:"#"+ee().get("Comfy.Load3D.BackgroundColor"),backgroundImage:""}}loadCameraConfig(){return this.properties&&"Camera Config"in this.properties?this.properties["Camera Config"]:{cameraType:ee().get("Comfy.Load3D.CameraType"),fov:35}}loadLightConfig(){return this.properties&&"Light Config"in this.properties?this.properties["Light Config"]:{intensity:ee().get("Comfy.Load3D.LightIntensity")}}loadModelConfig(){return this.properties&&"Model Config"in this.properties?this.properties["Model Config"]:{upDirection:"original",materialMode:"original",showSkeleton:!1}}applySceneConfig(e,i){if(this.load3d.toggleGrid(e.showGrid),this.load3d.setBackgroundColor(e.backgroundColor),e.backgroundImage){if(i&&i!=e.backgroundImage)return;this.load3d.setBackgroundImage(e.backgroundImage),e.backgroundRenderMode&&this.load3d.setBackgroundRenderMode(e.backgroundRenderMode)}}applyCameraConfig(e){this.load3d.toggleCamera(e.cameraType),this.load3d.setFOV(e.fov),e.state&&this.load3d.setCameraState(e.state)}applyLightConfig(e){this.load3d.setLightIntensity(e.intensity)}applyModelConfig(e){this.load3d.setUpDirection(e.upDirection),this.load3d.setMaterialMode(e.materialMode)}createModelUpdateHandler(e,i){let s=!0;return async t=>{if(!t)return;const o=t;this.setResourceFolder(o);const r=E.apiURL($.getResourceURL(...$.splitFilePath(o),e));await this.load3d.loadModel(r,o);const a=this.loadModelConfig();if(this.applyModelConfig(a),s&&i){try{this.load3d.setCameraState(i)}catch(l){console.warn("Failed to restore camera state:",l)}s=!1}}}setResourceFolder(e){const i=e.split("/").filter(o=>o.trim());if(i.length<=2)return;const t=i.slice(1,-1).join("/");t&&this.properties&&(this.properties["Resource Folder"]=t)}}const go={name:"image",type:"Load3D",isPreview:!1},ze={name:"image",type:"Preview3D",isPreview:!0};async function fo(n,e){if(!n?.length)return;const i=e.widgets?.find(s=>s.name==="model_file");try{const s=e.properties["Resource Folder"]||"",t=s.trim()?`3d/${s.trim()}`:"3d",o=await $.uploadFile(n[0],t);if(!o){S().addAlert(D("toastMessages.fileUploadFailed"));return}const r=E.apiURL($.getResourceURL(...$.splitFilePath(o),"input"));re(e).waitForLoad3d(a=>{try{a.loadModel(r)}catch{S().addAlert(D("toastMessages.failedToLoadModel"))}}),o&&i&&(i.options?.values?.includes(o)||i.options?.values?.push(o),i.value=o)}catch(s){console.error("Model upload failed:",s),S().addAlert(D("toastMessages.fileUploadFailed"))}}u(fo,"handleModelUpload");async function ho(n,e){if(n?.length)try{const i=e.properties["Resource Folder"]||"",s=i.trim()?`3d/${i.trim()}`:"3d";await $.uploadMultipleFiles(n,s)}catch(i){console.error("Extra resources upload failed:",i),S().addAlert(D("toastMessages.extraResourcesUploadFailed"))}}u(ho,"handleResourcesUpload");function je(n,e=!1){const i=document.createElement("input");return i.type="file",i.accept=n,i.multiple=e,i.style.display="none",i}u(je,"createFileInput");X().registerExtension({name:"Comfy.Load3D",settings:[{id:"Comfy.Load3D.ShowGrid",category:["3D","Scene","Initial Grid Visibility"],name:"Initial Grid Visibility",tooltip:"Controls whether the grid is visible by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.",type:"boolean",defaultValue:!0,experimental:!0},{id:"Comfy.Load3D.BackgroundColor",category:["3D","Scene","Initial Background Color"],name:"Initial Background Color",tooltip:"Controls the default background color of the 3D scene. This setting determines the background appearance when a new 3D widget is created, but can be adjusted individually for each widget after creation.",type:"color",defaultValue:"282828",experimental:!0},{id:"Comfy.Load3D.CameraType",category:["3D","Camera","Initial Camera Type"],name:"Initial Camera Type",tooltip:"Controls whether the camera is perspective or orthographic by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.",type:"combo",options:["perspective","orthographic"],defaultValue:"perspective",experimental:!0},{id:"Comfy.Load3D.LightIntensity",category:["3D","Light","Initial Light Intensity"],name:"Initial Light Intensity",tooltip:"Sets the default brightness level of lighting in the 3D scene. This value determines how intensely lights illuminate objects when a new 3D widget is created, but can be adjusted individually for each widget after creation.",type:"number",defaultValue:3,experimental:!0},{id:"Comfy.Load3D.LightIntensityMaximum",category:["3D","Light","Light Intensity Maximum"],name:"Light Intensity Maximum",tooltip:"Sets the maximum allowable light intensity value for 3D scenes. This defines the upper brightness limit that can be set when adjusting lighting in any 3D widget.",type:"number",defaultValue:10,experimental:!0},{id:"Comfy.Load3D.LightIntensityMinimum",category:["3D","Light","Light Intensity Minimum"],name:"Light Intensity Minimum",tooltip:"Sets the minimum allowable light intensity value for 3D scenes. This defines the lower brightness limit that can be set when adjusting lighting in any 3D widget.",type:"number",defaultValue:1,experimental:!0},{id:"Comfy.Load3D.LightAdjustmentIncrement",category:["3D","Light","Light Adjustment Increment"],name:"Light Adjustment Increment",tooltip:"Controls the increment size when adjusting light intensity in 3D scenes. A smaller step value allows for finer control over lighting adjustments, while a larger value results in more noticeable changes per adjustment.",type:"slider",attrs:{min:.1,max:1,step:.1},defaultValue:.5,experimental:!0},{id:"Comfy.Load3D.3DViewerEnable",category:["3D","3DViewer","Enable"],name:"Enable 3D Viewer (Beta)",tooltip:"Enables the 3D Viewer (Beta) for selected nodes. This feature allows you to visualize and interact with 3D models directly within the full size 3d viewer.",type:"boolean",defaultValue:!1,experimental:!0},{id:"Comfy.Load3D.PLYEngine",category:["3D","PLY","PLY Engine"],name:"PLY Engine",tooltip:'Select the engine for loading PLY files. "threejs" uses the native Three.js PLYLoader (best for mesh PLY files). "fastply" uses an optimized loader for ASCII point cloud PLY files. "sparkjs" uses Spark.js for 3D Gaussian Splatting PLY files.',type:"combo",options:["threejs","fastply","sparkjs"],defaultValue:"threejs",experimental:!0}],commands:[{id:"Comfy.3DViewer.Open3DViewer",icon:"pi pi-pencil",label:"Open 3D Viewer (Beta) for Selected Node",function:u(()=>{const n=p.canvas.selected_nodes;if(!n||Object.keys(n).length!==1)return;const e=n[Object.keys(n)[0]];if(!Gt(e))return;T.copyToClipspace(e),T.clipspace_return_node=e;const i={node:e};tt().showDialog({key:"global-load3d-viewer",title:D("load3d.viewer.title"),component:Wt,props:i,dialogComponentProps:{style:"width: 80vw; height: 80vh;",maximizable:!0,onClose:u(async()=>{await ce().handleViewerClose(i.node)},"onClose")}})},"function")}],getCustomWidgets(){return{LOAD_3D(n){const e=je(".gltf,.glb,.obj,.fbx,.stl,.ply,.spz,.splat,.ksplat",!1);n.properties["Resource Folder"]="",e.onchange=async()=>{await fo(e.files,n)},n.addWidget("button","upload 3d model","upload3dmodel",()=>{e.click()});const i=je("*",!0);i.onchange=async()=>{await ho(i.files,n),i.value=""},n.addWidget("button","upload extra resources","uploadExtraResources",()=>{i.click()}),n.addWidget("button","clear","clear",()=>{re(n).waitForLoad3d(o=>{o.clearModel()});const t=n.widgets?.find(o=>o.name==="model_file");t&&(t.value="")});const s=new De({node:n,name:"image",component:Te,inputSpec:go,options:{}});return s.type="load3D",xe(n,s),{widget:s}}}},getNodeMenuItems(n){if(n.constructor.comfyClass!=="Load3D")return[];const e=ce().getLoad3d(n);return e?e.isSplatModel()?[]:pe(e):[]},async nodeCreated(n){if(n.constructor.comfyClass!=="Load3D")return;const[e,i]=n.size;n.setSize([Math.max(e,300),Math.max(i,600)]),await _e(),re(n).waitForLoad3d(s=>{const o=n.properties["Camera Config"]?.state,r=new Ee(s,n.properties),a=n.widgets?.find(f=>f.name==="model_file"),l=n.widgets?.find(f=>f.name==="width"),d=n.widgets?.find(f=>f.name==="height"),c=n.widgets?.find(f=>f.name==="image");if(a&&l&&d&&c){const f={loadFolder:"input",modelWidget:a,cameraState:o,width:l,height:d};r.configure(f),c.serializeValue=async()=>{const v=Lt.get(n);if(!v)return console.error("No load3d instance found for node"),null;const g=n.properties["Camera Config"]||{cameraType:v.getCurrentCameraType(),fov:v.cameraManager.perspectiveCamera.fov};g.state=v.getCameraState(),n.properties["Camera Config"]=g,v.stopRecording();const{scene:h,mask:m,normal:y}=await v.captureScene(l.value,d.value),[w,N,C]=await Promise.all([$.uploadTempImage(h,"scene"),$.uploadTempImage(m,"scene_mask"),$.uploadTempImage(y,"scene_normal")]);v.handleResize();const k={image:`threed/${w.name} [temp]`,mask:`threed/${N.name} [temp]`,normal:`threed/${C.name} [temp]`,camera_info:n.properties["Camera Config"]?.state||null,recording:""},x=v.getRecordingData();if(x){const[_]=await Promise.all([$.uploadTempImage(x,"recording","mp4")]);k.recording=`threed/${_.name} [temp]`}return k}}})}});X().registerExtension({name:"Comfy.Preview3D",async beforeRegisterNodeDef(n,e){e.name==="Preview3D"&&(e.input.required.image=["PREVIEW_3D"])},getNodeMenuItems(n){if(n.constructor.comfyClass!=="Preview3D")return[];const e=ce().getLoad3d(n);return e?e.isSplatModel()?[]:pe(e):[]},getCustomWidgets(){return{PREVIEW_3D(n){const e=new De({node:n,name:ze.name,component:Te,inputSpec:ze,options:{}});return e.type="load3D",xe(n,e),{widget:e}}}},async nodeCreated(n){if(n.constructor.comfyClass!=="Preview3D")return;const[e,i]=n.size;n.setSize([Math.max(e,400),Math.max(i,550)]),await _e();const s=n.onExecuted;re(n).waitForLoad3d(t=>{const o=new Ee(t,n.properties),r=n.widgets?.find(a=>a.name==="model_file");if(r){const a=n.properties["Last Time Model File"];if(a){r.value=a;const d=n.properties["Camera Config"]?.state,c={loadFolder:"output",modelWidget:r,cameraState:d};o.configure(c)}n.onExecuted=function(l){s?.apply(this,arguments);let d=l.result[0];if(!d){const g=D("toastMessages.unableToGetModelFilePath");console.error(g),S().addAlert(g)}let c=l.result[1],f=l.result[2];r.value=d.replaceAll("\\","/"),n.properties["Last Time Model File"]=r.value;const v={loadFolder:"output",modelWidget:r,cameraState:c,bgImagePath:f};o.configure(v),f&&t.setBackgroundImage(f)}}})}});function rt(n){if(!n){console.error("[MaskEditor] No node provided");return}if(!n.imgs?.length&&n.previewMediaType!=="image"){console.error("[MaskEditor] Node has no images");return}Rt().openMaskEditor(n)}u(rt,"openMaskEditor");function mo(){const n=T.clipspace_return_node;if(!n){console.error("[MaskEditor] No clipspace_return_node found");return}rt(n)}u(mo,"openMaskEditorFromClipspace");function at(){return tt().isDialogOpen("global-mask-editor")}u(at,"isOpened");const He=u(async n=>{if(!at())return;const e=ot(),i=e.brushSettings.size,s=n(i);e.setBrushSize(s)},"changeBrushSize");p.registerExtension({name:"Comfy.MaskEditor",settings:[{id:"Comfy.MaskEditor.BrushAdjustmentSpeed",category:["Mask Editor","BrushAdjustment","Sensitivity"],name:"Brush adjustment speed multiplier",tooltip:"Controls how quickly the brush size and hardness change when adjusting. Higher values mean faster changes.",type:"slider",attrs:{min:.1,max:2,step:.1},defaultValue:1,versionAdded:"1.0.0"},{id:"Comfy.MaskEditor.UseDominantAxis",category:["Mask Editor","BrushAdjustment","UseDominantAxis"],name:"Lock brush adjustment to dominant axis",tooltip:"When enabled, brush adjustments will only affect size OR hardness based on which direction you move more",type:"boolean",defaultValue:!0}],commands:[{id:"Comfy.MaskEditor.OpenMaskEditor",icon:"pi pi-pencil",label:"Open Mask Editor for Selected Node",function:u(()=>{const n=p.canvas.selected_nodes;if(!n||Object.keys(n).length!==1)return;const e=n[Object.keys(n)[0]];rt(e)},"function")},{id:"Comfy.MaskEditor.BrushSize.Increase",icon:"pi pi-plus-circle",label:"Increase Brush Size in MaskEditor",function:u(()=>He(n=>H.clamp(n+2,1,250)),"function")},{id:"Comfy.MaskEditor.BrushSize.Decrease",icon:"pi pi-minus-circle",label:"Decrease Brush Size in MaskEditor",function:u(()=>He(n=>H.clamp(n-2,1,250)),"function")},{id:"Comfy.MaskEditor.ColorPicker",icon:"pi pi-palette",label:"Open Color Picker in MaskEditor",function:u(()=>{if(!at())return;ot().colorInput?.click()},"function")}],init(){T.open_maskeditor=mo,console.warn("[MaskEditor] ComfyApp.open_maskeditor is deprecated. Plugins should migrate to using the command system or direct node context menu integration.")}});const yo="Comfy.NodeTemplates",qe="comfy.templates.json";class wo extends Je{static{u(this,"ManageTemplates")}templates;draggedEl;saveVisualCue;emptyImg;importInput;constructor(){super(),this.load().then(e=>{this.templates=e}),this.element.classList.add("comfy-manage-templates"),this.draggedEl=null,this.saveVisualCue=null,this.emptyImg=new Image,this.emptyImg.src="data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=",this.importInput=b("input",{type:"file",accept:".json",multiple:!0,style:{display:"none"},parent:document.body,onchange:u(()=>this.importAll(),"onchange")})}createButtons(){const e=super.createButtons();return e[0].textContent="Close",e[0].onclick=()=>{clearTimeout(this.saveVisualCue),this.close()},e.unshift(b("button",{type:"button",textContent:"Export",onclick:u(()=>this.exportAll(),"onclick")})),e.unshift(b("button",{type:"button",textContent:"Import",onclick:u(()=>{this.importInput.click()},"onclick")})),e}async load(){let e=[];const i=await E.getUserData(qe);if(i.status===200)try{e=await i.json()}catch{}else i.status!==404&&console.error(i.status+" "+i.statusText);return e??[]}async store(){const e=JSON.stringify(this.templates,void 0,4);try{await E.storeUserData(qe,e,{stringify:!1})}catch(i){console.error(i),S().addAlert(i.message)}}async importAll(){for(const e of this.importInput.files)if(e.type==="application/json"||e.name.endsWith(".json")){const i=new FileReader;i.onload=async()=>{const s=JSON.parse(i.result);if(s?.templates){for(const t of s.templates)t?.name&&t?.data&&this.templates.push(t);await this.store()}},await i.readAsText(e)}this.importInput.value=null,this.close()}exportAll(){if(this.templates.length==0){S().addAlert(D("toastMessages.noTemplatesToExport"));return}const e=JSON.stringify({templates:this.templates},null,2),i=new Blob([e],{type:"application/json"});Ge("node_templates.json",i)}show(){super.show(b("div",{},this.templates.flatMap((e,i)=>{let s;return[b("div",{dataset:{id:i.toString()},className:"templateManagerRow",style:{display:"grid",gridTemplateColumns:"1fr auto",border:"1px dashed transparent",gap:"5px",backgroundColor:"var(--comfy-menu-bg)"},ondragstart:u(t=>{this.draggedEl=t.currentTarget,t.currentTarget.style.opacity="0.6",t.currentTarget.style.border="1px dashed yellow",t.dataTransfer.effectAllowed="move",t.dataTransfer.setDragImage(this.emptyImg,0,0)},"ondragstart"),ondragend:u(t=>{t.target.style.opacity="1",t.currentTarget.style.border="1px dashed transparent",t.currentTarget.removeAttribute("draggable"),this.element.querySelectorAll(".templateManagerRow").forEach((o,r)=>{var a=Number.parseInt(o.dataset.id);o==this.draggedEl&&a!=r&&this.templates.splice(r,0,this.templates.splice(a,1)[0]),o.dataset.id=r.toString()}),this.store()},"ondragend"),ondragover:u(t=>{if(t.preventDefault(),t.currentTarget==this.draggedEl)return;let o=t.currentTarget.getBoundingClientRect();t.clientY>o.top+o.height/2?t.currentTarget.parentNode.insertBefore(this.draggedEl,t.currentTarget.nextSibling):t.currentTarget.parentNode.insertBefore(this.draggedEl,t.currentTarget)},"ondragover")},[b("label",{textContent:"Name: ",style:{cursor:"grab"},onmousedown:u(t=>{t.target.localName=="label"&&(t.currentTarget.parentNode.draggable="true")},"onmousedown")},[b("input",{value:e.name,dataset:{name:e.name},style:{transitionProperty:"background-color",transitionDuration:"0s"},onchange:u(t=>{clearTimeout(this.saveVisualCue);var o=t.target,r=o.parentNode.parentNode;this.templates[r.dataset.id].name=o.value.trim()||"untitled",this.store(),o.style.backgroundColor="rgb(40, 95, 40)",o.style.transitionDuration="0s",this.saveVisualCue=setTimeout(function(){o.style.transitionDuration=".7s",o.style.backgroundColor="var(--comfy-input-bg)"},15)},"onchange"),onkeypress:u(t=>{var o=t.target;clearTimeout(this.saveVisualCue),o.style.transitionDuration="0s",o.style.backgroundColor="var(--comfy-input-bg)"},"onkeypress"),$:u(t=>s=t,"$")})]),b("div",{},[b("button",{textContent:"Export",style:{fontSize:"12px",fontWeight:"normal"},onclick:u(()=>{const t=JSON.stringify({templates:[e]},null,2),o=new Blob([t],{type:"application/json"}),r=(s.value||e.name)+".json";Ge(r,o)},"onclick")}),b("button",{textContent:"Delete",style:{fontSize:"12px",color:"red",fontWeight:"normal"},onclick:u(t=>{const o=t.target.parentNode.parentNode;o.parentNode.removeChild(o),this.templates.splice(o.dataset.id*1,1),this.store();var r=this;setTimeout(function(){r.element.querySelectorAll(".templateManagerRow").forEach((a,l)=>{a.dataset.id=l.toString()})},0)},"onclick")})])])]})))}}const le=new wo,Ye=u(async n=>{const e=localStorage.getItem("litegrapheditor_clipboard");await n(),localStorage.setItem("litegrapheditor_clipboard",e)},"clipboardAction"),vo={name:yo,getCanvasMenuItems(n){const e=[];e.push(null),e.push({content:"Save Selected as Template",disabled:!Object.keys(p.canvas.selected_nodes||{}).length,callback:u(async()=>{const s=await te().prompt({title:D("nodeTemplates.saveAsTemplate"),message:D("nodeTemplates.enterName"),defaultValue:""});s?.trim()&&Ye(()=>{p.canvas.copyToClipboard();let t=localStorage.getItem("litegrapheditor_clipboard");t=JSON.parse(t||"{}");const o=Object.keys(p.canvas.selected_nodes);for(let r=0;r<o.length;r++){const a=p.canvas.graph?.getNodeById(o[r]),l=a?.constructor.nodeData;let d=U.getGroupData(a);if(d){if(d=d.nodeData,t.groupNodes||(t.groupNodes={}),l==null)throw new TypeError("nodeData is not set");t.groupNodes[l.name]=d,t.nodes[r].type=l.name}}le.templates.push({name:s,data:JSON.stringify(t)}),le.store()})},"callback")});const i=le.templates.map(s=>({content:s.name,callback:u(()=>{Ye(async()=>{const t=JSON.parse(s.data);await Y.registerFromWorkflow(t.groupNodes,{}),t.reroutes?(localStorage.setItem("litegrapheditor_clipboard",s.data),p.canvas.pasteFromClipboard()):et(s.data,p.canvas)})},"callback")}));return i.push(null,{content:"Manage",callback:u(()=>le.show(),"callback")}),e.push({content:"Node Templates",submenu:{options:i}}),e}};p.registerExtension(vo);p.registerExtension({name:"Comfy.NoteNode",registerCustomNodes(){class n extends de{static{u(this,"NoteNode")}static category;static collapsable;static title_mode;groupcolor=R.node_colors.yellow.groupcolor;isVirtualNode;constructor(s){super(s),this.color=R.node_colors.yellow.color,this.bgcolor=R.node_colors.yellow.bgcolor,this.properties||(this.properties={text:""}),B.STRING(this,"text",["STRING",{default:this.properties.text,multiline:!0}],p),this.serialize_widgets=!0,this.isVirtualNode=!0}}I.registerNodeType("Note",Object.assign(n,{title_mode:I.NORMAL_TITLE,title:"Note",collapsable:!0})),n.category="utils";class e extends de{static{u(this,"MarkdownNoteNode")}static title="Markdown Note";groupcolor=R.node_colors.yellow.groupcolor;constructor(s){super(s),this.color=R.node_colors.yellow.color,this.bgcolor=R.node_colors.yellow.bgcolor,this.properties||(this.properties={text:""}),B.MARKDOWN(this,"text",["STRING",{default:this.properties.text}],p),this.serialize_widgets=!0,this.isVirtualNode=!0}}I.registerNodeType("MarkdownNote",e),e.category="utils"}});X().registerExtension({name:"Comfy.PreviewAny",async beforeRegisterNodeDef(n,e){if(e.name==="PreviewAny"){const i=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){i&&i.apply(this,[]);const t=B.MARKDOWN(this,"preview",["MARKDOWN",{}],p).widget,o=B.STRING(this,"preview",["STRING",{multiline:!0}],p).widget,r=B.BOOLEAN(this,"previewMode",["BOOLEAN",{label_on:"Markdown",label_off:"Plaintext",default:!1}],p);r.widget.callback=a=>{t.hidden=!a,t.options.hidden=!a,o.hidden=a,o.options.hidden=a},t.hidden=!0,t.options.hidden=!0,t.options.read_only=!0,t.element.readOnly=!0,t.element.disabled=!0,t.serialize=!1,o.hidden=!1,o.options.hidden=!1,o.options.read_only=!0,o.element.readOnly=!0,o.element.disabled=!0,o.serialize=!1};const s=n.prototype.onExecuted;n.prototype.onExecuted=function(t){s?.apply(this,[t]);const o=this.widgets?.filter(r=>r.name==="preview")??[];for(const r of o){const a=t.text??"";r.value=Array.isArray(a)?a[0]??"":a}}}}});p.registerExtension({name:"Comfy.RerouteNode",registerCustomNodes(n){class e extends de{static{u(this,"RerouteNode")}static category;static defaultVisibility=!1;constructor(s){super(s??""),this.properties||(this.properties={}),this.properties.showOutputText=e.defaultVisibility,this.properties.horizontal=!1,this.addInput("","*"),this.addOutput(this.properties.showOutputText?"*":"","*"),this.isVirtualNode=!0}onAfterGraphConfigured(){requestAnimationFrame(()=>{this.onConnectionsChange(I.INPUT,void 0,!0)})}clone(){const s=super.clone();return s&&(s.removeOutput(0),s.addOutput(this.properties.showOutputText?"*":"","*"),s.setSize(s.computeSize()),s)}onConnectionsChange(s,t,o){const{graph:r}=this;if(!r||n.configuringGraph)return;if(o&&s===I.OUTPUT&&new Set(this.outputs[0].links?.map(N=>r.links[N]?.type)?.filter(N=>N&&N!=="*")??[]).size>1){const N=[];for(const C of this.outputs[0].links??[]){const k=r.links[C];N.push(k)}N.pop();for(const C of N)r.getNodeById(C.target_id)?.disconnectInput(C.target_slot)}let a=this,l=[],d=null,c=null;for(;a;){l.unshift(a);const w=a.inputs[0].link;if(w!==null){const N=r.links[w];if(!N)return;const C=r.getNodeById(N.origin_id);if(!C)return;if(C instanceof e)C===this?(a.disconnectInput(N.target_slot),a=null):a=C;else{c=a,d=C.outputs[N.origin_slot]?.type??null;break}}else{a=null;break}}const f=[this];let v=null;for(;f.length;){a=f.pop();const w=a.outputs?.[0]?.links??[];for(const N of w){const C=r.links[N];if(!C)continue;const k=r.getNodeById(C.target_id);if(k)if(k instanceof e)f.push(k),l.push(k);else{const x=k.inputs[C.target_slot],_=x.type,O=!d||!_||I.isValidConnection(d,_);if(!O){k.disconnectInput(C.target_slot);continue}k.onConnectionsChange?.(I.INPUT,C.target_slot,O,C,x),v=k.inputs[C.target_slot].type}}}const g=d||v||"*",h=R.link_type_colors[g];let m,y;for(const w of l){w.outputs[0].type=d||"*",w.__outputType=g,w.outputs[0].name=w.properties.showOutputText?`${g}`:"",w.setSize(w.computeSize());for(const N of w.outputs[0].links||[]){const C=r.links[N];if(!C||(C.color=h,n.configuringGraph))continue;const k=r.getNodeById(C.target_id);if(!k)continue;const x=k.inputs?.[C.target_slot];if(x?.widget){const _=Me(x);m||(m=_[1]??{},y=_[0]);const O=ae(x,[_[0],m]);O.customConfig&&(m=O.customConfig)}}}for(const w of l)m&&v?(w.inputs[0].widget={name:"value"},Ie(w.inputs[0],[y??`${g}`,m])):Ie(w.inputs[0],void 0);if(c?.inputs?.[0]?.link){const w=r.links[c.inputs[0].link];w&&(w.color=h)}}getExtraMenuOptions(s,t){return t.unshift({content:(this.properties.showOutputText?"Hide":"Show")+" Type",callback:u(()=>{this.properties.showOutputText=!this.properties.showOutputText,this.properties.showOutputText?this.outputs[0].name=`${this.__outputType||this.outputs[0].type}`:this.outputs[0].name="",this.setSize(this.computeSize()),n.canvas.setDirty(!0,!0)},"callback")},{content:(e.defaultVisibility?"Hide":"Show")+" Type By Default",callback:u(()=>{e.setDefaultTextVisibility(!e.defaultVisibility)},"callback")}),[]}computeSize(){return[this.properties.showOutputText&&this.outputs&&this.outputs.length?Math.max(75,I.NODE_TEXT_SIZE*this.outputs[0].name.length*.6+40):75,26]}static setDefaultTextVisibility(s){e.defaultVisibility=s,s?localStorage["Comfy.RerouteNode.DefaultVisibility"]="true":delete localStorage["Comfy.RerouteNode.DefaultVisibility"]}}e.setDefaultTextVisibility(!!localStorage["Comfy.RerouteNode.DefaultVisibility"]),I.registerNodeType("Reroute",Object.assign(e,{title_mode:I.NO_TITLE,title:"Reroute",collapsable:!1})),e.category="utils"}});const bo=new Set(["SaveImage","SaveVideo","SaveAnimatedWEBP","SaveWEBM","SaveAudio","SaveGLB","SaveAnimatedPNG","CLIPSave","VAESave","ModelSave","LoraSave","SaveLatent"]);p.registerExtension({name:"Comfy.SaveImageExtraOutput",async beforeRegisterNodeDef(n,e,i){if(bo.has(e.name)){const s=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){const t=s?s.apply(this,arguments):void 0,o=this.widgets.find(r=>r.name==="filename_prefix");return o.serializeValue=()=>Ze(i.graph,o.value),t}}else{const s=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){const t=s?s.apply(this,arguments):void 0;return(!this.properties||!("Node name for S&R"in this.properties))&&this.addProperty("Node name for S&R",this.constructor.type,"string"),t}}}});const Xe={name:"image",type:"Preview3D",isPreview:!0};X().registerExtension({name:"Comfy.SaveGLB",async beforeRegisterNodeDef(n,e){e.name==="SaveGLB"&&(e.input.required.image=["PREVIEW_3D"])},getCustomWidgets(){return{PREVIEW_3D(n){const e=new De({node:n,name:Xe.name,component:Te,inputSpec:Xe,options:{}});return e.type="load3D",xe(n,e),{widget:e}}}},getNodeMenuItems(n){if(n.constructor.comfyClass!=="SaveGLB")return[];const e=ce().getLoad3d(n);return e?e.isSplatModel()?[]:pe(e):[]},async nodeCreated(n){if(n.constructor.comfyClass!=="SaveGLB")return;const[e,i]=n.size;n.setSize([Math.max(e,400),Math.max(i,550)]),await _e();const s=n.onExecuted;n.onExecuted=function(t){s?.apply(this,arguments);const o=t["3d"][0];re(n).waitForLoad3d(r=>{const a=n.widgets?.find(l=>l.name==="image");if(r&&a){const l=o.subfolder+"/"+o.filename;a.value=l,new Ee(r,n.properties).configureForSaveMesh(o.type,l)}})}}});function No(n,e){const i=e.selectedItems;if(i.size<=1)return;const s=Ft(i,10);if(!s)return;const[t,o,r,a]=s;n.save();const l=2/e.ds.scale;n.lineWidth=l,n.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--border-color").trim()||"#ffffff66";const d=5/e.ds.scale;n.setLineDash([d,d]),n.beginPath(),n.roundRect(t,o,r,a,8/e.ds.scale),n.stroke(),n.restore()}u(No,"drawSelectionBorder");const Co={name:"Comfy.SelectionBorder",async init(){const n=p.canvas.onDrawForeground;p.canvas.onDrawForeground=function(e,i){n?.call(this,e,i),No(e,p.canvas)}}};p.registerExtension(Co);let ie=!1,se=0;p.registerExtension({name:"Comfy.SimpleTouchSupport",setup(){let n=null,e=null,i=null,s=null;function t(a){return Math.hypot(a.touches[0].clientX-a.touches[1].clientX,a.touches[0].clientY-a.touches[1].clientY)}u(t,"getMultiTouchPos");function o(a){return{clientX:(a.touches[0].clientX+a.touches[1].clientX)/2,clientY:(a.touches[0].clientY+a.touches[1].clientY)/2}}u(o,"getMultiTouchCenter"),p.canvasEl.parentElement?.addEventListener("touchstart",a=>{se+=a.changedTouches.length,i=null,s=null,a.touches?.length===1?(e=new Date,i=a.touches[0]):(e=null,a.touches?.length===2&&(s=p.canvas.ds.scale,i=o(a),n=t(a),p.canvas.pointer.isDown=!1))},!0),p.canvasEl.parentElement?.addEventListener("touchend",a=>{if(se-=a.changedTouches.length,a.touches?.length!==1&&(ie=!1),e&&!a.touches?.length){if(new Date().getTime()-e.getTime()>600&&a.target===p.canvasEl){const l={button:2,clientX:a.changedTouches[0].clientX,clientY:a.changedTouches[0].clientY,pointerId:1,isPrimary:!0};p.canvasEl.dispatchEvent(new PointerEvent("pointerdown",l)),setTimeout(()=>{p.canvasEl.dispatchEvent(new PointerEvent("pointerup",l))}),a.preventDefault()}e=null}});const r=u(()=>{se=0,ie=!1,e=null,i=null,s=null,n=null},"resetTouchState");document.addEventListener("visibilitychange",()=>{document.hidden&&r()}),p.canvasEl.parentElement?.addEventListener("touchcancel",r),p.canvasEl.parentElement?.addEventListener("touchmove",a=>{if(e&&i&&a.touches?.length===1){const c=a.touches[0],f=c.clientX-i.clientX,v=c.clientY-i.clientY;f*f+v*v>30&&(e=null)}if(a.touches?.length===2&&i&&!a.ctrlKey&&!a.shiftKey){a.preventDefault(),p.canvas.pointer.isDown=!1,ie=!0,I.closeAllContextMenus(window),p.canvas.search_box?.close();const c=t(a),f=o(a);if(s===null||n===null)return;let v=s*c/n;const g=(f.clientX-i.clientX)/v,h=(f.clientY-i.clientY)/v;v<p.canvas.ds.min_scale?v=p.canvas.ds.min_scale:v>p.canvas.ds.max_scale&&(v=p.canvas.ds.max_scale);const m=p.canvas.ds.scale;p.canvas.ds.scale=v,Math.abs(p.canvas.ds.scale-1)<.01&&(p.canvas.ds.scale=1);const y=p.canvas.ds.scale,w=u(N=>[f.clientX/N-p.canvas.ds.offset[0],f.clientY/N-p.canvas.ds.offset[1]],"convertScaleToOffset");var l=w(m),d=w(y);p.canvas.ds.offset[0]+=g+d[0]-l[0],p.canvas.ds.offset[1]+=h+d[1]-l[1],i.clientX=f.clientX,i.clientY=f.clientY,p.canvas.setDirty(!0,!0)}},!0)}});const Io=R.prototype.processMouseDown;R.prototype.processMouseDown=function(n){if(!(ie||se))return p.canvas.pointer.isDown=!1,Io.apply(this,[n])};const ko=R.prototype.processMouseMove;R.prototype.processMouseMove=function(n){if(!(ie||se>1))return ko.apply(this,[n])};p.registerExtension({name:"Comfy.SlotDefaults",suggestionsNumber:null,init(){I.search_filter_enabled=!0,I.middle_click_slot_add_default_node=!0,this.suggestionsNumber=p.ui.settings.addSetting({id:"Comfy.NodeSuggestions.number",category:["Comfy","Node Search Box","NodeSuggestions"],name:"Number of nodes suggestions",tooltip:"Only for litegraph searchbox/context menu",type:"slider",attrs:{min:1,max:100,step:1},defaultValue:5,onChange:u(n=>{this.setDefaults(n)},"onChange")})},slot_types_default_out:{},slot_types_default_in:{},async beforeRegisterNodeDef(n,e){var i=e.name;const s=e.input?.required;for(const d in s){var t=s[d];if(typeof t[0]!="string")continue;var o=t[0];if(o in B){var r=t[1];if(!r?.forceInput)continue}if(o in this.slot_types_default_out||(this.slot_types_default_out[o]=["Reroute"]),this.slot_types_default_out[o].includes(i))continue;this.slot_types_default_out[o].push(i);const c=o.toLocaleLowerCase();c in I.registered_slot_in_types||(I.registered_slot_in_types[c]={nodes:[]}),I.registered_slot_in_types[c].nodes.push(n.comfyClass)}var a=e.output??[];for(const d of a){const c=d;c in this.slot_types_default_in||(this.slot_types_default_in[c]=["Reroute"]),!this.slot_types_default_in[c].includes(i)&&(this.slot_types_default_in[c].push(i),c in I.registered_slot_out_types||(I.registered_slot_out_types[c]={nodes:[]}),I.registered_slot_out_types[c].nodes.push(n.comfyClass),I.slot_types_out.includes(c)||I.slot_types_out.push(c))}var l=this.suggestionsNumber.value;this.setDefaults(l)},setDefaults(n){I.slot_types_default_out={},I.slot_types_default_in={};for(const e in this.slot_types_default_out)I.slot_types_default_out[e]=this.slot_types_default_out[e].slice(0,n);for(const e in this.slot_types_default_in)I.slot_types_default_in[e]=this.slot_types_default_in[e].slice(0,n)}});async function Do(n,e,i,s,t=!1){try{const o=new FormData;o.append("image",i),t&&o.append("subfolder","pasted");const r=await E.fetchApi("/upload/image",{method:"POST",body:o});if(r.status===200){const a=await r.json();let l=a.name;a.subfolder&&(l=a.subfolder+"/"+l),n.options.values.includes(l)||n.options.values.push(l),s&&(e.element.src=E.apiURL(ue(...nt(l))),n.value=l,n.callback?.(l))}else S().addAlert(r.status+" - "+r.statusText)}catch(o){S().addAlert(o)}}u(Do,"uploadFile");p.registerExtension({name:"Comfy.AudioWidget",async beforeRegisterNodeDef(n,e){["LoadAudio","SaveAudio","PreviewAudio","SaveAudioMP3","SaveAudioOpus"].includes(n.prototype.comfyClass)&&(e.input.required.audioUI=["AUDIO_UI",{}])},getCustomWidgets(){return{AUDIO_UI(n,e){const i=document.createElement("audio");i.controls=!0,i.classList.add("comfy-audio"),i.setAttribute("name","media");const s=n.addDOMWidget(e,"audioUI",i);s.serialize=!1;const{nodeData:t}=n.constructor;if(t==null)throw new TypeError("nodeData is null");if(t.output_node){s.element.classList.add("empty-audio-widget");const r=n.onExecuted;n.onExecuted=function(a){r?.apply(this,arguments);const l=a.audio;if(!l)return;const d=l[0];s.element.src=E.apiURL(ue(d.subfolder,d.filename,d.type)),s.element.classList.remove("empty-audio-widget")}}return s.onRemove=J(s.onRemove,()=>{s.element&&(s.element.pause(),s.element.src="",s.element.remove())}),{widget:s}}}},onNodeOutputsUpdated(n){for(const[e,i]of Object.entries(n))if("audio"in i){const s=Ut(p.rootGraph,e);if(!s)continue;const t=s.widgets.find(r=>r.name==="audioUI"),o=i.audio[0];t.element.src=E.apiURL(ue(o.subfolder,o.filename,o.type)),t.element.classList.remove("empty-audio-widget")}}});p.registerExtension({name:"Comfy.UploadAudio",async beforeRegisterNodeDef(n,e){e?.input?.required?.audio?.[1]?.audio_upload===!0&&(e.input.required.upload=["AUDIOUPLOAD",{}])},getCustomWidgets(){return{AUDIOUPLOAD(n,e){const i=n.widgets.find(c=>c.name==="audio"),s=n.widgets.find(c=>c.name==="audioUI");s.options.canvasOnly=!0;const t=u(()=>{typeof i.value=="string"&&(s.element.src=E.apiURL(ue(...nt(i.value))))},"onAudioWidgetUpdate");i.value&&t(),i.callback=t;const o=n.onGraphConfigured;n.onGraphConfigured=function(){o?.apply(this,arguments),i.value&&t()};const r=u(async c=>(c?.length&&Do(i,s,c[0],!0),c),"handleUpload"),a=u(c=>c.type.startsWith("audio/"),"isAudioFile"),{openFileSelection:l}=Bt(n,{accept:"audio/*",onSelect:r}),d=n.addWidget("button",e,"",l,{serialize:!1,canvasOnly:!0});return d.label=D("g.choose_file_to_upload"),Vt(n,{fileFilter:a,onDrop:r}),$t(n,{fileFilter:a,onPaste:r}),n.previewMediaType="audio",{widget:d}}}}});p.registerExtension({name:"Comfy.RecordAudio",getCustomWidgets(){return{AUDIO_RECORD(n,e){const i=document.createElement("audio");i.controls=!0,i.classList.add("comfy-audio"),i.setAttribute("name","media");const s=n.addDOMWidget(e,"audioUI",i);s.options.canvasOnly=!1;let t=null,o=!1,r=[],a=null,l=null,d=null,c=null;s.serializeValue=async()=>{o&&t&&(d=new Promise(h=>{c=h}),t.stop(),await d);const v=s.element.src;if(!v)return S().addAlert(D("g.noAudioRecorded")),"";const g=await fetch(v).then(h=>h.blob());return await Z().convertBlobToFileAndSubmit(g)},l=n.addWidget("button",e,"",async()=>{if(o)t&&o&&t.stop();else try{a=await navigator.mediaDevices.getUserMedia({audio:!0}),t=new Ht(a,{mimeType:"audio/wav"}),r=[],t.ondataavailable=v=>{r.push(v.data)},t.onstop=async()=>{const v=new Blob(r,{type:"audio/wav"});Z().stopAllTracks(a),s.element.src&&s.element.src.startsWith("blob:")&&URL.revokeObjectURL(s.element.src),s.element.src=URL.createObjectURL(v),o=!1,l&&(l.label=D("g.startRecording")),c&&(c(),c=null,d=null)},t.onerror=v=>{console.error("MediaRecorder error:",v),Z().stopAllTracks(a),o=!1,l&&(l.label=D("g.startRecording")),c&&(c(),c=null,d=null)},t.start(),o=!0,l&&(l.label=D("g.stopRecording"))}catch(v){if(console.error("Error accessing microphone:",v),S().addAlert(D("g.micPermissionDenied")),t)try{t.stop()}catch{}Z().stopAllTracks(a),a=null,o=!1,l&&(l.label=D("g.startRecording"))}},{serialize:!1,canvasOnly:!1}),l.label=D("g.startRecording"),l.type="audiorecord";const f=n.onRemoved;return n.onRemoved=function(){o&&t&&t.stop(),Z().stopAllTracks(a),s.element.src?.startsWith("blob:")&&URL.revokeObjectURL(s.element.src),f?.call(this)},{widget:l}}}},async nodeCreated(n){n.constructor.comfyClass==="RecordAudio"&&await Z().registerWavEncoder()}});const xo=u(n=>{const[e,i]=n;return i?(i.image_upload===!0||i.video_upload===!0||i.animated_image_upload===!0)&&(zt(n)||e==="COMBO"):!1},"isMediaUploadComboInput"),_o=u((n,e)=>["IMAGEUPLOAD",{...e[1],imageInputName:n}],"createUploadInput");p.registerExtension({name:"Comfy.UploadImage",beforeRegisterNodeDef(n,e){const{input:i}=e??{},{required:s}=i??{};if(!s)return;const t=Object.entries(s).find(([o,r])=>xo(r));if(t){const[o,r]=t;s.upload=_o(o,r)}}});const Ke=Symbol();p.registerExtension({name:"Comfy.WebcamCapture",getCustomWidgets(){return{WEBCAM(n,e){let i;n[Ke]=new Promise(r=>i=r);const s=document.createElement("div");s.style.background="rgba(0,0,0,0.25)",s.style.textAlign="center";const t=document.createElement("video");return t.style.height=t.style.width="100%",u(async()=>{try{const r=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});s.replaceChildren(t),setTimeout(()=>i(t),500),t.addEventListener("loadedmetadata",()=>i(t),!1),t.srcObject=r,t.play()}catch(r){const a=document.createElement("div");a.style.color="red",a.style.overflow="auto",a.style.maxHeight="100%",a.style.whiteSpace="pre-wrap",window.isSecureContext?a.textContent=`Unable to load webcam, please ensure access is granted:
`+r.message:a.textContent=`Unable to load webcam. A secure context is required, if you are not accessing ComfyUI on localhost (127.0.0.1) you will have to enable TLS (https)

`+r.message,s.replaceChildren(a)}},"loadVideo")(),{widget:n.addDOMWidget(e,"WEBCAM",s)}}}},nodeCreated(n){if(n.type,n.constructor.comfyClass!=="WebcamCapture")return;let e;const i=n.widgets.find(d=>d.name==="image"),s=n.widgets.find(d=>d.name==="width"),t=n.widgets.find(d=>d.name==="height"),o=n.widgets.find(d=>d.name==="capture_on_queue"),r=document.createElement("canvas"),a=u(()=>{r.width=s.value,r.height=t.value,r.getContext("2d").drawImage(e,0,0,s.value,t.value);const c=r.toDataURL("image/png"),f=new Image;f.onload=()=>{n.imgs=[f],p.canvas.setDirty(!0)},f.src=c},"capture"),l=n.addWidget("button","waiting for camera...","capture",a,{canvasOnly:!0});l.disabled=!0,l.serializeValue=()=>{},i.serializeValue=async()=>{if(o.value)a();else if(!n.imgs?.length){const h="No webcam image captured";throw S().addAlert(h),new Error(h)}const d=await new Promise(h=>r.toBlob(h)),c=`${+new Date}.png`,f=new File([d],c),v=new FormData;v.append("image",f),v.append("subfolder","webcam"),v.append("type","temp");const g=await E.fetchApi("/upload/image",{method:"POST",body:v});if(g.status!==200){const h=`Error uploading camera image: ${g.status} - ${g.statusText}`;throw S().addAlert(h),new Error(h)}return`webcam/${c} [temp]`},n[Ke].then(d=>{e=d,s.value||(s.value=e.videoWidth||640,t.value=e.videoHeight||480),l.disabled=!1,l.label=D("g.capture")})}});X().registerExtension({name:"Comfy.LLMNodePreview",async beforeRegisterNodeDef(n,e){if(e.name==="LLMNode"){const i=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){i&&i.apply(this,[]);const t=B.MARKDOWN(this,"preview",["MARKDOWN",{}],p).widget;t.element.readOnly=!0,t.serialize=!1,t.beforeQueued=()=>{t.value="",t.callback?.("")}};const s=n.prototype.onExecuted;n.prototype.onExecuted=function(t){s?.apply(this,[t]);const o=this.widgets?.find(r=>r.name==="preview");o&&t.text&&Array.isArray(t.text)&&t.text.length>0&&(o.value=t.text[0])}}}});
//# sourceMappingURL=index-DVTKN5t7.js.map
