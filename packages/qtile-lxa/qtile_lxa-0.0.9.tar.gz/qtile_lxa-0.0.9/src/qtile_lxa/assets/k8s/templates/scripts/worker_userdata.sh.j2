#!/bin/bash
set -e
# set -x  # Uncomment for debugging

# ===== Variables =====
JOIN_SCRIPT_PATH="/lxa_k8s/join.sh"
KUBECONFIG_SRC="/lxa_k8s/kubeconfig"
KUBECONFIG_DEST="$HOME/.kube/config"
WAIT_INTERVAL=2

{% if worker_only %}
echo "=== Preparing Join Command ==="
TOKEN="{{ k3s_token }}"
MASTER_IP="{{ master_address }}"
JOIN_CMD="curl -sfL https://get.k3s.io | {% if k3s_version %}INSTALL_K3S_VERSION={{ k3s_version }}{% endif %} sh -s - agent --token=${TOKEN} --server https://${MASTER_IP}:6443 {{ other_flags }}" 
echo "$JOIN_CMD" > /lxa_k8s/join.sh
chmod +x /lxa_k8s/join.sh
echo "$JOIN_CMD"
{% endif %}

# ===== Functions =====
wait_for_join_script() {
    echo "=== Waiting for join script from master ==="
    while [ ! -f "$JOIN_SCRIPT_PATH" ]; do
        echo "waiting..."
        sleep "$WAIT_INTERVAL"
    done
}

wait_for_kubeconfig() {
    echo "=== Waiting for kubeconfig from master ==="
    while [ ! -f "$KUBECONFIG_SRC" ]; do
        echo "waiting..."
        sleep "$WAIT_INTERVAL"
    done
}

setup_k3s_config() {
    echo "=== Setting up k3s config ==="
    sudo mkdir -p /etc/rancher/k3s
    sudo tee /etc/rancher/k3s/config.yaml > /dev/null <<EOF
node-name: $HOSTNAME
EOF
}

setup_kubeconfig() {
    mkdir -p "$(dirname "$KUBECONFIG_DEST")"
    cp "$KUBECONFIG_SRC" "$KUBECONFIG_DEST"
}

run_join_script() {
    bash "$JOIN_SCRIPT_PATH"
}

# ===== Main =====
{% if not worker_only or (worker_only and kubeconfig_path not in ["", "None"]) %}
wait_for_kubeconfig
setup_kubeconfig
{% endif %}
setup_k3s_config
wait_for_join_script
run_join_script
