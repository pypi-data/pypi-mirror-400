name: Build and Deploy to PyPI

on:
    push:
        tags:
            - "v*"
    release:
        types: [published]
    workflow_dispatch: # Allow manual triggering

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        environment:
            name: pypi
            url: https://pypi.org/p/simde-py
        permissions:
            id-token: write # For trusted publishing
            contents: read

        steps:
            - name: Checkout code with submodules
              uses: actions/checkout@v6
              with:
                  submodules: recursive
                  fetch-depth: 0 # Full history for proper versioning

            - name: Set up Python
              uses: actions/setup-python@v6
              with:
                  python-version: "3.11"

            - name: Install build dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install build twine

            - name: Build source distribution
              run: |
                  python -m build --sdist

            - name: Check built distribution
              run: |
                  twine check dist/*
                  ls -la dist/

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
