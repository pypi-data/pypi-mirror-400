from pathlib import Path
import shutil, json
from typing import Any
import numpy as np


def mkdir(directory: str) -> bool:
    """
    Create a directory, ensuring parent directories exist.

    Args:
        directory (str): Path of the folder to be created.

    Returns:
        bool: True if creation was successful (or directory already exists).
    """

    # os.makedirs(directory, exist_ok=True)
    Path(directory).mkdir(parents=True, exist_ok=True)

    return True


def move_files(conf, protocol, label: str) -> None:
    """
    Move calculation output files to the conformer's specific folder.

    Identifies files generated by the calculator (based on label) and moves
    them to `conf_X/protocol_Y/`.

    Args:
        conf (Conformer): The conformer instance associated with the files.
        protocol (Protocol): The protocol instance defining the step.
        label (str): The calculator label used as a prefix/suffix for files.

    Returns:
        None
    """

    cwd = Path.cwd()
    files = [f for f in cwd.iterdir() if f.name.startswith(label)]
    dest_folder = cwd / conf.folder / f"protocol_{protocol.number}"
    mkdir(str(dest_folder))

    for file in files:
        dst = dest_folder / f"{conf.number}_p{protocol.number}_{file.name}"
        shutil.move(str(file), str(dst))


def tail(file_path: str, num_lines:int=100) -> str:
    """
    Read the last N lines of a file.

    Useful for extracting summary information from large log files.

    Args:
        file_path (str): Path to the file.
        num_lines (int, optional): Number of lines to read from the end. Defaults to 100.

    Returns:
        str: The tail of the file content as a single string.
    """

    with Path(file_path).open() as f:
        fl = f.readlines()

    return "".join(fl[-num_lines:])


class SerialiseEncoder(json.JSONEncoder):
    """
    Custom JSON Encoder for Ensemble Analyzer objects.

    Handles serialization of:
    - NumPy arrays (converted to lists).
    - Custom objects (via __dict__).
    """
    def default(self, obj) -> Any:
        """
        Override default serialization method.

        Args:
            obj (Any): The object to serialize.

        Returns:
            Any: JSON-serializable representation of the object.
        """
        if isinstance(obj, np.ndarray):
            return obj.tolist()
        return obj.__dict__