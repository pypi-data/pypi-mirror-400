"""cortex_db_version_1: Initial migration - auto-generated schema

Revision ID: c594bd42779a
Revises: 
Create Date: 2026-01-09 19:00:39.300401

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from cortex.core.types.databases import JSONType, ArrayType


# revision identifiers, used by Alembic.
revision: str = 'c594bd42779a'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('dashboards',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('environment_id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('type', sa.String(length=50), nullable=False),
    sa.Column('default_view', sa.String(length=255), nullable=False),
    sa.Column('tags', sa.JSON(), nullable=True),
    sa.Column('created_by', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.Column('last_viewed_at', sa.DateTime(), nullable=True),
    sa.Column('config', sa.JSON(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('dashboards', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_dashboards_environment_id'), ['environment_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_dashboards_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_dashboards_name'), ['name'], unique=False)

    op.create_table('query_history',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('metric_id', sa.UUID(), nullable=False),
    sa.Column('data_model_id', sa.UUID(), nullable=False),
    sa.Column('query', sa.Text(), nullable=False),
    sa.Column('parameters', sa.JSON(), nullable=True),
    sa.Column('context_id', sa.String(length=255), nullable=True),
    sa.Column('meta', sa.JSON(), nullable=True),
    sa.Column('cache_mode', sa.String(length=50), nullable=True),
    sa.Column('query_hash', sa.String(length=255), nullable=True),
    sa.Column('duration', sa.Float(), nullable=False),
    sa.Column('row_count', sa.Float(), nullable=True),
    sa.Column('success', sa.Boolean(), nullable=False),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('executed_at', sa.DateTime(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('query_history', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_query_history_cache_mode'), ['cache_mode'], unique=False)
        batch_op.create_index(batch_op.f('ix_query_history_context_id'), ['context_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_query_history_data_model_id'), ['data_model_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_query_history_executed_at'), ['executed_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_query_history_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_query_history_metric_id'), ['metric_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_query_history_query_hash'), ['query_hash'], unique=False)
        batch_op.create_index(batch_op.f('ix_query_history_success'), ['success'], unique=False)

    op.create_table('workspaces',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(), nullable=True),
    sa.Column('description', sa.String(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('workspaces', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_workspaces_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_workspaces_name'), ['name'], unique=False)

    op.create_table('environments',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('workspace_id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(), nullable=True),
    sa.Column('description', sa.String(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['workspace_id'], ['workspaces.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('environments', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_environments_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_environments_name'), ['name'], unique=False)
        batch_op.create_index(batch_op.f('ix_environments_workspace_id'), ['workspace_id'], unique=False)

    op.create_table('consumer_groups',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('environment_id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('description', sa.String(), nullable=True),
    sa.Column('alias', sa.String(), nullable=True),
    sa.Column('properties', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['environment_id'], ['environments.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('consumer_groups', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_consumer_groups_environment_id'), ['environment_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_consumer_groups_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_consumer_groups_name'), ['name'], unique=False)

    op.create_table('consumers',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('environment_id', sa.UUID(), nullable=False),
    sa.Column('first_name', sa.String(), nullable=False),
    sa.Column('last_name', sa.String(), nullable=False),
    sa.Column('email', sa.String(), nullable=False),
    sa.Column('organization', sa.String(), nullable=True),
    sa.Column('properties', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['environment_id'], ['environments.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('consumers', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_consumers_email'), ['email'], unique=False)
        batch_op.create_index(batch_op.f('ix_consumers_environment_id'), ['environment_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_consumers_id'), ['id'], unique=False)

    op.create_table('data_models',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('environment_id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('alias', sa.String(), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('version', sa.Integer(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('parent_version_id', sa.UUID(), nullable=True),
    sa.Column('config', JSONType(), nullable=False),
    sa.Column('is_valid', sa.Boolean(), nullable=False),
    sa.Column('validation_errors', ArrayType(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['environment_id'], ['environments.id'], ),
    sa.ForeignKeyConstraint(['parent_version_id'], ['data_models.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('data_models', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_data_models_alias'), ['alias'], unique=False)
        batch_op.create_index(batch_op.f('ix_data_models_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_data_models_environment_id'), ['environment_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_data_models_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_data_models_is_active'), ['is_active'], unique=False)
        batch_op.create_index(batch_op.f('ix_data_models_is_valid'), ['is_valid'], unique=False)
        batch_op.create_index(batch_op.f('ix_data_models_name'), ['name'], unique=False)

    op.create_table('data_sources',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('environment_id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('alias', sa.String(), nullable=True),
    sa.Column('description', sa.String(), nullable=True),
    sa.Column('source_catalog', sa.String(), nullable=False),
    sa.Column('source_type', sa.String(), nullable=False),
    sa.Column('config', JSONType(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['environment_id'], ['environments.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('data_sources', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_data_sources_environment_id'), ['environment_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_data_sources_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_data_sources_name'), ['name'], unique=False)

    op.create_table('consumer_group_members',
    sa.Column('consumer_id', sa.UUID(), nullable=False),
    sa.Column('group_id', sa.UUID(), nullable=False),
    sa.ForeignKeyConstraint(['consumer_id'], ['consumers.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['group_id'], ['consumer_groups.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('consumer_id', 'group_id')
    )
    op.create_table('metrics',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('environment_id', sa.UUID(), nullable=False),
    sa.Column('data_model_id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('alias', sa.String(), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('title', sa.String(), nullable=True),
    sa.Column('query', sa.Text(), nullable=True),
    sa.Column('table_name', sa.String(), nullable=True),
    sa.Column('data_source_id', sa.UUID(), nullable=True),
    sa.Column('limit', sa.Integer(), nullable=True),
    sa.Column('grouped', sa.Boolean(), nullable=True),
    sa.Column('ordered', sa.Boolean(), nullable=True),
    sa.Column('measures', JSONType(), nullable=True),
    sa.Column('dimensions', JSONType(), nullable=True),
    sa.Column('joins', JSONType(), nullable=True),
    sa.Column('aggregations', JSONType(), nullable=True),
    sa.Column('filters', JSONType(), nullable=True),
    sa.Column('order', JSONType(), nullable=True),
    sa.Column('parameters', JSONType(), nullable=True),
    sa.Column('version', sa.Integer(), nullable=False),
    sa.Column('extends', sa.UUID(), nullable=True),
    sa.Column('public', sa.Boolean(), nullable=False),
    sa.Column('refresh', JSONType(), nullable=True),
    sa.Column('cache', JSONType(), nullable=True),
    sa.Column('meta', JSONType(), nullable=True),
    sa.Column('is_valid', sa.Boolean(), nullable=False),
    sa.Column('validation_errors', ArrayType(), nullable=True),
    sa.Column('compiled_query', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['data_model_id'], ['data_models.id'], ),
    sa.ForeignKeyConstraint(['data_source_id'], ['data_sources.id'], ),
    sa.ForeignKeyConstraint(['environment_id'], ['environments.id'], ),
    sa.ForeignKeyConstraint(['extends'], ['metrics.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('metrics', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_metrics_alias'), ['alias'], unique=False)
        batch_op.create_index(batch_op.f('ix_metrics_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_metrics_data_model_id'), ['data_model_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_metrics_data_source_id'), ['data_source_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_metrics_environment_id'), ['environment_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_metrics_extends'), ['extends'], unique=False)
        batch_op.create_index(batch_op.f('ix_metrics_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_metrics_is_valid'), ['is_valid'], unique=False)
        batch_op.create_index(batch_op.f('ix_metrics_name'), ['name'], unique=False)
        batch_op.create_index(batch_op.f('ix_metrics_public'), ['public'], unique=False)

    op.create_table('model_versions',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('data_model_id', sa.UUID(), nullable=False),
    sa.Column('version_number', sa.Integer(), nullable=False),
    sa.Column('semantic_model', JSONType(), nullable=False),
    sa.Column('is_valid', sa.Boolean(), nullable=False),
    sa.Column('validation_errors', ArrayType(), nullable=True),
    sa.Column('compiled_queries', JSONType(), nullable=True),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('created_by', sa.UUID(), nullable=True),
    sa.Column('tags', ArrayType(), nullable=True),
    sa.Column('config', JSONType(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['data_model_id'], ['data_models.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('model_versions', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_model_versions_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_model_versions_data_model_id'), ['data_model_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_model_versions_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_model_versions_version_number'), ['version_number'], unique=False)

    op.create_table('metric_versions',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('metric_id', sa.UUID(), nullable=False),
    sa.Column('version_number', sa.Integer(), nullable=False),
    sa.Column('snapshot_data', JSONType(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('created_by', sa.UUID(), nullable=True),
    sa.Column('tags', ArrayType(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['metric_id'], ['metrics.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('metric_versions', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_metric_versions_created_at'), ['created_at'], unique=False)
        batch_op.create_index(batch_op.f('ix_metric_versions_id'), ['id'], unique=False)
        batch_op.create_index(batch_op.f('ix_metric_versions_metric_id'), ['metric_id'], unique=False)
        batch_op.create_index(batch_op.f('ix_metric_versions_version_number'), ['version_number'], unique=False)

    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('metric_versions', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_metric_versions_version_number'))
        batch_op.drop_index(batch_op.f('ix_metric_versions_metric_id'))
        batch_op.drop_index(batch_op.f('ix_metric_versions_id'))
        batch_op.drop_index(batch_op.f('ix_metric_versions_created_at'))

    op.drop_table('metric_versions')
    with op.batch_alter_table('model_versions', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_model_versions_version_number'))
        batch_op.drop_index(batch_op.f('ix_model_versions_id'))
        batch_op.drop_index(batch_op.f('ix_model_versions_data_model_id'))
        batch_op.drop_index(batch_op.f('ix_model_versions_created_at'))

    op.drop_table('model_versions')
    with op.batch_alter_table('metrics', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_metrics_public'))
        batch_op.drop_index(batch_op.f('ix_metrics_name'))
        batch_op.drop_index(batch_op.f('ix_metrics_is_valid'))
        batch_op.drop_index(batch_op.f('ix_metrics_id'))
        batch_op.drop_index(batch_op.f('ix_metrics_extends'))
        batch_op.drop_index(batch_op.f('ix_metrics_environment_id'))
        batch_op.drop_index(batch_op.f('ix_metrics_data_source_id'))
        batch_op.drop_index(batch_op.f('ix_metrics_data_model_id'))
        batch_op.drop_index(batch_op.f('ix_metrics_created_at'))
        batch_op.drop_index(batch_op.f('ix_metrics_alias'))

    op.drop_table('metrics')
    op.drop_table('consumer_group_members')
    with op.batch_alter_table('data_sources', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_data_sources_name'))
        batch_op.drop_index(batch_op.f('ix_data_sources_id'))
        batch_op.drop_index(batch_op.f('ix_data_sources_environment_id'))

    op.drop_table('data_sources')
    with op.batch_alter_table('data_models', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_data_models_name'))
        batch_op.drop_index(batch_op.f('ix_data_models_is_valid'))
        batch_op.drop_index(batch_op.f('ix_data_models_is_active'))
        batch_op.drop_index(batch_op.f('ix_data_models_id'))
        batch_op.drop_index(batch_op.f('ix_data_models_environment_id'))
        batch_op.drop_index(batch_op.f('ix_data_models_created_at'))
        batch_op.drop_index(batch_op.f('ix_data_models_alias'))

    op.drop_table('data_models')
    with op.batch_alter_table('consumers', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_consumers_id'))
        batch_op.drop_index(batch_op.f('ix_consumers_environment_id'))
        batch_op.drop_index(batch_op.f('ix_consumers_email'))

    op.drop_table('consumers')
    with op.batch_alter_table('consumer_groups', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_consumer_groups_name'))
        batch_op.drop_index(batch_op.f('ix_consumer_groups_id'))
        batch_op.drop_index(batch_op.f('ix_consumer_groups_environment_id'))

    op.drop_table('consumer_groups')
    with op.batch_alter_table('environments', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_environments_workspace_id'))
        batch_op.drop_index(batch_op.f('ix_environments_name'))
        batch_op.drop_index(batch_op.f('ix_environments_id'))

    op.drop_table('environments')
    with op.batch_alter_table('workspaces', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_workspaces_name'))
        batch_op.drop_index(batch_op.f('ix_workspaces_id'))

    op.drop_table('workspaces')
    with op.batch_alter_table('query_history', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_query_history_success'))
        batch_op.drop_index(batch_op.f('ix_query_history_query_hash'))
        batch_op.drop_index(batch_op.f('ix_query_history_metric_id'))
        batch_op.drop_index(batch_op.f('ix_query_history_id'))
        batch_op.drop_index(batch_op.f('ix_query_history_executed_at'))
        batch_op.drop_index(batch_op.f('ix_query_history_data_model_id'))
        batch_op.drop_index(batch_op.f('ix_query_history_context_id'))
        batch_op.drop_index(batch_op.f('ix_query_history_cache_mode'))

    op.drop_table('query_history')
    with op.batch_alter_table('dashboards', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_dashboards_name'))
        batch_op.drop_index(batch_op.f('ix_dashboards_id'))
        batch_op.drop_index(batch_op.f('ix_dashboards_environment_id'))

    op.drop_table('dashboards')
    # ### end Alembic commands ###
