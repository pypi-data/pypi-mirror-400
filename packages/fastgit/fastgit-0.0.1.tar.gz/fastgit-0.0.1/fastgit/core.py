"""Implementation of fastgit"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/00_core.ipynb.

# %% auto 0
__all__ = ['callgit', 'get_top', 'Git']

# %% ../nbs/00_core.ipynb 3
from fastcore.utils import *
import subprocess
from subprocess import CalledProcessError
import shutil,stat

# %% ../nbs/00_core.ipynb 5
def callgit(path, *args, split=None, uname=None):
    fp = Path(path).resolve()
    args = ['git', '-C', str(fp)] + list(args)
    if uname: args = ['/usr/bin/sudo', '-u', uname] + args
    res = subprocess.run(args, capture_output=True, text=True, check=True).stdout.strip()
    if split is None: return res.splitlines() if '\n' in res else res
    return res.splitlines() if split else res

# %% ../nbs/00_core.ipynb 6
def get_top(folder):
    try: return callgit(folder, 'rev-parse', '--show-toplevel')
    except CalledProcessError: return None

# %% ../nbs/00_core.ipynb 9
class Git:
    def __init__(self, d): self.d = Path(d)

    def __call__(self, cmd, *args, split=None, mute_errors=False, **kwargs):
        args = listify(args)
        args += concat((f'-{k}',v) for k,v in kwargs.items() if len(k)==1)
        args += [f'--{k}={v}' for k,v in kwargs.items() if len(k)>1]
        try: return callgit(self.d, cmd, *args, split=split)
        except CalledProcessError as e: 
            if not mute_errors: print(f'ERROR: Git.__call__ caught exception {e} \n with stderr={e.stderr}')

    def __getattr__(self, nm):
        if nm.startswith('_'): raise AttributeError(nm)
        return partial(self, nm.replace('_','-'))

    def top(self): return self.rev_parse('--show-toplevel', mute_errors=True)
    
    @property
    def exists(self): return self.top() is not None

# %% ../nbs/00_core.ipynb 11
@patch(as_prop=True)
def last_commit(self:Git): return self.log('-1', pretty='format:%s')
