import{c as H,r as u,j as e,L as J,p as _,I as F,x as M,Y as Q,a8 as $,b as A,Z as X,_ as ee,$ as R,ac as q,t as v,A as se,v as te,w as ae,y as re,C as U,g as C,q as ne,z as ie}from"./index-D87ilqMg.js";import{a as le,c as oe,u as ce,d as de,e as me,f as fe}from"./useWorkflows-DOUPJgnh.js";import{g as pe}from"./comfy-hqZb5pXy.js";import{S as he}from"./save-BbL542gH.js";import{S as ue}from"./settings-2-D-cav7o9.js";import{E as V}from"./eye-B6DXG3sW.js";import{E as Z,F as B}from"./file-json-DUo8Cyr4.js";import{R as xe}from"./refresh-cw-kkw2GHsq.js";import{T as ge}from"./trash-2-CTOpWkMI.js";const je=[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]],we=H("bot",je);const be=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],ye=H("upload",be);function Ne({workflowId:I}){const{data:a,isLoading:g}=le(I),j=oe(),[l,y]=u.useState(""),[w,k]=u.useState(""),[i,m]=u.useState(!0),[x,b]=u.useState([]),[f,O]=u.useState(null);u.useEffect(()=>{pe().then(O).catch(console.error)},[]),u.useEffect(()=>{if(a){y(a.name),k(a.description||""),m(a.is_active??!0);const r=a.meta?.exposed_inputs;if(Array.isArray(r))b(r);else if(r&&typeof r=="object"){const o=[];Object.entries(r).forEach(([c,t])=>{Object.entries(t).forEach(([s,d])=>{o.push({node_id:c,field:s,type:d.type||"string",label:s,description:d.description,enabled:!0,mcp_enabled:!0,zen_enabled:!1,order:o.length})})}),b(o)}else b([])}},[a]);const E=async()=>{if(a)try{await j.mutateAsync({id:a.id,data:{name:l,description:w,is_active:i,meta:{...a.meta,exposed_inputs:x}}}),v.success("Workflow saved")}catch{v.error("Failed to save workflow")}},W=u.useMemo(()=>{if(!a?.data)return[];if("nodes"in a.data&&Array.isArray(a.data.nodes)){const o={};"definitions"in a.data&&a.data.definitions?.subgraphs&&a.data.definitions.subgraphs.forEach(t=>{const s={};t.inputs&&t.inputs.forEach(d=>{s[d.name]=[d.type||"STRING",{}]}),o[t.id]={input:{required:s},output:(t.outputs||[]).map(d=>d.type),display_name:t.name}});const c={...f||{},...o};return a.data.nodes.map(t=>{const s={};if(c[t.type]){const d=c[t.type],h=d.input?.required||{},Y=d.input?.optional||{},K={...h,...Y},P=new Set;t.inputs&&t.inputs.forEach(N=>{N.link&&P.add(N.name)});const D=t.widgets_values||[],T=t.properties?.proxyWidgets;if(T&&Array.isArray(T))T.forEach((N,S)=>{const p=N[1];S<D.length?s[p]=D[S]:p==="seed"||p==="noise_seed"?s[p]=0:p==="steps"?s[p]=20:p==="cfg"?s[p]=8:p==="control_after_generate"?s[p]="randomize":s[p]=""});else{let N=0;Object.entries(K).forEach(([S,p])=>{const z=Array.isArray(p)?p[0]:p;let L=!1;(Array.isArray(z)||typeof z=="string"&&["INT","FLOAT","STRING","BOOLEAN"].includes(z))&&(L=!0),P.has(S)||L&&N<D.length&&(s[S]=D[N],N++),(S==="seed"||S==="noise_seed")&&N++})}}return{id:String(t.id),title:t.title||c[t.type]?.display_name||t.type,class_type:t.type,inputs:s,isStandard:!0}})}const r=a.data;return Object.entries(r).map(([o,c])=>({id:o,...c,title:c._meta?.title||c.class_type}))},[a?.data,f]),n=(r,o,c,t)=>{b(s=>{const d=s.findIndex(h=>h.node_id===r&&h.field===o);if(d>=0){const h=[...s];return h[d]={...h[d],...c},h}else{let h=typeof t;return(o==="image_url"||o==="image")&&(h="image"),o==="image_id"&&(h="image_id"),[...s,{node_id:r,field:o,type:h,label:o,description:"",enabled:!1,mcp_enabled:!1,order:s.length,zen_enabled:!1,...c}]}})};return g?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(J,{className:"w-8 h-8 animate-spin text-muted-foreground"})}):a?e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b bg-card flex items-start justify-between gap-4 shrink-0",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{htmlFor:"wf-name",className:"sr-only",children:"Name"}),e.jsx(F,{id:"wf-name",value:l,onChange:r=>y(r.target.value),className:"text-lg font-semibold h-auto py-1 px-2 -ml-2 border-transparent hover:border-input focus:border-input transition-colors"}),"nodes"in(a.data||{})&&e.jsx(M,{variant:"secondary",className:"ml-2",children:"Standard Format"})]}),e.jsx(Q,{value:w,onChange:r=>k(r.target.value),placeholder:"Add a description...",className:"resize-none h-16 text-sm text-muted-foreground min-h-[60px]"})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(_,{htmlFor:"is-active",className:"text-sm text-muted-foreground",children:"Active"}),e.jsx($,{id:"is-active",checked:i,onCheckedChange:m})]}),e.jsxs(A,{onClick:E,disabled:j.isPending,children:[j.isPending?e.jsx(J,{className:"w-4 h-4 animate-spin mr-2"}):e.jsx(he,{className:"w-4 h-4 mr-2"}),"Save Changes"]})]})]}),e.jsxs(X,{defaultValue:"comfy",className:"flex-1 flex flex-col min-h-0",children:[e.jsx("div",{className:"px-4 pt-4 border-b bg-muted/10",children:e.jsxs(ee,{children:[e.jsxs(R,{value:"comfy",className:"gap-2",children:[e.jsx(ue,{className:"w-4 h-4"}),"ComfyUI Settings"]}),e.jsxs(R,{value:"mcp",className:"gap-2",children:[e.jsx(we,{className:"w-4 h-4"}),"MCP Settings"]})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:e.jsxs("div",{className:"max-w-3xl mx-auto space-y-6",children:[e.jsx(q,{value:"comfy",className:"mt-0 space-y-4",children:e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium mb-2",children:"ComfyUI Inputs"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Select which inputs should be exposed in the Generation UI."}),e.jsx(G,{nodes:W,exposedInputs:x,onUpdate:n,mode:"comfy"})]})}),e.jsx(q,{value:"mcp",className:"mt-0 space-y-4",children:e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium mb-2",children:"MCP Inputs"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Select which inputs should be exposed to the AI Agent. Add descriptions to help the agent understand what each input controls."}),e.jsx(G,{nodes:W,exposedInputs:x,onUpdate:n,mode:"mcp"})]})})]})})]})]}):null}function G({nodes:I,exposedInputs:a,onUpdate:g,mode:j}){return e.jsx(se,{type:"multiple",className:"w-full space-y-2",children:I.map(l=>{const y=Object.keys(l.inputs||{}).length>0;if(l.isStandard&&!y)return null;const w=Object.entries(l.inputs||{}).filter(([i,m])=>!Array.isArray(m)&&typeof m!="object");if(w.length===0)return null;const k=a.filter(i=>i.node_id===l.id&&(j==="comfy"?i.enabled:i.mcp_enabled)).length;return e.jsxs(te,{value:l.id,className:"border px-4 bg-card border-b!",children:[e.jsx(ae,{className:"hover:no-underline py-3",children:e.jsxs("div",{className:"flex items-center gap-3 flex-1 text-left",children:[e.jsx("span",{className:"font-medium",children:l.title}),e.jsxs(M,{variant:"outline",className:"text-xs font-normal text-muted-foreground",children:["ID: ",l.id]}),k>0&&e.jsxs(M,{variant:"secondary",className:"ml-auto mr-4",children:[k," exposed"]})]})}),e.jsx(re,{className:"pt-2 pb-4 space-y-4",children:w.map(([i,m])=>{const x=a.find(f=>f.node_id===l.id&&f.field===i),b=j==="comfy"?x?.enabled:x?.mcp_enabled;return e.jsxs("div",{className:"flex items-start gap-4 p-3 border bg-background/50",children:[e.jsx("div",{className:"pt-1",children:e.jsx($,{checked:!!b,onCheckedChange:f=>g(l.id,i,{[j==="comfy"?"enabled":"mcp_enabled"]:f},m)})}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(_,{className:"font-medium",children:i}),e.jsxs("span",{className:"text-xs text-muted-foreground font-mono truncate max-w-[200px]",children:["Current: ",String(m)]})]}),b&&e.jsx("div",{className:"animate-in fade-in slide-in-from-top-2 duration-200",children:j==="comfy"?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(_,{className:"text-xs text-muted-foreground",children:"Label"}),e.jsx(F,{placeholder:"Label in UI",value:x?.label||i,onChange:f=>g(l.id,i,{label:f.target.value},m),className:"h-8 text-sm"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx($,{id:`zen-${l.id}-${i}`,checked:!!x?.zen_enabled,onCheckedChange:f=>g(l.id,i,{zen_enabled:f},m)}),e.jsx(_,{htmlFor:`zen-${l.id}-${i}`,className:"text-xs text-muted-foreground",children:"Show in Zen Mode"})]})]}):e.jsxs("div",{className:"space-y-1",children:[e.jsx(_,{className:"text-xs text-muted-foreground",children:"Description for AI"}),e.jsx(F,{placeholder:`Describe what '${i}' controls...`,value:x?.description||"",onChange:f=>g(l.id,i,{description:f.target.value},m),className:"h-8 text-sm"})]})})]}),e.jsx("div",{className:"pt-1 text-muted-foreground",children:b?e.jsx(V,{className:"w-4 h-4"}):e.jsx(Z,{className:"w-4 h-4 opacity-20"})})]},i)})})]},l.id)})})}const ve=()=>{const{data:I,isLoading:a}=ce(),g=de(),j=me(),l=fe(),[y,w]=u.useState(null),[k,i]=u.useState(!1),[m,x]=u.useState(!1),b=async()=>{try{await l.mutateAsync(),v.success("Workflows synced from disk")}catch{v.error("Failed to sync workflows")}},f=u.useCallback(n=>{n.preventDefault(),i(!0)},[]),O=u.useCallback(n=>{n.preventDefault(),i(!1)},[]),E=u.useCallback(async n=>{n.preventDefault(),i(!1);const o=Array.from(n.dataTransfer.files).find(c=>c.type==="application/json"||c.name.endsWith(".json"));if(o){const c=new FileReader;c.onload=async t=>{try{const s=JSON.parse(t.target?.result);if(typeof s!="object")throw new Error("Invalid JSON");const d=o.name.replace(".json",""),h=await g.mutateAsync({name:d,data:s,description:"Imported via drag and drop"});v.success(`Imported workflow: ${d}`),w(h.id.toString())}catch(s){console.error(s),v.error("Failed to parse workflow JSON")}},c.readAsText(o)}},[g]),W=async(n,r)=>{n.stopPropagation(),confirm("Are you sure you want to delete this workflow?")&&(await j.mutateAsync(r),v.success("Workflow deleted"),y===r.toString()&&w(null))};return e.jsxs("div",{className:"p-1 w-full grid grid-cols-4 grid-rows-[auto_1fr] md:grid-rows-[1fr] gap-1 h-full overflow-visible",children:[e.jsx("div",{className:"col-span-4 md:col-span-1 shrink-0! overflow-visible h-auto md:h-full border-none ring-0! shadow-none bg-transparent p-0! min-h-0 gap-1",children:e.jsxs(U,{className:"flex-1 h-auto md:h-full p-0! gap-0! shrink-0 flex flex-col overflow-visible min-h-0",children:[e.jsxs("div",{className:"flex items-center justify-between shrink-0 border-b border-foreground/10 p-2 bg-muted/35",children:[e.jsx("span",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wider",children:"Workflows"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(A,{size:"icon-sm",variant:"ghost",className:"h-6 w-6",onClick:b,title:"Sync from Disk",disabled:l.isPending,children:e.jsx(xe,{className:C("h-3.5 w-3.5",l.isPending&&"animate-spin")})}),e.jsx(A,{size:"icon-sm",variant:"ghost",className:C("h-6 w-6",m&&"text-primary"),onClick:()=>x(!m),title:m?"Hide disabled workflows":"Show disabled workflows",children:m?e.jsx(V,{className:"w-4 h-4"}):e.jsx(Z,{className:"w-4 h-4"})}),e.jsx(A,{size:"icon-sm",variant:"ghost",className:"h-6 w-6",onClick:()=>document.getElementById("workflow-upload")?.click(),children:e.jsx(ne,{className:"w-4 h-4"})}),e.jsx("input",{id:"workflow-upload",type:"file",accept:".json",className:"hidden",onChange:n=>{const r=n.target.files?.[0];if(r){const o=new FileReader;o.onload=async c=>{try{const t=JSON.parse(c.target?.result),s=r.name.replace(".json",""),d=await g.mutateAsync({name:s,data:t,description:"Imported from file"});v.success(`Imported workflow: ${s}`),w(d.id.toString())}catch{v.error("Failed to parse workflow JSON")}},o.readAsText(r)}}})]})]}),e.jsx("div",{className:"p-2 flex flex-row space-x-2 space-y-0 md:flex-col md:space-y-2 md:space-x-0 w-full max-w-full",children:a?e.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"Loading..."}):I?.length===0?e.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"No workflows found."}):I?.filter(n=>m||n.is_active!==!1).map(n=>e.jsxs("div",{className:C("group flex items-center justify-between p-2 cursor-pointer hover:bg-accent/50 transition-colors border bg-card w-full max-w-full overflow-hidden",y===n.id.toString()?"bg-accent text-accent-foreground border-accent":"text-muted-foreground border hover:border-border"),onClick:()=>w(n.id.toString()),children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[e.jsx(B,{className:C("w-4 h-4 shrink-0",!n.is_active&&"opacity-50")}),e.jsx("span",{className:C("truncate text-sm font-medium",!n.is_active&&"opacity-50"),children:n.name})]}),e.jsx(A,{variant:"ghost",size:"icon-sm",className:"opacity-0 group-hover:opacity-100 h-6 w-6 shrink-0 hover:bg-destructive/10 hover:text-destructive ml-2",onClick:r=>W(r,n.id),children:e.jsx(ge,{className:"w-3 h-3"})})]},n.id))})]})}),e.jsx(U,{className:"col-span-4 md:col-span-3 flex grow flex-col overflow-hidden h-full border-none ring-0! shadow-none bg-transparent p-0! min-h-0",children:e.jsx("div",{className:"h-full flex flex-col w-full! min-h-0 gap-1! space-y-0!",children:e.jsxs("div",{className:`flex-1 m-0 overflow-y-auto border border-foreground/10 bg-card relative flex flex-col ${k?"bg-primary/5":""}`,onDragOver:f,onDragLeave:O,onDrop:E,children:[k&&e.jsx("div",{className:"absolute inset-0 z-50 flex items-center justify-center bg-background/80 backdrop-blur-sm border-2 border-dashed border-primary m-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ye,{className:"w-12 h-12 mx-auto text-primary mb-4"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Drop Workflow JSON here"})]})}),e.jsx(ie,{className:"h-full pl-1 pr-4",variant:"left-border",type:"always",children:y?e.jsx("div",{className:"p-1",children:e.jsx(Ne,{workflowId:parseInt(y)})}):e.jsxs("div",{className:"flex h-full flex-col items-center justify-center text-muted-foreground p-8 text-center min-h-[400px]",children:[e.jsx(B,{className:"w-16 h-16 mb-4 opacity-20"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No Workflow Selected"}),e.jsx("p",{className:"max-w-sm",children:"Select a workflow from the sidebar or drag and drop a ComfyUI JSON file here to get started."})]})})]})})})]})},Ee=ve;export{Ee as component};
