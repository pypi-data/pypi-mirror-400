"use strict";(self.webpackChunkjupyterlab_unicore_shell=self.webpackChunkjupyterlab_unicore_shell||[]).push([[92],{92:(e,t,s)=>{s.r(t),s.d(t,{default:()=>b});var i=s(827),n=s(366),o=s(409),r=s(223),a=s(292),l=s(907);async function c(e="",t={}){const s=l.ServerConnection.makeSettings(),i=a.URLExt.join(s.baseUrl,"jupyterlabunicoreshell",e);let n;try{n=await l.ServerConnection.makeRequest(i,t,s)}catch(e){throw new l.ServerConnection.NetworkError(e)}let o=await n.text();if(o.length>0)try{o=JSON.parse(o)}catch(e){console.log("Not a JSON response body.",n)}if(!n.ok)throw new l.ServerConnection.ResponseError(n,o.message||o);return o}async function h(e){try{await c(e,{method:"DELETE"})}catch(e){throw console.error(`UNICORE ReverseShell: Could not delete shell.\n${e}`),new Error(`Failed to delete shell\n${e}`)}}var d,m=s(591),u=s(262),p=s(209),_=s(230),y=s(247),g=s(690);class f extends l.TerminalManager{constructor(){const e=l.ServerConnection.makeSettings();super({serverSettings:l.ServerConnection.makeSettings({baseUrl:a.URLExt.join(e.baseUrl,"/remoteshell"),wsUrl:a.URLExt.join(e.wsUrl,"/remoteshell")})})}}class v extends y.Widget{constructor(e,t={},s){super(),this._needsResize=!0,this._offsetWidth=-1,this._offsetHeight=-1,this._isReady=!1,this._ready=new u.PromiseDelegate,this._shellTermReady=new u.PromiseDelegate,this._termOpened=!1,s=s||m.nullTranslator,this._trans=s.load("jupyterlab"),this._failed=!1,this._system=e,this._options={...g.ITerminal.defaultOptions,...t};const{theme:i,...n}=this._options,o={theme:d.getXTermTheme(i),...n};this.addClass("jp-Terminal"),this._setThemeAttribute(i),d.createTerminal(o).then((([t,s])=>{this._term=t,this._fitAddon=s,this._initializeTerm(),this.id="jp-Terminal-"+d.id++,this.title.label=this._trans.__(`Starting Terminal on ${e} ...`),this._isReady=!0,this.title.closable=!0,this._ready.resolve(),this.update(),this._term.write(`Setting up your terminal session on ${this._system} ...`),this._waitForTerminal(this._system)})).catch((e=>{console.error("Failed to create a terminal.\n",e),this._ready.reject(e)}))}onCloseRequest(e){super.onCloseRequest(e),this.dispose()}async createLateSession(){var e,t,s;const i=new f;this.session=await i.startNew({name:this._system}),null===(e=this.session)||void 0===e||e.messageReceived.connect(this._onMessage,this),"connected"===(null===(t=this.session)||void 0===t?void 0:t.connectionStatus)?this._initialConnection():null===(s=this.session)||void 0===s||s.connectionStatusChanged.connect(this._initialConnection,this)}printStatus(e){!1!==e.newline?(this._term.writeln(""),this._term.write(e.msg)):this._term.write(e.msg),!0===e.ready?this._shellTermReady.resolve():!0===e.failed&&(this._failed=!0,this._shellTermReady.resolve())}_startKeepAlive(){this.session&&setInterval((()=>{var e,t;if("connected"===(null===(e=this.session)||void 0===e?void 0:e.connectionStatus))try{null===(t=this.session)||void 0===t||t.send({type:"stdin",content:[""]})}catch(e){console.warn("Keepalive failed",e)}}),8e3)}_waitForTerminal(e){!function(e,t){const s=l.ServerConnection.makeSettings(),i=a.URLExt.join(s.baseUrl,"jupyterlabunicoreshell",e),n=new EventSource(i);n.onmessage=e=>{const s=JSON.parse(e.data);t(s),!0===s.ready&&n.close()},n.onerror=e=>{console.error(e),n.close()}}(e,(e=>this.printStatus(e)))}get ready(){return this._ready.promise}get shellTermReady(){return this._shellTermReady.promise}getOption(e){return this._options[e]}setOption(e,t){if("theme"===e||this._options[e]!==t&&"initialCommand"!==e){switch(this._options[e]=t,e){case"fontFamily":this._term.options.fontFamily=t;break;case"fontSize":this._term.options.fontSize=t;break;case"lineHeight":this._term.options.lineHeight=t;break;case"screenReaderMode":this._term.options.screenReaderMode=t;break;case"scrollback":this._term.options.scrollback=t;break;case"theme":this._term.options.theme={...d.getXTermTheme(t)},this._setThemeAttribute(t);break;case"macOptionIsMeta":this._term.options.macOptionIsMeta=t}this._needsResize=!0,this.update()}}dispose(){var e,t;(null===(e=this.session)||void 0===e?void 0:e.isDisposed)||this.getOption("shutdownOnClose")&&(null===(t=this.session)||void 0===t||t.shutdown().catch((e=>{console.error(`Terminal not shut down: ${e}`)}))),this.ready.then((()=>{this._term.dispose()})),super.dispose()}async refresh(){var e;!this.isDisposed&&this._isReady&&(await(null===(e=this.session)||void 0===e?void 0:e.reconnect()),this._term.clear())}hasSelection(){return!(this.isDisposed||!this._isReady)&&this._term.hasSelection()}paste(e){if(!this.isDisposed&&this._isReady)return this._term.paste(e)}getSelection(){return!this.isDisposed&&this._isReady?this._term.getSelection():null}processMessage(e){super.processMessage(e),"fit-request"===e.type&&this.onFitRequest(e)}onAfterAttach(e){this.update()}onAfterShow(e){this.update()}onResize(e){this._offsetWidth=e.width,this._offsetHeight=e.height,this._needsResize=!0,this.update()}onUpdateRequest(e){var t;this.isVisible&&this.isAttached&&this._isReady&&(this._termOpened||(this._term.open(this.node),null===(t=this._term.element)||void 0===t||t.classList.add("jp-Terminal-body"),this._termOpened=!0),this._needsResize&&this._resizeTerminal())}onFitRequest(e){const t=y.Widget.ResizeMessage.UnknownSize;_.MessageLoop.sendMessage(this,t)}onActivateRequest(e){var t;null===(t=this._term)||void 0===t||t.focus()}_initialConnection(){var e,t,s;this.isDisposed||"connected"===(null===(e=this.session)||void 0===e?void 0:e.connectionStatus)&&(this._term.write(" done"),this._term.writeln(""),this._term.writeln(`--- You are now connected to ${this._system} ---`),this.title.label=this._trans.__("Terminal %1",this._system),this._setSessionSize(),this._options.initialCommand&&(null===(t=this.session)||void 0===t||t.send({type:"stdin",content:[this._options.initialCommand+"\r"]})),null===(s=this.session)||void 0===s||s.connectionStatusChanged.disconnect(this._initialConnection,this),this._startKeepAlive())}_initializeTerm(){const e=this._term;e.onData((e=>{var t;this.isDisposed||null===(t=this.session)||void 0===t||t.send({type:"stdin",content:[e]})})),e.onTitleChange((e=>{this.title.label=e})),p.Platform.IS_MAC||e.attachCustomKeyEventHandler((t=>!(t.ctrlKey&&"c"===t.key&&e.hasSelection()||t.ctrlKey&&"v"===t.key&&this._options.pasteWithCtrlV)))}_onMessage(e,t){switch(t.type){case"stdout":t.content&&this._term.write(t.content[0]);break;case"disconnect":this._term.write("\r\n\r\n[Finishedâ€¦ Term Session]\r\n")}}_resizeTerminal(){this._options.autoFit&&this._fitAddon.fit(),-1===this._offsetWidth&&(this._offsetWidth=this.node.offsetWidth),-1===this._offsetHeight&&(this._offsetHeight=this.node.offsetHeight),this._setSessionSize(),this._needsResize=!1}_setSessionSize(){var e;const t=[this._term.rows,this._term.cols,this._offsetHeight,this._offsetWidth];this.isDisposed||null===(e=this.session)||void 0===e||e.send({type:"set_size",content:t})}_setThemeAttribute(e){this.isDisposed||this.node.setAttribute("data-term-theme",e?e.toLowerCase():"inherit")}}!function(e){e.id=0,e.lightTheme={foreground:"#000",background:"#fff",cursor:"#616161",cursorAccent:"#F5F5F5",selectionBackground:"rgba(97, 97, 97, 0.3)",selectionInactiveBackground:"rgba(189, 189, 189, 0.3)"},e.darkTheme={foreground:"#fff",background:"#000",cursor:"#fff",cursorAccent:"#000",selectionBackground:"rgba(255, 255, 255, 0.3)",selectionInactiveBackground:"rgba(238, 238, 238, 0.3)"},e.inheritTheme=()=>({foreground:getComputedStyle(document.body).getPropertyValue("--jp-ui-font-color0").trim(),background:getComputedStyle(document.body).getPropertyValue("--jp-layout-color0").trim(),cursor:getComputedStyle(document.body).getPropertyValue("--jp-ui-font-color1").trim(),cursorAccent:getComputedStyle(document.body).getPropertyValue("--jp-ui-inverse-font-color0").trim(),selectionBackground:getComputedStyle(document.body).getPropertyValue("--jp-layout-color3").trim(),selectionInactiveBackground:getComputedStyle(document.body).getPropertyValue("--jp-layout-color2").trim()}),e.getXTermTheme=function(t){switch(t){case"light":return e.lightTheme;case"dark":return e.darkTheme;default:return e.inheritTheme()}}}(d||(d={})),function(e){let t,i,n,o,r=!1;function a(e){const t=new o;e.loadAddon(t),r&&t.onContextLoss((s=>{console.debug("WebGL context lost - reinitialize Xtermjs renderer."),t.dispose(),a(e)}))}e.createTerminal=async function(e){var l;if(!t){r=function(){const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");try{return t instanceof WebGLRenderingContext}catch(e){return!1}}();const[e,a,c,h]=await Promise.all([s.e(646).then(s.t.bind(s,646,23)),s.e(8).then(s.t.bind(s,8,23)),r?s.e(466).then(s.t.bind(s,466,23)):s.e(909).then(s.t.bind(s,909,23)),s.e(708).then(s.t.bind(s,708,23))]);t=e.Terminal,i=a.FitAddon,o=null!==(l=c.WebglAddon)&&void 0!==l?l:c.CanvasAddon,n=h.WebLinksAddon}const c=new t(e);a(c);const h=new i;return c.loadAddon(h),c.loadAddon(new n),[c,h]}}(d||(d={}));const w="UNICORE Terminals",b={id:"jupyterlab-unicore-shell:plugin",description:"A JupyterLab extension to add UNICORE reverse shells.",autoStart:!0,requires:[n.ILauncher,r.ISettingRegistry,i.IThemeManager],optional:[i.ICommandPalette],activate:async function(e,t,s,n,r,a){console.log("JupyterLab extension jupyterlab-unicore-shell is activated!");const{commands:l}=e,d=new i.WidgetTracker({namespace:"jupyterlabunicoreshell:terminals"}),m={};function u(e){const t=e.composite;for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&(m[e]=t[e])}function p(){d.forEach((e=>{Object.keys(m).forEach((t=>{const s=t;e.setOption(s,m[s])}))}))}n.themeChanged.connect((()=>{p()})),s.load("@jupyterlab/terminal-extension:plugin").then((e=>{u(e),p(),e.changed.connect((()=>{u(e),p()}))}));const _=await async function(){let e=[];try{e=await c()}catch(e){throw console.error(`UNICORE ReverseShell: Could not receive Systems.\n${e}`),new Error(`Failed to fetch systems\n${e}`)}return e}();for(const s of _){const i=`reverse-unicore-terminal-${s}:create`;l.addCommand(i,{label:s,caption:`Start terminal on ${s}`,icon:e=>e.isPalette?void 0:o.terminalIcon,execute:async t=>{console.log(`Start ${s} terminal`);for(const t of e.shell.widgets("main"))if(t.node.dataset.myCustomId===`${s.toLowerCase()}-terminal-001`){if(!(t instanceof v)){t.close();break}const s=e.shell.currentWidget;return s&&s.id.startsWith("launcher")&&s.close(),void e.shell.activateById(t.id)}const i=new v(s,m,a);i.title.icon=o.terminalIcon,i.id=`${s.toLowerCase()}-terminal-001`,i.node.dataset.myCustomId=`${s.toLowerCase()}-terminal-001`,i.disposed.connect((()=>{i.node.dataset.myCustomId=void 0,h(s).catch((e=>{console.log("Failed to remove job:",e)}))}));const n=e.shell.currentWidget;e.shell.add(i,"main"),n&&n.id.startsWith("launcher")&&n.close(),d.add(i),await i.shellTermReady,i._failed||await i.createLateSession()}}),t&&t.add({command:i,category:w,rank:1}),r&&r.addItem({command:i,args:{isPalette:!0},category:w})}e.restored.then((()=>{(async()=>{const e=await async function(){let e=[];try{e=await c("list_sessions")}catch(e){throw console.error(`UNICORE ReverseShell: Could not receive sessions.\n${e}`),new Error(`Failed to fetch systems\n${e}`)}return e}();for(const t of e){console.log(`Restore terminal for ${t}`);const e=`reverse-unicore-terminal-${t}:create`;l.hasCommand(e)?await l.execute(e):console.warn(`Command not found: ${e}`)}})()}))}}}}]);