import{u as W,r,p as Z,j as e,B as f,f as j,C as ee,g as te,q as se,s as ae}from"./index-CssG-3TH.js";import{T as P,L as A,C as re,c as le}from"./dialog-DZ78cEcj.js";import{S as ne,a as ie,b as oe,c as ce,d as T,A as F,e as L,f as O,g as $,h as _,i as H,j as M,k as R}from"./alert-dialog-B42XxGPR.js";import{C as de,a as he}from"./popover-DLsuV5Sx.js";function fe(){const s=W(),[p,z]=r.useState([]),[l,y]=r.useState(""),[o,d]=r.useState([]),[B,D]=r.useState(!1),[N,C]=r.useState(!1),[k,h]=r.useState(0),[S,x]=r.useState(0),[E,m]=r.useState(!1),[V,g]=r.useState(!1),[u,b]=r.useState(null),q=20;r.useEffect(()=>{(async()=>{try{const a=await te();z(a),a.length>0&&!l&&y(a[0].serial)}catch(a){console.error("Failed to load devices:",a)}})()},[l]);const v=r.useCallback(async(t,a=!0)=>{if(t)try{a?(D(!0),x(0)):C(!0);const n=a?0:S,i=await Z(t,q,n);d(a?i.records:c=>[...c,...i.records]),h(i.total),x(n+i.records.length)}catch(n){console.error("Failed to load history:",n)}finally{D(!1),C(!1)}},[S]);r.useEffect(()=>{l&&v(l,!0)},[l]);const I=()=>{l&&o.length<k&&v(l,!1)},X=async()=>{if(l){try{await se(l),d([]),h(0),x(0)}catch(t){console.error("Failed to clear history:",t)}m(!1)}},Y=async()=>{if(!(!l||!u)){try{await ae(l,u),d(t=>t.filter(a=>a.id!==u)),h(t=>t-1)}catch(t){console.error("Failed to delete record:",t)}g(!1),b(null)}},G=t=>t<1e3?`${t}ms`:t<6e4?`${(t/1e3).toFixed(1)}s`:`${(t/6e4).toFixed(1)}min`,J=t=>{const a=new Date(t),n=new Date,i=a.toDateString()===n.toDateString(),c=new Date(n);c.setDate(c.getDate()-1);const U=a.toDateString()===c.toDateString(),w=a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});return i?`${s.history.today} ${w}`:U?`${s.history.yesterday} ${w}`:a.toLocaleDateString("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},K=t=>({chat:s.historyPage.source.chat,layered:s.historyPage.source.layered,scheduled:s.historyPage.source.scheduled})[t]||t,Q=t=>{switch(t){case"chat":return"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300";case"layered":return"bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300";case"scheduled":return"bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300";default:return"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300"}};return e.jsxs("div",{className:"container mx-auto p-6 max-w-4xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold",children:s.historyPage.title}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(ne,{value:l,onValueChange:y,children:[e.jsx(ie,{className:"w-[200px]",children:e.jsx(oe,{placeholder:s.historyPage.selectDevice})}),e.jsx(ce,{children:p.length===0?e.jsx(T,{value:"_none",disabled:!0,children:s.historyPage.noDevices}):p.map(t=>e.jsx(T,{value:t.serial,children:t.model||t.serial},t.serial))})]}),o.length>0&&e.jsxs(f,{variant:"destructive",size:"sm",onClick:()=>m(!0),children:[e.jsx(P,{className:"w-4 h-4 mr-2"}),s.historyPage.clearAll]})]})]}),B?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(A,{className:"w-8 h-8 animate-spin text-slate-400"})}):o.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("p",{className:"text-slate-500 dark:text-slate-400",children:s.historyPage.noRecords}),e.jsx("p",{className:"text-sm text-slate-400 dark:text-slate-500 mt-2",children:s.historyPage.noRecordsDesc})]}):e.jsxs("div",{className:"space-y-4",children:[o.map(t=>e.jsx(re,{className:"hover:shadow-md transition-shadow",children:e.jsx(le,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-slate-900 dark:text-slate-100 line-clamp-2 mb-2",children:t.task_text}),e.jsx("p",{className:"text-sm text-slate-600 dark:text-slate-400 line-clamp-2 mb-3",children:t.final_message}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs",children:[t.success?e.jsxs(j,{variant:"outline",className:"text-green-600 border-green-300 dark:text-green-400 dark:border-green-700",children:[e.jsx(de,{className:"w-3 h-3 mr-1"}),s.historyPage.success]}):e.jsxs(j,{variant:"outline",className:"text-red-600 border-red-300 dark:text-red-400 dark:border-red-700",children:[e.jsx(he,{className:"w-3 h-3 mr-1"}),s.historyPage.failed]}),e.jsxs(j,{className:Q(t.source),children:[K(t.source),t.source_detail&&`: ${t.source_detail}`]}),t.steps>0&&e.jsx("span",{className:"text-slate-500 dark:text-slate-400",children:s.historyPage.steps.replace("{count}",String(t.steps))}),e.jsxs("span",{className:"text-slate-500 dark:text-slate-400 flex items-center",children:[e.jsx(ee,{className:"w-3 h-3 mr-1"}),G(t.duration_ms)]}),e.jsx("span",{className:"text-slate-400 dark:text-slate-500",children:J(t.start_time)})]})]}),e.jsx(f,{variant:"ghost",size:"sm",className:"text-slate-400 hover:text-red-500",onClick:()=>{b(t.id),g(!0)},children:e.jsx(P,{className:"w-4 h-4"})})]})})},t.id)),o.length<k&&e.jsx("div",{className:"text-center py-4",children:e.jsx(f,{variant:"outline",onClick:I,disabled:N,children:N?e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"w-4 h-4 mr-2 animate-spin"}),s.historyPage.loading]}):s.historyPage.loadMore})})]}),e.jsx(F,{open:E,onOpenChange:m,children:e.jsxs(L,{children:[e.jsxs(O,{children:[e.jsx($,{children:s.historyPage.clearAll}),e.jsx(_,{children:s.historyPage.clearAllConfirm})]}),e.jsxs(H,{children:[e.jsx(M,{children:s.common.cancel}),e.jsx(R,{onClick:X,children:s.common.confirm})]})]})}),e.jsx(F,{open:V,onOpenChange:g,children:e.jsxs(L,{children:[e.jsxs(O,{children:[e.jsx($,{children:s.common.delete}),e.jsx(_,{children:s.historyPage.deleteConfirm})]}),e.jsxs(H,{children:[e.jsx(M,{children:s.common.cancel}),e.jsx(R,{onClick:Y,children:s.common.confirm})]})]})})]})}export{fe as component};
