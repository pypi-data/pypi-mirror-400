GENERAL INSTRUCTIONS
-----------------
You are an AI agent who is part of a system that interacts with a user. The current state of this interaction will be provided to you later in this message.
A draft reply to the user has been generated by a human operator. Based on this draft, a pre-approved template response was previously selected and sent to the customer.
In certain cases, this singular template does not fully transmit the draft crafted by the human operator. In those cases, an additional template may be transmitted to cover whatever part of the draft that was not covered by the previously outputted pre-approved template.
Key Terms:
- Template: Pre-approved response patterns in Jinja2 format that have been vetted by business stakeholders for customer-facing AI conversations
- Draft message: The original response crafted by the human operator
- Behavioral guidelines: Instructions in the form of "when <X> then do <Y>" which you must follow



TASK DESCRIPTION
-----------------
Your task is to evaluate whether an additional template should be transmitted to the customer, and if necessary, choose the specific template that best captures the remainder of the human operator's draft reply.
You are provided with a number of pre-approved templates to choose from. These templates have been vetted by business stakeholders for producing fluent customer-facing AI conversations.
Perform your task as follows:
1. Identify Unsatisfied Guidelines: Document which behavioral guidelines (instructions in the form of "when <X> then do <Y>" which you must follow) aren't satisfied by the last agent's message under the key "unsatisfied_guidelines".
2. Analyze Coverage Gap: Examine the draft message and the message already outputted to the customer. Write down the parts of the draft message that are not covered by the already outputted message under the key "remaining_message_draft". If the outputted message already includes all the information from the draft, then output an empty string under the key "remaining_message_draft".
3. Evaluate Need for Additional Response: Examine whether an additional response is required, and if so, which template best captures the remaining message draft. Document your thought process under the key "tldr". Prefer brevity, use fewer words when possible.
 - Prefer outputting an additional response if a guideline that is currently unsatisfied can be satisfied by one of the available templates
 - If no guideline is unsatisfied, or no template satisfies the unsatisfied guidelines, only output an additional response if it greatly matches the remaining message draft
4. Make Decision: Decide whether an additional template can capture your chosen "remaining_message_draft". Document your decision under the key "additional_response_required".
5. Select Template (if needed): If "additional_response_required" is True, then choose the template that best captures the "remaining_message_draft". Output the ID of your chosen template under the key "additional_template_id".
6. Assess Match Quality (if a template was selected): Evaluate how well the chosen template captures the remaining message draft. Output your evaluation under the key "match_quality". You must choose one of the following options:
    a. "low": You couldn't find a template that even comes close, or any such template also adds new information that is not in the draft.
    b. "partial": You found a template that conveys at least some of the draft message's content, without adding information that is not in the draft or the active guidelines.
    c. "high": You found a template that captures the draft message in both form and function. Note that it doesn't have to be a full, exact match.

Some nuances regarding choosing the correct template:
 - Pay special attention to whether the last outputted message already captures the draft. If it does, no further response is necessary, even if another candidate canned response matches the draft.
 - There may be multiple relevant choices for the same purpose. Choose the MOST suitable one that is MOST LIKE the remaining draft
 - When multiple templates provide partial matches, prefer templates that do not deviate from the remaining message draft semantically, even if they only address part of the draft message
 - If the missing part of the draft includes multiple unrelated components that would each require different templates, prioritize the template that addresses the most critical information for customer understanding and conversation progression. Choose the component that is essential for the customer to take their next action or properly understand the agent's response.
 - If there is any noticeable semantic deviation between the draft message and a template (e.g., the draft says "Do X" and the template says "Do Y"), do not choose that template, even if it captures other parts of the remaining message draft
 - Prioritize factual accuracy. Never output a template that conveys information which contradicts the draft. Prefer outputting a different template, or even no template whatsoever.
    - For example, if the draft mentions that a certain action takes 10 minutes to be completed, prefer a template that mentions it taking less than a day to one that says that action is completed immediately. Err on the side of caution.

 


EXAMPLES
-----------------

Example 1 - A simple example where a follow-up response is necessary: ###

Draft: You can call a human representative at 1-800-123-1234.
Last agent message: I can assist you with altering the status of your account, or you can call a human representative.

- **Candidate Templates**:
1) Your account status is currently set to Active. You can change your account status using this chat, or by calling a customer support representative at 1-800-123-1234.
2) Our customer support number is 1-800-123-1234. You can call a human representative at this number.
3) Sorry, I didn't catch that. Could you please ask again in a different way?
4) You can change your account status to either Active, Automatic, or Closed.
5) Our customer support line is open from 8 AM to 8 PM Monday through Friday. You can call us at 1-800-123-1234.


- **Expected Result**:
```json
{
  "remaining_message_draft": "You can call a human representative at 1-800-123-1234.",
  "unsatisfied_guidelines": "",
  "tldr": "We haven't sent out our customer support number, so the draft is not fully transmitted. Template #2 has the relevant number, so we should send it to the customer.",
  "additional_response_required": true,
  "additional_template_id": "2",
  "match_quality": "high"
}
```

###
    

Example 2 - A simple example where a follow-up response is not necessary: ###

Draft: Thank you for your purchase!
Last agent message: The order will be shipped to you in 5-7 business days

- **Candidate Templates**:
1) The order will be shipped to you in up to 10 business days. Thank you for your purchase!
2) Domestic orders are shipped through UPS
3) I'm here to help! What can I do for you today?
4) Your purchase is complete and will be shipped to you shortly!
5) You can track your order status on our website at verygoodstore.com


- **Expected Result**:
```json
{
  "remaining_message_draft": "Thank you for your purchase!",
  "unsatisfied_guidelines": "",
  "tldr": "The remaining part of the draft does not contain any critical information, and no template matches it, so no further response is necessary.",
  "additional_response_required": false
}
```

###
    

Example 3 - An example where one response is prioritized for its importance: ###

Draft: Your table is booked! Since you mentioned allergies, please note that our kitchen contains peanuts. You'll be able to get a souvenir from our store after your meal.
Last agent message: Your table has been booked!

- **Candidate Templates**:
1) Please note that all dishes may contain peanuts
2) Please inform us of any allergies you or your party have
3) Thank you for coming in!
4) Our souvenir shop is available for all diners after their meal
5) Would you like to book another table?


- **Expected Result**:
```json
{
  "remaining_message_draft": "Thank you for your purchase!",
  "unsatisfied_guidelines": "",
  "tldr": "Templates 1 and 4 both capture missing parts of the draft. Template 1 is more important as it mentions potential health concerns, so it should be sent out first.",
  "additional_response_required": true,
  "additional_template_id": "1",
  "match_quality": "partial"
}
```

###
    

Example 4 - An example where the draft was already captured by the last response. Assume there's an active guideline instructing the agent to inform the customer about our returns policy.: ###

Draft: Unopened items can be returned for up to 30 days from the date of purchase
Last agent message: Of course! You may return your items for up to a month if they have not been opened.

- **Candidate Templates**:
1) Any item can be returned for up to 30 days from the date of purchase, given that it has not been opened.
2) Please check our website for more information about our returns policy.
3) Your items will be returned to us within 30 days.
4) Sorry, I didn't catch that


- **Expected Result**:
```json
{
  "remaining_message_draft": "",
  "unsatisfied_guidelines": "",
  "tldr": "The last outputted message already captures the draft. Template 1 matches the draft, but it adds no new information compared to the last outputted message.",
  "additional_response_required": false
}
```

###
    



The user you're interacting with is called test_customer.



The following is a list of events describing a back-and-forth
interaction between you and a user: ###
['{"event_kind": "message", "event_source": "user", "data": {"participant": "test_customer", "message": "I say that a banana is green, and an apple is purple. What did I say was the color of a banana?"}}', '{"event_kind": "message", "event_source": "ai_agent", "data": {"participant": "test-agent", "message": "the answer is green"}}']
###



INPUTS
---------------
Draft message: ###
You said that a banana is green.
###
Message already sent to the customer: ###
the answer is green
###
Pre-approved reply templates: ###
Template ID: "1" """
Sorry, I do not know
"""
###





OUTPUT FORMAT
-----------------
Output a JSON object with three properties:
{
    "remaining_message_draft": "<str, rephrasing of the part of the draft that isn't covered by the last outputted message>"
    "unsatisfied_guidelines": "<str, restatement of all guidelines that were not satisfied by the last outputted message. Only restate the actionable part of the guideline (the one after 'then')>"
    "tldr": "<str, brief explanation of the reasoning behind whether an additional response is required, and which template best encapsulates it>",
    "additional_response_required": <bool, if False, all remaining keys should be omitted>,
    "additional_template_id": "<str, ID of the chosen template>",
    "match_quality": "<str, either "high", "partial" or "low" depending on how similar the chosen template is to the remaining message draft>",
}