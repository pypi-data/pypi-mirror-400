<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>mlearning lab</title>
    <style>
      body {
        font-family: Helvetica, Arial, sans-serif;
        font-size: clamp(0.95rem, 1.7vw, 1.08rem);
        background: #f8f9fb;
        margin: 0;
        padding: 0;
      }
      
      .dashboard-main {
        margin-left: 220px;
        padding: 36px 40px 30px 10px;
        min-height: 100vh;
        box-sizing: border-box;
        overflow-x: auto;
        background: #dff0f5ff;
        font-size: clamp(0.98rem, 2vw, 1.07rem);
      }
      .dashboard-tabs {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0 0 12px 0;
        border-bottom: 2px solid #ccc;
        background: none;
      }
      .dashboard-tabs li { margin: 0 8px; }
      .dashboard-tabs a {
        display: inline-block; padding: 12px 32px; text-decoration: none; color: #333; font-size: clamp(0.96rem, 2vw, 1.1em);
        border-radius: 8px 8px 0 0;
        background: #e0e5ee;
        border: 1px solid #ccc;
        border-bottom: none;
        margin-bottom: -2px;
      }
      .dashboard-tabs .active a, .dashboard-tabs a.active {
        background: #fff;
        border-bottom: 2px solid #f8f9fb;
        font-weight: bold;
        color: #007acc;
        position: relative;
        top: 2px;
      }
      .dashboard-content {
        background: #bbbbbd;
        width: 100%;
        padding: 10px;
        border-radius: 0 0 10px 10px;
        box-shadow: 0 3px 12px rgba(80,120,160,0.08);
        min-height: 320px;
        border: 1px solid #ccc;
        overflow-x: auto;
        margin-right: 1vw; 
      }

      textarea#askai{
        background: #e5e5e5cd;
      }

      .dashboard-sidebar {
        position: fixed;
        top: 0; left: 0;
        width: 200px; height: 100vh;
        background: #a3a4a5ff;
        border-right: 1px solid #ccc;
        padding: 26px 10px 10px 14px;
        box-sizing: border-box;
        overflow-y: auto;    
        z-index: 100;
        font-size: clamp(0.95rem, 2vw, 1.09rem);
      }
      .dashboard-sidebar h2 {
        font-size: clamp(1.12rem, 3vw, 1.28rem);
        color: #007acc;
        margin-top: 0;
        margin-bottom: 32px;
        font-weight: bold;
        letter-spacing: 1px;
      }
      .sidebar-links {
        margin-top: 22px;
      }
      .sidebar-links a {
        display: block;
        padding: 12px 10px 12px 0;
        color: #333;
        text-decoration: none;
        font-size: clamp(0.93rem, 2vw, 1.08rem);
        border-radius: 6px;
        margin-bottom: 6px;
        transition: background 0.2s, color 0.2s;
      }
      .sidebar-links a.active,
      .sidebar-links a:hover {
        background: #e0e5ee;
        color: #007acc;
        font-weight: bold;
      }
      
      .smx-table {
        padding: clamp(3px, 1vw, 9px) clamp(4px, 2vw, 13px);
        margin-bottom: 16px;
        background: #fff;
        display: block;
        overflow-x: auto;
        width: max-content;      
        border-collapse: collapse;
        font-size: 13px;
      }
      .smx-table th {
        position: sticky;
        top: 0;
        background: #e0e5ee;
        font-weight: bold;
        padding: 8px 10px;
        border-bottom: 2px solid #ccc;
        z-index: 2;
      }
      .smx-table td {
        border: 1px solid #ddd;
        padding: 7px 10px;
      }
      .smx-scroll {
          overflow-x: auto;        
          overflow-y: hidden;    
          max-width: 100%;         
      }
      .smx-table th,
      .smx-table td {
          padding: 4px 8px;
          white-space: nowrap;    
      }
      #form-askai {
        display: flex;
        flex-direction: column;
        align-items: flex-center; /* or 'center' for centered alignment */
        gap: 16px; 
      }
  
      button {
        padding: 8px 10px;
        font-size: 1em;
        background: #007acc;
        color: #fff;
        border: none;
        border-radius: 4px;
        align-items:center;
        justify-content:center;
        cursor:pointer;
      }
      button:hover { background: #005fa3; }
      input.btn { cursor: pointer; padding: 10px; }
      .del-btn {
        border-radius:40%;
        cursor:pointer;
        background:none; 
        padding:0.2rem;
      }
      .del-btn:hover { opacity:0.8; background:red; }

      /* Make the Explore Data submit button compact instead of full-width */
      .eda-submit-btn {
        align-self: flex-start;      /* stop flex from stretching it to 100% */
        width: auto;                 /* shrink to content */
        min-width: 7.5rem;           /* tweak this if you want it smaller/larger */
        padding: 6px 16px;           /* a bit tighter than the global button */
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      
      /* --- Mobile fixes --- */
      .dashboard-content img,
      .dashboard-content canvas,
      .dashboard-content svg,
      .dashboard-content iframe,
      .dashboard-content .plotly-graph-div {
        max-width: 100% !important;
        height: auto !important;
      }

      /* Wrap-wide tables will scroll horizontally on small screens */
      .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .table-wrap table { min-width: 640px; }
    </style>
    <style>
      /* Off-canvas sidebar behaviour on phones */
      @media (max-width: 768px) {
        .sidebar-toggle{ display: none; } 
        .dashboard-main { 
          margin-left: 0 !important;     
          padding: 16px !important;
        }
        .dashboard-sidebar {
          position: fixed !important;
          inset: 0 auto 0 0;
          width: 48vw !important;           /* drawer width */
          max-width: 200px;
          transform: translateX(-100%);
          transition: transform .28s ease;
          z-index: 1000;
          box-shadow: 0 10px 30px rgba(0,0,0,.18);
        }
        .dashboard-sidebar.open { transform: translateX(0); }
      }
      /* Always-on mobile toggle button */
      .sidebar-toggle{
        position: fixed;          /* stays on screen */
        top: 10px;
        left: 10px;
        z-index: 1100;            
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 44px; height: 44px;
        border: 0;
        border-radius: 10px;
        background: #0d6efd;      /* solid, visible colour */
        color: #fff;
        box-shadow: 0 4px 14px rgba(0,0,0,.18);
        cursor: pointer;
      }
      .sidebar-toggle::before{ content: "‚ò∞"; font-size: 22px; line-height: 1; }
      .sidebar-toggle.is-open::before{ content: "‚úï"; }   /* becomes close */
      .sidebar-toggle:focus{ outline: 3px solid rgba(13,110,253,.5); outline-offset: 2px; }

      @media (min-width: 769px){
        .sidebar-toggle{ display: none; }  /* desktop: hidden */
      }

      /* Close button inside drawer */
      .dashboard-sidebar .sidebar-close{
        position: absolute;
        top: 8px; right: 8px;
        width: 36px; height: 36px;
        border: 0; border-radius: 8px;
        background: transparent;
        font-size: 22px;
        line-height: 1;
        cursor: pointer;
      }

      /* Scrim behind the drawer */
      .sidebar-scrim{
        position: fixed; inset: 0;
        background: rgba(0,0,0,.25);
        z-index: 900;                  /* below the drawer, above content */
        display: none;
      }
      .sidebar-scrim.show{ display: block; }
      body.no-scroll{ overflow: hidden; }

      /* Make the Ask AI form fluid */
      #form-askai{ width: 100% !important; max-width: 100% !important; }
      #form-askai *{ box-sizing: border-box; }
      #form-askai textarea,
      #form-askai input[type="text"],
      #form-askai select{
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
      }

      /* If the form sits inside a card/panel, ensure the wrapper can shrink */
      .askai-card, .explore-card, .dashboard-content{
        min-width: 0;                 
      }

      @media (max-width: 768px){
        .askai-card, .explore-card{
          margin: 0 !important;
          padding: 12px !important;
          border-radius: 10px;
        }
        #form-askai textarea{ min-height: 120px; }
      }
      /* Fix fieldset overflow on small screens (Chromium/Firefox quirk) */
      .dashboard-content form#form-askai,
      .dashboard-content form#form-askai fieldset {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        min-inline-size: 0 !important;  /* critical: prevents min-content expansion */
        box-sizing: border-box;
      }

      /* Ensure the dashboard area never shows a 1‚Äì2px horizontal creep */
      .dashboard-content { overflow-x: clip; }  /* or hidden */
      /* If you have a wrapper (use your actual class if different) */
      .askai-card, .explore-card {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        box-sizing: border-box;
      }
      #form-askai textarea,
      #form-askai input[type="text"],
      #form-askai select {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        box-sizing: border-box;
      }

      /* Centre the main column and balance the side gutters */
      @media (max-width: 768px){
        .dashboard-main{
          max-width: 100%;
          margin-inline: auto !important;     
          padding-inline: 12px !important;    
          box-sizing: border-box;
        }
      }

      /* Neutralise Bootstrap's negative row margins in this page.
            (Rows assume they're inside .container; here they aren't.) 
      */
      .dashboard-main .row{
        margin-left: 0 !important;
        margin-right: 0 !important;
      }
      .dashboard-main .row > [class*="col"]{
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
      }

      /* Make the cards/panels line up perfectly with the column */
      .dashboard-main .card,
      .dashboard-main .panel,
      .dashboard-main .explore-card{
        width: 100%;
        max-width: 100%;
        margin-left: 0 !important;
        margin-right: 0 !important;
        box-sizing: border-box;
      }

      /* Belt-and-braces: prevent any 1-2px creep from borders */
      .dashboard-main, .dashboard-content{ overflow-x: clip; }

       @media (max-width: 768px){
        .dashboard-main{
          padding-right: 24px;
        }
        .dashboard-content {
          margin-right: 24px;
        }
      }

      /* Make the border count inside the element's width */
      .dashboard-content{
        box-sizing: border-box !important;
      }

      /* Centre it with symmetric gutters and avoid the 1px crop */
      @media (max-width: 768px){
        .dashboard-content{
          width: auto !important;                
          max-width: none !important;
          margin-inline: 12px !important;       
          padding-inline: 12px !important;       
          border: 1px solid #dee2e6;            
          border-radius: 10px;                   
          background: #fff;
        }

        /* Neutralise Bootstrap row negatives that can push borders off-screen */
        .dashboard-content .row{
          margin-left: 0 !important;
          margin-right: 0 !important;
        }
        .dashboard-content .row > [class^="col"],
        .dashboard-content .row > [class*=" col"]{
          padding-left: 12px !important;
          padding-right: 12px !important;
        }
      }

      /* Belt-and-braces: draw the stroke *inside* the box to defeat subpixel rounding */
      @media (max-width: 768px){
        .dashboard-content{
          outline: 1px solid #dee2e6;   
          outline-offset: -1px;         
        }
      }
    </style>
    <style>
      /* Code block container + copy button */
      .code-wrap{ position:relative; margin:14px 0; }
      .code-wrap pre{                /* Pygments emits <div class="highlight"><pre ...> */
        margin:0;                    /* ensure padding/scroll come from server-side prestyles too */
        max-width:100%;
        overflow:auto;
        box-sizing:border-box;
        border-radius:8px;
      }
      .code-copy-btn{
        position:absolute; top:8px; right:8px;
        background:#0d6efd; color:#fff;
        border:0; border-radius:8px;
        font-weight:600; font-size:0.9rem;
        padding:6px 12px;
        cursor:pointer;
        box-shadow:0 2px 8px rgba(0,0,0,.12);
      }
      .code-copy-btn:hover{ background:#0b5ed7; }
    </style>
    <style>
      .eda-grid{
        display:grid;
        grid-template-columns:repeat(auto-fit, minmax(360px,1fr));
        gap:12px;
        align-items:start;
      }
      .eda-card{
        background:#fff;
        border:1px solid #e5e7eb;
        border-radius:12px;
        padding:14px 16px;
        box-shadow:0 1px 8px rgba(0,0,0,.04);
        opacity:0; transform:translateY(6px);
        animation:edaFade .35s ease forwards;
        animation-delay: calc(var(--i, 0) * 60ms);
      }
      /* 12-column grid */
      .eda-grid.eda-grid-12{
        display:grid;
        grid-auto-flow:dense;
        grid-template-columns:repeat(12, minmax(0,1fr));
        gap:12px; align-items:start;
      }
      /* Helpers (use these in cell["span"]) */
       .eda-col-3 { grid-column:span 3; }   /* third width ‚Üí 3:3:3:3 */
      .eda-col-4  { grid-column:span 4; }   /* third width ‚Üí 4:4:4 */
      .eda-col-5  { grid-column:span 5; }   /* third width ‚Üí 5:7 */
      .eda-col-6  { grid-column:span 6; }   /* half width ‚Üí 6:6 */
      .eda-col-7  { grid-column:span 7; }   /* third width ‚Üí 7:5 */
      .eda-col-8  { grid-column:span 8; }   /* two-thirds ‚Üí 8:4 */
      .eda-col-9  { grid-column:span 9; }   /* two-thirds ‚Üí 9:3 */
      .eda-col-12 { grid-column:span 12;}   /* full width */

      /* Breakpoints */
      @media (max-width:960px){
        .eda-grid.eda-grid-12{ grid-template-columns:repeat(6, minmax(0,1fr)); }
        .eda-col-9{ grid-column:span 6; }
        .eda-col-8{ grid-column:span 6; }
        .eda-col-7{ grid-column:span 6; }
        .eda-col-6{ grid-column:span 6; }
        .eda-col-5{ grid-column:span 6; }
        .eda-col-4{ grid-column:span 6; }
        .eda-col-3{ grid-column:span 6; }
      }
      @media (max-width:540px){
        .eda-grid.eda-grid-12{ grid-template-columns:repeat(1, 1fr); }
        .eda-card, .eda-col-3, .eda-col-4, .eda-col-5, .eda-col-6, .eda-col-7, .eda-col-8, .eda-col-9, .eda-col-12 {
          grid-column:span 12; 
        }
      }
      .eda-card h3{ margin:0 0 .5rem; font-size:1.02rem; }
      .eda-card .eda-body{ overflow:auto; }
      .eda-card details summary{ cursor:pointer; color:#0366d6; margin-top:.5rem; }
      @keyframes edaFade{ to { opacity:1; transform:none; } }

    </style>
    <style id="smx-theme">
      :root{
        --smx-bg: #f3f6fb;
        --smx-surface: #ffffff;
        --smx-elev1: #fcfdff;
        --smx-border: #dfe5ee;
        --smx-text: #0f172a;
        --smx-muted: #667085;
        --smx-accent: #007acc;        /* SyntaxMatrix blue (keeps your current tone) */
        --smx-accent-2: #14b8a6;      /* teal for subtle gradients */
      }

      body.smx-theme{
        background: linear-gradient(180deg, var(--smx-bg) 0%, #eef3f9 60%, #eaf0f7 100%);
        color: var(--smx-text);
      }

      /* Sidebar + tabs pick up accent */
      .dashboard-sidebar{
        background: linear-gradient(180deg, #f0f5fb 0%, #eaf1f8 100%);
        border-right: 1px solid var(--smx-border);
      }
      .dashboard-sidebar h2{ color: var(--smx-accent); }
      .dashboard-tabs a{ background:#e9f2fb; border-color: var(--smx-border); color:#1f2a37; }
      .dashboard-tabs .active a, .dashboard-tabs a.active{
        background: var(--smx-surface);
        color: var(--smx-accent);
        border-color: var(--smx-border);
      }

      /* Cards: clearer elevation + accent top bar */
      .eda-card{
        background: var(--smx-surface);
        border: 1px solid var(--smx-border);
        border-radius: 14px;
        box-shadow: 0 6px 18px rgba(16,24,40,.06);
        position: relative;
      }
      .eda-card::before{
        content:"";
        position:absolute; inset:0 0 auto 0; height:4px; border-radius:14px 14px 0 0;
        background: linear-gradient(90deg, var(--smx-accent), var(--smx-accent-2));
      }
      .eda-card h3{
        margin: 0; padding: 10px 12px;
        font-size: 1rem; font-weight: 700; color: #1f2937;
        border-bottom: 1px solid var(--smx-border);
      }
      .eda-card .eda-body{ padding: 10px 12px; }

      /* Stat tiles harmonised */
      .smx-statwrap{ gap: 12px !important; }
      .smx-stat{
        background: var(--smx-elev1) !important;
        border: 1px solid var(--smx-border) !important;
        box-shadow: 0 2px 10px rgba(16,24,40,.05);
        border-radius: 12px !important;
      }
      .smx-stat h4{ color: var(--smx-muted) !important; letter-spacing:.2px; }

      /* Buttons */
      button, .btn{
        background: var(--smx-accent);
        color: #fff;
        border: 1px solid #0a66c2;
        border-radius: 10px;
      }
      button:hover, .btn:hover{ background:#0566b1; }

      /* Forms & selects */
      select, textarea, input[type="text"], input[type="file"]{
        border:1px solid var(--smx-border);
        border-radius:10px;
      }

      /* Content panel */
      .dashboard-content{
        background: var(--smx-surface);
        border: 1px solid var(--smx-border);
        border-radius: 14px;
        box-shadow: 0 8px 24px rgba(16,24,40,.05);
      }
    </style>
    <style id="smx-contrast">
      /* Dark slate backdrop for the whole page */
      body.smx-theme.smx-contrast{
        background:
          radial-gradient(1100px 520px at 15% -10%, #16253a 0%, #0f2036 40%, #0b1628 70%, #0a1424 100%),
          linear-gradient(180deg, #0a1424 0%, #0c172a 100%);
        color: #e9eef6;
      }

      /* Let the dark backdrop show through; keep content readable */
      .dashboard-main{ background: transparent !important; }
      .dashboard-content{
        background: rgba(255,255,255,0.96) !important;
        border: 1px solid #d4deea !important;
        border-radius: 14px;
        box-shadow: 0 10px 28px rgba(8,20,38,0.28);
      }

      /* Cards sit on a brighter surface with clear edge + shadow */
      .eda-card{
        background: #ffffff !important;
        border: 1px solid #d8e3f0 !important;
        border-radius: 14px;
        box-shadow: 0 8px 24px rgba(8,20,38,0.22);
      }
      .eda-card::before{
        background: linear-gradient(90deg, #0b8ae5, #14b8a6);
      }

      /* Tidy headings/labels inside light surfaces */
      .eda-card h3{ color: #1f2937 !important; }
      .smx-stat h4{ color: #64748b !important; }
    </style>
    <style>
      div.li li {
        margin-left: 35px;
      }
      /* 1. Style the arrow specifically */
      .toggle-arrow {
        display: inline-block;        /* CRITICAL: Allows the element to rotate */
        transition: transform 0.2s;   /* Makes the rotation smooth */
        margin-right: 6px;            /* Spacing between arrow and text */
      }

      /* 2. Rotate and color when the menu is OPEN */
      details[open] summary .toggle-arrow {
        transform: rotate(90deg);     /* Rotates the arrow downwards */
        color: #007acc;               /* Changes color to blue */
      }

      /* 3. (Optional) Remove default browser markers to avoid double arrows */
      details > summary {
        list-style: none;
      }
      details > summary::-webkit-details-marker {
        display: none;
      }

      /* Thinking dots that sit inside the Explore Data submit button */
      /* Submit button: keep size constant while swapping text for dots */
      .eda-submit-btn {
        position: relative;
        overflow: hidden;
      }

      .eda-btn-label {
        display: inline-block;
      }

      /* Thinking dots overlay, centred in the button */
      .eda-btn-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        display: none;                 /* hidden until loading */
        align-items: center;
        justify-content: center;
        gap: 0.15rem;
      }

      .eda-btn-spinner .dot {
        width: 0.28rem;
        height: 0.28rem;
        border-radius: 999px;
        background: currentColor;
        opacity: 0.2;
        display: inline-block;
        margin: 0 0.08rem;
        animation: edaBtnDots 1s infinite ease-in-out;
      }

      .eda-btn-spinner .dot:nth-child(2) {
        animation-delay: 0.15s;
      }

      .eda-btn-spinner .dot:nth-child(3) {
        animation-delay: 0.30s;
      }

      /* While loading: keep label in layout, but hide it visually */
      .eda-btn-loading .eda-btn-label {
        visibility: hidden;            /* keeps height and width */
      }

      .eda-btn-loading .eda-btn-spinner {
        display: inline-flex;
      }

      @keyframes edaBtnDots {
        0%, 60%, 100% {
          opacity: 0.2;
          transform: translateY(0);
        }
        30% {
          opacity: 1;
          transform: translateY(-0.16rem);
        }
      }

      .sidebar-links {
        margin-top: 22px;
      }
      .sidebar-links a {
        display: block;
        padding: 12px 10px 12px 0;
        color: #333;
        text-decoration: none;
        font-size: clamp(0.93rem, 2vw, 1.08rem);
        border-radius: 6px;
        margin-bottom: 6px;
        transition: background 0.2s, color 0.2s;
      }
      .sidebar-links a.active,
      .sidebar-links a:hover {
        background: #e0e5ee;
        color: #007acc;
        font-weight: bold;
      }
      /* Sub-links under a main section (e.g. Explore ‚Üí Resize dataset) */
      .sidebar-links a.sidebar-sub-link {
        font-size: clamp(0.80rem, 1.4vw, 0.95rem);  /* smaller than main items */
        padding: 6px 10px 6px 14px;                  /* slight indent to show hierarchy */
        margin-bottom: 4px;
        opacity: 0.95;
      }

      /* Optional: visual cue arrow for sub-items */
      .sidebar-links a.sidebar-sub-link::before {
        content: "‚Ü≥ ";
        font-size: 0.8em;
        opacity: 0.7;
      }
    </style>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <div id="sidebarScrim" class="sidebar-scrim" aria-hidden="true"></div>
  <div class="dashboard-sidebar">
   
    <h2>ML&nbsp;Lab</h2>
    <a href="/">return to home</a>
    <div class="sidebar-links">
      <a href="/dashboard?section=explore"{% if section == 'explore' %} class="active"{% endif %}>Explore</a>

      <!-- Explore subsets -->
      <a href="{{ url_for('dataset_resize') }}" class="sidebar-sub-link">Resize dataset</a>

      <!-- Future: more links here -->
    </div>

  </div>
  <div class="dashboard-main">
    <button id="sidebarToggle" class="sidebar-toggle" aria-label="Open menu"></button>
    <ul class="dashboard-tabs">
      <li class="{{ 'active' if section == 'explore' else '' }}"><a href="/dashboard?section=explore">Explore</a></li>  
    </ul>
    <div class="dashboard-content">
      <div class="explore-card">
        <!-- FLASH MESSAGES (optional but useful) -->
        {% with msgs = get_flashed_messages() %}
          {% if msgs %}
            <ul class="flashes">
              {% for m in msgs %}
                <li>{{ m }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}
        <!-- Upload form -->
        <div style="width:70vw; margin-bottom:10px; border:1px solid gray; border-radius:10px; padding:10px;">
          <form action="/dashboard/upload" method="post" enctype="multipart/form-data" style="padding:5px; margin-bottom:5px;">
            <input style="cursor:pointer;" type="file" name="dataset_file" accept=".csv" required>
            <button type="submit">Upload CSV</button>
          </form>
        
          <!-- Dataset selection dropdown -->
          {% if datasets %}
            <form method="get" action="/dashboard" style="margin-top:45px; margin-bottom:8px;padding:5px;">
              <input type="hidden" name="section" value="explore"/>
              <label for="dataset_select"><strong>Select dataset:</strong></label>
              <select name="dataset" id="dataset_select" onchange="this.form.submit()" style="margin-top:5px; height:24px;">
                {% for ds in datasets %}
                  <option value="{{ ds }}" {% if ds == selected_dataset %}selected{% endif %}>{{ ds }}</option>
                {% endfor %}
              </select>
            </form>
            <form  method="post" action="{{ url_for('delete_dataset', dataset_name=selected_dataset) }}"
              style="display:inline-block;">
              <div>Current dataset: 
                  <strong style="margin:10px;color:green; background:yellow;">{{ selected_dataset }}</strong>
                  <button class="del-btn" type="submit" title="Delete {{ selected_dataset }}"
                        onclick="return confirm('Delete {{ selected_dataset }}?');">
                        üóëÔ∏è   
                  </button>
              </div>
            </form>
          {% else %}
            <p style="color:red; padding:5px;">No datasets uploaded yet. Upload a CSV to begin.</p>
          {% endif %}     
        </div>
        {% if section == 'explore' %}
          <br>
          <h2>Explore Data</h2>
          <form id="form-askai" method="post" action="/dashboard?section=explore" style="margin-top:5px;padding:12px; border:1px solid grey;border-radius:5px;width:70vw;">
            <input type="hidden" name="dataset" value="{{ selected_dataset }}">
            <label for="askai"><strong>Ask {{ smxAI }}:</strong></label>
            <textarea id="askai" name="askai_question" type="text" rows="5"
                    style="position:relative; width:90%; padding:16px; font-size:0.8em; border-radius:8px;"
                    placeholder="Ask me about {{ (selected_dataset or 'your dataset\n. But upload it first.').replace('_', ' ').replace('.csv', '') }}" required></textarea>
            <!-- <button type="submit" style="font-size:1.2rem; width:8rem; padding:4px;">Submit</button> -->
            <button
              type="submit"
              class="btn btn-primary eda-submit-btn"
            >
              <span class="eda-btn-content">
                <span class="eda-btn-label">Submit</span>
                <span class="eda-btn-spinner" aria-hidden="true">
                  <span class="dot"></span>
                  <span class="dot"></span>
                  <span class="dot"></span>
                </span>
              </span>
            </button>
          </form>
          <div style="margin-bottom: 36px;">
            {% if askai_question %}
              <!--
              <div class="askai-qblock" style="margin:20px 5px;">
                  <span class="askai-q-label"><b>Task:</b></span>
                  <span class="askai-q">{{ askai_question }}</span>
              </div>
              -->
              <br><br>
              <div class="refined-qblock">
                <details>
                  <summary class="refined-q-label" style="cursor: pointer; list-style: none;">
                      <span class="toggle-arrow">‚ñ∂</span> 
                      <b>Thought Process</b>
                  </summary>
                  <div class="li" style="margin-top: 10px; padding-left: 14px; border-left: 3px solid #e0e5ee;">
                      <span class="refined-q">{{ refined_question|safe }}</span>
                      <br><br>
                      {% if tasks %}
                        <b>Tasks Performed: </b>
                        {% for task in tasks %}
                          <li>{{ task.replace('_', ' ').capitalize() }}</li>
                        {% endfor %}
                      {% endif %} 
                      <br><br>
                      {% if TOKENS %}
                        <b>Refiner Agent: </b><span>{{ TOKENS['Refiner'][0] }} | {{  TOKENS['Refiner'][1] }}</span><br> 
                        <b>Token Usage: </b>
                          <li>Input Tokens: {{ TOKENS['Refiner'][2] }}</li>
                          <li>Output Tokens: {{ TOKENS['Refiner'][3] }}</li>
                          <li>Total Tokens: {{ TOKENS['Refiner'][4] }}</li>  
                        <br>     
                        
                        <b>Coder Agent: </b><span>{{ TOKENS['Coder'][0] }} | {{  TOKENS['Coder'][1] }}</span><br> 
                        <b>Token Usage: </b>
                          <li>Input Tokens: {{ TOKENS['Coder'][2] }}</li>
                          <li>Output Tokens: {{ TOKENS['Coder'][3] }}</li>
                          <li>Total Tokens: {{ TOKENS['Coder'][4] }}</li>
                      {% endif %} 
                  </div>
                </details>
              </div>
            {% endif %}
            {% if ai_outputs %}
              <div class="d-flex align-items-center justify-content-between" style="margin: 12px;">
                <br>
                <h3 class="m-0">Result</h3>
                {% for html_block in ai_outputs %}
                    <div class="ai-output" style="margin-bottom:18px;overflow-x:auto; max-width:100%;">
                        {{ html_block | safe }}
                    </div>
                {% endfor %}
              </div>
            {% endif %}
            {% if ai_code %}
              <div>
                  <a href="#" onclick="toggleCode();return false;" id="toggle-link">Show Code</a>
                  <div id="ai-code-block" class="code-wrap" style="display:none;">
                    {{ highlighted_ai_code|safe }}
                    <button type="button" class="code-copy-btn" onclick="copyCode(this)">Copy</button>
                  </div>
              </div>
            {% endif %}
          </div>
          <script>
              function toggleCode() {
                  var el = document.getElementById('ai-code-block');
                  var link = document.getElementById('toggle-link');
                  if (el.style.display === 'none') {
                      el.style.display = '';
                      link.innerText = 'Hide Code';
                  } else {
                      el.style.display = 'none';
                      link.innerText = 'Show Code';
                  }
              }
          </script>        
          <div class="eda-grid eda-grid-12">
            {% for cell in data_cells %}
              <section class="eda-card {{ cell.span or '' }}" style="--i: {{ loop.index0 }}">
                <h3>{{ cell.title }}</h3>
                <div class="eda-body">
                  {{ cell.output|safe }}
                </div>
                {% if cell.highlighted_code %}
                <details>
                  <summary>Show code</summary>
                  <div style="margin-top:.5rem">{{ cell.highlighted_code|safe }}</div>
                </details>
                {% endif %}
              </section>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
  <script>
    async function copyCode(btn){
      const pre = btn.parentElement.querySelector('pre');
      if(!pre) return;
      const text = pre.innerText;

      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          // fallback
          const range = document.createRange();
          range.selectNodeContents(pre);
          const sel = window.getSelection();
          sel.removeAllRanges(); sel.addRange(range);
          document.execCommand('copy');
          sel.removeAllRanges();
        }
        btn.textContent = 'Copied!';
        setTimeout(()=>btn.textContent='Copy', 1200);
      } catch(e){
        btn.textContent = 'Failed';
        setTimeout(()=>btn.textContent='Copy', 1200);
      }
    }
  </script>
  <script>
    function toggleCodeCell(link) {
      var cell = link.nextElementSibling;
      if (!cell) return;
      if (cell.style.display === "none") {
        cell.style.display = "block";
        link.querySelector("span").innerText = "Hide Code";
      } else {
        cell.style.display = "none";
        link.querySelector("span").innerText = "Show Code";
      }
    }

    function copyCodeToClipboard(btn) {
      var pre = btn.parentElement.querySelector("pre");
      if (!pre) return;
      var range = document.createRange();
      range.selectNodeContents(pre);
      var sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      try {
        document.execCommand("copy");
        btn.innerText = "Copied!";
        setTimeout(() => { btn.innerText = "Copy"; }, 1200);
      } catch (err) {
        btn.innerText = "Failed!";
        setTimeout(() => { btn.innerText = "Copy"; }, 1200);
      }
      sel.removeAllRanges();
    }

    document.addEventListener("DOMContentLoaded", function () {
      var form = document.getElementById("form-askai");
      if (!form) return;

      var submitBtn = form.querySelector(".eda-submit-btn");
      if (!submitBtn) return;

      // When the form actually submits, show the spinner and disable the button
      form.addEventListener("submit", function () {
        submitBtn.classList.add("eda-btn-loading");
        submitBtn.disabled = true;
        // IMPORTANT: no preventDefault here ‚Äì the browser/htmx still submits normally
      });

      // If htmx is used on this form, reset the spinner once the request completes or errors
      if (window.htmx) {
        form.addEventListener("htmx:afterRequest", function () {
          submitBtn.classList.remove("eda-btn-loading");
          submitBtn.disabled = false;
        });
        form.addEventListener("htmx:responseError", function () {
          submitBtn.classList.remove("eda-btn-loading");
          submitBtn.disabled = false;
        });
        form.addEventListener("htmx:sendError", function () {
          submitBtn.classList.remove("eda-btn-loading");
          submitBtn.disabled = false;
        });
      }
    });
  </script>
  <script>
    const sidebar = document.querySelector('.dashboard-sidebar');
    const toggle  = document.getElementById('sidebarToggle');
    const scrim   = document.getElementById('sidebarScrim');
    const closeBtn= document.querySelector('.dashboard-sidebar .sidebar-close');

    function setOpen(open){
      if(!sidebar || !toggle) return;
      sidebar.classList.toggle('open', open);
      toggle.classList.toggle('is-open', open);
      toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
      document.body.classList.toggle('no-scroll', open);
      if (scrim) scrim.classList.toggle('show', open);
    }

    toggle?.addEventListener('click', () => setOpen(!sidebar.classList.contains('open')));
    closeBtn?.addEventListener('click', () => setOpen(false));
    scrim?.addEventListener('click', () => setOpen(false));
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') setOpen(false); });
  </script>
  <script>
    // Resize Plotly charts responsively
    window.addEventListener('resize', () => {
      if (window.Plotly) {
        document.querySelectorAll('.js-plotly-plot').forEach(el => {
          try { window.Plotly.Plots.resize(el); } catch(e) {}
        });
      }
    });
  </script>
</body>
</html>
