[tox]
envlist: {p310,p311,p312,p313}-{deploy,test}-{pipfile,pipenv}-{intel,applesilicon}{,-extras,-optimizers}
#This is a hack to force pip to serialise installs
#i.e. install a set of packages before installing the next
#This happens particularly with numpy which MUST be installed
#for other package that depend on it to be installed
indexserver =
    DEV = https://pypi.python.org/simple
    OTH = https://pypi.python.org/simple

#Defaults for all environments
#Can make options conditional on a particular environment using $envname_part:
[testenv]
runner = uv-venv-lock-runner
envdir=
    test: {env:TEST_VENV:toxenv}
    deploy: {env:DEPLOY_VENV:toxenv}
basepython= 
    py37: python3.7
    py38: python3.8
    py39: python3.9
    py310: python3.10
    py311: python3.11
    py312: python3.12
    py313: python3.13
passenv=
    CI
setenv=
    LC_ALL=en_GB.UTF-8
    LOGLEVEL=DEBUG
    TESTCONTAINERS_RYUK_DISABLED=true
    RAY_TASK_MAX_RETRIES=0
deps =
    extras: -rdeploy/deps_learning.txt
    setuptools_scm
    wheel
    hatchling
    uv-dynamic-versioning
dependency_groups =
    dev
    test
allowlist_externals=
    printenv
    ls
    pwd
    rm
    uv
    pip
commands=
    printenv
    uv pip list
    pytest -n auto --dist worksteal -rx -vv --log-level=INFO --color=yes tests/
    # Run the SFTTrainer tests
    !py313: pytest -n auto --dist worksteal -rx -vv --log-level=INFO --color=yes plugins/actuators/sfttrainer/ado_actuators/sfttrainer/tests/
    # Basic test of custom experiment examples
    ado describe experiment calculate_density
    run_experiment examples/density_example/point.yaml
    # Run the autoconf tests
    uv pip install --no-progress plugins/custom_experiments/autoconf
    pytest -n auto --dist worksteal -rx -vv --log-level=INFO --color=yes plugins/custom_experiments/autoconf/autoconf/test/
    # Basic test of ray_tune
    ado get operator ray_tune
    ado template operation --operator-name=ray_tune
    # Basic test of random_walk
    ado get operator random_walk
    ado template operation --operator-name=random_walk
    # Test actuators have basic functionality
    uv pip install --no-progress plugins/actuators/vllm_performance
    ado get actuators vllm_performance --details
    ado describe experiment test-deployment-v1
    ado template space --from-experiment test-deployment-v1
    # Test run_experiment
    run_experiment examples/optimization_test_functions/point.yaml
    # Test random walk and LHC example
    ado create space -f examples/ml-multi-cloud/ml_multicloud_space.yaml --with store=tests/resources/ml_multicloud_sample_store.yaml
    ado -lINFO create operation -f examples/ml-multi-cloud/lhc_sampler.yaml --use-latest space
    ado -lINFO create op -f examples/ml-multi-cloud/randomwalk_ml_multicloud_operation.yaml --use-latest space
