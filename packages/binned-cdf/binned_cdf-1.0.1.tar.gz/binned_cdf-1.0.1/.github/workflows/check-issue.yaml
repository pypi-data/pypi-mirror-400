name: Check issue

on:
    issues:
        types: [labeled, opened, unlabeled]

concurrency:
    group: ${{ github.job }}/${{ github.workflow }}/${{ github.head_ref || github.ref }}
    cancel-in-progress: true

jobs:
    labels:
        name: Labels
        container: ubuntu:latest
        runs-on: ubuntu-latest
        env:
            comment_header: |
                ## :card_index_dividers: Missing Labels

                We categorize issues using specific label groups to help us prioritize and assign them.
        steps:
            - name: Check if required label prefixes are missing
              id: check-labels
              uses: actions/github-script@v8
              with:
                  script: |
                      const requiredPrefixes = ['area:', 'type:'];
                      const names = (context.payload.issue && context.payload.issue.labels)
                        ? context.payload.issue.labels.map(label => label.name)
                        : [];
                      const missingPrefixes = requiredPrefixes.filter(prefix => !names.some(name => name.startsWith(prefix)));
                      core.setOutput('missing-prefixes', missingPrefixes)
                      core.setOutput('missing-prefixes-md', missingPrefixes.map(prefix => `- \`${prefix}\``).join('\n'))

            - name: Find comment
              id: find-comment
              uses: peter-evans/find-comment@v4
              with:
                  body-includes: "${{ env.comment_header }}"
                  comment-author: "github-actions[bot]"
                  issue-number: ${{ github.event.issue.number }}

            - name: Create or update comment
              uses: peter-evans/create-or-update-comment@v5
              if: ${{ steps.check-labels.outputs.missing-prefixes != '[]' }}
              with:
                  comment-id: ${{ steps.find-comment.outputs.comment-id }}
                  issue-number: ${{ github.event.issue.number }}
                  body: |
                      ${{ env.comment_header }}

                      Please add label(s) with the required prefix(es):

                      ${{ steps.check-labels.outputs.missing-prefixes-md }}
                  edit-mode: replace
                  reactions-edit-mode: replace

            - name: Resolve comment
              uses: peter-evans/create-or-update-comment@v5
              if: ${{ steps.check-labels.outputs.missing-prefixes == '[]' && steps.find-comment.outputs.comment-id != 0 }}
              with:
                  comment-id: ${{ steps.find-comment.outputs.comment-id }}
                  issue-number: ${{ github.event.issue.number }}
                  body: |

                      ---

                      :white_check_mark: All set! Thanks for updating the labels.
                  reactions: rocket
