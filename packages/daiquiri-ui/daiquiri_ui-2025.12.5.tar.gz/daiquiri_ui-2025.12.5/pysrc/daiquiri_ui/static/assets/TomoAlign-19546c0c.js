import{r as u,a8 as Be,aA as $e,aB as Ve,aC as Xe,aD as We,aE as qe,aF as Se,aG as Ke,aH as Qe,aI as Ne,aJ as Ye,aK as Ze,aL as we,aM as Je,aN as ie,j as t,aO as et,I as Ae,F as te,aP as ce,ay as F,aj as $,B as y,aQ as A,aR as tt,g as Ue,R as B,C as p,aS as at,aT as se,aU as q,aV as nt,A as rt,a1 as it,aw as st,av as ot,U as lt,q as ct}from"./index-4cf586ed.js";import{V as dt,u as ut}from"./VLineRoi-75cfdd39.js";import{N as mt,u as ft,a as xt,b as _e,c as Ie}from"./hooks-e7539055.js";import{u as ht,T as gt,D as vt,S as pe,L as jt}from"./UseMouseModeInteraction-9b6c111c.js";import{o as oe}from"./index-19c84627.js";import{A as E}from"./colormap-0981f7dc.js";import{S as Oe}from"./ScreenScale-fdd43179.js";import{D as yt,S as Ct,Z as St,A as Nt}from"./DraggableRect-8e897252.js";import{D as Te}from"./DropdownButton-9a594aef.js";import{S as At}from"./SceneScale-47e8e288.js";import{S as ze,R as _t,a as It}from"./RulerButton-ebbb7ca3.js";import{L as pt}from"./LoadingMessage-072bb4e8.js";import"./types-0be7083b.js";import"./QtyHelper-8429914f.js";import"./colors-5bf0897d.js";import"./Anchor-f3716b7b.js";var N=(e=>(e[e.NONE=0]="NONE",e[e.LAPLACIAN_3x3=1]="LAPLACIAN_3x3",e[e.LAPLACIAN_9x9=2]="LAPLACIAN_9x9",e[e.SHARPENING_3x3=3]="SHARPENING_3x3",e[e.UNSHARPENING_3x3=4]="UNSHARPENING_3x3",e[e.UNSHARPENING_5x5=5]="UNSHARPENING_5x5",e[e.SMOOTH_3x3=6]="SMOOTH_3x3",e[e.SMOOTH_5x5=7]="SMOOTH_5x5",e[e.SMOOTH_7x7=8]="SMOOTH_7x7",e))(N||{});const Z={0:{name:"No filter",size:0,coefs:Float32Array.from([0,0,0,0,0,0,0,0,0])},1:{name:"Laplacian 3×3",size:3,coefs:Float32Array.from([0,-1,0,-1,4,-1,0,-1,0])},2:{name:"Laplacian 9×9",size:9,coefs:Float32Array.from([0,1,1,2,2,2,1,1,0,1,2,4,5,5,5,4,2,1,1,4,5,3,0,3,5,4,1,2,5,3,-12,-24,-12,3,5,2,2,5,0,-24,-40,-24,0,5,2,2,5,3,-12,-24,-12,3,5,2,1,4,5,3,0,3,5,4,1,1,2,4,5,5,5,4,2,1,0,1,1,2,2,2,1,1,0])},3:{name:"Sharpening 3×3",size:3,coefs:Float32Array.from([-1,-1,-1,-1,9,-1,-1,-1,-1])},4:{name:"Unsharpening 3×3",size:3,coefs:Float32Array.from([0,-1,0,-1,5,-1,0,-1,0])},5:{name:"Unsharpening 5×5",size:5,coefs:Float32Array.from([1/256,4/256,6/256,4/256,1/256,4/256,16/256,24/256,16/256,4/256,6/256,24/256,-476/256,24/256,6/256,4/256,16/256,24/256,16/256,4/256,1/256,4/256,6/256,4/256,1/256])},6:{name:"Gaussian 3×3",size:3,coefs:Float32Array.from([1/16,2/16,1/16,2/16,4/16,2/16,1/16,2/16,1/16])},7:{name:"Gaussian 5×5",size:5,coefs:Float32Array.from([1/273,4/273,7/273,4/273,1/273,4/273,16/273,26/273,16/273,4/273,7/273,26/273,41/273,26/273,7/273,4/273,16/273,26/273,16/273,4/273,1/273,4/273,7/273,4/273,1/273])},8:{name:"Gaussian 7×7",size:7,coefs:Float32Array.from([1/4096,6/4096,15/4096,20/4096,15/4096,6/4096,1/4096,6/4096,36/4096,90/4096,120/4096,90/4096,36/4096,6/4096,15/4096,90/4096,225/4096,300/4096,225/4096,90/4096,15/4096,20/4096,120/4096,300/4096,400/4096,300/4096,120/4096,20/4096,15/4096,90/4096,225/4096,300/4096,225/4096,90/4096,15/4096,6/4096,36/4096,90/4096,120/4096,90/4096,36/4096,6/4096,1/4096,6/4096,15/4096,20/4096,15/4096,6/4096,1/4096])}},Ot={float32:Ke,float16:Qe,uint8:Ne,uint16:Ye,uint32:Ze,uint8_clamped:Ne};function Rt(e,a){if(e===void 0)return;const[n,s]=e.shape,r=a!=null&&a.magNearest?$e:Ve,o=new Xe(e.data,s,n,We,Ot[e.dtype],qe,Se,Se,r);return o.needsUpdate=!0,o}function Re(e,a){return u.useMemo(()=>Rt(e,a),[e,a])}function Le(e,a){const n=`resources/shaders/${e}`,[s,r]=u.useState();return u.useEffect(()=>{Be.get(n).then(o=>r({name:e,data:o.data,id:a}))},[n]),s}const Lt=we("daiquiri.components.tomo.TomoAlign");var g=(e=>(e[e.IMAGE_A=0]="IMAGE_A",e[e.IMAGE_B=1]="IMAGE_B",e[e.DIFF=100]="DIFF",e[e.ERROR=101]="ERROR",e[e.MAX=102]="MAX",e[e.MIN=103]="MIN",e[e.MUL=104]="MUL",e[e.HSPLITTER=105]="HSPLITTER",e[e.DIFF_COLOR=200]="DIFF_COLOR",e[e.ERROR_COLOR=201]="ERROR_COLOR",e[e.MAX_COLOR=202]="MAX_COLOR",e[e.MIN_COLOR=203]="MIN_COLOR",e[e.MUL_COLOR=204]="MUL_COLOR",e[e.HSPLITTER_COLOR=205]="HSPLITTER_COLOR",e[e.CUSTOM=300]="CUSTOM",e))(g||{});class Mt extends et{constructor(){super({uniforms:{textureA:{value:null},normA:{value:{min:0,max:0,mode:0}},textureB:{value:null},normB:{value:{min:0,max:0,mode:0}},mode:{value:0},sizeCoef:{value:1},lateral:{value:0},tilt:{value:0},domain:{value:{min:0,max:1}},verticalSeparator:{value:0},kernelCoefs:{value:Float32Array.from([0,0,0,0,0,0,0,0,0])},kernelSize:{value:0}}})}}Je({CompareMaterial:Mt});function bt(e,a,n){return a===0||(a===105||a===205)&&e.y<n?-1:1}function Et(e){const{lateral:a,threshold:n=4,displayMode:s,verticalSeparator:r,disabled:o}=e,c=u.useRef(void 0),i=u.useCallback(m=>{const d=bt(m.dataPt,s,r);c.current={lateral:a,startData:m.dataPt,startScreen:m.htmlPt,gestureStarted:!1,coef:d}},[a,s,r]),x=u.useCallback(m=>{const d=c.current;if(d===void 0)return!1;const{htmlPt:h}=m;return Math.max(Math.abs(h.x-d.startScreen.x),Math.abs(h.y-d.startScreen.y))<=n},[n]),v=u.useCallback(m=>{const d=c.current;if(d===void 0)return;if(!d.gestureStarted){if(x(m))return;c.current={...d,gestureStarted:!0}}const h=m.dataPt.x-d.startData.x;e.onLateralIntermediateChanged(d.lateral+h*2*d.coef)},[x,e.onLateralIntermediateChanged]),j=u.useCallback(m=>{const d=c.current;if(d){const h=m.dataPt.x-d.startData.x;e.onLateralChanged(d.lateral+h*2*d.coef)}c.current=void 0},[x,e.onLateralChanged]);function O(){return oe("pointerdown",i),oe("pointermove",v),oe("pointerup",j),t.jsx(t.Fragment,{})}return t.jsx(t.Fragment,{children:!o&&t.jsx(O,{})})}function wt(e){var b,I,D;const a=u.useRef(null),{displayMode:n=1,lateral:s=0,tilt:r=0,autoScale:o=E.None,stateA:c,stateB:i,verticalSeparator:x=0,customFunc:v,filterMode:j=N.NONE,lateralInteration:O=!1}=e,m=(b=Le("compare.vert.glsl"))==null?void 0:b.data,d=(I=Le("compare.frag.glsl"))==null?void 0:I.data,[h,w]=u.useState(0),L=u.useMemo(()=>e.pixelSize===void 0?1:e.pixelSize.to("mm").scalar,[e.pixelSize]),U=u.useMemo(()=>{if(v===void 0)return d;if(d!==void 0)return d.replace("// CUSTOM FUNC INJECTION //",v)},[d,v]),z=Re(e.imageA,{magNearest:!0}),_=Re(e.imageB,{magNearest:!0}),[T,P]=u.useMemo(()=>{if(j in Z){const{size:X,coefs:k}=Z[j];return[X,k]}console.log(`Unsupported ${j}`);const{size:f,coefs:M}=Z[N.NONE];return[f,M]},[j]);u.useEffect(()=>{w(f=>f+1)},[U,m]);const V=u.useMemo(()=>{if(c===void 0||i===void 0)return{min:0,max:1};switch(o){case E.None:return{min:0,max:1};case E.Minmax:return{min:Math.min(c.min??0,i.min??0),max:Math.max(c.max??1,i.max??1)};case E.StdDev3:{const f=Math.min(c.min??0,i.min??0),M=Math.max(c.max??1,i.max??1),X=((c.mean??.5)+(i.mean??.5))*.5,k=((c.std??.5)+(i.std??.5))*.5;return{min:Math.max(f,X-3*k),max:Math.min(M,X+3*k)}}default:console.warn(`Unsupported norm ${o}`)}return{min:0,max:1}},[c,i,o]);u.useEffect(()=>{if(a.current){const f=a.current.uniforms;f.mode.value=n,f.sizeCoef.value=L,f.tilt.value=r,f.lateral.value=s,f.domain.value=V,f.verticalSeparator.value=x,f.kernelCoefs.value=P,f.kernelSize.value=T,ie()}},[a.current,n,L,s,r,c,i,V,x,P,T,h]);function H(f){return f instanceof mt?{min:f.transfer.min,max:f.transfer.max,mode:1}:{min:0,max:0,mode:0}}u.useEffect(()=>{if(a.current){const f=a.current.uniforms;f.textureA.value=z,f.normA.value=H(e.imageA),ie()}},[h,z,a.current]),u.useEffect(()=>{if(a.current){const f=a.current.uniforms;f.textureB.value=_,f.normB.value=H(e.imageB),ie()}},[h,_,a.current]);const[C,S]=((D=e.imageA)==null?void 0:D.shape)??[1024,1024];return u.useEffect(()=>{Lt(`Debug vertexShader?:${m!==void 0} fragmentShader?:${U!==void 0} textureA?:${z!==void 0} textureB?:${_!==void 0}`)},[m,U,z,_]),m===void 0||U===void 0||z===void 0||_===void 0?t.jsx(t.Fragment,{}):t.jsxs("mesh",{children:[t.jsx("planeGeometry",{attach:"geometry",args:[S*L*2,C*L*2,1,1]}),t.jsx(Et,{lateral:s*L,onLateralChanged:f=>{var M;(M=e.onLateralChanged)==null||M.call(e,.5*f/L)},onLateralIntermediateChanged:f=>{var M;(M=e.onLateralIntermediateChanged)==null||M.call(e,.5*f/L)},threshold:0,displayMode:n,verticalSeparator:x,disabled:!O}),t.jsx("compareMaterial",{attach:"material",ref:a,vertexShader:m,fragmentShader:U},h)]})}function ae(e,a,n,s){if(a===n)return e;if(a==="rad"&&n==="deg")return 180*e/Math.PI;if(a==="deg"&&n==="rad")return Math.PI*e/180;if(a==="px"){if(s!==void 0){const r=s.to("mm").scalar;return ae(e*r,"mm",n,void 0)}return Number.NaN}if(n==="px"){if(s!==void 0){const r=ae(e,a,"mm",void 0),o=s.to("mm").scalar;return r/o}return Number.NaN}try{return ce(e,a).to(n).scalar}catch{return console.error(`Convertion ${a}->${n} is not provided`),Number.NaN}}function Ut(e){return e==="um"?"μm":e}function le(e){const{style:a,className:n,decimals:s=2}=e,r=u.useRef(null),o=u.useRef(void 0),[c,i]=u.useState(!1),x=u.useMemo(()=>e.preferedDisplayUnit!==void 0&&(e.pixelSize===void 0||e.unit==="px"||e.preferedDisplayUnit==="px")?e.preferedDisplayUnit:e.displayUnit??e.unit,[e.displayUnit,e.unit,e.preferedDisplayUnit,e.pixelSize]),v=u.useCallback(d=>{if(!(d===void 0||x===void 0))return ae(d,x,e.unit,e.pixelSize)},[e.unit,x,e.pixelSize]),j=u.useCallback(d=>{if(!(d===void 0||x===void 0))return ae(d,e.unit,x,e.pixelSize)},[e.unit,x,e.pixelSize]);function O(){var w;if(o.current===void 0)return;const d=o.current,h=v(d);o.current=void 0,r.current&&(r.current.value=d.toFixed(s)),h!==void 0&&((w=e.onChange)==null||w.call(e,h)),i(!1)}function m(){var d;o.current!==void 0&&(o.current=void 0,r.current&&(r.current.value=((d=j(e.value))==null?void 0:d.toFixed(s))??""),i(!1))}return u.useEffect(()=>{var d;o.current||r.current&&(r.current.value=((d=j(e.value))==null?void 0:d.toFixed(s))??"")},[e.value]),t.jsxs(Ae,{className:n,style:a,children:[t.jsx(te.Control,{ref:r,step:e.step,type:"number",style:{backgroundColor:c?"#FFFF80":"transparent"},onChange:d=>{i(!0),o.current=Number.parseFloat(d.target.value)},onBlur:()=>{m()},onKeyDown:d=>/^[ a-z]$/i.test(d.key)?(d.preventDefault(),!1):(d.stopPropagation(),d.key==="Enter"&&O(),!0)}),t.jsx(Ae.Text,{children:Ut(x)})]})}function Me(e){const{style:a,className:n}=e,s=u.useRef({value:0,dragging:!1});return t.jsx(te.Range,{className:n,style:a,min:e.min,max:e.max,value:e.value,step:e.step,onChange:r=>{var c,i;const o=Number.parseFloat(r.target.value);s.current.value=o,s.current.dragging?(c=e.onIntermediateChange)==null||c.call(e,o):(i=e.onChange)==null||i.call(e,o)},onMouseDown:r=>{s.current.dragging=!0},onMouseUp:r=>{var o;s.current.dragging=!1,(o=e.onChange)==null||o.call(e,s.current.value)}})}function be(e){const{geometry:a,lineWidth:n=2,color:s="blue",opacity:r=1,zIndex:o=1,visible:c=!0,readOnly:i=e.onGeometryChanged===void 0}=e,[x,v]=u.useState(!1);return c?t.jsxs("group",{position:[0,a.y,o],children:[t.jsx(Oe,{children:t.jsx(yt,{pos:[0,a.y],size:[999999,Ct],pointer:"ns-resize",zIndex:o+St,enabled:!i,onPositionChanged:(j,O)=>{var m;(m=e.onGeometryChanged)==null||m.call(e,{y:j[1]},O)},onEnter:()=>{v(!0)},onLeave:()=>{v(!1)}})}),t.jsx("group",{children:t.jsx(Oe,{children:t.jsxs("mesh",{children:[t.jsx("ambientLight",{}),t.jsx("planeGeometry",{attach:"geometry",args:[999999,x?Nt:n,1,1]}),t.jsx("meshBasicMaterial",{attach:"material",transparent:!0,color:s,opacity:r})]})})})]}):t.jsx(t.Fragment,{})}function Tt(e){const{as:a,onSelect:n,value:s}=e;function r(i){const{name:x}=Z[i],v=i===N.NONE?"fa fa-fw fa-xmark":s===i?"fa fa-fw fa-circle-dot":"fa fa-fw fa-circle";return t.jsxs(F.Item,{eventKey:i,onClick:()=>{n(i)},children:[t.jsx("i",{className:v}),"  ",x]})}const{name:o}=Z[s],c=s===N.NONE?"Apply a convolution filter":`Filter ${o} enabled`;return t.jsxs(Te,{variant:s!==N.NONE?"primary":"secondary",as:a,title:t.jsx("i",{title:c,className:"fa fa-filter fa-fw fa-lg"}),id:"bg-vertical-dropdown-6",children:[r(N.NONE),r(N.LAPLACIAN_3x3),r(N.LAPLACIAN_9x9),r(N.SHARPENING_3x3),r(N.UNSHARPENING_3x3),r(N.UNSHARPENING_5x5),r(N.SMOOTH_3x3),r(N.SMOOTH_5x5),r(N.SMOOTH_7x7)]})}function zt(e){const[a,n,s]=ft(e,{behavior:"destroyFuture"}),[r,o]=u.useState(void 0),c=u.useMemo(()=>({...a,...r}),[a,r]);function i(x,v){v?o(j=>({...j,...x})):(n(j=>({...j,...x})),o(()=>{}))}return[c,i,s]}function kt(e){const{config:a}=e;return t.jsxs(Te,{title:t.jsx("i",{title:"Extra options",className:"fa fa-sliders fa-fw fa-lg"}),children:[t.jsxs(F.Header,{children:[t.jsx("h5",{style:{width:"8em"},children:"Auto contrast"}),t.jsxs($,{children:[t.jsx(y,{variant:a.autoscaleMode===E.None?"primary":"secondary",onClick:()=>{a.setAutoscaleMode(E.None)},children:"None"}),t.jsx(y,{variant:a.autoscaleMode===E.Minmax?"primary":"secondary",onClick:()=>{a.setAutoscaleMode(E.Minmax)},children:"Min/max"}),t.jsx(y,{variant:a.autoscaleMode===E.StdDev3?"primary":"secondary",onClick:()=>{a.setAutoscaleMode(E.StdDev3)},children:"3×std"})]})]}),t.jsx(F.Header,{children:t.jsxs(A,{direction:"horizontal",children:[t.jsx("h5",{style:{width:"8em"},children:"Vertical line"}),t.jsx(y,{title:"Show/hide a vertical line",variant:a.displayVLine?"primary":"secondary",onClick:()=>{a.setDisplayVLine(n=>!n)},children:t.jsx("i",{className:`fa ${a.displayVLine?"fa-eye":"fa-eye-slash"} fa-fw fa-lg`})})]})}),t.jsx(F.Header,{children:t.jsxs(A,{direction:"horizontal",children:[t.jsx("h5",{style:{width:"8em"},children:"Horizontal line"}),t.jsx(y,{title:"Show/hide an horizontal line",variant:a.displayHLine?"primary":"secondary",onClick:()=>{a.setDisplayHLine(n=>!n)},children:t.jsx("i",{className:`fa ${a.displayHLine?"fa-eye":"fa-eye-slash"} fa-fw fa-lg`})})]})}),t.jsx(F.Header,{children:t.jsxs(A,{direction:"horizontal",children:[t.jsx("h5",{style:{width:"8em"},children:"Show axes"}),t.jsx(y,{title:"Show/hide the axes",variant:a.displayAxes?"primary":"secondary",onClick:()=>{a.setDisplayAxes(!a.displayAxes)},children:t.jsx("i",{className:`fa ${a.displayAxes?"fa-eye":"fa-eye-slash"} fa-fw fa-lg`})})]})}),t.jsx(F.Header,{children:t.jsxs(A,{direction:"horizontal",children:[t.jsx("h5",{style:{width:"8em"},children:"Axis unit"}),t.jsxs($,{children:[t.jsx(y,{title:"Display axis as pixel",variant:a.preferedUnit==="px"?"primary":"secondary",onClick:()=>{a.setPreferedUnit("px")},children:"px"}),t.jsx(y,{title:"Display axis as milimeter if possible",variant:a.preferedUnit==="mm"?"primary":"secondary",onClick:()=>{a.setPreferedUnit("mm")},children:"mm"})]})]})})]})}function Ft(e){const{value:a,onChanged:n}=e;return t.jsxs($,{children:[t.jsx(y,{variant:a===g.IMAGE_A?"primary":"secondary",title:"Only display the image A",onClick:()=>{n(g.IMAGE_A)},children:t.jsx("i",{className:"fa fa-a fa-fw fa-lg"})}),t.jsx(y,{variant:a===g.IMAGE_B?"primary":"secondary",title:"Only display the image B",onClick:()=>{n(g.IMAGE_B)},children:t.jsx("i",{className:"fa fa-b fa-fw fa-lg"})})]})}function Ht(e){const{value:a,onChanged:n,mixedMode:s,onMixedModeChanged:r}=e;function o(i){return i>=100&&i<300}function c(i){return t.jsx(y,{variant:a===i.value?"primary":"secondary",onClick:()=>{n(i.value),r(i.value)},children:i.children})}return t.jsxs(ze,{title:t.jsx("i",{title:"Blend the two images",className:"fa fam-compare-mode fa-lg"}),variant:o(a)?"primary":"secondary",align:{lg:"start"},autoClose:!1,onClick:()=>{n(s)},children:[t.jsxs(F.Header,{children:[t.jsxs("h5",{children:[t.jsx("i",{className:"fa fam-compare-mode"})," Grey scale"]}),t.jsxs($,{children:[t.jsx(c,{value:g.MIN,children:"Min"}),t.jsx(c,{value:g.MAX,children:"Max"}),t.jsx(c,{value:g.DIFF,children:"Diff"}),t.jsx(c,{value:g.ERROR,children:"Error"}),t.jsx(c,{value:g.MUL,children:"A×B"}),t.jsx(c,{value:g.HSPLITTER,children:"Split"})]})]}),t.jsxs(F.Header,{children:[t.jsxs("h5",{children:[t.jsxs("span",{className:"fa-stack",children:[t.jsx("i",{className:"fa fam-compare-mode-left fa-stack-1x",style:{color:"cyan"}}),t.jsx("i",{className:"fa fam-compare-mode-center fa-stack-1x"}),t.jsx("i",{className:"fa fam-compare-mode-right fa-stack-1x",style:{color:"lime"}})]})," ","Green & Cyan"]}),t.jsxs($,{children:[t.jsx(c,{value:g.MIN_COLOR,children:"Min"}),t.jsx(c,{value:g.MAX_COLOR,children:"Max"}),t.jsx(c,{value:g.DIFF_COLOR,children:"Diff"}),t.jsx(c,{value:g.ERROR_COLOR,children:"Error"}),t.jsx(c,{value:g.MUL_COLOR,children:"A×B"}),t.jsx(c,{value:g.HSPLITTER_COLOR,children:"Split"})]})]})]})}function Pt(e){const a=u.useRef(e.defaultValue??""),[n,s]=u.useState(!1);function r(i){a.current=i,s(!0)}function o(){var i;(i=e.onChange)==null||i.call(e,a.current),s(!1)}const c=i=>{i.key==="Enter"&&i.ctrlKey&&o()};return tt.useEffect(()=>(document.addEventListener("keydown",c),()=>{document.removeEventListener("keydown",c)}),[]),t.jsxs(A,{direction:"vertical",gap:1,className:"mx-auto",children:[t.jsx("textarea",{rows:5,cols:40,defaultValue:a.current,onChange:i=>{r(i.target.value)}}),t.jsx(y,{variant:n?"primary":"secondary",onClick:()=>{o()},children:"Apply (Ctrl+Return)"})]})}function Dt(e){const{value:a,onChanged:n,customFunc:s,onCustomFuncChanged:r}=e;return t.jsx(ze,{title:t.jsx("i",{title:"Advanced blending based on custom webgl code",className:"fa fa-square-root-variable fa-fw fa-lg"}),variant:a===g.CUSTOM?"primary":"secondary",align:{lg:"start"},autoClose:!1,onClick:()=>{n(g.CUSTOM)},children:t.jsx(F.Header,{children:t.jsx(Pt,{defaultValue:s,onChange:o=>{r(o)}})})})}function Gt(e){const{nabu_method:a,nabu_lateral_corr:n,nabu_camera_tilt:s,nabu_exception:r}=e;return!a&&!n&&!s&&!r?null:{method:a,lateral_corr:n,camera_tilt:s,exception:r}}function Bt(e){const{lateral_motor:a,camera_tilt_motor:n}=e;return!a&&!n?null:{lateral_motor:a,camera_tilt_motor:n}}function $t(e){return e==="um"?"μm":e}function Vt(e,a,n,s){return u.useMemo(()=>{function r(i){return i==="um"?"μm":i}function o(i){return i.toFixed(s).replace(/\.?0+$/,"")}if(e===null)return["∅",""];if(a===n)return[o(e),r(n)];const c=ce(e,a);return[o(c.to(n).scalar),r(n)]},[e,a,n])}function Ee(e){const{value:a=null,unit:n,displayUnit:s,style:r,className:o,decimals:c=2}=e,[i,x]=Vt(a,n,s??n,c);return t.jsxs("span",{style:r,className:o,title:`${a} ${n}`,children:[i," ",$t(x)]})}function Xt(e){var o;const{nabuCorrection:a,decimals:n=2,lateralUnit:s="mm"}=e;if(a===null)return t.jsx(t.Fragment,{});const r=(o=a.exception)==null?void 0:o.message;return t.jsxs(Ue,{children:[t.jsxs(B,{children:[t.jsx(p,{xs:4,children:"Estimator"}),t.jsx(p,{xs:8,children:a.method?"nabu":"none"})]}),t.jsxs(B,{children:[t.jsx(p,{xs:4,children:"Method"}),t.jsx(p,{xs:8,children:a.method})]}),t.jsxs(B,{children:[t.jsx(p,{xs:4,children:"Lateral"}),t.jsx(p,{xs:8,children:t.jsx(Ee,{value:(a==null?void 0:a.lateral_corr)??0,unit:"mm",displayUnit:s,decimals:n})})]}),t.jsxs(B,{children:[t.jsx(p,{xs:4,children:"Tilt"}),t.jsx(p,{xs:8,children:t.jsx(Ee,{value:(a==null?void 0:a.camera_tilt)??0,unit:"deg",decimals:n})})]}),r&&t.jsxs(B,{children:[t.jsx(p,{xs:4,children:"Failure?"}),t.jsx(p,{xs:8,children:r})]})]})}function Wt(e){var n,s;const{description:a}=e;return a===null?t.jsx(t.Fragment,{}):t.jsxs(Ue,{children:[t.jsxs(B,{children:[t.jsx(p,{xs:4,children:"Lateral axis"}),t.jsx(p,{xs:8,children:(n=a.lateral_motor)==null?void 0:n.name})]}),t.jsxs(B,{children:[t.jsx(p,{xs:4,children:"Tilt axis"}),t.jsx(p,{xs:8,children:(s=a.camera_tilt_motor)==null?void 0:s.name})]})]})}function qt(e){var xe,he,ge,ve,je,ye;const{imageA:a,imageB:n,pixelSize:s,config:r,parameters:o,procedure:c,ignoreTilt:i=!1,decimals:x=2,lateralUnit:v="um"}=e,[j,O]=u.useState(g.MIN_COLOR),[m,d]=u.useState(g.MIN_COLOR),h=u.useRef(null),[w,L]=u.useState(0),[U,z]=u.useState(0),_=ht("zoom"),{mouseMode:T}=_,[P,V]=u.useState(void 0),[H,C]=u.useState(N.NONE),[S,b]=u.useState(0),[I,D]=u.useState(`// a: Intensity from image A, [0..1], -1 = out
// b: Intensity from image B, [0..1], -1 = out
// return: R, G, B, alpha values, [0..1]
return vec4(a, b, 0.0, 1.0);`),f=xt(),M=at(c.id),[X,k,K]=zt({lateral:0,tilt:0});u.useEffect(()=>{K.reset({lateral:o.nabu_lateral_corr??0,tilt:(i?0:o.nabu_camera_tilt??0)*(Math.PI/180)})},[o.nabu_lateral_corr??0,o.nabu_camera_tilt??0]);const{tilt:J,lateral:G}=X,Q=u.useMemo(()=>{if(s!==void 0&&r.preferedUnit!=="px")return s.to("mm").scalar},[r.preferedUnit,s]);function de(l){k({tilt:l},!0)}function ee(l){k({lateral:l},!0)}function ue(l){k({tilt:l},!1)}function W(l){k({lateral:l},!1)}u.useEffect(()=>{var l;(l=h.current)==null||l.actions.clearLater()},[a,n]);const[ne,re]=((xe=a==null?void 0:a[0])==null?void 0:xe.shape)??[1024,1024],{abscissaConfig:ke,ordinateConfig:Fe}=u.useMemo(()=>{const l=Q?"mm":"px",R=Q??1;return{abscissaConfig:{visDomain:[-re*R*.8,re*R*.8],label:`x (${l})`},ordinateConfig:{visDomain:[-ne*R*.6,ne*R*.6],label:`y (${l})`}}},[re,ne,Q]),Y=((he=c.properties)==null?void 0:he.state)==="AWAITING_USER_INPUT",He=((ge=c.properties)==null?void 0:ge.state)==="ABORTING",Pe=c.properties.state==="RUNNING"||Y||He,me=Gt(o),fe=Bt(o);u.useEffect(()=>{!Y&&_.mouseMode==="move-lateral"&&_.resetMouseMode()},[Y]);const De=u.useMemo(()=>({"move-lateral":"ew-resize"}),[]);return t.jsxs(A,{direction:"horizontal",gap:2,onKeyDown:l=>{var R,Ce;l.key===" "&&(d(Ge=>Ge===g.IMAGE_A?g.IMAGE_B:g.IMAGE_A),l.preventDefault()),l.key==="ArrowLeft"&&(W(G-Number(((R=e.pixelSize)==null?void 0:R.scalar)??0)*.5),l.preventDefault()),l.key==="ArrowRight"&&(W(G+Number(((Ce=e.pixelSize)==null?void 0:Ce.scalar)??0)*.5),l.preventDefault())},tabIndex:-1,style:e.style,children:[t.jsxs(A,{direction:"vertical",style:{alignSelf:"stretch",flexGrow:4,minWidth:0},children:[t.jsxs(gt,{align:"center",style:{zIndex:1},children:[t.jsx(vt,{mouseModeInteraction:_}),t.jsxs($,{children:[t.jsx(y,{title:"Reset zoom",variant:"secondary",onClick:()=>{var l;(l=h==null?void 0:h.current)==null||l.actions.resetZoom()},children:t.jsx("i",{className:"fa fa-expand fa-fw fa-lg"})}),t.jsx(y,{disabled:!f[2].canUndo,title:"Undo the last changes applied to the corrections",onClick:()=>{f[2].undo()},children:t.jsx("i",{className:"fa fa-reply fa-fw fa-lg"})}),t.jsx(y,{disabled:!f[2].canRedo,title:"Redo the last reverted changes applied to the corrections",onClick:()=>{f[2].redo()},children:t.jsx("i",{className:"fa fa-share fa-fw fa-lg"})})]}),t.jsx(pe,{}),t.jsx(_t,{mouseModeInteraction:_}),t.jsx(Ft,{value:m,onChanged:l=>{d(l)}}),t.jsx(Ht,{value:m,onChanged:l=>{d(l)},mixedMode:j,onMixedModeChanged:O}),t.jsx(Dt,{value:m,onChanged:l=>{d(l)},customFunc:I,onCustomFuncChanged:l=>{D(l)}}),t.jsx(Tt,{value:H,onSelect:l=>{C(l)}}),t.jsx(pe,{}),t.jsx(kt,{config:r})]}),t.jsx(u.Suspense,{fallback:null,children:t.jsxs(jt,{undoableViewpoint:f,plotRef:h,abscissaConfig:ke,ordinateConfig:Fe,aspect:"equal",showAxes:r.displayAxes,onMouseInteractionOverlayChanged:V,cursors:De,mouseMode:T,children:[t.jsx(At,{unit:Q===void 0?"px":"mm"}),t.jsx(pt,{loading:e.loading,warning:a===void 0||n===void 0?"No data":void 0,danger:e.loading?void 0:e.error}),a&&n&&t.jsx(wt,{imageA:a[0],imageB:n[0],stateA:a[1],stateB:n[1],displayMode:m,lateral:-G*2/(((ve=e.pixelSize)==null?void 0:ve.scalar)??0),pixelSize:r.preferedUnit!=="px"?e.pixelSize:void 0,onLateralChanged:l=>{var R;W(-l*(((R=e.pixelSize)==null?void 0:R.scalar)??0))},onLateralIntermediateChanged:l=>{var R;ee(-l*(((R=e.pixelSize)==null?void 0:R.scalar)??0))},tilt:J,autoScale:r.autoscaleMode,verticalSeparator:S,customFunc:I,filterMode:H,lateralInteration:P===void 0&&T==="move-lateral"}),t.jsx(dt,{geometry:{x:w},onGeometryChanged:l=>{L(l.x)},visible:r.displayVLine}),t.jsx(be,{geometry:{y:U},onGeometryChanged:l=>{z(l.y)},visible:r.displayHLine}),t.jsx(be,{geometry:{y:S},color:"red",onGeometryChanged:l=>{b(l.y)},visible:m===g.HSPLITTER||m===g.HSPLITTER_COLOR}),t.jsx(It,{mouseMode:T,disabled:P!==void 0,plotUnit:Q===void 0?"px":"mm"})]})})]}),t.jsx(A,{direction:"vertical",gap:2,className:"m-1",style:{width:"20em"},children:t.jsxs(A,{style:{minWidth:"20em"},className:"mt-4",direction:"vertical",gap:2,children:[t.jsx(se,{in:!!fe,dimension:"height",children:t.jsxs("div",{children:[t.jsx("h4",{children:"Description"}),t.jsx(Wt,{description:fe})]})}),t.jsx(se,{in:!!me,dimension:"height",children:t.jsxs("div",{children:[t.jsx("h4",{children:"Estimation"}),t.jsx(Xt,{nabuCorrection:me,lateralUnit:v,decimals:x})]})}),t.jsx(se,{in:Y,dimension:"height",children:t.jsxs("div",{children:[t.jsx("h4",{children:"Correction"}),t.jsxs(A,{className:"mb-2",direction:"horizontal",children:[t.jsx(y,{className:"me-1",variant:T==="move-lateral"?"primary":"secondary",title:"Shift the two images to compare and edit the ROIs",onClick:()=>{_.setOrResetMouseMode("move-lateral")},children:t.jsx("i",{className:"fa fa-arrow-right-arrow-left fa-fw fa-lg"})}),t.jsxs($,{children:[t.jsx(y,{disabled:!K.canUndo,title:"Undo the last changes applied to the corrections",onClick:()=>{K.undo()},children:t.jsx("i",{className:"fa fa-reply fa-fw fa-lg"})}),t.jsx(y,{disabled:!K.canRedo,title:"Redo the last reverted changes applied to the corrections",onClick:()=>{K.redo()},children:t.jsx("i",{className:"fa fa-share fa-fw fa-lg"})})]})]}),t.jsxs(A,{direction:"horizontal",gap:2,children:[t.jsx(te.Label,{style:{width:"5em"},children:"Lateral"}),t.jsxs(A,{direction:"vertical",gap:2,children:[t.jsx(le,{value:G,unit:"mm",preferedDisplayUnit:v,step:.01,decimals:x,onChange:l=>{W(l)},onIntermediateChange:l=>{ee(l)}}),t.jsx(le,{value:G,unit:"mm",decimals:x,preferedDisplayUnit:"px",pixelSize:e.pixelSize,step:.01,onChange:l=>{W(l)},onIntermediateChange:l=>{ee(l)}}),t.jsx(Me,{min:-200*(((je=e.pixelSize)==null?void 0:je.scalar)??0),max:200*(((ye=e.pixelSize)==null?void 0:ye.scalar)??0),value:G,step:.01,onChange:l=>{W(l)},onIntermediateChange:l=>{ee(l)}})]})]}),!i&&t.jsxs(A,{direction:"horizontal",gap:2,children:[t.jsx(te.Label,{style:{width:"5em"},children:"Tilt"}),t.jsxs(A,{direction:"vertical",gap:2,children:[t.jsx(le,{step:.01,value:J,unit:"rad",decimals:x,displayUnit:"deg",onChange:l=>{ue(l)},onIntermediateChange:l=>{de(l)}}),t.jsx(Me,{min:-1,max:1,step:.01,value:J,onChange:l=>{ue(l)},onIntermediateChange:l=>{de(l)}})]})]}),t.jsxs(A,{className:"mx-auto mt-4 justify-content-center",direction:"horizontal",gap:2,children:[t.jsx(y,{variant:"danger",size:"lg",disabled:!Y,onClick:()=>{M.call("validate",{lateral_corr:G,camera_tilt:i?null:J*180/Math.PI})},title:"This will apply the correction to the axes of the beamline",children:"Apply corrections"}),t.jsx(y,{size:"lg",onClick:()=>{M.call("abort")},disabled:!Pe,children:"Abort"})]})]})})]})})]})}function Kt(){const[e,a]=q("tomo/align/colormap/autoscalemode",E.StdDev3),[n,s]=q("tomo/align/axes",!0),[r,o]=q("tomo/align/vline",!1),[c,i]=q("tomo/align/hline",!1),[x,v]=q("tomo/align/crosshair",!1),[j,O]=q("tomo/align/preferedunit","mm");return{autoscaleMode:e,setAutoscaleMode:a,displayAxes:n,setDisplayAxes:s,displayVLine:r,setDisplayVLine:o,displayHLine:c,setDisplayHLine:i,crossHair:x,setCrossHair:v,preferedUnit:j,setPreferedUnit:O}}we("daiquiri.components.tomo.TomoAlign");function Qt(e){var H;const{options:a}=e,n=Kt(),{procedure:s,ignoretilt:r=!1,decimals:o,lateralunit:c}=a,i=nt(s??""),x=(i==null?void 0:i.properties)??{},v=(x==null?void 0:x.parameters)??{},j=(H=v.data_scan)==null?void 0:H.key,O=u.useMemo(()=>{if(v.pixel_size_mm!==void 0)return new ce(v.pixel_size_mm,"mm")},[v.pixel_size_mm]),m=ut({scanId:j,channelNames:["proj0","proj0_min","proj0_max","proj0_min_positive","proj0_mean","proj0_std","proj180","proj180_min","proj180_max","proj180_min_positive","proj180_mean","proj180_std"],start:0,stop:1});function d(C){var b,I;if(((b=m==null?void 0:m.request)==null?void 0:b.scanId)!==j)return;const S=(I=m.data[C])==null?void 0:I.pick(0,null,null);return S&&Ie(S)}function h(C){var I;const S=(I=m.data[C])==null?void 0:I.pick(0,null,null);return S===void 0?void 0:Ie(S).data[0]}function w(C){const S=h(`${C}_min`),b=h(`${C}_max`),I=h(`${C}_min_positive`),D=h(`${C}_mean`),f=h(`${C}_std`);if(!(S===void 0||b===void 0||I===void 0||D===void 0||f===void 0))return{min:S,max:b,mean:D,std:f,minPositive:I}}const L=d("proj0"),U=d("proj180"),z=w("proj0"),_=w("proj180");function T(C,S){return u.useMemo(()=>{if(!(C===void 0||S===void 0))return[C,S]},[C,S])}const P=T(L,z),V=T(U,_);try{_e(L),_e(U)}catch{return t.jsx(t.Fragment,{children:"Image data unsupported"})}return i===null?t.jsxs(rt,{variant:"danger",children:["Procedure ",s," is not available"]}):t.jsx(qt,{procedureId:j==null?void 0:j.toString(),config:n,procedure:i,parameters:v,pixelSize:O,imageA:P,imageB:V,loading:m.loading,error:m.errors?m.errors.join(`
`):void 0,ignoreTilt:r,decimals:o,lateralUnit:c,style:{flexGrow:1,flexShrink:1,minWidth:0,minHeight:0,alignSelf:"stretch",width:"100%",height:"100%"}})}function Yt(e){return t.jsx(Qt,{...e})}function xa(e){const{yamlNode:a,procedure:n,ignoretilt:s,decimals:r,lateralunit:o,...c}=e;it(a,"procedure",n),st(a,"ignoretilt",s),ot(a,"decimals",r),lt(a,"lateralunit",o),ct(a,c);const i={procedure:n,ignoretilt:s,decimals:r,lateralunit:o};return t.jsx(Yt,{options:i})}export{xa as default};
