"""
Mixins for SQLAlchemy models.

Provides reusable mixins for common model features:
- Primary key (auto-increment integer)
- UUID field (as external identifier, not necessarily primary key)
- Timestamps (created_at, updated_at)
- Soft delete (deleted_at)
"""

from datetime import datetime, timezone
from typing import Any
from uuid import UUID, uuid4

from sqlalchemy import Column, DateTime, Integer, func
from sqlalchemy.dialects.postgresql import UUID as PostgresUUID
from sqlalchemy.types import CHAR, TypeDecorator


def utcnow() -> datetime:
    """
    Get current UTC datetime.

    Returns:
        datetime: Current UTC datetime
    """
    return datetime.now(timezone.utc)


class GUID(TypeDecorator):
    """
    Platform-independent GUID type.

    Uses PostgreSQL's UUID type when available, otherwise uses CHAR(36).
    This ensures compatibility across different database backends.

    Stores and returns UUID objects, converting to/from strings as needed.
    """

    impl = CHAR
    cache_ok = True

    def load_dialect_impl(self, dialect: Any) -> Any:
        if dialect.name == "postgresql":
            return dialect.type_descriptor(PostgresUUID())
        else:
            return dialect.type_descriptor(CHAR(36))

    def process_bind_param(
        self, value: UUID | str | None, dialect: Any
    ) -> UUID | str | None:
        if value is None:
            return value
        elif dialect.name == "postgresql":
            # PostgreSQL accepts UUID objects directly
            return value
        else:
            # For other databases, convert to string
            if isinstance(value, UUID):
                return str(value)
            elif isinstance(value, str):
                return value
            else:
                return str(value)

    def process_result_value(
        self, value: UUID | str | None, dialect: Any
    ) -> UUID | None:
        if value is None:
            return value
        else:
            # Always return UUID object
            if isinstance(value, UUID):
                return value
            elif isinstance(value, str):
                return UUID(value)
            else:
                return UUID(str(value))


class PrimaryKeyMixin:
    """
    Mixin to add an auto-increment integer primary key to a model.

    Provides an 'id' column with Integer type as primary key.
    The ID is automatically generated by the database (auto-increment).

    This is the most common pattern for primary keys in relational databases.
    Use this when you want a simple, efficient integer primary key.

    Example:
        >>> class User(PrimaryKeyMixin, Base):
        ...     __tablename__ = "users"
        ...     name = Column(String)
        ...     # id is automatically added as Integer primary key

    Note:
        You can combine this with UUIDMixin to have both:
        - id (Integer, PK) for internal use
        - uuid (UUID) for external/public use
    """

    id = Column(
        Integer,
        primary_key=True,
        autoincrement=True,
        nullable=False,
        index=True,
    )


class UUIDMixin:
    """
    Mixin to add a UUID field to a model.

    Provides a 'uuid' column with UUID type. The UUID is automatically
    generated if not provided. This field is NOT a primary key by default,
    allowing you to use it as an external/public identifier while having
    a separate auto-increment primary key internally.

    You can use this mixin in two ways:
    1. As a non-primary key field (default, recommended):
       >>> from fastapi_crud_kit.models import PrimaryKeyMixin, UUIDMixin
       >>> class User(PrimaryKeyMixin, UUIDMixin, Base):
       ...     __tablename__ = "users"
       ...     # id (Integer, PK) added by PrimaryKeyMixin
       ...     # uuid (UUID) added by UUIDMixin, external identifier
       ...     name = Column(String)

    2. As a primary key (override the uuid column):
       >>> class User(UUIDMixin, Base):
       ...     __tablename__ = "users"
       ...     uuid = Column(GUID(), primary_key=True, ...)  # Override to make it PK
       ...     name = Column(String)

    Example:
        >>> from fastapi_crud_kit.models import PrimaryKeyMixin, UUIDMixin
        >>> class User(PrimaryKeyMixin, UUIDMixin, Base):
        ...     __tablename__ = "users"
        ...     # id (Integer, PK) and uuid (UUID) are automatically added
        ...     name = Column(String)
    """

    uuid = Column(
        GUID(),
        default=uuid4,
        nullable=False,
        unique=True,
        index=True,
    )  # type: ignore[var-annotated]


class TimestampMixin:
    """
    Mixin to add created_at and updated_at timestamps to a model.

    Provides:
    - created_at: DateTime set automatically on creation
    - updated_at: DateTime set automatically on creation and update

    Both timestamps use UTC timezone.

    Example:
        >>> class User(TimestampMixin, Base):
        ...     __tablename__ = "users"
        ...     name = Column(String)
    """

    created_at = Column(
        DateTime(timezone=True),
        nullable=False,
        server_default=func.now(),
        default=utcnow,
        index=True,
    )

    updated_at = Column(
        DateTime(timezone=True),
        nullable=False,
        server_default=func.now(),
        default=utcnow,
        onupdate=utcnow,
        index=True,
    )


class SoftDeleteMixin:
    """
    Mixin to add soft delete functionality to a model.

    Provides a 'deleted_at' column that can be set to mark a record as deleted.
    Records with deleted_at IS NULL are considered active.

    Example:
        >>> class User(SoftDeleteMixin, Base):
        ...     __tablename__ = "users"
        ...     name = Column(String)
    """

    deleted_at = Column(
        DateTime(timezone=True),
        nullable=True,
        default=None,
        index=True,
    )

    def soft_delete(self) -> None:
        """
        Mark this instance as soft-deleted.

        Sets deleted_at to the current UTC timestamp.
        """
        self.deleted_at = utcnow()  # type: ignore[assignment]

    def restore(self) -> None:
        """
        Restore this soft-deleted instance.

        Sets deleted_at back to None.
        """
        self.deleted_at = None  # type: ignore[assignment]

    @property
    def is_deleted(self) -> bool:
        """
        Check if this instance is soft-deleted.

        Returns:
            bool: True if deleted_at is not None, False otherwise
        """
        return self.deleted_at is not None
