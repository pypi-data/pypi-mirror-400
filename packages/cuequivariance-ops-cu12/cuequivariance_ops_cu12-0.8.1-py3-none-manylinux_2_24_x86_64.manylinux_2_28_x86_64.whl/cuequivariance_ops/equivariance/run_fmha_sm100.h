#pragma once

#include <cuda_fp16.h>

namespace cudnn_fmha {

template <typename DType>
void run_fmha_sm100(DType* q_ptr,
                    DType* k_ptr,
                    DType* v_ptr,
                    DType* o_ptr,
                    bool* mask_bias_ptr,
                    int* actual_s_kv_ptr,
                    DType* triangle_bias_ptr,
                    float* softmax_lse_ptr,
                    float* softmax_max_ptr,
                    const uint32_t B,
                    const uint32_t I,
                    const uint32_t H,
                    const uint32_t S_qo,
                    const uint32_t S_kv,
                    const uint32_t D,
                    const float bmm_scale,
                    void* stream_ = nullptr);

extern template void run_fmha_sm100<__nv_bfloat16>(__nv_bfloat16*,
                                                   __nv_bfloat16*,
                                                   __nv_bfloat16*,
                                                   __nv_bfloat16*,
                                                   bool*,
                                                   int*,
                                                   __nv_bfloat16*,
                                                   float*,
                                                   float*,
                                                   const uint32_t,
                                                   const uint32_t,
                                                   const uint32_t,
                                                   const uint32_t,
                                                   const uint32_t,
                                                   const uint32_t,
                                                   const float,
                                                   void*);

extern template void run_fmha_sm100<__half>(__half*,
                                            __half*,
                                            __half*,
                                            __half*,
                                            bool*,
                                            int*,
                                            __half*,
                                            float*,
                                            float*,
                                            const uint32_t,
                                            const uint32_t,
                                            const uint32_t,
                                            const uint32_t,
                                            const uint32_t,
                                            const uint32_t,
                                            const float,
                                            void*);

template <typename DType>
void run_fmha_bwd_sm100(DType* q_ptr,
                        DType* k_ptr,
                        DType* v_ptr,
                        DType* o_ptr,
                        bool* mask_bias_ptr,
                        DType* triangle_bias_ptr,
                        float* softmax_lse_ptr,
                        DType* do_ptr,
                        DType* dq_ptr,
                        DType* dk_ptr,
                        DType* dv_ptr,
                        DType* dtriangle_bias_ptr,
                        float* do_o_dot_tmp_ptr,
                        float* dq_tmp_ptr,              // must be zero initialized
                        float* dtriangle_bias_tmp_ptr,  // must be zero initialized
                        const uint32_t B,
                        const uint32_t I,
                        const uint32_t H,
                        const uint32_t S_qo,
                        const uint32_t S_kv,
                        const uint32_t D,
                        const float bmm_scale,
                        void* stream_ = nullptr);

extern template void run_fmha_bwd_sm100<__nv_bfloat16>(__nv_bfloat16*,
                                                       __nv_bfloat16*,
                                                       __nv_bfloat16*,
                                                       __nv_bfloat16*,
                                                       bool*,
                                                       __nv_bfloat16*,
                                                       float*,
                                                       __nv_bfloat16*,
                                                       __nv_bfloat16*,
                                                       __nv_bfloat16*,
                                                       __nv_bfloat16*,
                                                       __nv_bfloat16*,
                                                       float*,
                                                       float*,
                                                       float*,
                                                       const uint32_t,
                                                       const uint32_t,
                                                       const uint32_t,
                                                       const uint32_t,
                                                       const uint32_t,
                                                       const uint32_t,
                                                       const float,
                                                       void* stream_);

extern template void run_fmha_bwd_sm100<__half>(__half*,
                                                __half*,
                                                __half*,
                                                __half*,
                                                bool*,
                                                __half*,
                                                float*,
                                                __half*,
                                                __half*,
                                                __half*,
                                                __half*,
                                                __half*,
                                                float*,
                                                float*,
                                                float*,
                                                const uint32_t,
                                                const uint32_t,
                                                const uint32_t,
                                                const uint32_t,
                                                const uint32_t,
                                                const uint32_t,
                                                const float,
                                                void* stream_);

}  // namespace cudnn_fmha
