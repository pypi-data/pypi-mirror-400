import{j as e,r as f,an as I,aL as P,ay as S,aU as R,g as J,R as V,C as y,aj as q,B as k,ba as Q,bb as ee,u as ae,aX as te,aY as oe,A as se,bB as U,bC as ne,q as G,a1 as re,be as ie}from"./index-4cf586ed.js";import{S as A,a as K,n as le,p as ce,F as de,r as ue}from"./index-19c84627.js";import{L as me,b as xe,u as ge,T as fe,D as pe,S as H}from"./UseMouseModeInteraction-9b6c111c.js";import{V as Y}from"./VSegment-5d77576e.js";import{L as N}from"./Label-7daca8b6.js";import{l as L}from"./hooks-e7539055.js";import{L as he}from"./LoadingMessage-072bb4e8.js";import{W as je}from"./WorldScale-862ee5ba.js";import{V as ve,u as ye}from"./VLineRoi-75cfdd39.js";import{D as Ce}from"./DropdownButton-9a594aef.js";import{P as Se}from"./SelectionPoint-7fbd4e1f.js";import{H as be,a as Me}from"./HSegment-26c3fd51.js";import"./colors-5bf0897d.js";import"./ScreenScale-fdd43179.js";import"./DraggableRect-8e897252.js";import"./types-0be7083b.js";const D=.1;function we(t,a){if(!t)return{translationrange:A([0,1024],D),rotationrange:A([0,360],D)};const{rotationrange:s,translationrange:o}=t;if(a==="marker")return{translationrange:A(o,D),rotationrange:A(s,D)};if(a==="solid"){const{rotationaxispoints:r}=t,n=Math.abs(s[1]-s[0])/r;return{translationrange:o,rotationrange:[s[0]-n/2,s[1]-n/2]}}throw new Error(`Expected "marker" or "solid" render mode. Got ${a}`)}function Fe(t){return f.useMemo(()=>{if(t===void 0)return;const a=t instanceof Float32Array?t:Float32Array.from(t.data);return I(a,t.shape)},[t])}function Re(t){const{vData:a,xRange:s,xAxisSize:o,yRange:r,yAxisSize:n,colorMap:i,scaleType:l,invertColorMap:c,domain:p}=t,d=f.useMemo(()=>{const g=(a==null?void 0:a.shape[0])??0;return(g-g%o)/o},[a,o]),h=f.useMemo(()=>{if(a===void 0||d===0)return;const g=a.data.subarray(0,d*o);return I(g,[d,o])},[d,o]),u=Fe(h);if(u===void 0)return e.jsx(e.Fragment,{});const j=Math.abs(r[1]-r[0]),m=Math.abs(s[1]-s[0])/o,x=j/n;return e.jsx(ce,{position:[(s[0]+s[1])*.5,r[0]+j*(u.shape[0]/n)*.5,0],size:{width:u.shape[1],height:u.shape[0]},scale:[m,x,1],values:u,domain:p,colorMap:i,scaleType:l,invertColorMap:c})}function Ae(t){const{xData:a,yData:s,vData:o,domain:r,colorMap:n="Viridis",invertColorMap:i=!1,scaleType:l=K.Linear,markerSize:c=8,renderMode:p,...d}=t;return a===void 0||s===void 0||o===void 0?e.jsx(e.Fragment,{}):p==="marker"?e.jsx(je,{children:e.jsx(le,{abscissas:a.data,ordinates:s.data,data:o.data,size:c,domain:r,scaleType:l,invertColorMap:!1,colorMap:n})}):e.jsx(Re,{xData:a,yData:s,vData:o,domain:r,scaleType:l,invertColorMap:!1,colorMap:n,...d})}P("daiquiri.components.tomo.SinogramPlot");function De(t){const{datacollectionMeta:a}=t,s=a.requestedCor!==null&&a.requestedCor!==a.actualCor;return e.jsxs(e.Fragment,{children:[a.estimatedCor!==null&&a.estimatedCor!==a.actualCor&&e.jsxs(e.Fragment,{children:[e.jsx(Y,{x:a.estimatedCor,y1:0,y2:360,color:"#505050",gapColor:"#909090",dashSize:10,gapSize:10}),e.jsx(N,{datapos:[a.estimatedCor,10],color:"#A0A0A0",text:"Estimated CoR"})]}),a.actualCor!==null&&e.jsxs(e.Fragment,{children:[e.jsx(ve,{geometry:{x:a.requestedCor??a.actualCor},onGeometryChanged:(o,r)=>{t.setRequestedCor(o.x,r)}}),e.jsx(N,{datapos:[a.requestedCor??a.actualCor,s?40:25],color:"#FFFFFF",text:s?"Requested CoR":"Actual CoR"})]}),s&&a.actualCor!==null&&e.jsxs(e.Fragment,{children:[e.jsx(Y,{x:a.actualCor,y1:0,y2:360,color:"#000000",gapColor:"#FFFFFF",dashSize:10,gapSize:10}),e.jsx(N,{datapos:[a.actualCor,25],color:"#FFFFFF",text:"Actual CoR"})]})]})}function Ne(t){var m,x;const{xdata:a,ydata:s,vdata:o,sinogram:r,renderMode:n,datacollectionMeta:i,mouseMode:l}=t,{translationrange:c,rotationrange:p}=we(r,n),d=de(o),h=Math.min(a.size,s.size,o.size),u=L(a,0,h),j=L(s,0,h),b=L(o,0,h);return e.jsxs("div",{style:{flex:"1 1 auto",display:"flex",margin:0,minHeight:0},children:[e.jsxs(me,{plotRef:t.plotRef,showAxes:((m=t.viewConfig)==null?void 0:m.displayAxes)??!0,title:"Sinogram",abscissaConfig:{visDomain:c,showGrid:!0,label:"Profile"},ordinateConfig:{visDomain:p,showGrid:!0,label:"Rotation",flip:!0},mouseMode:l,children:[r&&d&&e.jsx(Ae,{xData:u,yData:j,vData:b,domain:d,colorMap:"Viridis",xAxisSize:r.translationaxispoints,yAxisSize:r.rotationaxispoints,xRange:r.translationrange,yRange:r.rotationrange,renderMode:n}),i!==void 0&&e.jsx(De,{setRequestedCor:t.setRequestedCor,datacollectionMeta:i}),e.jsx(he,{...t.message}),t.children]}),(((x=t.viewConfig)==null?void 0:x.colorbarVisible)??!0)&&e.jsx(ue,{domain:d??[0,0],withBounds:!0,colorMap:"Viridis",invertColorMap:!1,scaleType:K.Linear})]})}function ze(t){const{onSelect:a,value:s}=t,o={marker:"Marker",solid:"Solid"},r=o[s];return e.jsxs(Ce,{title:r,id:"bg-vertical-dropdown-4",variant:"secondary",onSelect:n=>{n!==null&&a(n)},children:[e.jsx(S.Item,{eventKey:"marker",children:o.marker}),e.jsx(S.Item,{eventKey:"solid",children:o.solid})]})}const T=P("daiquiri.components.tomo.sinogram.AxisRotationPositionInteraction");function Ve(t){const{operator:a,resetMouseMode:s}=t,o=xe(),{mouseMode:r,actions:n}=o??{},i=f.useCallback(l=>{const c=l.dataPt.x;s(),t.setRequestedCor(c)},[t.setRequestedCor,n]);return a?r!=="set-axis-rotation"?(T("disabled: mouseMode dont match"),e.jsx(e.Fragment,{})):(T("enabled"),e.jsx(Se,{onClick:i})):(T("disabled: not operator"),e.jsx(e.Fragment,{}))}function qe(t){var n;const{rotationHardware:a,detectorWidth:s}=t,o=(n=a==null?void 0:a.properties)==null?void 0:n.position;if(o==null||s===void 0)return e.jsx(e.Fragment,{});const r=a==null?void 0:a.name;return e.jsxs(e.Fragment,{children:[e.jsx(be,{y:o,x1:0,x2:s,color:"red",gapColor:"write",dashSize:10,gapSize:10,lineWidth:3}),e.jsx(N,{datapos:[10,o],color:"#FF0000",anchor:"top",vmargin:10,text:r??"srot"})]})}function Le(){const[t,a]=R("tomo/sinogramview/axes",!0),[s,o]=R("tomo/sinogramview/colorbar-visible",!1),[r,n]=R("tomo/sinogramview/crosshair",!1),[i,l]=R("tomo/sinogramview/displayed",!0);return{colorbarVisible:s,setColorbarVisible:o,displayAxes:t,setDisplayAxes:a,crossHair:r,setCrossHair:n,displayedSinogram:i,setDisplayedSinogram:l}}function Te(t,a,s){return t!==a?"secondary":s||"primary"}function C(t){return e.jsx(k,{variant:Te(t.var,t.value,t.variantWhenSelected),onClick:()=>{t.setter(t.value)},className:"text-nowrap",size:"sm",children:t.children})}function ke(t){const{as:a=void 0,variant:s="secondary",config:o}=t;return e.jsxs(S,{as:a,children:[e.jsx(S.Toggle,{id:"dropdown-basic",variant:s,className:"d-flex align-items-center",children:e.jsx("i",{className:"fa fa-sliders fa-fw fa-lg"})}),e.jsx(S.Menu,{className:"dropdown-menu-center",children:e.jsx("div",{className:"ms-1 me-1",style:{minWidth:"300px"},children:e.jsxs(J,{children:[e.jsxs(V,{children:[e.jsx(y,{className:"my-auto",children:"Sinogram"}),e.jsx(y,{xs:7,children:e.jsxs(q,{children:[e.jsx(C,{var:o.displayedSinogram,value:!0,setter:o.setDisplayedSinogram,children:"Displayed"}),e.jsx(C,{var:o.displayedSinogram,value:!1,setter:o.setDisplayedSinogram,variantWhenSelected:"warning",children:"Hide"})]})})]}),e.jsxs(V,{className:"mt-1",children:[e.jsx(y,{className:"my-auto",children:"Display axes"}),e.jsx(y,{xs:7,children:e.jsxs(q,{children:[e.jsx(C,{var:o.displayAxes,value:!0,setter:o.setDisplayAxes,children:"Yes"}),e.jsx(C,{var:o.displayAxes,value:!1,setter:o.setDisplayAxes,children:"No"})]})})]}),e.jsxs(V,{className:"mt-1",children:[e.jsx(y,{className:"my-auto",children:"Color bar"}),e.jsx(y,{xs:7,children:e.jsxs(q,{children:[e.jsx(C,{var:o.colorbarVisible,value:!0,setter:o.setColorbarVisible,children:"Displayed"}),e.jsx(C,{var:o.colorbarVisible,value:!1,setter:o.setColorbarVisible,children:"Hide"})]})})]})]})})})]})}P("daiquiri.components.tomo.TomoSinogram");function Ie(t){var B,O;const{sinogram:a,selectedScan:s,options:o}=t,{tomoconfig:r}=o,{datacollectionid:n,datacollectionMeta:i}=Q(o.datacollectionid),l=ee(),c=Le(),p=c.displayedSinogram?(a==null?void 0:a.actualnbpoints)??0:0,[d,h]=f.useState("solid"),u=ae(),j=te(r??""),b=oe(j);f.useEffect(()=>{n!==void 0&&l.updateDataCollectionMeta(n,{estimatedCor:null,requestedCor:null,actualCor:null})},[n]);const m=ye({scanId:a!==void 0?s??void 0:void 0,channelNames:["sinogram","rotation","translation"],start:0,stop:p}),x=f.useRef(null),g=ge("zoom"),{mouseMode:E}=g,z=I(new Float32Array([]),[0]),M=m.data.translation,w=m.data.rotation,F=m.data.sinogram;function X(){if(s===null)return{info:"No scan"};if(!a)return{info:"No sinogram defined"};if(!M||!w||!F){if(m.loading)return{warning:"Waiting for data..."};if(!M)return{danger:"Data for x-axis are missing"};if(!w)return{danger:"Data for y-axis are missing"};if(!F)return{danger:"Data for intensity are missing"}}return Math.min(M.size,w.size,F.size)===0?{warning:"Waiting for data..."}:{}}const Z=X(),_=(O=(B=t.sinogram)==null?void 0:B.translationrange)==null?void 0:O[1],W=f.useCallback((v,$)=>{n!==void 0&&($||Me({datacollectionid:n,axisposition:v,filename:(i==null?void 0:i.sourceFilename)??void 0}),l.updateDataCollectionMeta(n,{requestedCor:v}))},[n,i==null?void 0:i.sourceFilename]);return e.jsxs("div",{className:"plot2d-container w-100 h-100",style:{flex:"1 1 0%",display:"flex",flexDirection:"column"},children:[e.jsxs(fe,{align:"center",children:[e.jsx(pe,{mouseModeInteraction:g}),e.jsx(k,{title:"Reset zoom (sample stage overview)",variant:"secondary",onClick:()=>{var v;(v=x==null?void 0:x.current)==null||v.actions.resetZoom()},children:e.jsx("i",{className:"fa fa-expand fa-fw fa-lg"})}),e.jsx(H,{}),e.jsx(k,{title:u?"Select another center of rotation for the slice reconstruction":"You have to get the control on the session to set the center of rotation",disabled:!u,variant:E==="set-axis-rotation"?"warning":"secondary",onClick:()=>{g.setOrResetMouseMode("set-axis-rotation")},children:e.jsx("i",{className:"fad fam-tomo-cor fa-fw fa-lg"})}),e.jsx(H,{}),e.jsx(ze,{value:d,onSelect:h}),e.jsx(ke,{config:c})]}),!c.displayedSinogram&&e.jsx(se,{variant:"warning",children:"Sinogram was disabled by user"}),c.displayedSinogram&&e.jsxs(Ne,{viewConfig:c,message:Z,mouseMode:E,xdata:M??z,ydata:w??z,vdata:F??z,sinogram:a,renderMode:d,plotRef:x,datacollectionMeta:i,setRequestedCor:W,children:[e.jsx(Ve,{operator:u,resetMouseMode:g.resetMouseMode,setRequestedCor:W}),e.jsx(qe,{rotationHardware:b.somega,detectorWidth:_})]})]})}function Pe(){return U(t=>{const a=t.scaninfo.lastgroup;return(a==null?void 0:a.sinogram)??void 0},ne)}function Ee(){return U(t=>{const a=t.scaninfo.lastgroup;return(a==null?void 0:a.scanid)??null})}function We(t){const a=Pe(),s=Ee();return e.jsx(Ie,{...t,sinogram:a,selectedScan:s})}function oa(t){const{yamlNode:a,tomoconfig:s,datacollectionid:o,...r}=t;G(a,r),re(a,"tomoconfig",s),ie(a,"datacollectionid",o),G(a,r);const n={datacollectionid:o,tomoconfig:s};return e.jsx(We,{options:n})}export{oa as default};
