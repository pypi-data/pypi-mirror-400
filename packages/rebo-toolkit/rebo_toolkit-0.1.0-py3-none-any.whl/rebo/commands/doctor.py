\
from __future__ import annotations

from pathlib import Path
from typing import List

from ..core import CheckResult, detect_repo_type, rel, write_text
from .. import templates


RECOMMENDED_FILES = [
    ("README.md", "A short overview and quickstart."),
    ("LICENSE", "License text (MIT/Apache/etc)."),
    (".gitignore", "Ignore build artifacts and env files."),
    ("CHANGELOG.md", "Release notes / changes."),
    (".github/workflows/ci.yml", "Basic CI workflow."),
    ("CONTRIBUTING.md", "Contribution guidelines."),
    ("CODE_OF_CONDUCT.md", "Behavior expectations."),
    ("SECURITY.md", "Security reporting info."),
]


def cmd_doctor(args) -> int:
    root = Path(args.path).resolve()
    repo_type = detect_repo_type(root)

    results = _run_checks(root, repo_type)
    _print_results(results)

    if args.fix:
        _apply_fixes(root, repo_type, overwrite=bool(args.force))
        print("\n[FIX] Applied placeholder fixes. Re-run `rebo doctor` to verify.")
    return 0


def _run_checks(root: Path, repo_type: str) -> List[CheckResult]:
    res: List[CheckResult] = []

    for f, desc in RECOMMENDED_FILES:
        p = root / f
        ok = p.exists()
        res.append(CheckResult(
            key=f,
            ok=ok,
            message=("OK" if ok else "MISSING") + f" - {desc}",
            fix_hint="Use `rebo doctor --fix` to generate placeholders." if not ok else "",
        ))

    # type-specific basics
    if repo_type == "python":
        res.append(CheckResult(
            key="pyproject.toml",
            ok=(root / "pyproject.toml").exists(),
            message="Python packaging file (pyproject.toml)",
            fix_hint="Use `rebo init --profile py-lib` for a ready skeleton."
        ))
        res.append(CheckResult(
            key="tests/",
            ok=(root / "tests").exists(),
            message="Test folder",
            fix_hint="Add pytest tests under tests/."
        ))
    elif repo_type == "node":
        res.append(CheckResult(
            key="package.json",
            ok=(root / "package.json").exists(),
            message="Node package definition",
            fix_hint="Use `rebo init --profile node-lib`."
        ))
    elif repo_type == "c":
        res.append(CheckResult(
            key="Makefile/CMakeLists.txt",
            ok=(root / "Makefile").exists() or (root / "CMakeLists.txt").exists(),
            message="Build definition for C projects",
            fix_hint="Add Makefile or CMakeLists.txt."
        ))

    return res


def _print_results(results: List[CheckResult]) -> None:
    # simple console output (no extra deps)
    ok_count = sum(1 for r in results if r.ok)
    total = len(results)
    print(f"[DOCTOR] {ok_count}/{total} checks OK\n")

    for r in results:
        status = "[OK] " if r.ok else "[!!] "
        print(status + r.key + " :: " + r.message)
        if (not r.ok) and r.fix_hint:
            print("      -> " + r.fix_hint)


def _apply_fixes(root: Path, repo_type: str, overwrite: bool) -> None:
    # only create missing placeholders; do not overwrite unless --force.
    def w(relpath: str, content: str):
        p = root / relpath
        wrote = write_text(p, content, overwrite=overwrite)
        if wrote:
            print(f"[OK]  created {rel(p)}")
        else:
            print(f"[SKIP] {rel(p)} exists")

    if not (root / "README.md").exists() or overwrite:
        w("README.md", templates.README_TEMPLATE.format(
            project_name=root.name,
            tagline="(auto-generated placeholder)",
            quickstart="```bash\n# TODO\n```\n"
        ))

    if not (root / "LICENSE").exists() or overwrite:
        w("LICENSE", templates.license_text("MIT", "Unknown"))

    if not (root / ".gitignore").exists() or overwrite:
        if repo_type == "python":
            w(".gitignore", templates.PY_GITIGNORE)
        elif repo_type == "node":
            w(".gitignore", templates.NODE_GITIGNORE)
        elif repo_type == "c":
            w(".gitignore", templates.C_GITIGNORE)
        else:
            w(".gitignore", "# Generated by rebo\n")

    if not (root / "CHANGELOG.md").exists() or overwrite:
        w("CHANGELOG.md", "# Changelog\n\n## Unreleased\n- \n")

    if not (root / "CONTRIBUTING.md").exists() or overwrite:
        w("CONTRIBUTING.md", templates.CONTRIBUTING)

    if not (root / "CODE_OF_CONDUCT.md").exists() or overwrite:
        w("CODE_OF_CONDUCT.md", templates.CODE_OF_CONDUCT)

    if not (root / "SECURITY.md").exists() or overwrite:
        w("SECURITY.md", templates.SECURITY)

    wf = root / ".github" / "workflows" / "ci.yml"
    if not wf.exists() or overwrite:
        if repo_type == "python":
            w(".github/workflows/ci.yml", templates.gh_actions_ci_python())
        elif repo_type == "node":
            w(".github/workflows/ci.yml", templates.gh_actions_ci_node())
        elif repo_type == "c":
            w(".github/workflows/ci.yml", templates.gh_actions_ci_c())
        else:
            w(".github/workflows/ci.yml", templates.gh_actions_ci_python())
