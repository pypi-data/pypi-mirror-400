name: MirrorMind Validation Protocol

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch: # Allows manual trigger from UI

jobs:
  run-gauntlet:
    name: üõ°Ô∏è Validation Gauntlet (Phases 1-7)
    runs-on: ubuntu-latest
    timeout-minutes: 60 # SOTA Deathmatch + Pre-training can be long

    env:
      MPLBACKEND: Agg # Prevents Matplotlib from trying to open a window

    steps:
    # ------------------------------------------------------------------
    # 1. SETUP
    # ------------------------------------------------------------------
    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: üêç Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: üì¶ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        # Ensure we have the critical libs for the protocol
        pip install torch numpy matplotlib requests tqdm

    # ------------------------------------------------------------------
    # 2. DATA INGESTION
    # ------------------------------------------------------------------
    - name: üìÇ Setup Real ARC-AGI Dataset
      run: |
        python arc_data.py
      continue-on-error: false

    # ------------------------------------------------------------------
    # 3. THE PROTOCOL (PHASES 1-4)
    # ------------------------------------------------------------------
    - name: "Phase 1: System Integrity (Smoke Test)"
      run: python experiments/protocol_v1/phase1_integrity.py

    - name: "Phase 2: Functional Logic (Introspection Check)"
      run: python experiments/protocol_v1/phase2_verification.py

    - name: "Phase 3: Universal Compatibility (Omni-Test)"
      run: python experiments/protocol_v1/phase3_universal.py

    - name: "Phase 4: Behavioral Dynamics (Reflex Test)"
      run: python experiments/protocol_v1/phase4_behavior.py

    # ------------------------------------------------------------------
    # 4. THE INTELLIGENCE TEST (PHASE 5)
    # ------------------------------------------------------------------
    - name: "Phase 5a: The School (Pre-Training)"
      run: python experiments/protocol_v1/phase5a_pretrain.py
      # Note: This trains the model on the 400 ARC tasks downloaded in step 2

    - name: "Phase 5b: The Exam (ARC-AGI Benchmark)"
      run: python experiments/protocol_v1/phase5_arc_challenge.py

    # ------------------------------------------------------------------
    # 5. THE STABILITY TEST (PHASE 6)
    # ------------------------------------------------------------------
    - name: "Phase 6: The Titan Seal (Chaos Stability)"
      run: python experiments/protocol_v1/phase6_titan_seal.py

    # ------------------------------------------------------------------
    # 6. THE DEATHMATCH (PHASE 7)
    # ------------------------------------------------------------------
    - name: "Phase 7: SOTA Deathmatch (Broken Drone)"
      run: python experiments/protocol_v1/phase7_sota_deathmatch.py

    # ------------------------------------------------------------------
    # 7. REPORTING
    # ------------------------------------------------------------------
    - name: "üìù Generate Final Victory Report"
      run: python generate_final_report.py

    - name: "üì§ Upload Validation Artifacts"
      uses: actions/upload-artifact@v4
      if: always() # Upload logs even if a test fails
      with:
        name: mirrormind-results
        path: |
          RESULTS_SUMMARY.md
          experiments/protocol_v1/*.png
          experiments/protocol_v1/*.log