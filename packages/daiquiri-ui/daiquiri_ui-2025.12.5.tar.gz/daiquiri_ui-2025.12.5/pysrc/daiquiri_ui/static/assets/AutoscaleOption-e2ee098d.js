var te=Object.defineProperty;var se=(e,t,s)=>t in e?te(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var p=(e,t,s)=>(se(e,typeof t!="symbol"?t+"":t,s),s);import{r as S,an as k,j as d,aL as ne,aa as ae,aP as u,aW as P,aU as b,B as re}from"./index-4cf586ed.js";import{p as D,a as l}from"./index-19c84627.js";import{N as $,f as U,h as ie,c as E,e as L}from"./hooks-e7539055.js";import{A as x}from"./colormap-0981f7dc.js";import{I as oe}from"./Image-c1578ac2.js";function ce(e,t,s){const n=e-s.position[0],a=t-s.position[1],r=Math.round(n/s.scale[0]+s.size.width*.5-.5),i=Math.round(a/s.scale[1]+s.size.height*.5-.5);if(!(r<0||r>=s.size.width)&&!(i<0||i>=s.size.width))return[i,r]}const le=S.forwardRef((e,t)=>{const{values:s}=e;if(S.useImperativeHandle(t,()=>({pick:(n,a)=>{const r=ce(n,a,e);if(r!==void 0)return s.get(...r)}}),[e.position,e.scale,s,e.size]),s instanceof $){const n=k(s.data,s.shape);return d.jsx(D,{...e,values:n,domain:[0,255],scaleType:l.Linear})}if(s instanceof U){const n=k(s.data,s.shape);return d.jsx(D,{...e,values:n})}return d.jsx(D,{...e,values:s})}),Ne=le,F=4;class ue{constructor(t){p(this,"buffer");p(this,"view");p(this,"pos");this.buffer=new Uint8Array(t),this.view=new DataView(t),this.pos=0}readChunkType(){const t=this.pos%F;t&&(this.pos+=F-t);const s=this.pos;this.pos+=4;const n=this.buffer.subarray(s,this.pos);return String.fromCharCode.apply(null,n)}readChunkSize(){const t=this.view.getUint32(this.pos,!1);return this.pos+=4,t}readChunk(){const t=this.readChunkSize(),s=this.pos;return this.pos+=t,this.buffer.subarray(s,s+t)}skipChunk(){const t=this.readChunkSize();this.pos,this.pos+=t}readJsonChunk(){const t=this.readChunkSize(),s=this.pos;this.pos+=t;const n=this.buffer.subarray(s,s+t),a=String.fromCharCode.apply(null,n);return JSON.parse(a)}eof(){return this.pos+(F-this.pos%F)>=this.buffer.byteLength}}const de=ne("daiquiri.services.TomoDetectorService");var O=(e=>(e.Raw="raw",e.F16="f16",e.U8="u8",e))(O||{}),fe=(e=>(e.Dark="dark",e.Flat="flat",e.Proj="proj",e.Flatfield="flatfield",e))(fe||{}),me=(e=>(e.Unknown="unknown",e.Dark="dark",e.Flat="flat",e.Proj="proj",e.ProjNorm="proj_norm",e.ProjDarkNorm="proj_dark_norm",e.ProjFlatNorm="proj_flat_norm",e.FlatfieldNorm="flatfield_norm",e))(me||{});const he={Greys:"gray",Viridis:"viridis",Cividis:"cividis",Magma:"magma",Inferno:"inferno",Plasma:"plasma"},ge={[l.Linear]:"linear",[l.Log]:"log",[l.Sqrt]:"sqrt",[l.Gamma]:"gamma",[l.SymLog]:"arcsinh"};function ye(e){var m;if(!e.detector)return null;const{flat:t,dark:s,data:n}=e.detector,a=n?n.scanid:0,r=n?n.frame_no:0,i=(s!==void 0?s+1:0)+(t!==void 0?t+1:0)+a+r,c=(m=e.profiles)==null?void 0:m.map(o=>o.toString()).join(";");function f(){return e.vmin&&e.vmax?{vmin:e.vmin.toString(),vmax:e.vmax.toString()}:e.autoscale===x.None?{}:{autoscale:e.autoscale.toString()}}return{image_no:i.toString(),norm:ge[e.normalization],lut:he[e.lut]??"gray",detectorid:e.detector.detector_id,process:e.process.toString(),encoding:e.encoding,histogram:e.histogram?"true":void 0,profiles:c,...f()}}function w(e,t,s){const n=e.headers[t];return n?new u(n):s}function pe(e,t){return e.headers[t].split(" ").map(r=>Number.parseInt(r))}function M(e,t){return Number.parseFloat(e.headers[t])}function ve(e,t){if(t in e.headers)return Number.parseFloat(e.headers[t])}function be(e){const t=w(e,"dqr-pixelsize",new u("1 px")),s=w(e,"dqr-sy",new u("0 mm")),n=w(e,"dqr-sz",new u("0 mm")),a=w(e,"dqr-sampy",new u("0 mm")),r=w(e,"dqr-somega",null),i=w(e,"dqr-detcy",null),c=w(e,"dqr-detcz",null),f=s.add(a);return{imagePixelSize:t,sampyPosition:a,syPosition:s,szPosition:n,imagePosition:f,imageSomegaPosition:r,detectorCenterY:i,detectorCenterZ:c}}function we(e){const t=be(e),s=e.headers["dqr-dtype"],n=pe(e,"dqr-shape"),a=M(e,"dqr-min"),r=M(e,"dqr-max"),i=M(e,"dqr-mean"),c=M(e,"dqr-std"),f=ve(e,"dqr-epoch"),m=e.headers["dqr-datakind"]??"unknown",o=ie(e.data,n,s),h=E(o);return{...t,detectorSize:{height:n[0],width:n[1]},array:o,epoch:f,displayArray:h,datakind:m,statistics:{min:a,max:r,mean:i,std:c,minPositive:null}}}function ke(e){const t=new ue(e.data),s=t.readChunkType();if(s!=="DQR0")throw new Error(`Unexpected IFF BOM: ${s}`);t.skipChunk();let n=null,a=null,r=null,i=null;for(;!t.eof();)switch(t.readChunkType()){case"FORM":{a=t.readJsonChunk();break}case"DATA":{r=t.readChunk();break}case"HST0":{i=t.readChunk();break}case"TOMO":{n=t.readJsonChunk();break}default:t.skipChunk()}if(r===null)throw new Error("Response does not contain DATA chunk");function c(){if(i===null)return;const g=new Float32Array(i.buffer,i.byteOffset,i.byteLength/4);return{values:k(g.subarray(0,256),[256]),bins:k(g.subarray(256,256+257),[257])}}const f=c(),m=a.dtype,o=a.shape,h=a.profile,R=a.min,z=a.max,N=a.mean,H=a.std;function T(g,j){if(h==="u8"){const y=L(g,"|u1");if(!j)return new $(y,o,{min:a.u8_min??0,max:a.u8_max??1,normalization:a.u8_norm??"linear",autoscale:a.u8_autoscale??"none"});const q=k(y,o),C=k(new Float32Array(o[0]*o[1]),o);return P.assign(C,q),P.mulseq(C,z-R),P.divseq(C,255),P.addseq(C,R),C}if(h==="f16"){const y=L(g,"<u2");return new U(y,o)}if(h==="raw"){const y=L(g,m);return k(y,o)}throw new Error(`Unsupported profile ${h}`)}const A=T(r,!1),G=A instanceof $||A instanceof U?A:E(A),B=r.byteLength;function v(g,j,y){const q=g[j];return q?u(q):y}const J=v(n,"DQR-pixelsize",u("1 px")),_=v(n,"DQR-sy",u("0 mm")),V=v(n,"DQR-sz",u("0 mm")),I=v(n,"DQR-sampy",u("0 mm")),Y=v(n,"DQR-somega",null),Z=v(n,"DQR-detcy",null),W=v(n,"DQR-detcz",null),X=n["DQR-datakind"]??"unknown",K=n["DQR-epoch"],ee=_.add(I);return{epoch:K,imagePixelSize:J,sampyPosition:I,syPosition:_,szPosition:V,imagePosition:ee,imageSomegaPosition:Y,detectorCenterY:Z,detectorCenterZ:W,detectorSize:{height:o[0],width:o[1]},array:A,displayArray:G,datakind:X,info:{profile:h,byteLength:B,dtype:m},statistics:{min:R,max:z,mean:N,std:H,minPositive:null},histogram:f}}const Q={bin:we,iff:ke};class Se{constructor(t){p(this,"setResult");p(this,"isAborted");p(this,"isFetching");p(this,"pendingRequest");this.setResult=t,this.setResult({loading:!1,data:null}),this.isAborted=!1,this.pendingRequest=void 0,this.isFetching=!1}requestUpdate(t){this.isAborted||(this.isFetching?this.pendingRequest=t:(this.isFetching=!0,this.fetchData(t)))}fetchPendingRequest(){if(!this.isAborted)if(this.pendingRequest){const t=this.pendingRequest;this.pendingRequest=void 0,this.fetchData(t)}else this.isFetching&&(this.isFetching=!1,this.setResult(t=>({...t,loading:!1})))}async fetchData(t){function s(){switch(t.process){case"flatfield":case"proj":return t.detector.data!==void 0;case"flat":return t.detector.flat!==void 0;case"dark":return t.detector.dark!==void 0}return!0}if(!s()){try{this.setResult(a=>({...a,data:null}))}finally{this.fetchPendingRequest()}return}const n="iff";if(!this.isAborted){this.setResult(a=>({...a,loading:!0}));try{let a;de("Get image from rest API /tomo/data");try{a=await ae.get("/tomo/data",ye({...t,encoding:n}),!0,"arraybuffer")}catch(r){if(this.isAborted)return;if(r.response.status===404)a=null;else{const i=r instanceof Error?r.message:String(r);this.setResult(c=>({...c,data:null,error:`Error while fetching data: ${i}`}));return}}if(this.isAborted)return;try{if(!a)throw new Error(`No ${t.process} yet available`);if(!(n in Q))throw new Error(`Unsupported response encoding '${n}'`);const r=Q[n](a);this.setResult(i=>({...i,data:r,error:void 0}))}catch(r){const i=r instanceof Error?r.message:String(r);this.setResult(c=>({...c,data:null,error:i}))}}finally{this.fetchPendingRequest()}}}abort(){this.isAborted=!0}}function je(){const[e,t]=S.useState({loading:!1,data:null}),s=S.useMemo(()=>new Se(t),[]);S.useEffect(()=>()=>{s==null||s.abort()},[s]);const n=S.useCallback(a=>{s==null||s.requestUpdate(a)},[s]);return[e,n]}function De(e){const[t,s]=b(`${e.name}/lut`,e.lut??"Cividis"),[n,a]=b(`${e.name}/levels`,[-.1,.1]),[r,i]=b(`${e.name}/inverted`,!1),[c,f]=b(`${e.name}/scale`,l.Linear),[m,o]=b(`${e.name}/autoscale`,e.autoscale??!0),[h,R]=b(`${e.name}/autoscalemode`,e.autoscaleMode??x.StdDev3),[z,N]=b(`${e.name}/profile`,O.Raw);return{colorMap:t,setColorMap:s,scaleType:c,setScaleType:f,autoscale:m,setAutoscale:o,autoscaleMode:h,setAutoscaleMode:R,scaleDomain:n,setScaleDomain:a,invertColorMap:r,setInvertColorMap:i,profile:z,setProfile:N}}const Re={[l.Linear]:"fam-norm-linear",[l.Log]:"fam-norm-log",[l.Sqrt]:"fam-norm-sqrt",[l.Gamma]:"fam-norm-gamma",[l.SymLog]:"fam-norm-arcsinh"},Ae={[x.Minmax]:["fam-scale-auto-minmax","Min-max"],[x.StdDev3]:["fam-scale-auto-3std","3 Ã— stddev"],[x.None]:["","Manual"]},Ce={Greys:"gray",Viridis:"viridis",Cividis:"cividis",Magma:"magma",Inferno:"inferno",Plasma:"plasma"};function Le(e){const s=`resources/icons/lut/${Ce[e.name]??"unknown"}.png`;return d.jsx(oe,{className:"border",src:s,rounded:!0,width:16,height:16,title:e.name})}function $e(e){const t=e.scale.replace(/^\w/,n=>n.toUpperCase()),s=Re[e.scale];return d.jsx("i",{className:`fad ${s} fa-lg fa-fw`,title:t})}function Ue(e){const[t,s]=Ae[e.autoscale];return t===""?d.jsx(d.Fragment,{}):d.jsx("i",{className:`fad ${t} fa-lg fa-fw`,title:s})}function _e(e){const{disabled:t,autoscale:s,autoscaleMode:n,setAutoscale:a}=e;return d.jsx(re,{title:"Enable/disable auto scale on colormap",variant:s?"primary":"secondary",disabled:t,onClick:()=>{a(r=>!r)},children:d.jsx("i",{className:"fa-solid fa-circle-half-stroke fa-fw fa-lg"})})}export{_e as A,Ne as I,Le as L,$e as S,me as T,fe as a,Ue as b,je as c,O as d,De as u};
