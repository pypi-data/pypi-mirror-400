# *******************
# NGINX sub filters allows for server to access request information
# *******************
sub_filter_types *;
sub_filter '{basepath}' '$realpath_root';
sub_filter '{port}' '$server_port';
sub_filter '{host}' '$host';
sub_filter '{hostname}' '$hostname';
sub_filter '{args}' '$args';
sub_filter '{status}' '$status';
sub_filter '{time}' '$time_local';
sub_filter '{uri}' '$uri';
sub_filter '{request_uri}' '$request_uri';
sub_filter '{request_method}' '$request_method';
sub_filter '{domain}' '$host:$server_port';   
sub_filter '{protocol}' '$scheme';
sub_filter '{pid}' '$pid';
sub_filter '{cookie_id}' '$cookie_id';   
# sub_filter '{geoip_city}' '$geoip_city';   
# sub_filter '{geoip_code}' '$geoip_dma_code';   
sub_filter '{ip}' '$remote_addr';   
sub_filter '{user_ip}' '$http_x_real_ip';   
sub_filter_once off;

# *******************
# Server Log format
# *******************
log_format {{app_name_id}}_jsonlog escape=json
'{'
    '"request":"$request",'
    '"time_local":"$time_local",'
    '"remote_addr":"$remote_addr",'
    '"remote_user":"$remote_user",'
    '"status": "$status",'
    '"body_bytes_sent":"$body_bytes_sent",'
    '"request_time":"$request_time",'
    '"http_referrer":"$http_referer",'
    '"http_user_agent":"$http_user_agent"'
'}';
# *******************
# Defer logging for certain routes
# *******************
map $request_uri $loggable {
  ~^/({{app_ignore_logs}})/ 0;
  default 1;
}

# *******************
# Map for WebSocket connections
# *******************
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# *******************
# Upstream Python or ASGI service
# *******************
upstream {{app_name_id}}_socket {
server unix:{{app_socket_filepath}};
}

# *******************
# Primary Application Server for Site
# *******************
server {
	listen 80;
	listen 443;
	server_name {{ domain }};
	root {{site_dirpath}};
	index index.html index.json;
	access_log {{site_logs_dirpath}}/nginx_access.log {{app_name_id}}_jsonlog if=$loggable;
	error_log {{site_logs_dirpath}}/nginx_errors.log;
	client_max_body_size 1000M;

	error_page	404 403 500 502 503 504	/$status/index.html;

{%- if is_secure %}
{%- include "nginx-ssl.jinja.conf" -%}
{% endif %}


    # *******************
    # Serve Site Theme Assets Route
    # *******************
	location {{public_assets_route}} {
		alias {{public_assets_dirpath}};
		try_files $uri $uri/;
	}
	location {{frontend_assets_route}} {
		alias {{frontend_assets_dirpath}};
		{% include "nginx-cache-config.jinja.conf" %}
		try_files $uri $uri/;
	}

    # *******************
    # Serving uploads directory
	# Note: Uploads directory path may be heavy so its recommended to serve path directly
    # *******************
	location {{site_uploads_route}} {
		alias {{site_uploads_dirpath}};
		{% include "nginx-cache-config.jinja.conf" %}
		try_files $uri $uri/; 
	}
	
{%- if custom_nginx_locations and custom_nginx_locations.locations %}
	# *******************
    # Add Custom location routes to be served by nginx
    # *******************
	{{-  custom_nginx_locations.locations|indent(4, True) }}
{%- endif %}

	# Denial all access to hidden try_files
	location ~ /\. {
		access_log off;
		log_not_found off; 
		deny all;
	}
    # *******************
    # Serving All Routes
    # *******************
	location / {
	{%- if configs.site_ssg_inprogress %}
		root {{site_ssg_dirpath}};
		try_files $uri $uri/ index.html;
	{%- else %}
		root {{site_dirpath}};
		try_files $uri @pyonir_app;
	{%- endif %}
	}


{% if not configs.site_ssg_inprogress %}
    # *******************
    # Serving Python Application
    # Note: This location is used to pass requests to the Python or ASGI application
    # *******************
	location @pyonir_app {
		proxy_set_header Host $http_host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header Upgrade $http_upgrade;
		proxy_redirect off;
		proxy_buffering off;
		# Allow Websocket Connections
		proxy_set_header Connection $connection_upgrade;
		# Specify Python service to pass request
        proxy_pass $scheme://{{app_name_id}}_socket;
	}
{% endif %}
}