Metadata-Version: 2.4
Name: piko-cucc
Version: 0.1.7
Summary: Data-Oriented Async Task Orchestrator
Project-URL: Homepage, https://github.com/yingsf/piko
Project-URL: Repository, https://github.com/yingsf/piko
Project-URL: Documentation, https://github.com/yingsf/piko/tree/dev#readme
Author-email: chenjp <chenjp105@x.com>
License: MIT
License-File: LICENSE
Keywords: asyncio,etl,framework,pipeline,scheduler
Classifier: Development Status :: 4 - Beta
Classifier: Framework :: AsyncIO
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: MIT License
Classifier: Programming Language :: Python :: 3.12
Classifier: Topic :: Software Development :: Libraries :: Application Frameworks
Requires-Python: >=3.12
Requires-Dist: aiofiles>=25.1.0
Requires-Dist: apscheduler>=3.11.2
Requires-Dist: asyncmy>=0.2.10
Requires-Dist: cloudpickle>=3.1.2
Requires-Dist: croniter>=6.0.0
Requires-Dist: cryptography>=46.0.3
Requires-Dist: dynaconf>=3.2.12
Requires-Dist: fastapi>=0.128.0
Requires-Dist: greenlet>=3.0.0
Requires-Dist: prometheus-client>=0.23.1
Requires-Dist: pydantic>=2.12.5
Requires-Dist: sqlalchemy>=2.0.45
Requires-Dist: structlog>=25.5.0
Requires-Dist: uvicorn>=0.40.0
Description-Content-Type: text/markdown

# Piko: Enterprise-Grade Async Orchestrator

[![PyPI version](https://img.shields.io/pypi/v/piko-cucc.svg)](https://pypi.org/project/piko-cucc/)
[![Python 3.10+](https://img.shields.io/badge/python-3.10+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

Piko ä¸“ä¸ºæ•°æ®å·¥ç¨‹è®¾è®¡ï¼Œæ—¨åœ¨è§£å†³**é«˜å¹¶å‘ I/O** ä¸**å¤æ‚èµ„æºç®¡ç†**ä¹‹é—´çš„çŸ›ç›¾ï¼Œé€šè¿‡**å¾®å†…æ ¸è®¾è®¡**ä¸**ä¾èµ–æ³¨å…¥**æœºåˆ¶ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿè½»æ¾æ„å»ºæ”¯æ’‘æ•°ä¸‡ QPS çš„æµæ°´çº¿ã€‚

---

## ğŸ”¥ Piko 0.1.6 æ–°ç‰¹æ€§ (New in v0.1.6)

- **App å®ä¾‹æ¨¡å¼**: `app = PikoApp()`ï¼Œå½»åº•å‘Šåˆ«éšå¼å…¨å±€å˜é‡ï¼Œæ”¯æŒå¤šå®ä¾‹è¿è¡Œã€‚
- **åŠ¨æ€ç³»ç»Ÿé…ç½®**: æ”¯æŒåœ¨ä¸é‡å¯æœåŠ¡çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡æ•°æ®åº“åŠ¨æ€è°ƒæ•´è½®è¯¢é—´éš”ç­‰ç³»ç»Ÿå‚æ•°ã€‚
- **å¢å¼ºçš„è¿æ¥æ± **: è‡ªåŠ¨æ¢æ´»ä¸æ–­çº¿é‡è¿ï¼ˆPre-pingï¼‰ï¼Œé€‚åº”ä¸ç¨³å®šçš„ç½‘ç»œç¯å¢ƒã€‚
- **æ™ºèƒ½å›å¡«ç­–ç•¥**: æ”¯æŒ `SKIP` (è·³è¿‡) å’Œ `CATCH_UP` (è¿½èµ¶) ç­‰å¤šç§å›æº¯ç­–ç•¥ã€‚

---

## å‰ç½®è¦æ±‚ (Prerequisites)

Piko ä¾èµ– **MySQL** (5.7 æˆ– 8.0+) ä½œä¸ºæ ¸å¿ƒç»„ä»¶ã€‚

```sql
# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE piko_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

## å®‰è£… (Installation)

```bash
pip install piko-cucc
```

------

## å¿«é€Ÿå¼€å§‹ (Quick Start)

### 1. å®šä¹‰åº”ç”¨ (`app.py`)

Piko å¼ºåˆ¶è¦æ±‚æ˜¾å¼å®ä¾‹åŒ– App å¯¹è±¡ã€‚

```python
from piko.app import PikoApp

# å®ä¾‹åŒ– App
app = PikoApp(name="my_crawler_service")
```

### 2. ç¼–å†™ä»»åŠ¡ (`jobs.py`)

ä½¿ç”¨ `@app.job` è£…é¥°å™¨æ³¨å†Œä»»åŠ¡ã€‚

```Python
from .app import app

@app.job(
    job_id="hello_world",
    cron="* * * * *"  # æ¯åˆ†é’Ÿæ‰§è¡Œ
)
async def hello_handler(ctx, scheduled_time):
    print(f"Hello Piko ! Time: {scheduled_time}")
```

### 3. å¯åŠ¨å…¥å£ (`main.py`)

```python
from my_project.app import app
import my_project.jobs  # å¿…é¡»å¯¼å…¥ä»»åŠ¡æ¨¡å—ä»¥è§¦å‘æ³¨å†Œ

if __name__ == "__main__":
    # ä¸€é”®å¯åŠ¨ï¼šè‡ªåŠ¨å¤„ç† DB åˆå§‹åŒ–ã€Leader é€‰ä¸¾ã€Worker å¯åŠ¨
    app.run()
```

------

## æ ¸å¿ƒæ¨¡å¼ (Core Patterns)

### åœºæ™¯ä¸€ï¼šé«˜å¹¶å‘ç½‘ç»œ I/O (The Async IO Pattern)

åˆ©ç”¨ `asyncio` åŸç”Ÿå¹¶å‘èƒ½åŠ›ï¼Œå•èŠ‚ç‚¹è½»æ¾æ”¯æ’‘æ•°åƒå¹¶å‘ã€‚

```python
import aiohttp
from .app import app

@app.job(job_id="fetch_price", cron="*/1 * * * *")
async def fetch_handler(ctx, scheduled_time):
    # çº¯å¼‚æ­¥éé˜»å¡
    async with aiohttp.ClientSession() as session:
        async with session.get("[https://api.example.com/data](https://api.example.com/data)") as resp:
            data = await resp.json()
            print(f"Data: {data}")
```

### åœºæ™¯äºŒï¼šèµ„æºä¾èµ–æ³¨å…¥ (Dependency Injection)

é€šè¿‡ `resources` å‚æ•°æ³¨å…¥è¿æ¥æ± ï¼Œè‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œé˜²æ­¢èµ„æºæ³„éœ²ã€‚

```Python
from piko.core.resource import Resource
from contextlib import asynccontextmanager

class DBPool(Resource):
    @asynccontextmanager
    async def acquire(self, ctx):
        # æ¨¡æ‹Ÿå€Ÿå‡ºè¿æ¥
        yield "db_connection_obj"

@app.job(
    job_id="db_task",
    cron="0 * * * *",
    resources={"db": DBPool}  # æ³¨å…¥èµ„æº
)
async def db_handler(ctx, scheduled_time, db):
    # db å‚æ•°ç”±æ¡†æ¶è‡ªåŠ¨æ³¨å…¥
    print(f"Using connection: {db}")
```

### åœºæ™¯ä¸‰ï¼šåŠ¨æ€ç³»ç»Ÿè°ƒä¼˜ (Dynamic Configuration)

Piko å…è®¸ä½ é€šè¿‡æ•°æ®åº“åŠ¨æ€è°ƒæ•´ç³»ç»Ÿè¡Œä¸ºã€‚

åœ¨ `job_config` è¡¨ä¸­æ’å…¥ç‰¹æ®Š ID `piko_system_settings`ï¼š

```json
// job_id: piko_system_settings
{
    "poll_interval_s": 5,   // å°†è½®è¯¢é—´éš”è°ƒæ•´ä¸º 5 ç§’
    "log_level": "DEBUG"
}
```

Watcher ä¼šè‡ªåŠ¨æ„ŸçŸ¥å¹¶åº”ç”¨æ–°é…ç½®ï¼Œæ— éœ€é‡å¯æœåŠ¡ã€‚

------

## é…ç½® (Configuration)

æ¨èä½¿ç”¨ `settings.toml` æˆ–ç¯å¢ƒå˜é‡ã€‚æ ¼å¼å¦‚ä¸‹ï¼š

```toml
[default]
# ============================================================================
# General - é€šç”¨é…ç½®
# ============================================================================
version = "0.1.6"

# ============================================================================
# Startup Strategy - å¯åŠ¨ç­–ç•¥
# ============================================================================
# startup_mode æ§åˆ¶æœåŠ¡å¯åŠ¨æ—¶çš„å®¹é”™è¡Œä¸ºï¼š
#   - "fail_closed": ä¸¥æ ¼æ¨¡å¼ï¼Œä»»ä½•é…ç½®æˆ–ä¾èµ–æ£€æŸ¥å¤±è´¥éƒ½ç«‹å³ç»ˆæ­¢å¯åŠ¨ï¼ˆç”Ÿäº§æ¨èï¼‰
#   - "fail_open_snapshot": å®½å®¹æ¨¡å¼ï¼Œå…è®¸ä½¿ç”¨å¿«ç…§æ•°æ®é™çº§å¯åŠ¨ï¼ˆä»…ç”¨äºå¼€å‘/æµ‹è¯•ï¼‰
startup_mode = "fail_closed"

# debug æ¨¡å¼ä¼šå¯ç”¨æ›´è¯¦ç»†çš„æ—¥å¿—å’Œè°ƒè¯•ç«¯ç‚¹ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»è®¾ä¸º false
debug = false

# ============================================================================
# Database - æ•°æ®åº“è¿æ¥é…ç½® (Piko æ ¸å¿ƒ)
# ============================================================================
# [æ³¨æ„] åº“å†…éƒ¨é»˜è®¤ç•™ç©ºï¼Œé…åˆ init_db çš„æ£€æŸ¥é€»è¾‘ã€‚
# è¿™æ ·ç”¨æˆ·å¦‚æœæ²¡é…ç½®ç¯å¢ƒå˜é‡ï¼Œå¯åŠ¨æ—¶ä¼šçœ‹åˆ°å‹å¥½çš„ FATAL ERROR æç¤º
# 
# âš ï¸ å¿…é¡»ä½¿ç”¨å¼‚æ­¥é©±åŠ¨ï¼
# æ¨èä½¿ç”¨ mysql+asyncmy (é€Ÿåº¦æœ€å¿«) æˆ– mysql+aiomysql (å…¼å®¹æ€§å¥½)
# âŒ ä¸è¦ä½¿ç”¨ pymysql (è¿™æ˜¯åŒæ­¥é©±åŠ¨ï¼Œä¼šé˜»å¡ Event Loop)
#
# æ ¼å¼ç¤ºä¾‹: 
#   "mysql+asyncmy://user:pass@host:port/dbname?charset=utf8mb4"
mysql_dsn = ""

# mysql_pool_size: è¿æ¥æ± åˆå§‹å¤§å°ï¼Œå½±å“å¹¶å‘èƒ½åŠ›
# è®¾ä¸º 10-20 æ˜¯åŸºäºå…¸å‹ä¸­å°å‹æœåŠ¡çš„ç»éªŒå€¼
mysql_pool_size = 20

# mysql_max_overflow: è¿æ¥æ± æœ€å¤§æº¢å‡ºè¿æ¥æ•°
# å…è®¸åœ¨é«˜å³°æœŸä¸´æ—¶åˆ›å»ºé¢å¤–è¿æ¥ï¼Œé¿å…è¯·æ±‚é˜»å¡
mysql_max_overflow = 10

# mysql_pool_recycle_s: è¿æ¥å›æ”¶æ—¶é—´ï¼ˆç§’ï¼‰
# å¼ºåˆ¶æ¯ 3600 ç§’å›æ”¶ä¸€æ¬¡è¿æ¥ï¼Œé˜²æ­¢è¿æ¥å­˜åœ¨å¤ªä¹…è¢«é˜²ç«å¢™/MySQLæœåŠ¡ç«¯åˆ‡æ–­
# è¿™é…åˆä»£ç ä¸­çš„ pool_pre_ping=True å…±åŒè§£å†³äº† "Lost connection" é—®é¢˜
mysql_pool_recycle_s = 3600

# ============================================================================
# Scheduler Tuning - è°ƒåº¦å™¨è°ƒä¼˜å‚æ•°
# ============================================================================
# poll_interval_s: ä¸»è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰
# [Piko æ–°ç‰¹æ€§] è¿™æ˜¯"é»˜è®¤"é—´éš”ã€‚
# ç³»ç»Ÿå¯åŠ¨åï¼ŒConfigWatcher ä¼šä¼˜å…ˆè¯»å–æ•°æ®åº“ä¸­çš„ piko_system_settings é…ç½®ã€‚
# å¦‚æœæ•°æ®åº“æ²¡é…ç½®ï¼Œæ‰ä½¿ç”¨æ­¤å€¼ã€‚
poll_interval_s = 10

# poll_jitter_s: è½®è¯¢æŠ–åŠ¨æ—¶é—´ï¼ˆç§’ï¼‰
# éšæœºåŒ–è½®è¯¢æ—¶åˆ»ï¼Œé¿å…å¤šå®ä¾‹åœ¨åŒä¸€æ—¶åˆ»åŒæ—¶è½®è¯¢é€ æˆæ•°æ®åº“å‹åŠ›å³°å€¼
poll_jitter_s = 2

# debounce_s: é˜²æŠ–çª—å£ï¼ˆç§’ï¼‰
# åœ¨æ­¤æ—¶é—´çª—å£å†…é‡å¤è§¦å‘çš„ç›¸åŒä»»åŠ¡ä¼šè¢«åˆå¹¶ï¼Œå‡å°‘æ— æ•ˆè°ƒåº¦
debounce_s = 2

# timezone: æ—¶åŒºè®¾ç½®
# å½±å“ cron è¡¨è¾¾å¼çš„è§£æå’Œä»»åŠ¡è§¦å‘æ—¶é—´è®¡ç®—ï¼Œå¿…é¡»ä¸ä¸šåŠ¡æ—¶åŒºä¸€è‡´
timezone = "Asia/Shanghai"

# ap_misfire_grace_s_default: APScheduler misfire å®¹å¿æ—¶é—´ï¼ˆç§’ï¼‰
# ä»»åŠ¡é”™è¿‡é¢„å®šæ—¶é—´åï¼Œåœ¨æ­¤æ—¶é—´çª—å£å†…ä»ä¼šæ‰§è¡Œï¼›è¶…å‡ºåˆ™è·³è¿‡
# 300 ç§’ï¼ˆ5åˆ†é’Ÿï¼‰æ˜¯å¹³è¡¡åŠæ—¶æ€§ä¸ç³»ç»Ÿå‹åŠ›çš„ç»éªŒå€¼
ap_misfire_grace_s_default = 300

# ap_max_instances_default: APScheduler å•ä»»åŠ¡æœ€å¤§å¹¶å‘å®ä¾‹æ•°
# è®¾ä¸º 1 é˜²æ­¢åŒä¸€ä»»åŠ¡çš„å¤šä¸ªå®ä¾‹å¹¶å‘æ‰§è¡Œï¼Œé¿å…æ•°æ®ç«äº‰
ap_max_instances_default = 1

# ============================================================================
# Leader Election - åˆ†å¸ƒå¼Leaderé€‰ä¸¾
# ============================================================================
# leader_enabled: æ˜¯å¦å¯ç”¨Leaderé€‰ä¸¾
# å¤šå®ä¾‹éƒ¨ç½²æ—¶å¿…é¡»å¯ç”¨ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œè°ƒåº¦é€»è¾‘
leader_enabled = true

# leader_name: Leaderåç§°/ç»„å
# åŒä¸€ç»„å†…çš„å®ä¾‹ä¼šç«äº‰åŒä¸€ä¸ªLeaderé”ï¼Œä¸åŒç»„äº’ä¸å¹²æ‰°
leader_name = "default"

# leader_lease_s: Leaderç§Ÿçº¦æ—¶é•¿ï¼ˆç§’ï¼‰
# Leaderå¿…é¡»åœ¨æ­¤æ—¶é—´å†…ç»­ç§Ÿï¼Œå¦åˆ™è¢«è§†ä¸ºå¤±æ•ˆï¼Œå…¶ä»–å®ä¾‹å¯æ¥ç®¡
leader_lease_s = 30

# leader_renew_interval_s: ç»­ç§Ÿé—´éš”ï¼ˆç§’ï¼‰
# Leaderå¤šä¹…ç»­ç§Ÿä¸€æ¬¡ï¼Œå¿…é¡»å°äº lease æ—¶é•¿ä¸”ç•™æœ‰ä½™é‡ï¼ˆå½“å‰ä¸º 1/3ï¼‰
# è¿™æ ·å³ä½¿æŸæ¬¡ç»­ç§Ÿå¤±è´¥ï¼Œä»æœ‰æ—¶é—´åœ¨ç§Ÿçº¦åˆ°æœŸå‰é‡è¯•
leader_renew_interval_s = 10

# ============================================================================
# Concurrency & Compute - å¹¶å‘ä¸è®¡ç®—èµ„æº
# ============================================================================
# cpu_workers: CPU å¯†é›†å‹ä»»åŠ¡çš„å·¥ä½œçº¿ç¨‹æ•°
# 0 è¡¨ç¤ºè‡ªåŠ¨æ£€æµ‹ï¼ˆé€šå¸¸ä¸º CPU æ ¸å¿ƒæ•°ï¼‰ï¼Œå¯æ ¹æ®ä»»åŠ¡ç‰¹æ€§æ‰‹åŠ¨è°ƒæ•´
cpu_workers = 0

# per_job_cpu_max: å•ä»»åŠ¡æœ€å¤§ CPU å¹¶å‘æ•°
# é™åˆ¶å•ä¸ªä»»åŠ¡å¯ä½¿ç”¨çš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œé˜²æ­¢æŸä¸ªä»»åŠ¡è€—å°½æ‰€æœ‰èµ„æº
per_job_cpu_max = 8

# ============================================================================
# Persistence - æŒä¹…åŒ–ä¸ç¼“å†²é…ç½®
# ============================================================================
# persist_queue_max: æŒä¹…åŒ–é˜Ÿåˆ—æœ€å¤§é•¿åº¦
# æ§åˆ¶å†…å­˜ä¸­å¾…æŒä¹…åŒ–å¯¹è±¡çš„æœ€å¤§æ•°é‡ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
persist_queue_max = 200

# persist_flush_timeout_s: å¼ºåˆ¶åˆ·ç›˜è¶…æ—¶ï¼ˆç§’ï¼‰
# å³ä½¿é˜Ÿåˆ—æœªæ»¡ï¼Œä¹Ÿä¼šåœ¨æ­¤æ—¶é—´åå¼ºåˆ¶å†™å…¥ï¼Œå¹³è¡¡æ•°æ®ä¸¢å¤±é£é™©ä¸ I/O æ•ˆç‡
persist_flush_timeout_s = 60

# persist_disk_fallback_path: ç£ç›˜é™çº§å¤‡ä»½è·¯å¾„
# å½“ä¸»å­˜å‚¨ï¼ˆå¦‚æ•°æ®åº“ï¼‰ä¸å¯ç”¨æ—¶ï¼Œä¸´æ—¶å†™å…¥æœ¬åœ°æ–‡ä»¶ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
# æ³¨æ„ï¼šæ­¤è·¯å¾„åº”åœ¨å®¹å™¨/ä¸»æœºé‡å¯åä»å¯è®¿é—®ï¼ˆå¦‚æŒ‚è½½å·ï¼‰
persist_disk_fallback_path = "/tmp/piko_fallback.bin"

# ============================================================================
# Observability & Logging - å¯è§‚æµ‹æ€§ä¸æ—¥å¿—
# ============================================================================
# metrics_enabled: æ˜¯å¦å¯ç”¨ Prometheus ç­‰æŒ‡æ ‡é‡‡é›†
# ç”Ÿäº§ç¯å¢ƒå¼ºçƒˆå»ºè®®å¯ç”¨ï¼Œç”¨äºç›‘æ§è°ƒåº¦å™¨å¥åº·çŠ¶å†µ
metrics_enabled = true

# health_port: å¥åº·æ£€æŸ¥å’ŒæŒ‡æ ‡æš´éœ²ç«¯å£
# K8s/Docker å¯é€šè¿‡æ­¤ç«¯å£è¿›è¡Œ liveness/readiness probe
health_port = 8080

# log_level: æ—¥å¿—çº§åˆ«
# å¯é€‰: DEBUG, INFO, WARNING, ERROR, CRITICAL
# ç”Ÿäº§ç¯å¢ƒå»ºè®® INFOï¼Œæ’æŸ¥é—®é¢˜æ—¶ä¸´æ—¶è°ƒä¸º DEBUG
log_level = "INFO"

# log_json: æ—¥å¿—æ ¼å¼å¼€å…³
#   - true: ç”Ÿäº§æ¨¡å¼ï¼Œè¾“å‡ºç»“æ„åŒ– JSON æ—¥å¿—ï¼Œä¾¿äºæ—¥å¿—èšåˆå¹³å°è§£æ
#   - false: å¼€å‘æ¨¡å¼ï¼Œè¾“å‡ºå½©è‰²æ–‡æœ¬æ—¥å¿—ï¼Œæå‡æœ¬åœ°è°ƒè¯•ä½“éªŒ
log_json = false
```

## âš™ï¸ è¿›é˜¶ï¼šåŠ¨æ€ç³»ç»Ÿé…ç½® (Dynamic System Settings)

é™¤äº†å‰é¢çš„é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡æ–¹å¼ï¼ŒPiko  è¿˜å¼•å…¥äº† **â€œæ§åˆ¶é¢ä¸æ•°æ®é¢åˆ†ç¦»â€** çš„è®¾è®¡ç†å¿µã€‚ä½ è¿˜å¯ä»¥é€šè¿‡æ•°æ®åº“å®æ—¶è°ƒæ•´ç³»ç»Ÿçš„è¿è¡Œæ—¶è¡Œä¸ºï¼Œå®ç° **æ— åœæœºè°ƒä¼˜ (Hot Reload)**ã€‚

è¿™æ˜¯é€šè¿‡åœ¨ `job_config` è¡¨ä¸­æ’å…¥ä¸€ä¸ªç‰¹æ®Šçš„ä¿ç•™ä»»åŠ¡ ID `piko_system_settings` æ¥å®ç°çš„ã€‚

### 1. é™æ€ vs åŠ¨æ€é…ç½®å¯¹ç…§è¡¨

å¹¶ä¸æ˜¯æ‰€æœ‰é…ç½®éƒ½èƒ½æ”¾å…¥æ•°æ®åº“ã€‚è¯·åŠ¡å¿…éµå¾ªä»¥ä¸‹è§„åˆ™ï¼Œå¦åˆ™é…ç½®å°†æ— æ•ˆï¼š

| é…ç½®åˆ†ç±»                        | å…¸å‹å‚æ•°                                                     | å­˜æ”¾ä½ç½®                                          | ç”Ÿæ•ˆæ—¶æœº                  | å¤‡æ³¨                                                         |
| :------------------------------ | :----------------------------------------------------------- | :------------------------------------------------ | :------------------------ | :----------------------------------------------------------- |
| **åŸºç¡€è®¾æ–½ (Infrastructure)**   | `mysql_dsn`<br>`mysql_pool_size`<br>`leader_name`<br>`startup_mode`<br>`timezone` | **ä»…** `settings.toml`<br>æˆ– ç¯å¢ƒå˜é‡             | **å¯åŠ¨æ—¶**                | æ¶‰åŠè¿æ¥æ± åˆå§‹åŒ–ã€çº¿ç¨‹å¯åŠ¨æˆ–æ—¶åŒºåŸºå‡†ï¼Œä¿®æ”¹å**å¿…é¡»é‡å¯æœåŠ¡**ã€‚ |
| **è¿è¡Œæ—¶ç­–ç•¥ (Runtime Policy)** | `poll_interval_s`<br>`poll_jitter_s`<br>`log_level`<br>`per_job_cpu_max` | `settings.toml` (é»˜è®¤å€¼)<br>**+ æ•°æ®åº“ (è¦†ç›–å€¼)** | **å³æ—¶ç”Ÿæ•ˆ**<br>(< 1åˆ†é’Ÿ) | Watcher ä¼šåœ¨ä¸‹ä¸€æ¬¡å¿ƒè·³æ—¶è‡ªåŠ¨åŠ è½½æ–°å€¼ã€‚                       |

### 2. å¦‚ä½•ä½¿ç”¨åŠ¨æ€é…ç½®

ä½ ä¸éœ€è¦é‡å¯æœåŠ¡ï¼Œåªéœ€åœ¨æ•°æ®åº“ä¸­æ’å…¥æˆ–æ›´æ–°ä»¥ä¸‹ JSONï¼š

```sql
INSERT INTO job_config (job_id, schema_version, config_json, version, updated_at)
VALUES (
    'piko_system_settings',  -- âš ï¸ ç³»ç»Ÿä¿ç•™ IDï¼Œä¸å¯æ›´æ”¹
    1,
    '{
        "poll_interval_s": 5,       -- [è°ƒä¼˜] å°†è½®è¯¢é—´éš”åŠ é€Ÿåˆ° 5ç§’ (é»˜è®¤10s)
        "poll_jitter_s": 1,         -- [è°ƒä¼˜] å‡å°‘æŠ–åŠ¨èŒƒå›´
        "log_level": "DEBUG"        -- [æ’æŸ¥] ä¸´æ—¶å¼€å¯è°ƒè¯•æ—¥å¿—ï¼ŒæŸ¥å®Œæ”¹å› INFO
    }',
    1,
    NOW()
) 
ON DUPLICATE KEY UPDATE 
    config_json = VALUES(config_json), 
    version = version + 1;
```

### 3. å¸¸è§è¯¯åŒº (Common Pitfalls)

- âŒ **é”™è¯¯åšæ³•**ï¼šåœ¨æ•°æ®åº“é‡Œä¿®æ”¹ `mysql_pool_size` æƒ³æ‰©å¤§è¿æ¥æ± ã€‚
  - **åæœ**ï¼šæ— æ•ˆã€‚è¿æ¥æ± åœ¨è¿›ç¨‹å¯åŠ¨çš„ç¬¬ä¸€ç§’å°±å·²ç»å›ºå®šäº†ï¼Œæ•°æ®åº“é‡Œçš„é…ç½®ä¼šè¢«å¿½ç•¥ã€‚
- âŒ **é”™è¯¯åšæ³•**ï¼šåœ¨æ•°æ®åº“é‡Œä¿®æ”¹ `timezone`ã€‚
  - **åæœ**ï¼šæåº¦å±é™©ã€‚è°ƒåº¦å™¨å¯èƒ½äº§ç”Ÿé€»è¾‘åˆ†è£‚ï¼ˆéƒ¨åˆ†ä»»åŠ¡æŒ‰æ—§æ—¶åŒºè·‘ï¼Œéƒ¨åˆ†æŒ‰æ–°æ—¶åŒºè®¡ç®—ï¼‰ï¼Œå¯¼è‡´ä»»åŠ¡æ¼è·‘æˆ–é‡è·‘ã€‚
- âœ… **æ­£ç¡®åšæ³•**ï¼šä»…åœ¨æ•°æ®åº“ä¸­è°ƒæ•´ `poll_interval_s` (æ§åˆ¶èŠ‚å¥) å’Œ `log_level` (æ§åˆ¶æ—¥å¿—é‡)ã€‚