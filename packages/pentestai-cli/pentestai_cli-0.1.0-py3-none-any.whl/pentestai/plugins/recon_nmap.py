from __future__ import annotations

import subprocess
from typing import Dict, Any
from pathlib import Path

from pentestai.plugins.base import Plugin
from pentestai.core.artifacts import Artifact, now_iso, save_artifact, ws_paths


class NmapPlugin(Plugin):
    name = "nmap"

    def run(self, ctx, args: Dict[str, Any]) -> Dict[str, Any]:
        paths = ws_paths(ctx.workspace)

        live = paths["artifacts"] / "recon_live.json"
        if not live.exists():
            raise RuntimeError("Missing recon_live.json. Run: pentestai recon run")

        import json
        import urllib.parse

        live_data = json.loads(live.read_text(encoding="utf-8"))
        urls = live_data["data"].get("urls", [])
        hosts = sorted({urllib.parse.urlparse(u).hostname for u in urls if u})
        hosts = [h for h in hosts if h]

        hosts_file = paths["artifacts"] / "recon_hosts.txt"
        hosts_file.write_text("\n".join(hosts) + ("\n" if hosts else ""), encoding="utf-8")

        # flags from ctx.vars (preferred) with fallback to args
        top_ports = str(ctx.vars.get("nmap_top_ports", args.get("top_ports", 1000)))
        ports = (ctx.vars.get("nmap_ports", args.get("ports", "")) or "").strip()
        extra_args = (ctx.vars.get("nmap_args", args.get("nmap_args", "")) or "").strip()

        dry_run = bool(ctx.vars.get("dry_run", False))
        verbose = bool(ctx.vars.get("verbose", False))

        out_xml = paths["artifacts"] / "recon_nmap.xml"

        # Safe-ish defaults: -sV only. (No aggressive scripts by default)
        cmd = ["nmap", "-sV"]

        # Choose between explicit ports or top ports
        if ports:
            cmd += ["-p", ports]
        else:
            cmd += ["--top-ports", top_ports]

        # Extra args (be careful â€” you can restrict later if needed)
        if extra_args:
            cmd += extra_args.split()

        cmd += ["-iL", str(hosts_file), "-oX", str(out_xml)]

        stderr_tail = ""
        rc = None

        if dry_run:
            # Don't run nmap, but still write artifact for reproducibility
            stderr_tail = "[dry-run] command not executed"
        else:
            r = subprocess.run(cmd, capture_output=True, text=True)
            rc = r.returncode
            stderr_tail = (r.stderr or "")[-2000:]

            # Optional: fail hard if nmap fails (or keep soft)
            if r.returncode != 0 and verbose:
                # Keep it non-fatal by default for pipeline robustness
                pass

        art = Artifact(
            kind="recon.nmap",
            created_at=now_iso(),
            data={
                "hosts": hosts,
                "hosts_count": len(hosts),
                "xml_path": str(out_xml),
                "top_ports": int(top_ports) if (not ports and top_ports.isdigit()) else None,
                "ports": ports or None,
                "extra_args": extra_args or None,
                "dry_run": dry_run,
                "returncode": rc,
            },
            meta={
                "cmd": cmd,
                "stderr": stderr_tail,
            },
        )

        save_artifact(paths["artifacts"] / "recon_nmap.json", art)

        if verbose:
            print(f"[NmapPlugin] Saved artifact: {paths['artifacts'] / 'recon_nmap.json'}")

        return art.model_dump()
