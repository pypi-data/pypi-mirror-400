# macOS PKG æ‰“åŒ…æ–‡æ¡£

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•å°† esn-tool æ‰“åŒ…æˆ macOS å®‰è£…åŒ…(.pkg)ã€‚

## å‡†å¤‡å·¥ä½œ

### 1. å®‰è£…ä¾èµ–

æ‰“åŒ…è¿‡ç¨‹ä¼šè‡ªåŠ¨ä½¿ç”¨é¡¹ç›®é…ç½®çš„ Python 3.12+ ç¯å¢ƒï¼Œæ— éœ€æ‰‹åŠ¨å®‰è£… PyInstallerã€‚

ç¡®ä¿å·²å®‰è£… uvï¼š

```bash
# æ£€æŸ¥ uv
uv --version

# å¦‚æœªå®‰è£…
brew install uv  # macOS
```

### 2. ç¡®è®¤ç¯å¢ƒ

- macOS ç³»ç»Ÿ
- uv (ç”¨äºç®¡ç† Python ç¯å¢ƒ)
- Python 3.12+ (é€šè¿‡ uv ç®¡ç†)
- å·²å®‰è£… Xcode Command Line Toolsï¼ˆç”¨äº pkgbuildï¼‰

```bash
# éªŒè¯ pkgbuild æ˜¯å¦å¯ç”¨
which pkgbuild

# åŒæ­¥é¡¹ç›®ä¾èµ–
uv sync
```

## æ„å»º PKG å®‰è£…åŒ…

### å¿«é€Ÿæ„å»º

åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œï¼š

```bash
# æ„å»ºå½“å‰ç³»ç»Ÿæ¶æ„ï¼ˆM1 ä¸Šæ„å»º ARM64ï¼ŒIntel ä¸Šæ„å»º x86_64ï¼‰
uv run python build_pkg.py

# æˆ–æŒ‡å®šæ¶æ„
uv run python build_pkg.py --arch arm64
```

> ğŸ’¡ **æ¶æ„é™åˆ¶**ï¼š
> - **M1/M2/M3 Mac**: åªèƒ½æ„å»º ARM64 æ¶æ„
> - **Intel Mac**: å¯ä»¥æ„å»º x86_64 æ¶æ„
> - æ— æ³•äº¤å‰ç¼–è¯‘ï¼ˆè¿™æ˜¯ macOS å’Œ Python ç”Ÿæ€çš„æŠ€æœ¯é™åˆ¶ï¼‰

### æ„å»ºæµç¨‹

è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š
1. æ£€æµ‹ç³»ç»Ÿæ¶æ„
2. æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
3. ä½¿ç”¨ PyInstaller æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
4. å‡†å¤‡ pkg ç›®å½•ç»“æ„
5. ä½¿ç”¨ pkgbuild ç”Ÿæˆ pkg å®‰è£…åŒ…

### æ„å»ºè¾“å‡º

æˆåŠŸåä¼šåœ¨ `dist/` ç›®å½•ç”Ÿæˆï¼š

```bash
# M1/M2/M3 Mac ä¸Š
dist/esn-0.1.0-arm64.pkg

# Intel Mac ä¸Š
dist/esn-0.1.0-x86_64.pkg
```

æ¯ä¸ªæ–‡ä»¶å¤§å°çº¦ 14-20MBï¼ˆåŒ…å« Python è¿è¡Œæ—¶å’Œæ‰€æœ‰ä¾èµ–ï¼‰ã€‚

> ğŸ’¡ **å¤šæ¶æ„åˆ†å‘**ï¼š
> - å¦‚éœ€åŒæ—¶æä¾›ä¸¤ä¸ªæ¶æ„çš„å®‰è£…åŒ…
> - å»ºè®®ä½¿ç”¨ GitHub Actions ç­‰ CI å·¥å…·åˆ†åˆ«åœ¨ä¸åŒæ¶æ„çš„ runner ä¸Šæ„å»º
> - æˆ–è€…åœ¨ Intel Mac å’Œ Apple Silicon Mac ä¸Šåˆ†åˆ«è¿è¡Œæ‰“åŒ…è„šæœ¬

> ğŸ’¡ **æŠ€æœ¯è¯´æ˜**ï¼š
> - ä½¿ç”¨ `uv run` æ‰§è¡Œæ‰“åŒ…è„šæœ¬ï¼Œç¡®ä¿ä½¿ç”¨é¡¹ç›®ç®¡ç†çš„ Python ç¯å¢ƒ
> - æ‰“åŒ…è„šæœ¬å†…éƒ¨ä½¿ç”¨ `uv run pyinstaller` æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
> - è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿæ¶æ„ï¼Œåªæ„å»ºå…¼å®¹çš„ç›®æ ‡æ¶æ„

## å®‰è£…å’Œä½¿ç”¨

### å®‰è£…

åŒå‡» `esn-0.1.0.pkg` æˆ–è¿è¡Œï¼š

```bash
sudo installer -pkg dist/esn-0.1.0.pkg -target /
```

### éªŒè¯å®‰è£…

```bash
esn --version
esn --help
```

### å®‰è£…ä½ç½®

- å¯æ‰§è¡Œæ–‡ä»¶ï¼š`/usr/local/bin/esn`
- å¸è½½è„šæœ¬ï¼š`/usr/local/share/esn/uninstall.sh`
- é…ç½®æ–‡ä»¶ï¼š`~/.esn/`ï¼ˆé¦–æ¬¡è¿è¡Œæ—¶åˆ›å»ºï¼‰

## å¸è½½

è¿è¡Œå¸è½½è„šæœ¬ï¼š

```bash
sudo /usr/local/share/esn/uninstall.sh
```

å¸è½½è„šæœ¬ä¼šï¼š
1. åˆ é™¤å¯æ‰§è¡Œæ–‡ä»¶ `/usr/local/bin/esn`
2. åˆ é™¤å…±äº«æ–‡ä»¶ `/usr/local/share/esn`
3. è¯¢é—®æ˜¯å¦åˆ é™¤é…ç½®æ–‡ä»¶ `~/.esn/`

## æ‰“åŒ…æµç¨‹è¯¦è§£

### 1. PyInstaller é…ç½®

é¡¹ç›®åŒ…å«ä¸¤ä¸ªæ¶æ„ç‰¹å®šçš„ PyInstaller é…ç½®æ–‡ä»¶ï¼š

- **esn-arm64.spec**: ARM64 æ¶æ„é…ç½®ï¼ˆM1/M2/M3 Macï¼‰
  - `target_arch='arm64'`
- **esn-x86_64.spec**: x86_64 æ¶æ„é…ç½®ï¼ˆIntel Macï¼‰
  - `target_arch='x86_64'`

ä¸¤ä¸ªé…ç½®æ–‡ä»¶å‡å®šä¹‰äº†ï¼š
- å…¥å£ç‚¹: `src/esn_tool/cli.py`
- éšå¼å¯¼å…¥: click, rich, httpx, questionary, textual
- æ‰“åŒ…æ¨¡å¼: å•æ–‡ä»¶å¯æ‰§è¡Œï¼ˆonefileï¼‰

### 2. ç›®å½•ç»“æ„

æ‰“åŒ…è„šæœ¬ä¼šåˆ›å»ºä»¥ä¸‹ç»“æ„ï¼š

```
pkg_root/
â””â”€â”€ usr/
    â””â”€â”€ local/
        â”œâ”€â”€ bin/
        â”‚   â””â”€â”€ esn          # å¯æ‰§è¡Œæ–‡ä»¶
        â””â”€â”€ share/
            â””â”€â”€ esn/
                â””â”€â”€ uninstall.sh  # å¸è½½è„šæœ¬
```

### 3. PKG å…ƒæ•°æ®

- Package ID: `com.esn.cli`
- ç‰ˆæœ¬å·: ä» `pyproject.toml` è¯»å–
- å®‰è£…ä½ç½®: `/`ï¼ˆæ ¹ç›®å½•ï¼‰
- å®‰è£…è„šæœ¬: `scripts/postinstall`

## è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹ç‰ˆæœ¬å·

ç¼–è¾‘ `pyproject.toml`:

```toml
[project]
version = "0.2.0"  # ä¿®æ”¹è¿™é‡Œ
```

### ä¿®æ”¹å®‰è£…è·¯å¾„

ç¼–è¾‘ `build_pkg.py` ä¸­çš„è·¯å¾„å˜é‡ï¼š

```python
# é»˜è®¤å®‰è£…åˆ° /usr/local/bin
bin_dir = PKG_ROOT / "usr" / "local" / "bin"
```

### æ·»åŠ é¢å¤–æ–‡ä»¶

åœ¨ `build_pkg.py` çš„ `prepare_pkg_structure()` å‡½æ•°ä¸­æ·»åŠ å¤åˆ¶é€»è¾‘ã€‚

## å¸¸è§é—®é¢˜

### Q: æç¤º "pyinstaller: command not found"

**A:** å®‰è£… PyInstaller:
```bash
uv pip install pyinstaller
```

### Q: æç¤º "pkgbuild: command not found"

**A:** å®‰è£… Xcode Command Line Tools:
```bash
xcode-select --install
```

### Q: æ‰“åŒ…åçš„æ–‡ä»¶å¤ªå¤§

**A:** PyInstaller ä¼šæ‰“åŒ…å®Œæ•´çš„ Python è¿è¡Œæ—¶å’Œæ‰€æœ‰ä¾èµ–ã€‚è¿™æ˜¯æ­£å¸¸çš„ï¼Œç¡®ä¿ç”¨æˆ·æ— éœ€å®‰è£… Python å³å¯ä½¿ç”¨ã€‚

å¯ä»¥å°è¯•ï¼š
1. ä½¿ç”¨ UPX å‹ç¼©ï¼ˆå·²åœ¨ spec ä¸­å¯ç”¨ï¼‰
2. æ’é™¤ä¸å¿…è¦çš„ä¾èµ–

### Q: å®‰è£…éœ€è¦ç®¡ç†å‘˜æƒé™

**A:** å› ä¸ºå®‰è£…åˆ° `/usr/local/bin`ï¼Œéœ€è¦ sudo æƒé™ã€‚è¿™æ˜¯ macOS çš„æ ‡å‡†è¡Œä¸ºã€‚

### Q: å¦‚ä½•åˆ†å‘ç»™å…¶ä»–ç”¨æˆ·

**A:** ç›´æ¥åˆ†å‘ `dist/esn-*-{arch}.pkg` æ–‡ä»¶å³å¯ã€‚ç”¨æˆ·åŒå‡»å®‰è£…ï¼Œæ— éœ€é…ç½® Python ç¯å¢ƒã€‚

æ ¹æ®ç”¨æˆ·çš„ Mac å‹å·é€‰æ‹©å¯¹åº”çš„æ¶æ„ï¼š
- **M1/M2/M3 Mac**: ä½¿ç”¨ `esn-*-arm64.pkg`
- **Intel Mac**: ä½¿ç”¨ `esn-*-x86_64.pkg`

### Q: åœ¨ M1 ä¸Šæ‰“åŒ… x86_64 å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A:** M1/M2/M3 Mac æ— æ³•äº¤å‰ç¼–è¯‘ x86_64 æ¶æ„ï¼Œè¿™æ˜¯æŠ€æœ¯é™åˆ¶ã€‚

è§£å†³æ–¹æ¡ˆï¼š
1. **åªæ‰“åŒ… ARM64**ï¼ˆæ¨èï¼‰ï¼š
   ```bash
   uv run python build_pkg.py --arch arm64
   ```

2. **åœ¨ Intel Mac ä¸Šæ„å»º x86_64**ï¼š
   - ä½¿ç”¨æœ‹å‹çš„ Intel Mac
   - æˆ–ä½¿ç”¨ GitHub Actions CI è‡ªåŠ¨æ„å»º

3. **ä½¿ç”¨ CI/CD**ï¼ˆæœ€ä¸“ä¸šï¼‰ï¼š
   ```yaml
   # .github/workflows/build.yml
   strategy:
     matrix:
       include:
         - os: macos-latest    # Intel
           arch: x86_64
         - os: macos-14        # Apple Silicon
           arch: arm64
   ```

### Q: æˆ‘åº”è¯¥æ‰“åŒ…å“ªä¸ªæ¶æ„ï¼Ÿ

**A:** å»ºè®®æ ¹æ®ç›®æ ‡ç”¨æˆ·é€‰æ‹©ï¼š
- **ä»…è‡ªç”¨æˆ–å†…éƒ¨å›¢é˜Ÿ**: æ ¹æ®å®é™…è®¾å¤‡æ‰“åŒ…å¯¹åº”æ¶æ„
- **å…¬å¼€åˆ†å‘**: å»ºè®®æ‰“åŒ…ä¸¤ä¸ªæ¶æ„ï¼Œè®©ç”¨æˆ·æ ¹æ®è®¾å¤‡é€‰æ‹©
- **CI/CD ç¯å¢ƒ**: åœ¨ GitHub Actions ç­‰ CI ç¯å¢ƒä¸­å¯ä»¥åˆ†åˆ«åœ¨ä¸åŒçš„ runner ä¸Šæ„å»º

## å‘å¸ƒæµç¨‹

### æ‰‹åŠ¨å‘å¸ƒ

1. **æ›´æ–°ç‰ˆæœ¬å·**: ä¿®æ”¹ `pyproject.toml` ä¸­çš„ version
2. **åŒæ­¥ä¾èµ–**: è¿è¡Œ `uv sync` ç¡®ä¿ä¾èµ–æœ€æ–°
3. **æµ‹è¯•åŠŸèƒ½**: ç¡®ä¿æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
4. **æ„å»º pkg**: è¿è¡Œ `uv run python build_pkg.py`
5. **æµ‹è¯•å®‰è£…**: åœ¨å¹²å‡€çš„ç³»ç»Ÿä¸Šæµ‹è¯•å®‰è£…åŒ…
6. **å‘å¸ƒ**: ä¸Šä¼ åˆ°å‘å¸ƒå¹³å°æˆ–å†…éƒ¨æœåŠ¡å™¨

### å»ºè®®çš„æ„å»ºç­–ç•¥

- **å¼€å‘æµ‹è¯•**: åªæ„å»ºå½“å‰æ¶æ„ `uv run python build_pkg.py --arch arm64`
- **æ­£å¼å‘å¸ƒ**: æ„å»ºæ‰€æœ‰æ¶æ„ `uv run python build_pkg.py --arch all`

### ä½¿ç”¨ GitLab CI è‡ªåŠ¨å‘å¸ƒï¼ˆæ¨èï¼‰

é¡¹ç›®å·²é…ç½® GitLab CI/CDï¼Œå¯ä»¥è‡ªåŠ¨åŒ–æ•´ä¸ªå‘å¸ƒæµç¨‹ï¼š

1. **æ›´æ–°ç‰ˆæœ¬å·**:
   ```bash
   # ä¿®æ”¹ pyproject.toml
   vim pyproject.toml  # version = "0.2.0"
   
   # æäº¤
   git add pyproject.toml
   git commit -m "chore: bump version to 0.2.0"
   ```

2. **åˆ›å»ºå¹¶æ¨é€ Tag**:
   ```bash
   git tag v0.2.0
   git push origin main --tags
   ```

3. **è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ**:
   - GitLab CI ä¼šè‡ªåŠ¨åœ¨ä¸¤ä¸ªæ¶æ„çš„ Runner ä¸Šæ„å»º
   - æ„å»ºå®Œæˆåè‡ªåŠ¨åˆ›å»º Release
   - é™„åŠ  ARM64 å’Œ x86_64 ä¸¤ä¸ª PKG æ–‡ä»¶

4. **ä¸‹è½½å‘å¸ƒåŒ…**:
   - è¿›å…¥ GitLab **Deployments â†’ Releases**
   - é€‰æ‹©å¯¹åº”ç‰ˆæœ¬ä¸‹è½½

è¯¦ç»†çš„ CI/CD é…ç½®è¯´æ˜è¯·å‚è€ƒ [GitLab CI æ–‡æ¡£](gitlab-ci.md)ã€‚

## è¿›é˜¶ï¼šä»£ç ç­¾å

å¦‚æœéœ€è¦åˆ†å‘åˆ°å…¬ä¼—ï¼Œå»ºè®®å¯¹ pkg è¿›è¡Œä»£ç ç­¾åï¼š

```bash
# ç­¾åå¯æ‰§è¡Œæ–‡ä»¶
codesign --sign "Developer ID Application: Your Name" dist/esn

# ç­¾å pkg
productsign --sign "Developer ID Installer: Your Name" \
  dist/esn-unsigned.pkg \
  dist/esn-signed.pkg
```

éœ€è¦ï¼š
1. Apple å¼€å‘è€…è´¦å·
2. Developer ID è¯ä¹¦

## æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æäº¤ issueã€‚
