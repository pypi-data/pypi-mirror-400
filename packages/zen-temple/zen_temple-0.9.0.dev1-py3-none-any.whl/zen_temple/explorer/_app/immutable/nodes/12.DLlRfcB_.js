import"../chunks/DsnmJJEf.js";import{s as Fe,o as _t}from"../chunks/CXB-c7mV.js";import{p as Xe,m as ue,a as y,b as g,c as Ze,f as $,d as de,r as ce,s as P,h as e,l as a,t as Re,e as w,g as F,u as He,j as pt,k as mt,i,B as ht}from"../chunks/DqiEsuqZ.js";import{i as W}from"../chunks/Bn_fozzu.js";import{u as bt,g as wt,a as Je,b as Me,e as xt}from"../chunks/P-s3qVBC.js";import{b as yt}from"../chunks/KivD7ms6.js";import{S as Pe,M as Ct,r as St,g as Tt,n as kt,c as Pt,p as Et,o as Dt,a as Nt}from"../chunks/DP9vVMdq.js";import{M as be}from"../chunks/Cw9LdTcD.js";import{a as je,C as $t}from"../chunks/COrL_aJw.js";import{C as Ae,D as Bt,F as we,g as Lt,b as Mt,c as At,j as Ot,W as Ke,r as It,h as Ee,l as Oe,n as Ft,i as Qe,E as Rt}from"../chunks/B5aYIa2h.js";import{T as Ie}from"../chunks/DBiFLRHa.js";import{u as xe}from"../chunks/BusSaQ9E.js";var jt=$('<div class="text-center text-xl text-muted my-2">Click on a bar to see a production and consumption breakdown.</div>'),Ut=$('<h3 class="font-semibold text-lg mb-4"> </h3> <!>',1),Wt=$('<h3 class="font-semibold text-lg mb-4"> </h3> <!>',1),Yt=$('<div class="grid grid-cols-2 gap-4"><!> <!></div>');function zt(De,v){Xe(v,!0);let Y=a(()=>{if(v.year==null)return[];const s=v.labels.findIndex(l=>l===v.year);return v.datasets.filter(l=>l.stack===v.solution).map(l=>({data:l.data.find((E,B)=>B===s),color:l.backgroundColor,label:l.label}))}),Z=a(()=>new Set(v.datasets.map(s=>s.stack)).size>1);function ne(){return{animation:{duration:0},maintainAspectRatio:!0,radius:"90%",plugins:{tooltip:{callbacks:{label:s=>{const l=Number(s.raw||0),E=s.dataset.data.map(L=>Number(L||0)).reduce((L,D)=>L+D,0),B=(l*100/E).toFixed(2);return`${s.dataset.label}: ${s.formattedValue}${v.tooltipSuffix} (${B}%)`}}},legend:{position:"top"}}}}function z(s,l){if(v.year==null)return[];const E=e(Y).filter(D=>D.data&&s(Number(D.data))),B=E.map(D=>D.data),L=E.map(D=>D.color);return[{label:l,data:B,backgroundColor:L}]}function d(s){return v.year==null?[]:e(Y).filter(l=>l.data&&s(Number(l.data))).map(l=>l.label||"")}let n=a(()=>z(s=>s>1e-6,"Production")),ee=a(()=>d(s=>s>1e-6)),te=a(ne),R=a(()=>z(s=>s<-1e-6,"Consumption")),Ne=a(()=>d(s=>s<-1e-6)),V=a(ne);var A=ue(),re=y(A);{var q=s=>{Ae(s,{children:(l,E)=>{var B=jt();g(l,B)},$$slots:{default:!0}})},G=s=>{var l=Yt(),E=de(l);Ae(E,{children:(L,D)=>{var oe=Ut(),j=y(oe),_=de(j);ce(j);var b=P(j,2);je(b,{type:"pie",get datasets(){return e(n)},get labels(){return e(ee)},get options(){return e(te)},boxed:!1}),Re(()=>Fe(_,`Breakdown of Production for ${v.year??""}
				${e(Z)?` (${v.solution})`:""}`)),g(L,oe)},$$slots:{default:!0}});var B=P(E,2);Ae(B,{children:(L,D)=>{var oe=Wt(),j=y(oe),_=de(j);ce(j);var b=P(j,2);je(b,{type:"pie",get datasets(){return e(R)},get labels(){return e(Ne)},get options(){return e(V)},boxed:!1}),Re(()=>Fe(_,`Breakdown of Consumption for ${v.year??""}
				${e(Z)?` (${v.solution})`:""}`)),g(L,oe)},$$slots:{default:!0}}),ce(l),g(s,l)};W(re,s=>{v.year==null||v.solution==null?s(q):s(G,!1)})}g(De,A),Ze()}var Vt=$('<!> <div class="text-gray-500 italic text-sm mb-2"> </div>',1),qt=$("<div><!></div>"),Gt=$('<div class="grid grid-cols-2"><div><!></div> <!></div>'),Ht=$("<!> <!> <!>",1),Jt=$("<!> <!> <!>",1),Kt=$("<!> <!> <!>",1),Qt=$("<!> <!>",1),Xt=$("<!> <!>",1),Zt=$("<!> <!>",1);function gr(De,v){Xe(v,!0);let Y=w(F([])),Z=w(F([])),ne=w(F([])),z=F([{id:"conversion",short_id:"conv",title:"Conversion",show:!0,subdivision:!0,show_subdivision:!0,filter_by_technologies:!0,positive:"flow_conversion_output",positive_label:"Conversion output",negative:"flow_conversion_input",negative_label:"Conversion input"},{id:"storage",short_id:"stor",title:"Storage",show:!0,subdivision:!0,show_subdivision:!0,filter_by_technologies:!0,positive:"flow_storage_discharge",positive_label:"Storage discharge",positive_suffix:" (discharge)",negative:"flow_storage_charge",negative_label:"Storage charge",negative_suffix:" (charge)"},{id:"transport",short_id:"tran",title:"Transport",show:!0,subdivision:!0,show_subdivision:!0,filter_by_technologies:!0,positive:"flow_transport",positive_label:"Transport in",positive_suffix:" (transport in)",negative:"flow_transport_loss",negative_label:"Transport out",negative_suffix:" (transport out)"},{id:"import_export",short_id:"imp_exp",title:"Import/Export",show:!0,subdivision:!1,show_subdivision:!1,filter_by_technologies:!1,positive:"flow_import",positive_label:"Import",negative:"flow_export",negative_label:"Export"},{id:"demand_shed_demand",short_id:"dem_shed",title:"Demand/Shed Demand",show:!0,subdivision:!1,show_subdivision:!1,filter_by_technologies:!1,positive:"shed_demand",positive_label:"Shed Demand",negative:"demand",negative_label:"Demand"}]),d=w(F([null])),n=w(null),ee=w(F([])),te=w(F([])),R=w(F([])),Ne=a(()=>[...e(ee),...e(te),...e(R)]),V=w(!1),A=w(F([])),re=w(F([])),q=w(null),G=w(null),s=null,l=null,E=null,B="",L="",D="",oe="",j="",_=w(!1),b=w(!1),et=a(()=>{if(!e(d)[0]?.solution_name||!e(n))return"";let t=e(d)[0].solution_name.split(".");return[t[t?.length-1],e(d)[0].scenario_name,e(n)].join("_")}),se=a(()=>e(d).some(t=>t===null)),Ue=w(F([])),We=a(()=>{let t=null;return!t&&e(n)&&(t=e(Ue).find(o=>o.carrier==e(n))),t&&(t[0]||t.units)||""}),$e=w(void 0),Ye=a(()=>e(re)),ze=a(()=>e(V)?"":` ${e(We)}`),tt=a(()=>({datasets:{bar:{borderColor:"rgb(255, 0, 0)",borderWidth:t=>!e(q)||!e(G)||t.chart.data.labels?.[t.dataIndex]!==e(q)||t.chart.data.datasets?.[t.datasetIndex].stack!==e(G)?0:5,borderRadius:2,borderSkipped:"middle"}},animation:{duration:0},maintainAspectRatio:!1,scales:{x:{stacked:!0,title:{display:!0,text:"Year"}},y:{stacked:!0,title:{display:!0,text:"Production"+(e(V)?"":` [${e(We)}]`)},max:e(V)?1:void 0,suggestedMin:e(V)?-1:void 0}},interaction:{intersect:!1,mode:"nearest",axis:"x"}}));const rt={tooltip:{callbacks:{label:t=>`${t.dataset.label}: ${t.formattedValue}${e(ze)}`,title:t=>{if(t.length>0)return`${t[0].label} - ${t[0].dataset.stack}`},labelColor:t=>({borderColor:t.dataset.backgroundColor,backgroundColor:t.dataset.backgroundColor,borderWidth:0})},filter:t=>Math.abs(t.parsed.y||0)>1e-6,borderWidth:0}};function ot(t){return Nt(t).map(o=>({...o,lineWidth:0}))}let Be=a(()=>{if(e(se))return[];const t=new Pe;return e(d).forEach(r=>{r.detail.system.set_carriers.forEach(u=>t.add(u))}),Array.from(t).sort()}),ye=a(()=>{if(e(se)||e(n)===null)return[];const t=new Pe;return e(d).forEach(r=>{Object.entries(r.detail.carriers_input).concat(Object.entries(r.detail.carriers_output)).filter(u=>e(n)&&u[1].includes(e(n))).forEach(u=>t.add(u[0]))}),Array.from(t).sort()}),Ce=a(()=>{if(e(se)||e(n)===null)return[];const t=new Pe;return e(d).forEach(r=>{r.detail.system.set_storage_technologies.forEach(u=>{r.detail.reference_carrier[u]===e(n)&&t.add(u)})}),Array.from(t).sort()}),Se=a(()=>{if(e(se)||e(n)===null)return[];const t=new Pe;return e(d).forEach(r=>{r.detail.system.set_transport_technologies.forEach(u=>{r.detail.reference_carrier[u]===e(n)&&t.add(u)})}),Array.from(t).sort()});function at(t){switch(t.id){case"conversion":return e(ye).length>0;case"storage":return e(Ce).length>0;case"transport":return e(Se).length>0;case"import_export":return e(Y).some(o=>o[6].some(r=>r.carrier===e(n))||o[7].some(r=>r.carrier===e(n)));case"demand_shed_demand":return e(Y).some(o=>o[8].some(r=>r.carrier===e(n))||o[9].some(r=>r.carrier===e(n)))}return!0}He(()=>{e(Be),pt(()=>{e(d)&&e(n)!==null&&!e(Be).includes(e(n))&&i(n,null)})}),xe(()=>e(ye),()=>!!e(d),()=>B,()=>s,t=>i(ee,t,!0),t=>B=t,t=>s=t),xe(()=>e(Ce),()=>!!e(d),()=>L,()=>l,t=>i(te,t,!0),t=>L=t,t=>l=t),xe(()=>e(Se),()=>!!e(d),()=>D,()=>E,t=>i(R,t,!0),t=>D=t,t=>E=t),xe(()=>e(ne),()=>!!e(d),()=>oe,()=>null,t=>i(A,t,!0),t=>oe=t,()=>{}),xe(()=>e(Z).map(t=>t.toString()),()=>!!e(d),()=>j,()=>null,t=>i(re,t,!0),t=>j=t,()=>{}),_t(()=>{i(n,wt("car")||null,!0),z.forEach(t=>{t.show=Je(t.short_id,t.show),t.subdivision=Je(t.short_id+"_sub",t.subdivision)}),s=Me("conv_tech"),l=Me("stor_tech"),E=Me("tran_tech")}),He(()=>{e(n),z.forEach(t=>{t.show,t.subdivision}),e(ee),e(te),mt().then(()=>{let t={car:e(n),conv_tech:e(ee).map(o=>e(ye).indexOf(o)).join("~"),stor_tech:e(te).map(o=>e(Ce).indexOf(o)).join("~"),tran_tech:e(R).map(o=>e(Se).indexOf(o)).join("~")};z.forEach(o=>{t[o.short_id]=o.show?"1":"0",t[o.short_id+"_sub"]=o.subdivision?"1":"0"}),bt(t)})});function nt(){i(q,null),i(G,null),Ve()}function st(){Ve()}function it(t,o){if(!t)return;const r=e(Te)[o].stack;if(!r||e(q)===t&&e(G)===r){i(q,null),i(G,null);return}i(q,t,!0),i(G,r||null,!0)}async function Ve(){if(e(se)||e(n)===null)return;i(b,!0),i(Y,[],!0);const t=e(d),o=await Promise.all(t.map(r=>Lt(r.solution_name,["flow_conversion_output","flow_conversion_input","flow_storage_discharge","flow_storage_charge","flow_import","flow_export","flow_transport","flow_transport_loss","shed_demand","demand"],r.scenario_name,e(n),"demand")));i(Y,o.map(r=>z.flatMap(u=>[r[u.positive]?.data||[],r[u.negative]?.data||[]])),!0),o.length>0&&o[0].unit?.data&&i(Ue,o[0].unit.data,!0),i(b,!1)}function qe(t,o,r,u,C){if(!e(n))return Ee.empty();const H={carrier:[e(n)],node:e(A)};o.filter_by_technologies&&(H.technology=e(Ne));const J=o.subdivision?["technology"]:[];let U=t.filterByCriteria(H).filterDataByIndex(e(re).map(c=>e(Z).indexOf(Number(c)))).groupBy(J).mapIndex(c=>({...c,label:o.subdivision?c.technology+(u||""):r}));return C!==void 0&&(U=U.mapData(C)),U}let lt=a(()=>{if(e(A).length==0||e(re).length==0||e(Y).length==0)return[[],[]];It(),St();const t=[];return[e(d).flatMap((r,u)=>{const C=e(Y)[u];if(!r||!C.length)return[];let H=z.flatMap((p,M)=>{if(!p.show)return[];let f=Ee.fromRows(C[2*M]),ie=Ee.fromRows(C[2*M+1]);if(p.id==="transport"){const O=f,_e=ie.filterByCriteria({technology:e(R),edge:Oe(r.detail.edges,e(A),!0)});f=O.filterByCriteria({technology:e(R),edge:Oe(r.detail.edges,e(A),!0)}).mapEntries((N,T)=>{const K=_e.find(k=>k.index.technology===N.technology&&k.index.edge===N.edge)?.data;return!K||K.length!==T.length?{index:N,data:T}:{data:T.map((k,m)=>k-K[m]),index:N}}),ie=O.filterByCriteria({technology:e(R),edge:Oe(r.detail.edges,e(A),!1)})}let S=qe(f,p,p.positive_label,p.positive_suffix),ae=qe(ie,p,p.negative_label,p.negative_suffix,O=>-O);return[S,ae]}),J=Ee.concatenate(H);e(V)&&(J=J.normalize());let U=Tt(r.solution_name,r.scenario_name),c=u>0?kt():void 0;return t.push(Pt(U,c)),J.toArray().map(p=>{const M=p.index.label,f=Ft(M);return{label:M,data:p.data,borderColor:f,backgroundColor:c!==void 0?Et.draw(c,Qe(f)):Qe(f),stack:U}})}),t]}),Ge=a(()=>ht(e(lt),2)),Te=a(()=>e(Ge)[0]),ut=a(()=>e(Ge)[1]);Bt(De,{parentTitle:"The Transition Pathway",pageTitle:"Production",subtitle:"Annual production and consumption of a carrier",filters:u=>{var C=Xt(),H=y(C);we(H,{title:"Solution Selection",children:(c,p)=>{{let M=a(()=>e(b)||e(_));Ct(c,{onSelected:nt,get disabled(){return e(M)},get solutions(){return e(d)},set solutions(f){i(d,f,!0)},get years(){return e(Z)},set years(f){i(Z,f,!0)},get nodes(){return e(ne)},set nodes(f){i(ne,f,!0)},get loading(){return e(_)},set loading(f){i(_,f,!0)}})}}});var J=P(H,2);{var U=c=>{var p=Qt(),M=y(p);we(M,{title:"Carrier Selection",children:(S,ae)=>{{let O=a(()=>e(_)||e(b));Mt(S,{label:"Carrier",get options(){return e(Be)},get disabled(){return e(O)},onUpdate:st,get value(){return e(n)},set value(le){i(n,le,!0)}})}}});var f=P(M,2);{var ie=S=>{var ae=Kt(),O=y(ae);we(O,{title:"Production Component Selection",children:(T,K)=>{var Q=ue(),k=y(Q);xt(k,17,()=>z,m=>m.id,(m,h,I)=>{var x=ue(),X=y(x);{var pe=ge=>{var fe=Vt(),ve=y(fe);Ot(ve,{get label(){return e(h).title}});var ke=P(ve,2),Le=de(ke);ce(ke),Re(()=>Fe(Le,`No data available for ${e(h).title??""}.`)),g(ge,fe)},dt=ge=>{var fe=Gt(),ve=de(fe),ke=de(ve);{let me=a(()=>e(_)||e(b));Ie(ke,{get label(){return e(h).title},get disabled(){return e(me)},get value(){return e(h).show},set value(he){e(h).show=he}})}ce(ve);var Le=P(ve,2);{var ct=me=>{var he=qt(),gt=de(he);{let ft=a(()=>e(_)||e(b));Ie(gt,{label:"with Subdivision",get disabled(){return e(ft)},get value(){return e(h).subdivision},set value(vt){e(h).subdivision=vt}})}ce(he),g(me,he)};W(Le,me=>{e(h).show&&e(h).show_subdivision&&me(ct)})}ce(fe),g(ge,fe)};W(X,ge=>{at(e(h))?ge(dt,!1):ge(pe)})}g(m,x)}),g(T,Q)}});var le=P(O,2);we(le,{title:"Technology Selection",children:(T,K)=>{var Q=Ht(),k=y(Q);{let I=a(()=>e(_)||e(b));be(k,{get options(){return e(ye)},label:"Conversion",emptyText:"No conversion technologies available.",get disabled(){return e(I)},get value(){return e(ee)},set value(x){i(ee,x,!0)}})}var m=P(k,2);{let I=a(()=>e(_)||e(b));be(m,{get options(){return e(Ce)},label:"Storage",emptyText:"No storage technologies available.",get disabled(){return e(I)},get value(){return e(te)},set value(x){i(te,x,!0)}})}var h=P(m,2);{let I=a(()=>e(_)||e(b));be(h,{get options(){return e(Se)},label:"Transport",emptyText:"No transport technologies available.",get disabled(){return e(I)},get value(){return e(R)},set value(x){i(R,x,!0)}})}g(T,Q)}});var _e=P(le,2);{var N=T=>{we(T,{title:"Data Selection",children:(K,Q)=>{var k=Jt(),m=y(k);{let x=a(()=>e(_)||e(b));Ie(m,{label:"Normalization",get disabled(){return e(x)},get value(){return e(V)},set value(X){i(V,X,!0)}})}var h=P(m,2);{let x=a(()=>e(_)||e(b));be(h,{get options(){return e(ne)},label:"Nodes",get disabled(){return e(x)},get value(){return e(A)},set value(X){i(A,X,!0)}})}var I=P(h,2);{let x=a(()=>e(Z).map(pe=>pe.toString())),X=a(()=>e(_)||e(b));be(I,{get options(){return e(x)},label:"Years",get disabled(){return e(X)},get value(){return e(re)},set value(pe){i(re,pe,!0)}})}g(K,k)}})};W(_e,T=>{e(n)!==null&&T(N)})}g(S,ae)};W(f,S=>{e(n)!==null&&S(ie)})}g(c,p)};W(J,c=>{!e(_)&&!e(se)&&c(U)})}g(u,C)},buttons:u=>{{let C=a(()=>[e($e)]);$t(u,{get charts(){return e(C)},downloadable:!0})}},mainContent:u=>{var C=ue(),H=y(C);{var J=c=>{At(c)},U=c=>{var p=ue(),M=y(p);{var f=S=>{Ke(S,{message:"Please select all solutions"})},ie=S=>{var ae=ue(),O=y(ae);{var le=N=>{Ke(N,{message:"Please select a carrier"})},_e=N=>{var T=ue(),K=y(T);{var Q=m=>{Rt(m,{message:"No data with this selection"})},k=m=>{var h=Zt(),I=y(h);yt(je(I,{type:"bar",get datasets(){return e(Te)},get labels(){return e(Ye)},get options(){return e(tt)},get pluginOptions(){return rt},get plotName(){return e(et)},get patterns(){return e(ut)},generateLabels:ot,get onClickLegend(){return Dt},onClickBar:it}),X=>i($e,X,!0),()=>e($e));var x=P(I,2);zt(x,{get datasets(){return e(Te)},get labels(){return e(Ye)},get year(){return e(q)},get solution(){return e(G)},get tooltipSuffix(){return e(ze)}}),g(m,h)};W(K,m=>{e(Te).length==0?m(Q):m(k,!1)},!0)}g(N,T)};W(O,N=>{e(n)==null?N(le):N(_e,!1)},!0)}g(S,ae)};W(M,S=>{e(se)?S(f):S(ie,!1)},!0)}g(c,p)};W(H,c=>{e(_)||e(b)?c(J):c(U,!1)})}g(u,C)}}),Ze()}export{gr as component};
