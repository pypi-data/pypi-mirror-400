name: Publish

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup uv
      uses: astral-sh/setup-uv@v4

    - name: Set up Python
      run: uv python install 3.12

    - name: Check if version exists on PyPI
      id: check
      run: |
        PACKAGE_VERSION=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
        if curl -s "https://pypi.org/pypi/serp-mcp/${PACKAGE_VERSION}/json" | grep -q '"version"'; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Bump version if exists
      if: steps.check.outputs.exists == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Get current version and bump patch
        CURRENT=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
        IFS='.' read -r major minor patch <<< "$CURRENT"
        NEW_VERSION="${major}.${minor}.$((patch + 1))"

        # Update pyproject.toml
        sed -i "s/^version = \"${CURRENT}\"/version = \"${NEW_VERSION}\"/" pyproject.toml

        git add pyproject.toml
        git commit -m "Bump version to ${NEW_VERSION} [skip ci]"
        git push

    - name: Install dependencies
      run: uv sync --all-extras

    - name: Run tests
      run: uv run pytest

    - name: Run lint
      run: uv run ruff check .

    - name: Run ty
      run: uv run ty check serp_mcp

    - name: Build package
      run: uv build

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: dist/