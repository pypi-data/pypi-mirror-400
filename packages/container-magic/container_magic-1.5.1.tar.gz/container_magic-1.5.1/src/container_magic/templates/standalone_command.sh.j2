#!/usr/bin/env bash
# Standalone command script: {{ command_name }}
# Generated by container-magic: https://github.com/markhedleyjones/container-magic
{% if description -%}
# {{ description }}
{% endif -%}

set -euo pipefail

IMAGE_NAME="{{ project_name }}"
TAG="latest"
WORKDIR="{{ workdir }}"
SHELL="{{ shell }}"

# Detect runtime backend
{% if backend == "auto" -%}
if command -v podman >/dev/null 2>&1; then
	RUNTIME="podman"
elif command -v docker >/dev/null 2>&1; then
	RUNTIME="docker"
else
	echo "Error: Neither podman nor docker found in PATH"
	exit 1
fi
{% else -%}
RUNTIME="{{ backend }}"
{% endif -%}

# Build run arguments
RUN_ARGS=(
	"--rm"
	"--hostname" "${IMAGE_NAME}"
{% if privileged -%}
	"--privileged"
{% endif -%}
{% if network -%}
	"--net" "{{ network }}"
{% endif -%}
)

# Add TTY flags if stdin is a terminal
if [[ -t 0 ]]; then
	RUN_ARGS+=("--interactive" "--tty")
fi

# Mount workspace
RUN_ARGS+=("-v" "$(pwd)/{{ workspace_name }}:${WORKDIR}/{{ workspace_name }}:z")

{% if env -%}
# Environment variables
{% for key, value in env.items() -%}
RUN_ARGS+=("-e" "{{ key }}={{ value }}")
{% endfor -%}
{% endif -%}

# Check if image exists
if ! ${RUNTIME} image inspect "${IMAGE_NAME}:${TAG}" >/dev/null 2>&1; then
	echo "Error: Image ${IMAGE_NAME}:${TAG} not found"
	echo "Build it first with: ./build.sh"
	exit 1
fi

# Run command
${RUNTIME} run "${RUN_ARGS[@]}" \
	-w "${WORKDIR}" \
	"${IMAGE_NAME}:${TAG}" \
	"${SHELL}" -c "{{ command }}"
