import"./map-D3rdFka2.js";import"./_initCloneObject-w666mXAM.js";import"./_baseClone-BEd4hvTE.js";import"./_baseEach-BN0HOvWa.js";import"./isArrayLikeObject-CPqL_9mx.js";import"./merge-CBnaWh74.js";import"./flatMap-CTTB_rc6.js";import{a as e,c as t,d as n,f as r,h as i,i as a,l as o,n as s,o as c,r as l,s as ee,t as te,u as ne}from"./ConfigurableChartCard-DXBpeDOb.js";import"./clone-BmyFpy2t.js";import"./now-ByUdnbf_.js";import{n as re,r as ie,t as ae}from"./css-CzALU0nX.js";import{$r as u,Gr as d,Ir as f,Jn as oe,Nr as p,Pr as se,Qr as ce,Rr as m,Sr as h,Xr as g,Zn as le,_r as _,a as ue,ai as v,dr as de,er as y,gr as b,hi as fe,hr as x,kr as S,mr as C,n as pe,pr as w,qr as T,r as E,tr as me,ur as he,vi as D,vr as O,xr as k}from"./index-EnPYNmIz.js";var ge={class:`container-main`},_e={class:`mb-6 flex flex-wrap items-start justify-between gap-4 border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-white dark:bg-gray-900`},ve={class:`flex flex-col gap-1 min-w-0`},ye={key:0,class:`flex items-center gap-2`},be={key:2,class:`flex items-center gap-2`},xe={class:`font-mono`},Se={class:`flex items-center justify-end gap-2 flex-wrap`},Ce={key:0},we={key:1},Te={key:0},Ee={key:1},De={key:0},Oe={key:1},ke={class:`flex items-center gap-2`},Ae={key:0,class:`flex items-center justify-center gap-4 mb-4`},je={class:`text-sm text-gray-600 dark:text-gray-400`},Me={class:`text-xs ml-2`},A=`Metrics`,Ne=`run-layout`,Pe=`project-layout`,Fe=2,Ie={__name:`[id]`,setup(Ie){let j=y(),{animationsEnabled:Le}=pe(),{hoverSyncEnabled:Re,toggleHoverSync:ze}=s(),M=u({}),N=u([]),P=u(null),F=u(null);me();let Be=C(()=>j.params.project),Ve=C(()=>j.params.id),He=C(()=>F.value?.name||P.value?.metadata?.name||Ve.value),Ue=C(()=>F.value?.annotation||P.value?.metadata?.annotation||``),We=C(()=>`${Ue.value&&Ue.value.trim().length>0?Ue.value:`No annotation`}(${Ve.value})`),Ge=C(()=>!!F.value?.finished_at),I=u(!1),L=u(!1),Ke=u(``),qe=u(``),Je=u(null),Ye=u(null),Xe=u(!1),Ze=u(!1),R=u([{name:`Metrics`,cards:[]}]),z=u(`Metrics`),B=u(1),Qe=u(!1),V=u(!1),$e=u(!1),H=u(``),et=u(!1),tt=u(!1),U=u(`line`),W=u([]),nt=u(!0),rt=u(new Set),G=u(new Set),K=u(new Set),it=u(new Set),at=u(!1);async function ot(e){if(!(!Be.value||!e)&&!(F.value?.name&&F.value.name!==e))try{let t=(await oe(Be.value)).runs?.find(t=>t.run_id===e);t?.name&&t.name!==t.run_id&&(F.value={...F.value||{},name:t.name,annotation:t.annotation},P.value?.metadata&&(P.value={...P.value,metadata:{...P.value.metadata||{},name:t.name,annotation:t.annotation},experiment_info:{...P.value.experiment_info||{},name:t.name}}))}catch(e){console.warn(`Failed to hydrate run name:`,e)}}function st(e,t=`Request failed`){let n=e?.response?.data?.detail;return typeof n==`string`?n:n?.error?n.error:e?.message||t}function ct(){Ke.value=He.value,I.value=!0,S(()=>{Je.value?.focus(),Je.value?.select?.()})}function lt(){Xe.value||(I.value=!1)}async function ut(){if(!I.value||Xe.value)return;let e=Ke.value.trim();if(!e){E.warning(`Run name cannot be empty`);return}if(e===He.value){I.value=!1;return}Xe.value=!0;try{await le(Be.value,Ve.value,{name:e}),F.value={...F.value||{},name:e},P.value&&={...P.value,metadata:{...P.value.metadata||{},name:e}},await ot(Ve.value),E.success(`Run name updated`),I.value=!1}catch(e){E.error(st(e,`Failed to update run name`))}finally{Xe.value=!1}}function dt(){if(!Ge.value){E.warning(`Finish the run before renaming the annotation`);return}qe.value=Ue.value,L.value=!0,S(()=>{Ye.value?.focus(),Ye.value?.select?.()})}function ft(){Ze.value||(L.value=!1)}async function pt(){if(!L.value||Ze.value)return;let e=qe.value.trim();if(!e){E.warning(`Annotation cannot be empty`);return}if(e===Ue.value){L.value=!1;return}Ze.value=!0,Ue.value;try{let t=await le(Be.value,Ve.value,{annotation:e});F.value={...F.value||{},annotation:t.annotation},P.value&&={...P.value,metadata:{...P.value.metadata||{},annotation:t.annotation}},E.success(`Annotation updated`),L.value=!1,await ot(t.run_id)}catch(e){E.error(st(e,`Failed to update annotation`))}finally{Ze.value=!1}}let mt=u(0),ht=u(null),gt=u(!0),q=u(0),J=u(window.innerWidth<=900),_t=window.matchMedia(`(max-width: 900px)`),vt=e=>{J.value=e.matches,q.value=0};p(()=>{_t.addEventListener(`change`,vt)}),se(()=>{_t.removeEventListener(`change`,vt)});let yt=()=>({xAxis:`global_step`,smoothing:`disabled`,smoothingValue:.9,histogramMode:`flow`,downsampleRate:-1}),Y=ce({[A]:yt()});function X(e){let t=e||A;Y[t]||(Y[t]=yt())}let Z=C(()=>{let e=z.value||A;return X(e),Y[e]}),bt=C(()=>`${Ne}-${j.params.project}-${j.params.id}`),xt=C(()=>`${Pe}-${j.params.project}`);function Q(){at.value||=!0}function St(e,t){if(!e)return null;try{let t=JSON.parse(e);return Ct(t)?(Array.isArray(t.removedMetrics)||(t.removedMetrics=[]),Array.isArray(t.removedTables)||(t.removedTables=[]),Array.isArray(t.removedHistograms)||(t.removedHistograms=[]),Array.isArray(t.removedMedia)||(t.removedMedia=[]),t):null}catch(e){return console.warn(`[RunLayout] Failed to parse ${t}:`,e),null}}function Ct(e){return!(!e||typeof e!=`object`||!Array.isArray(e.tabs)||`hiddenRunIds`in e||`customRunColors`in e)}function wt(){let e=St(localStorage.getItem(bt.value),bt.value);if(e)return e;if(xt.value===bt.value)return null;let t=St(localStorage.getItem(xt.value),xt.value);return t?(localStorage.setItem(bt.value,JSON.stringify(t)),localStorage.removeItem(xt.value),t):null}async function Tt(){try{nt.value=!0,F.value=null,I.value=!1,L.value=!1;let e=j.params.project,t=j.params.id;console.log(`[Init] Loading experiment: ${e}/${t}`),M.value={};let n=await fetch(`/api/projects/${e}/runs/${t}/summary`);if(!n.ok){console.error(`Failed to fetch summary:`,n.status,n.statusText);let e=await n.text();throw console.error(`Error response:`,e),Error(`Failed to fetch summary: ${n.status}`)}let r=await n.json();if(console.log(`Summary response:`,r),!r.available_data||!r.available_data.scalars)throw console.error(`Invalid summary structure:`,r),Error(`Invalid summary response structure`);P.value=r,F.value={...r.metadata||{}},N.value=r.available_data.scalars,N.value.includes(`timestamp`)&&(N.value.push(`walltime`),N.value.push(`relative_walltime`));let i=wt();if(i){if(at.value=!0,z.value=i.activeTab||`Metrics`,B.value=i.nextCardId||1,i.tabSettings)for(let[e,t]of Object.entries(i.tabSettings))Y[e]={...yt(),...t};else i.globalSettings?Y[A]={...yt(),...i.globalSettings}:Y[A]=yt();i.removedMetrics&&(rt.value=new Set(i.removedMetrics)),i.removedTables&&(G.value=new Set(i.removedTables)),i.removedHistograms&&(K.value=new Set(i.removedHistograms)),i.removedMedia&&(it.value=new Set(i.removedMedia))}let a=new Set;if(i?.tabs)for(let e of i.tabs)for(let t of e.cards)t.config.yMetrics&&t.config.yMetrics.forEach(e=>a.add(e));let o=e=>!a.has(e)&&!rt.value.has(e);if(i?.tabs){R.value=i.tabs;for(let e of R.value)X(e.name);let e=B.value,t=!1,n=new Set([`step`,`global_step`,`timestamp`,`walltime`,`relative_walltime`]),a=new Map;a.set(``,[]);for(let e of N.value){if(n.has(e)||!o(e))continue;let t=e.indexOf(`/`);if(t>0){let n=e.substring(0,t);a.has(n)||a.set(n,[]),a.get(n).push(e)}else a.get(``).push(e)}let s=R.value.find(e=>e.name===`Metrics`);if(s)for(let n of a.get(``))s.cards.push({id:`card-${e++}`,config:{type:`line`,title:n,widthPercent:33,height:400,xMetric:`global_step`,yMetrics:[n]}}),t=!0;for(let[n,r]of a.entries()){if(n===``)continue;let i=R.value.find(e=>e.name===n);i||(i={name:n,cards:[]},R.value.push(i),X(n),console.log(`[Init] Created new tab for namespace: ${n}`));for(let n of r)i.cards.push({id:`card-${e++}`,config:{type:`line`,title:n,widthPercent:33,height:400,xMetric:`global_step`,yMetrics:[n]}}),t=!0}let{addedAny:c,nextCardId:l}=Et(r,e);e=l,c&&(t=!0),B.value=e,t&&(console.log(`[Layout] Saved layout updated with new default cards`),$())}else{Y[A]=yt();let e=[],t=1,n=new Set([`step`,`global_step`,`timestamp`,`walltime`,`relative_walltime`]),i=new Map;i.set(``,[]);for(let e of N.value){if(n.has(e))continue;let t=e.indexOf(`/`);if(t>0){let n=e.substring(0,t);i.has(n)||i.set(n,[]),i.get(n).push(e)}else i.get(``).push(e)}for(let n of i.get(``))e.push({id:`card-${t++}`,config:{type:`line`,title:n,widthPercent:33,height:400,xMetric:`global_step`,yMetrics:[n]}});R.value[0].cards=e;let a=new Map;for(let[e,n]of i.entries())if(e!==``){a.has(e)||a.set(e,[]);for(let r of n)a.get(e).push({id:`card-${t++}`,config:{type:`line`,title:r,widthPercent:33,height:400,xMetric:`step`,yMetrics:[r]}})}for(let e of r.available_data?.tables||[]){if(G.value.has(e))continue;let n=e.indexOf(`/`);if(n>0){let r=e.substring(0,n);a.has(r)||a.set(r,[]),a.get(r).push({id:`card-${t++}`,config:{type:`table`,title:e,widthPercent:50,height:400,tableName:e,currentStep:0}})}}for(let e of r.available_data?.histograms||[]){if(K.value.has(e))continue;let n=e.indexOf(`/`);if(n>0){let r=e.substring(0,n);a.has(r)||a.set(r,[]);let i=r===`gradients`||r===`params`?`flow`:`single`;a.get(r).push({id:`card-${t++}`,config:{type:`histogram`,title:e,widthPercent:33,height:400,histogramName:e,currentStep:0,histogramMode:i}})}}for(let[e,t]of a.entries())t.length>0&&(R.value.push({name:e,cards:t}),X(e));for(let n of r.available_data?.media||[])!n.includes(`/`)&&!it.value.has(n)&&e.push({id:`card-${t++}`,config:{type:`media`,title:n,widthPercent:33,height:400,mediaName:n,currentStep:0}});for(let n of r.available_data?.tables||[])!n.includes(`/`)&&!G.value.has(n)&&e.push({id:`card-${t++}`,config:{type:`table`,title:n,widthPercent:50,height:400,tableName:n,currentStep:0}});for(let n of r.available_data?.histograms||[])!n.includes(`/`)&&!K.value.has(n)&&e.push({id:`card-${t++}`,config:{type:`histogram`,title:n,widthPercent:33,height:400,histogramName:n,currentStep:0}});R.value[0].cards=e,B.value=t}await At(),await Dt(),await ot(t),nt.value=!1,console.log(`[Init] Initialization complete`),Bt()}catch(e){console.error(`Failed to load experiment:`,e),nt.value=!1}}function Et(e,t=B.value){let n=t,r=!1;R.value.length===0&&(R.value=[{name:`Metrics`,cards:[]}]);let i=e=>{let t=R.value.find(t=>t.name===e);return t||(t={name:e,cards:[]},R.value.push(t),console.log(`[Layout] Created tab '${e}' for default artifacts`)),t},a=(e,t)=>{e.cards.push({id:`card-${n++}`,config:t}),r=!0},o=new Set,s=new Set,c=new Set;for(let e of R.value)for(let t of e.cards)t.config.type===`table`&&t.config.tableName?o.add(t.config.tableName):(t.config.type===`histogram`||t.config.type===`histogram_surface`)&&t.config.histogramName?s.add(t.config.histogramName):t.config.type===`media`&&t.config.mediaName&&c.add(t.config.mediaName);let l=e?.available_data||{};for(let e of l.tables||[]){if(G.value.has(e)||o.has(e))continue;let t=e.indexOf(`/`),n=t>0?e.substring(0,t):``,r=i(n===``?`Metrics`:n);a(r,{type:`table`,title:e,widthPercent:50,height:400,tableName:e,currentStep:0}),o.add(e)}for(let e of l.histograms||[]){if(K.value.has(e)||s.has(e))continue;let t=e.indexOf(`/`),n=t>0?e.substring(0,t):``,r=i(n===``?`Metrics`:n);a(r,{type:`histogram`,title:e,widthPercent:33,height:400,histogramName:e,currentStep:0,histogramMode:n===`gradients`||n===`params`?`flow`:`single`}),s.add(e)}for(let e of l.media||[]){if(e.includes(`/`)||it.value.has(e)||c.has(e))continue;let t=i(`Metrics`);a(t,{type:`media`,title:e,widthPercent:33,height:400,mediaName:e,currentStep:0}),c.add(e)}return{addedAny:r,nextCardId:n}}p(()=>{Tt()}),se(()=>{Vt(),Ut&&=(clearTimeout(Ut),null)});async function Dt(){try{let e=j.params.project,t=j.params.id;if((await(await fetch(`/api/projects/${e}/runs/${t}/scalars/global_step`)).json()).values.some(e=>e!==0&&e!==null)){for(let e of R.value)for(let t of e.cards)(t.config.type===`line`||!t.config.type)&&t.config.xMetric===`step`&&(t.config.xMetric=`global_step`);$()}}catch(e){console.error(`Failed to determine default x-axis:`,e)}}function Ot(e,t){if(!M.value[e])return M.value[e]=Array(t).fill(null),M.value[e];let n=M.value[e];if(n.length<t){let e=n.length;n.length=t;for(let r=e;r<t;r++)n[r]=null}return n}function kt(e){return{step:Ot(`step`,e),global_step:Ot(`global_step`,e),timestamp:Ot(`timestamp`,e)}}async function At(e=!1){try{console.log(`[fetchMetricsForTab] Starting fetch for tab: ${z.value}, forceRefresh: ${e}`);let t=R.value.find(e=>e.name===z.value);if(!t){console.warn(`[fetchMetricsForTab] Tab not found: ${z.value}`);return}let n=new Set([`walltime`,`relative_walltime`]),r=new Set;for(let e of t.cards)if((e.config.type===`line`||!e.config.type)&&(e.config.xMetric&&!n.has(e.config.xMetric)&&r.add(e.config.xMetric),e.config.yMetrics))for(let t of e.config.yMetrics)n.has(t)||r.add(t);let i=j.params.project,a=j.params.id;for(let t of r)if(!M.value[t]||e)try{let n=!!M.value[t]&&e;console.log(`[fetchMetricsForTab] ${n?`Updating`:`Fetching`} metric: ${t}`);let r=await fetch(`/api/projects/${i}/runs/${a}/scalars/${t}`);if(!r.ok){console.warn(`[fetchMetricsForTab] Failed to fetch ${t}: ${r.status}`),M.value[t]||(M.value[t]=[]);continue}let o=await r.json();if(n){let e=M.value[t].filter(e=>e!==null).length,n=o.values.length;if(e===n){console.log(`[fetchMetricsForTab] ${t}: No new data (${n} points), skipping update`);continue}console.log(`[fetchMetricsForTab] ${t}: ${e} → ${n} points`)}else console.log(`[fetchMetricsForTab] Fetched ${t}: ${o.values?.length||0} values`);if(console.log(`[fetchMetricsForTab] ${t} response:`,{hasSteps:!!o.steps,hasValues:!!o.values,stepsIsArray:Array.isArray(o.steps),valuesIsArray:Array.isArray(o.values),stepsLength:o.steps?.length,valuesLength:o.values?.length}),!o.steps||!Array.isArray(o.steps)||o.steps.length===0){console.warn(`[fetchMetricsForTab] ${t}: Invalid or empty steps array`),M.value[t]||(M.value[t]=[]);continue}let s=Math.max(...o.steps);console.log(`[fetchMetricsForTab] ${t}: maxStep = ${s}, creating array of size ${s+1}`);let c=M.value[t],l=n&&c?Math.max(s+1,c.length):s+1;console.log(`[fetchMetricsForTab] ${t}: targetSize = ${l}`);let ee=Array(l).fill(null),te=null;o.steps&&o.steps.length>0&&(te=kt(l));for(let e=0;e<o.steps.length;e++){let t=o.steps[e],n=o.values[e];if(n===`NaN`?n=NaN:n===`Infinity`?n=1/0:n===`-Infinity`&&(n=-1/0),ee[t]=n,te){if(te.step[t]=t,Array.isArray(o.global_steps)){let n=o.global_steps[e];n!=null&&(te.global_step[t]=n)}if(Array.isArray(o.timestamps)){let n=o.timestamps[e];n!=null&&(te.timestamp[t]=new Date(n*1e3).toISOString())}}}M.value[t]=ee,console.log(`[fetchMetricsForTab] Stored ${t} in cache: ${ee.length} slots, ${ee.filter(e=>e!==null).length} non-null values`)}catch(e){console.error(`Failed to fetch metric ${t}:`,e),M.value[t]=[]}if(M.value.timestamp){let e=M.value.timestamp,t=[],n=[],r=null;for(let i=0;i<e.length;i++)if(e[i]){let a=new Date(e[i]).getTime()/1e3;t[i]=a,r===null?(r=a,n[i]=0):n[i]=a-r}else t[i]=null,n[i]=null;M.value.walltime=t,M.value.relative_walltime=n}console.log(`[fetchMetricsForTab] Completed. Cache keys:`,Object.keys(M.value))}catch(e){console.error(`[fetchMetricsForTab] Error:`,e)}}let jt=C(()=>{let e={time:M.value.step||[]};for(let[t,n]of Object.entries(M.value))e[t]=n;return console.log(`[sparseData] Computed with ${Object.keys(e).length} metrics`),e}),Mt=C({get(){let e=R.value.find(e=>e.name===z.value);return e?e.cards:[]},set(e){let t=R.value.find(e=>e.name===z.value);t&&(t.cards=e,Q(),$())}}),Nt=C(()=>J.value?2:12),Pt=C(()=>J.value?280:400),Ft=C(()=>{let e=Mt.value,t=0,n=[],r=[];for(let i of e)i.config.type===`line`||i.config.type===`histogram`||i.config.type===`histogram_surface`?(t++,t>Nt.value?(n.push(r),r=[i],t=1):r.push(i)):r.push(i);return r.length>0&&n.push(r),n}),It=C(()=>Ft.value.length),Lt=C(()=>{if(Ft.value.length===0)return[];let e=Math.min(q.value,Ft.value.length-1);return Ft.value[e]||[]});d(z,()=>{if(nt.value){console.log(`[Watch] activeTab changed during init, skipping fetch`);return}console.log(`[Watch] activeTab changed to:`,z.value),q.value=0,At(),$()}),d(()=>[j.params.project,j.params.id],([e,t],[n,r])=>{r&&(t!==r||e!==n)&&(console.log(`[Watch] Route changed - reinitializing`),Vt(),q.value=0,mt.value=0,I.value=!1,L.value=!1,Tt())}),d(()=>R.value.map(e=>e.cards.map(e=>({id:e.id,width:e.config.widthPercent,height:e.config.height}))),()=>{Wt()},{deep:!0}),d(Y,()=>{Wt()},{deep:!0});async function Rt(){if(gt.value)try{let e=j.params.project,t=j.params.id,n=await fetch(`/api/projects/${e}/runs/${t}/status`);if(!n.ok)return;let r=(await n.json()).metrics_count;if(mt.value>0&&r>mt.value){console.log(`[Poll] New data detected: ${mt.value} → ${r} metrics`);let n=await fetch(`/api/projects/${e}/runs/${t}/summary`);if(n.ok){let e=await n.json(),t=new Set(N.value);N.value=e.available_data.scalars,N.value.includes(`timestamp`)&&(N.value.push(`walltime`),N.value.push(`relative_walltime`));let r=N.value.filter(e=>!t.has(e));r.length>0&&(console.log(`[Poll] New metrics found:`,r),await zt(r)),await At(!0)}}mt.value=r}catch(e){console.error(`[Poll] Error checking for updates:`,e)}}async function zt(e){let t=new Set([`step`,`global_step`,`timestamp`,`walltime`,`relative_walltime`]),n=B.value,r=new Map;r.set(``,[]);for(let n of e){if(t.has(n)||rt.value.has(n))continue;let e=n.indexOf(`/`);if(e>0){let t=n.substring(0,e);r.has(t)||r.set(t,[]),r.get(t).push(n)}else r.get(``).push(n)}let i=R.value.find(e=>e.name===`Metrics`);if(i)for(let e of r.get(``))i.cards.push({id:`card-${n++}`,config:{type:`line`,title:e,widthPercent:33,height:400,xMetric:`step`,yMetrics:[e]}});for(let[e,t]of r.entries()){if(e===``)continue;let r=R.value.find(t=>t.name===e);r||(r={name:e,cards:[]},R.value.push(r),X(e),console.log(`[Poll] Created new tab: ${e}`));for(let e of t)r.cards.push({id:`card-${n++}`,config:{type:`line`,title:e,widthPercent:33,height:400,xMetric:`step`,yMetrics:[e]}})}B.value=n}function Bt(){ht.value||=(console.log(`[Poll] Starting polling (every 10s)`),setInterval(Rt,1e4))}function Vt(){ht.value&&=(console.log(`[Poll] Stopping polling`),clearInterval(ht.value),null)}function Ht(){let e={};for(let[t,n]of Object.entries(Y))e[t]={...n};return e}function $(e={}){let{force:t=!1}=e;if(!t&&!at.value)return;let n={schemaVersion:Fe,tabs:R.value,activeTab:z.value,nextCardId:B.value,tabSettings:Ht(),removedMetrics:Array.from(rt.value),removedTables:Array.from(G.value),removedHistograms:Array.from(K.value),removedMedia:Array.from(it.value)};localStorage.setItem(bt.value,JSON.stringify(n))}let Ut=null;function Wt(){nt.value||(Q(),Ut&&clearTimeout(Ut),Ut=setTimeout(()=>{$(),Ut=null},250))}function Gt(){tt.value=!0,U.value=`line`,W.value=[]}let Kt=C(()=>{if(!P.value)return[];if(U.value===`line`){let e=new Set([`step`,`global_step`,`timestamp`,`walltime`,`relative_walltime`]);return N.value.filter(t=>!e.has(t))}else if(U.value===`media`)return P.value.available_data?.media||[];else if(U.value===`table`)return P.value.available_data?.tables||[];else if(U.value===`histogram`)return P.value.available_data?.histograms||[];else if(U.value===`histogram_surface`)return P.value.available_data?.histograms||[];return[]});function qt(){let e=R.value.find(e=>e.name===z.value);if(!e)return;if(U.value===`line`){if(!Array.isArray(W.value)||W.value.length===0){E.warning(`Please select at least one metric`);return}}else if(!W.value){E.warning(`Please select a ${U.value}`);return}let t;t=U.value===`line`?W.value.join(`, `):W.value||`New ${U.value}`;let n={title:t,widthPercent:33,height:400},r;U.value===`line`?r={...n,type:`line`,xMetric:`global_step`,yMetrics:W.value}:U.value===`media`?r={...n,type:`media`,mediaName:W.value,currentStep:0}:U.value===`table`?r={...n,type:`table`,tableName:W.value,currentStep:0}:U.value===`histogram`?r={...n,type:`histogram`,histogramName:W.value,currentStep:0}:U.value===`histogram_surface`&&(r={...n,type:`histogram`,histogramName:W.value,histogramMode:`flow`,histogramFlowSurface:!0,surfaceAxis:`global_step`,surfaceNormalize:`none`,surfaceAspect:{x:1.2,y:1,z:.85},downsampleRate:-1});let i={id:`card-${B.value++}`,config:r};e.cards.push(i),Q(),$(),tt.value=!1,W.value=[],U.value===`line`&&At(!1)}function Jt(){if(confirm(`Reset to default layout? This will remove all customizations.`)){rt.value.clear(),G.value.clear(),K.value.clear(),it.value.clear();for(let e of Object.keys(Y))delete Y[e];X(A),localStorage.removeItem(bt.value),location.reload()}}function Yt(){$e.value=!0,H.value=``}function Xt(){if(H.value.trim()){let e=H.value.trim();R.value.push({name:e,cards:[]}),X(e),Q(),$(),$e.value=!1,H.value=``}}function Zt(e){if(R.value.length<=1){E.warning(`Cannot remove the last tab`);return}R.value=R.value.filter(t=>t.name!==e),z.value===e&&(z.value=R.value[0].name),delete Y[e],X(z.value),Q(),$()}function Qt(e){let t=[],n=[],r=0;for(let i=0;i<e.length;i++){let a=e[i].config.widthPercent||100;r>0&&r+a>102&&(t.push([...n]),n=[],r=0),n.push(i),r+=a}return n.length>0&&t.push(n),t}function $t({id:e,config:t,syncAll:n,realtime:r}){if(!t)return;let i=R.value.find(e=>e.name===z.value);if(!i)return;let a=i.cards.findIndex(t=>t.id===e);if(a===-1)return;let o=i.cards[a].config,s=o.height!==t.height,c=o.widthPercent!==t.widthPercent;if(n){if(r&&V.value)return;if(!r){if(V.value)return;V.value=!0}try{for(let e=0;e<i.cards.length;e++){let n={};s&&(n.height=t.height),c&&(n.widthPercent=t.widthPercent),Object.keys(n).length>0&&(i.cards[e].config={...i.cards[e].config,...n})}}finally{r||(Q(),$(),S(()=>{V.value=!1}))}return}if(i.cards[a].config=t,!V.value){V.value=!0;try{if(s&&!c){let e=Qt(i.cards).find(e=>e.includes(a));if(e&&e.length>1)for(let n of e)n!==a&&(i.cards[n].config={...i.cards[n].config,height:t.height})}else if(c){let e=Qt(i.cards);for(let t of e)if(t.length>1){let e=t.includes(a),n=null,r=t.filter(e=>e!==a);if(r.length>0?n=i.cards[r[0]].config.height:e&&(n=i.cards[a].config.height),n!==null)for(let e of t)i.cards[e].config.height!==n&&(console.log(`[Card ${e}] Width change caused row wrap, syncing to row height: ${n}px`),i.cards[e].config={...i.cards[e].config,height:n})}}}finally{Q(),$(),S(()=>{V.value=!1})}}}function en(e){let t=R.value.find(e=>e.name===z.value);if(t){let n=t.cards.find(t=>t.id===e);n?.config?.yMetrics?n.config.yMetrics.forEach(e=>{rt.value.add(e),console.log(`[removeCard] Marked ${e} as removed`)}):n?.config?.type===`table`&&n.config.tableName?(G.value.add(n.config.tableName),console.log(`[removeCard] Marked table ${n.config.tableName} as removed`)):n?.config?.histogramName&&(n.config.type===`histogram`||n.config.type===`histogram_surface`)?(K.value.add(n.config.histogramName),console.log(`[removeCard] Marked histogram ${n.config.histogramName} as removed`)):n?.config?.type===`media`&&n.config.mediaName&&(it.value.add(n.config.mediaName),console.log(`[removeCard] Marked media ${n.config.mediaName} as removed`)),t.cards=t.cards.filter(t=>t.id!==e),Q(),$()}}let tn=C(()=>{let e=R.value.find(e=>e.name===z.value);if(!e)return!1;let t=Z.value;return e.cards.some(e=>e.config.type===`line`?e.config.xMetric!==t.xAxis||e.config.smoothingMode!==void 0&&e.config.smoothingMode!==t.smoothing:e.config.type===`histogram`?e.config.histogramMode!==void 0&&e.config.histogramMode!==t.histogramMode:!1)});function nn(){let e=R.value.findIndex(e=>e.name===z.value);if(e===-1)return;let t=Z.value,n=R.value[e].cards.map(e=>{let n={...e.config};return e.config.type===`line`?(n.xMetric=t.xAxis,n.smoothingMode=t.smoothing,n.smoothingValue=t.smoothingValue,n.downsampleRate=t.downsampleRate):e.config.type===`histogram`&&(n.histogramMode=t.histogramMode),{...e,config:n}});R.value=[...R.value.slice(0,e),{...R.value[e],cards:n},...R.value.slice(e+1)],S(()=>{Q(),$(),et.value=!1,E.success(`Applied global settings to all cards`)})}function rn(e){console.log(`[DragEnd] Syncing heights after drag`,e);let t=R.value.find(e=>e.name===z.value);if(!t)return;let n=e.newIndex,r=e.oldIndex;if(n===void 0||r===void 0){Q(),$();return}let i=Qt(t.cards);for(let e of i)if(e.length>1){let r={};for(let n of e){let e=t.cards[n].config.height;r[e]=(r[e]||0)+1}let i=null,a=0;for(let[e,t]of Object.entries(r))t>a&&(a=t,i=parseInt(e));if(i!==null){for(let r of e)if(t.cards[r].config.height!==i){let e=r===n?`(dragged)`:`(in-row)`;console.log(`[DragEnd] Card ${r} ${e} syncing to dominant row height: ${i}px`),t.cards[r].config={...t.cards[r].config,height:i}}}}Q(),$()}return(s,u)=>{let d=ie,oe=r,p=ue,se=a,ce=e,le=o,y=c,S=ee,C=re,pe=ae,E=n,me=i,A=ne,Ne=t;return f(),O(`div`,ge,[x(`div`,_e,[x(`div`,ve,[v(I)?(f(),O(`div`,ye,[h(d,{ref_key:`nameInputRef`,ref:Je,modelValue:v(Ke),"onUpdate:modelValue":u[0]||=e=>g(Ke)?Ke.value=e:null,size:`large`,placeholder:`Run name`,disabled:v(Xe),onKeyup:he(ut,[`enter`]),onKeydown:he(lt,[`esc`]),onBlur:ut},null,8,[`modelValue`,`disabled`])])):(f(),O(`div`,{key:1,class:`text-2xl font-bold text-gray-900 dark:text-gray-100 cursor-pointer select-text`,title:`Double-click to rename run`,onDblclick:ct},D(v(He)),33)),v(L)?(f(),O(`div`,be,[h(d,{ref_key:`annotationInputRef`,ref:Ye,modelValue:v(qe),"onUpdate:modelValue":u[1]||=e=>g(qe)?qe.value=e:null,size:`small`,placeholder:`Annotation`,disabled:v(Ze),onKeyup:he(pt,[`enter`]),onKeydown:he(ft,[`esc`]),onBlur:pt},null,8,[`modelValue`,`disabled`]),u[27]||=x(`span`,{class:`text-xs text-gray-500`},`Used as folder name on disk`,-1)])):(f(),O(`div`,{key:3,class:fe([`text-sm text-gray-500 dark:text-gray-400 flex items-center gap-2`,{"cursor-pointer":v(Ge)}]),title:`Double-click to rename annotation`,onDblclick:dt},[x(`span`,xe,D(v(We)),1),v(Ge)?_(``,!0):(f(),b(oe,{key:0,type:`info`,size:`small`},{default:T(()=>[...u[28]||=[k(` Finish run to rename `,-1)]]),_:1}))],34))]),x(`div`,Se,[h(p,{type:`primary`,size:`small`,onClick:Gt},{default:T(()=>[u[29]||=x(`i`,{class:`i-ep-plus mr-1`},null,-1),v(J)?(f(),O(`span`,we,`Add`)):(f(),O(`span`,Ce,`Add Chart`))]),_:1}),h(p,{size:`small`,onClick:Yt},{default:T(()=>[v(J)?(f(),O(`span`,Ee,`Tab`)):(f(),O(`span`,Te,`Add Tab`))]),_:1}),h(p,{size:`small`,onClick:u[2]||=e=>Qe.value=!v(Qe)},{default:T(()=>[k(D(v(Qe)?`Done`:`Edit`),1)]),_:1}),h(p,{size:`small`,onClick:Jt,type:`danger`,plain:``},{default:T(()=>[u[30]||=x(`i`,{class:`i-ep-refresh-left mr-1`},null,-1),v(J)?(f(),O(`span`,Oe,`Reset`)):(f(),O(`span`,De,`Reset Layout`))]),_:1})])]),h(ce,{modelValue:v(z),"onUpdate:modelValue":u[4]||=e=>g(z)?z.value=e:null,type:`card`},{default:T(()=>[(f(!0),O(w,null,m(v(R),e=>(f(),b(se,{key:e.name,label:e.name,name:e.name},{label:T(()=>[x(`div`,ke,[x(`span`,null,D(e.name),1),e.name===v(z)&&!v(Qe)?(f(),b(p,{key:0,size:`small`,circle:``,onClick:de(v(ze),[`stop`]),title:v(Re)?`Disable Hover Sync`:`Enable Hover Sync`,type:v(Re)?`primary`:`default`},{default:T(()=>[x(`i`,{class:fe((v(Re),`i-ep-connection`))},null,2)]),_:1},8,[`onClick`,`title`,`type`])):_(``,!0),e.name===v(z)&&!v(Qe)?(f(),b(p,{key:1,size:`small`,circle:``,onClick:u[3]||=de(e=>et.value=!0,[`stop`]),title:`Global Tab Settings`},{default:T(()=>[...u[31]||=[x(`i`,{class:`i-ep-setting`},null,-1)]]),_:1})):_(``,!0),v(Qe)&&v(R).length>1?(f(),b(p,{key:2,icon:`Close`,size:`small`,text:``,type:`danger`,onClick:de(t=>Zt(e.name),[`stop`])},null,8,[`onClick`])):_(``,!0)])]),_:2},1032,[`label`,`name`]))),128))]),_:1},8,[`modelValue`]),v(It)>1?(f(),O(`div`,Ae,[h(p,{size:`small`,disabled:v(q)===0,onClick:u[5]||=e=>q.value--,icon:`ArrowLeft`},{default:T(()=>[...u[32]||=[k(` Previous `,-1)]]),_:1},8,[`disabled`]),x(`span`,je,[k(` Page `+D(v(q)+1)+` / `+D(v(It))+` `,1),x(`span`,Me,` (`+D(v(Lt).length)+` charts, max `+D(v(Nt))+` WebGL per page) `,1)]),h(p,{size:`small`,disabled:v(q)>=v(It)-1,onClick:u[6]||=e=>q.value++,icon:`ArrowRight`},{default:T(()=>[...u[33]||=[k(` Next `,-1)]]),_:1},8,[`disabled`])])):_(``,!0),h(v(l),{modelValue:v(Mt),"onUpdate:modelValue":u[7]||=e=>g(Mt)?Mt.value=e:null,animation:v(Le)?200:0,handle:`.card-drag-handle`,class:`flex flex-wrap gap-4`,onEnd:rn},{default:T(()=>[(f(!0),O(w,null,m(v(Lt),e=>(f(),b(te,{key:e.id,"card-id":e.id,"experiment-id":v(j).params.id,project:v(j).params.project,"sparse-data":v(jt),"available-metrics":v(N),"available-histograms":v(P)?.available_data?.histograms||[],"initial-config":e.config,"forced-height":v(J)?v(Pt):null,"tab-name":v(z),"hover-sync-enabled":v(Re),"onUpdate:config":$t,onRemove:t=>en(e.id)},null,8,[`card-id`,`experiment-id`,`project`,`sparse-data`,`available-metrics`,`available-histograms`,`initial-config`,`forced-height`,`tab-name`,`hover-sync-enabled`,`onRemove`]))),128))]),_:1},8,[`modelValue`,`animation`]),v(Mt).length===0?(f(),b(le,{key:1,description:`No charts in this tab`},{default:T(()=>[h(p,{type:`primary`,onClick:Gt},{default:T(()=>[...u[34]||=[k(`Add Chart`,-1)]]),_:1})]),_:1})):_(``,!0),h(E,{modelValue:v(tt),"onUpdate:modelValue":u[16]||=e=>g(tt)?tt.value=e:null,title:`Add Chart`,width:`500px`},{footer:T(()=>[h(p,{onClick:u[15]||=e=>tt.value=!1},{default:T(()=>[...u[35]||=[k(`Cancel`,-1)]]),_:1}),h(p,{type:`primary`,onClick:qt},{default:T(()=>[...u[36]||=[k(`Add`,-1)]]),_:1})]),default:T(()=>[h(pe,{"label-width":`120px`},{default:T(()=>[h(C,{label:`Chart Type`},{default:T(()=>[h(S,{modelValue:v(U),"onUpdate:modelValue":u[8]||=e=>g(U)?U.value=e:null,class:`w-full`,onChange:u[9]||=e=>W.value=v(U)===`line`?[]:``},{default:T(()=>[h(y,{label:`Line Chart`,value:`line`}),h(y,{label:`Media Viewer`,value:`media`}),h(y,{label:`Table Viewer`,value:`table`}),h(y,{label:`Histogram`,value:`histogram`}),h(y,{label:`3D Histogram Surface`,value:`histogram_surface`})]),_:1},8,[`modelValue`])]),_:1}),v(U)===`line`?(f(),b(C,{key:0,label:`Select Metrics`},{default:T(()=>[h(S,{modelValue:v(W),"onUpdate:modelValue":u[10]||=e=>g(W)?W.value=e:null,class:`w-full`,placeholder:`Choose one or more metrics`,multiple:``,filterable:``,"collapse-tags":``,"collapse-tags-tooltip":``},{default:T(()=>[(f(!0),O(w,null,m(v(Kt),e=>(f(),b(y,{key:e,label:e,value:e},null,8,[`label`,`value`]))),128))]),_:1},8,[`modelValue`])]),_:1})):_(``,!0),v(U)===`media`?(f(),b(C,{key:1,label:`Select Media`},{default:T(()=>[h(S,{modelValue:v(W),"onUpdate:modelValue":u[11]||=e=>g(W)?W.value=e:null,class:`w-full`,placeholder:`Choose a media item`,filterable:``},{default:T(()=>[(f(!0),O(w,null,m(v(Kt),e=>(f(),b(y,{key:e,label:e,value:e},null,8,[`label`,`value`]))),128))]),_:1},8,[`modelValue`])]),_:1})):_(``,!0),v(U)===`table`?(f(),b(C,{key:2,label:`Select Table`},{default:T(()=>[h(S,{modelValue:v(W),"onUpdate:modelValue":u[12]||=e=>g(W)?W.value=e:null,class:`w-full`,placeholder:`Choose a table`,filterable:``},{default:T(()=>[(f(!0),O(w,null,m(v(Kt),e=>(f(),b(y,{key:e,label:e,value:e},null,8,[`label`,`value`]))),128))]),_:1},8,[`modelValue`])]),_:1})):_(``,!0),v(U)===`histogram`?(f(),b(C,{key:3,label:`Select Histogram`},{default:T(()=>[h(S,{modelValue:v(W),"onUpdate:modelValue":u[13]||=e=>g(W)?W.value=e:null,class:`w-full`,placeholder:`Choose a histogram`,filterable:``},{default:T(()=>[(f(!0),O(w,null,m(v(Kt),e=>(f(),b(y,{key:e,label:e,value:e},null,8,[`label`,`value`]))),128))]),_:1},8,[`modelValue`])]),_:1})):_(``,!0),v(U)===`histogram_surface`?(f(),b(C,{key:4,label:`Select Histogram`},{default:T(()=>[h(S,{modelValue:v(W),"onUpdate:modelValue":u[14]||=e=>g(W)?W.value=e:null,class:`w-full`,placeholder:`Choose a histogram`,filterable:``},{default:T(()=>[(f(!0),O(w,null,m(v(Kt),e=>(f(),b(y,{key:e,label:e,value:e},null,8,[`label`,`value`]))),128))]),_:1},8,[`modelValue`])]),_:1})):_(``,!0)]),_:1})]),_:1},8,[`modelValue`]),h(E,{modelValue:v($e),"onUpdate:modelValue":u[19]||=e=>g($e)?$e.value=e:null,title:`Add Tab`,width:`400px`},{footer:T(()=>[h(p,{onClick:u[18]||=e=>$e.value=!1},{default:T(()=>[...u[37]||=[k(`Cancel`,-1)]]),_:1}),h(p,{type:`primary`,onClick:Xt},{default:T(()=>[...u[38]||=[k(`Add`,-1)]]),_:1})]),default:T(()=>[h(pe,{onSubmit:de(Xt,[`prevent`])},{default:T(()=>[h(C,{label:`Tab Name`},{default:T(()=>[h(d,{modelValue:v(H),"onUpdate:modelValue":u[17]||=e=>g(H)?H.value=e:null,placeholder:`Enter tab name`,onKeyup:he(Xt,[`enter`]),autofocus:``},null,8,[`modelValue`])]),_:1})]),_:1})]),_:1},8,[`modelValue`]),h(E,{modelValue:v(et),"onUpdate:modelValue":u[26]||=e=>g(et)?et.value=e:null,title:`Global Tab Settings`,width:`600px`},{footer:T(()=>[h(p,{onClick:u[25]||=e=>et.value=!1},{default:T(()=>[...u[44]||=[k(`Cancel`,-1)]]),_:1}),h(p,{type:`primary`,onClick:nn},{default:T(()=>[...u[45]||=[k(` Apply to All Cards `,-1)]]),_:1})]),default:T(()=>[v(tn)?(f(),b(me,{key:0,type:`warning`,closable:!1,class:`mb-4`},{title:T(()=>[...u[39]||=[k(` Some cards have custom settings `,-1)]]),default:T(()=>[u[40]||=k(` Click "Apply to All Cards" below to reset all cards to these global settings `,-1)]),_:1})):_(``,!0),h(pe,{"label-width":`160px`},{default:T(()=>[h(A,{"content-position":`left`},{default:T(()=>[...u[41]||=[k(`Line Chart Settings`,-1)]]),_:1}),h(C,{label:`X-Axis`},{default:T(()=>[h(S,{modelValue:v(Z).xAxis,"onUpdate:modelValue":u[20]||=e=>v(Z).xAxis=e,class:`w-full`},{default:T(()=>[(f(!0),O(w,null,m(v(N),e=>(f(),b(y,{key:e,label:e,value:e},null,8,[`label`,`value`]))),128))]),_:1},8,[`modelValue`])]),_:1}),h(C,{label:`Smoothing`},{default:T(()=>[h(S,{modelValue:v(Z).smoothing,"onUpdate:modelValue":u[21]||=e=>v(Z).smoothing=e,class:`w-full`},{default:T(()=>[h(y,{label:`Disabled`,value:`disabled`}),h(y,{label:`EMA`,value:`ema`}),h(y,{label:`Moving Average`,value:`ma`}),h(y,{label:`Gaussian`,value:`gaussian`})]),_:1},8,[`modelValue`])]),_:1}),v(Z).smoothing===`disabled`?_(``,!0):(f(),b(C,{key:0,label:`Smoothing Value`},{default:T(()=>[h(Ne,{modelValue:v(Z).smoothingValue,"onUpdate:modelValue":u[22]||=e=>v(Z).smoothingValue=e,min:0,max:v(Z).smoothing===`ema`?1:1e3,step:v(Z).smoothing===`ema`?.01:1,class:`w-full`},null,8,[`modelValue`,`max`,`step`])]),_:1})),h(C,{label:`Downsample Rate`},{default:T(()=>[h(Ne,{modelValue:v(Z).downsampleRate,"onUpdate:modelValue":u[23]||=e=>v(Z).downsampleRate=e,min:-1,max:100,class:`w-full`},null,8,[`modelValue`]),u[42]||=x(`div`,{class:`text-xs text-gray-500 dark:text-gray-400 mt-1`},` -1 = Adaptive (recommended), 1 = No downsampling `,-1)]),_:1}),h(A,{"content-position":`left`},{default:T(()=>[...u[43]||=[k(`Histogram Settings`,-1)]]),_:1}),h(C,{label:`Histogram Mode`},{default:T(()=>[h(S,{modelValue:v(Z).histogramMode,"onUpdate:modelValue":u[24]||=e=>v(Z).histogramMode=e,class:`w-full`},{default:T(()=>[h(y,{label:`Single Step`,value:`single`}),h(y,{label:`Distribution Flow`,value:`flow`})]),_:1},8,[`modelValue`])]),_:1})]),_:1})]),_:1},8,[`modelValue`])])}}};export{Ie as default};