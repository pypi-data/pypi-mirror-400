from __future__ import annotations
import os, yaml
from dotenv import load_dotenv
from pydantic import BaseModel
from typing import Dict, List

load_dotenv()

class ProviderCfg(BaseModel):
    api_key_env: str
    model: str
    base_url: str

class AIConfig(BaseModel):
    default_provider: str
    fallback_providers: List[str] = []
    routing: Dict[str, List[str]] = {}
    providers: Dict[str, ProviderCfg]

class AppConfig(BaseModel):
    workspace_root: str = "workspaces"
    safe_mode_default: bool = True
    ai: AIConfig

def load_config(path: str = "config.yaml") -> AppConfig:
    if not os.path.exists(path):
        raise RuntimeError("Missing config.yaml")
    with open(path, "r", encoding="utf-8") as f:
        data = yaml.safe_load(f)
    return AppConfig(**data)

def get_api_key(env_name: str) -> str:
    v = os.getenv(env_name, "").strip()
    if not v:
        raise RuntimeError(f"Missing API key: {env_name} (check .env)")
    return v
