Metadata-Version: 2.3
Name: powermonitor
Version: 0.0.9
Summary: macOS power monitoring tool with auto-updating TUI
Author: narumi
Author-email: narumi <toucans-cutouts0f@icloud.com>
Requires-Dist: loguru>=0.7.3
Requires-Dist: peewee>=3.18.3
Requires-Dist: rich>=13.7.0
Requires-Dist: textual>=0.50.0
Requires-Dist: textual-plotext>=0.2.0
Requires-Dist: typer>=0.21.0
Requires-Python: >=3.13
Description-Content-Type: text/markdown

# Power Monitor

macOS power monitoring tool with auto-updating TUI for real-time battery and charging status.

## Quick Start

```bash
uvx powermonitor
```

## Features

- ğŸ–¥ï¸ **Auto-updating TUI** with 3-panel layout (Textual framework)
- âš¡ **Real-time monitoring** - Updates every 2 seconds automatically
- ğŸ“Š **Live power metrics** - Voltage, amperage, wattage, battery %
- ğŸ“ˆ **Historical visualization** - Power chart and statistics
- ğŸ”‹ **Battery tracking** - Capacity, charging status, charger info
- ğŸ’¾ **SQLite persistence** - Automatic background data logging with proper resource management
- ğŸ¯ **IOKit/SMC access** - Direct macOS API integration via ctypes
- ğŸ”„ **Auto-fallback** - Graceful fallback to subprocess-based collection
- âš™ï¸ **Configuration file** - Optional TOML config with CLI override support
- ğŸ“¤ **Data export** - Export to CSV/JSON formats
- ğŸ§¹ **Data cleanup** - Remove old readings by age or clear all
- ğŸ¥ **Battery health** - Track battery degradation over time

## Installation

### Install with uv (recommended)

```bash
uv tool install powermonitor
```

### Install with pipx

```bash
pipx install powermonitor
```

## Usage

### Launch the TUI

```bash
# Launch auto-updating TUI with default settings
powermonitor

# Customize TUI settings
powermonitor --interval 1.0 --stats-limit 100 --chart-limit 60

# Enable debug logging
powermonitor --debug
```

**TUI Options:**
- `--interval` / `-i` - Data collection interval in seconds (default: 1.0)
- `--stats-limit` - Number of readings for statistics (default: 100)
- `--chart-limit` - Number of readings in chart (default: 60)
- `--debug` - Enable debug logging

The TUI displays:

```
â”Œâ”€ powermonitor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Real-Time Power                           â”‚
â”‚ âš¡ 45.2W / 67W    ğŸ”‹ 72%    âš¡ Charging   â”‚
â”‚ 20.0V Ã— 2.26A                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Statistics (Last 100 readings)            â”‚
â”‚ Avg: 42.3W  Max: 55.1W  Min: 12.4W       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Power Chart (Last 60 readings)            â”‚
â”‚     55W â”¤      â•­â”€â”€â•®                       â”‚
â”‚     45W â”¤  â•­â”€â”€â”€â•¯  â•°â”€â”€â•®                    â”‚
â”‚     35W â”¤â”€â”€â•¯         â•°â”€                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”‚
â”‚ [q] Quit  [r] Refresh  [c] Clear History â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Keyboard Controls:**
- `q` or `ESC` - Quit application
- `r` - Force refresh data
- `c` - Clear history (with confirmation)

### Configuration File

powermonitor supports an optional configuration file at `~/.powermonitor/config.toml`:

```toml
# powermonitor configuration file

[tui]
interval = 1.0           # Data collection interval in seconds
stats_limit = 100        # Number of readings for statistics
chart_limit = 60         # Number of readings to display in chart

[database]
path = "~/.powermonitor/powermonitor.db"  # Database file location

[cli]
default_history_limit = 20           # Default limit for history command
default_export_limit = 1000          # Default limit for export command

[logging]
level = "INFO"           # Logging level: DEBUG, INFO, WARNING, ERROR
```

**Configuration Priority**: CLI arguments > Config file > Defaults

If no config file exists, powermonitor uses sensible defaults. CLI arguments always override config file values.

**Example**: Set custom database path and collection interval:

```toml
[database]
path = "~/Documents/power-data.db"

[tui]
interval = 2.0
```

Then run: `powermonitor` (uses config) or `powermonitor --interval 0.5` (overrides config)

### CLI Commands

#### Export Data

Export power readings to CSV or JSON format:

```bash
# Export to CSV (auto-detected from extension)
powermonitor export data.csv

# Export to JSON
powermonitor export data.json

# Export last 1000 readings
powermonitor export data.csv --limit 1000

# Manually specify format
powermonitor export backup.txt --format csv
```

#### Database Statistics

Show database information and statistics:

```bash
powermonitor stats
```

Output:
```
Database Statistics
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Total readings       12,450
Earliest reading     2025-12-01 10:30:00
Latest reading       2026-01-06 15:22:00
Database size        2.4 MB
Database path        /Users/you/.powermonitor/powermonitor.db
```

#### View History

Display recent power readings in a formatted table:

```bash
# Show last 20 readings (default)
powermonitor history

# Show last 50 readings
powermonitor history --limit 50
```

Output shows time, power, battery %, voltage, current, and status.

#### Clean Up Data

Remove old readings to manage database size:

```bash
# Delete readings older than 30 days
powermonitor cleanup --days 30

# Delete all readings (requires confirmation)
powermonitor cleanup --all
```

#### Battery Health

Track battery degradation over time:

```bash
# Analyze last 30 days (default)
powermonitor health

# Analyze last 60 days
powermonitor health --days 60
```

Output:
```
Battery Health Analysis (30 days)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
First reading        2025-12-06
First avg capacity   4,709 mAh
Last reading         2026-01-06
Last avg capacity    4,650 mAh
Change               -59 mAh (-1.25%)
Status               âš ï¸  Degrading (normal wear)
Days analyzed        30
```

### Development Mode

```bash
# Run with verbose collector info
uv run python -c "from powermonitor.collector import default_collector; collector = default_collector(verbose=True); print(collector.collect())"

# Test data collection
uv run python -c "from powermonitor.collector import default_collector; print(default_collector().collect())"
```

## Requirements

- **macOS**: 12.0+ (Monterey or later)
- **Python**: 3.13+ (uses modern type hints)
- **Dependencies**: textual, rich, textual-plotext (auto-installed by uv)

## Architecture

### TUI Layout (3 Panels)

1. **LiveDataPanel** (green) - Real-time power data
   - Status: âš¡ Charging / ğŸ”Œ AC Power / ğŸ”‹ On Battery
   - Power: watts_actual / watts_negotiated
   - Battery: percentage, capacity (mAh)
   - Electrical: voltage, amperage
   - Charger info (if available)

2. **StatsPanel** (cyan) - Historical statistics
   - Time range (earliest/latest)
   - Average/min/max power
   - Average battery percentage
   - Based on last 100 readings

3. **ChartWidget** (blue) - Power over time
   - Line chart with 60 data points
   - Shows actual power and max negotiated power
   - Auto-scales based on data

### Data Collection

powermonitor uses two collectors with automatic fallback:

1. **IOKitCollector** (preferred) - Direct IOKit/SMC API via ctypes
   - Reads 7 SMC sensors: PPBR, PDTR, PSTR, PHPC, PDBR, TB0T, CHCC
   - Most accurate power readings (PDTR sensor)
   - Zero overhead (no subprocess)

2. **IORegCollector** (fallback) - Subprocess-based
   - Executes `ioreg -rw0 -c AppleSmartBattery -a`
   - Parses plist output using Python's plistlib
   - Works on all Macs without special permissions

### Database

All readings automatically saved to SQLite with proper resource management:

**Default location**: `~/.powermonitor/powermonitor.db`

**Custom location** (via config file):
```toml
[database]
path = "/path/to/custom.db"
```

**Resource Management**:
- Automatic connection cleanup using context managers
- No ResourceWarnings or connection leaks
- Proper transaction handling for all write operations
- Safe shutdown and cleanup in TUI mode

**Schema**:
```sql
CREATE TABLE power_readings (
    id INTEGER PRIMARY KEY,
    timestamp TEXT,
    watts_actual REAL,
    watts_negotiated INTEGER,
    voltage REAL,
    amperage REAL,
    current_capacity INTEGER,
    max_capacity INTEGER,
    battery_percent INTEGER,
    is_charging INTEGER,
    external_connected INTEGER,
    charger_name TEXT,
    charger_manufacturer TEXT
);
```

## Project Structure

```
powermonitor/
â”œâ”€â”€ pyproject.toml              # uv project config
â”œâ”€â”€ uv.lock                     # Dependency lock file
â”œâ”€â”€ src/
â”‚   â””â”€â”€ powermonitor/
â”‚       â”œâ”€â”€ cli.py              # Entry point
â”‚       â”œâ”€â”€ models.py           # PowerReading dataclass
â”‚       â”œâ”€â”€ database.py         # SQLite operations
â”‚       â”œâ”€â”€ config.py           # PowerMonitorConfig dataclass
â”‚       â”œâ”€â”€ config_loader.py    # TOML config file loader
â”‚       â”œâ”€â”€ logger.py           # Logging configuration
â”‚       â”œâ”€â”€ collector/          # Data collection
â”‚       â”‚   â”œâ”€â”€ base.py         # PowerCollector protocol
â”‚       â”‚   â”œâ”€â”€ ioreg.py        # Subprocess collector
â”‚       â”‚   â”œâ”€â”€ factory.py      # Auto-fallback logic
â”‚       â”‚   â””â”€â”€ iokit/          # IOKit/SMC FFI
â”‚       â”‚       â”œâ”€â”€ bindings.py # ctypes bindings
â”‚       â”‚       â”œâ”€â”€ structures.py # SMC data structures
â”‚       â”‚       â”œâ”€â”€ parser.py   # Binary parsing
â”‚       â”‚       â”œâ”€â”€ connection.py # SMCConnection
â”‚       â”‚       â””â”€â”€ collector.py # IOKitCollector
â”‚       â””â”€â”€ tui/                # Textual TUI
â”‚           â”œâ”€â”€ app.py          # PowerMonitorApp
â”‚           â””â”€â”€ widgets.py      # Custom widgets
â””â”€â”€ tests/
    â””â”€â”€ fixtures/               # Test data
```

## Development

### Code Quality

```bash
# Type checking
uv run ty check .

# Linting
uv run ruff check src/

# Auto-formatting
uv run ruff format src/

# Run all checks
uv run ty check . && uv run ruff check src/ && uv run ruff format src/
```

### Testing

```bash
# Run tests (when available)
uv run pytest

# Manual testing
uv run powermonitor
```

## Performance

- **Memory**: <50MB RAM
- **CPU**: <1% when idle
- **Update interval**: 2 seconds (configurable)
- **Database**: Indexed for fast queries

## Recent Improvements

- âœ… **Resource Management**: Proper SQLite connection cleanup eliminates ResourceWarnings
- âœ… **Configuration System**: TOML-based config with 3-layer priority (CLI > Config > Defaults)
- âœ… **CLI Commands**: Export, stats, history, cleanup, and battery health tracking
- âœ… **Code Quality**: Clean test infrastructure with proper fixture cleanup
- âœ… **Database Operations**: Context manager pattern for all database operations

## Migration Notes

- **To**: Python TUI with unified auto-updating interface
- **Reason**: Better rapid development, easier maintenance, similar performance for 2s intervals
- **Preserved**: All data collection logic, database schema, SMC sensor access (via ctypes)
- **Breaking Change**: `POWERMONITOR_DB_PATH` environment variable removed (use config.toml instead)

## License

MIT
