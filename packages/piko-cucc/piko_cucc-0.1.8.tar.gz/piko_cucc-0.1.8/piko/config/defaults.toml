[default]
# ============================================================================
# General - 通用配置
# ============================================================================
version = "0.0.0-dev"

# ============================================================================
# Startup Strategy - 启动策略
# ============================================================================
# startup_mode 控制服务启动时的容错行为：
#   - "fail_closed": 严格模式，任何配置或依赖检查失败都立即终止启动（生产推荐）
#   - "fail_open_snapshot": 宽容模式，允许使用快照数据降级启动（仅用于开发/测试）
startup_mode = "fail_closed"

# debug 模式会启用更详细的日志和调试端点，生产环境必须设为 false
debug = false

# ============================================================================
# Database - 数据库连接配置 (Piko 2.0 核心)
# ============================================================================
# [注意] 库内部默认留空，配合 init_db 的检查逻辑。
# 这样用户如果没配置环境变量，启动时会看到友好的 FATAL ERROR 提示
#
# ⚠️ 必须使用异步驱动！
# 推荐使用 mysql+asyncmy (速度最快) 或 mysql+aiomysql (兼容性好)
# ❌ 不要使用 pymysql (这是同步驱动，会阻塞 Event Loop)
#
# 格式示例:
#   "mysql+asyncmy://user:pass@host:port/dbname?charset=utf8mb4"
mysql_dsn = ""

# mysql_pool_size: 连接池初始大小，影响并发能力
# 设为 10-20 是基于典型中小型服务的经验值
mysql_pool_size = 20

# mysql_max_overflow: 连接池最大溢出连接数
# 允许在高峰期临时创建额外连接，避免请求阻塞
mysql_max_overflow = 10

# mysql_pool_recycle_s: 连接回收时间（秒）
# 强制每 3600 秒回收一次连接，防止连接存在太久被防火墙/MySQL服务端切断
# 这配合代码中的 pool_pre_ping=True 共同解决了 "Lost connection" 问题
mysql_pool_recycle_s = 3600

# ============================================================================
# Scheduler Tuning - 调度器调优参数
# ============================================================================
# poll_interval_s: 主轮询间隔（秒），这是"默认"间隔。
# 系统启动后，ConfigWatcher 会优先读取数据库中的 piko_system_settings 配置。
# 如果数据库没配置，才使用此值。
poll_interval_s = 10

# poll_jitter_s: 轮询抖动时间（秒）
# 随机化轮询时刻，避免多实例在同一时刻同时轮询造成数据库压力峰值
poll_jitter_s = 2

# debounce_s: 防抖窗口（秒）
# 在此时间窗口内重复触发的相同任务会被合并，减少无效调度
debounce_s = 2

# timezone: 时区设置
# 影响 cron 表达式的解析和任务触发时间计算，必须与业务时区一致
timezone = "Asia/Shanghai"

# ap_misfire_grace_s_default: APScheduler misfire 容忍时间（秒）
# 任务错过预定时间后，在此时间窗口内仍会执行；超出则跳过
# 300 秒（5分钟）是平衡及时性与系统压力的经验值
ap_misfire_grace_s_default = 300

# ap_max_instances_default: APScheduler 单任务最大并发实例数
# 设为 1 防止同一任务的多个实例并发执行，避免数据竞争
ap_max_instances_default = 1

# ============================================================================
# Leader Election - 分布式Leader选举
# ============================================================================
# leader_enabled: 是否启用Leader选举
# 多实例部署时必须启用，确保只有一个实例执行调度逻辑
leader_enabled = true

# leader_name: Leader名称/组名
# 同一组内的实例会竞争同一个Leader锁，不同组互不干扰
leader_name = "default"

# leader_lease_s: Leader租约时长（秒）
# Leader必须在此时间内续租，否则被视为失效，其他实例可接管
leader_lease_s = 30

# leader_renew_interval_s: 续租间隔（秒）
# Leader多久续租一次，必须小于 lease 时长且留有余量（当前为 1/3）
# 这样即使某次续租失败，仍有时间在租约到期前重试
leader_renew_interval_s = 10

# ============================================================================
# Concurrency & Compute - 并发与计算资源
# ============================================================================
# cpu_workers: CPU 密集型任务的工作线程数
# 0 表示自动检测（通常为 CPU 核心数），可根据任务特性手动调整
cpu_workers = 0

# per_job_cpu_max: 单任务最大 CPU 并发数
# 限制单个任务可使用的最大线程数，防止某个任务耗尽所有资源
per_job_cpu_max = 8

# ============================================================================
# Persistence - 持久化与缓冲配置
# ============================================================================
# persist_queue_max: 持久化队列最大长度
# 控制内存中待持久化对象的最大数量，防止内存溢出
persist_queue_max = 200

# persist_flush_timeout_s: 强制刷盘超时（秒）
# 即使队列未满，也会在此时间后强制写入，平衡数据丢失风险与 I/O 效率
persist_flush_timeout_s = 60

# persist_disk_fallback_path: 磁盘降级备份路径
# 当主存储（如数据库）不可用时，临时写入本地文件，防止数据丢失
# 注意：此路径应在容器/主机重启后仍可访问（如挂载卷）
persist_disk_fallback_path = "/tmp/piko_fallback.bin"

# ============================================================================
# Observability & Logging - 可观测性与日志
# ============================================================================
# metrics_enabled: 是否启用 Prometheus 等指标采集
# 生产环境强烈建议启用，用于监控调度器健康状况
metrics_enabled = true

# health_port: 健康检查和指标暴露端口
# K8s/Docker 可通过此端口进行 liveness/readiness probe
health_port = 8080

# log_level: 日志级别
# 可选: DEBUG, INFO, WARNING, ERROR, CRITICAL
# 生产环境建议 INFO，排查问题时临时调为 DEBUG
log_level = "INFO"

# log_json: 日志格式开关
#   - true: 生产模式，输出结构化 JSON 日志，便于日志聚合平台解析
#   - false: 开发模式，输出彩色文本日志，提升本地调试体验
log_json = false
