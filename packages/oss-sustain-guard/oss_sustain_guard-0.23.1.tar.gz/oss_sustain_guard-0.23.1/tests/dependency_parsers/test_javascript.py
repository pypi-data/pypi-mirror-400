"""
Test JavaScript lockfile parsers (package-lock.json, yarn.lock, pnpm-lock.yaml).
"""

import json
import tempfile
from pathlib import Path

from oss_sustain_guard.dependency_graph import (
    get_package_dependencies,
    parse_javascript_lockfile,
)


def test_parse_npm_lock():
    """Test parsing a package-lock.json file."""
    npm_lock_content = {
        "name": "test-npm-project",
        "version": "1.0.0",
        "lockfileVersion": 3,
        "packages": {
            "": {
                "name": "test-npm-project",
                "version": "1.0.0",
            },
            "node_modules/lodash": {
                "version": "4.17.21",
            },
            "node_modules/axios": {
                "version": "1.4.0",
            },
            "node_modules/axios/node_modules/follow-redirects": {
                "version": "1.15.2",
            },
        },
    }

    with tempfile.TemporaryDirectory() as tmpdir:
        lockfile_path = Path(tmpdir) / "package-lock.json"
        lockfile_path.write_text(json.dumps(npm_lock_content))

        package_json_path = Path(tmpdir) / "package.json"
        package_json_path.write_text(json.dumps({"name": "test-npm-project"}))

        result = parse_javascript_lockfile(lockfile_path)

        assert result is not None
        assert result.ecosystem == "javascript"
        assert result.root_package == "test-npm-project"
        assert len(result.direct_dependencies) == 2
        assert len(result.transitive_dependencies) == 1


def test_parse_yarn_lock():
    """Test parsing a yarn.lock file."""
    yarn_lock_content = """
# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
# yarn lockfile v1

lodash@^4.17.21:
  version "4.17.21"
  resolved "https://registry.yarnpkg.com/lodash/-/lodash-4.17.21.tgz"
"""

    with tempfile.TemporaryDirectory() as tmpdir:
        lockfile_path = Path(tmpdir) / "yarn.lock"
        lockfile_path.write_text(yarn_lock_content)

        package_json_path = Path(tmpdir) / "package.json"
        package_json_path.write_text(json.dumps({"name": "test-yarn-project"}))

        result = parse_javascript_lockfile(lockfile_path)

        assert result is not None
        assert result.ecosystem == "javascript"
        assert result.root_package == "test-yarn-project"


def test_parse_pnpm_lock():
    """Test parsing a pnpm-lock.yaml file."""
    pnpm_lock_content = """
lockfileVersion: '6.0'

dependencies:
  lodash:
    specifier: ^4.17.21
    version: 4.17.21
"""

    with tempfile.TemporaryDirectory() as tmpdir:
        lockfile_path = Path(tmpdir) / "pnpm-lock.yaml"
        lockfile_path.write_text(pnpm_lock_content)

        package_json_path = Path(tmpdir) / "package.json"
        package_json_path.write_text(json.dumps({"name": "test-pnpm-project"}))

        result = parse_javascript_lockfile(lockfile_path)

        assert result is not None
        assert result.ecosystem == "javascript"
        assert result.root_package == "test-pnpm-project"


def test_parse_nonexistent_javascript_lockfile():
    """Test parsing a non-existent JavaScript lockfile returns None."""
    result = parse_javascript_lockfile("/nonexistent/package-lock.json")
    assert result is None


def test_parse_unsupported_javascript_lockfile():
    """Test parsing an unsupported JavaScript lockfile returns None."""
    with tempfile.TemporaryDirectory() as tmpdir:
        lockfile_path = Path(tmpdir) / "unsupported.lock"
        lockfile_path.write_text("# unsupported format")

        result = parse_javascript_lockfile(lockfile_path)

        assert result is None


def test_parse_corrupted_javascript_lockfile():
    """Test parsing a corrupted JavaScript lockfile returns None."""
    with tempfile.TemporaryDirectory() as tmpdir:
        lockfile_path = Path(tmpdir) / "package-lock.json"
        lockfile_path.write_text("invalid json {[[")

        result = parse_javascript_lockfile(lockfile_path)

        assert result is None


def test_javascript_without_package_json():
    """Test parsing JavaScript lock without package.json."""
    npm_lock_content = {
        "lockfileVersion": 3,
        "packages": {
            "": {},
            "node_modules/lodash": {"version": "4.17.21"},
        },
    }

    with tempfile.TemporaryDirectory() as tmpdir:
        lockfile_path = Path(tmpdir) / "package-lock.json"
        lockfile_path.write_text(json.dumps(npm_lock_content))

        result = parse_javascript_lockfile(lockfile_path)

        assert result is not None
        assert result.root_package == "unknown"


def test_corrupted_package_json():
    """Test handling corrupted package.json gracefully."""
    npm_lock_content = {
        "lockfileVersion": 3,
        "packages": {
            "": {},
            "node_modules/lodash": {"version": "4.17.21"},
        },
    }

    with tempfile.TemporaryDirectory() as tmpdir:
        lockfile_path = Path(tmpdir) / "package-lock.json"
        lockfile_path.write_text(json.dumps(npm_lock_content))

        package_json_path = Path(tmpdir) / "package.json"
        package_json_path.write_text("invalid json {[[")

        result = parse_javascript_lockfile(lockfile_path)

        assert result is not None
        assert result.root_package == "unknown"


def test_get_package_dependencies_package_lock_json():
    """Test extracting dependencies for a specific package from package-lock.json."""
    package_lock_content = """{
  "name": "test-project",
  "version": "1.0.0",
  "lockfileVersion": 3,
  "packages": {
    "node_modules/react": {
      "name": "react",
      "version": "18.0.0",
      "dependencies": {
        "loose-envify": "^1.1.0"
      }
    },
    "node_modules/react-dom": {
      "name": "react-dom",
      "version": "18.0.0",
      "dependencies": {
        "loose-envify": "^1.1.0",
        "scheduler": "^0.23.0"
      }
    },
    "node_modules/@types/react": {
      "name": "@types/react",
      "version": "18.0.0",
      "dependencies": {
        "@types/prop-types": "*",
        "csstype": "^3.0.2"
      }
    }
  }
}"""

    with tempfile.TemporaryDirectory() as tmpdir:
        lockfile_path = Path(tmpdir) / "package-lock.json"
        lockfile_path.write_text(package_lock_content)

        # Test getting dependencies for react
        deps = get_package_dependencies(lockfile_path, "react")
        assert set(deps) == {"loose-envify"}

        # Test getting dependencies for react-dom
        deps = get_package_dependencies(lockfile_path, "react-dom")
        assert set(deps) == {"loose-envify", "scheduler"}

        # Test getting dependencies for scoped package
        deps = get_package_dependencies(lockfile_path, "@types/react")
        assert set(deps) == {"@types/prop-types", "csstype"}

        # Test package that doesn't exist
        deps = get_package_dependencies(lockfile_path, "nonexistent")
        assert deps == []


def test_get_package_dependencies_yarn_lock():
    """Test extracting dependencies for a package from yarn.lock."""
    yarn_lock_content = """
lodash@^4.17.21:
  version "4.17.21"
  dependencies:
    foo "^1.0.0"
"""

    with tempfile.TemporaryDirectory() as tmpdir:
        lockfile_path = Path(tmpdir) / "yarn.lock"
        lockfile_path.write_text(yarn_lock_content)

        deps = get_package_dependencies(lockfile_path, "lodash")
        assert deps == ["foo"]


def test_get_package_dependencies_pnpm_lock():
    """Test extracting dependencies for a package from pnpm-lock.yaml."""
    pnpm_lock_content = """
lockfileVersion: '6.0'
packages:
  /lodash/4.17.21:
    dependencies:
      foo: 1.0.0
"""

    with tempfile.TemporaryDirectory() as tmpdir:
        lockfile_path = Path(tmpdir) / "pnpm-lock.yaml"
        lockfile_path.write_text(pnpm_lock_content)

        deps = get_package_dependencies(lockfile_path, "lodash")
        assert deps == ["foo"]
