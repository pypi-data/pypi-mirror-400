#!/bin/bash
#
# Python-Node Interoperability Test Runner
#
# Tests communication between Python hub-client (local) and
# Node.js hub-client (remote) to verify cross-implementation compatibility.
#
# Usage:
#   ./scripts/python-node-test.sh setup     # Configure credentials
#   ./scripts/python-node-test.sh run       # Run test (Python initiator, Node responder)
#   ./scripts/python-node-test.sh run-rev   # Reverse (Node initiator, Python responder)
#   ./scripts/python-node-test.sh clean     # Clean up
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
ENV_FILE="$PROJECT_DIR/.env.interop-test"
REMOTE_LOG="/tmp/node-responder.log"
LOCAL_LOG="/tmp/python-initiator.log"

# Path to Node.js hub-client (relative to workspace root)
NODE_HUB_CLIENT="${NODE_HUB_CLIENT:-$(dirname "$(dirname "$PROJECT_DIR")")/../phystack-npm/packages/hub-client}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Load environment file
load_env() {
    if [[ ! -f "$ENV_FILE" ]]; then
        log_error "Environment file not found: $ENV_FILE"
        log_info "Run './scripts/python-node-test.sh setup' to create it"
        exit 1
    fi
    source "$ENV_FILE"

    # Validate required variables
    local missing=()
    [[ -z "$DEVICE_A_ID" ]] && missing+=("DEVICE_A_ID")
    [[ -z "$DEVICE_A_KEY" ]] && missing+=("DEVICE_A_KEY")
    [[ -z "$DEVICE_A_TWIN_ID" ]] && missing+=("DEVICE_A_TWIN_ID")
    [[ -z "$DEVICE_B_ID" ]] && missing+=("DEVICE_B_ID")
    [[ -z "$DEVICE_B_KEY" ]] && missing+=("DEVICE_B_KEY")
    [[ -z "$DEVICE_B_TWIN_ID" ]] && missing+=("DEVICE_B_TWIN_ID")

    if [[ ${#missing[@]} -gt 0 ]]; then
        log_error "Missing required variables: ${missing[*]}"
        exit 1
    fi

    # Set defaults
    PHYHUB_REGION="${PHYHUB_REGION:-eu}"

    # Resolve Node hub-client path
    NODE_HUB_CLIENT="${NODE_HUB_CLIENT:-$(dirname "$(dirname "$PROJECT_DIR")")/../phystack-npm/packages/hub-client}"
    if [[ ! -d "$NODE_HUB_CLIENT" ]]; then
        log_error "Node.js hub-client not found at: $NODE_HUB_CLIENT"
        log_info "Set NODE_HUB_CLIENT environment variable to the correct path"
        exit 1
    fi
}

# Setup wizard
cmd_setup() {
    log_info "Python-Node Interoperability Test Setup"
    echo ""

    # Load existing values if file exists
    if [[ -f "$ENV_FILE" ]]; then
        source "$ENV_FILE"
        log_info "Loading existing configuration from $ENV_FILE"
    fi

    echo "Enter credentials for Device A (Python side):"
    read -p "  Device A ID [${DEVICE_A_ID:-}]: " input
    DEVICE_A_ID="${input:-$DEVICE_A_ID}"

    read -p "  Device A Access Key [${DEVICE_A_KEY:+****}]: " input
    DEVICE_A_KEY="${input:-$DEVICE_A_KEY}"

    read -p "  Device A Twin ID [${DEVICE_A_TWIN_ID:-}]: " input
    DEVICE_A_TWIN_ID="${input:-$DEVICE_A_TWIN_ID}"

    echo ""
    echo "Enter credentials for Device B (Node.js side):"
    read -p "  Device B ID [${DEVICE_B_ID:-}]: " input
    DEVICE_B_ID="${input:-$DEVICE_B_ID}"

    read -p "  Device B Access Key [${DEVICE_B_KEY:+****}]: " input
    DEVICE_B_KEY="${input:-$DEVICE_B_KEY}"

    read -p "  Device B Twin ID [${DEVICE_B_TWIN_ID:-}]: " input
    DEVICE_B_TWIN_ID="${input:-$DEVICE_B_TWIN_ID}"

    echo ""
    read -p "  PhyHub Region (eu/us) [${PHYHUB_REGION:-eu}]: " input
    PHYHUB_REGION="${input:-${PHYHUB_REGION:-eu}}"

    # Write environment file
    cat > "$ENV_FILE" << EOF
# Python-Node Interoperability Test Configuration
# Generated by python-node-test.sh setup

# Device A (Python client)
DEVICE_A_ID=$DEVICE_A_ID
DEVICE_A_KEY=$DEVICE_A_KEY
DEVICE_A_TWIN_ID=$DEVICE_A_TWIN_ID

# Device B (Node.js client)
DEVICE_B_ID=$DEVICE_B_ID
DEVICE_B_KEY=$DEVICE_B_KEY
DEVICE_B_TWIN_ID=$DEVICE_B_TWIN_ID

# PhyHub configuration
PHYHUB_REGION=$PHYHUB_REGION
EOF

    chmod 600 "$ENV_FILE"
    log_success "Configuration saved to $ENV_FILE"

    # Add to gitignore
    GITIGNORE="$PROJECT_DIR/.gitignore"
    if ! grep -q ".env.interop-test" "$GITIGNORE" 2>/dev/null; then
        echo ".env.interop-test" >> "$GITIGNORE"
        log_info "Added .env.interop-test to .gitignore"
    fi
}

# Install Python dependencies
install_python_deps() {
    log_info "Installing Python dependencies..."
    cd "$PROJECT_DIR"
    pip install -e . 2>&1 || {
        log_warn "pip install had warnings, trying with --user..."
        pip install --user -e .
    }
    log_success "Python dependencies installed"
}

# Build Node.js hub-client
build_node() {
    log_info "Building Node.js hub-client..."
    cd "$NODE_HUB_CLIENT"
    yarn build
    log_success "Node.js build complete"
}

# Start Node.js responder
start_node_responder() {
    log_info "Starting Node.js responder..."

    # Kill any existing process
    pkill -f 'communication-comprehensive-test' 2>/dev/null || true
    sleep 1

    cd "$NODE_HUB_CLIENT"

    PHYHUB_DIRECT=true \
    DEVICE_ID="$DEVICE_B_ID" \
    ACCESS_KEY="$DEVICE_B_KEY" \
    PEER_TWIN_ID="$DEVICE_A_TWIN_ID" \
    PHYHUB_REGION="$PHYHUB_REGION" \
    ROLE=responder \
    node dist/test/communication-comprehensive-test.js > "$REMOTE_LOG" 2>&1 &

    log_info "Waiting for Node.js responder to be ready..."
    sleep 5

    if grep -q 'Connected' "$REMOTE_LOG" 2>/dev/null; then
        log_success "Node.js responder connected and ready"
    else
        log_warn "Node.js responder may not be ready yet"
        log_info "Current log:"
        tail -10 "$REMOTE_LOG" 2>/dev/null || echo "No log yet"
    fi
}

# Run Python initiator
run_python_initiator() {
    log_info "Running Python initiator..."

    cd "$PROJECT_DIR"

    PHYHUB_DIRECT=true \
    DEVICE_ID="$DEVICE_A_ID" \
    ACCESS_KEY="$DEVICE_A_KEY" \
    PEER_TWIN_ID="$DEVICE_B_TWIN_ID" \
    PHYHUB_REGION="$PHYHUB_REGION" \
    ROLE=initiator \
    python tests/test_communication.py 2>&1 | tee "$LOCAL_LOG"
}

# Start Python responder
start_python_responder() {
    log_info "Starting Python responder..."

    cd "$PROJECT_DIR"

    PHYHUB_DIRECT=true \
    DEVICE_ID="$DEVICE_A_ID" \
    ACCESS_KEY="$DEVICE_A_KEY" \
    PEER_TWIN_ID="$DEVICE_B_TWIN_ID" \
    PHYHUB_REGION="$PHYHUB_REGION" \
    ROLE=responder \
    python tests/test_communication.py > "$LOCAL_LOG" 2>&1 &

    log_info "Waiting for Python responder to be ready..."
    sleep 5

    if grep -q 'Connected' "$LOCAL_LOG" 2>/dev/null; then
        log_success "Python responder connected and ready"
    else
        log_warn "Python responder may not be ready yet"
    fi
}

# Run Node.js initiator
run_node_initiator() {
    log_info "Running Node.js initiator..."

    cd "$NODE_HUB_CLIENT"

    PHYHUB_DIRECT=true \
    DEVICE_ID="$DEVICE_B_ID" \
    ACCESS_KEY="$DEVICE_B_KEY" \
    PEER_TWIN_ID="$DEVICE_A_TWIN_ID" \
    PHYHUB_REGION="$PHYHUB_REGION" \
    ROLE=initiator \
    node dist/test/communication-comprehensive-test.js 2>&1 | tee "$REMOTE_LOG"
}

# Collect results
collect_results() {
    echo ""
    log_info "Test completed. Results:"
    echo ""

    echo "=== Node.js Log ==="
    cat "$REMOTE_LOG" 2>/dev/null || echo "No log available"
    echo ""

    echo "=== Python Log ==="
    cat "$LOCAL_LOG" 2>/dev/null || echo "No log available"
    echo ""
}

# Cleanup
cleanup() {
    log_info "Cleaning up..."
    pkill -f 'communication-comprehensive-test' 2>/dev/null || true
    pkill -f 'test_communication.py' 2>/dev/null || true
    rm -f "$REMOTE_LOG" "$LOCAL_LOG" 2>/dev/null || true
    log_success "Cleanup complete"
}

# Run test: Python initiator, Node.js responder
cmd_run() {
    load_env

    echo ""
    log_info "Python-Node Interoperability Test"
    echo "=============================================="
    echo "  Python (Initiator): Device A - Twin $DEVICE_A_TWIN_ID"
    echo "  Node.js (Responder): Device B - Twin $DEVICE_B_TWIN_ID"
    echo "  PhyHub Region: $PHYHUB_REGION"
    echo "=============================================="
    echo ""

    trap cleanup EXIT

    install_python_deps
    build_node
    start_node_responder
    run_python_initiator
    collect_results
}

# Run reverse test: Node.js initiator, Python responder
cmd_run_reverse() {
    load_env

    echo ""
    log_info "Python-Node Interoperability Test (Reversed)"
    echo "=============================================="
    echo "  Node.js (Initiator): Device B - Twin $DEVICE_B_TWIN_ID"
    echo "  Python (Responder): Device A - Twin $DEVICE_A_TWIN_ID"
    echo "  PhyHub Region: $PHYHUB_REGION"
    echo "=============================================="
    echo ""

    trap cleanup EXIT

    install_python_deps
    build_node
    start_python_responder
    run_node_initiator
    collect_results
}

# Clean command
cmd_clean() {
    cleanup
}

# Help
cmd_help() {
    echo "Python-Node Interoperability Test Runner"
    echo ""
    echo "Usage: $0 <command>"
    echo ""
    echo "Commands:"
    echo "  setup     Configure test credentials"
    echo "  run       Run test: Python initiator, Node.js responder"
    echo "  run-rev   Run reversed: Node.js initiator, Python responder"
    echo "  clean     Clean up processes and logs"
    echo "  help      Show this help message"
    echo ""
    echo "Environment Variables:"
    echo "  NODE_HUB_CLIENT  Path to Node.js hub-client (default: auto-detect)"
    echo ""
    echo "Examples:"
    echo "  $0 setup      # First time setup"
    echo "  $0 run        # Test Python -> Node.js communication"
    echo "  $0 run-rev    # Test Node.js -> Python communication"
}

# Main
case "${1:-}" in
    setup)
        cmd_setup
        ;;
    run)
        cmd_run
        ;;
    run-rev|run-reverse)
        cmd_run_reverse
        ;;
    clean)
        cmd_clean
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        cmd_help
        exit 1
        ;;
esac
