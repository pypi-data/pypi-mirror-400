from pathlib import Path
from typing import Union

from chartbook.settings import config


def get_path(
    base_dir: Union[str, Path, None] = None,
    pipeline_id: str = "EX",
    dataframe_id: str = "repo_public",
    data_dir_name: str = "_data",
) -> Path:
    """Get the path to a dataframe file.

    :param base_dir: The base directory where pipeline data is stored.
        If None, uses the DATA_DIR from settings.
    :type base_dir: Union[str, Path, None]
    :param pipeline_id: The identifier of the pipeline.
    :type pipeline_id: str
    :param dataframe_id: The identifier of the dataframe.
    :type dataframe_id: str
    :param data_dir_name: The name of the data directory within the pipeline.
    :type data_dir_name: str
    :returns: The path to the parquet file.
    :rtype: Path
    """
    if base_dir is None:
        base_dir = config("DATA_DIR")
    base_dir = Path(base_dir)

    filename = f"{dataframe_id}.parquet"
    file_path = base_dir / pipeline_id / data_dir_name / filename
    return file_path


def load(
    base_dir: Union[str, Path, None] = None,
    pipeline_id: str = "EX",
    dataframe_id: str = "repo_public",
    data_dir_name: str = "_data",
    format: str = "pandas",
):
    """Load a specific dataframe generated by a pipeline.

    This function reads a Parquet file corresponding to the given pipeline and dataframe IDs
    from the specified base directory (or the default DATA_DIR configured in settings).
    It can return the data as either a pandas or a polars DataFrame.

    :param base_dir: The base directory where pipeline data is stored.
        If None, uses the DATA_DIR from settings.
    :type base_dir: Union[str, Path, None]
    :param pipeline_id: The identifier of the pipeline that generated the dataframe.
    :type pipeline_id: str
    :param dataframe_id: The identifier of the specific dataframe within the pipeline.
    :type dataframe_id: str
    :param data_dir_name: The name of the data directory.
    :type data_dir_name: str
    :param format: The desired format of the returned DataFrame. Options are "pandas" or "polars". Default is "pandas".
    :type format: str

    :returns: The loaded dataframe in the specified format.
    :rtype: pandas.DataFrame or polars.DataFrame

    **Examples**

    Load the 'repo_public' dataframe from the 'EX' pipeline as a pandas DataFrame:

    ```python
    import chartbook as cb
    df_pandas = cb.data.load(pipeline_id="EX", dataframe_id="repo_public")
    print(df_pandas.head())
    ```

    Load the same dataframe as a polars DataFrame:

    ```python
    import chartbook as cb
    df_polars = cb.data.load(pipeline_id="EX", dataframe_id="repo_public", format="polars")
    print(df_polars.head())
    ```

    Load from a specific directory:

    ```python
    import chartbook as cb
    df = cb.data.load(base_dir="/path/to/data", pipeline_id="EX", dataframe_id="repo_public")
    print(df.head())
    ```
    """
    file_path = get_path(base_dir, pipeline_id, dataframe_id, data_dir_name)
    if format == "pandas":
        import pandas as pd

        df = pd.read_parquet(file_path)
    elif format == "polars":
        import polars as pl

        df = pl.read_parquet(file_path)
    else:
        raise ValueError(f"Invalid format: {format}")
    return df
