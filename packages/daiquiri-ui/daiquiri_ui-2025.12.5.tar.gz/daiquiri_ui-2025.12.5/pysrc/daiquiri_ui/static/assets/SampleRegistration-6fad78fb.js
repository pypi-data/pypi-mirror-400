var oe=Object.defineProperty;var ie=(t,s,a)=>s in t?oe(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a;var u=(t,s,a)=>(ie(t,typeof s!="symbol"?s+"":s,a),a);import{k as V,j as e,v as re,i as z,D as ce,a2 as F,a3 as le,a4 as $,a5 as de,r as l,T as L,B as U,a6 as Y,a7 as w,a8 as me,a9 as pe,aa as q,u as ue,a as xe,N as fe,F as G,e as D,ab as K,ac as he,ad as ge,ae as je,w as ye,c as Se,m as N,t as ve,q as we}from"./index-4cf586ed.js";import{u as I,S as M,a as A,B as Ce,T as be}from"./store-2462c975.js";import{T as Me,I as Te,R as ke,a as B,$ as Re,m as De,U as Fe,j as Ie,B as Ae,C as Ee,Y as Pe,b as Be}from"./index-19c84627.js";import{P as W}from"./SelectionPoint-7fbd4e1f.js";import{L as Le}from"./hooks-e7539055.js";import{C as _}from"./CrossMarker-cc495eca.js";import{L as Ne}from"./Label-7daca8b6.js";import{f as Ve,H as ze,V as $e}from"./VisViewpointRestore-3a80fbce.js";import{L as _e}from"./LoadingMessage-072bb4e8.js";import"./colors-5bf0897d.js";import"./ScreenScale-fdd43179.js";function Oe({sampleactionpositionid:t}){const{fetch:s}=z();function a(){s(M.delete,{sampleactionpositionid:t})}return e.jsx(ce,{id:t,onClick:()=>a(),confirm:!0,show:!0})}function He(t,s){return s.sampleactionpositionid&&e.jsx(Oe,{sampleactionpositionid:s.sampleactionpositionid})}function Ue(){const{selectedSampleActionId:t}=I(),s=V(M.getList,t?{sampleactionid:t}:null),a=[{dataField:"id",text:"#"},{dataField:"type",text:"Type"},{dataField:"posx",text:"X"},{dataField:"posy",text:"Y"},{dataField:"",text:"",formatter:He,classes:"text-end"}];return e.jsx(e.Fragment,{children:e.jsx(re,{keyField:"sampleactionpositionid",data:s.rows||[],columns:a,noDataIndication:"No reference positions",overlay:!0})})}class Ye{constructor(){u(this,"actiontype");u(this,"has_result");u(this,"message");u(this,"positions");u(this,"sampleactionid");u(this,"status")}}class qe extends F(Ye,{pk:"sampleactionid",key:"SampleAction"}){}const Ge=le({path:"/metadata/samples/actions/:sampleactionid",schema:qe});class We{constructor(){u(this,"matrixid")}}class Ke extends F(We,{pk:"matrixid",key:"SetReferenceMatrix"}){}const Xe=new $({method:"POST",path:"/imageviewer/move/reference/matrix",schema:Ke,searchParams:{}});class Je{constructor(){u(this,"crop");u(this,"sampleactionid")}}class Qe extends Je{constructor(){super(...arguments);u(this,"exportid",0)}}class Ze extends F(Qe,{pk:"exportid",key:"ExportToSampleImage"}){}const et=new $({method:"POST",path:"/imageviewer/reference/export",schema:Ze,searchParams:{}});var j=(t=>(t.error="error",t.warning="warning",t.success="success",t.info="info",t))(j||{});function tt({sampleactionid:t,addToast:s}){const{visibleDomain:a}=A(),{fetch:n}=z(),[i,o]=l.useState(!1),[r,c]=l.useState(!1),p=l.useCallback(async()=>{if(t){o(!0);try{await n(Xe,{sampleactionid:t}),s({type:j.success,title:"Matrix calculated",text:"Transformation matrix successfully calculated"})}catch(m){const x=await m.response.json();s({type:j.error,title:"Couldn't calculate matrix",text:x.error})}o(!1)}},[t]),d=l.useCallback(async()=>{if(t){c(!0);try{await n(et,{sampleactionid:t,crop:{x:a.xVisibleDomain.map(m=>Math.max(0,Math.round(m))),y:a.yVisibleDomain.map(m=>Math.max(0,Math.round(m)))}}),s({type:j.success,title:"Reference Exported",text:"Exported reference to sample image"})}catch(m){const x=await m.response.json();s({type:j.error,title:"Couldn't export reference to sample image",text:x.error})}c(!1)}},[t]);return e.jsxs(e.Fragment,{children:[e.jsx(L,{tooltip:"Select this reference for coordinate transform",children:e.jsxs(U,{size:"sm",onClick:()=>void p(),disabled:i,children:[i&&e.jsx("i",{className:"fa fa-spinner fa-spin"}),!i&&e.jsx("i",{className:"fa fa-th"})]})}),e.jsx(L,{tooltip:"Export this image transform to the 2d view",children:e.jsxs(U,{size:"sm",onClick:()=>void d(),className:"ms-1",disabled:r,children:[r&&e.jsx("i",{className:"fa fa-spinner fa-spin"}),!r&&e.jsx("i",{className:"fa fa-file-export"})]})})]})}function st(t,s,a,n){return e.jsx(e.Fragment,{children:s.has_result&&e.jsx(tt,{...s,...n})})}function at({sampleid:t,addToast:s}){const{selectedSampleActionId:a,setSelectedSampleActionId:n,setSelectedSampleActionHasResult:i}=I(),o=V(Ge.getList,{actiontype:"reference",...t?{sampleid:t}:null}),r=[{dataField:"sampleactionid",text:"Id"},{dataField:"status",text:"Status"},{dataField:"message",text:"Message",classes:"text-break"},{dataField:"has_result",text:"Image",formatter:(c,p)=>p.has_result?"Yes":"No"},{text:"",dataField:"",formatter:st,classes:"text-end text-nowrap",formatExtraData:{addToast:s}}];return e.jsx(e.Fragment,{children:e.jsx(de,{keyField:"sampleactionid",data:o.rows||[],columns:r,noDataIndication:"No reference images",selectedItems:a!==void 0?[a]:[],actions:{addSelection:c=>{const{sampleactionid:p}=c;n(p);const d=o.rows.filter(m=>m.sampleactionid===p);d.length>0&&i(d[0].has_result??!1)},removeSelection:c=>{},resetSelection:()=>{}}})})}function nt(t){const{abscissaConfig:s,ordinateConfig:a,title:n,showAxes:i,children:o}=t;return e.jsx(Me,{abscissaConfig:s,ordinateConfig:a,aspect:"equal",title:n,showAxes:i,children:e.jsx(Le,{children:o})})}class ot{constructor(){u(this,"moveid");u(this,"positions")}}class it extends F(ot,{pk:"moveid",key:"MoveToReference"}){}const rt=new $({method:"POST",path:"/imageviewer/move/reference",schema:it,searchParams:{}}),ct={values:new Float32Array([0]),bins:new Float32Array([0,255])};function lt(t){const s={width:256,height:256},[a,n]=l.useState(void 0),[i,o]=l.useState(new Y(new w,new w(1,1))),[r,c]=l.useState(ct);return l.useEffect(()=>{async function p(){if(t)try{const d=await Ve(t,"sample_registration","sample_registration"),{histogram:m,layers:x,yDomain:h,zDomain:y}=d,C=new ze(s,x);n(C),c(m),o(new Y(new w(h[0],y[0]),new w(h[1],y[1])))}catch{console.log("Could not fetch dataset")}}p()},[t]),{api:a,histogram:r,tilingBox:i}}function dt({sampleactionid:t}){const[s,a]=l.useState(void 0);return l.useEffect(()=>{a(()=>me.create({baseURL:pe(),params:{sampleactionid:t},...q.getOptions()}))},[q.token,t]),s}function mt(t){const{currentAction:s,setCurrentAction:a,colorMap:n,setColorMap:i,scaleType:o,setScaleType:r,invertColorMap:c,setInvertColorMap:p,setCustomDomain:d,customDomain:m,doMove:x,setDoMove:h}=A(),y=ue(),C=xe(),{dataDomain:E,histogram:P,currentSample:b}=t;return e.jsxs(fe,{bg:"cyan",className:"p-2",style:{zIndex:99},children:[e.jsx(G,{children:e.jsx(Ce,{children:e.jsxs(be,{type:"radio",name:"action",value:s,onChange:f=>a(f),className:"me-1",children:[e.jsxs(D,{id:"reference",value:"reference",size:"sm",disabled:!b,children:[e.jsx("i",{className:"fa fa-map-marker me-1"}),"Reference"]}),e.jsxs(D,{id:"poi",value:"poi",size:"sm",disabled:!b,children:[e.jsx("i",{className:"fa fa-map-pin me-1"}),"POI"]}),e.jsxs(D,{id:"pan",value:"pan",size:"sm",children:[e.jsx("i",{className:"fa fa-arrows me-1"}),"Pan"]}),e.jsxs(D,{id:"move",value:"move",size:"sm",disabled:!y||!!C,children:[e.jsx("i",{className:"fa fa-map-marker me-1"}),"Move",e.jsx(L,{tooltip:"Enable Move",children:e.jsx(G.Check,{className:"d-inline ms-1",type:"checkbox",checked:x,value:"1",onChange:()=>h(!x)})})]})]})})}),e.jsx(Te,{dataDomain:E,customDomain:m,scaleType:o,onCustomDomainChange:f=>d(f),histogram:P}),e.jsx(ke,{value:o,onScaleChange:r,options:[B.Linear,B.SymLog,B.Sqrt]}),e.jsx(Re,{value:n,onValueChange:i,invert:c,onInversionChange:()=>p(!c)})]})}function pt(){return e.jsx(_,{x:1e3,y:1e3,color:K.primary,sizeInScreen:20,lineWidth:1})}function ut({beam:t}){return e.jsx(e.Fragment,{children:t&&e.jsx(_,{x:t[0],y:t[1],color:K.warning,sizeInScreen:20,lineWidth:1})})}function xt({positions:t}){return e.jsx(e.Fragment,{children:t==null?void 0:t.filter(s=>s.type==="reference").map(s=>e.jsxs(e.Fragment,{children:[e.jsx(_,{x:s.posx,y:s.posy,color:"magenta",sizeInScreen:20,lineWidth:1},s.sampleactionpositionid),e.jsx(Ne,{color:"magenta",datapos:[s.posx,s.posy],text:`${s.id}`})]}))})}function ft({currentAction:t,setReference:s,move:a}){return e.jsxs(e.Fragment,{children:[t==="reference"&&e.jsx(W,{onClick:n=>void s(Math.round(n.dataPt.x),Math.round(n.dataPt.y))}),t==="pan"&&e.jsxs(e.Fragment,{children:[e.jsx(Ae,{button:Ee.Left}),e.jsx(Pe,{})]}),t==="move"&&e.jsx(W,{onClick:n=>a(Math.round(n.dataPt.x),Math.round(n.dataPt.y))})]})}function ht(){const{getVisibleDomains:t}=Be(),s=he(r=>r.camera),{setVisibleDomain:a}=A();function n(r){a(r)}const i=l.useCallback(ge(n,200),[]),o=t(s);return i(o),null}function gt(t){const{api:s,tilingBox:a,dataDomain:n,sampleactionid:i,referenceBeam:o,addToast:r}=t,{fetch:c,invalidateAll:p}=z(),d=a.getSize(new w),m=a.getCenter(new w),{colorMap:x,scaleType:h,invertColorMap:y,customDomain:C,currentAction:E,setCurrentAction:P,doMove:b}=A(),[f,X]=l.useState(0);l.useEffect(()=>{const g=setInterval(()=>{const S=s.getPendingTilesCount();S!==f&&X(S)},1e3);return()=>{clearTimeout(g)}},[s,f]);const{cameraViewport:J,setCameraViewport:Q}=I(),Z=De(C,n),[ee]=Fe(Z,n,h),te={sampleactionid:i,type:"reference"},T=V(M.getList,te),se=l.useCallback(async(g,S)=>{const k=T.rows.length>0?Math.max(...T.rows.map(R=>R.id)):0;await c(M.getList.push,{posx:g,posy:S,sampleactionid:i,type:"reference",id:k+1}),p(M.getList),P("pan")},[T]),ae=l.useCallback(async(g,S)=>{var k,R,O,H;try{const v=await c(rt,{x:g,y:S,execute:b});r({type:j.info,title:"Move To Poisiton",text:`${(k=v.positions)==null?void 0:k.x.motor}: ${(R=v.positions)==null?void 0:R.x.destination}, ${(O=v.positions)==null?void 0:O.y.motor}: ${(H=v.positions)==null?void 0:H.y.destination}`})}catch(v){const ne=await v.response.json();r({type:j.error,title:"Couldn't move to position",text:ne.error})}},[i,b]);return e.jsx("div",{style:{flex:"1",display:"flex",flexDirection:"column"},children:e.jsxs(nt,{abscissaConfig:{visDomain:[0,d.x]},ordinateConfig:{visDomain:[0,d.y],flip:!0},children:[e.jsx(_e,{info:f>0?`Waiting for ${f} tiles`:""}),e.jsx($e,{viewpoint:J,setViewpoint:Q}),e.jsx("group",{position:[m.x,m.y,0],children:e.jsx(Ie,{size:{width:d.x,height:d.y},api:s,colorMap:x,invertColorMap:y,domain:ee,scaleType:h,displayLowerResolutions:!1,qualityFactor:0})}),e.jsx(ht,{}),e.jsx(ut,{beam:o==null?void 0:o.beam}),e.jsx(xt,{positions:T.rows}),e.jsx(pt,{}),e.jsx(ft,{currentAction:E,setReference:se,move:(...g)=>void ae(...g)})]})})}function jt(t){var p,d;const{selectedSampleActionId:s,selectedSampleActionHasResult:a}=I(),n=dt({sampleactionid:s}),{api:i,tilingBox:o,histogram:r}=lt(n),c=[0,254];return s?a?i?e.jsxs(e.Fragment,{children:[e.jsx(mt,{dataDomain:c,histogram:r,...t}),s&&a&&e.jsx(gt,{sampleactionid:s,dataDomain:c,api:i,tilingBox:o,referenceBeam:(d=(p=t.sources)==null?void 0:p["1"])==null?void 0:d.reference,addToast:t.addToast})]}):null:e.jsx("p",{style:{padding:"10px"},children:"Selected reference does not have an image"}):e.jsx("p",{style:{padding:"10px"},children:"Please select a reference image"})}function yt(t){const s=je();return e.jsxs("div",{className:"h-100",style:{display:"flex",flexDirection:"row"},children:[e.jsx("div",{style:{flex:"1 1 70%",display:"flex",flexDirection:"column",backgroundColor:"#efefef",borderRadius:"3px"},children:e.jsx(jt,{...t,addToast:s})}),e.jsxs("div",{style:{flex:"1 1 30%",padding:"0.5rem"},children:[e.jsx(l.Suspense,{fallback:e.jsx("p",{children:"..."}),children:e.jsx(at,{sampleid:t.currentSample,addToast:s})}),e.jsx(l.Suspense,{fallback:e.jsx("p",{children:"..."}),children:e.jsx(Ue,{})})]})]})}const St=(t,s)=>{const{samples:a}=s.providers.metadata,{sources:n}=s.providers.twod;return{currentSample:N.selector("currentSample",t),sample:a.selector("results",t)[N.selector("currentSample",t)],sources:n.selector("results",t)}},vt=(t,s)=>({}),wt=ye({metadata:N,twod:ve})(Se(St,vt)(yt));function Bt(t){const{providers:s,yamlNode:a,datacollectionid:n,fileName:i,...o}=t;return we(a,o),e.jsx(wt,{})}export{Bt as default};
