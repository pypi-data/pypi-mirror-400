name: Dev Container Features - CI

on:
  workflow_dispatch:
  push:
    tags: [v*]
    paths:
      - devcontainer-features/**

  pull_request:
    paths:
      - devcontainer-features/**

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
      - uses: devcontainers/action@v1
        with:
          validate-only: true
          base-path-to-features: ./devcontainer-features/src

  test-autogenerated:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        base-image:
          - debian:latest
        features:
          - session-manager-plugin
    steps:
      - uses: actions/checkout@v6

      - name: Install Dev Containers CLI
        run: npm install --global @devcontainers/cli

      - name: Run autogenerated tests
        run: |
          devcontainer features test \
            --skip-scenarios \
            --features '${{ matrix.features }}' \
            --base-image '${{ matrix.base-image }}' \
            ./devcontainer-features

  test-scenarios:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        base-image:
          - debian:latest
        features:
          - session-manager-plugin
    steps:
      - uses: actions/checkout@v6

      - name: Install Dev Containers CLI
        run: npm install --global @devcontainers/cli

      - name: Run scenario tests
        run: |
          devcontainer features test \
            --skip-autogenerated \
            --skip-duplicated \
            --features '${{ matrix.features }}' \
            --base-image '${{ matrix.base-image }}' \
            ./devcontainer-features

  test-global:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        base-image:
          - debian:latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Dev Containers CLI
        run: npm install --global @devcontainers/cli

      - name: Run global tests
        run: |
          devcontainer features test \
            --global-scenarios-only \
            --base-image '${{ matrix.base-image }}' \
            ./devcontainer-features
