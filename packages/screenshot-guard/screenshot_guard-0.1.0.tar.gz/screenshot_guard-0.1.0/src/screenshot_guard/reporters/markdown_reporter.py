"""Markdown report generator."""

from datetime import datetime
from typing import List

from screenshot_guard.detector import Finding


class MarkdownReporter:
    """Generate Markdown reports from findings."""

    def generate(self, findings: List[Finding]) -> str:
        """Generate a Markdown report.

        Args:
            findings: List of findings to report

        Returns:
            Markdown string
        """
        lines = []

        # Header
        lines.append("# Screenshot Guard Report")
        lines.append("")
        lines.append(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        lines.append("")

        # Summary
        lines.append("## Summary")
        lines.append("")
        lines.append(f"- **Total findings:** {len(findings)}")

        severity_counts = {}
        for finding in findings:
            severity_counts[finding.severity] = severity_counts.get(finding.severity, 0) + 1

        for sev in ["critical", "high", "medium", "low"]:
            count = severity_counts.get(sev, 0)
            if count > 0:
                emoji = {"critical": "", "high": "", "medium": "", "low": ""}.get(sev, "")
                lines.append(f"- **{sev.capitalize()}:** {count} {emoji}")

        ocr_count = len([f for f in findings if f.from_ocr])
        if ocr_count > 0:
            lines.append(f"- **From OCR (screenshots):** {ocr_count}")

        lines.append("")

        # Group by severity
        lines.append("## Findings")
        lines.append("")

        severity_order = {"critical": 0, "high": 1, "medium": 2, "low": 3}
        sorted_findings = sorted(findings, key=lambda f: severity_order.get(f.severity, 4))

        current_severity = None
        for finding in sorted_findings:
            if finding.severity != current_severity:
                current_severity = finding.severity
                emoji = {"critical": "", "high": "", "medium": "", "low": ""}.get(current_severity, "")
                lines.append(f"### {current_severity.capitalize()} {emoji}")
                lines.append("")

            source_tag = " `[OCR]`" if finding.from_ocr else ""
            lines.append(f"#### {finding.pattern_name}{source_tag}")
            lines.append("")
            lines.append(f"- **File:** `{finding.file_path}`")
            lines.append(f"- **Line:** {finding.line_number}")
            lines.append(f"- **Provider:** {finding.provider}")
            if finding.description:
                lines.append(f"- **Description:** {finding.description}")
            lines.append(f"- **Match:** `{finding.redacted_match()}`")
            lines.append("")

        # Footer
        lines.append("---")
        lines.append("")
        lines.append("Generated by [Screenshot Guard](https://github.com/Keyvanhardani/screenshot-guard)")

        return "\n".join(lines)
