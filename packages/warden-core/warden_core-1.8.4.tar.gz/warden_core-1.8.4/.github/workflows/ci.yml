name: Warden CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  warden-scan:
    name: Self-Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # Removed apt-get install as build-essential is pre-installed on ubuntu-latest
      # and it saves ~1-2 minutes of setup time.

      - name: Install Warden
        run: |
          pip install --upgrade pip
          pip install -e .
          # Verify installation
          warden --help

      - name: Cache Warden Storage
        uses: actions/cache@v4
        with:
          path: |
            .warden/memory
            .warden/embeddings
          key: warden-storage-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            warden-storage-${{ runner.os }}-

      - name: Cache AI Models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: hf-models-${{ runner.os }}-${{ hashFiles('.warden/config.yaml') }}
          restore-keys: |
            hf-models-${{ runner.os }}-

      - name: Run Warden Scan
        # continue-on-error removed to enforce quality gate
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_API_VERSION: ${{ secrets.AZURE_OPENAI_API_VERSION }}
          AZURE_OPENAI_DEPLOYMENT_NAME: ${{ secrets.AZURE_OPENAI_DEPLOYMENT_NAME }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          LLM_PROVIDER: ${{ secrets.LLM_PROVIDER }}
          DEFAULT_LLM_MODEL: ${{ secrets.DEFAULT_LLM_MODEL }}
        run: |
          # Scanning the source code of Warden itself
          warden scan src/warden --format sarif --output warden.sarif --verbose



      - name: Archive SARIF Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: warden-scan-results
          path: warden.sarif

