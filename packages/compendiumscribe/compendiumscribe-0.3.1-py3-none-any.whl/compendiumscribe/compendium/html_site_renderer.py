"""Render a Compendium as a navigable multi-file HTML site."""

from __future__ import annotations

import html
from typing import TYPE_CHECKING

from .text_utils import format_html_text, slugify

if TYPE_CHECKING:  # pragma: no cover - hints only
    from .compendium import Compendium
    from .entities import Section


def _html_head(title: str, depth: int = 0) -> list[str]:
    """Generate HTML head section."""
    return [
        "<!DOCTYPE html>",
        '<html lang="en">',
        "<head>",
        '  <meta charset="utf-8">',
        (
            '  <meta name="viewport" content="width=device-width, '
            'initial-scale=1">'
        ),
        f"  <title>{html.escape(title)}</title>",
        "</head>",
    ]


def _nav_links(
    current: str,
    sections: list["Section"],
    depth: int = 0,
) -> list[str]:
    """Generate navigation links for the site."""
    prefix = "../" * depth
    parts = [
        "<nav>",
        "  <ul>",
        f'    <li><a href="{prefix}index.html">Home</a></li>',
    ]

    if sections:
        parts.append("    <li>Sections:")
        parts.append("      <ul>")
        for section in sections:
            section_slug = slugify(section.identifier)
            href = f"{prefix}sections/{section_slug}.html"
            label = html.escape(section.title)
            parts.append(f'        <li><a href="{href}">{label}</a></li>')
        parts.append("      </ul>")
        parts.append("    </li>")

    parts.append(
        f'    <li><a href="{prefix}citations.html">Citations</a></li>'
    )
    parts.append(
        f'    <li><a href="{prefix}open-questions.html">'
        "Open Questions</a></li>"
    )
    parts.append("  </ul>")
    parts.append("</nav>")
    return parts


def _render_index_page(compendium: "Compendium") -> str:
    """Render the index/home page."""
    title = f"{compendium.topic} Compendium"
    generated_at = compendium.generated_at.replace(microsecond=0).isoformat()

    parts = _html_head(title, depth=0)
    parts.append("<body>")
    parts.append("<header>")
    parts.append(f"  <h1>{html.escape(compendium.topic)}</h1>")
    parts.append(f"  <p><time>{html.escape(generated_at)}</time></p>")
    parts.append("</header>")
    parts.append("<main>")

    # Navigation
    parts.extend(_nav_links("index", compendium.sections, depth=0))

    # Overview
    if compendium.overview:
        parts.append('<section id="overview">')
        parts.append("  <h2>Overview</h2>")
        parts.append(f"  <p>{format_html_text(compendium.overview)}</p>")
        parts.append("</section>")

    # Methodology
    if compendium.methodology:
        parts.append('<section id="methodology">')
        parts.append("  <h2>Methodology</h2>")
        parts.append("  <ol>")
        for step in compendium.methodology:
            parts.append(f"    <li>{format_html_text(step)}</li>")
        parts.append("  </ol>")
        parts.append("</section>")

    # Section summaries with links
    if compendium.sections:
        parts.append('<section id="sections">')
        parts.append("  <h2>Sections</h2>")
        parts.append("  <ul>")
        for section in compendium.sections:
            section_slug = slugify(section.identifier)
            href = f"sections/{section_slug}.html"
            label = html.escape(section.title)
            summary = format_html_text(section.summary)
            parts.append("    <li>")
            parts.append(
                f'      <a href="{href}"><strong>{label}</strong></a>'
            )
            parts.append(f"      <p>{summary}</p>")
            parts.append("    </li>")
        parts.append("  </ul>")
        parts.append("</section>")

    parts.append("</main>")
    parts.append("<footer>")
    parts.append("  <p>Generated by Compendium Scribe</p>")
    parts.append("</footer>")
    parts.append("</body>")
    parts.append("</html>")

    return "\n".join(parts) + "\n"


def _render_section_page(section: "Section", compendium: "Compendium") -> str:
    """Render a single section page."""
    title = f"{section.title} — {compendium.topic}"

    parts = _html_head(title, depth=1)
    parts.append("<body>")
    parts.append("<header>")
    parts.append(f"  <h1>{format_html_text(section.title)}</h1>")
    parts.append(f"  <p>Part of <em>{html.escape(compendium.topic)}</em></p>")
    parts.append("</header>")
    parts.append("<main>")

    # Navigation
    parts.extend(_nav_links(section.identifier, compendium.sections, depth=1))

    # Summary
    if section.summary:
        parts.append('<section id="summary">')
        parts.append("  <h2>Summary</h2>")
        parts.append(f"  <p>{format_html_text(section.summary)}</p>")
        parts.append("</section>")

    # Key Terms
    if section.key_terms:
        parts.append('<section id="key-terms">')
        parts.append("  <h2>Key Terms</h2>")
        parts.append("  <ul>")
        for term in section.key_terms:
            parts.append(f"    <li>{format_html_text(term)}</li>")
        parts.append("  </ul>")
        parts.append("</section>")

    # Guiding Questions
    if section.guiding_questions:
        parts.append('<section id="guiding-questions">')
        parts.append("  <h2>Guiding Questions</h2>")
        parts.append("  <ul>")
        for question in section.guiding_questions:
            parts.append(f"    <li>{format_html_text(question)}</li>")
        parts.append("  </ul>")
        parts.append("</section>")

    # Insights
    if section.insights:
        parts.append('<section id="insights">')
        parts.append("  <h2>Insights</h2>")
        for insight in section.insights:
            parts.append("  <article>")
            parts.append(f"    <h3>{format_html_text(insight.title)}</h3>")
            parts.append("    <dl>")
            parts.append("      <dt>Evidence</dt>")
            parts.append(
                f"      <dd>{format_html_text(insight.evidence)}</dd>"
            )
            if insight.implications:
                parts.append("      <dt>Implications</dt>")
                parts.append(
                    f"      <dd>{format_html_text(insight.implications)}</dd>"
                )
            if insight.citation_refs:
                ref_links = []
                for ref in insight.citation_refs:
                    escaped_ref = html.escape(ref)
                    # Link to the citation anchor on the citations page
                    # Sections are one level deep (sections/), so we go up
                    # one level.
                    url = f"../citations.html#{escaped_ref}"
                    ref_links.append(f'<a href="{url}">{escaped_ref}</a>')

                refs = ", ".join(ref_links)
                parts.append("      <dt>Citations</dt>")
                parts.append(f"      <dd>{refs}</dd>")
            parts.append("    </dl>")
            parts.append("  </article>")
        parts.append("</section>")

    parts.append("</main>")
    parts.append("<footer>")
    parts.append('  <p><a href="../index.html">← Back to Home</a></p>')
    parts.append("</footer>")
    parts.append("</body>")
    parts.append("</html>")

    return "\n".join(parts) + "\n"


def _render_citations_page(compendium: "Compendium") -> str:
    """Render the citations page."""
    title = f"Citations — {compendium.topic}"

    parts = _html_head(title, depth=0)
    parts.append("<body>")
    parts.append("<header>")
    parts.append("  <h1>Citations</h1>")
    parts.append(
        f"  <p>Sources for <em>{html.escape(compendium.topic)}</em></p>"
    )
    parts.append("</header>")
    parts.append("<main>")

    # Navigation
    parts.extend(_nav_links("citations", compendium.sections, depth=0))

    if compendium.citations:
        parts.append('<section id="citations">')
        parts.append("  <ol>")
        for citation in compendium.citations:
            parts.append("    <li>")
            parts.append(
                f'      <article id="{html.escape(citation.identifier)}">'
            )
            parts.append(
                f"        <h2>[{html.escape(citation.identifier)}] "
                f"{format_html_text(citation.title)}</h2>"
            )
            parts.append(
                f'        <p><a href="{html.escape(citation.url)}" '
                f'rel="noopener noreferrer">'
                f"{html.escape(citation.url)}</a></p>"
            )
            details: list[str] = []
            if citation.publisher:
                details.append(html.escape(citation.publisher))
            if citation.published_at:
                details.append(html.escape(citation.published_at))
            if details:
                parts.append(f"        <p>{' · '.join(details)}</p>")
            if citation.summary:
                parts.append(
                    f"        <p>{format_html_text(citation.summary)}</p>"
                )
            parts.append("      </article>")
            parts.append("    </li>")
        parts.append("  </ol>")
        parts.append("</section>")
    else:
        parts.append("<p>No citations available.</p>")

    parts.append("</main>")
    parts.append("<footer>")
    parts.append('  <p><a href="index.html">← Back to Home</a></p>')
    parts.append("</footer>")
    parts.append("</body>")
    parts.append("</html>")

    return "\n".join(parts) + "\n"


def _render_open_questions_page(compendium: "Compendium") -> str:
    """Render the open questions page."""
    title = f"Open Questions — {compendium.topic}"

    parts = _html_head(title, depth=0)
    parts.append("<body>")
    parts.append("<header>")
    parts.append("  <h1>Open Questions</h1>")
    parts.append(
        "  <p>Unanswered questions about "
        f"<em>{html.escape(compendium.topic)}</em></p>"
    )
    parts.append("</header>")
    parts.append("<main>")

    # Navigation
    parts.extend(_nav_links("open-questions", compendium.sections, depth=0))

    if compendium.open_questions:
        parts.append('<section id="open-questions">')
        parts.append("  <ul>")
        for question in compendium.open_questions:
            parts.append(f"    <li>{format_html_text(question)}</li>")
        parts.append("  </ul>")
        parts.append("</section>")
    else:
        parts.append("<p>No open questions recorded.</p>")

    parts.append("</main>")
    parts.append("<footer>")
    parts.append('  <p><a href="index.html">← Back to Home</a></p>')
    parts.append("</footer>")
    parts.append("</body>")
    parts.append("</html>")

    return "\n".join(parts) + "\n"


def render_html_site(compendium: "Compendium") -> dict[str, str]:
    """Render the compendium as a navigable multi-file HTML site.

    Returns a dictionary mapping relative file paths to their HTML content.
    """
    files: dict[str, str] = {}

    # Index page
    files["index.html"] = _render_index_page(compendium)

    # Section pages
    for section in compendium.sections:
        section_slug = slugify(section.identifier)
        path = f"sections/{section_slug}.html"
        files[path] = _render_section_page(section, compendium)

    # Citations page
    files["citations.html"] = _render_citations_page(compendium)

    # Open Questions page
    files["open-questions.html"] = _render_open_questions_page(compendium)

    return files


__all__ = ["render_html_site"]
