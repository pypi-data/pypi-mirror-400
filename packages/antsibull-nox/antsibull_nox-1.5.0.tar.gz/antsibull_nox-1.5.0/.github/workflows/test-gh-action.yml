---
# GNU General Public License v3.0+ (see LICENSES/GPL-3.0-or-later.txt or
# https://www.gnu.org/licenses/gpl-3.0.txt)
# SPDX-License-Identifier: GPL-3.0-or-later
# SPDX-FileCopyrightText: 2023 Maxwell G <maxwell@gtmx.me>

name: test-gh-action
'on':
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Run once per week (Monday at 03:30 UTC)
  schedule:
    - cron: '30 3 * * 1'
  workflow_dispatch:

env:
  FORCE_COLOR: "1"

jobs:
  coverage-test:
    runs-on: ubuntu-latest
    name: "Run all tests with Py${{ matrix.python }}"
    strategy:
      fail-fast: false
      matrix:
        python:
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
          - "3.14"
    steps:
      - name: Check out antsibull-nox
        uses: actions/checkout@v6
        with:
          persist-credentials: false
      - name: Run nox action in subdirectory
        uses: ./
        with:
          working-directory: tests/coverage-collection/
          python-version: ${{ matrix.python }}
      - name: Run matrix generator
        id: run-nox
        run: |
          nox --verbose --reuse-existing-virtualenvs --no-install --sessions matrix-generator 2>&1
        env:
          FORCE_COLOR: "1"
        shell: bash
        working-directory: tests/coverage-collection/

  test-gh-action:
    runs-on: ubuntu-latest
    name: "Run nox"
    steps:
      - name: Check out antsibull-nox
        uses: actions/checkout@v6
        with:
          persist-credentials: false
      - name: Run nox action in subdirectory
        uses: ./
        with:
          working-directory: tests/test-collection/

  nox:
    uses: ./.github/workflows/reusable-nox-run.yml
    with:
      session-name: Run extra sanity tests
      change-detection-in-prs: true
      collection-root: tests/test-collection/

  ansible-test:
    uses: ./.github/workflows/reusable-nox-matrix.yml
    with:
      change-detection-in-prs: true
      collection-root: tests/test-collection/
