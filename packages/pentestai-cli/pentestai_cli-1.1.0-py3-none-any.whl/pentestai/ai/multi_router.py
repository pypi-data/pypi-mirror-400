from __future__ import annotations
from typing import Dict, List, Optional
from pentestai.ai.providers.base import AIProvider

class MultiAIRouter:
    def __init__(self, providers: Dict[str, AIProvider], routing: Dict[str, List[str]], fallbacks: List[str], default_provider: str):
        self.providers = providers
        self.routing = routing
        self.fallbacks = fallbacks
        self.default_provider = default_provider

    def order_for_task(self, task: str) -> List[str]:
        order = []
        if task in self.routing:
            order.extend(self.routing[task])
        if self.default_provider not in order:
            order.append(self.default_provider)
        for fb in self.fallbacks:
            if fb not in order:
                order.append(fb)
        return [p for p in order if p in self.providers]

    async def run(self, task: str, system: str, user: str, temperature: float = 0.2, max_tokens: int = 1400) -> str:
        last_err: Optional[Exception] = None
        for name in self.order_for_task(task):
            prov = self.providers[name]
            try:
                return await prov.chat(system, user, temperature=temperature, max_tokens=max_tokens)
            except Exception as e:
                last_err = e
                continue
        raise RuntimeError(f"All AI providers failed for task={task}. Last error: {last_err}")
