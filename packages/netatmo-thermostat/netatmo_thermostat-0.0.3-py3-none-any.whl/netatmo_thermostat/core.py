# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/00_core.ipynb.

# %% auto 0
__all__ = ['Thermostat', 'ControlBtn', 'SetpointDisplay', 'to_chart', 'TempChart', 'ThermostatWidget', 'setup_thermostat_widget']

# %% ../nbs/00_core.ipynb 2
import os
import json 

from time import time
from fastcore.utils import patch
from fastcore.xtras import dict2obj

from fasthtml.common import *
from monsterui.all import *

from httpx import get as xget, post as xpost

# %% ../nbs/00_core.ipynb 14
class Thermostat:
    base = 'https://api.netatmo.com'
    
    def __init__(self, client_id=None, client_secret=None, access_token=None, refresh_token=None):
        self.client_id = client_id or os.getenv('CLIENT_ID')
        self.client_secret = client_secret or os.getenv('CLIENT_SECRET')
        self.access_token = access_token or os.getenv('ACCESS_TOKEN')
        self.refresh_token = refresh_token or os.getenv('REFRESH_TOKEN')

# %% ../nbs/00_core.ipynb 16
@patch
def _refresh(self:Thermostat):
    r = xpost(f'{self.base}/oauth2/token', data={
        'grant_type': 'refresh_token',
        'refresh_token': self.refresh_token,
        'client_id': self.client_id,
        'client_secret': self.client_secret
    })
    d = r.json()
    self.access_token, self.refresh_token = d['access_token'], d['refresh_token']
    return d

# %% ../nbs/00_core.ipynb 18
@patch
def _request(self:Thermostat,
    endpoint:str, # the endpoint to query
    method='post', # the http method,
    **kwargs
): # extra kwargs
    "Request a Netatmo API endpoint with auto-refresh on expired token."

    url = f'{self.base}/api/{endpoint}'
    headers = kwargs.pop('headers', {})
    headers['Authorization'] = f'Bearer {self.access_token}'
    
    r = xpost(url, headers=headers, **kwargs) if method == 'post' else xget(url, headers=headers, **kwargs)
    if r.status_code in (401, 403): 
        self._refresh()
        return self._request(endpoint, method, **kwargs)
    rj = r.json()
    return dict2obj(rj.get('body', rj))


# %% ../nbs/00_core.ipynb 22
@patch
def homesdata(self:Thermostat):
    return self._request('homesdata')

# %% ../nbs/00_core.ipynb 27
@patch
def homestatus(self:Thermostat, home_id): return self._request('homestatus', data={'home_id': home_id})

# %% ../nbs/00_core.ipynb 32
@patch
def getroommeasure(self:Thermostat,
    home_id:str,   # Home ID
    room_id:str,   # Room ID
    scale:str='1hour',  # Time scale: 30min, 1hour, 3hours, 1day, 1week, 1month
    type:str='temperature',  # Data type: temperature or sp_temperature
    begin:int=None,  # Start timestamp
    end:int=None,    # End timestamp
):
    "Retrieve room temperature history"
    d = {'home_id': home_id, 'room_id': room_id, 'scale': scale, 'type': type}
    if begin: d['date_begin'] = begin
    if end: d['date_end'] = end
    return self._request('getroommeasure', data=d)

# %% ../nbs/00_core.ipynb 39
@patch
def setroomthermpoint(self:Thermostat,
    home_id:str,   # Home ID
    room_id:str,   # Room ID
    mode:str,      # Mode: manual, home, or schedule
    temp:float=None,      # Target temperature (for manual mode)
    endtime:int=None,     # End timestamp (for manual mode)
):
    "Set room temperature setpoint"
    d = {'home_id': home_id, 'room_id': room_id, 'mode': mode}
    if temp: d['temp'] = temp
    if endtime: d['endtime'] = endtime
    return self._request('setroomthermpoint', data=d)

@patch
def room_temperatures(self:Thermostat, home_id: str):
    "Nicer way to get a list of the temperatures of all room in the home"
    st = self.homestatus(home_id)
    return [dict(room_id=r.id, temperature=r.therm_measured_temperature, setpoint=r.therm_setpoint_temperature, setpoint_mode=r.therm_setpoint_mode) for r in st.home.rooms]

# %% ../nbs/00_core.ipynb 48
@patch
def setthermmode(self:Thermostat,
    home_id:str,   # Home ID
    mode:str,      # Mode: schedule (weekly program), away (reduced temp), hg (frost guard ~7°C)
    endtime:int=None,  # End timestamp (for away/hg modes)
):
    "Set home thermostat mode"
    d = {'home_id': home_id, 'mode': mode}
    if endtime: d['endtime'] = endtime
    return self._request('setthermmode', data=d)

# %% ../nbs/00_core.ipynb 57
@patch
def getmeasure(self:Thermostat,
    device_id:str,     # Device MAC address
    module_id:str=None,  # Module MAC (if reading from a module)
    scale:str='1hour', # Time scale: 30min, 1hour, 3hours, 1day, 1week, 1month
    type:str='boileron',  # Data type: boileron, boileroff, sum_boiler_on, sum_boiler_off
    begin:int=None,    # Start timestamp
    end:int=None,      # End timestamp
):
    "Retrieve boiler historical data"
    d = {'device_id': device_id, 'scale': scale, 'type': type}
    if module_id: d['module_id'] = module_id
    if begin: d['date_begin'] = begin
    if end: d['date_end'] = end
    return self._request('getmeasure', data=d)

# %% ../nbs/00_core.ipynb 64
@patch
def createnewhomeschedule(self:Thermostat,
    home_id:str,       # Home ID
    name:str,          # New schedule name
    zones:list,        # List of zone dicts with id, name, type, rooms_temp
    timetable:list,    # List of timetable entries with zone_id, m_offset
    hg_temp:float=7,   # Frost guard temp
    away_temp:float=17, # Away mode temp
):
    "Create a new weekly schedule"
    return self._request('createnewhomeschedule', data={
        'home_id': home_id, 'name': name, 'zones': zones, 
        'timetable': timetable, 'hg_temp': hg_temp, 'away_temp': away_temp})

# %% ../nbs/00_core.ipynb 66
@patch
def switchhomeschedule(self:Thermostat,
    home_id:str,       # Home ID
    schedule_id:str,   # Schedule ID to activate
):
    "Switch to a specific weekly schedule"
    return self._request('switchhomeschedule', data={'home_id': home_id, 'schedule_id': schedule_id})

# %% ../nbs/00_core.ipynb 68
@patch
def synchomeschedule(self:Thermostat,
    home_id:str,       # Home ID
    schedule_id:str,   # Schedule ID to modify
    zones:list,        # List of zone dicts with id, name, type, rooms_temp
    timetable:list,    # List of timetable entries with zone_id, m_offset
    name:str=None,     # Schedule name
    hg_temp:float=None,   # Frost guard temp
    away_temp:float=None, # Away mode temp
):
    "Modify an existing weekly schedule"
    d = {'home_id': home_id, 'schedule_id': schedule_id, 'zones': zones, 'timetable': timetable}
    if name: d['name'] = name
    if hg_temp: d['hg_temp'] = hg_temp
    if away_temp: d['away_temp'] = away_temp
    return self._request('synchomeschedule', data=d)

# %% ../nbs/00_core.ipynb 84
def ControlBtn(text, change, current_temp, **kwargs):
    return Button(text, 
        hx_post="/setpoint", 
        hx_vals=json.dumps({'change': change, 'current_setpoint': current_temp}),
        hx_target="#setpoint-display",
        hx_swap="outerHTML",
        cls="w-10 h-10 rounded-full border border-black/5 bg-white/50 text-slate-700 text-lg flex items-center justify-center hover:bg-white hover:scale-105 transition-all shadow-sm cursor-pointer",
        **kwargs
    )

def SetpointDisplay(temp):
    return Span(
        "Target ", Span(f"{temp}°", cls="text-temp-set font-semibold"),
        id="setpoint-display",
        cls="text-slate-500 font-medium text-base"
    )

# %% ../nbs/00_core.ipynb 87
def to_chart(raw):
    d = list(raw)[0]
    return [[d['beg_time']*1000 + i*d['step_time']*1000, v[0]] for i,v in enumerate(d['value'])]

# %% ../nbs/00_core.ipynb 90
def TempChart(temps_raw, sp_raw):
    return ApexChart(opts={
        'chart': {'type': 'area', 'height': 150, 'sparkline': {'enabled': True}},
        'series': [
            {'name': 'Temp', 'data': to_chart(temps_raw)},
            {'name': 'Setpoint', 'data': to_chart(sp_raw)}
        ],
        'xaxis': {'type': 'datetime'},
        'stroke': {'curve': ['smooth', 'stepline'], 'width': [3, 2], 'dashArray': [0, 5]},
        'colors': ['#00b894', '#e17055'],
        'fill': {'type': 'gradient', 'gradient': {'opacityFrom': 0.15, 'opacityTo': 0}}
    })

# %% ../nbs/00_core.ipynb 92
def ThermostatWidget(t, home_id, room_id, xtra_classes='w-[320px]'):
    temps_raw = t.getroommeasure(home_id, room_id, type='temperature')
    sp_raw = t.getroommeasure(home_id, room_id, type='sp_temperature')
    status = t.homestatus(home_id)
    room = [r for r in status.home.rooms if r.id == room_id][0]
    sp = room.therm_setpoint_temperature
    
    return Div(
        Div(
            Span("CLIMATE", cls="font-display text-xs font-bold text-slate-400 uppercase tracking-widest"),
            Div(
                ControlBtn("−", -0.5, sp, id="btn-minus"),
                ControlBtn("+", 0.5, sp, id="btn-plus"), cls="flex gap-2"),
            cls="flex justify-between items-center mb-6"
        ),
        Div(
            Span(f"{room.therm_measured_temperature}°", cls="font-display text-6xl text-temp-real leading-none"),
            SetpointDisplay(sp),
            cls="flex items-baseline gap-3 flex-wrap"
        ),
        Div(TempChart(temps_raw, sp_raw), cls="mt-auto -mx-3 h-[150px]"),
        cls=f"bg-white/85 backdrop-blur-xl border border-white/60 rounded-[32px] p-8 shadow-soft flex flex-col h-full transition-transform hover:-translate-y-1 duration-300 aspect-square {xtra_classes}"
    )

# %% ../nbs/00_core.ipynb 106
def setup_thermostat_widget(
    rt,        # FastHTML route decorator from fast_app()
    t,         # Thermostat instance (authenticated)
    home_id,   # Netatmo home ID
    room_id,   # Room ID to control,
    **kwargs   # Extra kwargs for ThermostatWidget
):
    "Register thermostat routes and return the climate widget. Call once after fast_app()."
    
    @rt("/setpoint")
    def post(change: float, current_setpoint: float):
        new_temp = round(current_setpoint + change, 1)
        t.setroomthermpoint(home_id, room_id, 'manual', new_temp, int(time.time() + 3600))
        return (SetpointDisplay(new_temp),
                ControlBtn("−", -0.5, new_temp, id="btn-minus", hx_swap_oob="true"),
                ControlBtn("+", 0.5, new_temp, id="btn-plus", hx_swap_oob="true"))

    return ThermostatWidget(t, home_id, room_id, **kwargs)

