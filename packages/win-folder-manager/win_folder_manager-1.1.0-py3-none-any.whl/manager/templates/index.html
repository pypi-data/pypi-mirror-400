<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Win Folder Manager</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .folder-row { transition: all 0.2s; }
        .folder-row:hover { background-color: #e9ecef; }
        .icon-preview { width: 24px; height: 24px; display: inline-block; vertical-align: middle; margin-right: 8px; }
        .badge-soft { background-color: #e7f1ff; color: #0d6efd; border: 1px solid #cff4fc;}
        .btn-ai { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white !important; border: none; }
        .btn-ai:hover { background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%); color: white !important; }
        /* å¢åŠ  loading é®ç½©å±‚æ ·å¼ */
        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" class="container py-4" v-cloak>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0"><i class="fa-solid fa-folder-tree text-primary"></i> æ–‡ä»¶å¤¹ç®¡ç†å™¨</h2>
                <p class="text-muted small mb-0">å½“å‰è·¯å¾„: <strong>[[ config.root_path ]]</strong></p>
            </div>
            <div>
                <button class="btn btn-outline-secondary me-2" @click="showConfigModal">
                    <i class="fa-solid fa-gear"></i> è®¾ç½®
                </button>
                <button class="btn btn-success" @click="refreshFolders">
                    <i class="fa-solid fa-rotate-right"></i> åˆ·æ–°åˆ—è¡¨
                </button>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-body py-2">
                <div class="d-flex gap-2">
                    <button v-if="config.ai_config?.enabled" class="btn btn-ai btn-sm" @click="batchAiGenerate" :disabled="batchAiGenerating">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        <span v-if="batchAiGenerating">æ‰¹é‡ç”Ÿæˆä¸­...</span>
                        <span v-else>AI æ‰¹é‡ç”Ÿæˆ</span>
                    </button>
                    <button class="btn btn-warning btn-sm" @click="batchRelativeToAll">
                        <i class="fa-solid fa-link"></i> å…¨éƒ¨è½¬ä¸ºç›¸å¯¹è·¯å¾„
                    </button>
                    <span class="text-muted small align-self-center ms-auto">
                        <i class="fa-solid fa-info-circle"></i> æç¤ºï¼šä¿®æ”¹é…ç½®åï¼Œèµ„æºç®¡ç†å™¨å¯èƒ½éœ€è¦å‡ ç§’é’Ÿåˆ·æ–°ç¼“å­˜ã€‚
                    </span>
                </div>
            </div>
        </div>

        <div class="card shadow">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 20%">ç‰©ç†åç§°</th>
                            <th style="width: 20%">æ˜¾ç¤ºåˆ«å</th>
                            <th style="width: 15%">å›¾æ ‡çŠ¶æ€</th>
                            <th style="width: 25%">å¤‡æ³¨ (InfoTip)</th>
                            <th class="text-end">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="folder in folders" :key="folder.path" class="folder-row">
                            <td class="font-monospace">[[ folder.name ]]</td>
                            <td>
                                <span v-if="folder.alias" class="fw-bold text-primary">[[ folder.alias ]]</span>
                                <span v-else class="text-muted fst-italic">- æ— åˆ«å -</span>
                            </td>
                            <td>
                                <span v-if="getIconAlias(folder.icon_path)" class="badge badge-soft">
                                    [[ getIconAlias(folder.icon_path) ]]
                                </span>
                                <span v-else-if="folder.icon_path" class="badge bg-secondary">è‡ªå®šä¹‰å›¾æ ‡</span>
                                <span v-else class="badge bg-light text-dark border">é»˜è®¤</span>
                            </td>
                            <td class="small text-muted text-truncate" style="max-width: 200px;">
                                [[ folder.infotip ]]
                            </td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm">
                                    <button v-if="config.ai_config?.enabled" class="btn btn-ai"
                                            @click="aiQuickGenerate(folder)"
                                            :disabled="aiGenerating[folder.path]">
                                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                                        <span v-if="aiGenerating[folder.path]">ç”Ÿæˆä¸­...</span>
                                        <span v-else>AI ç”Ÿæˆ</span>
                                    </button>
                                    <button class="btn btn-primary" @click="editFolder(folder)">
                                        <i class="fa-solid fa-pen"></i> ç¼–è¾‘
                                    </button>
                                    <button class="btn btn-outline-secondary" @click="openPath(folder.path, 'explorer')" title="æ‰“å¼€æ–‡ä»¶å¤¹">
                                        <i class="fa-regular fa-folder-open"></i>
                                    </button>
                                    <button class="btn btn-outline-dark" @click="openPath(folder.path, 'cmd')" title="æ‰“å¼€ CMD">
                                        <i class="fa-solid fa-terminal"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="modal fade" id="editModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ç¼–è¾‘å±æ€§: [[ currentFolder.name ]]</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">æ–‡ä»¶å¤¹åˆ«å (ä¸­æ–‡å)</label>
                            <input type="text" class="form-control" v-model="editForm.alias" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„æ–‡æ¡£">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">é¡¹ç›®å¤‡æ³¨ (InfoTip)</label>
                            <textarea class="form-control" v-model="editForm.infotip" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">é€‰æ‹©å›¾æ ‡</label>
                            <select class="form-select" v-model="editForm.icon_path">
                                <option value="">ä½¿ç”¨é»˜è®¤æ–‡ä»¶å¤¹å›¾æ ‡</option>
                                <option v-for="icon in config.icons" :value="icon.path">
                                    [[ icon.name ]] ([[ icon.path ]])
                                </option>
                            </select>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" v-model="editForm.use_relative" id="relPathCheck">
                            <label class="form-check-label" for="relPathCheck">
                                å°è¯•ä½¿ç”¨ç›¸å¯¹è·¯å¾„ä¿å­˜ (ä¾¿äºç§»åŠ¨)
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="button" class="btn btn-primary" @click="saveFolder">ä¿å­˜æ›´æ”¹</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="configModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <span v-if="!config.root_path">ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ï¼è¯·å…ˆé…ç½®</span>
                            <span v-else>å…¨å±€è®¾ç½®</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" v-if="config.root_path"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info" v-if="!config.root_path">
                            <i class="fa-solid fa-circle-info"></i> åˆæ¬¡ä½¿ç”¨ï¼Œè¯·è®¾ç½®éœ€è¦ç®¡ç†çš„<b>æ ¹ç›®å½•è·¯å¾„</b>ï¼ˆå¿…å¡«ï¼‰ã€‚
                            <div class="mt-1 small">å›¾æ ‡åº“å’Œ AI åŠŸèƒ½å‡ä¸ºé€‰å¡«é¡¹ï¼Œå¯ç¨åé…ç½®ã€‚</div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-bold">æ ¹ç›®å½•è·¯å¾„ <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" v-model="config.root_path" placeholder="ä¾‹å¦‚: D:\MyData">
                                <button class="btn btn-outline-secondary" type="button" @click="selectFolder">
                                    <i class="fa-regular fa-folder-open"></i> é€‰æ‹©
                                </button>
                            </div>
                        </div>


                        
                        <label class="form-label fw-bold">å›¾æ ‡åº“ç®¡ç† <span class="fw-normal text-muted small">ï¼ˆé€‰å¡«ï¼‰</span></label>
                        <table class="table table-bordered table-sm">
                            <thead>
                                <tr>
                                    <th>å›¾æ ‡åˆ«å</th>
                                    <th>ICO è·¯å¾„</th>
                                    <th width="50">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(icon, idx) in config.icons">
                                    <td><input type="text" class="form-control form-control-sm" v-model="icon.name"></td>
                                    <td><input type="text" class="form-control form-control-sm" v-model="icon.path"></td>
                                    <td><button class="btn btn-danger btn-sm" @click="removeIcon(idx)">Ã—</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <button class="btn btn-outline-primary btn-sm" @click="addIcon">+ æ·»åŠ æ–°å›¾æ ‡</button>

                        <div class="mt-4 mb-4">
                            <label class="form-label fw-bold">å›¾æ ‡ç¼“å­˜æ¨¡å¼</label>
                            <div class="d-flex gap-3 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="emojiMode" id="modeGlobal" value="global" v-model="config.emoji_save_mode">
                                    <label class="form-check-label" for="modeGlobal">å…¨å±€æŒ‡å®šç›®å½• (Global)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="emojiMode" id="modeRelative" value="relative" v-model="config.emoji_save_mode">
                                    <label class="form-check-label" for="modeRelative">æ ¹ç›®å½•å†…ç›¸å¯¹è·¯å¾„ (Root Relative)</label>
                                </div>
                            </div>

                            <!-- Global Mode Input -->
                            <div class="input-group" v-if="config.emoji_save_mode === 'global'">
                                <input type="text" class="form-control" v-model="config.emoji_global_dir" placeholder="ä¾‹å¦‚: .../emoji_cache">
                                <button class="btn btn-outline-secondary" type="button" @click="selectEmojiCacheFolder">
                                    <i class="fa-regular fa-folder-open"></i> é€‰æ‹©
                                </button>
                            </div>
                            <div class="form-text text-muted" v-if="config.emoji_save_mode === 'global'">
                                æ‰€æœ‰é¡¹ç›®çš„å›¾æ ‡éƒ½å°†ä¿å­˜åœ¨æ­¤ç»Ÿä¸€ç›®å½•ä¸­ï¼Œä¸å—æ ¹ç›®å½•åˆ‡æ¢å½±å“ã€‚
                            </div>

                            <!-- Relative Mode Input -->
                            <div class="input-group" v-if="config.emoji_save_mode === 'relative'">
                                <span class="input-group-text">[[ config.root_path || 'å½“å‰æ ¹ç›®å½•' ]]\</span>
                                <input type="text" class="form-control" v-model="config.emoji_relative_name" placeholder=".emoji_cache">
                            </div>
                            <div class="form-text text-muted" v-if="config.emoji_save_mode === 'relative'">
                                å›¾æ ‡å°†ä¿å­˜åœ¨å½“å‰ç®¡ç†çš„æ ¹ç›®å½•ä¸‹çš„æŒ‡å®šå­æ–‡ä»¶å¤¹ä¸­ã€‚åˆ‡æ¢æ ¹ç›®å½•æ—¶ï¼Œç¼“å­˜ä½ç½®ä¹Ÿä¼šéšä¹‹æ”¹å˜ã€‚
                            </div>
                        </div>

                        <hr class="my-4">
                        
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label fw-bold mb-0">
                                <i class="fa-solid fa-robot text-primary"></i> AI è‡ªåŠ¨å‘½åé…ç½®
                                <span class="fw-normal text-muted small" v-if="!config.ai_config.enabled">ï¼ˆé€‰å¡«ï¼‰</span>
                            </label>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" v-model="config.ai_config.enabled" id="aiEnabled">
                                <label class="form-check-label" for="aiEnabled">å¯ç”¨åŠŸèƒ½</label>
                            </div>
                        </div>

                        <div v-if="config.ai_config.enabled" class="bg-light p-3 rounded border">
                            <div class="mb-3">
                                <label class="form-label fw-bold small text-muted">é€‰æ‹©æä¾›å•† (Provider)</label>
                                <div class="d-flex gap-2">
                                    <select class="form-select" v-model="config.ai_config.active_provider" :class="{'is-invalid': !config.ai_config.providers || config.ai_config.providers.length === 0}">
                                        <option v-for="p in config.ai_config.providers" :value="p.name">[[ p.name ]]</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" @click="addProvider" title="æ·»åŠ æ–°æä¾›å•†">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" 
                                            @click="removeProvider" 
                                            :disabled="!config.ai_config.providers || config.ai_config.providers.length <= 1"
                                            title="åˆ é™¤å½“å‰æä¾›å•†">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback" v-if="!config.ai_config.providers || config.ai_config.providers.length === 0">
                                    è¯·æ·»åŠ è‡³å°‘ä¸€ä¸ª AI æä¾›å•†é…ç½®ã€‚
                                </div>
                            </div>

                            <div v-if="currentProvider">
                                <div class="mb-3">
                                    <label class="form-label">API Base Address</label>
                                    <input type="text" class="form-control" v-model="currentProvider.api_base" placeholder="https://api.openai.com/v1">
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">API Key</label>
                                        <div class="input-group">
                                            <input :type="showApiKey ? 'text' : 'password'" class="form-control" v-model="currentProvider.api_key" placeholder="sk-...">
                                            <button class="btn btn-outline-secondary" type="button" @click="showApiKey = !showApiKey">
                                                <i :class="showApiKey ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye'"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">æ¨¡å‹ (Model)</label>
                                        <div class="input-group">
                                            <select class="form-select" v-model="currentProvider.model">
                                                <option v-for="m in currentProvider.models" :value="m">[[ m ]]</option>
                                            </select>
                                            <button class="btn btn-outline-secondary" @click="addModel" title="æ·»åŠ æ¨¡å‹">
                                                <i class="fa-solid fa-plus"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" 
                                                    @click="removeModel" 
                                                    :disabled="!currentProvider.models || currentProvider.models.length === 0"
                                                    title="åˆ é™¤å½“å‰æ¨¡å‹">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" @click="saveConfig">ä¿å­˜è®¾ç½®</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
            <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <i :class="toast.icon" class="me-2"></i>
                    <strong class="me-auto">[[ toast.title ]]</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" style="white-space: pre-wrap;">
                    [[ toast.message ]]
                </div>
            </div>
        </div>

        <footer class="text-center text-muted mt-5 mb-3 small">
            Win Folder Manager v{{ version }} &copy; 2025
            <span class="mx-2">|</span>
            <a href="https://github.com/LinJHS/win-folder-manager" target="_blank" class="text-muted text-decoration-none">
                <i class="fa-brands fa-github"></i> GitHub
            </a>
        </footer>

    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            // å…³é”®ä¿®æ”¹ï¼šæ›´æ”¹ Vue çš„å®šç•Œç¬¦ï¼Œé¿å…ä¸ Flask Jinja2 å†²çª
            compilerOptions: {
                delimiters: ['[[', ']]']
            },
            data() {
                return {
                    config: {
                        root_path: '',
                        emoji_save_mode: 'global', // 'global' or 'relative'
                        emoji_global_dir: '',
                        emoji_relative_name: '.emoji_cache',
                        icons: [],
                        ai_config: {  // AI é…ç½®
                            enabled: false,
                            active_provider: 'SiliconFlow',
                            providers: []
                        }
                    },
                    folders: [],
                    currentFolder: {},
                    editForm: {
                        path: '',
                        alias: '',
                        infotip: '',
                        icon_path: '',
                        use_relative: true
                    },
                    modals: {
                        edit: null,
                        config: null
                    },
                    showApiKey: false,      // æ§åˆ¶ API Key æ˜¾ç¤º/éšè—
                    aiGenerating: {},       // è®°å½•æ¯ä¸ªæ–‡ä»¶å¤¹çš„ AI ç”ŸæˆçŠ¶æ€
                    batchAiGenerating: false, // æ‰¹é‡ AI ç”ŸæˆçŠ¶æ€
                    toast: { title: '', message: '', icon: '' },
                    toastInstance: null
                }
            },
            computed: {
                currentProvider() {
                    if (!this.config.ai_config?.providers) return null;
                    return this.config.ai_config.providers.find(p => p.name === this.config.ai_config.active_provider);
                }
            },
            mounted() {
                // Initialize Bootstrap Modals
                this.modals.edit = new bootstrap.Modal(document.getElementById('editModal'));
                this.modals.config = new bootstrap.Modal(document.getElementById('configModal'));
                this.toastInstance = new bootstrap.Toast(document.getElementById('liveToast'));
                
                this.loadConfig().then(() => {
                    if (!this.config.root_path) {
                        // First run: Show config modal
                        this.modals.config.show();
                    } else {
                        this.refreshFolders();
                    }
                });
            },
            methods: {
                async loadConfig() {
                    const res = await axios.get('/api/config');
                    this.config = res.data;
                    
                    // Ensure AI config structure
                    if (!this.config.ai_config) {
                        this.config.ai_config = { enabled: false, providers: [], active_provider: '' };
                    }
                    if (!this.config.ai_config.providers) {
                        this.config.ai_config.providers = [];
                    }
                },
                async saveConfig() {
                    await axios.post('/api/config', this.config);
                    this.modals.config.hide();
                    this.refreshFolders();
                },
                async refreshFolders() {
                    const res = await axios.get('/api/folders');
                    this.folders = res.data;
                },
                async openPath(path, mode) {
                    await axios.post('/api/open', { path, mode });
                },
                editFolder(folder) {
                    this.currentFolder = folder;
                    
                    // === æ™ºèƒ½åˆ«åç”Ÿæˆé€»è¾‘ ===
                    let initialAlias = folder.alias || '';
                    
                    // ä»…å½“å½“å‰æ²¡æœ‰åˆ«åæ—¶ï¼Œæ‰å°è¯•è‡ªåŠ¨ç”Ÿæˆ
                    if (!initialAlias) {
                        // æ­£åˆ™è§£é‡Šï¼š
                        // ^        : ä»å¤´å¼€å§‹åŒ¹é…
                        // (\d{6})  : æ•è·6ä½æ•°å­— (å¯¹åº” YYMMDD)
                        // _        : ç´§æ¥ç€ä¸€ä¸ªä¸‹åˆ’çº¿
                        const dateMatch = folder.name.match(/^(\d{6})_/);
                        
                        if (dateMatch) {
                            // dateMatch[1] æ‹¿åˆ°çš„å°±æ˜¯ '230214'
                            // æ ¹æ®ä½ çš„éœ€æ±‚ï¼Œæ‹¼æ¥æˆ '230214_'
                            initialAlias = dateMatch[1] + '_';
                            
                            // ğŸ’¡ å¦‚æœä½ å¸Œæœ›å˜æˆ "[230214] " è¿™ç§æ ¼å¼ï¼Œå¯ä»¥æ”¹æˆ:
                            // initialAlias = `[${dateMatch[1]}] `;
                        }
                    }

                    // Copy data to form
                    this.editForm = {
                        path: folder.path,
                        alias: initialAlias, // ä½¿ç”¨è®¡ç®—åçš„åˆå§‹å€¼
                        infotip: folder.infotip || '',
                        icon_path: folder.icon_path || '',
                        use_relative: true
                    };
                    this.modals.edit.show();
                },
                async saveFolder() {
                    await axios.post('/api/update', this.editForm);
                    this.modals.edit.hide();
                    this.refreshFolders();
                },
                async batchRelativeToAll() {
                    if(!confirm('ç¡®å®šè¦å°†æ‰€æœ‰æ–‡ä»¶å¤¹é…ç½®è½¬æ¢ä¸ºç›¸å¯¹è·¯å¾„å—ï¼Ÿ')) return;
                    const res = await axios.post('/api/batch_relative');
                    this.showToast(`å·²å¤„ç† ${res.data.count} ä¸ªæ–‡ä»¶å¤¹`, 'success');
                    this.refreshFolders();
                },
                
                // Config Icon Management
                async addIcon() {
                    try {
                        const res = await axios.post('/api/select_file');
                        if (res.data.status === 'success' && res.data.path) {
                            const path = res.data.path;
                            const ext = path.split('.').pop().toLowerCase();
                            
                            let finalPath = path;
                            // Use filename (without extension) as default name
                            let name = path.split(/[\\/]/).pop().split('.').slice(0, -1).join('.');
                            if (!name) name = 'æ–°å›¾æ ‡';
                            
                            if (ext !== 'ico') {
                                // Convert to ICO
                                this.showToast('æ­£åœ¨è½¬æ¢å›¾ç‰‡...', 'info');
                                const convRes = await axios.post('/api/convert_to_ico', { 
                                    source_path: path,
                                    // Pass current config state to ensure WYSIWYG behavior
                                    emoji_save_mode: this.config.emoji_save_mode,
                                    root_path: this.config.root_path,
                                    emoji_relative_name: this.config.emoji_relative_name,
                                    emoji_global_dir: this.config.emoji_global_dir
                                });
                                if (convRes.data.status === 'success') {
                                    finalPath = convRes.data.ico_path;
                                    this.showToast('è½¬æ¢æˆåŠŸ', 'success');
                                } else {
                                    this.showToast('è½¬æ¢å¤±è´¥: ' + convRes.data.msg, 'error');
                                    return; 
                                }
                            }
                            
                            this.config.icons.push({ name: name, path: finalPath });
                        } else {
                            // Cancelled or error, fallback to empty row
                             this.config.icons.push({ name: 'æ–°å›¾æ ‡', path: '', index: 0 });
                        }
                    } catch (e) {
                        console.error(e);
                        this.config.icons.push({ name: 'æ–°å›¾æ ‡', path: '', index: 0 });
                    }
                },
                removeIcon(index) {
                    this.config.icons.splice(index, 1);
                },

                // AI Provider Management
                addProvider() {
                    const name = prompt("è¯·è¾“å…¥æä¾›å•†åç§° (ä¾‹å¦‚: LocalLLM):");
                    if (!name) return;
                    if (this.config.ai_config.providers.find(p => p.name === name)) {
                        this.showToast("è¯¥åç§°å·²å­˜åœ¨", "error");
                        return;
                    }
                    this.config.ai_config.providers.push({
                        name: name,
                        api_base: "",
                        api_key: "",
                        model: "",
                        models: []
                    });
                    this.config.ai_config.active_provider = name;
                },
                removeProvider() {
                    if (!confirm("ç¡®å®šè¦åˆ é™¤å½“å‰æä¾›å•†é…ç½®å—ï¼Ÿ")) return;
                    const idx = this.config.ai_config.providers.findIndex(p => p.name === this.config.ai_config.active_provider);
                    if (idx > -1) {
                        this.config.ai_config.providers.splice(idx, 1);
                        // Select first available
                        if (this.config.ai_config.providers.length > 0) {
                            this.config.ai_config.active_provider = this.config.ai_config.providers[0].name;
                        }
                    }
                },
                addModel() {
                    if (!this.currentProvider) return;
                    const model = prompt("è¯·è¾“å…¥æ¨¡å‹åç§° (ä¾‹å¦‚: llama3):");
                    if (model) {
                        if (!this.currentProvider.models) this.currentProvider.models = [];
                        if (!this.currentProvider.models.includes(model)) {
                            this.currentProvider.models.push(model);
                            this.currentProvider.model = model;
                        }
                    }
                },
                removeModel() {
                    if (!this.currentProvider || !this.currentProvider.model) return;
                    if (!confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡å‹ ${this.currentProvider.model} å—ï¼Ÿ`)) return;
                    
                    const idx = this.currentProvider.models.indexOf(this.currentProvider.model);
                    if (idx > -1) {
                        this.currentProvider.models.splice(idx, 1);
                        // Select another model if available
                        this.currentProvider.model = this.currentProvider.models.length > 0 ? this.currentProvider.models[0] : '';
                    }
                },

                async selectFolder() {
                    try {
                        const res = await axios.post('/api/select_folder');
                        if (res.data.status === 'success' && res.data.path) {
                            this.config.root_path = res.data.path;
                        } else if (res.data.status === 'error') {
                            this.showToast('æ— æ³•æ‰“å¼€æ–‡ä»¶å¤¹é€‰æ‹©å™¨: ' + res.data.msg, 'error');
                        }
                    } catch (e) {
                        console.error(e);
                    }
                },
                async selectEmojiCacheFolder() {
                    try {
                        const res = await axios.post('/api/select_folder');
                        if (res.data.status === 'success' && res.data.path) {
                            this.config.emoji_global_dir = res.data.path;
                        } else if (res.data.status === 'error') {
                            this.showToast('æ— æ³•æ‰“å¼€æ–‡ä»¶å¤¹é€‰æ‹©å™¨: ' + res.data.msg, 'error');
                        }
                    } catch (e) {
                        console.error(e);
                    }
                },
                showConfigModal() {
                    this.modals.config.show();
                },
                
                // Helpers
                showToast(message, type = 'info') {
                    this.toast.message = message;
                    if (type === 'success') {
                        this.toast.title = 'æˆåŠŸ';
                        this.toast.icon = 'fa-solid fa-check-circle text-success';
                    } else if (type === 'error') {
                        this.toast.title = 'é”™è¯¯';
                        this.toast.icon = 'fa-solid fa-circle-exclamation text-danger';
                    } else {
                        this.toast.title = 'æç¤º';
                        this.toast.icon = 'fa-solid fa-info-circle text-info';
                    }
                    this.toastInstance.show();
                },

                getIconAlias(path) {
                    if (!path) return '';
                    
                    // === å¼ºåŠ›æ ‡å‡†åŒ–å‡½æ•° ===
                    // 1. å°†æ‰€æœ‰åæ–œæ  \ æ›¿æ¢ä¸º æ­£æ–œæ  /
                    // 2. å°†è¿ç»­çš„æ–œæ  // æ›¿æ¢ä¸º å•ä¸ª / (å®¹é”™)
                    // 3. è½¬ä¸ºå…¨å°å†™ (Windows ä¸åŒºåˆ†å¤§å°å†™)
                    // 4. å»é™¤é¦–å°¾ç©ºæ ¼
                    const standardize = (p) => {
                        if (!p) return '';
                        return p.toString()
                                .replace(/\\/g, '/')   // æ›¿æ¢ \ ä¸º /
                                .replace(/\/+/g, '/')  // æ›¿æ¢ // ä¸º /
                                .toLowerCase()         // è½¬å°å†™
                                .trim();               // å»ç©ºæ ¼
                    };

                    // 1. è·å–å½“å‰æ–‡ä»¶å¤¹çš„æ ‡å‡†åŒ–å›¾æ ‡è·¯å¾„
                    const currentPath = standardize(path);

                    // 2. éå†é…ç½®åˆ—è¡¨ï¼Œé€ä¸ªå¯¹æ¯”
                    const found = this.config.icons.find(i => {
                        const configPath = standardize(i.path);
                        return currentPath === configPath;
                    });
                    
                    return found ? found.name : '';
                },

                // AI ç”Ÿæˆæ–¹æ³•
                async aiQuickGenerate(folder) {
                    // æ£€æŸ¥æœ¬åœ°é…ç½®æ˜¯å¦å·²å¯ç”¨ï¼Œä¸å†æ£€æŸ¥ Key (åç«¯æ£€æŸ¥)
                    if (!this.config.ai_config?.enabled) {
                        this.showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­å¯ç”¨ AI åŠŸèƒ½', 'error');
                        return;
                    }

                    // Vue 3 ç›´æ¥èµ‹å€¼å³å¯
                    this.aiGenerating[folder.path] = true;
                    try {
                        // ä¸å†å‘é€ ai_configï¼Œåç«¯ä½¿ç”¨å­˜å‚¨çš„é…ç½®
                        const res = await axios.post('/api/ai_generate', {
                            folder_name: folder.name
                        });

                        if (res.data.status === 'success') {
                            const iconRes = await axios.post('/api/emoji_to_ico', {
                                emoji: res.data.emoji,
                                folder_path: folder.path
                            });

                            await axios.post('/api/update', {
                                path: folder.path,
                                alias: res.data.alias,
                                infotip: res.data.infotip,
                                icon_path: iconRes.data.ico_path,
                                use_relative: true
                            });

                            await this.refreshFolders();
                            this.showToast(`å·²ç”Ÿæˆ: ${res.data.alias}`, 'success');
                        } else {
                            this.showToast('AI ç”Ÿæˆå¤±è´¥: ' + res.data.msg, 'error');
                        }
                    } catch (e) {
                        this.showToast('è¯·æ±‚å¤±è´¥: ' + (e.response?.data?.msg || e.message), 'error');
                    } finally {
                        this.aiGenerating[folder.path] = false;
                    }
                },

                async batchAiGenerate() {
                    if (!this.config.ai_config?.enabled) {
                        this.showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­å¯ç”¨ AI åŠŸèƒ½', 'error');
                        return;
                    }

                    if (!confirm('ç¡®å®šè¦ AI æ‰¹é‡ç”Ÿæˆæ‰€æœ‰æœªå‘½åæ–‡ä»¶å¤¹å—ï¼Ÿ')) return;

                    this.batchAiGenerating = true;
                    try {
                        // ä¸å†å‘é€ ai_config
                        const res = await axios.post('/api/batch_ai_generate', {
                            batch_size: 5
                        });

                        if (res.data.status === 'success') {
                            let msg = `å·²å¤„ç† ${res.data.count} ä¸ªæ–‡ä»¶å¤¹`;
                            if (res.data.errors.length > 0) {
                                msg += ` (å¤±è´¥ ${res.data.errors.length} ä¸ª):\n`;
                                // æ˜¾ç¤ºå‰ 3 ä¸ªé”™è¯¯
                                msg += res.data.errors.slice(0, 3).join('\n');
                                if (res.data.errors.length > 3) {
                                    msg += `\n...ä»¥åŠå…¶ä»– ${res.data.errors.length - 3} ä¸ªé”™è¯¯`;
                                }
                            }
                            
                            let type = 'success';
                            if (res.data.count === 0 && res.data.errors.length > 0) {
                                type = 'error';
                            } else if (res.data.errors.length > 0) {
                                type = 'warning';
                            }

                            this.showToast(msg, type);
                            await this.refreshFolders();
                        } else {
                            this.showToast('æ‰¹é‡ç”Ÿæˆå¤±è´¥: ' + res.data.msg, 'error');
                        }
                    } catch (e) {
                        this.showToast('è¯·æ±‚å¤±è´¥: ' + (e.response?.data?.msg || e.message), 'error');
                    } finally {
                        this.batchAiGenerating = false;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>