name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string
      reason:
        description: 'Reason for manual release'
        required: false
        default: 'Manual release testing'
      dry_run:
        description: 'Dry run (skip actual publishing)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  UV_CACHE_DIR: .uv-cache
  UV_SYSTEM_PYTHON: 1

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      release_exists: ${{ steps.check_release.outputs.exists }}

    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Check if release already exists
      id: check_release
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${{ github.ref_name }}"
        fi

        if gh release view "$VERSION" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "[WARNING] Release $VERSION already exists"
          exit 0
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "[OK] No existing release found for $VERSION"
        fi
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Validate version
      id: version
      if: steps.check_release.outputs.exists != 'true'
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${{ github.ref_name }}"
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT

        if [[ "$VERSION" =~ (alpha|beta|rc) ]]; then
          echo "is_prerelease=true" >> $GITHUB_OUTPUT
        else
          echo "is_prerelease=false" >> $GITHUB_OUTPUT
        fi

        echo "[INFO] Release version: $VERSION"

    - name: Check changelog
      run: |
        if [ -f "CHANGELOG.md" ] || [ -f "HISTORY.rst" ]; then
          echo "[OK] Changelog found"
        else
          echo "[WARNING] No changelog found"
        fi

  build:
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.release_exists != 'true'
    timeout-minutes: 15

    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
        enable-cache: true
        cache-dependency-glob: "pyproject.toml"

    - name: Set up Python
      run: uv python install 3.13

    - name: Build package
      run: |
        uv build
        echo "[OK] Package built"

    - name: Validate package
      env:
        UV_SYSTEM_PYTHON: "0"  # Override global setting to use venv
      run: |
        # Create venv for validation with pip included
        uv venv .venv --seed
        source .venv/bin/activate
        pip install twine
        twine check dist/* --strict

        echo "[INFO] Package files:"
        ls -la dist/

        # Test wheel installation in separate venv
        deactivate
        uv venv test_env --seed
        source test_env/bin/activate
        pip install dist/*.whl
        python -c "import xpcsviewer; print(f'[OK] Version: {xpcsviewer.__version__}')"
        deactivate
        rm -rf test_env .venv

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-release-${{ github.sha }}
        path: dist/
        retention-days: 90

  test-release:
    runs-on: ${{ matrix.os }}
    needs: [validate, build]
    if: needs.validate.outputs.release_exists != 'true'
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.13"]
        include:
          - os: ubuntu-latest
            python-version: "3.12"

    steps:
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
        enable-cache: false  # No checkout, no cache dependency file

    - name: Set up Python ${{ matrix.python-version }}
      run: uv python install ${{ matrix.python-version }}

    - name: Download build artifacts
      uses: actions/download-artifact@v5
      with:
        name: dist-release-${{ github.sha }}
        path: dist/

    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          libgl1-mesa-dri libegl1-mesa-dev libxrandr2 libxss1 \
          libxcursor1 libxcomposite1 libasound2t64 libxi6 libxtst6 \
          xvfb

    - name: Create test venv and install wheel
      env:
        UV_SYSTEM_PYTHON: "0"
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
      shell: bash
      run: |
        uv venv test_env --python ${{ matrix.python-version }} --seed
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          source test_env/Scripts/activate
        else
          source test_env/bin/activate
        fi
        pip install dist/*.whl
        python -c "import xpcsviewer; print(f'[OK] XPCS Viewer {xpcsviewer.__version__} installed')"

    - name: Test CLI commands
      env:
        QT_QPA_PLATFORM: offscreen
        DISPLAY: ":99"
      shell: bash
      run: |
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          Xvfb :99 -screen 0 1024x768x24 &
          sleep 2
        fi

        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          source test_env/Scripts/activate
        else
          source test_env/bin/activate
        fi

        echo "[INFO] Testing CLI commands..."
        xpcsviewer-gui --help || echo "[WARNING] xpcsviewer-gui command failed"
        xpcsviewer --help || echo "[WARNING] xpcsviewer command failed"
        echo "[OK] CLI command tests completed"

    - name: Test basic import
      env:
        QT_QPA_PLATFORM: offscreen
      shell: bash
      run: |
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          source test_env/Scripts/activate
        else
          source test_env/bin/activate
        fi

        python -c "
        import xpcsviewer
        from xpcsviewer.file_locator import FileLocator
        from xpcsviewer.viewer_kernel import ViewerKernel
        print('[OK] Core modules import successfully')
        print(f'[INFO] Version: {xpcsviewer.__version__}')
        "

  github-release:
    runs-on: ubuntu-latest
    needs: [validate, build, test-release]
    if: needs.validate.outputs.release_exists != 'true' && (startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch') && github.event.inputs.dry_run != 'true'
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v5

    - name: Download build artifacts
      uses: actions/download-artifact@v5
      with:
        name: dist-release-${{ github.sha }}
        path: dist/

    - name: Extract release notes
      id: extract_notes
      run: |
        if [ -f "CHANGELOG.md" ]; then
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          awk '/^## \[?v?[0-9]/{if(found) exit; if($0 ~ /${{ needs.validate.outputs.version }}/) found=1; next} found' CHANGELOG.md | head -20 >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        elif [ -f "HISTORY.rst" ]; then
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          head -20 HISTORY.rst >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "RELEASE_NOTES=üéâ New release of XPCS Viewer!" >> $GITHUB_OUTPUT
        fi

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.validate.outputs.version }}
        name: "XPCS Viewer ${{ needs.validate.outputs.version }}"
        body: |
          ## üöÄ XPCS Viewer ${{ needs.validate.outputs.version }}

          ### üì• Installation
          ```bash
          pip install xpcsviewer-gui==${{ needs.validate.outputs.version }}
          ```

          ### üöÄ Quick Start
          ```bash
          xpcsviewer-gui path_to_hdf_directory
          # Aliases: pyxpcsviewer, xpcs-toolkit, xpcs-viewer
          ```

          ### üìù Changes
          ${{ steps.extract_notes.outputs.RELEASE_NOTES }}

          ### üì¶ Package Files
          - **Source Distribution**: `xpcsviewer_gui-*.tar.gz`
          - **Universal Wheel**: `xpcsviewer_gui-*-py3-none-any.whl`

          ### üîó Links
          - [Documentation](https://github.com/imewei/xpcsviewer/tree/master/docs)
          - [Issues](https://github.com/imewei/xpcsviewer/issues)
          - [PyPI Package](https://pypi.org/project/xpcsviewer-gui/)
        files: dist/*
        draft: false
        prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
        generate_release_notes: true

  pypi-publish:
    runs-on: ubuntu-latest
    needs: [validate, build, test-release, github-release]
    if: needs.validate.outputs.release_exists != 'true' && startsWith(github.ref, 'refs/tags/') && needs.validate.outputs.is_prerelease == 'false' && github.event.inputs.dry_run != 'true' && github.repository_owner == 'imewei'
    environment:
      name: pypi
      url: https://pypi.org/p/xpcsviewer-gui
    timeout-minutes: 10

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v5
      with:
        name: dist-release-${{ github.sha }}
        path: dist/

    - name: Verify package before upload
      run: |
        ls -la dist/
        echo "[INFO] Package contents:"
        for file in dist/*; do
          echo "  $(basename "$file"): $(stat -c%s "$file" | numfmt --to=iec)B"
        done

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        verify-metadata: true
        verbose: true
        print-hash: true

  test-pypi-publish:
    runs-on: ubuntu-latest
    needs: [validate, build, test-release]
    if: needs.validate.outputs.release_exists != 'true' && ((startsWith(github.ref, 'refs/tags/') && needs.validate.outputs.is_prerelease == 'true') || github.event.inputs.dry_run == 'true') && github.repository_owner == 'imewei'
    environment:
      name: testpypi
      url: https://test.pypi.org/p/xpcsviewer-gui
    timeout-minutes: 10

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v5
      with:
        name: dist-release-${{ github.sha }}
        path: dist/

    - name: Publish to Test PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        verify-metadata: true
        verbose: true
        print-hash: true

  release-status:
    runs-on: ubuntu-latest
    needs: [validate, build, test-release, github-release, pypi-publish, test-pypi-publish]
    if: always()

    steps:
    - name: Release Summary
      shell: bash
      run: |
        echo "[INFO] Release Workflow Summary"
        echo "================================"
        echo "[INFO] Version: ${{ needs.validate.outputs.version }}"
        echo "[INFO] Pre-release: ${{ needs.validate.outputs.is_prerelease }}"
        echo "[INFO] Build: ${{ needs.build.result }}"
        echo "[INFO] Tests: ${{ needs.test-release.result }}"
        echo "[INFO] GitHub Release: ${{ needs.github-release.result }}"
        echo "[INFO] PyPI: ${{ needs.pypi-publish.result || 'skipped' }}"

        if [ "${{ needs.build.result }}" = "failure" ] || [ "${{ needs.test-release.result }}" = "failure" ]; then
          echo "[ERROR] Release failed"
          exit 1
        else
          echo "[SUCCESS] Release completed successfully!"
        fi
