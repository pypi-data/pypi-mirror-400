---
title: "{{ outline.title }}"
format:
  {{ format }}:
    toc: {{ 'true' if options.toc else 'false' }}
    css: styles.css
    theme:
      light: flatly
      dark: darkly
    mainfont: system-ui, -apple-system, sans-serif
    fontsize: 1rem
    linestretch: 1.75
{% if options.code_folding %}
    code-fold: true
{% endif %}
---

{% set citation_map = hints.get('citation_map', {}) if hints else {} %}
{% set citation_details = hints.get('citation_details', {}) if hints else {} %}
{% set query_provenance = query_provenance if query_provenance else (hints.get('query_provenance', {}) if hints else {}) %}

{% if outline.metadata.get('summary') %}
{{ outline.metadata.summary }}
{% endif %}

{% if outline.metadata.get('template') == 'analyst_v1' %}
{# Analyst mode rendering #}

{# Executive Summary Section #}
{% set exec_summary_ids = outline.metadata.get('executive_summary_insight_ids', []) %}
{% if not exec_summary_ids %}
  {# Auto-select high-importance insights #}
  {% set exec_summary_ids = [] %}
  {% for insight in outline.insights %}
    {% if insight.importance >= 8 %}
      {% set exec_summary_ids = exec_summary_ids + [insight.insight_id] %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if exec_summary_ids|length > 0 %}
## Executive Summary

{% for insight_id in exec_summary_ids %}
{% set insight = outline.get_insight(insight_id) %}
{% if insight %}
{% set exec_id = insight.supporting_queries[0].execution_id if insight.supporting_queries and insight.supporting_queries|length > 0 else None %}
{% set citation_num = citation_map.get(exec_id) if exec_id else None %}
{{ insight.summary }}{% if citation_num %} [{{ citation_num }}]{% endif %}

{% endif %}
{% endfor %}

{% endif %}

{# Standard sections in fixed order #}
{% set section_order = ['Network Activity', 'DEX Trading', 'Objects', 'Events'] %}
{% for section_title in section_order %}
{% for section in outline.sections %}
{% if section.title == section_title %}

## {{ section.title }}

{% set prose = section.content if section.content else section.notes %}
{% if prose %}
{% if section.content and section.content_format == 'html' %}
{{ section.content | safe }}
{% else %}
{{ prose }}
{% endif %}
{% endif %}

{% for insight_id in section.insight_ids %}
{% set insight = outline.get_insight(insight_id) %}
{% if insight %}
{% set references = insight.citations if insight.citations else insight.supporting_queries %}
{% set exec_id = references[0].execution_id if references and references|length > 0 else None %}
{% set citation_num = citation_map.get(exec_id) if exec_id else None %}
{{ insight.summary }}{% if citation_num %} [{{ citation_num }}]{% endif %}

{% endif %}
{% endfor %}

{% endif %}
{% endfor %}
{% endfor %}

{# Data Sources Appendix with Citation Grouping #}
{% if citation_map|length > 0 %}
## Appendix: Data Sources

### Query Executions
{% set sorted_citations = citation_map.items() | sort(attribute='1') %}
{% for exec_id, citation_num in sorted_citations %}
[{{ citation_num }}] `{{ exec_id }}`
{% set details = citation_details.get(exec_id, {}) %}
{% if details.timestamp %}  - Executed: {{ details.timestamp }}{% endif %}
{% if details.duration_ms %}  - Duration: {{ "%.2f"|format(details.duration_ms / 1000.0) }}s{% endif %}
{% if details.rowcount is not none and details.rowcount is defined %}  - Rows: {{ "{:,}"|format(details.rowcount) }}{% endif %}
{% if details.statement_preview %}  - SQL: `{{ details.statement_preview[:80] }}{% if details.statement_preview|length > 80 %}...{% endif %}`{% endif %}

{% endfor %}

{% endif %}

{% else %}
{# Default rendering mode #}
{% set sorted_sections = outline.sections %}
{% if sorted_sections|length > 0 %}
## Table of Contents

{% for section in sorted_sections %}
- [{{ section.title }}](#section-{{ section.section_id }})
{% endfor %}
{% if query_provenance %}
- [Data Sources](#data-sources)
{% endif %}

{% endif %}
{% for section in outline.sections %}
<a id="section-{{ section.section_id }}"></a>
## {{ section.title }}

{% set prose = section.content if section.content else section.notes %}
{% if prose %}
{% if section.content and section.content_format == 'html' %}
{{ section.content | safe }}
{% else %}
{{ prose }}
{% endif %}
{% endif %}

{% for insight_id in section.insight_ids %}
{% set insight = outline.get_insight(insight_id) %}
{% if insight %}

### {{ insight.summary }}

**Importance:** {{ insight.importance }}/10

{% if insight.metadata and insight.metadata.get('chart_id') %}
{# Render attached chart #}
{% set chart_id = insight.metadata.chart_id %}
{% set chart_meta = outline.metadata.get('charts', {}).get(chart_id, {}) %}
{% if chart_meta %}
![{{ chart_meta.get('description', 'Chart') }}]({{ chart_meta.path }})
{% endif %}
{% elif insight.draft_changes and insight.draft_changes.get('type') == 'table' %}
```{python}
# Table data for {{ insight.insight_id }}
import pandas as pd

# Placeholder table - replace with actual dataset query results
data = {
    "Metric": ["Value 1", "Value 2", "Value 3"],
    "Count": [10, 20, 30],
    "Percentage": [33.3, 66.7, 100.0]
}
df = pd.DataFrame(data)
print(df.to_markdown(index=False))
```
{% else %}
**Supporting Data:**

{% for query in insight.supporting_queries %}
{% set exec_id = query.execution_id %}
{% set provenance = query_provenance.get(exec_id) if query_provenance else None %}
{% if exec_id %}
- **Query Execution**: `{{ exec_id }}`
  {% if provenance %}
  - Executed: {{ provenance.timestamp or 'Unknown time' }}
  {% if provenance.duration_ms %}  - Duration: {{ "%.2f"|format(provenance.duration_ms / 1000.0) }}s{% endif %}
  {% if provenance.rowcount is not none and provenance.rowcount is defined %}  - Rows returned: {{ "{:,}"|format(provenance.rowcount) }}{% endif %}
  {% if provenance.status %}  - Status: {{ provenance.status }}{% endif %}
  {% if provenance.statement_preview %}  - SQL Preview: `{{ provenance.statement_preview[:100] }}{% if provenance.statement_preview|length > 100 %}...{% endif %}`{% endif %}
  {% endif %}
  {% if query.sql_sha256 %}  - SQL Hash: `{{ query.sql_sha256[:16] }}...`{% endif %}
{% elif query.sql_sha256 %}
- **SQL Hash**: `{{ query.sql_sha256[:16] }}...`
{% else %}
- **Dataset**: Unknown source
{% endif %}
{% endfor %}

{% if insight.supporting_queries|length == 0 %}
*No supporting queries available*
{% endif %}
{% endif %}

{% endif %}
{% endfor %}
{% endfor %}
{% endif %}

{% if query_provenance %}
<a id="data-sources"></a>
## Data Sources

{% for exec_id, details in query_provenance.items() %}
- `{{ exec_id }}`{% if details.timestamp %} â€” Executed: {{ details.timestamp }}{% endif %}{% if details.duration_ms %} | Duration: {{ "%.2f"|format(details.duration_ms / 1000.0) }}s{% endif %}{% if details.rowcount is not none and details.rowcount is defined %} | Rows: {{ "{:,}"|format(details.rowcount) }}{% endif %}
  {% if details.statement_preview %}`{{ details.statement_preview[:120] }}{% if details.statement_preview|length > 120 %}...{% endif %}`{% endif %}
{% endfor %}

{% endif %}
