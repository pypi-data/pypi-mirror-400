# システム概要仕様書

**文書番号:** SPEC-001  

**バージョン:** 1.0  

**作成日:** 2025-11-02  

**最終更新:** 2025-11-02

---

## 1. システム概要

### 1.1 プロダクト名

**Tree-sitter Analyzer** - AI時代のエンタープライズグレードコード解析ツール

### 1.2 プロダクト概要

Tree-sitter Analyzerは、tree-sitterパーサーを基盤とした多言語対応のコード解析ツールである。AI統合（MCPプロトコル）、高速検索（fd/ripgrep）、包括的な言語サポートを特徴とし、開発者とAIアシスタントの協業を促進する。

### 1.3 ターゲットユーザー

| ユーザー分類         | 特徴                     | 主な利用シーン                     |
| -------------------- | ------------------------ | ---------------------------------- |
| **AIツールユーザー** | Claude、Cursor等を使用   | AIとの対話でコード理解・操作       |
| **CLI開発者**        | コマンドライン愛好者     | スクリプト統合、自動化             |
| **個人開発者**       | 中小規模プロジェクト管理 | コードベース把握、リファクタリング |
| **開発チーム**       | チーム開発環境           | コードレビュー、品質管理           |
| **OSS貢献者**        | プラグイン開発           | 言語拡張、カスタマイズ             |

### 1.4 主要価値提案

#### 価値1: 深いAI統合

- MCPプロトコル完全サポート
- トークン制限を突破するSMART要約
- 自然言語でのコード操作

#### 価値2: 強力な検索機能

- fd統合による高速ファイル検索
- ripgrep統合による全文検索
- 2段階インテリジェント検索

#### 価値3: 多言語対応

- **17言語の完全サポート**（実装済み）
- C/C++、Go、Rust、Kotlin等のシステム言語対応
- HTML/CSS完全対応
- プラグインによる拡張性
- **注:** Python, Java, JavaScript, TypeScript, C, C++, C#, Go, Rust, Kotlin, PHP, Ruby, SQL, YAML, CSS, HTML, Markdown

---

## 2. システムアーキテクチャ

### 2.1 高レベルアーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    ユーザーインターフェース              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │ MCPクライアント│  │  CLIツール   │  │  Python API  │ │
│  │ (Claude等)    │  │  (CLI)       │  │  (直接呼出)  │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                    統合レイヤー                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  MCPサーバー  │  │ CLIコマンド  │  │   公開API    │ │
│  │  (MCP)       │  │  (argparse)  │  │  (Python)    │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                    コアサービス層                        │
│  ┌─────────────────┐  ┌─────────────────────────────┐  │
│  │ 解析サービス     │  │  検索サービス               │  │
│  │ - QueryService  │  │  - FileSearchService        │  │
│  │ - AsyncQuery    │  │  - ContentSearchService     │  │
│  └─────────────────┘  └─────────────────────────────┘  │
│  ┌─────────────────┐  ┌─────────────────────────────┐  │
│  │ キャッシュ管理   │  │  セキュリティ              │  │
│  │ - CacheManager  │  │  - PathValidator           │  │
│  │ - LRU戦略       │  │  - AccessControl           │  │
│  └─────────────────┘  └─────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                    言語プラグイン層                      │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐        │
│  │ Java │ │Python│ │  JS  │ │  TS  │ │ HTML │  ...   │
│  │Plugin│ │Plugin│ │Plugin│ │Plugin│ │Plugin│        │
│  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘        │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│                    基盤レイヤー                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │ tree-sitter  │  │      fd      │  │   ripgrep    │ │
│  │   (Parser)   │  │(File Search) │  │  (Content)   │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 2.2 データフロー

#### 2.2.1 解析フロー

```
1. ユーザーリクエスト
   ↓
2. パス検証（セキュリティ）
   ↓
3. キャッシュ確認
   ├─ ヒット → キャッシュ返却
   └─ ミス → 4へ
   ↓
4. 言語プラグイン選択
   ↓
5. tree-sitter解析
   ↓
6. コード要素抽出
   ↓
7. 統一要素変換（UnifiedElement）
   ↓
8. メトリクス計算
   ↓
9. キャッシュ保存
   ↓
10. 結果返却（JSON/YAML/Text）
```

#### 2.2.2 検索フロー

```
【ファイル検索】
1. パターン受取
   ↓
2. プロジェクトルート検出
   ↓
3. fd実行
   ↓
4. 結果フィルタリング
   ↓
5. 返却

【コンテンツ検索】
1. クエリ受取
   ↓
2. ripgrep実行
   ↓
3. 結果パース
   ↓
4. グループ化（オプション）
   ↓
5. 返却

【複合検索】
1. ファイル検索実行
   ↓
2. 候補ファイル取得
   ↓
3. コンテンツ検索実行（候補内）
   ↓
4. 結果マージ
   ↓
5. 返却
```

---

## 3. 主要機能概要

### 3.1 機能マップ

```
Tree-sitter Analyzer
├─ コード解析機能
│  ├─ 構文解析
│  ├─ 構造抽出（クラス、関数、メソッド等）
│  ├─ 複雑度計算
│  ├─ 統一要素システム
│  └─ 多言語サポート（17言語: Python, Java, JS, TS, C, C++, C#, Go, Rust, Kotlin, PHP, Ruby, SQL, YAML, CSS, HTML, Markdown）
│
├─ AI統合機能（MCP）
│  ├─ MCPサーバー（2実装: 公開版8ツール、テスト版9ツール）
│  ├─ 8つのMCPツール（公開版）
│  ├─ SMART要約
│  └─ トークン最適化
│
├─ CLI機能
│  ├─ tree-sitter-analyzer（メイン）
│  ├─ list-files（ファイル検索）
│  ├─ search-content（コンテンツ検索）
│  ├─ find-and-grep（複合検索）
│  └─ 出力制御（JSON/YAML/Text/File）
│
├─ 検索機能
│  ├─ ファイル検索（fd統合）
│  ├─ コンテンツ検索（ripgrep統合）
│  └─ 複合検索
│
├─ パフォーマンス最適化
│  ├─ キャッシュシステム
│  ├─ 非同期処理
│  └─ ストリーミング処理
│
└─ セキュリティ機能
   ├─ パストラバーサル防止
   ├─ プロジェクト境界保護
   └─ アクセス権限検証
```

### 3.2 機能一覧表

| 機能ID | 機能名                    | 優先度 | ステータス |
| ------ | ------------------------- | ------ | ---------- |
| F-001  | コード構文解析            | 必須   | ✅ 実装済  |
| F-002  | 多言語サポート            | 必須   | ✅ 実装済  |
| F-003  | MCPプロトコル統合         | 必須   | ✅ 実装済  |
| F-004  | CLIツール                 | 必須   | ✅ 実装済  |
| F-005  | ファイル検索（fd）        | 高     | ✅ 実装済  |
| F-006  | コンテンツ検索（ripgrep） | 高     | ✅ 実装済  |
| F-007  | キャッシュシステム        | 高     | ✅ 実装済  |
| F-008  | セキュリティ保護          | 必須   | ✅ 実装済  |
| F-009  | 非同期処理                | 中     | ✅ 実装済  |
| F-010  | プラグインシステム        | 高     | ✅ 実装済  |

---

## 4. 技術スタック

### 4.1 コア技術

| 技術            | バージョン | 用途                 |
| --------------- | ---------- | -------------------- |
| **Python**      | 3.10+      | 実装言語             |
| **tree-sitter** | 0.25.0+    | 構文解析エンジン     |
| **MCP**         | 1.12.3+    | AI統合プロトコル     |
| **pytest**      | 8.4.1+     | テストフレームワーク |

### 4.2 言語パーサー

| 言語       | パッケージ             | バージョン | プラグイン実装 |
| ---------- | ---------------------- | ---------- | -------------- |
| Java       | tree-sitter-java       | 0.23.5+    | ✅ 実装済       |
| Python     | tree-sitter-python     | 0.23.6+    | ✅ 実装済       |
| JavaScript | tree-sitter-javascript | 0.23.1+    | ✅ 実装済       |
| TypeScript | tree-sitter-typescript | 0.23.2+    | ✅ 実装済       |
| C          | tree-sitter-c          | 0.20.0+    | ✅ 実装済       |
| C++        | tree-sitter-cpp        | 0.23.4+    | ✅ 実装済       |
| C#         | tree-sitter-c-sharp    | 0.23.1+    | ✅ 実装済       |
| Go         | tree-sitter-go         | 0.20.0+    | ✅ 実装済       |
| Rust       | tree-sitter-rust       | 0.20.0+    | ✅ 実装済       |
| Kotlin     | tree-sitter-kotlin     | 0.3.0+     | ✅ 実装済       |
| PHP        | tree-sitter-php        | 0.24.1+    | ✅ 実装済       |
| Ruby       | tree-sitter-ruby       | 0.23.1+    | ✅ 実装済       |
| SQL        | tree-sitter-sql        | 0.3.11+    | ✅ 実装済       |
| YAML       | tree-sitter-yaml       | 0.7.0+     | ✅ 実装済       |
| HTML       | tree-sitter-html       | 0.23.0+    | ✅ 実装済       |
| CSS        | tree-sitter-css        | 0.23.0+    | ✅ 実装済       |
| Markdown   | tree-sitter-markdown   | 0.3.1+     | ✅ 実装済       |

### 4.3 外部ツール

| ツール      | バージョン | 用途               |
| ----------- | ---------- | ------------------ |
| **fd**      | 10.3.0+    | 高速ファイル検索   |
| **ripgrep** | 14.1.1+    | 高速コンテンツ検索 |
| **uv**      | latest     | パッケージ管理     |

### 4.4 開発ツール

| ツール         | 用途                 |
| -------------- | -------------------- |
| **mypy**       | 型チェック           |
| **ruff**       | リント、フォーマット |
| **black**      | コードフォーマット   |
| **isort**      | import整理           |
| **bandit**     | セキュリティスキャン |
| **pytest-cov** | カバレッジ測定       |

---

## 5. 非機能要件

### 5.1 パフォーマンス

| 項目                   | 要件                  | 測定方法         |
| ---------------------- | --------------------- | ---------------- |
| **解析速度**           | 10,000行/秒           | ベンチマーク     |
| **起動時間**           | < 1秒                 | 手動測定         |
| **メモリ使用量**       | ファイルサイズ×5以内  | プロファイリング |
| **キャッシュヒット率** | > 80%（繰返し解析時） | ログ分析         |

### 5.2 スケーラビリティ

| 項目                   | 要件                     |
| ---------------------- | ------------------------ |
| **最大ファイルサイズ** | 100MB推奨、制限なし      |
| **プロジェクト規模**   | 100,000ファイル推奨      |
| **並行処理**           | CPU コア数に応じた並行化 |

### 5.3 信頼性

| 項目           | 要件                         | 検証方法     |
| -------------- | ---------------------------- | ------------ |
| **エラー率**   | < 0.1%                       | テスト統計   |
| **回復性**     | エラー時の適切なハンドリング | エラーテスト |
| **後方互換性** | マイナーバージョンで維持     | 互換性テスト |

### 5.4 保守性

| 項目                 | 要件                 | 現在値 |
| -------------------- | -------------------- | ------ |
| **コードカバレッジ** | > 80%                | ~85% ✅ |
| **型チェック**       | mypyエラー < 100     | 0 ✅    |
| **Ruff警告**         | < 10                 | 6 ✅    |
| **ドキュメント**     | 主要API完全記述      | ✅      |
| **モジュール性**     | プラグインによる拡張 | ✅      |

### 5.5 ユーザビリティ

| 項目                 | 要件                               |
| -------------------- | ---------------------------------- |
| **学習曲線**         | 基本操作5分以内で習得              |
| **エラーメッセージ** | 明確な原因と対処法表示             |
| **ドキュメント**     | クイックスタート、完全リファレンス |

### 5.6 互換性

| 項目                | 要件                                    |
| ------------------- | --------------------------------------- |
| **Python**          | 3.10, 3.11, 3.12, 3.13                  |
| **OS**              | Windows 10/11, macOS 12+, Ubuntu 20.04+ |
| **MCPクライアント** | Claude Desktop, Cursor, Roo Code        |

### 5.7 セキュリティ

| 項目                 | 要件           | 検証方法           |
| -------------------- | -------------- | ------------------ |
| **パストラバーサル** | 完全防止       | セキュリティテスト |
| **脆弱性**           | 既知脆弱性なし | bandit, safety     |
| **権限管理**         | 最小権限原則   | 手動監査           |

---

## 6. 制約条件

### 6.1 技術的制約

- Python 3.10以降のみ対応
- tree-sitterライブラリへの依存
- 各言語パーサーの個別インストール必要
- fd/ripgrepは検索機能利用時のみ必須

### 6.2 ライセンス制約

- MIT License（オープンソース）
- 依存ライブラリのライセンス遵守

### 6.3 運用制約

- ローカル実行のみ（クラウド非対応）
- インターネット接続（パッケージインストール時のみ）

---

## 7. 今後の展開

### 7.1 ロードマップ（v2.0+）

#### 短期（3ヶ月）

- ~~さらなる型安全性向上（mypyエラー 0 目標）~~ **✅ 達成済（v1.9.2でmypy 0エラー達成）**
- パフォーマンス最適化（継続中）
- ~~新言語サポート（C/C++, Rust, Go, JSON等のプラグイン実装）~~ **✅ 達成済（v1.9.18でC/C++追加、Go/Rust/Kotlinはv1.9.17で追加）**

#### 中期（6ヶ月）

- リアルタイム解析API
- CI/CD統合改善

#### 長期（12ヶ月）

- コード変更検出・差分解析
- AIベースの推奨機能

---

## 改訂履歴

| バージョン | 日付       | 変更内容                                                                                                                                                                                                                                                | 承認者          |
| ---------- | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------- |
| 1.0        | 2025-11-02 | 初版作成                                                                                                                                                                                                                                                | aisheng.yu      |
| 1.1        | 2025-11-03 | 実装コードとの照合・修正（第一性原理検証）<br>- サポート言語数: 10言語以上 → **7言語**（実装済みプラグイン確認）<br>- MCPツール数: 6つ → **8つ**（公開版）<br>- mypy目標: エラー<100 → **0達成**（実測）<br>- 言語パーサー表に実装状況を追加<br>- 保守性メトリクスに現在値を追加 | GitHub Copilot |