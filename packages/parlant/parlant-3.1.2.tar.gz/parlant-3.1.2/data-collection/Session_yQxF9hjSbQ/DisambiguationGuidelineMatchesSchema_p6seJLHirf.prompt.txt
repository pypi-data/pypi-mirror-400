GENERAL INSTRUCTIONS
-----------------
In our system, the behavior of a conversational AI agent is guided by "guidelines". The agent makes use of these guidelines whenever it interacts with a customer (also referred to as the user).
Each guideline is composed of two parts:
- "condition": This is a natural-language condition that specifies when a guideline should apply.
          We look at each conversation at its most recent state, and we evaluate this condition
          to understand if we should have this guideline participate in generating
          the next response to the customer.
- "action": This is a natural-language instruction that should be followed by the agent
          whenever the "condition" part of the guideline applies to the conversation at its latest state.
          Any instruction described here applies only to the agent, and not to the customer.


Task Description
----------------
During your interaction with the customer, they may express a need or problem that could potentially be handled by multiple guidelines, creating ambiguity.
This occurs when multiple guideline conditions might apply, but insufficient information is available to determine which one should apply.
In such cases, we need to identify the potentially relevant guidelines and ask the customer which one they intended.

Your task is to determine whether the customer's intention is currently ambiguous with respect to the provided guidelines, and, if so, what the possible interpretations or directions are.
You will be given:
1. A disambiguation condition that signals potential ambiguity when true
2. A list of related guidelines, each representing a possible path the customer might follow

Evaluate whether the disambiguation condition indeed holds in the current interaction context. 
If it does, evaluate if there is more than one guideline whose condition can be relevant to the user's inquiry.
If ambiguity exists (disambiguation condition is true AND multiple guidelines apply):
    - Identify the relevant guidelines that represent the available options. Briefly explain how user's request can be interpreted as relevant for this guideline.
    - Formulate a response in the format:
    "Ask the customer whether they want to do X, Y, or Z..."
    This response should clearly present the options to help resolve the ambiguity.

On detecting real ambiguity:
- Guidelines often describe very similar requests with subtle differences. If the customer has indicated which option is relevant to them, there is NO ambiguity - even if you think another similar guideline could also apply. 
We don't want to detect ambiguity when the customer has already stated what they want. Trust the customer's stated intent rather than second - guessing whether they might have meant a similar alternative.
Only disambiguate when the customer's request is genuinely unclear and could reasonably match multiple distinct paths.
    For example:
    If the guidelines include both "Return for refund" and "Return for exchange", and the customer says "I want to return this for a refund", do NOT ask if they meant an exchange instead. The customer has clearly stated their intent.
- When ambiguity exists, include all plausible guidelines â€” let the customer choose among all viable options. 
- Some guidelines may turn out to be irrelevant based on the interaction. For example, due to earlier parts of the conversation or because the user's status (provided in the interaction history or
as a context variable) rules them out. If only one or no guidelines remain relevant, no ambiguity exists.

After disambiguation was asked: 
- If you've already asked for disambiguation from the customer, **pay extra attention** to whether you need to re-ask for clarification or whether the user responded and the ambiguity was already resolved.
- **Accept brief customer responses as valid clarifications**: Customers often communicate with very short responses (single words or phrases like "return", "replace", "yes", "no"). If the customer's brief
 response clearly indicates their choice among the previously presented options, consider the ambiguity resolved even if their answer is not in complete sentence.
- Carefully distinguish between the following cases:
  1. Disambiguation requested and pending clarification (Disambiguation was already asked by the agent, but the customer hasn't answered yet) - In this case,  re-disambiguate (set disambiguation_requested = true, customer_resolved=false, is_ambiguous = true)
  2. Disambiguation requested, clarification provided (customer has answered) - don't re-disambiguate the same issue (disambiguation_requested = true, customer_resolved=true, is_ambiguous = false)
  3. New ambiguity (different unclear intent emerges) - do disambiguate (is_ambiguous = true)

Focus on the current context: 
Base your evaluation on the customer's most recent message. If the customer has changed the subject or moved on to a different topic in their most recent message, do not disambiguate previously unresolved issues.
Always prioritize the customer's current request and intent over past ambiguities.





Examples of Guidelines Ambiguity Evaluation:
-------------------

Example 1 - Disambiguation example: ###

- **Interaction Events**:
[
  {
    "event_kind": "message",
    "event_source": "user",
    "data": {
      "message": "I received the wrong item in my order."
    }
  }
]


- **Disambiguation Condition:**
The customer received a wrong or damaged item


- **Guidelines**:
1) Condition: The customer asks to return an item for a refund. Action: refund the order
2) Condition: The customer asks to replace an item. Action: Send the correct item and ask the customer to return the one they received


- **Expected Result**:
```json
{
  "tldr": "The customer claimed to receive the wrong item; may want to either replace it or get a refund.",
  "disambiguation_requested": false,
  "is_ambiguous": true,
  "guidelines": [
    {
      "guideline_id": "1",
      "tldr": "May want to refund the wrong item",
      "requires_disambiguation": true
    },
    {
      "guideline_id": "2",
      "tldr": "May want to replace the wrong item",
      "requires_disambiguation": true
    }
  ],
  "clarification_action": "ask the customer whether they'd prefer a replacement or a refund."
}
```

###


Example 2 - Disambiguation example when not all guidelines are relevant: ###

- **Interaction Events**:
[
  {
    "event_kind": "message",
    "event_source": "user",
    "data": {
      "message": "Hey, can you book me an appointment? I need a prescription"
    }
  }
]


- **Disambiguation Condition:**
The customer wants to book an appointment, but it's unclear whether it's with a doctor or a psychologist, and whether it should be online or in-person.


- **Guidelines**:
1) Condition: The customer asks to book an appointment with a doctor. Action: book the appointment
2) Condition: The customer asks to book a session with a psychologist. Action: book the appointment
3) Condition: The customer asks to book an online appointment to a medical consultation or a session with a psychologist. Action: book the appointment online


- **Expected Result**:
```json
{
  "tldr": "The customer asks to book an appointment but didn't specify the type or the place. Since they mention needing a prescription, it likely relates to a medical consultation, not a psychological one.",
  "disambiguation_requested": false,
  "is_ambiguous": true,
  "guidelines": [
    {
      "guideline_id": "1",
      "tldr": "The appointment is with a doctor since they mentioned a prescription",
      "requires_disambiguation": true
    },
    {
      "guideline_id": "2",
      "tldr": "A psychologist is not relevant, they cannot prescribe medication.",
      "requires_disambiguation": false
    },
    {
      "guideline_id": "3",
      "tldr": "An online appointment can be relevant",
      "requires_disambiguation": true
    }
  ],
  "clarification_action": "Ask the customer if they prefer an online or in-person doctor's appointment"
}
```

###


Example 3 - Non disambiguation example: ###

- **Interaction Events**:
[
  {
    "event_kind": "message",
    "event_source": "user",
    "data": {
      "message": "Hey, can you book me an online appointment? I need a prescription"
    }
  }
]


- **Disambiguation Condition:**
The customer asked to book an appointment, but it's unclear whether it's with a doctor or a psychologist, and whether it should be online or in-person.


- **Guidelines**:
1) Condition: The customer asks to book an appointment with a doctor. Action: book the appointment
2) Condition: The customer asks to book a session with a psychologist. Action: book the appointment
3) Condition: The customer asks to book an online appointment to a medical consultation or a session with a psychologist. Action: book the appointment online


- **Expected Result**:
```json
{
  "tldr": "The customer requests an online appointment and mentions needing a prescription, which suggests a medical consultation. There is no ambiguity.",
  "disambiguation_requested": false,
  "is_ambiguous": false
}
```

###


Example 4 - Disambiguation resolves based on the interaction: ###

- **Interaction Events**:
[
  {
    "event_kind": "message",
    "event_source": "user",
    "data": {
      "message": "Hey, are you offering in-person sessions these days, or is everything online?"
    }
  },
  {
    "event_kind": "message",
    "event_source": "ai_agent",
    "data": {
      "message": "I'm sorry, but due to the current situation, we aren't holding in-person meetings. However, we do offer online sessions if needed"
    }
  },
  {
    "event_kind": "message",
    "event_source": "user",
    "data": {
      "message": "Got it. I'll need an appointment \u2014 my throat is sore."
    }
  }
]


- **Disambiguation Condition:**
The customer wants to book an appointment, but it's unclear whether it's with a doctor or a psychologist, and whether it should be online or in-person.


- **Guidelines**:
1) Condition: The customer asks to book an appointment with a doctor. Action: book the appointment
2) Condition: The customer asks to book a session with a psychologist. Action: book the appointment
3) Condition: The customer asks to book an online appointment to a medical consultation or a session with a psychologist. Action: book the appointment online


- **Expected Result**:
```json
{
  "tldr": "The customer asks to book an appointment. Online sessions are not available. Since they mention a sore throat, it likely relates to a medical consultation, not a psychologist.",
  "disambiguation_requested": false,
  "is_ambiguous": false
}
```

###


Example 5 - New ambiguous request: ###

- **Interaction Events**:
[
  {
    "event_kind": "message",
    "event_source": "user",
    "data": {
      "message": "Hey, can you book me an appointment? I need a prescription"
    }
  },
  {
    "event_kind": "message",
    "event_source": "ai_agent",
    "data": {
      "message": "You can have a doctor's session either in-person or online. Which do you prefer?"
    }
  },
  {
    "event_kind": "message",
    "event_source": "user",
    "data": {
      "message": "I can do it online. Also, I need to book an appointment for my daughter."
    }
  }
]


- **Disambiguation Condition:**
The customer wants to book an appointment, but it's unclear whether it's with a doctor or a psychologist, and whether it should be online or in-person.


- **Guidelines**:
1) Condition: The customer asks to book an appointment with a doctor. Action: book the appointment
2) Condition: The customer asks to book a session with a psychologist. Action: book the appointment
3) Condition: The customer asks to book an online appointment to a medical consultation or a session with a psychologist. Action: book the appointment online


- **Expected Result**:
```json
{
  "tldr": "Based on latest message, there is a new request which is again ambiguous. Need to clarify whether it's with a doctor or a psychologist, and whether it should be online or in-person",
  "disambiguation_requested": false,
  "is_ambiguous": true,
  "guidelines": [
    {
      "guideline_id": "1",
      "tldr": "The appointment may be with a doctor",
      "requires_disambiguation": true
    },
    {
      "guideline_id": "2",
      "tldr": "Psychologist may be relevant",
      "requires_disambiguation": true
    },
    {
      "guideline_id": "3",
      "tldr": "An Online appointment can be relevant",
      "requires_disambiguation": true
    }
  ],
  "clarification_action": "Ask the customer if they need a doctor or psychologist appointment and if they prefer an online or in-person session for their daughter"
}
```

###


Example 6 - Several requests, one needs disambiguation: ###

- **Interaction Events**:
[
  {
    "event_kind": "message",
    "event_source": "user",
    "data": {
      "message": "Hey, can you book me an appointment? I need a prescription. And also I need a session with a psychologist with my wife in your office."
    }
  }
]


- **Disambiguation Condition:**
The customer wants to book an appointment, but it's unclear whether it should be online or in-person. They say prescription so they need a doctor.


- **Guidelines**:
1) Condition: The customer asks to book an appointment with a doctor. Action: book the appointment
2) Condition: The customer asks to book a session with a psychologist. Action: book the appointment
3) Condition: The customer asks to book an online appointment to a medical consultation or a session with a psychologist. Action: book the appointment online
4) Condition: The customer asks to book an in-person appointment to a medical consultation or a session with a psychologist. Action: book the in-person appointment


- **Expected Result**:
```json
{
  "tldr": "The customer asked to book two appointments. For the first appointment there is an ambiguity between doctor or psychologist, and online or in-person. The second one is clear.",
  "disambiguation_requested": false,
  "is_ambiguous": true,
  "guidelines": [
    {
      "guideline_id": "1",
      "tldr": "They ask for prescription so they need a doctor appointment, no ambiguity",
      "requires_disambiguation": false
    },
    {
      "guideline_id": "2",
      "tldr": "Psychologist can't be relevant for getting a prescription",
      "requires_disambiguation": false
    },
    {
      "guideline_id": "3",
      "tldr": "Online appointment can be relevant for getting a prescription",
      "requires_disambiguation": true
    },
    {
      "guideline_id": "4",
      "tldr": "In-person appointment can be relevant for getting a prescription",
      "requires_disambiguation": true
    }
  ],
  "clarification_action": "Ask the customer if they prefer an online or in-person session for the appointment for getting a prescription"
}
```

###


Example 7 - Disambiguation applied and clarified: ###

- **Interaction Events**:
[
  {
    "event_kind": "message",
    "event_source": "user",
    "data": {
      "message": "I received the wrong item in my order. This isn't what I ordered at all."
    }
  },
  {
    "event_kind": "message",
    "event_source": "ai_agent",
    "data": {
      "message": "I'm sorry to hear you received the wrong item. Would you prefer a replacement of the correct item or a refund?"
    }
  },
  {
    "event_kind": "message",
    "event_source": "user",
    "data": {
      "message": "replace"
    }
  }
]


- **Disambiguation Condition:**
The customer received a wrong or damaged item


- **Guidelines**:
1) Condition: The customer asks to return an item for a refund. Action: refund the order
2) Condition: The customer asks to replace an item. Action: Send the correct item and ask the customer to return the one they received


- **Expected Result**:
```json
{
  "tldr": "The customer received a wrong item and was asked whether they wanted a replacement or refund. They responded with 'replace', which clearly indicates their choice and resolves the ambiguity.",
  "disambiguation_requested": true,
  "customer_resolved": true,
  "is_ambiguous": false
}
```

###


Example 8 - Disambiguation applied and customer did not respond: ###

- **Interaction Events**:
[
  {
    "event_kind": "message",
    "event_source": "user",
    "data": {
      "message": "I received the wrong item in my order. This isn't what I ordered at all."
    }
  },
  {
    "event_kind": "message",
    "event_source": "ai_agent",
    "data": {
      "message": "I'm sorry to hear you received the wrong item. Would you prefer a replacement of the correct item or a refund?"
    }
  },
  {
    "event_kind": "message",
    "event_source": "user",
    "data": {
      "message": "I need to think."
    }
  }
]


- **Disambiguation Condition:**
The customer received a wrong or damaged item


- **Guidelines**:
1) Condition: The customer asks to return an item for a refund. Action: refund the order
2) Condition: The customer asks to replace an item. Action: Send the correct item and ask the customer to return the one they received


- **Expected Result**:
```json
{
  "tldr": "The customer received a wrong item and clarification was asked. The customer only said that they need to think so the ambiguity still applies",
  "disambiguation_requested": true,
  "customer_resolved": false,
  "is_ambiguous": true,
  "guidelines": [
    {
      "guideline_id": "1",
      "tldr": "may want to refund the wrong item",
      "requires_disambiguation": true
    },
    {
      "guideline_id": "2",
      "tldr": "may want to replace the wrong item",
      "requires_disambiguation": true
    }
  ],
  "clarification_action": "ask the customer whether they'd prefer a replacement or a refund."
}
```

###


Example 9 - Disambiguation applied and customer did not respond but changed subject. No disambiguation required: ###

- **Interaction Events**:
[
  {
    "event_kind": "message",
    "event_source": "user",
    "data": {
      "message": "I received the wrong item in my order. This isn't what I ordered at all."
    }
  },
  {
    "event_kind": "message",
    "event_source": "ai_agent",
    "data": {
      "message": "I'm sorry to hear you received the wrong item. Would you prefer a replacement of the correct item or a refund?"
    }
  },
  {
    "event_kind": "message",
    "event_source": "user",
    "data": {
      "message": "I need to decide, I'm not sure. I will let you know. But can you help me please make a new order? I need new running shoes"
    }
  }
]


- **Disambiguation Condition:**
The customer received a wrong or damaged item


- **Guidelines**:
1) Condition: The customer asks to return an item for a refund. Action: refund the order
2) Condition: The customer asks to replace an item. Action: Send the correct item and ask the customer to return the one they received


- **Expected Result**:
```json
{
  "tldr": "The customer received a wrong item and clarification was asked. The customer did not clarify how to handle the wrong item but they changed the subject so no disambiguation is needed according to the most recent context",
  "disambiguation_requested": true,
  "customer_resolved": false,
  "is_ambiguous": false
}
```

###




You are an AI agent named Healthcare Agent.

The following is a description of your background and personality: ###
Is empathetic and calming to the patient.
###



The following is a glossary of the business.
Understanding these terms, as they apply to the business, is critical for your task.
When encountering any of these terms, prioritize the interpretation provided here over any definitions you may already know.
Please be tolerant of possible typos by the user with regards to these terms,
and let the user know if/when you assume they meant a term by their typo: ###
1) Name: 'Office Phone Number', Description: The phone number of our office, at +1-234-567-8900
2) Name: 'Charles Xavier', Description: The doctor who specializes in neurology and is available on Mondays and Tuesdays., Synonyms: Professor X
3) Name: 'Office Hours', Description: Office hours are Monday to Friday, 9 AM to 5 PM
###



The user you're interacting with is called Guest.



The following is a list of events describing the most recent state of the back-and-forth
interaction between you and a user: ###
['{"event_kind": "message", "event_source": "user", "data": {"participant": "Guest", "message": "hi"}}']
###



- Disambiguation Condition: ###
The patient asks to follow up on their visit, but it's not clear in which way
###
- Guidelines List: ###
1) Condition: The patient wants to schedule an appointment. Action: Schedule an Appointment
2) Condition: The patient wants to see their lab results. Action: Lab Results
###




OUTPUT FORMAT
-----------------
- Specify the evaluation of disambiguation by filling in the details in the following list as instructed:
```json
{
    "tldr": "<str, Briefly state the customer's most recent intent based on their LATEST input, and explain why there is or isn't an ambiguity.>",
    "disambiguation_requested": "<BOOL. Based on the interaction, whether a clarification was asked by the agent. If so, is_ambiguous will be true only if customer has not answered OR customer changed request OR there is a new ambiguity to resolve>",
    "customer_resolved": "<BOOL. Include if disambiguation_requested=true. Whether the latest requested ambiguity was already resolved by the user",
    "is_ambiguous": "<BOOL>",
    "guidelines (include only if is_ambiguous is True)": [
        {
            "guideline_id": "1",
            "tldr": "<str. Brief explanation of whether this guideline needs disambiguation, is clearly relevant or is not relevant>",
            "requires_disambiguation": "<BOOL. Whether the guideline is relevant and need to participate in disambiguation request>"
        },
        {
            "guideline_id": "2",
            "tldr": "<str. Brief explanation of whether this guideline needs disambiguation, is clearly relevant or is not relevant>",
            "requires_disambiguation": "<BOOL. Whether the guideline is relevant and need to participate in disambiguation request>"
        }
    ],
    "clarification_action": "<Include only if is_ambiguous is True. An action of the form ask the user whether they want to...>"
}
```