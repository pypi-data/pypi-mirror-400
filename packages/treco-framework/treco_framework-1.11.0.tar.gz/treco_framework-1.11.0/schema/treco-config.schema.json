{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://github.com/maycon/TRECO/schema/treco-config.schema.json",
    "title": "TRECO Attack Configuration",
    "description": "Configuration schema for TRECO race condition attacks",
    "type": "object",
    "required": [
        "metadata",
        "target",
        "entrypoint",
        "states"
    ],
    "properties": {
        "metadata": {
            "type": "object",
            "description": "Attack metadata information",
            "required": [
                "name",
                "version",
                "author",
                "vulnerability"
            ],
            "properties": {
                "name": {
                    "type": "string",
                    "minLength": 1,
                    "description": "Human-readable name of the attack scenario"
                },
                "version": {
                    "type": "string",
                    "pattern": "^\\d+\\.\\d+",
                    "description": "Version number (semver format, e.g., '1.0', '2.1.0')"
                },
                "author": {
                    "type": "string",
                    "minLength": 1,
                    "description": "Author name or organization"
                },
                "vulnerability": {
                    "type": "string",
                    "pattern": "^(CVE|CWE)-\\d+",
                    "description": "CVE or CWE identifier (e.g., 'CWE-362', 'CVE-2024-1234')"
                },
                "description": {
                    "type": "string",
                    "description": "Optional detailed description of the attack"
                }
            },
            "additionalProperties": false
        },
        "target": {
            "type": "object",
            "description": "Target server configuration",
            "required": [
                "host",
                "port"
            ],
            "properties": {
                "host": {
                    "type": "string",
                    "minLength": 1,
                    "description": "Target hostname or IP address (supports Jinja2 templates)"
                },
                "port": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 65535,
                    "description": "Target port number"
                },
                "threads": {
                    "type": "integer",
                    "minimum": 1,
                    "maximum": 1000,
                    "default": 20,
                    "description": "Default number of threads for non-race states"
                },
                "reuse_connection": {
                    "type": "boolean",
                    "default": false,
                    "description": "Whether to reuse TCP connections across requests"
                },
                "tls": {
                    "type": "object",
                    "description": "TLS/SSL configuration",
                    "properties": {
                        "enabled": {
                            "type": "boolean",
                            "default": false,
                            "description": "Enable HTTPS/TLS"
                        },
                        "verify_cert": {
                            "type": "boolean",
                            "default": false,
                            "description": "Verify SSL certificates (disable for self-signed certs)"
                        },
                        "client_cert": {
                            "type": "string",
                            "description": "Path to client certificate file for mTLS (supports Jinja2 templates)"
                        },
                        "client_key": {
                            "type": "string",
                            "description": "Path to client private key file for mTLS (supports Jinja2 templates)"
                        },
                        "client_key_password": {
                            "type": "string",
                            "description": "Password for encrypted client key (supports Jinja2 templates like env())"
                        },
                        "client_pem": {
                            "type": "string",
                            "description": "Path to combined PEM file containing cert and key for mTLS (supports Jinja2 templates)"
                        },
                        "client_pfx": {
                            "type": "string",
                            "description": "Path to PKCS12 file (.pfx/.p12) for mTLS (supports Jinja2 templates)"
                        },
                        "client_pfx_password": {
                            "type": "string",
                            "description": "Password for PKCS12 file (supports Jinja2 templates like env())"
                        }
                    },
                    "additionalProperties": false
                },
                "http": {
                    "type": "object",
                    "description": "HTTP client configuration",
                    "properties": {
                        "follow_redirects": {
                            "type": "boolean",
                            "default": true,
                            "description": "Whether to follow HTTP redirects"
                        },
                        "timeout": {
                            "type": "integer",
                            "minimum": 1,
                            "default": 10,
                            "description": "Request timeout in seconds"
                        }
                    },
                    "additionalProperties": false
                },
                "proxy": {
                    "type": "object",
                    "description": "Proxy server configuration",
                    "properties": {
                        "host": {
                            "type": "string",
                            "description": "Proxy hostname or IP address"
                        },
                        "port": {
                            "type": "integer",
                            "minimum": 1,
                            "maximum": 65535,
                            "description": "Proxy port number"
                        },
                        "type": {
                            "type": "string",
                            "enum": [
                                "http",
                                "https",
                                "socks5"
                            ],
                            "default": "http",
                            "description": "Proxy protocol type"
                        },
                        "auth": {
                            "type": "object",
                            "description": "Proxy authentication credentials",
                            "required": [
                                "username",
                                "password"
                            ],
                            "properties": {
                                "username": {
                                    "type": "string",
                                    "description": "Proxy username"
                                },
                                "password": {
                                    "type": "string",
                                    "description": "Proxy password"
                                }
                            },
                            "additionalProperties": false
                        }
                    },
                    "additionalProperties": false
                }
            },
            "additionalProperties": false
        },
        "entrypoint": {
            "type": "object",
            "description": "Defines the initial state and variables for execution",
            "required": [
                "state"
            ],
            "properties": {
                "state": {
                    "type": "string",
                    "minLength": 1,
                    "description": "Name of the starting state"
                },
                "input": {
                    "type": "object",
                    "description": "Initial variable definitions (supports Jinja2 templates)",
                    "additionalProperties": true
                }
            },
            "additionalProperties": false
        },
        "states": {
            "type": "object",
            "minProperties": 1,
            "description": "State machine definition - maps state names to state configurations",
            "patternProperties": {
                "^[a-zA-Z_][a-zA-Z0-9_]*$": {
                    "type": "object",
                    "description": "A single state in the attack flow",
                    "properties": {
                        "description": {
                            "type": "string",
                            "description": "Human-readable description of what this state does"
                        },
                        "request": {
                            "type": "string",
                            "description": "HTTP request template in raw HTTP format (supports Jinja2 templates)"
                        },
                        "options": {
                            "type": "object",
                            "description": "Additional execution options for the state",
                            "properties": {
                                "proxy_bypass": {
                                    "type": "boolean",
                                    "default": false,
                                    "description": "Bypass proxy for this state only"
                                }
                            },
                            "additionalProperties": false
                        },
                        "race": {
                            "type": "object",
                            "description": "Race condition configuration - makes this a race state",
                            "properties": {
                                "threads": {
                                    "type": "integer",
                                    "minimum": 2,
                                    "maximum": 1000,
                                    "default": 20,
                                    "description": "Number of concurrent threads for this race (legacy mode)"
                                },
                                "sync_mechanism": {
                                    "type": "string",
                                    "enum": [
                                        "barrier",
                                        "countdown_latch",
                                        "semaphore"
                                    ],
                                    "default": "barrier",
                                    "description": "Synchronization mechanism (barrier recommended for races)"
                                },
                                "connection_strategy": {
                                    "type": "string",
                                    "enum": [
                                        "preconnect",
                                        "lazy",
                                        "pooled",
                                        "multiplexed"
                                    ],
                                    "default": "preconnect",
                                    "description": "Connection strategy (preconnect/multiplexed recommended for best timing)"
                                },
                                "reuse_connections": {
                                    "type": "boolean",
                                    "default": false,
                                    "description": "Whether threads reuse connections"
                                },
                                "thread_propagation": {
                                    "type": "string",
                                    "enum": [
                                        "single",
                                        "parallel"
                                    ],
                                    "default": "single",
                                    "description": "How to propagate state after race (single: one thread continues, parallel: all threads continue)"
                                },
                                "input_mode": {
                                    "type": "string",
                                    "enum": [
                                        "same",
                                        "distribute",
                                        "product",
                                        "random"
                                    ],
                                    "default": "same",
                                    "description": "How to distribute input values across threads (same: all get same value, distribute: round-robin, product: cartesian product, random: random selection)"
                                },
                                "thread_groups": {
                                    "type": "array",
                                    "description": "Thread groups configuration (new mode) - allows defining distinct request patterns with specific thread counts and delays",
                                    "items": {
                                        "type": "object",
                                        "required": ["name", "threads", "request"],
                                        "properties": {
                                            "name": {
                                                "type": "string",
                                                "minLength": 1,
                                                "description": "Group identifier (used in logging and context)"
                                            },
                                            "threads": {
                                                "type": "integer",
                                                "minimum": 1,
                                                "maximum": 1000,
                                                "description": "Number of threads in this group"
                                            },
                                            "delay_ms": {
                                                "type": "integer",
                                                "minimum": 0,
                                                "default": 0,
                                                "description": "Delay in milliseconds AFTER barrier release"
                                            },
                                            "request": {
                                                "type": "string",
                                                "minLength": 1,
                                                "description": "HTTP request template for this group (supports Jinja2)"
                                            },
                                            "variables": {
                                                "type": "object",
                                                "description": "Optional group-specific variables",
                                                "additionalProperties": true
                                            }
                                        },
                                        "additionalProperties": false
                                    }
                                }
                            },
                            "additionalProperties": false
                        },
                        "extract": {
                            "type": "object",
                            "description": "Extract values from response into variables",
                            "patternProperties": {
                                "^[a-zA-Z_][a-zA-Z0-9_]*$": {
                                    "oneOf": [
                                        {
                                            "type": "string",
                                            "description": "Simple regex pattern (shorthand)"
                                        },
                                        {
                                            "type": "object",
                                            "required": [
                                                "type",
                                                "pattern"
                                            ],
                                            "properties": {
                                                "type": {
                                                    "type": "string",
                                                    "enum": [
                                                        "regex",
                                                        "jpath",
                                                        "xpath",
                                                        "boundary",
                                                        "header",
                                                        "cookie",
                                                        "jinja2"
                                                    ],
                                                    "description": "Extractor type"
                                                },
                                                "pattern": {
                                                    "type": "string",
                                                    "description": "Extraction pattern (syntax depends on type)"
                                                }
                                            },
                                            "additionalProperties": false
                                        },
                                        {
                                            "type": "object",
                                            "required": [
                                                "type",
                                                "source"
                                            ],
                                            "properties": {
                                                "type": {
                                                    "const": "jwt",
                                                    "description": "JWT extractor type"
                                                },
                                                "source": {
                                                    "type": "string",
                                                    "description": "JWT token source (variable reference)"
                                                },
                                                "claim": {
                                                    "type": "string",
                                                    "description": "Specific claim to extract from JWT"
                                                },
                                                "part": {
                                                    "type": "string",
                                                    "enum": ["header", "payload", "signature"],
                                                    "description": "JWT part to extract"
                                                },
                                                "check": {
                                                    "type": "string",
                                                    "enum": ["expired", "algorithm", "valid"],
                                                    "description": "Validation check to perform"
                                                },
                                                "verify": {
                                                    "type": "boolean",
                                                    "description": "Whether to verify JWT signature"
                                                },
                                                "secret": {
                                                    "type": "string",
                                                    "description": "Secret for HMAC or public key for RSA verification"
                                                },
                                                "algorithms": {
                                                    "type": "array",
                                                    "items": {
                                                        "type": "string"
                                                    },
                                                    "description": "Allowed algorithms for verification"
                                                },
                                                "default": {
                                                    "description": "Default value if extraction fails"
                                                }
                                            },
                                            "additionalProperties": false
                                        }
                                    ]
                                }
                            },
                            "additionalProperties": false
                        },
                        "logger": {
                            "type": "object",
                            "description": "Logging configuration for state execution",
                            "properties": {
                                "on_state_enter": {
                                    "type": "string",
                                    "description": "Template string to log when entering the state (supports Jinja2)"
                                },
                                "on_state_leave": {
                                    "type": "string",
                                    "description": "Template string to log when leaving the state (supports Jinja2)"
                                },
                                "on_thread_enter": {
                                    "type": "string",
                                    "description": "Template string to log when a thread enters (race states only)"
                                },
                                "on_thread_leave": {
                                    "type": "string",
                                    "description": "Template string to log when a thread leaves (race states only)"
                                }
                            },
                            "additionalProperties": false
                        },
                        "next": {
                            "type": "array",
                            "description": "State transitions based on HTTP response",
                            "items": {
                                "type": "object",
                                "properties": {
                                    "on_status": {
                                        "oneOf": [
                                            {
                                                "type": "integer",
                                                "minimum": 100,
                                                "maximum": 599,
                                                "description": "HTTP status code to match"
                                            },
                                            {
                                                "type": "array",
                                                "items": {
                                                    "type": "integer",
                                                    "minimum": 100,
                                                    "maximum": 599
                                                },
                                                "minItems": 1,
                                                "description": "List of HTTP status codes to match"
                                            }
                                        ],
                                        "description": "[Legacy] HTTP status code(s) that trigger this transition"
                                    },
                                    "when": {
                                        "type": "array",
                                        "description": "List of conditions that must ALL be true (AND logic)",
                                        "minItems": 1,
                                        "items": {
                                            "type": "object",
                                            "minProperties": 1,
                                            "maxProperties": 1,
                                            "properties": {
                                                "status": {
                                                    "type": "integer",
                                                    "minimum": 100,
                                                    "maximum": 599,
                                                    "description": "Exact HTTP status code match"
                                                },
                                                "status_in": {
                                                    "type": "array",
                                                    "items": {
                                                        "type": "integer",
                                                        "minimum": 100,
                                                        "maximum": 599
                                                    },
                                                    "minItems": 1,
                                                    "description": "Match any of these HTTP status codes"
                                                },
                                                "status_range": {
                                                    "type": "array",
                                                    "items": {
                                                        "type": "integer",
                                                        "minimum": 100,
                                                        "maximum": 599
                                                    },
                                                    "minItems": 2,
                                                    "maxItems": 2,
                                                    "description": "Match status codes in range [min, max] inclusive"
                                                },
                                                "condition": {
                                                    "type": "string",
                                                    "description": "Jinja2 boolean expression using extracted variables"
                                                },
                                                "body_contains": {
                                                    "type": "string",
                                                    "description": "Response body must contain this substring"
                                                },
                                                "body_not_contains": {
                                                    "type": "string",
                                                    "description": "Response body must NOT contain this substring"
                                                },
                                                "body_matches": {
                                                    "type": "string",
                                                    "description": "Response body must match this regex pattern"
                                                },
                                                "body_equals": {
                                                    "type": "string",
                                                    "description": "Response body must exactly equal this string"
                                                },
                                                "header_exists": {
                                                    "type": "string",
                                                    "description": "Header with this name must exist"
                                                },
                                                "header_not_exists": {
                                                    "type": "string",
                                                    "description": "Header with this name must NOT exist"
                                                },
                                                "header_equals": {
                                                    "type": "object",
                                                    "required": ["name", "value"],
                                                    "properties": {
                                                        "name": {
                                                            "type": "string",
                                                            "description": "Header name"
                                                        },
                                                        "value": {
                                                            "type": "string",
                                                            "description": "Expected header value (exact match)"
                                                        }
                                                    },
                                                    "additionalProperties": false,
                                                    "description": "Header must have exact value"
                                                },
                                                "header_contains": {
                                                    "type": "object",
                                                    "required": ["name", "value"],
                                                    "properties": {
                                                        "name": {
                                                            "type": "string",
                                                            "description": "Header name"
                                                        },
                                                        "value": {
                                                            "type": "string",
                                                            "description": "Substring to find in header value"
                                                        }
                                                    },
                                                    "additionalProperties": false,
                                                    "description": "Header value must contain substring"
                                                },
                                                "header_matches": {
                                                    "type": "object",
                                                    "required": ["name", "pattern"],
                                                    "properties": {
                                                        "name": {
                                                            "type": "string",
                                                            "description": "Header name"
                                                        },
                                                        "pattern": {
                                                            "type": "string",
                                                            "description": "Regex pattern to match header value"
                                                        }
                                                    },
                                                    "additionalProperties": false,
                                                    "description": "Header value must match regex"
                                                },
                                                "header_compare": {
                                                    "type": "object",
                                                    "required": ["name", "operator", "value"],
                                                    "properties": {
                                                        "name": {
                                                            "type": "string",
                                                            "description": "Header name"
                                                        },
                                                        "operator": {
                                                            "type": "string",
                                                            "enum": ["<", "<=", ">", ">=", "==", "!="],
                                                            "description": "Comparison operator"
                                                        },
                                                        "value": {
                                                            "type": "number",
                                                            "description": "Numeric value to compare against"
                                                        }
                                                    },
                                                    "additionalProperties": false,
                                                    "description": "Numeric comparison of header value"
                                                },
                                                "response_time_ms": {
                                                    "type": "object",
                                                    "required": ["operator", "value"],
                                                    "properties": {
                                                        "operator": {
                                                            "type": "string",
                                                            "enum": ["<", "<=", ">", ">=", "==", "!="],
                                                            "description": "Comparison operator"
                                                        },
                                                        "value": {
                                                            "type": "number",
                                                            "minimum": 0,
                                                            "description": "Response time threshold in milliseconds"
                                                        }
                                                    },
                                                    "additionalProperties": false,
                                                    "description": "Response time comparison"
                                                }
                                            },
                                            "additionalProperties": false
                                        }
                                    },
                                    "otherwise": {
                                        "type": "boolean",
                                        "const": true,
                                        "description": "Default fallback transition when no other conditions match"
                                    },
                                    "goto": {
                                        "type": "string",
                                        "minLength": 1,
                                        "description": "Target state name"
                                    },
                                    "delay_ms": {
                                        "type": "integer",
                                        "minimum": 0,
                                        "default": 0,
                                        "description": "Optional delay before transition (milliseconds)"
                                    }
                                },
                                "required": ["goto"],
                                "oneOf": [
                                    {
                                        "required": ["on_status"],
                                        "not": {
                                            "anyOf": [
                                                {"required": ["when"]},
                                                {"required": ["otherwise"]}
                                            ]
                                        }
                                    },
                                    {
                                        "required": ["when"],
                                        "not": {
                                            "anyOf": [
                                                {"required": ["on_status"]},
                                                {"required": ["otherwise"]}
                                            ]
                                        }
                                    },
                                    {
                                        "required": ["otherwise"],
                                        "not": {
                                            "anyOf": [
                                                {"required": ["on_status"]},
                                                {"required": ["when"]}
                                            ]
                                        }
                                    },
                                    {
                                        "not": {
                                            "anyOf": [
                                                {"required": ["on_status"]},
                                                {"required": ["when"]},
                                                {"required": ["otherwise"]}
                                            ]
                                        }
                                    }
                                ],
                                "additionalProperties": false
                            }
                        },
                        "input": {
                            "type": "object",
                            "description": "Input configuration for this state (overrides entrypoint input)",
                            "additionalProperties": true,
                            "patternProperties": {
                                "^[a-zA-Z_][a-zA-Z0-9_]*$": {
                                    "oneOf": [
                                        {
                                            "type": "string"
                                        },
                                        {
                                            "type": "number"
                                        },
                                        {
                                            "type": "boolean"
                                        },
                                        {
                                            "type": "array"
                                        },
                                        {
                                            "type": "object",
                                            "description": "Input source configuration (file, generator, range)",
                                            "properties": {
                                                "source": {
                                                    "type": "string",
                                                    "enum": [
                                                        "file",
                                                        "generator",
                                                        "range"
                                                    ],
                                                    "description": "Input source type"
                                                },
                                                "path": {
                                                    "type": "string",
                                                    "description": "File path for file source (or builtin:name for built-in wordlists)"
                                                },
                                                "expression": {
                                                    "type": "string",
                                                    "description": "Jinja2 expression for generator source"
                                                },
                                                "count": {
                                                    "type": "integer",
                                                    "minimum": 1,
                                                    "description": "Number of values to generate"
                                                },
                                                "start": {
                                                    "type": "integer",
                                                    "description": "Start value for range source"
                                                },
                                                "end": {
                                                    "type": "integer",
                                                    "description": "End value for range source (exclusive)"
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        }
                    },
                    "additionalProperties": false
                }
            },
            "additionalProperties": false
        }
    },
    "additionalProperties": false
}