#!/usr/bin/env python3
import argparse
import csv
import time
from pathlib import Path

from annpack.api import build_pack, open_pack


def make_csv(path: Path, rows: int) -> None:
    with path.open("w", newline="") as f:
        w = csv.writer(f)
        w.writerow(["id", "text"])
        for i in range(rows):
            w.writerow([i, f"doc {i} hello world"])


def main() -> int:
    ap = argparse.ArgumentParser()
    ap.add_argument("--rows", type=int, default=2000)
    ap.add_argument("--lists", type=int, default=64)
    ap.add_argument("--seed", type=int, default=0)
    ap.add_argument("--out", default="docs/benchmarks/bench_report.md")
    args = ap.parse_args()

    work = Path("/tmp/annpack_bench")
    work.mkdir(parents=True, exist_ok=True)
    csv_path = work / "bench.csv"
    make_csv(csv_path, args.rows)

    t0 = time.time()
    build_pack(
        str(csv_path),
        str(work / "pack"),
        text_col="text",
        id_col="id",
        lists=args.lists,
        seed=args.seed,
        offline=True,
    )
    build_ms = (time.time() - t0) * 1000.0

    pack = open_pack(str(work / "pack"))
    t1 = time.time()
    _ = pack.search("hello", top_k=5)
    search_ms = (time.time() - t1) * 1000.0
    pack.close()

    out = Path(args.out)
    out.parent.mkdir(parents=True, exist_ok=True)
    out.write_text(
        "# Benchmark Report\n\n"
        "Generated by `tools/bench/bench.py`.\n\n"
        f"- rows: {args.rows}\n"
        f"- lists: {args.lists}\n"
        f"- seed: {args.seed}\n"
        f"- build_ms: {build_ms:.2f}\n"
        f"- search_ms: {search_ms:.2f}\n"
    )
    print(f"wrote {out}")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
