<?xml version="1.0"?>
<beast
    namespace="
        :beast.base.evolution
        :beast.base.evolution.alignment
        :beast.base.evolution.branchratemodel
        :beast.base.evolution.likelihood
        :beast.base.evolution.operator
        :beast.base.evolution.operator.kernel
        :beast.base.evolution.sitemodel
        :beast.base.evolution.substitutionmodel
        :beast.base.evolution.tree
        :beast.base.evolution.tree.coalescent
        :beast.base.inference
        :beast.base.inference.parameter
        :beast.base.inference.operator.kernel
        :bdmmprime.distribution
        :bdmmprime.mapping
        :bdmmprime.trajectories
        :bdmmprime.parameterization
        :bdmmprime.util
        :bdmmprime.util.operators
        :bdmmprime.util.priors
        :feast.fileio"
    version="2.7"
>
    <map name="Uniform">beast.base.inference.distribution.Uniform</map>
    <map name="Exponential">beast.base.inference.distribution.Exponential</map>
    <map name="LogNormal">beast.base.inference.distribution.LogNormalDistributionModel</map>
    <map name="Normal">beast.base.inference.distribution.Normal</map>
    <map name="prior">beast.base.inference.distribution.Prior</map>
    <map name="AlignmentFromFasta">feast.fileio.AlignmentFromFasta</map>
    <map name="TaxonSet">beast.base.evolution.alignment.TaxonSet</map>
    <map name="TraitSetFromTaxonSet">feast.fileio.TraitSetFromTaxonSet</map>
    <map name="TypeSet">bdmmprime.parameterization.TypeSet</map>
    <map name="TypeMappedTree">bdmmprime.mapping.TypeMappedTree</map>

    <AlignmentFromFasta id="alignment" fileName="$(msa_file)"/>
    <TaxonSet id="taxonSet" alignment="@alignment"/>
    <TraitSetFromTaxonSet id="typeTraitSet" traitname="type" delimiter="|" takeGroup="1" taxa="@taxonSet"/>
    <TypeSet id="typeSet" typeTraitSet="@typeTraitSet"/>
    <TraitSetFromTaxonSet id="dateTrait" traitname="date" dateFormat="yyyy-M-dd" delimiter="|" everythingAfterLast="true" taxa="@taxonSet"/>
    <TypeMappedTree id="typeMappedTree" bdmmDistrib="@BDMMPrime" startTypePriorProbs="@startTypePriorProbs" mapOnInit="false" remapOnLog="true" typeLabel="type" typeTraitSet="@typeTraitSet" untypedTree="@tree"/>

    <run spec="MCMC" chainLength="10000000">
        <state id="state" spec="State">
            <stateNode id="tree" spec="RandomTree" taxa="@alignment" trait="@dateTrait">
                <populationModel spec="ConstantPopulation" popSize="0.1"/>
            </stateNode>
            <stateNode id="Re" spec="RealParameter" value="1.0 1.1 1.2 1.3 1.4 1.01 1.1 1.2 1.3 1.4"/>
            <stateNode id="samplingProportion" spec="RealParameter" value="1.1E-5 1.2E-5 1.3E-5 1.4E-5 1.5E-5 0.0 0.0 0.0 0.0 0.0"/>
            <plate var="n" range="$(layersRange)">
                <stateNode spec="RealParameter" id="migrationRateW$(n)" value="0"/>
            </plate>
            <stateNode id="processLength" spec="RealParameter" value="10.0"/>
            <stateNode id="gammaShape" spec="RealParameter" value="1.0"/>
            <stateNode id="kappa" spec="RealParameter" value="2.0"/>
        </state>
    
        <distribution id="posterior" spec="CompoundDistribution">
            <distribution id="likelihood" spec="CompoundDistribution" useThreads="true">
                <distribution id="treeLikelihood" spec="ThreadedTreeLikelihood" data="@alignment" tree="@tree">
                    <siteModel spec="SiteModel" gammaCategoryCount="4" shape="@gammaShape" mutationRate="1.0">
                        <substModel spec="HKY" kappa="@kappa">
                            <frequencies spec="Frequencies" data="@alignment"/>
                        </substModel>
                    </siteModel>
                    <branchRateModel spec="StrictClockModel" clock.rate="8.0E-4"/>
                </distribution>
            </distribution>

            <distribution id="prior" spec="CompoundDistribution">
                <distribution id="BDMMPrime" spec="BirthDeathMigrationDistribution" tree="@tree" conditionOnSurvival="true" typeTraitSet="@typeTraitSet">
                    <parameterization id="EpiBDMMPrimeParameterization" spec="EpiParameterization" processLength="@processLength" typeSet="@typeSet">
                        <Re id="ReSP" spec="SkylineVectorParameter" skylineValues="@Re" changeTimes="0.123" timesAreAges="true" processLength="@processLength" typeSet="@typeSet" />
                        <samplingProportion id="samplingProportionSP" spec="SkylineVectorParameter" skylineValues="@samplingProportion" changeTimes="0.205" timesAreAges="true" processLength="@processLength" typeSet="@typeSet"/>
                        <becomeUninfectiousRate spec="SkylineVectorParameter" skylineValues="36.5" typeSet="@typeSet"/>
                        <migrationRate id="migrationRateSP" spec="SkylineMatrixParameter" timesAreAges="true" processLength="@processLength" typeSet="@typeSet">
                            <skylineValues id="migrationRate" spec="bella.BayesMLP" nodes="$(nodes)">
                                <plate var="predictorFile" range="$(predictorFiles)">
                                    <predictor spec="RealParameterFromXSV" fileName="$(predictorFile)"/>
                                </plate>
                                <plate var="n" range="$(layersRange)">
                                    <weights idref="migrationRateW$(n)"/>
                                </plate>
                                <activationFunctionsOutput spec="bella.SoftPlus"/>
                            </skylineValues>
                            <changeTimes spec="RealParameterFromXSV" fileName="$(changeTimesFile)"/>
                        </migrationRate> 
                        <removalProb spec="SkylineVectorParameter" skylineValues="1.0" typeSet="@typeSet"/>
                    </parameterization>
                    <startTypePriorProbs id="startTypePriorProbs" spec="RealParameter" value="1.0 0.0 0.0 0.0 0.0"/>
                </distribution>

                <prior name="distribution" x="@processLength">
                    <LogNormal name="distr" M="-1.0" S="0.2"/>
                </prior>
                <distribution spec="SmartZeroExcludingPrior" x="@Re">
                    <LogNormal name="distr" M="0.8" S="0.5"/>
                </distribution>

                <!-- Sampling proportion in China -->
                <!-- Sequences from China: 39, total confirmed cases in China before 2020-03-08: 80814 (ECDC). 39/80814 = 0.0004826 -->
                <distribution spec="SmartZeroExcludingPrior" x="@samplingProportion" classesToExclude="1.2E-5 1.3E-5 1.4E-5 1.5E-5">
                    <Uniform name="distr" lower="0" upper="0.0005"/>
                </distribution>
                <!-- Sampling proportion in France -->
                <!-- Sequences from France: 19, total confirmed cases in France before 2020-03-08: 716 (ECDC). 19/716 = 0.02654 -->
                <distribution spec="SmartZeroExcludingPrior" x="@samplingProportion" classesToExclude="1.1E-5 1.3E-5 1.4E-5 1.5E-5">
                    <Uniform name="distr" lower="0" upper="0.03"/>
                </distribution>
                <!-- Sampling proportion in Germany -->
                <!-- Sequences from Germany: 38, total confirmed cases in Germany before 2020-03-08: 847 (ECDC). 38/847 = 0.04486 -->
                <distribution spec="SmartZeroExcludingPrior" x="@samplingProportion" classesToExclude="1.1E-5 1.2E-5 1.4E-5 1.5E-5">
                    <Uniform name="distr" lower="0" upper="0.045"/>
                </distribution>
                <!-- Sampling proportion in Italy -->
                <!-- Sequences from Italy: 22, total confirmed cases in Italy before 2020-03-08: 5883 (ECDC). 22/5883 = 0.0037396 -->
                <distribution spec="SmartZeroExcludingPrior" x="@samplingProportion" classesToExclude="1.1E-5 1.2E-5 1.3E-5 1.5E-5">
                    <Uniform name="distr" lower="0" upper="0.004"/>
                </distribution>
                <!-- Sampling proportion in Other EU -->
                <!-- Sequences from Other EU: 117, total confirmed cases in Other EU before 2020-03-08: 3054 (ECDC). 117/3054 = 0.03831 -->
                <distribution spec="SmartZeroExcludingPrior" x="@samplingProportion" classesToExclude="1.1E-5 1.2E-5 1.3E-5 1.4E-5">
                    <Uniform name="distr" lower="0" upper="0.04"/>
                </distribution>

                <plate var="n" range="$(layersRange)">
                    <prior name="distribution" x="@migrationRateW$(n)">
                        <Normal name="distr" mean="0.0" sigma="1.0"/>
                    </prior>
                </plate>
                <prior name="distribution" x="@gammaShape">
                    <Exponential name="distr" mean="0.5"/>
                </prior>
                <prior id="KappaPrior" name="distribution" x="@kappa">
                    <LogNormal name="distr" M="1.0" S="1.25"/>
                </prior>
            </distribution>
        </distribution>

        <operator spec="BactrianScaleOperator" tree="@tree" rootOnly="true" scaleFactor="0.25"  weight="5.0"/>
        <operator spec="BactrianNodeOperator" tree="@tree" weight="30.0"/>
        <operator spec="BactrianSubtreeSlide" tree="@tree" weight="15.0"/>
        <operator spec="Exchange" tree="@tree" weight="15.0"/>
        <operator spec="Exchange" tree="@tree" isNarrow="false" weight="3.0"/>
        <operator spec="WilsonBalding" tree="@tree" weight="3.0"/>
        <operator spec="EpochFlexOperator" tree="@tree" scaleFactor="0.1" weight="2.0"/>
        <operator spec="EpochFlexOperator" tree="@tree" fromOldestTipOnly="false" scaleFactor="0.1" weight="2.0"/>
        <operator spec="TreeStretchOperator" tree="@tree" scaleFactor="0.01" weight="2.0"/>
        <operator spec="BactrianScaleOperator" parameter="@processLength" scaleFactor="0.25" weight="3.0"/>
        <operator spec="SmartScaleOperator" parameter="@Re" scaleFactor="0.25" weight="10.0"/>
        <operator spec="SmartScaleOperator" parameter="@samplingProportion" weight="3.0"/>
        <plate var="n" range="$(layersRange)">
            <operator spec="BactrianRandomWalkOperator" parameter="@migrationRateW$(n)" weight="5.0"/>
        </plate>
        <operator spec="BactrianScaleOperator" parameter="@gammaShape" weight="1.0"/>
        <operator spec="BactrianScaleOperator" parameter="@kappa" weight="1.0"/>

        <logger spec="Logger" fileName="MCMC.log" logEvery="1000" model="@posterior">
            <log idref="posterior"/>
            <log idref="likelihood"/>
            <log idref="prior"/>
            <log idref="BDMMPrime"/>
            <log idref="gammaShape"/>
            <log idref="kappa"/>
            <log idref="processLength"/>
            <log idref="ReSP"/>
            <log idref="samplingProportionSP"/>
            <log idref="migrationRateSP"/>
            <log idref="migrationRate"/>
        </logger>
        <logger spec="Logger" fileName="typedTrees.trees" logEvery="100000" mode="tree">
            <log idref="typeMappedTree"/>
        </logger>
        <logger spec="Logger" fileName="TypedNodeTrees.trees" logEvery="100000" mode="tree">
            <log spec="TypedNodeTreeLogger" typedTree="@typeMappedTree"/>
        </logger>
        <logger spec="Logger" fileName="trajectories.csv" logEvery="100000">
            <log spec="SampledTrajectory" bdmmDistrib="@BDMMPrime" startTypePriorProbs="@startTypePriorProbs" typeMappedTree="@typeMappedTree" useTauLeaping="true"/>
        </logger>
    </run>
</beast>
