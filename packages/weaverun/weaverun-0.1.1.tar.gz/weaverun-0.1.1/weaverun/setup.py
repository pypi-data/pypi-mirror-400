"""
Interactive setup wizard for weaverun.

Creates a .env file with necessary environment variables for Weave logging.
"""
import os
import sys
from pathlib import Path
from typing import Optional

from dotenv import load_dotenv
from rich.console import Console
from rich.panel import Panel
from rich.prompt import Confirm, Prompt

console = Console()

# Required environment variables for Weave logging
REQUIRED_VARS = {
    "WANDB_API_KEY": {
        "description": "Your Weights & Biases API key",
        "help": "Get it from https://wandb.ai/authorize",
        "secret": True,
    },
    "WANDB_PROJECT_ID": {
        "description": "Weave project for logging (format: entity/project_id)",
        "help": "Example: my-team/my-project",
        "secret": False,
    },
}


def _log(msg: str, style: str = "cyan"):
    """Print weaverun styled message."""
    console.print(f"[{style}]weaverun:[/{style}] {msg}")


def _mask_key(key: str) -> str:
    """Mask an API key for display, showing only first 4 and last 4 chars."""
    if len(key) <= 12:
        return "*" * len(key)
    return f"{key[:4]}{'*' * (len(key) - 8)}{key[-4:]}"


def check_env_vars() -> list[str]:
    """
    Check which required environment variables are missing.
    
    Returns:
        List of missing required variable names
    """
    missing = []
    
    for var in REQUIRED_VARS:
        if not os.getenv(var):
            missing.append(var)
    
    return missing


def load_existing_env(env_path: Path) -> dict[str, str]:
    """Load existing .env file contents."""
    existing = {}
    if env_path.exists():
        try:
            with open(env_path) as f:
                for line in f:
                    line = line.strip()
                    if line and not line.startswith("#") and "=" in line:
                        key, _, value = line.partition("=")
                        # Remove quotes if present
                        value = value.strip().strip('"').strip("'")
                        existing[key.strip()] = value
        except Exception:
            pass
    return existing


def save_env_file(env_path: Path, variables: dict[str, str], existing: dict[str, str]):
    """Save variables to .env file, preserving existing content."""
    # Merge existing with new (new values override existing)
    merged = {**existing, **variables}
    
    # Build content
    lines = [
        "# weaverun environment configuration",
        "# Generated by: weaverun setup",
        "",
    ]
    
    # Group by type
    weave_vars = []
    api_keys = []
    other_vars = []
    
    for key, value in merged.items():
        if key.startswith("WEAVE_") or key.startswith("WANDB_"):
            weave_vars.append((key, value))
        elif key.endswith("_API_KEY") or key.endswith("_KEY"):
            api_keys.append((key, value))
        else:
            other_vars.append((key, value))
    
    if weave_vars:
        lines.append("# Weave / W&B Configuration")
        for key, value in sorted(weave_vars):
            lines.append(f'{key}="{value}"')
        lines.append("")
    
    if api_keys:
        lines.append("# API Keys")
        for key, value in sorted(api_keys):
            lines.append(f'{key}="{value}"')
        lines.append("")
    
    if other_vars:
        lines.append("# Other Configuration")
        for key, value in sorted(other_vars):
            lines.append(f'{key}="{value}"')
        lines.append("")
    
    # Write file
    with open(env_path, "w") as f:
        f.write("\n".join(lines))


def prompt_for_variable(var_name: str, var_info: dict, current_value: Optional[str] = None) -> Optional[str]:
    """Prompt user for a variable value."""
    description = var_info["description"]
    help_text = var_info["help"]
    is_secret = var_info.get("secret", False)
    
    console.print()
    console.print(f"[bold]{var_name}[/bold]")
    console.print(f"  [dim]{description}[/dim]")
    console.print(f"  [dim italic]{help_text}[/dim italic]")
    
    if current_value:
        masked = _mask_key(current_value) if is_secret else current_value
        console.print(f"  [green]Current value:[/green] {masked}")
        if not Confirm.ask("  Update this value?", default=False):
            return None
    
    # Prompt for value
    value = Prompt.ask(
        f"  Enter {var_name}",
        password=is_secret,
        default="" if not current_value else None,
    )
    
    return value.strip() if value else None


def run_setup_wizard(
    env_path: Optional[Path] = None,
    interactive: bool = True,
    check_only: bool = False,
    force: bool = False,
) -> bool:
    """
    Run the interactive setup wizard.
    
    Args:
        env_path: Path to .env file (defaults to current directory)
        interactive: If True, prompt for user input
        check_only: If True, only check for missing vars without prompting
        force: If True, allow reconfiguring even when all vars are set
    
    Returns:
        True if setup completed successfully or no setup needed
    """
    if env_path is None:
        env_path = Path.cwd() / ".env"
    
    # Load .env file into environment before checking
    if env_path.exists():
        load_dotenv(env_path)
    
    # Show header
    console.print()
    console.print(Panel.fit(
        "[bold cyan]weaverun Setup Wizard[/bold cyan]\n"
        "[dim]Configure environment variables for Weave logging[/dim]",
        border_style="cyan",
    ))
    
    # Check current state (now includes values from .env)
    missing_required = check_env_vars()
    existing = load_existing_env(env_path)
    
    # Determine which vars to configure
    if not missing_required:
        console.print()
        console.print("[green]✓[/green] All required environment variables are configured!")
        
        if check_only:
            return True
        
        if not force:
            return True
        
        # Force mode: offer to reconfigure
        console.print()
        if not Confirm.ask("Would you like to reconfigure them?", default=False):
            return True
        
        # Configure all required vars in force mode
        vars_to_configure = list(REQUIRED_VARS.keys())
    else:
        # Show missing status
        console.print()
        console.print("[yellow]Missing required variables:[/yellow]")
        for var in missing_required:
            console.print(f"  [red]✗[/red] {var}")
        
        if check_only:
            return False
        
        if not interactive:
            console.print()
            console.print("[yellow]Run 'weaverun setup' to configure missing variables.[/yellow]")
            return False
        
        # Ask to proceed
        console.print()
        if not Confirm.ask("Would you like to configure these now?", default=True):
            console.print("[dim]Setup cancelled. Run 'weaverun setup' when ready.[/dim]")
            return False
        
        vars_to_configure = missing_required
    
    # Collect values
    new_values = {}
    
    # Required variables
    console.print()
    console.print("[bold]Required Configuration[/bold]")
    for var in vars_to_configure:
        var_info = REQUIRED_VARS[var]
        current = existing.get(var)
        value = prompt_for_variable(var, var_info, current)
        if value:
            new_values[var] = value
        elif var in existing:
            new_values[var] = existing[var]
    
    # Validate required vars are set
    still_missing = []
    for var in REQUIRED_VARS:
        if var not in new_values and var not in existing:
            still_missing.append(var)
    
    if still_missing:
        console.print()
        console.print("[yellow]⚠ Some required variables are still missing:[/yellow]")
        for var in still_missing:
            console.print(f"  [red]✗[/red] {var}")
        console.print("[dim]Weave logging will be disabled until these are configured.[/dim]")
    
    # Save .env file
    if new_values:
        console.print()
        console.print(f"[bold]Saving to:[/bold] {env_path}")
        
        try:
            save_env_file(env_path, new_values, existing)
            console.print("[green]✓[/green] Configuration saved!")
            
            # Remind user to add to .gitignore
            gitignore_path = env_path.parent / ".gitignore"
            if gitignore_path.exists():
                with open(gitignore_path) as f:
                    if ".env" not in f.read():
                        console.print()
                        console.print("[yellow]⚠ Remember to add .env to your .gitignore![/yellow]")
            else:
                console.print()
                console.print("[yellow]⚠ Consider adding .env to .gitignore to protect your secrets.[/yellow]")
            
        except Exception as e:
            console.print(f"[red]✗[/red] Failed to save: {e}")
            return False
    
    console.print()
    console.print("[green]Setup complete![/green] Run your app with:")
    console.print("[cyan]  weaverun <your-command>[/cyan]")
    console.print()
    
    return len(still_missing) == 0


def prompt_setup_if_needed(silent: bool = False) -> bool:
    """
    Check for missing required env vars and offer to run setup.
    
    Args:
        silent: If True, don't prompt - just return status
    
    Returns:
        True if all required vars are set, False otherwise
    """
    # Load .env file if it exists
    env_path = Path.cwd() / ".env"
    if env_path.exists():
        load_dotenv(env_path)
    
    missing_required = check_env_vars()
    
    if not missing_required:
        return True
    
    if silent:
        return False
    
    console.print()
    console.print("[yellow]⚠ Missing required environment variables for Weave logging:[/yellow]")
    for var in missing_required:
        console.print(f"  [red]✗[/red] {var}")
    
    console.print()
    if Confirm.ask("Would you like to run the setup wizard?", default=True):
        return run_setup_wizard()
    else:
        console.print("[dim]Continuing without Weave logging. Run 'weaverun setup' to configure.[/dim]")
        return False

