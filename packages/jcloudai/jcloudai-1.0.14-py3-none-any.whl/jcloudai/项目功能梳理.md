# JCloud-AI 项目功能梳理

## 项目概述

JCloud-AI 是一个基于 PandasAI 的智能数据分析框架，它将 LLM（大语言模型）与 DataFrame 结合，使用户能够通过自然语言与数据进行对话式交互。

---

## 核心功能模块

### 1. 自然语言数据查询 (Chat)

**功能描述**：通过自然语言提问，自动生成 SQL/代码并执行，返回分析结果。

**支持的响应类型**：
- **字符串 (String)**：文本回答
- **数字 (Number)**：数值结果
- **DataFrame**：表格数据
- **图表 (Chart)**：可视化图表（支持保存、显示、Base64导出）

**使用示例**：
```python
import jcloudai as pai

df = pai.read_csv("data/companies.csv")
response = df.chat("What is the average revenue by region?")
```

### 2. 智能 Agent 系统

**功能描述**：提供智能代理，支持多轮对话、代码生成、错误重试和训练功能。

**核心能力**：
- **代码生成**：根据自然语言生成 Python/SQL 代码
- **代码执行**：安全执行生成的代码
- **错误重试**：自动重试失败的代码生成和执行
- **对话记忆**：支持多轮对话上下文
- **模型训练**：支持 Q&A 训练和文档训练

**使用示例**：
```python
from jcloudai import Agent

agent = Agent("data.csv")
agent.train(docs="The fiscal year starts in April")
response = agent.chat("What is the total sales for the fiscal year?")
```

### 3. 语义层 (Semantic Layer)

**功能描述**：定义数据集的元数据、列信息、关系和转换规则。

**Schema 配置项**：
- `name`：数据集名称
- `description`：数据集描述
- `source`：数据源配置
- `columns`：列定义（名称、类型、描述、表达式、别名）
- `relations`：表关系定义
- `transformations`：数据转换规则
- `group_by`：分组配置
- `order_by`：排序配置
- `limit`：数据限制

### 4. 数据转换 (Transformations)

**支持的转换类型**（共29种）：
| 类别 | 转换类型 |
|------|----------|
| 文本处理 | `to_lowercase`, `to_uppercase`, `strip`, `truncate`, `pad`, `extract` |
| 数值处理 | `round_numbers`, `scale`, `clip`, `normalize`, `standardize`, `ensure_positive` |
| 日期处理 | `format_date`, `convert_timezone`, `to_datetime`, `validate_date_range` |
| 数据清洗 | `fill_na`, `replace`, `remove_duplicates`, `anonymize` |
| 类型转换 | `to_numeric`, `encode_categorical`, `bin`, `map_values`, `rename` |
| 数据验证 | `validate_email`, `normalize_phone`, `validate_foreign_key`, `standardize_categories` |

### 5. 多数据源连接器

**本地数据源**：
- CSV 文件
- Parquet 文件

**远程数据源**：
| 数据库类型 | 扩展包 |
|-----------|--------|
| MySQL | `pandasai_sql` |
| PostgreSQL | `pandasai_sql` |
| CockroachDB | `pandasai_sql` |
| Oracle | `pandasai_oracle` |
| BigQuery | `pandasai_bigquery` |
| Snowflake | `pandasai_snowflake` |
| Databricks | `pandasai_databricks` |
| Yahoo Finance | `pandasai_yfinance` |

### 6. 向量存储 (Vector Stores)

**功能描述**：用于存储训练数据，支持相似性搜索。

**支持的向量数据库**（企业版）：
- ChromaDB
- LanceDB
- Milvus
- Pinecone
- Qdrant

**核心方法**：
- `add_question_answer()`：添加问答对
- `add_docs()`：添加文档
- `get_relevant_question_answers()`：获取相关问答
- `get_relevant_docs()`：获取相关文档

### 7. 沙箱执行环境 (Sandbox)

**功能描述**：提供安全的代码执行环境。

**Docker 沙箱**：
```python
from pandasai_docker import DockerSandbox

sandbox = DockerSandbox()
sandbox.start()
result = pai.chat("plot total heart patients by gender", df, sandbox=sandbox)
sandbox.stop()
```

### 8. LLM 集成

**支持的 LLM 扩展**：
- **LiteLLM**：支持多种模型（OpenAI、Anthropic 等）
- **OpenAI**：直接集成 OpenAI API

**LLM 基础功能**：
- 代码提取和清理
- 系统提示生成
- 对话历史管理

### 9. 视图 (Views)

**功能描述**：创建跨多个数据集的虚拟视图。

**特性**：
- 支持多表关联
- 列名格式：`[dataset_name].[column_name]`
- 关系定义：`from` 和 `to` 字段

### 10. CLI 命令行工具

**可用命令**：
```bash
# 数据集管理
pai dataset create    # 创建新数据集

# 认证
pai login <api_key>   # 使用 API Key 登录
```

---

## 辅助功能

### 配置管理
- 全局配置：`pai.config.set()`
- API Key 管理：`pai.api_key.set()`
- 日志保存、详细模式、最大重试次数

### 数据加载器
- `LocalDatasetLoader`：本地文件加载
- `SQLDatasetLoader`：SQL 数据库加载
- `ViewDatasetLoader`：视图加载

### 查询构建器
- SQL 解析和转换
- 表名/列名替换
- 分页支持
- 跨数据库方言转换（DuckDB、MySQL、PostgreSQL 等）

---

## 项目结构

```
jcloud-ai/
├── jcloudai/                 # 核心代码
│   ├── agent/               # Agent 系统
│   ├── cli/                 # 命令行工具
│   ├── core/                # 核心功能
│   │   ├── code_execution/  # 代码执行
│   │   ├── code_generation/ # 代码生成
│   │   ├── prompts/         # 提示模板
│   │   └── response/        # 响应处理
│   ├── data_loader/         # 数据加载器
│   ├── dataframe/           # DataFrame 扩展
│   ├── helpers/             # 辅助工具
│   ├── llm/                 # LLM 基础类
│   ├── query_builders/      # 查询构建器
│   ├── sandbox/             # 沙箱环境
│   └── vectorstores/        # 向量存储
├── extensions/              # 扩展模块
│   ├── connectors/          # 数据连接器
│   ├── llms/                # LLM 扩展
│   ├── sandbox/             # 沙箱扩展
│   └── ee/                  # 企业版功能
└── examples/                # 示例代码
```

 poetry version patch
 1687  poetry publish
 1688  poetry publish --build
