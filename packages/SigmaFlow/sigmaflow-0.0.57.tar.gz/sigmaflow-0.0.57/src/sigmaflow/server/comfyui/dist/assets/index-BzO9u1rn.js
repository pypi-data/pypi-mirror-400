var Mo=Object.defineProperty;var u=(n,e)=>Mo(n,"name",{value:e,configurable:!0});import{r as b,cc as X,cd as Et,ce as L,a5 as V,a9 as Me,cf as No,av as Ze,cg as To,ch as Po,aV as co,T as Eo,B as Lo,y as he,P as Oo,t as E,F as Je,ci as Ro,cj as Ao,ck as Ie,cl as ke,cm as Bo,cn as Mt,co as Fo,cp as $o,cq as Wo,cr as Wt,Y as Xe,cs as Ne,ct as Ee,ao as rt,cu as uo,cv as Qe,cw as Uo,cx as Se,a6 as zo,cy as Vo,bw as Go,a as ae,cz as po,ai as jo,cA as Ho,ap as Yo,u as Ye,cB as Le,aj as Xo,l as nt,c9 as Zo,ca as lt,cb as tt,cC as Lt,cD as Ot,cE as qo,m as ho,b as Ko,bp as Jo,bq as Qo,cF as en,cG as Ut,d as tn,cH as zt,cI as on,bA as nn,cJ as sn,cK as an,cL as rn,cM as ln}from"./index-6STX4Oia.js";import{aK as Vt,aR as de,bb as go,bj as cn,bc as dn,co as un,ck as pn}from"./vendor-other-_sromytg.js";import{l as hn}from"./mathUtil-DlGw4Aca.js";import{nextTick as Rt,ref as D,computed as se,watch as ze,unref as N,defineComponent as Ce,openBlock as oe,createElementBlock as le,normalizeStyle as Ae,createElementVNode as P,onMounted as mo,withModifiers as He,toDisplayString as te,createVNode as pe,normalizeClass as Ue,Fragment as fo,renderList as yo,createBlock as Ke,resolveDynamicComponent as gn,onBeforeUnmount as mn,createCommentVNode as st}from"vue";import{_ as At}from"./Load3D.vue_vue_type_script_setup_true_lang-BKrIKZkc.js";import{d as vo}from"./vendor-vue-CrN17A9b.js";import Gt from"primevue/button";import{g as ct,s as wo}from"./audioUtils-j6qvA_Je.js";import{u as je}from"./audioService-k6JHBynD.js";import"@primevue/themes";import"@primevue/themes/aura";import"primevue/config";import"primevue/confirmationservice";import"primevue/toastservice";import"primevue/tooltip";import"vue-i18n";import"primevue/message";import"primevue/skeleton";import"primevue/multiselect";import"primevue/inputtext";import"primevue/select";import"primevue/checkbox";import"primevue/divider";import"primevue/scrollpanel";import"primevue/usetoast";import"primevue/card";import"primevue/listbox";import"primevue/progressbar";import"primevue/floatlabel";import"@primevue/forms";import"@primevue/forms/resolvers/zod";import"primevue/password";import"primevue/progressspinner";import"primevue/tag";import"primevue/inputnumber";import"primevue/tabpanels";import"primevue/tabs";import"primevue/iconfield";import"primevue/inputicon";import"primevue/badge";import"primevue/chip";import"primevue/tabpanel";import"primevue/toggleswitch";import"primevue/colorpicker";import"primevue/radiobutton";import"primevue/knob";import"primevue/slider";import"primevue/panel";import"primevue/tabmenu";import"primevue/popover";import"primevue/tab";import"primevue/tablist";import"primevue";import"primevue/autocomplete";import"primevue/dropdown";import"./vendor-xterm-DV1MVhAx.js";import"./vendor-three-zdhtZbSm.js";import"primevue/galleria";import"primevue/tabview";import"primevue/contextmenu";import"primevue/tree";import"primevue/toolbar";import"primevue/selectbutton";import"primevue/dialog";import"primevue/confirmpopup";import"primevue/useconfirm";import"primevue/confirmdialog";import"./vendor-tiptap-D1RRboMA.js";import"primevue/blockui";class ue extends Et{static{u(this,"ClipspaceDialog")}static items=[];static instance=null;static registerButton(e,t,o){const s=L("button",{type:"button",textContent:e,contextPredicate:t,onclick:o});ue.items.push(s)}static invalidatePreview(){if(X.clipspace&&X.clipspace.imgs&&X.clipspace.imgs.length>0){const e=document.getElementById("clipspace_preview");e&&(e.src=X.clipspace.imgs[X.clipspace.selectedIndex].src,e.style.maxHeight="100%",e.style.maxWidth="100%")}}static invalidate(){if(ue.instance){const e=ue.instance,t=L("div.comfy-modal-content",[e.createImgSettings(),...e.createButtons()]);e.element?(e.element.firstChild&&e.element.removeChild(e.element.firstChild),e.element.appendChild(t)):e.element=L("div.comfy-modal",{parent:document.body},[t]),e.element.children[0].children.length<=1&&e.element.children[0].appendChild(L("p",{},["Unable to find the features to edit content of a format stored in the current Clipspace."])),ue.invalidatePreview()}}constructor(){super()}createButtons(){const e=[];for(let t in ue.items){const o=ue.items[t];(!o.contextPredicate||o.contextPredicate())&&e.push(ue.items[t])}return e.push(L("button",{type:"button",textContent:"Close",onclick:u(()=>{this.close()},"onclick")})),e}createImgSettings(){if(X.clipspace?.imgs){const e=[],t=X.clipspace.imgs;for(let l=0;l<t.length;l++)e.push(L("option",{value:l},[`${l}`]));const o=L("select",{id:"clipspace_img_selector",onchange:u(l=>{l.target&&X.clipspace&&(X.clipspace.selectedIndex=l.target.selectedIndex,ue.invalidatePreview())},"onchange")},e),s=L("tr",{},[L("td",{},[L("font",{color:"white"},["Select Image"])]),L("td",{},[o])]),a=L("select",{id:"clipspace_img_paste_mode",onchange:u(l=>{l.target&&X.clipspace&&(X.clipspace.img_paste_mode=l.target.value)},"onchange")},[L("option",{value:"selected"},"selected"),L("option",{value:"all"},"all")]);a.value=X.clipspace.img_paste_mode;const i=L("tr",{},[L("td",{},[L("font",{color:"white"},["Paste Mode"])]),L("td",{},[a])]),r=L("td",{align:"center",width:"100px",height:"100px",colSpan:"2"},[L("img",{id:"clipspace_preview",ondragstart:u(()=>!1,"ondragstart")},[])]),d=L("tr",{},[r]);return L("table",{},[s,i,d])}else return[]}createImgPreview(){return X.clipspace?.imgs?L("img",{id:"clipspace_preview",ondragstart:u(()=>!1,"ondragstart")}):[]}show(){ue.invalidate(),this.element.style.display="block"}}b.registerExtension({name:"Comfy.Clipspace",init(n){n.openClipspace=function(){ue.instance||(ue.instance=new ue,X.clipspace_invalidate_handler=ue.invalidate),X.clipspace?ue.instance.show():n.ui.dialog.show("Clipspace is Empty!")}}});window.comfyAPI=window.comfyAPI||{};window.comfyAPI.clipspace=window.comfyAPI.clipspace||{};window.comfyAPI.clipspace.ClipspaceDialog=ue;const fn={name:"Comfy.ContextMenuFilter",init(){const n=V.ContextMenu;V.ContextMenu=function(e,t){const o=new n(e,t);if(t?.className==="dark"&&e?.length>4){const s=document.createElement("input");s.classList.add("comfy-context-menu-filter"),s.placeholder="Filter list",o.root.prepend(s);const a=Array.from(o.root.querySelectorAll(".litemenu-entry"));let i=[...a],r=i.length;requestAnimationFrame(()=>{const l=Me.active_canvas.current_node?.widgets?.filter(p=>No(p)&&p.options.values?.length===e.length).find(p=>p.options.values?.every((m,v)=>m===e[v]))?.value;let c=l?e.findIndex(p=>p===l):0;c<0&&(c=0);let h=i[c];f();function f(){h?.style.setProperty("background-color",""),h?.style.setProperty("color",""),h=i[c],h?.style.setProperty("background-color","#ccc","important"),h?.style.setProperty("color","#000","important")}u(f,"updateSelected");const g=u(()=>{if(o.root.getBoundingClientRect().top<0){const m=1-o.root.getBoundingClientRect().height/o.root.clientHeight,v=o.root.clientHeight*m/2;o.root.style.top=-v+"px"}},"positionList");s.addEventListener("keydown",p=>{switch(p.key){case"ArrowUp":p.preventDefault(),c===0?c=r-1:c--,f();break;case"ArrowRight":p.preventDefault(),c=r-1,f();break;case"ArrowDown":p.preventDefault(),c===r-1?c=0:c++,f();break;case"ArrowLeft":p.preventDefault(),c=0,f();break;case"Enter":h?.click();break;case"Escape":o.close();break}}),s.addEventListener("input",()=>{const p=s.value.toLocaleLowerCase();if(i=a.filter(m=>{const v=!p||m.textContent?.toLocaleLowerCase().includes(p);return m.style.display=v?"block":"none",v}),c=0,i.includes(h)&&(c=i.findIndex(m=>m===h)),r=i.length,f(),t.event){let m=t.event.clientY-10;const v=document.body.getBoundingClientRect(),w=o.root.getBoundingClientRect();v.height&&m>v.height-w.height-10&&(m=Math.max(0,v.height-w.height-10)),o.root.style.top=m+"px",g()}}),requestAnimationFrame(()=>{s.focus(),g()})})}return o},V.ContextMenu.prototype=n.prototype}};b.registerExtension(fn);Ze().registerExtension({name:"Comfy.DynamicPrompts",nodeCreated(n){if(n.widgets){const e=n.widgets.filter(t=>t.dynamicPrompts);for(const t of e)t.serializeValue=(o,s)=>{if(typeof t.value!="string")return t.value;const a=To(t.value);return o?.widgets_values&&(o.widgets_values[s]=a),a}}}});b.registerExtension({name:"Comfy.EditAttention",init(){const n=b.ui.settings.addSetting({id:"Comfy.EditAttention.Delta",category:["Comfy","EditTokenWeight","Delta"],name:"Ctrl+up/down precision",type:"slider",attrs:{min:.01,max:.5,step:.01},defaultValue:.05});function e(a,i){const r=parseFloat(a);if(isNaN(r))return a;const d=r+i;return String(Number(d.toFixed(10)))}u(e,"incrementWeight");function t(a,i){let r=i,d=i,l=0,c=0;for(;r>=0&&(r--,!(a[r]==="("&&l===c));)a[r]==="("&&l++,a[r]===")"&&c++;if(r<0)return null;for(l=0,c=0;d<a.length&&!(a[d]===")"&&l===c);)a[d]==="("&&l++,a[d]===")"&&c++,d++;return d===a.length?null:{start:r+1,end:d}}u(t,"findNearestEnclosure");function o(a){const i=/^\((.*)\)$/,r=a.match(i),d=/:([+-]?(\d*\.)?\d+([eE][+-]?\d+)?)/,l=a.match(d);return r&&!l?`(${r[1]}:1.0)`:a}u(o,"addWeightToParentheses");function s(a){const i=a.composedPath()[0],r=parseFloat(n.value);if(i.tagName!=="TEXTAREA"||!(a.key==="ArrowUp"||a.key==="ArrowDown")||!a.ctrlKey&&!a.metaKey)return;a.preventDefault();let d=i.selectionStart,l=i.selectionEnd,c=i.value.substring(d,l);if(!c){const g=t(i.value,d);if(g)d=g.start,l=g.end,c=i.value.substring(d,l);else{const p=" .,\\/!?%^*;:{}=-_`~()\r\n	";for(;!p.includes(i.value[d-1])&&d>0;)d--;for(;!p.includes(i.value[l])&&l<i.value.length;)l++;if(c=i.value.substring(d,l),!c)return}}c[c.length-1]===" "&&(c=c.substring(0,c.length-1),l-=1),i.value[d-1]==="("&&i.value[l]===")"&&(d-=1,l+=1,c=i.value.substring(d,l)),(c[0]!=="("||c[c.length-1]!==")")&&(c=`(${c})`),c=o(c);const h=a.key==="ArrowUp"?r:-r,f=c.replace(/\((.*):([+-]?\d+(?:\.\d+)?)\)/,(g,p,m)=>(m=e(m,h),m==1?p:`(${p}:${m})`));i.setSelectionRange(d,l),document.execCommand("insertText",!1,f),i.setSelectionRange(d,d+f.length)}u(s,"editAttention"),window.addEventListener("keydown",s)}});const yn={settingId:"Comfy-Desktop.UV.PythonInstallMirror",mirror:"https://github.com/astral-sh/python-build-standalone/releases/download",fallbackMirror:"https://python-standalone.org/mirror/astral-sh/python-build-standalone",validationPathSuffix:"/20250115/cpython-3.10.16+20250115-aarch64-apple-darwin-debug-full.tar.zst.sha256"},yt=u(async n=>Po(n)&&await co().NetWork.canAccessUrl(n),"checkMirrorReachable");(async()=>{if(!Eo())return;const n=co(),e=await n.getElectronVersion(),t=Lo(),o=he(),{staticUrls:s,buildDocsUrl:a}=Oo(),i=u((r,d)=>{d!==void 0&&r!==d&&n.restartApp("Restart ComfyUI to apply changes.",1500)},"onChangeRestartApp");b.registerExtension({name:"Comfy.ElectronAdapter",settings:[{id:"Comfy-Desktop.AutoUpdate",category:["Comfy-Desktop","General","AutoUpdate"],name:"Automatically check for updates",type:"boolean",defaultValue:!0,onChange:i},{id:"Comfy-Desktop.SendStatistics",category:["Comfy-Desktop","General","Send Statistics"],name:"Send anonymous usage metrics",type:"boolean",defaultValue:!0,onChange:i},{id:"Comfy-Desktop.WindowStyle",category:["Comfy-Desktop","General","Window Style"],name:"Window Style",tooltip:"Custom: Replace the system title bar with ComfyUI's Top menu",type:"combo",experimental:!0,defaultValue:"default",options:["default","custom"],onChange:u((r,d)=>{d&&n.Config.setWindowStyle(r)},"onChange")},{id:"Comfy-Desktop.UV.PythonInstallMirror",name:"Python Install Mirror",tooltip:"Managed Python installations are downloaded from the Astral python-build-standalone project. This variable can be set to a mirror URL to use a different source for Python installations. The provided URL will replace https://github.com/astral-sh/python-build-standalone/releases/download in, e.g., https://github.com/astral-sh/python-build-standalone/releases/download/20240713/cpython-3.12.4%2B20240713-aarch64-apple-darwin-install_only.tar.gz. Distributions can be read from a local directory by using the file:// URL scheme.",type:"url",defaultValue:"",attrs:{validateUrlFn(r){return yt(r+yn.validationPathSuffix)}}},{id:"Comfy-Desktop.UV.PypiInstallMirror",name:"Pypi Install Mirror",tooltip:"Default pip install mirror",type:"url",defaultValue:"",attrs:{validateUrlFn:yt}},{id:"Comfy-Desktop.UV.TorchInstallMirror",name:"Torch Install Mirror",tooltip:"Pip install mirror for pytorch",type:"url",defaultValue:"",attrs:{validateUrlFn:yt}}],commands:[{id:"Comfy-Desktop.Folders.OpenLogsFolder",label:"Open Logs Folder",icon:"pi pi-folder-open",function(){n.openLogsFolder()}},{id:"Comfy-Desktop.Folders.OpenModelsFolder",label:"Open Models Folder",icon:"pi pi-folder-open",function(){n.openModelsFolder()}},{id:"Comfy-Desktop.Folders.OpenOutputsFolder",label:"Open Outputs Folder",icon:"pi pi-folder-open",function(){n.openOutputsFolder()}},{id:"Comfy-Desktop.Folders.OpenInputsFolder",label:"Open Inputs Folder",icon:"pi pi-folder-open",function(){n.openInputsFolder()}},{id:"Comfy-Desktop.Folders.OpenCustomNodesFolder",label:"Open Custom Nodes Folder",icon:"pi pi-folder-open",function(){n.openCustomNodesFolder()}},{id:"Comfy-Desktop.Folders.OpenModelConfig",label:"Open extra_model_paths.yaml",icon:"pi pi-file",function(){n.openModelConfig()}},{id:"Comfy-Desktop.OpenDevTools",label:"Open DevTools",icon:"pi pi-code",function(){n.openDevTools()}},{id:"Comfy-Desktop.OpenUserGuide",label:"Desktop User Guide",icon:"pi pi-book",function(){window.open(a("/installation/desktop",{includeLocale:!0,platform:!0}),"_blank")}},{id:"Comfy-Desktop.CheckForUpdates",label:"Check for Updates",icon:"pi pi-sync",async function(){try{const r=await n.checkForUpdates({disableUpdateReadyAction:!0});if(!r.isUpdateAvailable){o.add({severity:"info",summary:E("desktopUpdate.noUpdateFound"),life:5e3});return}if(await Je().confirm({title:E("desktopUpdate.updateFoundTitle",{version:r.version}),message:E("desktopUpdate.updateAvailableMessage"),type:"default"}))try{n.restartAndInstall()}catch(l){Vt.error("Error installing update:",l),o.add({severity:"error",summary:E("g.error"),detail:E("desktopUpdate.errorInstallingUpdate"),life:1e4})}}catch(r){Vt.error("Error checking for updates:",r),o.add({severity:"error",summary:E("g.error"),detail:E("desktopUpdate.errorCheckingUpdate"),life:1e4})}}},{id:"Comfy-Desktop.Reinstall",label:"Reinstall",icon:"pi pi-refresh",async function(){await Je().confirm({message:E("desktopMenu.confirmReinstall"),title:E("desktopMenu.reinstall"),type:"reinstall"})&&n.reinstall()}},{id:"Comfy-Desktop.Restart",label:"Restart",icon:"pi pi-refresh",function(){n.restartApp()}},{id:"Comfy-Desktop.Quit",label:"Quit",icon:"pi pi-sign-out",async function(){t.modifiedWorkflows.length>0&&!await Je().confirm({message:E("desktopMenu.confirmQuit"),title:E("desktopMenu.quit"),type:"default"})||n.quit()}}],menuCommands:[{path:["Help"],commands:["Comfy-Desktop.OpenUserGuide"]},{path:["Help"],commands:["Comfy-Desktop.OpenDevTools"]},{path:["Help","Open Folder"],commands:["Comfy-Desktop.Folders.OpenLogsFolder","Comfy-Desktop.Folders.OpenModelsFolder","Comfy-Desktop.Folders.OpenOutputsFolder","Comfy-Desktop.Folders.OpenInputsFolder","Comfy-Desktop.Folders.OpenCustomNodesFolder","Comfy-Desktop.Folders.OpenModelConfig"]},{path:["Help"],commands:["Comfy-Desktop.CheckForUpdates","Comfy-Desktop.Reinstall"]}],keybindings:[{commandId:"Workspace.CloseWorkflow",combo:{key:"w",ctrl:!0}}],aboutPageBadges:[{label:"ComfyUI_desktop v"+e,url:s.githubElectron,icon:"pi pi-github"}]})})();class vn extends Ro{static{u(this,"ExecutableGroupNodeChildDTO")}groupNodeHandler;constructor(e,t,o,s,a){super(e,t,o,s),this.groupNodeHandler=a}resolveInput(e){if(this.id.split(":").length>2)throw new Error("Group nodes inside subgraphs are not supported. Please convert the group node to a subgraph instead.");const t=this.node.getInputNode(e);if(!t)return;const o=this.node.getInputLink(e);if(!o)throw new Error("Failed to get input link");const s=String(t.id);let a=this.nodesByExecutionId?.get(s);if(!a){const i=s.split(":").at(-1);i!==void 0&&(a=this.nodesByExecutionId?.get(i))}if(!a)throw new Error(`Failed to get input node ${s} for group node child ${this.id} with slot ${e}`);return{node:a,origin_id:s,origin_slot:o.origin_slot}}}const vt=Symbol();function bo(n,e){if(typeof n=="object"&&typeof e=="object")for(const t in e){const o=e[t];if(typeof o=="object"){let s=n[t];s||(s=n[t]={}),bo(s,e[t])}else n[t]=o}return n}u(bo,"merge");class ko extends Ao{static{u(this,"ManageGroupDialog")}tabs;selectedNodeIndex;selectedTab="Inputs";selectedGroup;modifications={};nodeItems;app;groupNodeType;groupNodeDef;groupData;innerNodesList;widgetsPage;inputsPage;outputsPage;draggable;get selectedNodeInnerIndex(){return+this.nodeItems[this.selectedNodeIndex].dataset.nodeindex}constructor(e){super(),this.app=e,this.element=L("dialog.comfy-group-manage",{parent:document.body})}changeTab(e){this.tabs[this.selectedTab].tab.classList.remove("active"),this.tabs[this.selectedTab].page.classList.remove("active"),this.tabs[e].tab.classList.add("active"),this.tabs[e].page.classList.add("active"),this.selectedTab=e}changeNode(e,t){!t&&this.selectedNodeIndex===e||(this.selectedNodeIndex!=null&&this.nodeItems[this.selectedNodeIndex].classList.remove("selected"),this.nodeItems[e].classList.add("selected"),this.selectedNodeIndex=e,!this.buildInputsPage()&&this.selectedTab==="Inputs"&&this.changeTab("Widgets"),!this.buildWidgetsPage()&&this.selectedTab==="Widgets"&&this.changeTab("Outputs"),!this.buildOutputsPage()&&this.selectedTab==="Outputs"&&this.changeTab("Inputs"),this.changeTab(this.selectedTab))}getGroupData(){this.groupNodeType=V.registered_node_types[`${Ie}${ke}`+this.selectedGroup],this.groupNodeDef=this.groupNodeType.nodeData,this.groupData=Te.getGroupData(this.groupNodeType)}changeGroup(e,t=!0){this.selectedGroup=e,this.getGroupData();const o=this.groupData.nodeData.nodes;if(this.nodeItems=o.map((a,i)=>L("li.draggable-item",{dataset:{nodeindex:a.index+""},onclick:u(()=>{this.changeNode(i)},"onclick")},[L("span.drag-handle"),L("div",{textContent:a.title??a.type},a.title?L("span",{textContent:a.type}):[])])),this.innerNodesList.replaceChildren(...this.nodeItems),t)this.selectedNodeIndex=null,this.changeNode(0);else{let i=this.draggable.getAllItems().findIndex(r=>r.classList.contains("selected"));i===-1&&(i=this.selectedNodeIndex),this.changeNode(i,!0)}const s=[...o];this.draggable?.dispose(),this.draggable=new Bo(this.innerNodesList,"li"),this.draggable.addEventListener("dragend",({detail:{oldPosition:a,newPosition:i}})=>{if(a!==i){s.splice(i,0,s.splice(a,1)[0]);for(let r=0;r<s.length;r++)this.storeModification({nodeIndex:s[r].index,section:vt,prop:"order",value:r})}})}storeModification(e){const{nodeIndex:t,section:o,prop:s,value:a}=e,i=this.modifications[this.selectedGroup]??={},r=i.nodes??={},d=r[t??this.selectedNodeInnerIndex]??={},l=d[o]??={};if(typeof a=="object"){const c=l[s]??={};Object.assign(c,a)}else l[s]=a}getEditElement(e,t,o,s,a,i=!0){o===s&&(o="");const r=this.modifications[this.selectedGroup]?.nodes?.[this.selectedNodeInnerIndex]?.[e]?.[t];return r&&(r.name!=null&&(o=r.name),r.visible!=null&&(a=r.visible)),L("div",[L("input",{value:o,placeholder:s,type:"text",onchange:u(d=>{this.storeModification({section:e,prop:t,value:{name:d.target.value}})},"onchange")}),L("label",{textContent:"Visible"},[L("input",{type:"checkbox",checked:a,disabled:!i,onchange:u(d=>{this.storeModification({section:e,prop:t,value:{visible:!!d.target.checked}})},"onchange")})])])}buildWidgetsPage(){const e=this.groupData.oldToNewWidgetMap[this.selectedNodeInnerIndex],t=Object.keys(e??{}),s=b.graph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.widgetsPage.replaceChildren(...t.map(a=>this.getEditElement("input",a,e[a],a,s?.[a]?.visible!==!1))),!!t.length}buildInputsPage(){const e=this.groupData.nodeInputs[this.selectedNodeInnerIndex],t=Object.keys(e??{}),s=b.graph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.input;return this.inputsPage.replaceChildren(...t.map(a=>{let i=e[a];if(i)return this.getEditElement("input",a,i,a,s?.[a]?.visible!==!1)}).filter(Boolean)),!!t.length}buildOutputsPage(){const e=this.groupData.nodeData.nodes,t=this.groupData.getNodeDef(e[this.selectedNodeInnerIndex]),o=t?.output??[],s=this.groupData.oldToNewOutputMap[this.selectedNodeInnerIndex],i=b.graph.extra.groupNodes[this.selectedGroup].config?.[this.selectedNodeInnerIndex]?.output,d=this.groupData.nodeData.nodes[this.selectedNodeInnerIndex].type!=="PrimitiveNode";return this.outputsPage.replaceChildren(...o.map((l,c)=>{const h=s?.[c],f=t.output_name?.[c]??l;let g=i?.[c]?.name;const p=i?.[c]?.visible||h!=null;return(!g||g===f)&&(g=""),this.getEditElement("output",c,g,f,p,d)}).filter(Boolean)),!!o.length}show(e){const t=Object.keys(b.graph.extra?.groupNodes??{}).sort((a,i)=>a.localeCompare(i));this.innerNodesList=L("ul.comfy-group-manage-list-items"),this.widgetsPage=L("section.comfy-group-manage-node-page"),this.inputsPage=L("section.comfy-group-manage-node-page"),this.outputsPage=L("section.comfy-group-manage-node-page");const o=L("div",[this.widgetsPage,this.inputsPage,this.outputsPage]);this.tabs=[["Inputs",this.inputsPage],["Widgets",this.widgetsPage],["Outputs",this.outputsPage]].reduce((a,[i,r])=>(a[i]={tab:L("a",{onclick:u(()=>{this.changeTab(i)},"onclick"),textContent:i}),page:r},a),{});const s=L("div.comfy-group-manage-outer",[L("header",[L("h2","Group Nodes"),L("select",{onchange:u(a=>{this.changeGroup(a.target.value)},"onchange")},t.map(a=>L("option",{textContent:a,selected:`${Ie}${ke}${a}`===e,value:a})))]),L("main",[L("section.comfy-group-manage-list",this.innerNodesList),L("section.comfy-group-manage-node",[L("header",Object.values(this.tabs).map(a=>a.tab)),o])]),L("footer",[L("button.comfy-btn",{onclick:u(()=>{if(b.graph.nodes.find(i=>i.type===`${Ie}${ke}`+this.selectedGroup)){he().addAlert("This group node is in use in the current workflow, please first remove these.");return}confirm(`Are you sure you want to remove the node: "${this.selectedGroup}"`)&&(delete b.graph.extra.groupNodes[this.selectedGroup],V.unregisterNodeType(`${Ie}${ke}`+this.selectedGroup)),this.show()},"onclick")},"Delete Group Node"),L("button.comfy-btn",{onclick:u(async()=>{let a,i=[];const r={};for(const d in this.modifications){const l=b.graph.extra.groupNodes[d];let c=l.config??={},h=this.modifications[d]?.nodes;if(h){const g=Object.keys(h);if(h[g[0]][vt]){const p=[],m={},v={};for(const w of g){const y=h[w][vt].order;p[y]=l.nodes[+w],m[y]=h[w],p[y].index=y}for(const w of l.links)w[0]!=null&&(w[0]=l.nodes[w[0]].index),w[2]!=null&&(w[2]=l.nodes[w[2]].index);if(l.external)for(const w of l.external)w[0]=l.nodes[w[0]];for(const w of g)c[w]&&(v[l.nodes[w].index]=c[w]),delete c[w];l.nodes=p,h=m,l.config=c=v}bo(c,h)}r[d]=l,a||(a=b.graph.nodes.reduce((g,p)=>(g[p.type]??=[],g[p.type].push(p),g),{}));const f=a[`${Ie}${ke}`+d];f&&i.push(...f)}await $e.registerFromWorkflow(r,{});for(const d of i)d.recreate();this.modifications={},this.app.graph.setDirtyCanvas(!0,!0),this.changeGroup(this.selectedGroup,!1)},"onclick")},"Save"),L("button.comfy-btn",{onclick:u(()=>this.element.close(),"onclick")},"Close")])]);this.element.replaceChildren(s),this.changeGroup(e?t.find(a=>`${Ie}${ke}${a}`===e)??t[0]:t[0]),this.element.showModal(),this.element.addEventListener("close",()=>{this.draggable?.dispose(),this.element.remove()})}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.groupNodeManage=window.comfyAPI.groupNodeManage||{};window.comfyAPI.groupNodeManage.ManageGroupDialog=ko;const wn=new Set(["default","forceInput","defaultInput","control_after_generate","multiline","tooltip","dynamicPrompts"]),jt=u(n=>{const e=n.min??-1/0,t=n.max??1/0;return{min:e,max:t}},"getRange"),bn=u((n,e)=>{const t=n[0],o=n[1]??{},s=e[1]??{},a=jt(o),i=jt(s);if(a.min>i.max||a.max<i.min)return null;const r=o.step??1,d=s.step??1,l={min:Math.max(a.min,i.min),max:Math.min(a.max,i.max),step:hn(r,d)};return Bt([t,{...o,...l}],[t,{...s,...l}])},"mergeNumericInputSpec"),kn=u((n,e)=>{const t=n[1]??{},o=e[1]??{},s=Wt(n),a=Wt(e),i=de.intersection(s,a);return i.length===0?null:Bt(["COMBO",{...t,options:i}],["COMBO",{...o,options:i}])},"mergeComboInputSpec"),Bt=u((n,e)=>{const t=Mt(n),o=n[1]??{},s=e[1]??{};return de.union(de.keys(o),de.keys(s)).filter(r=>!wn.has(r)).every(r=>{const d=o[r],l=s[r];return d===l||de.isNil(d)&&de.isNil(l)})?[t,{...o,...s}]:null},"mergeCommonInputSpec"),xn=u((n,e)=>{const t=Mt(n),o=Mt(e);return t!==o?null:Fo(n)||$o(n)?bn(n,e):Wo(n)?kn(n,e):Bt(n,e)},"mergeInputSpec"),Cn=u(n=>n.type==="PrimitiveNode","isPrimitiveNode"),wt="Run widget replace on values";class Nt extends rt{static{u(this,"PrimitiveNode")}controlValues;lastType;static category;constructor(e){super(e),this.addOutput("connect to widget input","*"),this.serialize_widgets=!0,this.isVirtualNode=!0,(!this.properties||!(wt in this.properties))&&this.addProperty(wt,!1,"boolean")}applyToGraph(e=[]){if(!this.outputs[0].links?.length)return;const t=[...this.outputs[0].links.map(s=>b.graph.links[s]),...e];let o=this.widgets?.[0].value;o&&this.properties[wt]&&(o=uo(b.graph,o));for(const s of t){const a=this.graph?.getNodeById(s.target_id),i=a?.inputs[s.target_slot];if(!i){console.warn("Unable to resolve node or input for link",s);continue}const r=i.widget?.name;if(!r){console.warn("Invalid widget or widget name",i.widget);continue}const d=a.widgets?.find(l=>l.name===r);if(!d){console.warn(`Unable to find widget "${r}" on node [${a.id}]`);continue}d.value=o,d.callback?.(d.value,b.canvas,a,b.canvas.graph_mouse,{})}}refreshComboInNode(){const e=this.widgets?.[0];e?.type==="combo"&&(e.options.values=this.outputs[0].widget[Ne]()[0],e.options.values.includes(e.value)||(e.value=e.options.values[0],e.callback(e.value)))}onAfterGraphConfigured(){if(this.outputs[0].links?.length&&!this.widgets?.length){if(this.#e(),this.widgets&&this.widgets_values)for(let e=0;e<this.widgets_values.length;e++){const t=this.widgets[e];t&&(t.value=this.widgets_values[e])}this.#t()}}onConnectionsChange(e,t,o){if(b.configuringGraph)return;const s=this.outputs[0].links;o?s?.length&&!this.widgets?.length&&this.#e():(this.#t(),s?.length||this.onLastDisconnect())}onConnectOutput(e,t,o,s,a){if(!o.widget&&!(o.type in Ee))return!1;if(this.outputs[e].links?.length){const i=this.#o(o);return i&&this.applyToGraph([{target_id:s.id,target_slot:a}]),i}return!0}#e(e){if(!this.outputs[0].links||!this.graph){this.onLastDisconnect();return}const t=this.outputs[0].links[0],o=this.graph.links[t];if(!o)return;const s=this.graph.getNodeById(o.target_id);if(!s||!s.inputs)return;const a=s.inputs[o.target_slot];if(!a)return;let i;if(a.widget)i=a.widget;else{if(!(a.type in Ee))return;i={name:a.name,[Ne]:()=>[a.type,{}]}}const r=i[Ne]?.();if(!r)return;const{type:d}=In(r);this.outputs[0].type=d,this.outputs[0].name=d,this.outputs[0].widget=i,this.#s(i[Qe]??r,s,i.name,e)}#s(e,t,o,s){let a=e[0];a instanceof Array&&(a="COMBO");const[i,r]=this.size;let d;if(a in Ee?d=(Ee[a](this,"value",e,b)||{}).widget:d=this.addWidget(a,"value",null,()=>{},{}),t?.widgets&&d){const c=t.widgets.find(h=>h.name===o);c&&(d.value=c.value)}if(!e?.[1]?.control_after_generate&&(d.type==="number"||d.type==="combo")){let c=this.widgets_values?.[1];c||(c="fixed"),Uo(this,d,c,void 0,e);let h=this.widgets_values?.[2];h&&this.widgets&&this.widgets.length===3&&(this.widgets[2].value=h)}const l=this.controlValues;if(this.widgets&&this.lastType===this.widgets[0]?.type&&l?.length===this.widgets.length-1)for(let c=0;c<l.length;c++)this.widgets[c+1].value=l[c];if(d.callback=Xe(d.callback,()=>{this.applyToGraph()}),this.setSize([Math.max(this.size[0],i),Math.max(this.size[1],r)]),!s){const c=this.computeSize();this.size[0]<c[0]&&(this.size[0]=c[0]),this.size[1]<c[1]&&(this.size[1]=c[1]),requestAnimationFrame(()=>{this.onResize?.(this.size)})}}recreateWidget(){const e=this.widgets?.map(t=>t.value);if(this.#n(),this.#e(!0),e?.length&&this.widgets)for(let t=0;t<this.widgets.length;t++)this.widgets[t].value=e[t];return this.widgets?.[0]}#t(){const e=this.outputs[0],t=e.links??[],o=!!e.widget?.[Qe];if(o&&delete e.widget?.[Qe],t?.length<2&&o){t.length&&this.recreateWidget();return}const s=e.widget?.[Ne]?.();if(!(!s||!(s[0]==="INT"||s[0]==="FLOAT")))for(const i of t){const r=b.graph.links[i];if(!r)continue;const d=b.graph.getNodeById(r.target_id);if(!d)continue;const l=d.inputs[r.target_slot];this.#o(l,o)}}#o(e,t){const o=this.outputs?.[0],s=e.widget?.[Ne]?.();return s?!!ot.call(this,o,s,t,this.recreateWidget):!1}#n(){if(this.widgets){for(const e of this.widgets)e.onRemove&&e.onRemove();this.controlValues=[],this.lastType=this.widgets[0]?.type;for(let e=1;e<this.widgets.length;e++)this.controlValues.push(this.widgets[e].value);setTimeout(()=>{delete this.lastType,delete this.controlValues},15),this.widgets.length=0}}onLastDisconnect(){this.outputs[0].type="*",this.outputs[0].name="connect to widget input",delete this.outputs[0].widget,this.#n()}}function Ft(n){return n.widget?.[Qe]??n.widget?.[Ne]?.()??["*",{}]}u(Ft,"getWidgetConfig");function Ht(n){const{nodeData:e}=this.constructor;return e?.input?.required?.[n]??e?.input?.optional?.[n]}u(Ht,"getConfig");function _n(n,e){return console.warn("Please remove call to convertToInput. Widget to socket conversion is no longer necessary, as they co-exist now."),n.inputs.find(t=>t.widget?.name===e.name)}u(_n,"convertToInput");function In(n){let e=n[0];return e instanceof Array&&(e="COMBO"),{type:e}}u(In,"getWidgetType");function Tt(n,e){if(n.widget&&(e?n.widget[Ne]=()=>e:delete n.widget,"link"in n)){const t=b.graph.links[n.link??-1];if(t){const o=b.graph.getNodeById(t.origin_id);o&&Cn(o)&&(e?o.recreateWidget():b.configuringGraph||(o.disconnectOutput(0),o.onLastDisconnect()))}}}u(Tt,"setWidgetConfig");function ot(n,e,t,o,s){s||(s=Ft(n));const a=xn(s,e);if(a||t){a&&(n.widget[Qe]=a);const i=o?.call(this);if(i){const r=i.options.min,d=i.options.max;r!=null&&i.value<r&&(i.value=r),d!=null&&i.value>d&&(i.value=d),i.callback(i.value)}}return{customConfig:a?.[1]??{}}}u(ot,"mergeIfValid");b.registerExtension({name:"Comfy.WidgetInputs",async beforeRegisterNodeDef(n,e,t){n.prototype.convertWidgetToInput=function(){return console.warn("Please remove call to convertWidgetToInput. Widget to socket conversion is no longer necessary, as they co-exist now."),!1},n.prototype.onGraphConfigured=Xe(n.prototype.onGraphConfigured,function(){if(this.inputs){this.widgets??=[];for(const a of this.inputs)if(a.widget){const i=a.widget.name;a.widget[Ne]||(a.widget[Ne]=()=>Ht.call(this,i)),this.widgets?.find(d=>d.name===i)||this.removeInput(this.inputs.findIndex(d=>d===a))}}}),n.prototype.onConfigure=Xe(n.prototype.onConfigure,function(){if(!t.configuringGraph&&this.inputs){for(const a of this.inputs)if(a.widget&&!a.widget[Ne]){const i=a.widget.name;a.widget[Ne]=()=>Ht.call(this,i)}}});function o(a){for(const i of t.graph.nodes)if(i.pos[0]===a[0]&&i.pos[1]===a[1])return!0;return!1}u(o,"isNodeAtPos");const s=n.prototype.onInputDblClick;n.prototype.onInputDblClick=function(...[a,...i]){const r=s?.apply(this,[a,...i]),d=this.inputs[a];if(!d.widget&&!(d.type in Ee)&&!(d.widget?.[Ne]?.()?.[0]instanceof Array))return r;const l=V.createNode("PrimitiveNode");if(!l)return r;this.graph?.add(l);const c=[this.pos[0]-l.size[0]-30,this.pos[1]];for(;o(c);)c[1]+=V.NODE_TITLE_HEIGHT;return l.pos=c,l.connect(0,this,a),l.title=d.name,r}},registerCustomNodes(){V.registerNodeType("PrimitiveNode",Object.assign(Nt,{title:"Primitive"})),Nt.category="utils"}});window.comfyAPI=window.comfyAPI||{};window.comfyAPI.widgetInputs=window.comfyAPI.widgetInputs||{};window.comfyAPI.widgetInputs.PrimitiveNode=Nt;window.comfyAPI.widgetInputs.getWidgetConfig=Ft;window.comfyAPI.widgetInputs.convertToInput=_n;window.comfyAPI.widgetInputs.setWidgetConfig=Tt;window.comfyAPI.widgetInputs.mergeIfValid=ot;const Be={InUse:{Free:0,Registered:1,InWorkflow:2},isInUseGroupNode(n){const e=`${Ie}${ke}${n}`;return b.graph.extra?.groupNodes?.[n]?b.graph.nodes.find(t=>t.type===e)?Be.InUse.InWorkflow:Be.InUse.Registered:Be.InUse.Free},storeGroupNode(n,e){let t=b.graph.extra;t||(b.graph.extra=t={});let o=t.groupNodes;o||(t.groupNodes=o={}),o[n]=e}};class Yt{static{u(this,"GroupNodeBuilder")}nodes;nodeData;constructor(e){this.nodes=e}async build(){const e=await this.getName();if(e)return this.sortNodes(),this.nodeData=this.getNodeData(),Be.storeGroupNode(e,this.nodeData),{name:e,nodeData:this.nodeData}}async getName(){const e=await Je().prompt({title:E("groupNode.create"),message:E("groupNode.enterName"),defaultValue:""});if(!e)return;switch(Be.isInUseGroupNode(e)){case Be.InUse.InWorkflow:he().addAlert("An in use group node with this name already exists embedded in this workflow, please remove any instances or use a new name.");return;case Be.InUse.Registered:if(!confirm("A group node with this name already exists embedded in this workflow, are you sure you want to overwrite it?"))return;break}return e}sortNodes(){const e=b.graph.computeExecutionOrder(!1);this.nodes=this.nodes.map(t=>({index:e.indexOf(t),node:t})).sort((t,o)=>t.index-o.index||t.node.id-o.node.id).map(({node:t})=>t)}getNodeData(){const e=u(o=>{for(const s of o.links){const i=b.graph.getNodeById(s[4]).outputs[s[1]].type;s.push(i)}},"storeLinkTypes"),t=u(o=>{o.external=[];for(let s=0;s<this.nodes.length;s++){const a=this.nodes[s];if(a.outputs?.length)for(let i=0;i<a.outputs.length;i++){let r=!1;const d=a.outputs[i];let l=d.type;if(d.links?.length){for(const c of d.links){const h=b.graph.links[c];if(h&&(l==="*"&&(l=h.type),!b.canvas.selected_nodes[h.target_id])){r=!0;break}}r&&o.external.push([s,i,l])}}}},"storeExternalLinks");try{const o=Ho(this.nodes,b.canvas?.graph),s=JSON.parse(o);return e(s),t(s),s}finally{}}}class $e{static{u(this,"GroupNodeConfig")}name;nodeData;inputCount;oldToNewOutputMap;newToOldOutputMap;oldToNewInputMap;oldToNewWidgetMap;newToOldWidgetMap;primitiveDefs;widgetToPrimitive;primitiveToWidget;nodeInputs;outputVisibility;nodeDef;inputs;linksFrom;linksTo;externalFrom;constructor(e,t){this.name=e,this.nodeData=t,this.getLinks(),this.inputCount=0,this.oldToNewOutputMap={},this.newToOldOutputMap={},this.oldToNewInputMap={},this.oldToNewWidgetMap={},this.newToOldWidgetMap={},this.primitiveDefs={},this.widgetToPrimitive={},this.primitiveToWidget={},this.nodeInputs={},this.outputVisibility=[]}async registerType(e=Ie){this.nodeDef={output:[],output_name:[],output_is_list:[],output_is_hidden:[],name:e+ke+this.name,display_name:this.name,category:"group nodes"+(ke+e),input:{required:{}},description:`Group node combining ${this.nodeData.nodes.map(s=>s.type).join(", ")}`,python_module:"custom_nodes."+this.name,[Se]:this},this.inputs=[];const t={},o={};for(let s=0;s<this.nodeData.nodes.length;s++){const a=this.nodeData.nodes[s];a.index=s,this.processNode(a,t,o)}for(const s of this.#e)s();this.#e=null,await b.registerNodeDef(`${Ie}${ke}`+this.name,this.nodeDef),zo().addNodeDef(this.nodeDef)}getLinks(){this.linksFrom={},this.linksTo={},this.externalFrom={};for(const e of this.nodeData.links){const[t,o,s,a]=e;t!=null&&(this.linksFrom[t]||(this.linksFrom[t]={}),this.linksFrom[t][o]||(this.linksFrom[t][o]=[]),this.linksFrom[t][o].push(e),this.linksTo[s]||(this.linksTo[s]={}),this.linksTo[s][a]=e)}if(this.nodeData.external)for(const e of this.nodeData.external)this.externalFrom[e[0]]?this.externalFrom[e[0]][e[1]]=e[2]:this.externalFrom[e[0]]={[e[1]]:e[2]}}processNode(e,t,o){const s=this.getNodeDef(e);if(!s)return;const a={...s.input?.required,...s.input?.optional};this.inputs.push(this.processNodeInputs(e,t,a)),s.output?.length&&this.processNodeOutputs(e,o,s)}getNodeDef(e){const t=et[e.type];if(t)return t;const o=this.linksFrom[e.index];if(e.type==="PrimitiveNode"){if(!o)return;let s=o[0][0][5];if(s==="COMBO"){const i=e.outputs[0].widget.name,r=this.nodeData.nodes[o[0][0][2]].type,d=et[r];s=(d.input.required[i]??d.input.optional[i])[0]}return this.primitiveDefs[e.index]={input:{required:{value:[s,{}]}},output:[s],output_name:[],output_is_list:[]}}else if(e.type==="Reroute"){const s=this.linksTo[e.index];if(s&&o&&!this.externalFrom[e.index]?.[0])return null;let a={},i="*";if(o)for(const[,,r,d]of o[0]){const l=this.nodeData.nodes[r],c=l.inputs[d];if(i==="*"&&(i=c.type),c.widget){const h=et[l.type],f=h.input.required[c.widget.name]??h.input.optional[c.widget.name],g=[f[0],a];a=ot({widget:g},f,!1,null,g)?.customConfig??a}}else if(s){const[r,d]=s[0];i=this.nodeData.nodes[r].outputs[d].type}else{for(const r of this.nodeData.links)if(r[2]===e.index){i=r[5];break}if(i==="*"){const r=this.externalFrom[e.index]?.[0];r&&(i=r)}}return a.forceInput=!0,{input:{required:{[i]:[i,a]}},output:[i],output_name:[],output_is_list:[]}}console.warn("Skipping virtual node "+e.type+" when building group node "+this.name)}getInputConfig(e,t,o,s,a){const i=this.nodeData.config?.[e.index]?.input?.[t];let r=i?.name??e.inputs?.find(c=>c.name===t)?.label??t,d=r,l="";return(e.type==="PrimitiveNode"&&e.title||r in o)&&(l=`${e.title??e.type} `,d=r=`${l}${t}`,r in o&&(r=`${l}${o[r]} ${t}`)),o[d]=(o[d]??1)+1,(t==="seed"||t==="noise_seed")&&(a||(a={}),a.control_after_generate=`${l}control_after_generate`),s[0]==="IMAGEUPLOAD"&&(a||(a={}),a.widget=this.oldToNewWidgetMap[e.index]?.[s[1]?.widget??"image"]??"image"),a&&(s=[s[0],{...s[1],...a}]),{name:r,config:s,customConfig:i}}processWidgetInputs(e,t,o,s){const a=[],i=new Map,r=this.oldToNewWidgetMap[t.index]={};for(const d of o)if(Vo().inputIsWidget(e[d])){const l=t.inputs?.findIndex(c=>c.name===d&&c.widget?.name===d);if(l>-1)i.set(l,d),r[d]=null;else{const{name:c,config:h}=this.getInputConfig(t,d,s,e[d]);this.nodeDef.input.required[c]=h,r[d]=c,this.newToOldWidgetMap[c]={node:t,inputName:d}}}else a.push(d);return{converted:i,slots:a}}checkPrimitiveConnection(e,t,o){if(this.nodeData.nodes[e[0]].type==="PrimitiveNode"){const[a,i,r,d]=e,l=this.primitiveDefs[a],c=o[t],h=l.input.required.value,g=ot({widget:h},c,!1,null,h);h[1]=g?.customConfig??o[t][1]?{...o[t][1]}:{};let p=this.oldToNewWidgetMap[a].value;p=p.substr(0,p.length-6),h[1].control_after_generate=!0,h[1].control_prefix=p;let m=this.widgetToPrimitive[r];m||(m=this.widgetToPrimitive[r]={}),m[t]&&m[t].push(a),m[t]=a;let v=this.primitiveToWidget[a];v||(v=this.primitiveToWidget[a]=[]),v.push({nodeId:r,inputName:t})}}processInputSlots(e,t,o,s,a,i){this.nodeInputs[t.index]={};for(let r=0;r<o.length;r++){const d=o[r];if(s[r]){this.checkPrimitiveConnection(s[r],d,e);continue}const{name:l,config:c,customConfig:h}=this.getInputConfig(t,d,i,e[d]);this.nodeInputs[t.index][d]=l,h?.visible!==!1&&(this.nodeDef.input.required[l]=c,a[r]=this.inputCount++)}}processConvertedWidgets(e,t,o,s,a,i,r){const d=[...s.keys()].sort().map(l=>s.get(l));for(let l=0;l<d.length;l++){const c=d[l];if(a[o.length+l]){this.checkPrimitiveConnection(a[o.length+l],c,e);continue}const{name:h,config:f}=this.getInputConfig(t,c,r,e[c],{defaultInput:!0});this.nodeDef.input.required[h]=f,this.newToOldWidgetMap[h]={node:t,inputName:c},this.oldToNewWidgetMap[t.index]||(this.oldToNewWidgetMap[t.index]={}),this.oldToNewWidgetMap[t.index][c]=h,i[o.length+l]=this.inputCount++}}#e=[];processNodeInputs(e,t,o){const s=[],a=Object.keys(o);if(!a.length)return;const{converted:i,slots:r}=this.processWidgetInputs(o,e,a,t),d=this.linksTo[e.index]??{},l=this.oldToNewInputMap[e.index]={};return this.processInputSlots(o,e,r,d,l,t),this.#e.push(()=>this.processConvertedWidgets(o,e,r,i,d,l,t)),s}processNodeOutputs(e,t,o){const s=this.oldToNewOutputMap[e.index]={};for(let a=0;a<o.output.length;a++){const r=this.linksFrom[e.index]?.[a]&&!this.externalFrom[e.index]?.[a],d=this.nodeData.config?.[e.index]?.output?.[a],l=d?.visible??!r;if(this.outputVisibility.push(l),!l)continue;s[a]=this.nodeDef.output.length,this.newToOldOutputMap[this.nodeDef.output.length]={node:e,slot:a},this.nodeDef.output.push(o.output[a]),this.nodeDef.output_is_list.push(o.output_is_list[a]);let c=d?.name;if(!c){c=o.output_name?.[a]??o.output[a];const f=e.outputs.find(g=>g.name===c);f?.label&&(c=f.label)}let h=c;if(h in t){const f=`${e.title??e.type} `;h=`${f}${c}`,h in t&&(h=`${f}${e.index} ${c}`)}t[h]=1,this.nodeDef.output_name.push(h)}}static async registerFromWorkflow(e,t){for(const o in e){const s=e[o];let a=!1;for(const r of s.nodes)r.type in V.registered_node_types||(t.push({type:r.type,hint:` (In group node '${Ie}${ke}${o}')`}),t.push({type:`${Ie}${ke}`+o,action:{text:"Remove from workflow",callback:u(d=>{delete e[o],d.target.textContent="Removed",d.target.style.pointerEvents="none",d.target.style.opacity=.7},"callback")}}),a=!0);if(a)continue;await new $e(o,s).registerType()}}}class Te{static{u(this,"GroupNodeHandler")}node;groupData;innerNodes;constructor(e){this.node=e,this.groupData=e.constructor?.nodeData?.[Se],this.node.setInnerNodes=g=>{this.innerNodes=g;for(let p=0;p<this.innerNodes.length;p++){const m=this.innerNodes[p];m.graph??=this.node.graph;for(const v of m.widgets??[])v.type==="converted-widget"&&(v.serializeValue=v.origSerializeValue);m.index=p,m.getInputNode=v=>{const w=this.groupData.oldToNewInputMap[m.index]?.[v];if(w!=null)return this.node.getInputNode(w);const y=this.groupData.linksTo[m.index]?.[v];if(!y)return null;const k=g[y[0]];return k.type==="PrimitiveNode"?null:k},m.getInputLink=v=>{const w=this.groupData.oldToNewInputMap[m.index]?.[v];if(w!=null){const k=this.node.inputs[w].link;let _=b.graph.links[k];return _={..._,target_id:m.id,target_slot:+v},_}let y=this.groupData.linksTo[m.index]?.[v];return y?(y={origin_id:g[y[0]].id,origin_slot:y[1],target_id:m.id,target_slot:+v},y):null}}},this.node.updateLink=g=>{g={...g};const p=this.groupData.newToOldOutputMap[g.origin_slot];let m=this.innerNodes[p.node.index],v;for(;m?.type==="Reroute";)v=m.getInputLink(0),m=m.getInputNode(0);return m?v&&Te.isGroupNode(m)?m.updateLink(v):(g.origin_id=m.id,g.origin_slot=v?.origin_slot??p.slot,g):null},this.node.getInnerNodes=(g,p=[],m=[],v=new Set)=>{if(v.has(this.node))throw new Error("RecursionError: while flattening subgraph");v.add(this.node),this.innerNodes||this.node.setInnerNodes(this.groupData.nodeData.nodes.map((k,_)=>{const C=V.createNode(k.type);return C.configure(k),C.id=`${this.node.id}:${_}`,C.graph=this.node.graph,C})),this.updateInnerWidgets();const w=[...p,this.node.id],y=this.node.graph?.getNodeById(p.at(-1))??void 0;for(const k of this.innerNodes){k.graph??=this.node.graph;const _=String(k.id);k.id=_.split(":").at(-1);const C=new vn(k,w,g,y);k.id=_,C.groupNodeHandler=this,m.push(C)}return m},this.node.recreate=async()=>{const g=this.node.id,p=this.node.size,m=this.node.convertToNodes(),v=V.createNode(this.node.type);v.id=g,v.setInnerNodes(m),v[Se].populateWidgets(),b.graph.add(v),v.setSize([Math.max(v.size[0],p[0]),Math.max(v.size[1],p[1])]);const y=new Yt(m).getNodeData();return v[Se].groupData.nodeData.links=y.links,v[Se].replaceNodes(m),v},this.node.convertToNodes=()=>{const g=u(()=>{const v={...this.groupData.nodeData};v.nodes=[...v.nodes];const w=this.node.getInnerNodes();let y=[];for(let W=0;W<v.nodes.length;W++){let H=w?.[W]?.id;H==null||isNaN(H)?H=void 0:y.push(H),v.nodes[W]={...v.nodes[W],id:H}}po(JSON.stringify(v),b.canvas);const[k,_]=this.node.pos;let C,I;const $=y.length?y:Object.keys(b.canvas.selected_nodes),U=[];for(let W=0;W<$.length;W++){const H=$[W],j=b.graph.getNodeById(H),Q=w[W];if(U.push(j),(I==null||j.pos[0]<I)&&(I=j.pos[0]),(C==null||j.pos[1]<C)&&(C=j.pos[1]),!j.widgets)continue;const Y=this.groupData.oldToNewWidgetMap[Q.index];if(Y){const K=Object.keys(Y);for(const ve of K){const we=Y[ve];if(!we)continue;const fe=this.node.widgets.findIndex(ge=>ge.name===we);if(fe!==-1)if(Q.type==="PrimitiveNode")for(let ge=0;ge<j.widgets.length;ge++)j.widgets[ge].value=this.node.widgets[fe+ge].value;else{const ge=this.node.widgets[fe],Re=j.widgets.find(Pe=>Pe.name===ve);if(!Re)continue;Re.value=ge.value;for(let Pe=0;Pe<ge.linkedWidgets?.length;Pe++)Re.linkedWidgets[Pe].value=ge.linkedWidgets[Pe].value}}}}for(const W of U)W.pos[0]-=I-k,W.pos[1]-=C-_;return{newNodes:U,selectedIds:$}},"addInnerNodes"),p=u(v=>{for(const w in this.groupData.oldToNewInputMap){const y=v[w],k=b.graph.getNodeById(y),_=this.groupData.oldToNewInputMap[w];for(const C in _){const I=_[C];if(I==null)continue;const $=e.inputs[I];if($.link==null)continue;const U=b.graph.links[$.link];if(!U)continue;b.graph.getNodeById(U.origin_id).connect(U.origin_slot,k,+C)}}},"reconnectInputs"),m=u(v=>{for(let w=0;w<e.outputs?.length;w++){const y=e.outputs[w];if(!y.links)continue;const k=[...y.links];for(const _ of k){const C=this.groupData.newToOldOutputMap[w],I=b.graph.links[_],$=b.graph.getNodeById(I.target_id);b.graph.getNodeById(v[C.node.index]).connect(C.slot,$,I.target_slot)}}},"reconnectOutputs");b.canvas.emitBeforeChange();try{const{newNodes:v,selectedIds:w}=g();return p(w),m(w),b.graph.remove(this.node),v}finally{b.canvas.emitAfterChange()}};const t=this.node.getExtraMenuOptions;this.node.getExtraMenuOptions=function(g,p){t?.apply(this,arguments);let m=p.findIndex(v=>v?.content==="Outputs");m===-1?m=p.length:m++,p.splice(m,0,null,{content:"Convert to nodes",callback:u(()=>this.convertToNodes(),"callback")},{content:"Manage Group Node",callback:u(()=>Pt(this.type),"callback")})};const o=this.node.onDrawTitleBox;this.node.onDrawTitleBox=function(g,p){o?.apply(this,arguments);const m=g.fillStyle;g.beginPath(),g.rect(11,-p+11,2,2),g.rect(14,-p+11,2,2),g.rect(17,-p+11,2,2),g.rect(11,-p+14,2,2),g.rect(14,-p+14,2,2),g.rect(17,-p+14,2,2),g.rect(11,-p+17,2,2),g.rect(14,-p+17,2,2),g.rect(17,-p+17,2,2),g.fillStyle=this.boxcolor||V.NODE_DEFAULT_BOXCOLOR,g.fill(),g.fillStyle=m};const s=e.onDrawForeground,a=this.groupData.nodeData;e.onDrawForeground=function(g){s?.apply?.(this,arguments);const p=Go().nodeProgressStates[this.id];if(p&&p.state==="running"&&this.runningInternalNodeId!==null){const m=a.nodes[this.runningInternalNodeId];if(!m)return;const v=`Running ${m.title||m.type} (${this.runningInternalNodeId}/${a.nodes.length})`;g.save(),g.font="12px sans-serif";const w=g.measureText(v);g.fillStyle=e.boxcolor||V.NODE_DEFAULT_BOXCOLOR,g.beginPath(),g.roundRect(0,-V.NODE_TITLE_HEIGHT-20,w.width+12,20,5),g.fill(),g.fillStyle="#fff",g.fillText(v,6,-V.NODE_TITLE_HEIGHT-6),g.restore()}};const i=this.node.onExecutionStart;this.node.onExecutionStart=function(){return this.resetExecution=!0,i?.apply(this,arguments)};const r=this,d=this.node.onNodeCreated;this.node.onNodeCreated=function(){if(!this.widgets)return;const g=r.groupData.nodeData.config;if(g)for(const p in g){const m=g[p]?.input;for(const v in m){if(m[v].visible!==!1)continue;const w=r.groupData.oldToNewWidgetMap[p][v],y=this.widgets.find(k=>k.name===w);y&&(y.type="hidden",y.computeSize=()=>[0,-4])}}return d?.apply(this,arguments)};function l(g,p,m){const v=u(({detail:w})=>{const y=p(w);if(!y||b.graph.getNodeById(y))return;const _=this.innerNodes?.findIndex(C=>C.id==y);_>-1&&(this.node.runningInternalNodeId=_,ae.dispatchCustomEvent(g,m(w,`${this.node.id}`,this.node)))},"handler");return ae.addEventListener(g,v),v}u(l,"handleEvent");const c=l.call(this,"executing",g=>g,(g,p)=>p),h=l.call(this,"executed",g=>g?.display_node||g?.node,(g,p,m)=>({...g,node:p,display_node:p,merge:!m.resetExecution})),f=e.onRemoved;this.node.onRemoved=function(){f?.apply(this,arguments),ae.removeEventListener("executing",c),ae.removeEventListener("executed",h)},this.node.refreshComboInNode=g=>{for(const p in this.groupData.newToOldWidgetMap){const m=this.node.widgets.find(v=>v.name===p);if(m?.type==="combo"){const v=this.groupData.newToOldWidgetMap[p],w=g[v.node.type],y=w?.input?.required?.[v.inputName]??w?.input?.optional?.[v.inputName];if(!y)continue;m.options.values=y[0],v.inputName!=="image"&&!m.options.values.includes(m.value)&&(m.value=m.options.values[0],m.callback(m.value))}}}}updateInnerWidgets(){for(const e in this.groupData.newToOldWidgetMap){const t=this.node.widgets.find(r=>r.name===e);if(!t)continue;const o=t.value,s=this.groupData.newToOldWidgetMap[e];let a=this.innerNodes[s.node.index];if(a.type==="PrimitiveNode"){a.primitiveValue=o;const r=this.groupData.primitiveToWidget[s.node.index];for(const d of r??[]){const c=this.innerNodes[d.nodeId].widgets.find(h=>h.name===d.inputName);c&&(c.value=o)}continue}else if(a.type==="Reroute"){const r=this.groupData.linksFrom[s.node.index];if(r)for(const[d,,l,c]of r[0]){const h=this.innerNodes[l],f=h.inputs[c];if(f.widget){const g=h.widgets?.find(p=>p.name===f.widget.name);g&&(g.value=o)}}}const i=a.widgets?.find(r=>r.name===s.inputName);i&&(i.value=o)}}populatePrimitive(e,t,o){const s=this.groupData.widgetToPrimitive[t]?.[o];if(s==null)return;const a=this.groupData.oldToNewWidgetMap[s].value,i=this.node.widgets.findIndex(r=>r.name===a);if(i>-1){const r=this.innerNodes[s];let d=r.widgets.length;d-1!==this.node.widgets[i].linkedWidgets?.length&&(d=1);for(let l=0;l<d;l++)this.node.widgets[i+l].value=r.widgets[l].value}return!0}populateReroute(e,t,o){if(e.type!=="Reroute")return;const s=this.groupData.linksFrom[t]?.[0]?.[0];if(!s)return;const[,,a,i]=s,r=this.groupData.nodeData.nodes[a],d=r.inputs;if(!d?.[i]?.widget)return;const c=d.length-(r.widgets_values?.length??0),h=r.widgets_values?.[i-c];if(h==null)return;const f=Object.values(o)[0],g=this.node.widgets.find(p=>p.name===f);g&&(g.value=h)}populateWidgets(){if(this.node.widgets)for(let e=0;e<this.groupData.nodeData.nodes.length;e++){const t=this.groupData.nodeData.nodes[e],o=this.groupData.oldToNewWidgetMap[e]??{},s=Object.keys(o);if(!t.widgets_values?.length){this.populateReroute(t,e,o);continue}let a=0;for(let i=0;i<s.length;i++){const r=s[i],d=o[r],l=this.node.widgets.findIndex(h=>h.name===d),c=this.node.widgets[l];if(this.populatePrimitive(t,e,r)||l===-1){const h=this.innerNodes[e].widgets?.find(f=>f.name===r);a+=h?.linkedWidgets?.length??0}if(l!==-1){c.value=t.widgets_values[i+a];for(let h=0;h<c.linkedWidgets?.length;h++)this.node.widgets[l+h+1].value=t.widgets_values[i+ ++a]}}}}replaceNodes(e){let t,o;for(let s=0;s<e.length;s++){const a=e[s];(o==null||a.pos[0]<o)&&(o=a.pos[0]),(t==null||a.pos[1]<t)&&(t=a.pos[1]),this.linkOutputs(a,s),b.graph.remove(a),a.id=`${this.node.id}:${s}`}this.linkInputs(),this.node.pos=[o,t]}linkOutputs(e,t){if(e.outputs)for(const o of e.outputs){if(!o.links)continue;const s=[...o.links];for(const a of s){const i=b.graph.links[a];if(!i)continue;const r=b.graph.getNodeById(i.target_id),d=this.groupData.oldToNewOutputMap[t]?.[i.origin_slot];d!=null&&this.node.connect(d,r,i.target_slot)}}}linkInputs(){for(const e of this.groupData.nodeData.links??[]){const[,t,o,s,a]=e,i=b.graph.getNodeById(a);i&&i.connect(t,this.node.id,this.groupData.oldToNewInputMap[o][s])}}static getGroupData(e){return(e.nodeData??e.constructor?.nodeData)?.[Se]}static isGroupNode(e){return!!e.constructor?.nodeData?.[Se]}static async fromNodes(e){const t=new Yt(e),o=await t.build();if(!o)return;const{name:s,nodeData:a}=o;await new $e(s,a).registerType();const r=V.createNode(`${Ie}${ke}${s}`);return r.setInnerNodes(t.nodes),r[Se].populateWidgets(),b.graph.add(r),r[Se].replaceNodes(t.nodes),r}}const Dn=u(n=>{for(const e of n)typeof e.type=="string"&&e.type.startsWith("workflow/")&&(e.type=e.type.replace(/^workflow\//,`${Ie}${ke}`))},"replaceLegacySeparators");async function bt(){const n=Object.values(b.canvas.selected_nodes??{});if(n.length===0)throw new Error("No nodes selected");if(n.length===1)throw new Error("Please select multiple nodes to convert to group node");for(const e of n){if(e instanceof jo)throw new Error("Selected nodes contain a subgraph node");if(Te.isGroupNode(e))throw new Error("Selected nodes contain a group node")}return await Te.fromNodes(n)}u(bt,"convertSelectedNodesToGroupNode");const Xt=u(n=>n.length<2||!!n.find(e=>Te.isGroupNode(e)),"convertDisabled");function Sn(){const n=Object.values(b.canvas.selected_nodes??{});for(const e of n)Te.isGroupNode(e)&&e.convertToNodes?.()}u(Sn,"ungroupSelectedGroupNodes");function Pt(n){new ko(b).show(n)}u(Pt,"manageGroupNodes");const Mn="Comfy.GroupNode";let et;const Nn={name:Mn,commands:[{id:"Comfy.GroupNode.ConvertSelectedNodesToGroupNode",label:"Convert selected nodes to group node",icon:"pi pi-sitemap",versionAdded:"1.3.17",function:u(()=>bt(),"function")},{id:"Comfy.GroupNode.UngroupSelectedGroupNodes",label:"Ungroup selected group nodes",icon:"pi pi-sitemap",versionAdded:"1.3.17",function:u(()=>Sn(),"function")},{id:"Comfy.GroupNode.ManageGroupNodes",label:"Manage group nodes",icon:"pi pi-cog",versionAdded:"1.3.17",function:u((...n)=>Pt(n[0]),"function")}],keybindings:[{commandId:"Comfy.GroupNode.ConvertSelectedNodesToGroupNode",combo:{alt:!0,key:"g"}},{commandId:"Comfy.GroupNode.UngroupSelectedGroupNodes",combo:{alt:!0,shift:!0,key:"G"}}],getCanvasMenuItems(n){const e=[],t=Object.values(n.selected_nodes??{}),o=!Xt(t);e.push({content:"Convert to Group Node (Deprecated)",disabled:!o,callback:u(()=>bt(),"callback")});const s=n.graph?.extra?.groupNodes,a=!s||!Object.keys(s).length;return e.push({content:"Manage Group Nodes",disabled:a,callback:u(()=>Pt(),"callback")}),e},getNodeMenuItems(n){if(Te.isGroupNode(n))return[];const e=Object.values(b.canvas.selected_nodes??{});return[{content:"Convert to Group Node (Deprecated)",disabled:!!Xt(e),callback:u(()=>bt(),"callback")}]},async beforeConfigureGraph(n,e){const t=n?.extra?.groupNodes;t&&(Dn(n.nodes),await $e.registerFromWorkflow(t,e))},addCustomNodeDefs(n){et=n},nodeCreated(n){Te.isGroupNode(n)&&(n[Se]=new Te(n),n.title&&n[Se]?.groupData?.nodeData&&Be.storeGroupNode(n.title,n[Se].groupData.nodeData))},async refreshComboInNodes(n){Object.assign(et,n);const e=b.graph.extra?.groupNodes;e&&await $e.registerFromWorkflow(e,{})}};b.registerExtension(Nn);window.comfyAPI=window.comfyAPI||{};window.comfyAPI.groupNode=window.comfyAPI.groupNode||{};window.comfyAPI.groupNode.GroupNodeConfig=$e;window.comfyAPI.groupNode.GroupNodeHandler=Te;function De(n,e){n.mode=e,n.graph?.change()}u(De,"setNodeMode");function Zt(n,e){const t=Ye().get("Comfy.GroupSelectedNodes.Padding");n.resizeTo([...n.children,...e],t)}u(Zt,"addNodesToGroup");const Tn={name:"Comfy.GroupOptions",getCanvasMenuItems(n){const e=[],t=n.graph.getGroupOnPos(n.graph_mouse[0],n.graph_mouse[1]);if(!t)return n.selectedItems.size>0&&e.push({content:"Add Group For Selected Nodes",callback:u(()=>{const a=new Yo;Zt(a,n.selectedItems),n.graph.add(a),n.graph.change(),a.recomputeInsideNodes()},"callback")}),e;t.recomputeInsideNodes();const o=t.nodes;if(e.push({content:"Add Selected Nodes To Group",disabled:!n.selectedItems?.size,callback:u(()=>{Zt(t,n.selectedItems),n.graph.change()},"callback")}),o.length===0)return e;e.push(null);let s=!0;for(let a=1;a<o.length;a++)if(o[a].mode!==o[0].mode){s=!1;break}if(e.push({content:"Fit Group To Nodes",callback:u(()=>{t.recomputeInsideNodes();const a=Ye().get("Comfy.GroupSelectedNodes.Padding");t.resizeTo(t.children,a),n.graph.change()},"callback")}),e.push({content:"Select Nodes",callback:u(()=>{n.selectNodes(o),n.graph.change(),n.canvas.focus()},"callback")}),s)switch(o[0].mode){case 0:e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const i of o)De(i,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const i of o)De(i,4)},"callback")});break;case 2:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const i of o)De(i,0)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const i of o)De(i,4)},"callback")});break;case 4:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const i of o)De(i,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const i of o)De(i,2)},"callback")});break;default:e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const i of o)De(i,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const i of o)De(i,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const i of o)De(i,4)},"callback")});break}else e.push({content:"Set Group Nodes to Always",callback:u(()=>{for(const a of o)De(a,0)},"callback")}),e.push({content:"Set Group Nodes to Never",callback:u(()=>{for(const a of o)De(a,2)},"callback")}),e.push({content:"Bypass Group Nodes",callback:u(()=>{for(const a of o)De(a,4)},"callback")});return e}};b.registerExtension(Tn);const Pn=[{label:"GLB",value:"glb"},{label:"OBJ",value:"obj"},{label:"STL",value:"stl"}];function pt(n){return[null,{content:"Save",has_submenu:!0,callback:u((e,t,o,s)=>{const a=Pn.map(i=>({content:i.label,callback:u(()=>{(async()=>{try{await n.exportModel(i.value),he().add({severity:"success",summary:E("toastMessages.exportSuccess",{format:i.label})})}catch(r){console.error("Export failed:",r),he().addAlert(E("toastMessages.failedToExportModel",{format:i.label}))}})()},"callback")}));new V.ContextMenu(a,{event:o,parentMenu:s})},"callback")}]}u(pt,"createExportMenuItems");window.comfyAPI=window.comfyAPI||{};window.comfyAPI.exportMenuHelper=window.comfyAPI.exportMenuHelper||{};window.comfyAPI.exportMenuHelper.createExportMenuItems=pt;class $t{static{u(this,"Load3DConfiguration")}constructor(e,t){this.load3d=e,this.properties=t}configureForSaveMesh(e,t){this.setupModelHandlingForSaveMesh(t,e),this.setupDefaultProperties()}configure(e){this.setupModelHandling(e.modelWidget,e.loadFolder,e.cameraState),this.setupTargetSize(e.width,e.height),this.setupDefaultProperties(e.bgImagePath)}setupTargetSize(e,t){e&&t&&(this.load3d.setTargetSize(e.value,t.value),e.callback=o=>{this.load3d.setTargetSize(o,t.value)},t.callback=o=>{this.load3d.setTargetSize(e.value,o)})}setupModelHandlingForSaveMesh(e,t){const o=this.createModelUpdateHandler(t);e&&o(e)}setupModelHandling(e,t,o){const s=this.createModelUpdateHandler(t,o);e.value&&s(e.value);const a=e.callback;let i=e.value;Object.defineProperty(e,"value",{get(){return i},set(r){i=r,e.callback&&r!==void 0&&r!==""&&e.callback(r)},enumerable:!0,configurable:!0}),e.callback=r=>{s(r),a&&a(r)}}setupDefaultProperties(e){const t=this.loadSceneConfig();this.applySceneConfig(t,e);const o=this.loadCameraConfig();this.applyCameraConfig(o);const s=this.loadLightConfig();this.applyLightConfig(s)}loadSceneConfig(){return this.properties&&"Scene Config"in this.properties?this.properties["Scene Config"]:{showGrid:Ye().get("Comfy.Load3D.ShowGrid"),backgroundColor:"#"+Ye().get("Comfy.Load3D.BackgroundColor"),backgroundImage:""}}loadCameraConfig(){return this.properties&&"Camera Config"in this.properties?this.properties["Camera Config"]:{cameraType:Ye().get("Comfy.Load3D.CameraType"),fov:35}}loadLightConfig(){return this.properties&&"Light Config"in this.properties?this.properties["Light Config"]:{intensity:Ye().get("Comfy.Load3D.LightIntensity")}}loadModelConfig(){return this.properties&&"Model Config"in this.properties?this.properties["Model Config"]:{upDirection:"original",materialMode:"original"}}applySceneConfig(e,t){if(this.load3d.toggleGrid(e.showGrid),this.load3d.setBackgroundColor(e.backgroundColor),e.backgroundImage){if(t&&t!=e.backgroundImage)return;this.load3d.setBackgroundImage(e.backgroundImage),e.backgroundRenderMode&&this.load3d.setBackgroundRenderMode(e.backgroundRenderMode)}}applyCameraConfig(e){this.load3d.toggleCamera(e.cameraType),this.load3d.setFOV(e.fov),e.state&&this.load3d.setCameraState(e.state)}applyLightConfig(e){this.load3d.setLightIntensity(e.intensity)}applyModelConfig(e){this.load3d.setUpDirection(e.upDirection),this.load3d.setMaterialMode(e.materialMode)}createModelUpdateHandler(e,t){let o=!0;return async s=>{if(!s)return;const a=s;this.setResourceFolder(a);const i=ae.apiURL(Le.getResourceURL(...Le.splitFilePath(a),e));await this.load3d.loadModel(i,a);const r=this.loadModelConfig();if(this.applyModelConfig(r),o&&t){try{this.load3d.setCameraState(t)}catch(d){console.warn("Failed to restore camera state:",d)}o=!1}}}setResourceFolder(e){const t=e.split("/").filter(a=>a.trim());if(t.length<=2)return;const s=t.slice(1,-1).join("/");s&&this.properties&&(this.properties["Resource Folder"]=s)}}const En={name:"image",type:"Load3D",isPreview:!1},qt={name:"image",type:"Preview3D",isPreview:!0};async function Ln(n,e){if(!n?.length)return;const t=e.widgets?.find(o=>o.name==="model_file");try{const o=e.properties["Resource Folder"]||"",s=o.trim()?`3d/${o.trim()}`:"3d",a=await Le.uploadFile(n[0],s);if(!a){he().addAlert(E("toastMessages.fileUploadFailed"));return}const i=ae.apiURL(Le.getResourceURL(...Le.splitFilePath(a),"input"));tt(e).waitForLoad3d(r=>{try{r.loadModel(i)}catch{he().addAlert(E("toastMessages.failedToLoadModel"))}}),a&&t&&(t.options?.values?.includes(a)||t.options?.values?.push(a),t.value=a)}catch(o){console.error("Model upload failed:",o),he().addAlert(E("toastMessages.fileUploadFailed"))}}u(Ln,"handleModelUpload");async function On(n,e){if(n?.length)try{const t=e.properties["Resource Folder"]||"",o=t.trim()?`3d/${t.trim()}`:"3d";await Le.uploadMultipleFiles(n,o)}catch(t){console.error("Extra resources upload failed:",t),he().addAlert(E("toastMessages.extraResourcesUploadFailed"))}}u(On,"handleResourcesUpload");function Kt(n,e=!1){const t=document.createElement("input");return t.type="file",t.accept=n,t.multiple=e,t.style.display="none",t}u(Kt,"createFileInput");Ze().registerExtension({name:"Comfy.Load3D",settings:[{id:"Comfy.Load3D.ShowGrid",category:["3D","Scene","Initial Grid Visibility"],name:"Initial Grid Visibility",tooltip:"Controls whether the grid is visible by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.",type:"boolean",defaultValue:!0,experimental:!0},{id:"Comfy.Load3D.BackgroundColor",category:["3D","Scene","Initial Background Color"],name:"Initial Background Color",tooltip:"Controls the default background color of the 3D scene. This setting determines the background appearance when a new 3D widget is created, but can be adjusted individually for each widget after creation.",type:"color",defaultValue:"282828",experimental:!0},{id:"Comfy.Load3D.CameraType",category:["3D","Camera","Initial Camera Type"],name:"Initial Camera Type",tooltip:"Controls whether the camera is perspective or orthographic by default when a new 3D widget is created. This default can still be toggled individually for each widget after creation.",type:"combo",options:["perspective","orthographic"],defaultValue:"perspective",experimental:!0},{id:"Comfy.Load3D.LightIntensity",category:["3D","Light","Initial Light Intensity"],name:"Initial Light Intensity",tooltip:"Sets the default brightness level of lighting in the 3D scene. This value determines how intensely lights illuminate objects when a new 3D widget is created, but can be adjusted individually for each widget after creation.",type:"number",defaultValue:3,experimental:!0},{id:"Comfy.Load3D.LightIntensityMaximum",category:["3D","Light","Light Intensity Maximum"],name:"Light Intensity Maximum",tooltip:"Sets the maximum allowable light intensity value for 3D scenes. This defines the upper brightness limit that can be set when adjusting lighting in any 3D widget.",type:"number",defaultValue:10,experimental:!0},{id:"Comfy.Load3D.LightIntensityMinimum",category:["3D","Light","Light Intensity Minimum"],name:"Light Intensity Minimum",tooltip:"Sets the minimum allowable light intensity value for 3D scenes. This defines the lower brightness limit that can be set when adjusting lighting in any 3D widget.",type:"number",defaultValue:1,experimental:!0},{id:"Comfy.Load3D.LightAdjustmentIncrement",category:["3D","Light","Light Adjustment Increment"],name:"Light Adjustment Increment",tooltip:"Controls the increment size when adjusting light intensity in 3D scenes. A smaller step value allows for finer control over lighting adjustments, while a larger value results in more noticeable changes per adjustment.",type:"slider",attrs:{min:.1,max:1,step:.1},defaultValue:.5,experimental:!0},{id:"Comfy.Load3D.3DViewerEnable",category:["3D","3DViewer","Enable"],name:"Enable 3D Viewer (Beta)",tooltip:"Enables the 3D Viewer (Beta) for selected nodes. This feature allows you to visualize and interact with 3D models directly within the full size 3d viewer.",type:"boolean",defaultValue:!1,experimental:!0}],commands:[{id:"Comfy.3DViewer.Open3DViewer",icon:"pi pi-pencil",label:"Open 3D Viewer (Beta) for Selected Node",function:u(()=>{const n=b.canvas.selected_nodes;if(!n||Object.keys(n).length!==1)return;const e=n[Object.keys(n)[0]];if(!Xo(e))return;X.copyToClipspace(e),X.clipspace_return_node=e;const t={node:e};nt().showDialog({key:"global-load3d-viewer",title:E("load3d.viewer.title"),component:Zo,props:t,dialogComponentProps:{style:"width: 80vw; height: 80vh;",maximizable:!0,onClose:u(async()=>{await lt().handleViewerClose(t.node)},"onClose")}})},"function")}],getCustomWidgets(){return{LOAD_3D(n){const e=Kt(".gltf,.glb,.obj,.fbx,.stl",!1);n.properties["Resource Folder"]="",e.onchange=async()=>{await Ln(e.files,n)},n.addWidget("button","upload 3d model","upload3dmodel",()=>{e.click()});const t=Kt("*",!0);t.onchange=async()=>{await On(t.files,n),t.value=""},n.addWidget("button","upload extra resources","uploadExtraResources",()=>{t.click()}),n.addWidget("button","clear","clear",()=>{tt(n).waitForLoad3d(a=>{a.clearModel()});const s=n.widgets?.find(a=>a.name==="model_file");s&&(s.value="")});const o=new Lt({node:n,name:"image",component:At,inputSpec:En,options:{}});return o.type="load3D",Ot(n,o),{widget:o}}}},getNodeMenuItems(n){if(n.constructor.comfyClass!=="Load3D")return[];const e=lt().getLoad3d(n);return e?pt(e):[]},async nodeCreated(n){if(n.constructor.comfyClass!=="Load3D")return;const[e,t]=n.size;n.setSize([Math.max(e,300),Math.max(t,600)]),await Rt(),tt(n).waitForLoad3d(o=>{const a=n.properties["Camera Config"]?.state,i=new $t(o,n.properties),r=n.widgets?.find(h=>h.name==="model_file"),d=n.widgets?.find(h=>h.name==="width"),l=n.widgets?.find(h=>h.name==="height"),c=n.widgets?.find(h=>h.name==="image");if(r&&d&&l&&c){const h={loadFolder:"input",modelWidget:r,cameraState:a,width:d,height:l};i.configure(h),c.serializeValue=async()=>{const f=qo.get(n);if(!f)return console.error("No load3d instance found for node"),null;const g=n.properties["Camera Config"]||{cameraType:f.getCurrentCameraType(),fov:f.cameraManager.perspectiveCamera.fov};g.state=f.getCameraState(),n.properties["Camera Config"]=g,f.stopRecording();const{scene:p,mask:m,normal:v}=await f.captureScene(d.value,l.value),[w,y,k]=await Promise.all([Le.uploadTempImage(p,"scene"),Le.uploadTempImage(m,"scene_mask"),Le.uploadTempImage(v,"scene_normal")]);f.handleResize();const _={image:`threed/${w.name} [temp]`,mask:`threed/${y.name} [temp]`,normal:`threed/${k.name} [temp]`,camera_info:n.properties["Camera Config"]?.state||null,recording:""},C=f.getRecordingData();if(C){const[I]=await Promise.all([Le.uploadTempImage(C,"recording","mp4")]);_.recording=`threed/${I.name} [temp]`}return _}}})}});Ze().registerExtension({name:"Comfy.Preview3D",async beforeRegisterNodeDef(n,e){e.name==="Preview3D"&&(e.input.required.image=["PREVIEW_3D"])},getNodeMenuItems(n){if(n.constructor.comfyClass!=="Preview3D")return[];const e=lt().getLoad3d(n);return e?pt(e):[]},getCustomWidgets(){return{PREVIEW_3D(n){const e=new Lt({node:n,name:qt.name,component:At,inputSpec:qt,options:{}});return e.type="load3D",Ot(n,e),{widget:e}}}},async nodeCreated(n){if(n.constructor.comfyClass!=="Preview3D")return;const[e,t]=n.size;n.setSize([Math.max(e,400),Math.max(t,550)]),await Rt();const o=n.onExecuted;tt(n).waitForLoad3d(s=>{const a=new $t(s,n.properties),i=n.widgets?.find(r=>r.name==="model_file");if(i){const r=n.properties["Last Time Model File"];if(r){i.value=r;const l=n.properties["Camera Config"]?.state,c={loadFolder:"output",modelWidget:i,cameraState:l};a.configure(c)}n.onExecuted=function(d){o?.apply(this,arguments);let l=d.result[0];if(!l){const g=E("toastMessages.unableToGetModelFilePath");console.error(g),he().addAlert(g)}let c=d.result[1],h=d.result[2];i.value=l.replaceAll("\\","/"),n.properties["Last Time Model File"]=i.value;const f={loadFolder:"output",modelWidget:i,cameraState:c,bgImagePath:h};a.configure(f),h&&s.setBackgroundImage(h)}}})}});var ye=(n=>(n.Arc="arc",n.Rect="rect",n))(ye||{}),Z=(n=>(n.MaskPen="pen",n.PaintPen="rgbPaint",n.Eraser="eraser",n.MaskBucket="paintBucket",n.MaskColorFill="colorSelect",n))(Z||{});const xo=["pen","rgbPaint","eraser","paintBucket","colorSelect"];var _e=(n=>(n.SourceOver="source-over",n.DestinationOut="destination-out",n))(_e||{}),xe=(n=>(n.Black="black",n.White="white",n.Negative="negative",n))(xe||{}),Fe=(n=>(n.Simple="simple",n.HSL="hsl",n.LAB="lab",n))(Fe||{});window.comfyAPI=window.comfyAPI||{};window.comfyAPI.types=window.comfyAPI.types||{};window.comfyAPI.types.BrushShape=ye;window.comfyAPI.types.Tools=Z;window.comfyAPI.types.allTools=xo;window.comfyAPI.types.CompositionOperation=_e;window.comfyAPI.types.MaskBlendMode=xe;window.comfyAPI.types.ColorComparisonMethod=Fe;function Rn(n=20){const e=ie(),t=D([]),o=D(-1),s=D(!1),a=se(()=>t.value.length>1&&o.value>0),i=se(()=>t.value.length>1&&o.value<t.value.length-1),r=u(()=>{const g=e.maskCtx,p=e.rgbCtx,m=e.maskCanvas,v=e.rgbCanvas;if(!g||!p||!m||!v){requestAnimationFrame(r);return}if(!m.width||!v.width){requestAnimationFrame(r);return}t.value=[];const w=g.getImageData(0,0,m.width,m.height),y=p.getImageData(0,0,v.width,v.height);t.value.push({mask:w,rgb:y}),o.value=0,s.value=!0},"saveInitialState"),d=u(()=>{const g=e.maskCtx,p=e.rgbCtx,m=e.maskCanvas,v=e.rgbCanvas;if(!g||!p||!m||!v)return;if(!s.value||o.value===-1){r();return}t.value=t.value.slice(0,o.value+1);const w=g.getImageData(0,0,m.width,m.height),y=p.getImageData(0,0,v.width,v.height);t.value.push({mask:w,rgb:y}),o.value++,t.value.length>n&&(t.value.shift(),o.value--)},"saveState"),l=u(()=>{if(!a.value){alert("No more undo states available");return}o.value--,h(t.value[o.value])},"undo"),c=u(()=>{if(!i.value){alert("No more redo states available");return}o.value++,h(t.value[o.value])},"redo"),h=u(g=>{const p=e.maskCtx,m=e.rgbCtx;!p||!m||(p.putImageData(g.mask,0,0),m.putImageData(g.rgb,0,0))},"restoreState");return{canUndo:a,canRedo:i,saveInitialState:r,saveState:d,undo:l,redo:c,clearStates:u(()=>{t.value=[],o.value=-1,s.value=!1},"clearStates")}}u(Rn,"useCanvasHistory");const ie=vo("maskEditor",()=>{const n=D({type:ye.Arc,size:10,opacity:.7,hardness:1,smoothingPrecision:10}),e=D(xe.Black),t=D("mask"),o=D("#FF0000"),s=D(Z.MaskPen),a=D(!1),i=D(5),r=D(100),d=D(20),l=D(!1),c=D(Fe.Simple),h=D(!1),f=D(!1),g=D(0),p=D(100),m=D(1),v=D(1),w=D({x:0,y:0}),y=D({x:0,y:0}),k=D(0),_=D(null),C=D(null),I=D(null),$=D(null),U=D(null),W=D(null),H=D(null),j=D(null),Q=D(null),Y=D(null),K=D(.8),ve=D(!0),we=D(!1),fe=D(!1),ge=Rn(20);ze(_,G=>{G&&(C.value=G.getContext("2d",{willReadFrequently:!0}))}),ze(I,G=>{G&&($.value=G.getContext("2d",{willReadFrequently:!0}))}),ze(U,G=>{G&&(W.value=G.getContext("2d",{willReadFrequently:!0}))});const Re=se(()=>ge.canUndo.value),Pe=se(()=>ge.canRedo.value),S=se(()=>{switch(e.value){case xe.Black:return{r:0,g:0,b:0};case xe.White:return{r:255,g:255,b:255};case xe.Negative:return{r:255,g:255,b:255};default:return{r:0,g:0,b:0}}});function x(G){n.value.size=de.clamp(G,1,100)}u(x,"setBrushSize");function M(G){n.value.opacity=de.clamp(G,0,1)}u(M,"setBrushOpacity");function T(G){n.value.hardness=de.clamp(G,0,1)}u(T,"setBrushHardness");function A(G){n.value.smoothingPrecision=de.clamp(G,1,100)}u(A,"setBrushSmoothingPrecision");function F(){n.value.type=ye.Arc,n.value.size=20,n.value.opacity=1,n.value.hardness=1,n.value.smoothingPrecision=60}u(F,"resetBrushToDefault");function R(G){i.value=de.clamp(G,0,255)}u(R,"setPaintBucketTolerance");function B(G){r.value=de.clamp(G,0,100)}u(B,"setFillOpacity");function O(G){d.value=de.clamp(G,0,255)}u(O,"setColorSelectTolerance");function z(G){g.value=de.clamp(G,0,255)}u(z,"setMaskTolerance");function q(G){p.value=de.clamp(G,0,100)}u(q,"setSelectionOpacity");function J(G){m.value=Math.max(.1,Math.min(10,G))}u(J,"setZoomRatio");function ee(G){w.value={...G}}u(ee,"setPanOffset");function ne(G){y.value={...G}}u(ne,"setCursorPoint");function me(){k.value++}u(me,"resetZoom");function be(G){K.value=de.clamp(G,0,1)}u(be,"setMaskOpacity");function ce(){n.value={type:ye.Arc,size:10,opacity:.7,hardness:1,smoothingPrecision:10},e.value=xe.Black,t.value="mask",o.value="#FF0000",s.value=Z.MaskPen,a.value=!1,i.value=5,r.value=100,d.value=20,l.value=!1,c.value=Fe.Simple,h.value=!1,f.value=!1,g.value=0,p.value=100,m.value=1,w.value={x:0,y:0},y.value={x:0,y:0},K.value=.8}return u(ce,"resetState"),{brushSettings:n,maskBlendMode:e,activeLayer:t,rgbColor:o,currentTool:s,isAdjustingBrush:a,paintBucketTolerance:i,fillOpacity:r,colorSelectTolerance:d,colorSelectLivePreview:l,colorComparisonMethod:c,applyWholeImage:h,maskBoundary:f,maskTolerance:g,selectionOpacity:p,zoomRatio:m,displayZoomRatio:v,panOffset:w,cursorPoint:y,resetZoomTrigger:k,maskCanvas:_,maskCtx:C,rgbCanvas:I,rgbCtx:$,imgCanvas:U,imgCtx:W,canvasContainer:H,canvasBackground:j,pointerZone:Q,image:Y,maskOpacity:K,canUndo:Re,canRedo:Pe,maskColor:S,brushVisible:ve,isPanning:we,brushPreviewGradientVisible:fe,canvasHistory:ge,setBrushSize:x,setBrushOpacity:M,setBrushHardness:T,setBrushSmoothingPrecision:A,resetBrushToDefault:F,setPaintBucketTolerance:R,setFillOpacity:B,setColorSelectTolerance:O,setMaskTolerance:z,setSelectionOpacity:q,setZoomRatio:J,setPanOffset:ee,setCursorPoint:ne,resetZoom:me,setMaskOpacity:be,resetState:ce}}),ht=vo("maskEditorData",()=>{const n=D(null),e=D(null),t=D(null),o=D(!1),s=D(null),a=se(()=>n.value!==null),i=se(()=>e.value!==null),r=se(()=>a.value&&!o.value);return{inputData:n,outputData:e,sourceNode:t,isLoading:o,loadError:s,hasValidInput:a,hasValidOutput:i,isReady:r,reset:u(()=>{n.value=null,e.value=null,t.value=null,o.value=!1,s.value=null},"reset"),setLoading:u((c,h)=>{o.value=c,h&&(s.value=h)},"setLoading")}});function Co(){const n=ie(),e=u(async(a,i,r)=>{const d=n.maskColor;r.drawImage(a,0,0,i.width,i.height);const l=r.getImageData(0,0,i.width,i.height);for(let c=0;c<l.data.length;c+=4){const h=l.data[c+3];l.data[c]=d.r,l.data[c+1]=d.g,l.data[c+2]=d.b,l.data[c+3]=255-h}r.globalCompositeOperation="source-over",r.putImageData(l,0,0)},"prepareMask"),t=u(async(a,i,r)=>{const{imgCanvas:d,maskCanvas:l,rgbCanvas:c,imgCtx:h,maskCtx:f,rgbCtx:g}=n;if(!d||!l||!c||!h||!f||!g)throw new Error("Canvas elements or contexts not available");d.width=a.width,d.height=a.height,l.width=a.width,l.height=a.height,c.width=a.width,c.height=a.height,h.drawImage(a,0,0,a.width,a.height),r&&g.drawImage(r,0,0,r.width,r.height),await e(i,l,f)},"invalidateCanvas"),o=u(()=>{const a=n.canvasBackground;a&&(n.maskBlendMode===xe.Black?a.style.backgroundColor="rgba(0,0,0,1)":(n.maskBlendMode===xe.White||n.maskBlendMode===xe.Negative)&&(a.style.backgroundColor="rgba(255,255,255,1)"))},"setCanvasBackground");return{invalidateCanvas:t,updateMaskColor:u(async()=>{const{maskCanvas:a,maskCtx:i,maskColor:r,maskBlendMode:d,maskOpacity:l}=n;if(!a||!i)return;d===xe.Negative?(a.style.mixBlendMode="difference",a.style.opacity="1"):(a.style.mixBlendMode="initial",a.style.opacity=String(l)),i.fillStyle=`rgb(${r.r}, ${r.g}, ${r.b})`,o();const c=i.getImageData(0,0,a.width,a.height);for(let h=0;h<c.data.length;h+=4)c.data[h]=r.r,c.data[h+1]=r.g,c.data[h+2]=r.b;i.putImageData(c,0,0)},"updateMaskColor")}}u(Co,"useCanvasManager");function An(){const n=ie(),e=ht(),t=Co();return{loadImages:u(async()=>{const s=e.inputData;if(!s)throw new Error("No input data available in dataStore");const{imgCanvas:a,maskCanvas:i,rgbCanvas:r,imgCtx:d,maskCtx:l}=n;if(!a||!i||!r||!d||!l)throw new Error("Canvas elements or contexts not available");d.clearRect(0,0,a.width,a.height),l.clearRect(0,0,i.width,i.height);const c=s.baseLayer.image,h=s.maskLayer.image,f=s.paintLayer?.image;return i.width=c.width,i.height=c.height,r.width=c.width,r.height=c.height,n.image=c,await t.invalidateCanvas(c,h,f||null),await t.updateMaskColor(),c},"loadImages")}}u(An,"useImageLoaderInternal");const Bn=go(An);function Fn(){const n=ie(),e=D([]),t=u(d=>e.value.includes(d),"isKeyDown"),o=u(()=>{e.value=[]},"clearKeys"),s=u(d=>{if(e.value.includes(d.key)||e.value.push(d.key),d.key===" "){d.preventDefault();const l=document.activeElement;l&&l.blur&&l.blur()}if((d.ctrlKey||d.metaKey)&&!d.altKey){const l=d.key.toUpperCase();l==="Y"&&!d.shiftKey||l==="Z"&&d.shiftKey?n.canvasHistory.redo():l==="Z"&&!d.shiftKey&&n.canvasHistory.undo()}},"handleKeyDown"),a=u(d=>{e.value=e.value.filter(l=>l!==d.key)},"handleKeyUp");return{isKeyDown:t,addListeners:u(()=>{document.addEventListener("keydown",s),document.addEventListener("keyup",a),window.addEventListener("blur",o)},"addListeners"),removeListeners:u(()=>{document.removeEventListener("keydown",s),document.removeEventListener("keyup",a),window.removeEventListener("blur",o)},"removeListeners")}}u(Fn,"useKeyboard");const kt="clipspace-painted-masked-";function $n(n){if(!n.startsWith(kt))return;const t=n.slice(kt.length),o=parseInt(t.split(".")[0],10);return{maskedImage:`clipspace-mask-${o}.png`,paint:`clipspace-paint-${o}.png`,paintedImage:`clipspace-painted-${o}.png`,paintedMaskedImage:`${kt}${o}.png`}}u($n,"imageLayerFilenamesIfApplicable");function xt(n){return{filename:n,subfolder:"clipspace",type:"input"}}u(xt,"toRef");function Ct(n){const e=new URLSearchParams;e.set("filename",n.ref.filename),n.ref.subfolder&&e.set("subfolder",n.ref.subfolder),n.ref.type&&e.set("type",n.ref.type);const t=ae.apiURL("/view?"+e.toString()+b.getPreviewFormatParam()+b.getRandParam()),o=new Image;return o.crossOrigin="anonymous",o.src=t,o.src}u(Ct,"mkFileUrl");function Wn(){const n=ht(),e=ho(),t=u(async l=>{n.setLoading(!0);try{o(l);const c=s(l),h=a(c);let f;if(l.widgets){const I=l.widgets.find($=>$.name==="image");I&&typeof I.value=="object"&&I.value&&"filename"in I.value&&typeof I.value.filename=="string"&&(f=I.value.filename)}const g=f||h.filename;let p,m=$n(h.filename);if(p){const I=p.painted_masked||p.painted;I&&(m={maskedImage:I,paint:p.paint||"",paintedImage:p.painted||"",paintedMaskedImage:p.painted_masked||I})}const v=m?.maskedImage?Ct({ref:xt(m.maskedImage)}):c,w=m?.maskedImage?a(v):h;let y=null;p?.paint?y=Ct({ref:xt(p.paint)}):m?.paint&&(y=Ct({ref:xt(m.paint)}));const[k,_,C]=await Promise.all([i(v,"rgb"),i(v,"a"),y?d(y):Promise.resolve(void 0)]);n.inputData={baseLayer:k,maskLayer:_,paintLayer:C,sourceRef:w,nodeId:l.id},n.sourceNode=l,n.setLoading(!1)}catch(c){const h=c instanceof Error?c.message:"Failed to load from node";throw console.error("[MaskEditorLoader]",h,c),n.setLoading(!1,h),c}},"loadFromNode");function o(l){if(!l)throw new Error("Node is null or undefined");if(!(l.imgs?.length||l.previewMediaType==="image"))throw new Error("Node has no images")}u(o,"validateNode");function s(l){if(l.images?.[0]){const h=l.images[0],f=new URLSearchParams({filename:h.filename,type:h.type||"output",subfolder:h.subfolder||""});return ae.apiURL(`/view?${f.toString()}`)}const c=e.getNodeOutputs(l);if(c?.images?.[0]){const h=c.images[0];if(!h.filename)throw new Error("nodeOutputStore image missing filename");const f=new URLSearchParams;return f.set("filename",h.filename),f.set("type",h.type||"output"),f.set("subfolder",h.subfolder||""),ae.apiURL(`/view?${f.toString()}`)}if(l.imgs?.length){const h=l.imageIndex??0,f=l.imgs[h].src;if(f&&!f.startsWith("data:"))return f}throw new Error("Unable to get image URL from node")}u(s,"getNodeImageUrl");function a(l){try{const c=new URL(l),h=c.searchParams.get("filename");if(!h)throw new Error("Image URL missing filename parameter");return{filename:h,subfolder:c.searchParams.get("subfolder")||void 0,type:c.searchParams.get("type")||void 0}}catch{try{const h=new URL(l,window.location.origin),f=h.searchParams.get("filename");if(!f)throw new Error("Image URL missing filename parameter");return{filename:f,subfolder:h.searchParams.get("subfolder")||void 0,type:h.searchParams.get("type")||void 0}}catch{throw new Error(`Invalid image URL: ${l}`)}}}u(a,"parseImageRef");async function i(l,c){let h;try{h=new URL(l)}catch{h=new URL(l,window.location.origin)}c&&(h.searchParams.delete("channel"),h.searchParams.set("channel",c));const f=h.toString();return{image:await r(f),url:f}}u(i,"loadImageLayer");function r(l){return new Promise((c,h)=>{const f=new Image;f.crossOrigin="anonymous",f.onload=()=>c(f),f.onerror=()=>h(new Error(`Failed to load image: ${l}`)),f.src=l})}u(r,"loadImage");async function d(l){let c;try{c=new URL(l)}catch{c=new URL(l,window.location.origin)}const h=c.toString();return{image:await r(h),url:h}}return u(d,"loadPaintLayer"),{loadFromNode:t}}u(Wn,"useMaskEditorLoader");function Un(){const n=ie(),e=300,t=D(0),o=D(!1),s=D(0),a=D({x:0,y:0}),i=D({x:0,y:0}),r=D(1),d=D(1),l=D({x:0,y:0}),c=D(null),h=D({x:0,y:0}),f=D(null),g=D(null),p=D(null),m=D(null),v=D(null),w=D(null),y=D(null),k=D(0),_=D(0),C=D({x:0,y:0}),I=D([]),$=u(x=>{const M=x[0].clientX-x[1].clientX,T=x[0].clientY-x[1].clientY;return Math.sqrt(M*M+T*T)},"getTouchDistance"),U=u(x=>({x:(x[0].clientX+x[1].clientX)/2,y:(x[0].clientY+x[1].clientY)/2}),"getTouchMidpoint"),W=u(x=>{const M=x.x-l.value.x,T=x.y-l.value.y;C.value={x:M,y:T},n.setCursorPoint({x:M,y:T})},"updateCursorPosition"),H=u(()=>{n.canvasHistory.undo()},"handleDoubleTap"),j=u(async()=>{if(!y.value?.width||!y.value?.height||!l.value||!r.value){console.warn("Missing required properties for pan/zoom");return}const x=y.value.width*r.value,M=y.value.height*r.value;f.value||(f.value=n.canvasContainer),f.value&&(Object.assign(f.value.style,{width:`${x}px`,height:`${M}px`,left:`${l.value.x}px`,top:`${l.value.y}px`}),p.value||(p.value=n.rgbCanvas),p.value&&((p.value.width!==y.value.width||p.value.height!==y.value.height)&&(p.value.width=y.value.width,p.value.height=y.value.height),p.value.style.width=`${x}px`,p.value.style.height=`${M}px`),n.setPanOffset(l.value),n.setZoomRatio(r.value))},"invalidatePanZoom"),Q=u(x=>{c.value={x:x.clientX,y:x.clientY},n.isPanning=!0,h.value={...l.value}},"handlePanStart"),Y=u(async x=>{if(c.value===null)throw new Error("mouseDownPoint is null");const M=c.value.x-x.clientX,T=c.value.y-x.clientY,A=h.value.x-M,F=h.value.y-T;l.value={x:A,y:F},await j()},"handlePanMove"),K=u(async x=>{if(i.value===null){i.value={x:x.clientX,y:x.clientY};return}const M=x.clientX-i.value.x,T=x.clientY-i.value.y;l.value.x+=M,l.value.y+=T,await j(),i.value={x:x.clientX,y:x.clientY}},"handleSingleTouchPan"),ve=u(x=>{if(x.preventDefault(),!(I.value.length>0))if(n.brushVisible=!1,x.touches.length===2){const M=new Date().getTime();M-t.value<e?(H(),t.value=0):(t.value=M,o.value=!0,s.value=$(x.touches),a.value=U(x.touches))}else x.touches.length===1&&(i.value={x:x.touches[0].clientX,y:x.touches[0].clientY})},"handleTouchStart"),we=u(async x=>{if(x.preventDefault(),!(I.value.length>0))if(t.value=0,o.value&&x.touches.length===2){const M=$(x.touches),T=M/s.value,A=r.value;r.value=Math.max(.2,Math.min(10,r.value*T));const F=r.value,R=U(x.touches);if(a.value){const J=R.x-a.value.x,ee=R.y-a.value.y;l.value.x+=J,l.value.y+=ee}if(g.value===null&&(g.value=n.maskCanvas),!g.value)return;const B=g.value.getBoundingClientRect(),O=R.x-B.left,z=R.y-B.top,q=F/A;l.value.x+=O-O*q,l.value.y+=z-z*q,await j(),s.value=M,a.value=R}else x.touches.length===1&&await K(x.touches[0])},"handleTouchMove"),fe=u(x=>{x.preventDefault();const M=x.touches[0];M?i.value={x:M.clientX,y:M.clientY}:(o.value=!1,a.value={x:0,y:0})},"handleTouchEnd"),ge=u(async x=>{const M={x:x.clientX,y:x.clientY},T=r.value,A=x.deltaY<0?1.1:.9;r.value=Math.max(.2,Math.min(10,r.value*A));const F=r.value;if(g.value||(g.value=n.maskCanvas),!g.value)return;const R=g.value.getBoundingClientRect(),B=M.x-R.left,O=M.y-R.top,z=F/T;l.value.x+=B-B*z,l.value.y+=O-O*z,await j();const J=g.value.clientWidth/k.value;d.value=J,n.displayZoomRatio=J,W(M)},"zoom"),Re=u(()=>{const x=v.value?.getBoundingClientRect().width||64;return{sidePanelWidth:w.value?.getBoundingClientRect().width||220,toolPanelWidth:x}},"getPanelDimensions"),Pe=u(async(x=500)=>{if(!y.value||!m.value)return;const M=r.value,T={...l.value},{sidePanelWidth:A,toolPanelWidth:F}=Re(),R=m.value.clientWidth-A-F,B=m.value.clientHeight,O=R/y.value.width,z=B/y.value.height,q=Math.min(O,z),J=y.value.width/y.value.height;let ee,ne;const me={x:F,y:0};z>O?(ee=R,ne=ee/J,me.y=(B-ne)/2):(ne=B,ee=ne*J,me.x=(R-ee)/2+F);const be=performance.now(),ce=u(async G=>{const gt=G-be,We=Math.min(gt/x,1),Ve=1-Math.pow(1-We,3);r.value=M+(q-M)*Ve,l.value.x=T.x+(me.x-T.x)*Ve,l.value.y=T.y+(me.y-T.y)*Ve,await j();const Ge=M+(1-M)*Ve;n.displayZoomRatio=Ge,We<1&&requestAnimationFrame(ce)},"animate");requestAnimationFrame(ce),d.value=1},"smoothResetView"),S=u(async(x,M,T,A)=>{m.value=M,v.value=T||null,w.value=A||null;const{sidePanelWidth:F,toolPanelWidth:R}=Re(),B=M.clientWidth-F-R,O=M.clientHeight,z=B/x.width,q=O/x.height,J=x.width/x.height;let ee,ne;const me={x:R,y:0};q>z?(ee=B,ne=ee/J,me.y=(O-ne)/2):(ne=O,ee=ne*J,me.x=(B-ee)/2+R),y.value===null&&(y.value=x),k.value=ee,_.value=ne,r.value=Math.min(z,q),l.value=me,I.value=[],await j()},"initializeCanvasPanZoom");return ze(()=>n.resetZoomTrigger,async()=>{d.value!==1&&await Pe()}),{initializeCanvasPanZoom:S,handlePanStart:Q,handlePanMove:Y,handleTouchStart:ve,handleTouchMove:we,handleTouchEnd:fe,updateCursorPosition:W,zoom:ge,invalidatePanZoom:j}}u(Un,"usePanAndZoom");function zn(){const n=ie();return{screenToCanvas:u(o=>{const s=N(n.pointerZone),a=N(n.canvasContainer),i=N(n.maskCanvas);if(!s||!a||!i)return console.warn("screenToCanvas called before elements are available"),{x:0,y:0};const r=s.getBoundingClientRect(),d=a.getBoundingClientRect(),l=i.getBoundingClientRect(),c=r.left+o.x,h=r.top+o.y,f=c-d.left,g=h-d.top,p=i.width/l.width,m=i.height/l.height,v=f*p,w=g*m;return{x:v,y:w}},"screenToCanvas"),canvasToScreen:u(o=>{const s=N(n.pointerZone),a=N(n.canvasContainer),i=N(n.maskCanvas);if(!s||!a||!i)return console.warn("canvasToScreen called before elements are available"),{x:0,y:0};const r=s.getBoundingClientRect(),d=a.getBoundingClientRect(),l=i.getBoundingClientRect(),c=l.width/i.width,h=l.height/i.height,f=o.x*c,g=o.y*h,p=d.left+f,m=d.top+g,v=p-r.left,w=m-r.top;return{x:v,y:w}},"canvasToScreen")}}u(zn,"useCoordinateTransformInternal");const _o=go(zn),Vn=cn(function(n,e){try{const t=JSON.stringify(e);Jo(n,t)}catch(t){console.error("Failed to save brush to cache:",t)}},300);function Gn(n){try{const e=Qo(n);return e?JSON.parse(e):null}catch(e){return console.error("Failed to load brush from cache:",e),null}}u(Gn,"loadBrushFromCache");function jn(n){const e=ie(),t=_o(),o=new dn({maxSize:8}),s=30,a=2,i=D(!1),r=D(!1),d=D(null),l=D([]),c=D(new Date),h=D(!0),f=D(null),g=D(null),p=D(null),m=D(n?.useDominantAxis??!1),v=D(n?.brushAdjustmentSpeed??1),w=Gn("maskeditor_brush_settings");w&&(e.setBrushSize(w.size),e.setBrushOpacity(w.opacity),e.setBrushHardness(w.hardness),e.brushSettings.type=w.type,e.setBrushSmoothingPrecision(w.smoothingPrecision));const y=u(async()=>{if(f.value!==null)return;const S=e.maskCanvas;if(!S)throw new Error("Mask canvas not initialized");const x=document.createElement("canvas");x.width=S.width,x.height=S.height,f.value=x,g.value=x.getContext("2d")},"createBrushStrokeCanvas"),k=u(S=>{const x=e.maskBlendMode,M=e.maskCtx,T=e.rgbCtx;if(!M||!T)throw new Error("Canvas contexts are required");M.beginPath(),T.beginPath(),S===_e.SourceOver?(M.fillStyle=x,M.globalCompositeOperation=_e.SourceOver,T.globalCompositeOperation=_e.SourceOver):S===_e.DestinationOut&&(M.globalCompositeOperation=_e.DestinationOut,T.globalCompositeOperation=_e.DestinationOut)},"initShape"),_=u((S,x)=>{const{r:M,g:T,b:A}=en(S);return`rgba(${M}, ${T}, ${A}, ${x})`},"formatRgba"),C=u((S,x,M,T)=>{const A=`${S}_${x}_${M}_${T}`;if(o.has(A))return o.get(A);const F=document.createElement("canvas"),R=F.getContext("2d"),B=S*2;F.width=B,F.height=B;const O=B/2,z=B/2,q=S*x,J=R.createImageData(B,B),ee=J.data,{r:ne,g:me,b:be}=Ut(M),ce=S-q;for(let G=0;G<B;G++){const gt=G-z;for(let We=0;We<B;We++){const Ve=We-O,Ge=(G*B+We)*4,mt=Math.max(Math.abs(Ve),Math.abs(gt));let ft=0;if(mt<=q)ft=T;else if(mt<=S){const So=(mt-q)/ce;ft=T*(1-So)}ee[Ge]=ne,ee[Ge+1]=me,ee[Ge+2]=be,ee[Ge+3]=ft*255}}return R.putImageData(J,0,0),o.set(A,F),F},"getCachedBrushTexture"),I=u((S,x,M,T,A,F,R,B)=>{const O=S.createRadialGradient(x,M,0,x,M,T);if(B)O.addColorStop(0,`rgba(255, 255, 255, ${R})`),O.addColorStop(A,`rgba(255, 255, 255, ${R*.5})`),O.addColorStop(1,"rgba(255, 255, 255, 0)");else{const{r:z,g:q,b:J}=Ut(F);O.addColorStop(0,`rgba(${z}, ${q}, ${J}, ${R})`),O.addColorStop(A,`rgba(${z}, ${q}, ${J}, ${R*.5})`),O.addColorStop(1,`rgba(${z}, ${q}, ${J}, 0)`)}return O},"createBrushGradient"),$=u((S,x,M,T,A)=>{S.beginPath(),x===ye.Rect?S.rect(M-A,T-A,A*2,A*2):S.arc(M,T,A,0,Math.PI*2,!1),S.fill()},"drawShapeOnContext"),U=u((S,x,M,T,A,F)=>{const{x:R,y:B}=x,O=e.rgbColor;if(M===ye.Rect&&A<1){const q=_(O,F),J=C(T,A,q,F);S.drawImage(J,R-T,B-T);return}if(A===1){const q=_(O,F);S.fillStyle=q,$(S,M,R,B,T);return}const z=I(S,R,B,T,A,O,F,!1);S.fillStyle=z,$(S,M,R,B,T)},"drawRgbShape"),W=u((S,x,M,T,A,F,R)=>{const{x:B,y:O}=x,z=e.maskColor;if(M===ye.Rect&&A<1){const ee=R?`rgba(255, 255, 255, ${F})`:`rgba(${z.r}, ${z.g}, ${z.b}, ${F})`,ne=C(T,A,ee,F);S.drawImage(ne,B-T,O-T);return}if(A===1){S.fillStyle=R?`rgba(255, 255, 255, ${F})`:`rgba(${z.r}, ${z.g}, ${z.b}, ${F})`,$(S,M,B,O,T);return}const q=`rgb(${z.r}, ${z.g}, ${z.b})`,J=I(S,B,O,T,A,q,F,R);S.fillStyle=J,$(S,M,B,O,T)},"drawMaskShape"),H=u((S,x)=>{const M=e.brushSettings,T=e.maskCtx,A=e.rgbCtx;if(!T||!A)throw new Error("Canvas contexts are required");const F=M.type,R=M.size,B=M.hardness,O=x??M.opacity,z=T.globalCompositeOperation==="destination-out",q=e.currentTool;if(e.activeLayer==="rgb"&&q&&(q===Z.Eraser||q===Z.PaintPen)){U(A,S,F,R,B,O);return}W(T,S,F,R,B,O,z)},"drawShape"),j=u(S=>Math.min(Math.max(S,1),100),"clampSmoothingPrecision"),Q=u((S,x)=>{const M=[],T=[0];for(let R=1;R<S.length;R++){const B=S[R].x-S[R-1].x,O=S[R].y-S[R-1].y,z=Math.hypot(B,O);T[R]=T[R-1]+z}const A=T[T.length-1],F=Math.floor(A/x);for(let R=0;R<=F;R++){const B=R*x;let O=0;for(;O<T.length-1&&T[O+1]<B;)O++;if(O>=S.length-1){M.push(S[S.length-1]);continue}const z=T[O],q=T[O+1],J=(B-z)/(q-z),ee=S[O].x+J*(S[O+1].x-S[O].x),ne=S[O].y+J*(S[O+1].y-S[O].y);M.push({x:ee,y:ne})}return M},"generateEquidistantPoints"),Y=u(S=>{l.value||(l.value=[]);const x=1/(1+Math.exp(3)),M=1/(1+Math.exp(-6*(e.brushSettings.opacity-.5)))-x;if(l.value.push(S),l.value.length<5)return;let A=0;const F=l.value,R=F.length-1;let B,O;for(let ce=0;ce<R;ce++)B=F[ce+1].x-F[ce].x,O=F[ce+1].y-F[ce].y,A+=Math.sqrt(B*B+O*O);const z=s,q=a,ee=(j(e.brushSettings.smoothingPrecision)-1)/99,ne=Math.round(Math.round(q+(z-q)*ee)),me=A/ne;let be=F;if(ne>0&&(be=Q(l.value,me)),!h.value){const ce=be.findIndex(G=>G.x===l.value[2].x&&G.y===l.value[2].y);ce!==-1&&(be=be.slice(ce+1))}for(const ce of be)H(ce,M);h.value?h.value=!1:l.value=l.value.slice(2)},"drawWithBetterSmoothing"),K=u(async(S,x,M)=>{try{const T=e.brushSettings.size,A=Math.sqrt((x.x-S.x)**2+(x.y-S.y)**2),F=Math.ceil(A/(T/e.brushSettings.smoothingPrecision*4)),R=1/(1+Math.exp(-6*(e.brushSettings.opacity-.5)))-1/(1+Math.exp(3));k(M);for(let B=0;B<=F;B++){const O=B/F,z=S.x+(x.x-S.x)*O,q=S.y+(x.y-S.y)*O;H({x:z,y:q},R)}}catch(T){throw console.error("[useBrushDrawing] Failed to draw line:",T),T}},"drawLine");return{startDrawing:u(async S=>{i.value=!0;try{let x;const M=e.currentTool,T={x:S.offsetX,y:S.offsetY},A=t.screenToCanvas(T);await y(),M==="eraser"||S.buttons===2?x=_e.DestinationOut:x=_e.SourceOver,S.shiftKey&&d.value?(r.value=!0,await K(d.value,A,x)):(r.value=!1,k(x),H(A)),d.value=A,l.value=[A],c.value=new Date}catch(x){console.error("[useBrushDrawing] Failed to start drawing:",x),i.value=!1,r.value=!1}},"startDrawing"),handleDrawing:u(async S=>{const x=performance.now()-c.value.getTime(),M={x:S.offsetX,y:S.offsetY},T=t.screenToCanvas(M),A=e.currentTool;x>20&&!i.value?requestAnimationFrame(()=>{try{k(_e.SourceOver),H(T),l.value.push(T)}catch(F){console.error("[useBrushDrawing] Drawing error:",F)}}):requestAnimationFrame(()=>{try{A==="eraser"||S.buttons===2?k(_e.DestinationOut):k(_e.SourceOver),Y(T)}catch(F){console.error("[useBrushDrawing] Drawing error:",F)}}),c.value=new Date},"handleDrawing"),drawEnd:u(async S=>{const x={x:S.offsetX,y:S.offsetY},M=t.screenToCanvas(x);i.value&&(i.value=!1,e.canvasHistory.saveState(),d.value=M,h.value=!0)},"drawEnd"),startBrushAdjustment:u(async S=>{S.preventDefault();const x={x:S.offsetX,y:S.offsetY},M=t.screenToCanvas(x);e.brushPreviewGradientVisible=!0,p.value=M},"startBrushAdjustment"),handleBrushAdjustment:u(async S=>{if(!p.value)return;const x={x:S.offsetX,y:S.offsetY},M=5,T=t.screenToCanvas(x),A=T.x-p.value.x,F=T.y-p.value.y,R=Math.abs(A)<M?0:A,B=Math.abs(F)<M?0:F;let O=R,z=B;if(m.value){const me=Math.abs(R)/Math.abs(B),be=2;me>be?z=0:me<1/be&&(O=0)}const q=Math.max(-100,Math.min(100,O)),J=Math.max(-100,Math.min(100,z)),ee=Math.max(1,Math.min(100,e.brushSettings.size+q/35*v.value)),ne=Math.max(0,Math.min(1,e.brushSettings.hardness-J/4e3*v.value));e.setBrushSize(ee),e.setBrushHardness(ne)},"handleBrushAdjustment"),saveBrushSettings:u(()=>{Vn("maskeditor_brush_settings",e.brushSettings)},"saveBrushSettings")}}u(jn,"useBrushDrawing");const at=u((n,e,t,o)=>n[(t*o+e)*4+3],"getPixelAlpha"),qe=u((n,e,t,o)=>{const s=(t*o+e)*4;return{r:n[s],g:n[s+1],b:n[s+2]}},"getPixelColor"),_t=u((n,e,t,o,s,a)=>{const i=(t*o+e)*4;n[i]=a.r,n[i+1]=a.g,n[i+2]=a.b,n[i+3]=s},"setPixel"),Jt=u((n,e,t)=>{n/=255,e/=255,t/=255;const o=Math.max(n,e,t),s=Math.min(n,e,t);let a=0,i=0;const r=(o+s)/2;if(o!==s){const d=o-s;switch(i=r>.5?d/(2-o-s):d/(o+s),o){case n:a=(e-t)/d+(e<t?6:0);break;case e:a=(t-n)/d+2;break;case t:a=(n-e)/d+4;break}a/=6}return{h:a*360,s:i*100,l:r*100}},"rgbToHSL"),Qt=u(n=>{let e=n.r/255,t=n.g/255,o=n.b/255;e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,e*=100,t*=100,o*=100;const s=e*.4124+t*.3576+o*.1805,a=e*.2126+t*.7152+o*.0722,i=e*.0193+t*.1192+o*.9505,c=[s/95.047,a/100,i/108.883];for(let h=0;h<c.length;h++)c[h]=c[h]>.008856?Math.pow(c[h],1/3):7.787*c[h]+16/116;return{l:116*c[1]-16,a:500*(c[0]-c[1]),b:200*(c[1]-c[2])}},"rgbToLab"),eo=u((n,e,t)=>Math.sqrt(Math.pow(n.r-e.r,2)+Math.pow(n.g-e.g,2)+Math.pow(n.b-e.b,2))<=t,"isPixelInRangeSimple"),Hn=u((n,e,t)=>{const o=Jt(n.r,n.g,n.b),s=Jt(e.r,e.g,e.b),a=Math.abs(o.h-s.h),i=Math.abs(o.s-s.s),r=Math.abs(o.l-s.l);return Math.sqrt(Math.pow(a/360*255,2)+Math.pow(i/100*255,2)+Math.pow(r/100*255,2))<=t},"isPixelInRangeHSL"),Yn=u((n,e,t)=>{const o=Qt(n),s=Qt(e);return Math.sqrt(Math.pow(o.l-s.l,2)+Math.pow(o.a-s.a,2)+Math.pow(o.b-s.b,2))/100*255<=t},"isPixelInRangeLab"),It=u((n,e,t,o)=>{switch(o){case Fe.Simple:return eo(n,e,t);case Fe.HSL:return Hn(n,e,t);case Fe.LAB:return Yn(n,e,t);default:return eo(n,e,t)}},"isPixelInRange");function Io(){const n=ie(),e=D(null),t=u(r=>{const d=n.maskCtx,l=n.maskCanvas;if(!d||!l)return;const c=Math.floor(r.x),h=Math.floor(r.y),f=l.width,g=l.height;if(c<0||c>=f||h<0||h>=g)return;const p=d.getImageData(0,0,f,g),m=p.data,v=at(m,c,h,f),w=v!==255;if(v===-1)return;const y=n.maskColor,k=n.paintBucketTolerance,_=Math.floor(n.fillOpacity/100*255),C=[],I=new Uint8Array(f*g),$=u((U,W,H,j)=>U===-1?!1:j?U!==255&&Math.abs(U-W)<=H:U===255||Math.abs(U-W)<=H,"shouldProcessPixel");for($(v,v,k,w)&&C.push([c,h]);C.length>0;){const[U,W]=C.pop(),H=W*f+U;if(I[H])continue;const j=at(m,U,W,f);if(!$(j,v,k,w))continue;I[H]=1,_t(m,U,W,f,w?_:0,y);const Q=u((Y,K)=>{if(!(Y<0||Y>=f||K<0||K>=g)&&!I[K*f+Y]){const ve=at(m,Y,K,f);$(ve,v,k,w)&&C.push([Y,K])}},"checkNeighbor");Q(U-1,W),Q(U+1,W),Q(U,W-1),Q(U,W+1)}d.putImageData(p,0,0),n.canvasHistory.saveState()},"paintBucketFill"),o=u(async r=>{const d=n.maskCtx,l=n.imgCtx,c=n.imgCanvas;if(!d||!l||!c)return;const h=c.width,f=c.height;e.value=r;const g=d.getImageData(0,0,h,f),p=g.data,m=l.getImageData(0,0,h,f).data,v=n.colorSelectTolerance,w=n.colorComparisonMethod,y=n.maskColor,k=Math.floor(n.selectionOpacity/100*255),_=n.applyWholeImage,C=n.maskBoundary,I=n.maskTolerance;if(_){const $=qe(m,Math.floor(r.x),Math.floor(r.y),h),U=1e4;for(let W=0;W<h*f;W+=U){const H=Math.min(W+U,h*f);for(let j=W;j<H;j++){const Q=j%h,Y=Math.floor(j/h);It(qe(m,Q,Y,h),$,v,w)&&_t(p,Q,Y,h,k,y)}await new Promise(j=>setTimeout(j,0))}}else{const $=Math.floor(r.x),U=Math.floor(r.y);if($<0||$>=h||U<0||U>=f)return;const W=qe(m,$,U,h),H=[],j=new Uint8Array(h*f);for(H.push([$,U]);H.length>0;){const[Q,Y]=H.pop(),K=Y*h+Q;if(j[K]||!It(qe(m,Q,Y,h),W,v,w))continue;j[K]=1,_t(p,Q,Y,h,k,y);const ve=u((we,fe)=>{we<0||we>=h||fe<0||fe>=f||j[fe*h+we]||It(qe(m,we,fe,h),W,v,w)&&(C&&255-at(p,we,fe,h)<=I||H.push([we,fe]))},"checkNeighbor");ve(Q-1,Y),ve(Q+1,Y),ve(Q,Y-1),ve(Q,Y+1)}}d.putImageData(g,0,0),n.canvasHistory.saveState()},"colorSelectFill"),s=u(()=>{const r=n.maskCtx,d=n.maskCanvas;if(!r||!d)return;const l=r.getImageData(0,0,d.width,d.height),c=l.data;let h=0,f=0,g=0;for(let p=0;p<c.length;p+=4)if(c[p+3]>0){h=c[p],f=c[p+1],g=c[p+2];break}for(let p=0;p<c.length;p+=4){const m=c[p+3];c[p+3]=255-m,m===0&&(c[p]=h,c[p+1]=f,c[p+2]=g)}r.putImageData(l,0,0),n.canvasHistory.saveState()},"invertMask"),a=u(()=>{const r=n.maskCtx,d=n.maskCanvas,l=n.rgbCtx,c=n.rgbCanvas;r&&d&&r.clearRect(0,0,d.width,d.height),l&&c&&l.clearRect(0,0,c.width,c.height),n.canvasHistory.saveState()},"clearMask"),i=u(()=>{e.value=null},"clearLastColorSelectPoint");return ze([()=>n.colorSelectTolerance,()=>n.colorComparisonMethod,()=>n.selectionOpacity],async()=>{e.value&&n.colorSelectLivePreview&&n.canUndo&&(n.canvasHistory.undo(),await o(e.value))}),{paintBucketFill:t,colorSelectFill:o,clearLastColorSelectPoint:i,invertMask:s,clearMask:a}}u(Io,"useCanvasTools");function Xn(n,e){const t=ie(),o=_o(),s=jn({useDominantAxis:b.extensionManager.setting.get("Comfy.MaskEditor.UseDominantAxis"),brushAdjustmentSpeed:b.extensionManager.setting.get("Comfy.MaskEditor.BrushAdjustmentSpeed")}),a=Io(),i=D(null),r={[Z.MaskPen]:{newActiveLayerOnSet:"mask"},[Z.Eraser]:{},[Z.PaintPen]:{newActiveLayerOnSet:"rgb"},[Z.MaskBucket]:{cursor:"url('/cursor/paintBucket.png') 30 25, auto",newActiveLayerOnSet:"mask"},[Z.MaskColorFill]:{cursor:"url('/cursor/colorSelect.png') 15 25, auto",newActiveLayerOnSet:"mask"}},d=u(p=>{t.activeLayer=p;const m=t.currentTool;[Z.MaskPen,Z.MaskBucket,Z.MaskColorFill].includes(m)&&p==="rgb"&&l(Z.PaintPen),m===Z.PaintPen&&p==="mask"&&l(Z.MaskPen)},"setActiveLayer"),l=u(p=>{t.currentTool=p;const m=r[p].newActiveLayerOnSet;m&&(t.activeLayer=m);const v=r[p].cursor,w=t.pointerZone;v&&w?(t.brushVisible=!1,w.style.cursor=v):w&&(t.brushVisible=!0,w.style.cursor="none")},"switchTool"),c=u(()=>{const p=t.currentTool,m=r[p].cursor,v=t.pointerZone;m&&v?(t.brushVisible=!1,v.style.cursor=m):v&&(t.brushVisible=!0,v.style.cursor="none"),t.brushPreviewGradientVisible=!1},"updateCursor");return ze(()=>t.currentTool,p=>{p!==Z.MaskColorFill&&a.clearLastColorSelectPoint()}),{switchTool:l,setActiveLayer:d,updateCursor:c,handlePointerDown:u(async p=>{if(p.preventDefault(),p.pointerType==="touch")return;const m=n.isKeyDown(" ");if(p.buttons===4||p.buttons===1&&m){e.handlePanStart(p),t.brushVisible=!1;return}if(t.currentTool===Z.PaintPen&&p.button===0){await s.startDrawing(p);return}if(t.currentTool===Z.PaintPen&&p.buttons===1){await s.handleDrawing(p);return}if(t.currentTool===Z.MaskBucket&&p.button===0){const w={x:p.offsetX,y:p.offsetY},y=o.screenToCanvas(w);a.paintBucketFill(y);return}if(t.currentTool===Z.MaskColorFill&&p.button===0){const w={x:p.offsetX,y:p.offsetY},y=o.screenToCanvas(w);await a.colorSelectFill(y);return}if(p.altKey&&p.button===2){t.isAdjustingBrush=!0,await s.startBrushAdjustment(p);return}const v=[Z.MaskPen,Z.Eraser,Z.PaintPen].includes(t.currentTool);if([0,2].includes(p.button)&&v){await s.startDrawing(p);return}},"handlePointerDown"),handlePointerMove:u(async p=>{if(p.preventDefault(),p.pointerType==="touch")return;const m={x:p.clientX,y:p.clientY};e.updateCursorPosition(m);const v=n.isKeyDown(" ");if(p.buttons===4||p.buttons===1&&v){await e.handlePanMove(p);return}if([Z.MaskPen,Z.Eraser,Z.PaintPen].includes(t.currentTool)){if(t.isAdjustingBrush&&(t.currentTool===Z.MaskPen||t.currentTool===Z.Eraser)&&p.altKey&&p.buttons===2){await s.handleBrushAdjustment(p);return}if(p.buttons===1||p.buttons===2){await s.handleDrawing(p);return}}},"handlePointerMove"),handlePointerUp:u(async p=>{t.isPanning=!1,t.brushVisible=!0,p.pointerType!=="touch"&&(c(),t.isAdjustingBrush=!1,await s.drawEnd(p),i.value=null)},"handlePointerUp"),brushDrawing:s}}u(Xn,"useToolManager");const Zn=Ce({__name:"BrushCursor",props:{containerRef:{}},setup(n){const e=ie(),t=se(()=>e.brushVisible?"1":"0"),o=se(()=>e.brushSettings.size*e.zoomRatio),s=se(()=>o.value*2),a=se(()=>{const h=n.containerRef?.getBoundingClientRect()?.left||0;return e.cursorPoint.x+e.panOffset.x-o.value-h}),i=se(()=>{const h=n.containerRef?.getBoundingClientRect()?.top||0;return e.cursorPoint.y+e.panOffset.y-o.value-h}),r=se(()=>e.brushSettings.type===ye.Rect?"0%":"50%"),d=se(()=>e.brushPreviewGradientVisible),l=se(()=>{const c=e.brushSettings.hardness;return c===1?"rgba(255, 0, 0, 0.5)":`radial-gradient(
    circle,
    rgba(255, 0, 0, 0.5) 0%,
    rgba(255, 0, 0, 0.25) ${c*100}%,
    rgba(255, 0, 0, 0) 100%
  )`});return(c,h)=>(oe(),le("div",{id:"maskEditor_brush",style:Ae({position:"absolute",opacity:t.value,width:`${s.value}px`,height:`${s.value}px`,left:`${a.value}px`,top:`${i.value}px`,borderRadius:r.value,pointerEvents:"none",zIndex:1e3})},[P("div",{id:"maskEditor_brushPreviewGradient",style:Ae({display:d.value?"block":"none",background:l.value})},null,4)],4))}}),qn=Ce({__name:"PointerZone",props:{toolManager:{},panZoom:{}},setup(n){const e=ie(),t=D();mo(()=>{if(!t.value){console.error("[PointerZone] Pointer zone ref not initialized");return}e.pointerZone=t.value}),ze(()=>e.isPanning,f=>{t.value&&(f?t.value.style.cursor="grabbing":n.toolManager.updateCursor())});const o=u(async f=>{await n.toolManager.handlePointerDown(f)},"handlePointerDown"),s=u(async f=>{await n.toolManager.handlePointerMove(f)},"handlePointerMove"),a=u(f=>{n.toolManager.handlePointerUp(f)},"handlePointerUp"),i=u(()=>{e.brushVisible=!1,t.value&&(t.value.style.cursor="")},"handlePointerLeave"),r=u(()=>{n.toolManager.updateCursor()},"handlePointerEnter"),d=u(f=>{n.panZoom.handleTouchStart(f)},"handleTouchStart"),l=u(async f=>{await n.panZoom.handleTouchMove(f)},"handleTouchMove"),c=u(f=>{n.panZoom.handleTouchEnd(f)},"handleTouchEnd"),h=u(async f=>{await n.panZoom.zoom(f);const g={x:f.clientX,y:f.clientY};n.panZoom.updateCursorPosition(g)},"handleWheel");return(f,g)=>(oe(),le("div",{ref_key:"pointerZoneRef",ref:t,class:"w-[calc(100%-4rem-220px)] h-full",onPointerdown:o,onPointermove:s,onPointerup:a,onPointerleave:i,onPointerenter:r,onTouchstart:d,onTouchmove:l,onTouchend:c,onWheel:h,onContextmenu:g[0]||(g[0]=He(()=>{},["prevent"]))},null,544))}}),Kn={class:"flex flex-col gap-3 pb-3"},Jn={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},Qn=["min","max","step","value"],Oe=Ce({__name:"SliderControl",props:{label:{},min:{},max:{},step:{default:1},modelValue:{}},emits:["update:modelValue"],setup(n,{emit:e}){const t=e,o=u(s=>{const a=Number(s.target.value);t("update:modelValue",a)},"onInput");return(s,a)=>(oe(),le("div",Kn,[P("span",Jn,te(s.label),1),P("input",{type:"range",class:"maskEditor_sidePanelBrushRange",min:s.min,max:s.max,step:s.step,value:s.modelValue,onInput:o},null,40,Qn)]))}}),es={class:"flex flex-col gap-3 pb-3"},ts={class:"text-center text-[15px] font-sans text-[var(--descrip-text)] mt-2.5"},os={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},ns={class:"flex flex-row gap-2.5 items-center min-h-6 relative h-[50px] w-full rounded-[10px] -mt-2 -mb-1.5"},ss=["value"],as={value:"black"},is={value:"white"},rs={value:"negative"},ls={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},cs=["checked"],ds={class:"maskEditor_sidePanelLayerPreviewContainer"},us={viewBox:"0 0 20 20",style:{}},ps=["disabled"],hs={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},gs=["checked"],ms=["disabled"],fs={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},ys={class:"flex flex-row gap-2.5 items-center min-h-6 relative h-[50px] w-full rounded-[10px] bg-secondary-background-hover"},vs=["checked"],ws={class:"maskEditor_sidePanelLayerPreviewContainer"},bs=["src","alt"],ks=Ce({__name:"ImageLayerSettingsPanel",props:{toolManager:{}},setup(n){const e=ie(),t=Co(),o=D(!0),s=D(!0),a=D(!0),i=se(()=>e.image?.src??""),r=se(()=>e.currentTool===Z.Eraser),d=u(p=>{const m=p.target.checked;o.value=m;const v=e.maskCanvas;v&&(v.style.opacity=m?String(e.maskOpacity):"0")},"onMaskLayerVisibilityChange"),l=u(p=>{const m=p.target.checked;s.value=m;const v=e.rgbCanvas;v&&(v.style.opacity=m?"1":"0")},"onPaintLayerVisibilityChange"),c=u(p=>{const m=p.target.checked;a.value=m;const v=e.imgCanvas;v&&(v.style.opacity=m?"1":"0")},"onBaseImageLayerVisibilityChange"),h=u(p=>{e.setMaskOpacity(p);const m=e.maskCanvas;m&&(m.style.opacity=String(p)),o.value=p!==0},"onMaskOpacityChange"),f=u(async p=>{const m=p.target.value;let v;switch(m){case"white":v=xe.White;break;case"negative":v=xe.Negative;break;default:v=xe.Black}e.maskBlendMode=v,await t.updateMaskColor()},"onBlendModeChange"),g=u(p=>{n.toolManager?.setActiveLayer(p)},"setActiveLayer");return(p,m)=>(oe(),le("div",es,[P("h3",ts,te(N(E)("maskEditor.layers")),1),pe(Oe,{label:N(E)("maskEditor.maskOpacity"),min:0,max:1,step:.01,"model-value":N(e).maskOpacity,"onUpdate:modelValue":h},null,8,["label","model-value"]),P("span",os,te(N(E)("maskEditor.maskBlendingOptions")),1),P("div",ns,[P("select",{class:"maskEditor_sidePanelDropdown",value:N(e).maskBlendMode,onChange:f},[P("option",as,te(N(E)("maskEditor.black")),1),P("option",is,te(N(E)("maskEditor.white")),1),P("option",rs,te(N(E)("maskEditor.negative")),1)],40,ss)]),P("span",ls,te(N(E)("maskEditor.maskLayer")),1),P("div",{class:"flex flex-row gap-2.5 items-center min-h-6 relative h-[50px] w-full rounded-[10px] bg-secondary-background-hover",style:Ae({border:N(e).activeLayer==="mask"?"2px solid #007acc":"none"})},[P("input",{type:"checkbox",class:"maskEditor_sidePanelLayerCheckbox",checked:o.value,onChange:d},null,40,cs),P("div",ds,[(oe(),le("svg",us,m[2]||(m[2]=[P("path",{class:"cls-1",d:"M1.31,5.32v9.36c0,.55.45,1,1,1h15.38c.55,0,1-.45,1-1V5.32c0-.55-.45-1-1-1H2.31c-.55,0-1,.45-1,1ZM11.19,13.44c-2.91.94-5.57-1.72-4.63-4.63.34-1.05,1.19-1.9,2.24-2.24,2.91-.94,5.57,1.72,4.63,4.63-.34,1.05-1.19-1.9-2.24,2.24Z"},null,-1)])))]),P("button",{style:Ae([{"font-size":"12px"},{opacity:N(e).activeLayer==="mask"?"0.5":"1"}]),disabled:N(e).activeLayer==="mask",onClick:m[0]||(m[0]=v=>g("mask"))},te(N(E)("maskEditor.activateLayer")),13,ps)],4),P("span",hs,te(N(E)("maskEditor.paintLayer")),1),P("div",{class:"flex flex-row gap-2.5 items-center min-h-6 relative h-[50px] w-full rounded-[10px] bg-secondary-background-hover",style:Ae({border:N(e).activeLayer==="rgb"?"2px solid #007acc":"none"})},[P("input",{type:"checkbox",class:"maskEditor_sidePanelLayerCheckbox",checked:s.value,onChange:l},null,40,gs),m[3]||(m[3]=P("div",{class:"maskEditor_sidePanelLayerPreviewContainer"},[P("svg",{viewBox:"0 0 20 20"},[P("path",{class:"cls-1",d:"M 17 6.965 c 0 0.235 -0.095 0.47 -0.275 0.655 l -6.51 6.52 c -0.045 0.035 -0.09 0.075 -0.135 0.11 c -0.035 -0.695 -0.605 -1.24 -1.305 -1.245 c 0.035 -0.06 0.08 -0.12 0.135 -0.17 l 6.52 -6.52 c 0.36 -0.36 0.945 -0.36 1.3 0 c 0.175 0.175 0.275 0.415 0.275 0.65 Z"}),P("path",{class:"cls-1",d:"M 9.82 14.515 c 0 2.23 -3.23 1.59 -4.82 0 c 1.65 -0.235 2.375 -1.29 3.53 -1.29 c 0.715 0 1.29 0.58 1.29 1.29 Z"})])],-1)),P("button",{style:Ae([{"font-size":"12px"},{opacity:N(e).activeLayer==="rgb"?"0.5":"1",display:r.value?"block":"none"}]),disabled:N(e).activeLayer==="rgb",onClick:m[1]||(m[1]=v=>g("rgb"))},te(N(E)("maskEditor.activateLayer")),13,ms)],4),P("span",fs,te(N(E)("maskEditor.baseImageLayer")),1),P("div",ys,[P("input",{type:"checkbox",class:"maskEditor_sidePanelLayerCheckbox",checked:a.value,onChange:c},null,40,vs),P("div",ws,[P("img",{class:"maskEditor_sidePanelImageLayerImage",src:i.value,alt:N(E)("maskEditor.baseLayerPreview")},null,8,bs)])])]))}}),xs={class:"flex flex-col gap-3 pb-3"},Cs={class:"text-center text-[15px] font-sans text-[var(--descrip-text)] mt-2.5"},_s={class:"flex flex-col gap-3 pb-3"},Is={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},Ds={class:"flex flex-row gap-2.5 items-center min-h-6 relative h-[50px] w-full rounded-[10px] bg-secondary-background-hover"},Ss={class:"flex flex-col gap-3 pb-3"},Ms={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},Ns=["value"],Ts=Ce({__name:"BrushSettingsPanel",setup(n){const e=ie(),t=u(l=>{e.brushSettings.type=l},"setBrushShape"),o=u(l=>{e.rgbColor=l.target.value},"onColorChange"),s=u(l=>{e.setBrushSize(l)},"onThicknessChange"),a=u(l=>{e.setBrushOpacity(l)},"onOpacityChange"),i=u(l=>{e.setBrushHardness(l)},"onHardnessChange"),r=u(l=>{e.setBrushSmoothingPrecision(l)},"onSmoothingPrecisionChange"),d=u(()=>{e.resetBrushToDefault()},"resetToDefault");return(l,c)=>(oe(),le("div",xs,[P("h3",Cs,te(N(E)("maskEditor.brushSettings")),1),P("button",{class:"w-45 h-7.5 border-none bg-black/20 border border-[var(--border-color)] text-[var(--input-text)] font-sans text-[15px] pointer-events-auto transition-colors duration-100 hover:bg-[var(--p-overlaybadge-outline-color)] hover:border-none",onClick:d},te(N(E)("maskEditor.resetToDefault")),1),P("div",_s,[P("span",Is,te(N(E)("maskEditor.brushShape")),1),P("div",Ds,[P("div",{class:Ue(["maskEditor_sidePanelBrushShapeCircle bg-transparent hover:bg-comfy-menu-bg",{active:N(e).brushSettings.type===N(ye).Arc}]),style:Ae({background:N(e).brushSettings.type===N(ye).Arc?"var(--p-button-text-primary-color)":""}),onClick:c[0]||(c[0]=h=>t(N(ye).Arc))},null,6),P("div",{class:Ue(["maskEditor_sidePanelBrushShapeSquare bg-transparent hover:bg-comfy-menu-bg",{active:N(e).brushSettings.type===N(ye).Rect}]),style:Ae({background:N(e).brushSettings.type===N(ye).Rect?"var(--p-button-text-primary-color)":""}),onClick:c[1]||(c[1]=h=>t(N(ye).Rect))},null,6)])]),P("div",Ss,[P("span",Ms,te(N(E)("maskEditor.colorSelector")),1),P("input",{type:"color",value:N(e).rgbColor,onInput:o},null,40,Ns)]),pe(Oe,{label:N(E)("maskEditor.thickness"),min:1,max:100,step:1,"model-value":N(e).brushSettings.size,"onUpdate:modelValue":s},null,8,["label","model-value"]),pe(Oe,{label:N(E)("maskEditor.opacity"),min:0,max:1,step:.01,"model-value":N(e).brushSettings.opacity,"onUpdate:modelValue":a},null,8,["label","model-value"]),pe(Oe,{label:N(E)("maskEditor.hardness"),min:0,max:1,step:.01,"model-value":N(e).brushSettings.hardness,"onUpdate:modelValue":i},null,8,["label","model-value"]),pe(Oe,{label:N(E)("maskEditor.smoothingPrecision"),min:1,max:100,step:1,"model-value":N(e).brushSettings.smoothingPrecision,"onUpdate:modelValue":r},null,8,["label","model-value"])]))}}),Ps={class:"flex flex-row gap-2.5 items-center min-h-6 relative"},Es={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},Ls=["value"],Os=["value"],Rs=Ce({__name:"DropdownControl",props:{label:{},options:{},modelValue:{}},emits:["update:modelValue"],setup(n,{emit:e}){const t=n,o=e,s=se(()=>t.options.map(i=>typeof i=="string"?{label:i,value:i}:i)),a=u(i=>{const r=i.target.value;o("update:modelValue",r)},"onChange");return(i,r)=>(oe(),le("div",Ps,[P("span",Es,te(i.label),1),P("select",{class:"absolute right-0 h-6 px-1.5 rounded-md border border-border-default transition-colors duration-100 bg-secondary-background focus:outline focus:outline-node-component-border",value:i.modelValue,onChange:a},[(oe(!0),le(fo,null,yo(s.value,d=>(oe(),le("option",{key:d.value,value:d.value},te(d.label),9,Os))),128))],40,Ls)]))}}),As={class:"flex flex-row gap-2.5 items-center min-h-6 relative"},Bs={class:"text-left text-xs font-sans text-[var(--descrip-text)]"},Fs={class:"maskEditor_sidePanelToggleContainer"},$s=["checked"],Dt=Ce({__name:"ToggleControl",props:{label:{},modelValue:{type:Boolean}},emits:["update:modelValue"],setup(n,{emit:e}){const t=e,o=u(s=>{const a=s.target.checked;t("update:modelValue",a)},"onChange");return(s,a)=>(oe(),le("div",As,[P("span",Bs,te(s.label),1),P("label",Fs,[P("input",{type:"checkbox",class:"maskEditor_sidePanelToggleCheckbox",checked:s.modelValue,onChange:o},null,40,$s),a[0]||(a[0]=P("div",{class:"maskEditor_sidePanelToggleSwitch"},null,-1))])]))}}),Ws={class:"flex flex-col gap-3 pb-3"},Us={class:"text-center text-[15px] font-sans text-[var(--descrip-text)] mt-2.5"},zs=Ce({__name:"ColorSelectSettingsPanel",setup(n){const e=ie(),t=Object.values(Fe),o=u(c=>{e.setColorSelectTolerance(c)},"onToleranceChange"),s=u(c=>{e.setSelectionOpacity(c)},"onSelectionOpacityChange"),a=u(c=>{e.colorSelectLivePreview=c},"onLivePreviewChange"),i=u(c=>{e.applyWholeImage=c},"onWholeImageChange"),r=u(c=>{e.colorComparisonMethod=c},"onMethodChange"),d=u(c=>{e.maskBoundary=c},"onMaskBoundaryChange"),l=u(c=>{e.setMaskTolerance(c)},"onMaskToleranceChange");return(c,h)=>(oe(),le("div",Ws,[P("h3",Us,te(N(E)("maskEditor.colorSelectSettings")),1),pe(Oe,{label:N(E)("maskEditor.tolerance"),min:0,max:255,step:1,"model-value":N(e).colorSelectTolerance,"onUpdate:modelValue":o},null,8,["label","model-value"]),pe(Oe,{label:N(E)("maskEditor.selectionOpacity"),min:0,max:100,step:1,"model-value":N(e).selectionOpacity,"onUpdate:modelValue":s},null,8,["label","model-value"]),pe(Dt,{label:N(E)("maskEditor.livePreview"),"model-value":N(e).colorSelectLivePreview,"onUpdate:modelValue":a},null,8,["label","model-value"]),pe(Dt,{label:N(E)("maskEditor.applyToWholeImage"),"model-value":N(e).applyWholeImage,"onUpdate:modelValue":i},null,8,["label","model-value"]),pe(Rs,{label:N(E)("maskEditor.method"),options:N(t),"model-value":N(e).colorComparisonMethod,"onUpdate:modelValue":r},null,8,["label","options","model-value"]),pe(Dt,{label:N(E)("maskEditor.stopAtMask"),"model-value":N(e).maskBoundary,"onUpdate:modelValue":d},null,8,["label","model-value"]),pe(Oe,{label:N(E)("maskEditor.maskTolerance"),min:0,max:255,step:1,"model-value":N(e).maskTolerance,"onUpdate:modelValue":l},null,8,["label","model-value"])]))}}),Vs={class:"flex flex-col gap-3 pb-3"},Gs={class:"text-center text-[15px] font-sans text-[var(--descrip-text)] mt-2.5"},js=Ce({__name:"PaintBucketSettingsPanel",setup(n){const e=ie(),t=u(s=>{e.setPaintBucketTolerance(s)},"onToleranceChange"),o=u(s=>{e.setFillOpacity(s)},"onFillOpacityChange");return(s,a)=>(oe(),le("div",Vs,[P("h3",Gs,te(N(E)("maskEditor.paintBucketSettings")),1),pe(Oe,{label:N(E)("maskEditor.tolerance"),min:0,max:255,step:1,"model-value":N(e).paintBucketTolerance,"onUpdate:modelValue":t},null,8,["label","model-value"]),pe(Oe,{label:N(E)("maskEditor.fillOpacity"),min:0,max:100,step:1,"model-value":N(e).fillOpacity,"onUpdate:modelValue":o},null,8,["label","model-value"])]))}}),Hs={class:"maskEditor_sidePanel"},Ys={class:"maskEditor_sidePanelContainer"},Xs=Ce({__name:"SettingsPanelContainer",setup(n){const e=se(()=>{const t=ie().currentTool;return t===Z.MaskBucket?js:t===Z.MaskColorFill?zs:Ts});return(t,o)=>(oe(),le("div",Hs,[P("div",Ys,[(oe(),Ke(gn(e.value)))])]))}}),Zs={class:"flex flex-col gap-3 pb-3 h-full !items-stretch bg-[var(--comfy-menu-bg)] overflow-y-auto w-55 px-2.5"},qs={class:"w-full min-h-full"},Ks=Ce({__name:"SidePanel",props:{toolManager:{}},setup(n){return(e,t)=>(oe(),le("div",Zs,[P("div",qs,[pe(Xs),t[0]||(t[0]=P("div",{class:"w-full h-0.5 bg-[var(--border-color)] mt-6 mb-1.5"},null,-1)),pe(ks,{"tool-manager":e.toolManager},null,8,["tool-manager"])])]))}}),Do={[Z.MaskPen]:`
    <svg viewBox="0 0 44 44">
      <path class="cls-1" d="M10.97,15.98v14.04c0,.825.675,1.5,1.5,1.5h23.07c.825,0,1.5-.675,1.5-1.5V15.98c0-.825-.675-1.5-1.5-1.5H12.47c-.825,0-1.5.675-1.5,1.5ZM25.79,28.16c-4.365,1.41-8.355-2.58-6.945-6.945.51-1.575,1.785-2.85,3.36-3.36,4.365-1.41,8.355,2.58,6.945,6.945-.51,1.575-1.785,2.85-3.36,3.36Z"/>
    </svg>
  `,[Z.Eraser]:`
    <svg viewBox="0 0 44 44">
      <g>
        <rect class="cls-2" x="16.68" y="10" width="10.63" height="24" rx="1.16" ry="1.16" transform="translate(22 -9.11) rotate(45)"/>
        <path class="cls-1" d="M17.27,34.27c-.42,0-.85-.16-1.17-.48l-5.88-5.88c-.31-.31-.48-.73-.48-1.17s.17-.86.48-1.17l15.34-15.34c.62-.62,1.72-.62,2.34,0l5.88,5.88c.65.65.65,1.7,0,2.34l-15.34,15.34c-.32.32-.75.48-1.17.48ZM26.73,10.73c-.18,0-.34.07-.46.19l-15.34,15.34c-.12.12-.19.29-.19.46s.07.34.19.46l5.88,5.88c.26.26.67.26.93,0l15.34-15.34c.26-.26.26-.67,0-.93l-5.88-5.88c-.12-.12-.29-.19-.46-.19Z"/>
      </g>
      <path class="cls-3" d="M20.33,11.03h8.32c.64,0,1.16.52,1.16,1.16v15.79h-10.63v-15.79c0-.64.52-1.16,1.16-1.16Z" transform="translate(20.97 -11.61) rotate(45)"/>
    </svg>
  `,[Z.MaskBucket]:`
    <svg viewBox="0 0 44 44">
      <path class="cls-1" d="M33.4,21.76l-11.42,11.41-.04.05c-.61.61-1.6.61-2.21,0l-8.91-8.91c-.61-.61-.61-1.6,0-2.21l.04-.05.3-.29h22.24Z"/>
      <path class="cls-1" d="M20.83,34.17c-.55,0-1.07-.21-1.46-.6l-8.91-8.91c-.8-.8-.8-2.11,0-2.92l11.31-11.31c.8-.8,2.11-.8,2.92,0l8.91,8.91c.39.39.6.91.6,1.46s-.21,1.07-.6,1.46l-11.31,11.31c-.39.39-.91.6-1.46.6ZM23.24,10.83c-.27,0-.54.1-.75.31l-11.31,11.31c-.41.41-.41,1.09,0,1.5l8.91,8.91c.4.4,1.1.4,1.5,0l11.31-11.31c.2-.2.31-.47.31-.75s-.11-.55-.31-.75l-8.91-8.91c-.21-.21-.48-.31-.75-.31Z"/>
      <path class="cls-1" d="M34.28,26.85c0,.84-.68,1.52-1.52,1.52s-1.52-.68-1.52-1.52,1.52-2.86,1.52-2.86c0,0,1.52,2.02,1.52,2.86Z"/>
    </svg>
  `,[Z.MaskColorFill]:`
    <svg viewBox="0 0 44 44">
      <path class="cls-1" d="M30.29,13.72c-1.09-1.1-2.85-1.09-3.94,0l-2.88,2.88-.75-.75c-.2-.19-.51-.19-.71,0-.19.2-.19.51,0,.71l1.4,1.4-9.59,9.59c-.35.36-.54.82-.54,1.32,0,.14,0,.28.05.41-.05.04-.1.08-.15.13-.39.39-.39,1.01,0,1.4.38.39,1.01.39,1.4,0,.04-.04.08-.09.11-.13.14.04.3.06.45.06.5,0,.97-.19,1.32-.55l9.59-9.59,1.38,1.38c.1.09.22.14.35.14s.26-.05.35-.14c.2-.2.2-.52,0-.71l-.71-.72,2.88-2.89c1.08-1.08,1.08-2.85-.01-3.94ZM19.43,25.82h-2.46l7.15-7.15,1.23,1.23-5.92,5.92Z"/>
    </svg>
  `,[Z.PaintPen]:`
    <svg viewBox="0 0 44 44">
      <path class="cls-1" d="M34,13.93c0,.47-.19.94-.55,1.31l-13.02,13.04c-.09.07-.18.15-.27.22-.07-1.39-1.21-2.48-2.61-2.49.07-.12.16-.24.27-.34l13.04-13.04c.72-.72,1.89-.72,2.6,0,.35.35.55.83.55,1.3Z"/>
      <path class="cls-1" d="M19.64,29.03c0,4.46-6.46,3.18-9.64,0,3.3-.47,4.75-2.58,7.06-2.58,1.43,0,2.58,1.16,2.58,2.58Z"/>
    </svg>
  `};window.comfyAPI=window.comfyAPI||{};window.comfyAPI.constants=window.comfyAPI.constants||{};window.comfyAPI.constants.iconsHtml=Do;const Js={class:"h-full z-[8888] flex flex-col justify-between bg-comfy-menu-bg"},Qs={class:"flex flex-col"},ea=["onClick"],ta=["innerHTML"],oa=["title"],na={class:"text-sm text-text-secondary"},sa={class:"text-xs text-text-secondary"},aa=Ce({__name:"ToolPanel",props:{toolManager:{}},setup(n){const e=ie(),t=u(r=>{n.toolManager.switchTool(r)},"onToolSelect"),o=se(()=>e.currentTool),s=se(()=>`${Math.round(e.displayZoomRatio*100)}%`),a=se(()=>{const r=e.image;return r?`${r.width}x${r.height}`:" "}),i=u(()=>{e.resetZoom()},"onResetZoom");return(r,d)=>(oe(),le("div",Js,[P("div",Qs,[(oe(!0),le(fo,null,yo(N(xo),l=>(oe(),le("div",{key:l,class:Ue(["maskEditor_toolPanelContainer hover:bg-secondary-background-hover",{maskEditor_toolPanelContainerSelected:o.value===l}]),onClick:u(c=>t(l),"onClick")},[P("div",{class:"flex items-center justify-center",innerHTML:N(Do)[l]},null,8,ta),d[0]||(d[0]=P("div",{class:"maskEditor_toolPanelIndicator"},null,-1))],10,ea))),128))]),P("div",{class:"flex flex-col items-center cursor-pointer rounded-md mb-2 transition-colors duration-200 hover:bg-secondary-background-hover",title:N(E)("maskEditor.clickToResetZoom"),onClick:i},[P("span",na,te(s.value),1),P("span",sa,te(a.value),1)],8,oa)]))}}),ia={class:"maskEditor-ui-container flex min-h-0 flex-1 flex-col"},ra={class:"flex min-h-0 flex-1 overflow-hidden"},la=Ce({__name:"MaskEditorContent",props:{node:{}},setup(n){const e=ie(),t=ht(),o=nt(),s=Wn(),a=D(),i=D(),r=D(),d=D(),l=D(),c=D(),h=D(),f=D(),g=D(!1),p=Fn(),m=Un();let v=null,w=null;const y=u(_=>{_.ctrlKey&&_.preventDefault()},"handleDragStart"),k=u(async()=>{if(!a.value){console.error("[MaskEditorContent] Cannot initialize - missing required refs");return}if(!r.value||!d.value||!l.value||!i.value||!c.value){console.error("[MaskEditorContent] Cannot initialize - missing canvas refs");return}e.maskCanvas=d.value,e.rgbCanvas=l.value,e.imgCanvas=r.value,e.canvasContainer=i.value,e.canvasBackground=c.value;try{await s.loadFromNode(n.node),v=Xn(p,m);const C=await Bn().loadImages();await m.initializeCanvasPanZoom(C,a.value,h.value?.$el,f.value?.$el),e.canvasHistory.saveInitialState(),g.value=!0}catch(_){console.error("[MaskEditorContent] Initialization failed:",_),o.closeDialog()}},"initUI");return mo(()=>{p.addListeners(),a.value&&(w=new ResizeObserver(async()=>{m&&await m.invalidatePanZoom()}),w.observe(a.value)),k()}),mn(()=>{v?.brushDrawing.saveBrushSettings(),p?.removeListeners(),w&&(w.disconnect(),w=null),e.canvasHistory.clearStates(),e.resetState(),t.reset()}),(_,C)=>(oe(),le("div",{ref_key:"containerRef",ref:a,class:"maskEditor-dialog-root flex h-full w-full flex-col",onContextmenu:C[4]||(C[4]=He(()=>{},["prevent"])),onDragstart:y},[P("div",{id:"maskEditorCanvasContainer",ref_key:"canvasContainerRef",ref:i,onContextmenu:C[3]||(C[3]=He(()=>{},["prevent"]))},[P("canvas",{ref_key:"imgCanvasRef",ref:r,class:"absolute top-0 left-0 w-full h-full",onContextmenu:C[0]||(C[0]=He(()=>{},["prevent"]))},null,544),P("canvas",{ref_key:"rgbCanvasRef",ref:l,class:"absolute top-0 left-0 w-full h-full",onContextmenu:C[1]||(C[1]=He(()=>{},["prevent"]))},null,544),P("canvas",{ref_key:"maskCanvasRef",ref:d,class:"absolute top-0 left-0 w-full h-full",onContextmenu:C[2]||(C[2]=He(()=>{},["prevent"]))},null,544),P("div",{ref_key:"canvasBackgroundRef",ref:c,class:"bg-white w-full h-full"},null,512)],544),P("div",ia,[P("div",ra,[g.value?(oe(),Ke(aa,{key:0,ref_key:"toolPanelRef",ref:h,"tool-manager":N(v)},null,8,["tool-manager"])):st("",!0),g.value?(oe(),Ke(qn,{key:1,"tool-manager":N(v),"pan-zoom":N(m)},null,8,["tool-manager","pan-zoom"])):st("",!0),g.value?(oe(),Ke(Ks,{key:2,ref_key:"sidePanelRef",ref:f,"tool-manager":N(v)},null,8,["tool-manager"])):st("",!0)])]),g.value?(oe(),Ke(Zn,{key:0,"container-ref":a.value},null,8,["container-ref"])):st("",!0)],544))}}),ca=tn(la,[["__scopeId","data-v-a81aa0f6"]]);function da(n){return{maskedImage:`clipspace-mask-${n}.png`,paint:`clipspace-paint-${n}.png`,paintedImage:`clipspace-painted-${n}.png`,paintedMaskedImage:`clipspace-painted-masked-${n}.png`}}u(da,"imageLayerFilenamesByTimestamp");function ua(){const n=ht(),e=ie(),t=ho(),o=u(async()=>{const y=n.sourceNode;if(!y||!n.inputData)throw new Error("No source node or input data");try{const k=await s();n.outputData=k,await f(y,k),await l(k),g(y,k),b.graph.setDirtyCanvas(!0)}catch(k){throw console.error("[MaskEditorSaver] Save failed:",k),k}},"save");async function s(){const y=e.maskCanvas,k=e.rgbCanvas,_=e.imgCanvas;if(!y||!k||!_)throw new Error("Canvas not initialized");const C=Date.now(),I=da(C),[$,U,W,H]=await Promise.all([a(_,y,I.maskedImage),i(k,I.paint),r(_,k,I.paintedImage),d(_,k,y,I.paintedMaskedImage)]);return{maskedImage:$,paintLayer:U,paintedImage:W,paintedMaskedImage:H}}u(s,"prepareOutputData");async function a(y,k,_){const C=document.createElement("canvas");C.width=y.width,C.height=y.height;const I=C.getContext("2d");I.drawImage(y,0,0);const U=k.getContext("2d").getImageData(0,0,k.width,k.height),W=new Uint8ClampedArray(U.data.length);for(let Y=0;Y<U.data.length;Y+=4)W[Y]=0,W[Y+1]=0,W[Y+2]=0,W[Y+3]=255-U.data[Y+3];const H=I.getImageData(0,0,C.width,C.height);for(let Y=0;Y<H.data.length;Y+=4)H.data[Y+3]=W[Y+3];I.putImageData(H,0,0);const j=await v(C),Q=w(_);return{canvas:C,blob:j,ref:Q}}u(a,"createMaskedImage");async function i(y,k){const _=m(y),C=await v(_),I=w(k);return{canvas:_,blob:C,ref:I}}u(i,"createPaintLayer");async function r(y,k,_){const C=document.createElement("canvas");C.width=y.width,C.height=y.height;const I=C.getContext("2d");I.drawImage(y,0,0),I.globalCompositeOperation="source-over",I.drawImage(k,0,0);const $=await v(C),U=w(_);return{canvas:C,blob:$,ref:U}}u(r,"createPaintedImage");async function d(y,k,_,C){const I=document.createElement("canvas");I.width=y.width,I.height=y.height;const $=I.getContext("2d");$.drawImage(y,0,0),$.globalCompositeOperation="source-over",$.drawImage(k,0,0);const W=_.getContext("2d").getImageData(0,0,_.width,_.height),H=new Uint8ClampedArray(W.data.length);for(let K=0;K<W.data.length;K+=4)H[K]=0,H[K+1]=0,H[K+2]=0,H[K+3]=255-W.data[K+3];const j=$.getImageData(0,0,I.width,I.height);for(let K=0;K<j.data.length;K+=4)j.data[K+3]=H[K+3];$.putImageData(j,0,0);const Q=await v(I),Y=w(C);return{canvas:I,blob:Q,ref:Y}}u(d,"createPaintedMaskedImage");async function l(y){const k=n.inputData.sourceRef,_=await c(y.maskedImage,k),C=await h(y.paintLayer,k),I=await h(y.paintedImage,k),$=await c(y.paintedMaskedImage,I);y.maskedImage.ref=_,y.paintLayer.ref=C,y.paintedImage.ref=I,y.paintedMaskedImage.ref=$}u(l,"uploadAllLayers");async function c(y,k){const _=new FormData;_.append("image",y.blob,y.ref.filename),_.append("original_ref",JSON.stringify(k)),_.append("type","input"),_.append("subfolder","clipspace");const C=await ae.fetchApi("/upload/mask",{method:"POST",body:_});if(!C.ok)throw new Error(`Failed to upload mask: ${y.ref.filename}`);try{const I=await C.json();if(I?.name)return{filename:I.name,subfolder:I.subfolder||y.ref.subfolder,type:I.type||y.ref.type}}catch(I){console.warn("[MaskEditorSaver] Failed to parse upload response:",I)}return y.ref}u(c,"uploadMask");async function h(y,k){const _=new FormData;_.append("image",y.blob,y.ref.filename),_.append("original_ref",JSON.stringify(k)),_.append("type","input"),_.append("subfolder","clipspace");const C=await ae.fetchApi("/upload/image",{method:"POST",body:_});if(!C.ok)throw new Error(`Failed to upload image: ${y.ref.filename}`);try{const I=await C.json();if(I?.name)return{filename:I.name,subfolder:I.subfolder||y.ref.subfolder,type:I.type||y.ref.type}}catch(I){console.warn("[MaskEditorSaver] Failed to parse upload response:",I)}return y.ref}u(h,"uploadImage");async function f(y,k){const C=k.paintedMaskedImage.canvas.toDataURL("image/png"),I=await p(C);y.imgs=[I],b.graph.setDirtyCanvas(!0)}u(f,"updateNodePreview");function g(y,k){const _=k.paintedMaskedImage.ref;y.images=[_];const C=y.widgets?.find(I=>I.name==="image");if(C){let I;if(I=(_.subfolder?_.subfolder+"/":"")+_.filename+(_.type?` [${_.type}]`:""),C.value=I,y.properties&&(y.properties.image=I),y.widgets_values&&y.widgets){const $=y.widgets.indexOf(C);$>=0&&(y.widgets_values[$]=I)}C.callback?.(I)}t.updateNodeImages(y)}u(g,"updateNodeWithServerReferences");function p(y){return new Promise((k,_)=>{const C=new Image;C.crossOrigin="anonymous",C.onload=()=>k(C),C.onerror=I=>{console.error("[MaskEditorSaver] Failed to load image:",y,I),_(new Error(`Failed to load image: ${y}`))},C.src=y})}u(p,"loadImageFromUrl");function m(y){const k=document.createElement("canvas");return k.width=y.width,k.height=y.height,k.getContext("2d").drawImage(y,0,0),k}u(m,"cloneCanvas");function v(y){return new Promise((k,_)=>{y.toBlob(C=>{C?k(C):_(new Error("Failed to create blob from canvas"))},"image/png")})}u(v,"canvasToBlob");function w(y){return{filename:y,subfolder:"clipspace",type:"input"}}return u(w,"createFileRef"),{save:o}}u(ua,"useMaskEditorSaver");const pa={class:"flex w-full items-center justify-between gap-3"},ha={class:"flex items-center gap-3"},ga={class:"m-0 text-lg font-semibold"},ma={class:"flex items-center gap-4"},fa=["title"],ya=["title"],va={class:"flex gap-3"},to="flex h-7.5 w-12.5 items-center justify-center rounded-[10px] border border-[var(--p-form-field-border-color)] pointer-events-auto transition-colors duration-100 bg-[var(--comfy-menu-bg)] hover:bg-secondary-background-hover",oo="h-7.5 w-15 rounded-[10px] border border-[var(--p-form-field-border-color)] text-[var(--input-text)] font-sans pointer-events-auto transition-colors duration-100 bg-[var(--comfy-menu-bg)] hover:bg-secondary-background-hover",wa=Ce({__name:"TopBarHeader",setup(n){const e=ie(),t=nt(),o=Io(),s=ua(),a=D(E("g.save")),i=D(!0),r=u(()=>{e.canvasHistory.undo()},"onUndo"),d=u(()=>{e.canvasHistory.redo()},"onRedo"),l=u(()=>{o.invertMask()},"onInvert"),c=u(()=>{o.clearMask()},"onClear"),h=u(async()=>{a.value=E("g.saving"),i.value=!1;try{e.brushVisible=!1,await s.save(),t.closeDialog()}catch(g){console.error("[TopBarHeader] Save failed:",g),e.brushVisible=!0,a.value=E("g.save"),i.value=!0}},"handleSave"),f=u(()=>{t.closeDialog({key:"global-mask-editor"})},"handleCancel");return(g,p)=>(oe(),le("div",pa,[P("div",ha,[P("h3",ga,te(N(E)("maskEditor.title")),1),P("div",ma,[P("button",{class:Ue(to),title:N(E)("maskEditor.undo"),onClick:r},p[0]||(p[0]=[P("svg",{viewBox:"0 0 15 15",class:"h-6.25 w-6.25 pointer-events-none fill-[var(--input-text)]"},[P("path",{d:"M8.77,12.18c-.25,0-.46-.2-.46-.46s.2-.46.46-.46c1.47,0,2.67-1.2,2.67-2.67,0-1.57-1.34-2.67-3.26-2.67h-3.98l1.43,1.43c.18.18.18.47,0,.64-.18.18-.47.18-.64,0l-2.21-2.21c-.18-.18-.18-.47,0-.64l2.21-2.21c.18-.18.47-.18.64,0,.18.18.18.47,0,.64l-1.43,1.43h3.98c2.45,0,4.17,1.47,4.17,3.58,0,1.97-1.61,3.58-3.58,3.58Z"})],-1)]),8,fa),P("button",{class:Ue(to),title:N(E)("maskEditor.redo"),onClick:d},p[1]||(p[1]=[P("svg",{viewBox:"0 0 15 15",class:"h-6.25 w-6.25 pointer-events-none fill-[var(--input-text)]"},[P("path",{class:"cls-1",d:"M6.23,12.18c-1.97,0-3.58-1.61-3.58-3.58,0-2.11,1.71-3.58,4.17-3.58h3.98l-1.43-1.43c-.18-.18-.18-.47,0-.64.18-.18.46-.18.64,0l2.21,2.21c.09.09.13.2.13.32s-.05.24-.13.32l-2.21,2.21c-.18.18-.47.18-.64,0-.18-.18-.18-.47,0-.64l1.43-1.43h-3.98c-1.92,0-3.26,1.1-3.26,2.67,0,1.47,1.2,2.67,2.67,2.67.25,0,.46.2.46.46s-.2.46-.46.46Z"})],-1)]),8,ya),P("button",{class:Ue(oo),onClick:l},te(N(E)("maskEditor.invert")),1),P("button",{class:Ue(oo),onClick:c},te(N(E)("maskEditor.clear")),1)])]),P("div",va,[pe(N(Gt),{label:a.value,icon:"pi pi-check",size:"small",disabled:!i.value,onClick:h},null,8,["label","disabled"]),pe(N(Gt),{label:N(E)("g.cancel"),icon:"pi pi-times",size:"small",severity:"secondary",onClick:f},null,8,["label"])])]))}});function ba(n){const e=n.split(";base64,"),t=e[0].split(":")[1],o=atob(e[1]),s=new ArrayBuffer(o.length),a=new Uint8Array(s);for(let i=0;i<o.length;i++)a[i]=o.charCodeAt(i);return new Blob([s],{type:t})}u(ba,"dataURLToBlob");function ka(n){return new Promise(e=>{const t=new Image;t.onload=function(){e(t)},t.src=n})}u(ka,"loadImage");async function xa(n,e){await ae.fetchApi("/upload/mask",{method:"POST",body:e}).catch(t=>{console.error("Error:",t)}),X.clipspace.imgs[X.clipspace.selectedIndex]=new Image,X.clipspace.imgs[X.clipspace.selectedIndex].src=ae.apiURL("/view?"+new URLSearchParams(n).toString()+b.getPreviewFormatParam()+b.getRandParam()),X.clipspace.images&&(X.clipspace.images[X.clipspace.selectedIndex]=n),ue.invalidatePreview()}u(xa,"uploadMask");function Ca(n,e,t,o){t.drawImage(n,0,0,e.width,e.height);const s=t.getImageData(0,0,e.width,e.height);for(let a=0;a<s.data.length;a+=4)s.data[a+3]==255?s.data[a+3]=0:s.data[a+3]=255,s.data[a]=o.r,s.data[a+1]=o.g,s.data[a+2]=o.b;t.globalCompositeOperation="source-over",t.putImageData(s,0,0)}u(Ca,"prepare_mask");class re extends Et{static{u(this,"MaskEditorDialogOld")}static instance=null;static mousedown_x=null;static mousedown_y=null;brush;maskCtx;maskCanvas;brush_size_slider;brush_opacity_slider;colorButton;saveButton;zoom_ratio;pan_x;pan_y;imgCanvas;last_display_style;is_visible;image;handler_registered;brush_slider_input;cursorX;cursorY;mousedown_pan_x;mousedown_pan_y;last_pressure;pointer_type;brush_pointer_type_select;static getInstance(){return re.instance||(re.instance=new re),re.instance}is_layout_created=!1;constructor(){super(),this.element=L("div.comfy-modal",{parent:document.body},[L("div.comfy-modal-content",[...this.createButtons()])])}createButtons(){return[]}createButton(e,t){var o=document.createElement("button");return o.style.pointerEvents="auto",o.innerText=e,o.addEventListener("click",t),o}createLeftButton(e,t){var o=this.createButton(e,t);return o.style.cssFloat="left",o.style.marginRight="4px",o}createRightButton(e,t){var o=this.createButton(e,t);return o.style.cssFloat="right",o.style.marginLeft="4px",o}createLeftSlider(e,t,o){const s=document.createElement("div");s.id="maskeditor-slider",s.style.cssFloat="left",s.style.fontFamily="sans-serif",s.style.marginRight="4px",s.style.color="var(--input-text)",s.style.backgroundColor="var(--comfy-input-bg)",s.style.borderRadius="8px",s.style.borderColor="var(--border-color)",s.style.borderStyle="solid",s.style.fontSize="15px",s.style.height="25px",s.style.padding="1px 6px",s.style.display="flex",s.style.position="relative",s.style.top="2px",s.style.pointerEvents="auto",e.brush_slider_input=document.createElement("input"),e.brush_slider_input.setAttribute("type","range"),e.brush_slider_input.setAttribute("min","1"),e.brush_slider_input.setAttribute("max","100"),e.brush_slider_input.setAttribute("value","10");const a=document.createElement("label");return a.textContent=t,s.appendChild(a),s.appendChild(e.brush_slider_input),e.brush_slider_input.addEventListener("change",o),s}createOpacitySlider(e,t,o){const s=document.createElement("div");s.id="maskeditor-opacity-slider",s.style.cssFloat="left",s.style.fontFamily="sans-serif",s.style.marginRight="4px",s.style.color="var(--input-text)",s.style.backgroundColor="var(--comfy-input-bg)",s.style.borderRadius="8px",s.style.borderColor="var(--border-color)",s.style.borderStyle="solid",s.style.fontSize="15px",s.style.height="25px",s.style.padding="1px 6px",s.style.display="flex",s.style.position="relative",s.style.top="2px",s.style.pointerEvents="auto",e.opacity_slider_input=document.createElement("input"),e.opacity_slider_input.setAttribute("type","range"),e.opacity_slider_input.setAttribute("min","0.1"),e.opacity_slider_input.setAttribute("max","1.0"),e.opacity_slider_input.setAttribute("step","0.01"),e.opacity_slider_input.setAttribute("value","0.7");const a=document.createElement("label");return a.textContent=t,s.appendChild(a),s.appendChild(e.opacity_slider_input),e.opacity_slider_input.addEventListener("input",o),s}createPointerTypeSelect(e){const t=document.createElement("div");t.id="maskeditor-pointer-type",t.style.cssFloat="left",t.style.fontFamily="sans-serif",t.style.marginRight="4px",t.style.color="var(--input-text)",t.style.backgroundColor="var(--comfy-input-bg)",t.style.borderRadius="8px",t.style.borderColor="var(--border-color)",t.style.borderStyle="solid",t.style.fontSize="15px",t.style.height="25px",t.style.padding="1px 6px",t.style.display="flex",t.style.position="relative",t.style.top="2px",t.style.pointerEvents="auto";const o=document.createElement("label");o.textContent="Pointer Type:";const s=document.createElement("select");s.style.borderRadius="0",s.style.borderColor="transparent",s.style.borderStyle="unset",s.style.fontSize="0.9em";const a=document.createElement("option");a.value="arc",a.text="Circle",a.selected=!0;const i=document.createElement("option");return i.value="rect",i.text="Square",s.appendChild(a),s.appendChild(i),s.addEventListener("change",r=>{const d=r.target;e.pointer_type=d.value,this.setBrushBorderRadius(e)}),t.appendChild(o),t.appendChild(s),t}setBrushBorderRadius(e){e.pointer_type==="rect"?(this.brush.style.borderRadius="0%",this.brush.style.MozBorderRadius="0%",this.brush.style.WebkitBorderRadius="0%"):(this.brush.style.borderRadius="50%",this.brush.style.MozBorderRadius="50%",this.brush.style.WebkitBorderRadius="50%")}setlayout(e,t){const o=this;o.pointer_type="arc";var s=document.createElement("div");s.style.position="absolute",s.style.bottom="0px",s.style.left="20px",s.style.right="20px",s.style.height="50px",s.style.pointerEvents="none";var a=document.createElement("div");a.id="brush",a.style.backgroundColor="transparent",a.style.outline="1px dashed black",a.style.boxShadow="0 0 0 1px white",a.style.position="absolute",a.style.zIndex="8889",a.style.pointerEvents="none",this.brush=a,this.setBrushBorderRadius(o),this.element.appendChild(e),this.element.appendChild(t),this.element.appendChild(s),document.body.appendChild(a);var i=this.createLeftButton("Clear",()=>{o.maskCtx.clearRect(0,0,o.maskCanvas.width,o.maskCanvas.height)});this.brush_size_slider=this.createLeftSlider(o,"Thickness",l=>{o.brush_size=l.target.value,o.updateBrushPreview(o)}),this.brush_opacity_slider=this.createOpacitySlider(o,"Opacity",l=>{o.brush_opacity=l.target.value,o.brush_color_mode!=="negative"&&(o.maskCanvas.style.opacity=o.brush_opacity.toString())}),this.brush_pointer_type_select=this.createPointerTypeSelect(o),this.colorButton=this.createLeftButton(this.getColorButtonText(),()=>{o.brush_color_mode==="black"?o.brush_color_mode="white":o.brush_color_mode==="white"?o.brush_color_mode="negative":o.brush_color_mode="black",o.updateWhenBrushColorModeChanged()});var r=this.createRightButton("Cancel",()=>{document.removeEventListener("keydown",re.handleKeyDown),o.close()});this.saveButton=this.createRightButton("Save",()=>{document.removeEventListener("keydown",re.handleKeyDown),o.save()}),this.element.appendChild(e),this.element.appendChild(t),this.element.appendChild(s),s.appendChild(i),s.appendChild(this.saveButton),s.appendChild(r),s.appendChild(this.brush_size_slider),s.appendChild(this.brush_opacity_slider),s.appendChild(this.brush_pointer_type_select),s.appendChild(this.colorButton),e.style.position="absolute",t.style.position="absolute",e.style.top="200",e.style.left="0",t.style.top=e.style.top,t.style.left=e.style.left;const d=this.getMaskCanvasStyle();t.style.mixBlendMode=d.mixBlendMode,t.style.opacity=d.opacity.toString()}async show(){if(this.zoom_ratio=1,this.pan_x=0,this.pan_y=0,!this.is_layout_created){const e=document.createElement("canvas"),t=document.createElement("canvas");e.id="imageCanvas",t.id="maskCanvas",this.setlayout(e,t),this.imgCanvas=e,this.maskCanvas=t,this.maskCtx=t.getContext("2d",{willReadFrequently:!0}),this.setEventHandler(t),this.is_layout_created=!0;const o=this,s=new MutationObserver(function(i){i.forEach(function(r){r.type==="attributes"&&r.attributeName==="style"&&(o.last_display_style&&o.last_display_style!="none"&&o.element.style.display=="none"&&(o.brush.style.display="none",X.onClipspaceEditorClosed()),o.last_display_style=o.element.style.display)})}),a={attributes:!0};s.observe(this.element,a)}document.addEventListener("keydown",re.handleKeyDown),X.clipspace_return_node?this.saveButton.innerText="Save to node":this.saveButton.innerText="Save",this.saveButton.disabled=!1,this.element.style.display="block",this.element.style.width="85%",this.element.style.margin="0 7.5%",this.element.style.height="100vh",this.element.style.top="50%",this.element.style.left="42%",this.element.style.zIndex="8888",await this.setImages(this.imgCanvas),this.is_visible=!0}isOpened(){return this.element.style.display=="block"}invalidateCanvas(e,t){this.imgCanvas.width=e.width,this.imgCanvas.height=e.height,this.maskCanvas.width=e.width,this.maskCanvas.height=e.height;let o=this.imgCanvas.getContext("2d",{willReadFrequently:!0}),s=this.maskCanvas.getContext("2d",{willReadFrequently:!0});o.drawImage(e,0,0,e.width,e.height),Ca(t,this.maskCanvas,s,this.getMaskColor())}async setImages(e){let t=this;const o=e.getContext("2d",{willReadFrequently:!0}),s=this.maskCtx,a=this.maskCanvas;o.clearRect(0,0,this.imgCanvas.width,this.imgCanvas.height),s.clearRect(0,0,this.maskCanvas.width,this.maskCanvas.height);const i=new URL(X.clipspace.imgs[X.clipspace.selectedIndex].src);i.searchParams.delete("channel"),i.searchParams.delete("preview"),i.searchParams.set("channel","a");let r=await ka(i);const d=new URL(X.clipspace.imgs[X.clipspace.selectedIndex].src);d.searchParams.delete("channel"),d.searchParams.set("channel","rgb"),this.image=new Image,this.image.onload=function(){a.width=t.image.width,a.height=t.image.height,t.invalidateCanvas(t.image,r),t.initializeCanvasPanZoom()},this.image.src=d.toString()}initializeCanvasPanZoom(){let e=this.image.width,t=this.image.height,o=this.element.clientWidth,s=this.element.clientHeight;this.image.width>o&&(e=o,t=e/this.image.width*this.image.height),t>s&&(t=s,e=t/this.image.height*this.image.width),this.zoom_ratio=e/this.image.width;const a=(o-e)/2,i=(s-t)/2;this.pan_x=a,this.pan_y=i,this.invalidatePanZoom()}invalidatePanZoom(){let e=this.image.width*this.zoom_ratio,t=this.image.height*this.zoom_ratio;this.pan_x+e<10&&(this.pan_x=10-e),this.pan_y+t<10&&(this.pan_y=10-t);let o=`${e}px`,s=`${t}px`,a=`${this.pan_x}px`,i=`${this.pan_y}px`;this.maskCanvas.style.width=o,this.maskCanvas.style.height=s,this.maskCanvas.style.left=a,this.maskCanvas.style.top=i,this.imgCanvas.style.width=o,this.imgCanvas.style.height=s,this.imgCanvas.style.left=a,this.imgCanvas.style.top=i}setEventHandler(e){const t=this;this.handler_registered||(e.addEventListener("contextmenu",o=>{o.preventDefault()}),this.element.addEventListener("wheel",o=>this.handleWheelEvent(t,o)),this.element.addEventListener("pointermove",o=>this.pointMoveEvent(t,o)),this.element.addEventListener("touchmove",o=>this.pointMoveEvent(t,o)),this.element.addEventListener("dragstart",o=>{o.ctrlKey&&o.preventDefault()}),e.addEventListener("pointerdown",o=>this.handlePointerDown(t,o)),e.addEventListener("pointermove",o=>this.draw_move(t,o)),e.addEventListener("touchmove",o=>this.draw_move(t,o)),e.addEventListener("pointerover",()=>{this.brush.style.display="block"}),e.addEventListener("pointerleave",()=>{this.brush.style.display="none"}),document.addEventListener("pointerup",re.handlePointerUp),this.handler_registered=!0)}getMaskCanvasStyle(){return this.brush_color_mode==="negative"?{mixBlendMode:"difference",opacity:"1"}:{mixBlendMode:"initial",opacity:this.brush_opacity}}getMaskColor(){return this.brush_color_mode==="black"?{r:0,g:0,b:0}:this.brush_color_mode==="white"?{r:255,g:255,b:255}:this.brush_color_mode==="negative"?{r:255,g:255,b:255}:{r:0,g:0,b:0}}getMaskFillStyle(){const e=this.getMaskColor();return"rgb("+e.r+","+e.g+","+e.b+")"}getColorButtonText(){let e="unknown";return this.brush_color_mode==="black"?e="black":this.brush_color_mode==="white"?e="white":this.brush_color_mode==="negative"&&(e="negative"),"Color: "+e}updateWhenBrushColorModeChanged(){this.colorButton.innerText=this.getColorButtonText();const e=this.getMaskCanvasStyle();this.maskCanvas.style.mixBlendMode=e.mixBlendMode,this.maskCanvas.style.opacity=e.opacity.toString();const t=this.getMaskColor(),o=this.maskCtx.getImageData(0,0,this.maskCanvas.width,this.maskCanvas.height);for(let s=0;s<o.data.length;s+=4)o.data[s]=t.r,o.data[s+1]=t.g,o.data[s+2]=t.b;this.maskCtx.putImageData(o,0,0)}brush_opacity=.7;brush_size=10;brush_color_mode="black";drawing_mode=!1;lastx=-1;lasty=-1;lasttime=0;static handleKeyDown(e){const t=re.instance;e.key==="]"?(t.brush_size=Math.min(t.brush_size+2,100),t.brush_slider_input.value=t.brush_size):e.key==="["?(t.brush_size=Math.max(t.brush_size-2,1),t.brush_slider_input.value=t.brush_size):e.key==="Enter"&&t.save(),t.updateBrushPreview(t)}static handlePointerUp(e){e.preventDefault(),this.mousedown_x=null,this.mousedown_y=null,re.instance.drawing_mode=!1}updateBrushPreview(e){const t=e.brush;var o=e.cursorX,s=e.cursorY;t.style.width=e.brush_size*2*this.zoom_ratio+"px",t.style.height=e.brush_size*2*this.zoom_ratio+"px",t.style.left=o-e.brush_size*this.zoom_ratio+"px",t.style.top=s-e.brush_size*this.zoom_ratio+"px"}handleWheelEvent(e,t){t.preventDefault(),t.ctrlKey?(t.deltaY<0?this.zoom_ratio=Math.min(10,this.zoom_ratio+.2):this.zoom_ratio=Math.max(.2,this.zoom_ratio-.2),this.invalidatePanZoom()):(t.deltaY<0?this.brush_size=Math.min(this.brush_size+2,100):this.brush_size=Math.max(this.brush_size-2,1),this.brush_slider_input.value=this.brush_size.toString(),this.updateBrushPreview(this))}pointMoveEvent(e,t){this.cursorX=t.pageX,this.cursorY=t.pageY,e.updateBrushPreview(e),t.ctrlKey&&(t.preventDefault(),e.pan_move(e,t));let o=window.TouchEvent&&t instanceof TouchEvent||t.buttons==1;if(t.shiftKey&&o){e.drawing_mode=!1;const s=t.clientY;let a=(e.zoom_lasty-s)*.005;e.zoom_ratio=Math.max(Math.min(10,e.last_zoom_ratio-a),.2),this.invalidatePanZoom();return}}pan_move(e,t){if(t.buttons==1&&re.mousedown_x){let o=re.mousedown_x-t.clientX,s=re.mousedown_y-t.clientY;e.pan_x=this.mousedown_pan_x-o,e.pan_y=this.mousedown_pan_y-s,e.invalidatePanZoom()}}draw_move(e,t){if(t.ctrlKey||t.shiftKey)return;t.preventDefault(),this.cursorX=t.pageX,this.cursorY=t.pageY,e.updateBrushPreview(e);let o=window.TouchEvent&&t instanceof TouchEvent||t.buttons==1,s=[2,5,32].includes(t.buttons);if(!t.altKey&&o){var a=performance.now()-e.lasttime;const l=e.maskCanvas.getBoundingClientRect();var i=t.offsetX,r=t.offsetY;t.offsetX==null&&(i=t.targetTouches[0].clientX-l.left),t.offsetY==null&&(r=t.targetTouches[0].clientY-l.top),i/=e.zoom_ratio,r/=e.zoom_ratio;var d=this.brush_size;t instanceof PointerEvent&&t.pointerType=="pen"?(d*=t.pressure,this.last_pressure=t.pressure):window.TouchEvent&&t instanceof TouchEvent&&a<20?d*=this.last_pressure:d=this.brush_size,a>20&&!this.drawing_mode?requestAnimationFrame(()=>{e.init_shape(e,"source-over"),e.draw_shape(e,i,r,d),e.lastx=i,e.lasty=r}):requestAnimationFrame(()=>{e.init_shape(e,"source-over");for(var c=i-e.lastx,h=r-e.lasty,f=Math.sqrt(c*c+h*h),g=c/f,p=h/f,m=0;m<f;m+=5){var v=e.lastx+g*m,w=e.lasty+p*m;e.draw_shape(e,v,w,d)}e.lastx=i,e.lasty=r}),e.lasttime=performance.now()}else if(t.altKey&&o||s){const l=e.maskCanvas.getBoundingClientRect(),c=(t.offsetX||t.targetTouches[0].clientX-l.left)/e.zoom_ratio,h=(t.offsetY||t.targetTouches[0].clientY-l.top)/e.zoom_ratio;var d=this.brush_size;t instanceof PointerEvent&&t.pointerType=="pen"?(d*=t.pressure,this.last_pressure=t.pressure):window.TouchEvent&&t instanceof TouchEvent&&a<20?d*=this.last_pressure:d=this.brush_size,a>20&&!this.drawing_mode?requestAnimationFrame(()=>{e.init_shape(e,"destination-out"),e.draw_shape(e,c,h,d),e.lastx=c,e.lasty=h}):requestAnimationFrame(()=>{e.init_shape(e,"destination-out");for(var g=c-e.lastx,p=h-e.lasty,m=Math.sqrt(g*g+p*p),v=g/m,w=p/m,y=0;y<m;y+=5){var k=e.lastx+v*y,_=e.lasty+w*y;e.draw_shape(e,k,_,d)}e.lastx=c,e.lasty=h}),e.lasttime=performance.now()}}handlePointerDown(e,t){if(t.ctrlKey){t.buttons==1&&(re.mousedown_x=t.clientX,re.mousedown_y=t.clientY,this.mousedown_pan_x=this.pan_x,this.mousedown_pan_y=this.pan_y);return}var o=this.brush_size;if(t instanceof PointerEvent&&t.pointerType=="pen"&&(o*=t.pressure,this.last_pressure=t.pressure),[0,2,5].includes(t.button)){if(e.drawing_mode=!0,t.preventDefault(),t.shiftKey){e.zoom_lasty=t.clientY,e.last_zoom_ratio=e.zoom_ratio;return}const s=e.maskCanvas.getBoundingClientRect(),a=(t.offsetX||t.targetTouches[0].clientX-s.left)/e.zoom_ratio,i=(t.offsetY||t.targetTouches[0].clientY-s.top)/e.zoom_ratio;!t.altKey&&t.button==0?e.init_shape(e,"source-over"):e.init_shape(e,"destination-out"),e.draw_shape(e,a,i,o),e.lastx=a,e.lasty=i,e.lasttime=performance.now()}}init_shape(e,t){e.maskCtx.beginPath(),t=="source-over"?(e.maskCtx.fillStyle=this.getMaskFillStyle(),e.maskCtx.globalCompositeOperation="source-over"):t=="destination-out"&&(e.maskCtx.globalCompositeOperation="destination-out")}draw_shape(e,t,o,s){e.pointer_type==="rect"?e.maskCtx.rect(t-s,o-s,s*2,s*2):e.maskCtx.arc(t,o,s,0,Math.PI*2,!1),e.maskCtx.fill()}async save(){const e=document.createElement("canvas"),t=e.getContext("2d",{willReadFrequently:!0});e.width=this.image.width,e.height=this.image.height,t.clearRect(0,0,e.width,e.height),t.drawImage(this.maskCanvas,0,0,this.maskCanvas.width,this.maskCanvas.height,0,0,e.width,e.height);const o=t.getImageData(0,0,e.width,e.height);for(let g=0;g<o.data.length;g+=4)o.data[g+3]==255?o.data[g+3]=0:o.data[g+3]=255,o.data[g]=0,o.data[g+1]=0,o.data[g+2]=0;t.globalCompositeOperation="source-over",t.putImageData(o,0,0);const s=new FormData,a="clipspace-mask-"+performance.now()+".png",i={filename:a,subfolder:"clipspace",type:"input"};if(X.clipspace.images&&(X.clipspace.images[0]=i),X.clipspace.widgets){const g=X.clipspace.widgets.findIndex(p=>p.name==="image");g>=0&&(X.clipspace.widgets[g].value=i)}const r=e.toDataURL(),d=ba(r);let l=new URL(this.image.src);const c={filename:l.searchParams.get("filename")};let h=l.searchParams.get("subfolder");h&&(c.subfolder=h);let f=l.searchParams.get("type");f&&(c.type=f),s.append("image",d,a),s.append("original_ref",JSON.stringify(c)),s.append("type","input"),s.append("subfolder","clipspace"),this.saveButton.innerText="Saving...",this.saveButton.disabled=!0,await xa(i,s),X.onClipspaceEditorSave(),this.close()}}window.comfyAPI=window.comfyAPI||{};window.comfyAPI.maskEditorOld=window.comfyAPI.maskEditorOld||{};window.comfyAPI.maskEditorOld.MaskEditorDialogOld=re;function _a(n){if(!n){console.error("[MaskEditor] No node provided");return}if(!n.imgs?.length&&n.previewMediaType!=="image"){console.error("[MaskEditor] Node has no images");return}if(b.extensionManager.setting.get("Comfy.MaskEditor.UseNewEditor"))nt().showDialog({key:"global-mask-editor",headerComponent:wa,component:ca,props:{node:n},dialogComponentProps:{style:"width: 90vw; height: 90vh;",modal:!0,maximizable:!0,closable:!0,pt:{root:{class:"mask-editor-dialog flex flex-col"},content:{class:"flex flex-col min-h-0 flex-1 !p-0"},header:{class:"!p-2"}}}});else{X.copyToClipspace(n),X.clipspace_return_node=n;const t=re.getInstance();t?.isOpened&&!t.isOpened()&&t.show()}}u(_a,"openMaskEditor");function Ia(){return b.extensionManager.setting.get("Comfy.MaskEditor.UseNewEditor")?nt().isDialogOpen("global-mask-editor"):re.instance?.isOpened?.()??!1}u(Ia,"isOpened");b.registerExtension({name:"Comfy.MaskEditor",settings:[{id:"Comfy.MaskEditor.UseNewEditor",category:["Mask Editor","NewEditor"],name:"Use new mask editor",tooltip:"Switch to the new mask editor interface",type:"boolean",defaultValue:!0,experimental:!0},{id:"Comfy.MaskEditor.BrushAdjustmentSpeed",category:["Mask Editor","BrushAdjustment","Sensitivity"],name:"Brush adjustment speed multiplier",tooltip:"Controls how quickly the brush size and hardness change when adjusting. Higher values mean faster changes.",experimental:!0,type:"slider",attrs:{min:.1,max:2,step:.1},defaultValue:1,versionAdded:"1.0.0"},{id:"Comfy.MaskEditor.UseDominantAxis",category:["Mask Editor","BrushAdjustment","UseDominantAxis"],name:"Lock brush adjustment to dominant axis",tooltip:"When enabled, brush adjustments will only affect size OR hardness based on which direction you move more",type:"boolean",defaultValue:!0,experimental:!0}],commands:[{id:"Comfy.MaskEditor.OpenMaskEditor",icon:"pi pi-pencil",label:"Open Mask Editor for Selected Node",function:u(()=>{const n=b.canvas.selected_nodes;if(!n||Object.keys(n).length!==1)return;const e=n[Object.keys(n)[0]];_a(e)},"function")},{id:"Comfy.MaskEditor.BrushSize.Increase",icon:"pi pi-plus-circle",label:"Increase Brush Size in MaskEditor",function:u(()=>no(n=>de.clamp(n+4,1,100)),"function")},{id:"Comfy.MaskEditor.BrushSize.Decrease",icon:"pi pi-minus-circle",label:"Decrease Brush Size in MaskEditor",function:u(()=>no(n=>de.clamp(n-4,1,100)),"function")}],init(){const n=u(()=>{if(!b.extensionManager.setting.get("Comfy.MaskEditor.UseNewEditor")){const o=re.getInstance();o?.isOpened&&!o.isOpened()&&o.show()}},"openMaskEditorFromClipspace"),e=u(()=>!!(X.clipspace&&X.clipspace.imgs&&X.clipspace.imgs.length>0),"context_predicate");ue.registerButton("MaskEditor",e,n)}});const no=u(async n=>{if(!Ia())return;const e=ie(),t=e.brushSettings.size,o=n(t);e.setBrushSize(o)},"changeBrushSize"),St="COMFY_MATCHTYPE_V3";b.registerExtension({name:"Comfy.MatchType",beforeRegisterNodeDef(n,e){const t={...e.input?.required,...e.input?.optional};Object.values(t).some(o=>o[0]===St)&&(n.prototype.onNodeCreated=Xe(n.prototype.onNodeCreated,function(){const o={},s={};for(const a of this.inputs){if(a.type!==St)continue;const i=t[a.name][1]?.template;i&&(a.type=i.allowed_types??"*",o[i.template_id]??=[],o[i.template_id].push([a.name,a.type]))}this.outputs.forEach((a,i)=>{if(a.type!==St)return;const r=e.output_matchtypes?.[i];r!=null&&(s[r]??=[],s[r].push(i))});for(const a in o)Da(this,o[a],s[a])}))}});function Da(n,e,t){const o=new Array(e.length).fill("*");n.onConnectionsChange=Xe(n.onConnectionsChange,function(s,a,i,r){const d=this.inputs[a];if(s!==V.INPUT||!this.graph||!d)return;const l=e.findIndex(([c])=>c===d.name);if(l!=-1){if(o[l]=e[l][1],i&&r){const{output:c,subgraphInput:h}=r.resolve(this.graph),f=(c??h)?.type;f&&(r.type=o[l]=f)}for(let c=0;c<e.length;c++){const h=this.inputs.find(p=>p.name===e[c][0]);if(!h)continue;const f=[...o];f.splice(c,1);const g=so(...f,e[c][1]);if(!g)throw new Error("invalid connection");h.type=g}if(t){const c=so(...o);if(!c)throw new Error("invalid connection");Sa(this,c,t)}}})}u(Da,"addConnectionGroup");function Sa(n,e,t){if(n.graph){for(const o of t)if(n.outputs[o].type!==e){n.outputs[o].type=e;for(let s of n.outputs[o].links??[]){let a=n.graph.links[s];if(!a)continue;const{input:i,inputNode:r,subgraphOutput:d}=a.resolve(n.graph),l=(i??d)?.type;if(!l)continue;const c=V.isValidConnection(e,l);!c&&d?d.disconnect():!c&&r&&r.disconnectInput(a.target_slot),i&&r?.onConnectionsChange&&r.onConnectionsChange(V.INPUT,a.target_slot,c,a,i)}b.canvas.setDirty(!0,!0)}}}u(Sa,"changeOutputType");function Ma(n){return!n.some(e=>typeof e!="string")}u(Ma,"isStrings");function so(...n){if(!Ma(n))return;const e=un(n,"*");if(e.length===0)return"*";const t=e.map(s=>s.split(",")),o=Na(...t);if(o.length!==0)return o.join(",")}u(so,"combineTypes");function Na(...n){const e={};for(const t of n)for(const o of new Set(t))e[o]=(e[o]??0)+1;return Object.entries(e).filter(([,t])=>t==n.length).map(([t])=>t)}u(Na,"intersection");const Ta="Comfy.NodeTemplates",ao="comfy.templates.json";class Pa extends Et{static{u(this,"ManageTemplates")}templates;draggedEl;saveVisualCue;emptyImg;importInput;constructor(){super(),this.load().then(e=>{this.templates=e}),this.element.classList.add("comfy-manage-templates"),this.draggedEl=null,this.saveVisualCue=null,this.emptyImg=new Image,this.emptyImg.src="data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=",this.importInput=L("input",{type:"file",accept:".json",multiple:!0,style:{display:"none"},parent:document.body,onchange:u(()=>this.importAll(),"onchange")})}createButtons(){const e=super.createButtons();return e[0].textContent="Close",e[0].onclick=()=>{clearTimeout(this.saveVisualCue),this.close()},e.unshift(L("button",{type:"button",textContent:"Export",onclick:u(()=>this.exportAll(),"onclick")})),e.unshift(L("button",{type:"button",textContent:"Import",onclick:u(()=>{this.importInput.click()},"onclick")})),e}async load(){let e=[];const t=await ae.getUserData(ao);if(t.status===200)try{e=await t.json()}catch{}else t.status!==404&&console.error(t.status+" "+t.statusText);return e??[]}async store(){const e=JSON.stringify(this.templates,void 0,4);try{await ae.storeUserData(ao,e,{stringify:!1})}catch(t){console.error(t),he().addAlert(t.message)}}async importAll(){for(const e of this.importInput.files)if(e.type==="application/json"||e.name.endsWith(".json")){const t=new FileReader;t.onload=async()=>{const o=JSON.parse(t.result);if(o?.templates){for(const s of o.templates)s?.name&&s?.data&&this.templates.push(s);await this.store()}},await t.readAsText(e)}this.importInput.value=null,this.close()}exportAll(){if(this.templates.length==0){he().addAlert(E("toastMessages.noTemplatesToExport"));return}const e=JSON.stringify({templates:this.templates},null,2),t=new Blob([e],{type:"application/json"});zt("node_templates.json",t)}show(){super.show(L("div",{},this.templates.flatMap((e,t)=>{let o;return[L("div",{dataset:{id:t.toString()},className:"templateManagerRow",style:{display:"grid",gridTemplateColumns:"1fr auto",border:"1px dashed transparent",gap:"5px",backgroundColor:"var(--comfy-menu-bg)"},ondragstart:u(s=>{this.draggedEl=s.currentTarget,s.currentTarget.style.opacity="0.6",s.currentTarget.style.border="1px dashed yellow",s.dataTransfer.effectAllowed="move",s.dataTransfer.setDragImage(this.emptyImg,0,0)},"ondragstart"),ondragend:u(s=>{s.target.style.opacity="1",s.currentTarget.style.border="1px dashed transparent",s.currentTarget.removeAttribute("draggable"),this.element.querySelectorAll(".templateManagerRow").forEach((a,i)=>{var r=Number.parseInt(a.dataset.id);a==this.draggedEl&&r!=i&&this.templates.splice(i,0,this.templates.splice(r,1)[0]),a.dataset.id=i.toString()}),this.store()},"ondragend"),ondragover:u(s=>{if(s.preventDefault(),s.currentTarget==this.draggedEl)return;let a=s.currentTarget.getBoundingClientRect();s.clientY>a.top+a.height/2?s.currentTarget.parentNode.insertBefore(this.draggedEl,s.currentTarget.nextSibling):s.currentTarget.parentNode.insertBefore(this.draggedEl,s.currentTarget)},"ondragover")},[L("label",{textContent:"Name: ",style:{cursor:"grab"},onmousedown:u(s=>{s.target.localName=="label"&&(s.currentTarget.parentNode.draggable="true")},"onmousedown")},[L("input",{value:e.name,dataset:{name:e.name},style:{transitionProperty:"background-color",transitionDuration:"0s"},onchange:u(s=>{clearTimeout(this.saveVisualCue);var a=s.target,i=a.parentNode.parentNode;this.templates[i.dataset.id].name=a.value.trim()||"untitled",this.store(),a.style.backgroundColor="rgb(40, 95, 40)",a.style.transitionDuration="0s",this.saveVisualCue=setTimeout(function(){a.style.transitionDuration=".7s",a.style.backgroundColor="var(--comfy-input-bg)"},15)},"onchange"),onkeypress:u(s=>{var a=s.target;clearTimeout(this.saveVisualCue),a.style.transitionDuration="0s",a.style.backgroundColor="var(--comfy-input-bg)"},"onkeypress"),$:u(s=>o=s,"$")})]),L("div",{},[L("button",{textContent:"Export",style:{fontSize:"12px",fontWeight:"normal"},onclick:u(()=>{const s=JSON.stringify({templates:[e]},null,2),a=new Blob([s],{type:"application/json"}),i=(o.value||e.name)+".json";zt(i,a)},"onclick")}),L("button",{textContent:"Delete",style:{fontSize:"12px",color:"red",fontWeight:"normal"},onclick:u(s=>{const a=s.target.parentNode.parentNode;a.parentNode.removeChild(a),this.templates.splice(a.dataset.id*1,1),this.store();var i=this;setTimeout(function(){i.element.querySelectorAll(".templateManagerRow").forEach((r,d)=>{r.dataset.id=d.toString()})},0)},"onclick")})])])]})))}}const it=new Pa,io=u(async n=>{const e=localStorage.getItem("litegrapheditor_clipboard");await n(),localStorage.setItem("litegrapheditor_clipboard",e)},"clipboardAction"),Ea={name:Ta,getCanvasMenuItems(n){const e=[];e.push(null),e.push({content:"Save Selected as Template",disabled:!Object.keys(b.canvas.selected_nodes||{}).length,callback:u(async()=>{const o=await Je().prompt({title:E("nodeTemplates.saveAsTemplate"),message:E("nodeTemplates.enterName"),defaultValue:""});o?.trim()&&io(()=>{b.canvas.copyToClipboard();let s=localStorage.getItem("litegrapheditor_clipboard");s=JSON.parse(s||"{}");const a=Object.keys(b.canvas.selected_nodes);for(let i=0;i<a.length;i++){const r=b.graph.getNodeById(a[i]),d=r?.constructor.nodeData;let l=Te.getGroupData(r);if(l){if(l=l.nodeData,s.groupNodes||(s.groupNodes={}),d==null)throw new TypeError("nodeData is not set");s.groupNodes[d.name]=l,s.nodes[i].type=d.name}}it.templates.push({name:o,data:JSON.stringify(s)}),it.store()})},"callback")});const t=it.templates.map(o=>({content:o.name,callback:u(()=>{io(async()=>{const s=JSON.parse(o.data);await $e.registerFromWorkflow(s.groupNodes,{}),s.reroutes?(localStorage.setItem("litegrapheditor_clipboard",o.data),b.canvas.pasteFromClipboard()):po(o.data,b.canvas)})},"callback")}));return t.push(null,{content:"Manage",callback:u(()=>it.show(),"callback")}),e.push({content:"Node Templates",submenu:{options:t}}),e}};b.registerExtension(Ea);b.registerExtension({name:"Comfy.NoteNode",registerCustomNodes(){class n extends rt{static{u(this,"NoteNode")}static category;static collapsable;static title_mode;color=Me.node_colors.yellow.color;bgcolor=Me.node_colors.yellow.bgcolor;groupcolor=Me.node_colors.yellow.groupcolor;isVirtualNode;constructor(o){super(o),this.properties||(this.properties={text:""}),Ee.STRING(this,"text",["STRING",{default:this.properties.text,multiline:!0}],b),this.serialize_widgets=!0,this.isVirtualNode=!0}}V.registerNodeType("Note",Object.assign(n,{title_mode:V.NORMAL_TITLE,title:"Note",collapsable:!0})),n.category="utils";class e extends rt{static{u(this,"MarkdownNoteNode")}static title="Markdown Note";color=Me.node_colors.yellow.color;bgcolor=Me.node_colors.yellow.bgcolor;groupcolor=Me.node_colors.yellow.groupcolor;constructor(o){super(o),this.properties||(this.properties={text:""}),Ee.MARKDOWN(this,"text",["STRING",{default:this.properties.text}],b),this.serialize_widgets=!0,this.isVirtualNode=!0}}V.registerNodeType("MarkdownNote",e),e.category="utils"}});Ze().registerExtension({name:"Comfy.PreviewAny",async beforeRegisterNodeDef(n,e){if(e.name==="PreviewAny"){const t=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){t&&t.apply(this,[]);const s=Ee.STRING(this,"preview",["STRING",{multiline:!0}],b).widget;s.element.readOnly=!0,s.serialize=!1};const o=n.prototype.onExecuted;n.prototype.onExecuted=function(s){o?.apply(this,[s]);const a=this.widgets?.find(i=>i.name==="preview");a&&(a.value=s.text[0])}}}});b.registerExtension({name:"Comfy.RerouteNode",registerCustomNodes(n){class e extends rt{static{u(this,"RerouteNode")}static category;static defaultVisibility=!1;constructor(o){super(o??""),this.properties||(this.properties={}),this.properties.showOutputText=e.defaultVisibility,this.properties.horizontal=!1,this.addInput("","*"),this.addOutput(this.properties.showOutputText?"*":"","*"),this.isVirtualNode=!0}onAfterGraphConfigured(){requestAnimationFrame(()=>{this.onConnectionsChange(V.INPUT,void 0,!0)})}clone(){const o=super.clone();return o&&(o.removeOutput(0),o.addOutput(this.properties.showOutputText?"*":"","*"),o.setSize(o.computeSize()),o)}onConnectionsChange(o,s,a){const{graph:i}=this;if(!i||n.configuringGraph)return;if(a&&o===V.OUTPUT&&new Set(this.outputs[0].links?.map(y=>i.links[y]?.type)?.filter(y=>y&&y!=="*")??[]).size>1){const y=[];for(const k of this.outputs[0].links??[]){const _=i.links[k];y.push(_)}y.pop();for(const k of y)i.getNodeById(k.target_id)?.disconnectInput(k.target_slot)}let r=this,d=[],l=null,c=null;for(;r;){d.unshift(r);const w=r.inputs[0].link;if(w!==null){const y=i.links[w];if(!y)return;const k=i.getNodeById(y.origin_id);if(!k)return;if(k instanceof e)k===this?(r.disconnectInput(y.target_slot),r=null):r=k;else{c=r,l=k.outputs[y.origin_slot]?.type??null;break}}else{r=null;break}}const h=[this];let f=null;for(;h.length;){r=h.pop();const w=r.outputs?.[0]?.links??[];for(const y of w){const k=i.links[y];if(!k)continue;const _=i.getNodeById(k.target_id);if(_)if(_ instanceof e)h.push(_),d.push(_);else{const C=_.inputs[k.target_slot],I=C.type,$=!l||!I||V.isValidConnection(l,I);if(!$){_.disconnectInput(k.target_slot);continue}_.onConnectionsChange?.(V.INPUT,k.target_slot,$,k,C),f=_.inputs[k.target_slot].type}}}const g=l||f||"*",p=Me.link_type_colors[g];let m,v;for(const w of d){w.outputs[0].type=l||"*",w.__outputType=g,w.outputs[0].name=w.properties.showOutputText?`${g}`:"",w.setSize(w.computeSize());for(const y of w.outputs[0].links||[]){const k=i.links[y];if(!k||(k.color=p,n.configuringGraph))continue;const _=i.getNodeById(k.target_id);if(!_)continue;const C=_.inputs?.[k.target_slot];if(C?.widget){const I=Ft(C);m||(m=I[1]??{},v=I[0]);const $=ot(C,[I[0],m]);$.customConfig&&(m=$.customConfig)}}}for(const w of d)m&&f?(w.inputs[0].widget={name:"value"},Tt(w.inputs[0],[v??`${g}`,m])):Tt(w.inputs[0],void 0);if(c?.inputs?.[0]?.link){const w=i.links[c.inputs[0].link];w&&(w.color=p)}}getExtraMenuOptions(o,s){return s.unshift({content:(this.properties.showOutputText?"Hide":"Show")+" Type",callback:u(()=>{this.properties.showOutputText=!this.properties.showOutputText,this.properties.showOutputText?this.outputs[0].name=`${this.__outputType||this.outputs[0].type}`:this.outputs[0].name="",this.setSize(this.computeSize()),n.canvas.setDirty(!0,!0)},"callback")},{content:(e.defaultVisibility?"Hide":"Show")+" Type By Default",callback:u(()=>{e.setDefaultTextVisibility(!e.defaultVisibility)},"callback")}),[]}computeSize(){return[this.properties.showOutputText&&this.outputs&&this.outputs.length?Math.max(75,V.NODE_TEXT_SIZE*this.outputs[0].name.length*.6+40):75,26]}static setDefaultTextVisibility(o){e.defaultVisibility=o,o?localStorage["Comfy.RerouteNode.DefaultVisibility"]="true":delete localStorage["Comfy.RerouteNode.DefaultVisibility"]}}e.setDefaultTextVisibility(!!localStorage["Comfy.RerouteNode.DefaultVisibility"]),V.registerNodeType("Reroute",Object.assign(e,{title_mode:V.NO_TITLE,title:"Reroute",collapsable:!1})),e.category="utils"}});const La=new Set(["SaveImage","SaveVideo","SaveAnimatedWEBP","SaveWEBM","SaveAudio","SaveGLB","SaveAnimatedPNG","CLIPSave","VAESave","ModelSave","LoraSave","SaveLatent"]);b.registerExtension({name:"Comfy.SaveImageExtraOutput",async beforeRegisterNodeDef(n,e,t){if(La.has(e.name)){const o=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){const s=o?o.apply(this,arguments):void 0,a=this.widgets.find(i=>i.name==="filename_prefix");return a.serializeValue=()=>uo(t.graph,a.value),s}}else{const o=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){const s=o?o.apply(this,arguments):void 0;return(!this.properties||!("Node name for S&R"in this.properties))&&this.addProperty("Node name for S&R",this.constructor.type,"string"),s}}}});const ro={name:"image",type:"Preview3D",isPreview:!0};Ze().registerExtension({name:"Comfy.SaveGLB",async beforeRegisterNodeDef(n,e){e.name==="SaveGLB"&&(e.input.required.image=["PREVIEW_3D"])},getCustomWidgets(){return{PREVIEW_3D(n){const e=new Lt({node:n,name:ro.name,component:At,inputSpec:ro,options:{}});return e.type="load3D",Ot(n,e),{widget:e}}}},getNodeMenuItems(n){if(n.constructor.comfyClass!=="SaveGLB")return[];const e=lt().getLoad3d(n);return e?pt(e):[]},async nodeCreated(n){if(n.constructor.comfyClass!=="SaveGLB")return;const[e,t]=n.size;n.setSize([Math.max(e,400),Math.max(t,550)]),await Rt();const o=n.onExecuted;n.onExecuted=function(s){o?.apply(this,arguments);const a=s["3d"][0];tt(n).waitForLoad3d(i=>{const r=n.widgets?.find(d=>d.name==="image");if(i&&r){const d=a.subfolder+"/"+a.filename;r.value=d,new $t(i,n.properties).configureForSaveMesh(a.type,d)}})}}});function Oa(n,e){const t=e.selectedItems;if(t.size<=1)return;const o=on(t,10);if(!o)return;const[s,a,i,r]=o;n.save();const d=2/e.ds.scale;n.lineWidth=d,n.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--border-color").trim()||"#ffffff66";const l=5/e.ds.scale;n.setLineDash([l,l]),n.beginPath(),n.roundRect(s,a,i,r,8/e.ds.scale),n.stroke(),n.restore()}u(Oa,"drawSelectionBorder");const Ra={name:"Comfy.SelectionBorder",async init(){const n=b.canvas.onDrawForeground;b.canvas.onDrawForeground=function(e,t){n?.call(this,e,t),Oa(e,b.canvas)}}};b.registerExtension(Ra);let dt=!1,ut=0;b.registerExtension({name:"Comfy.SimpleTouchSupport",setup(){let n=null,e=null,t=null,o=null;function s(i){return Math.hypot(i.touches[0].clientX-i.touches[1].clientX,i.touches[0].clientY-i.touches[1].clientY)}u(s,"getMultiTouchPos");function a(i){return{clientX:(i.touches[0].clientX+i.touches[1].clientX)/2,clientY:(i.touches[0].clientY+i.touches[1].clientY)/2}}u(a,"getMultiTouchCenter"),b.canvasEl.parentElement?.addEventListener("touchstart",i=>{ut+=i.changedTouches.length,t=null,o=null,i.touches?.length===1?(e=new Date,t=i.touches[0]):(e=null,i.touches?.length===2&&(o=b.canvas.ds.scale,t=a(i),n=s(i),b.canvas.pointer.isDown=!1))},!0),b.canvasEl.parentElement?.addEventListener("touchend",i=>{if(ut-=i.changedTouches.length,i.touches?.length!==1&&(dt=!1),e&&!i.touches?.length){if(new Date().getTime()-e.getTime()>600&&i.target===b.canvasEl){const r={button:2,clientX:i.changedTouches[0].clientX,clientY:i.changedTouches[0].clientY,pointerId:1,isPrimary:!0};b.canvasEl.dispatchEvent(new PointerEvent("pointerdown",r)),setTimeout(()=>{b.canvasEl.dispatchEvent(new PointerEvent("pointerup",r))}),i.preventDefault()}e=null}}),b.canvasEl.parentElement?.addEventListener("touchmove",i=>{if(e&&t&&i.touches?.length===1){const l=i.touches[0],c=l.clientX-t.clientX,h=l.clientY-t.clientY;c*c+h*h>30&&(e=null)}if(i.touches?.length===2&&t&&!i.ctrlKey&&!i.shiftKey){i.preventDefault(),b.canvas.pointer.isDown=!1,dt=!0,V.closeAllContextMenus(window),b.canvas.search_box?.close();const l=s(i),c=a(i);if(o===null||n===null)return;let h=o*l/n;const f=(c.clientX-t.clientX)/h,g=(c.clientY-t.clientY)/h;h<b.canvas.ds.min_scale?h=b.canvas.ds.min_scale:h>b.canvas.ds.max_scale&&(h=b.canvas.ds.max_scale);const p=b.canvas.ds.scale;b.canvas.ds.scale=h,Math.abs(b.canvas.ds.scale-1)<.01&&(b.canvas.ds.scale=1);const m=b.canvas.ds.scale,v=u(w=>[c.clientX/w-b.canvas.ds.offset[0],c.clientY/w-b.canvas.ds.offset[1]],"convertScaleToOffset");var r=v(p),d=v(m);b.canvas.ds.offset[0]+=f+d[0]-r[0],b.canvas.ds.offset[1]+=g+d[1]-r[1],t.clientX=c.clientX,t.clientY=c.clientY,b.canvas.setDirty(!0,!0)}},!0)}});const Aa=Me.prototype.processMouseDown;Me.prototype.processMouseDown=function(n){if(!(dt||ut))return b.canvas.pointer.isDown=!1,Aa.apply(this,[n])};const Ba=Me.prototype.processMouseMove;Me.prototype.processMouseMove=function(n){if(!(dt||ut>1))return Ba.apply(this,[n])};b.registerExtension({name:"Comfy.SlotDefaults",suggestionsNumber:null,init(){V.search_filter_enabled=!0,V.middle_click_slot_add_default_node=!0,this.suggestionsNumber=b.ui.settings.addSetting({id:"Comfy.NodeSuggestions.number",category:["Comfy","Node Search Box","NodeSuggestions"],name:"Number of nodes suggestions",tooltip:"Only for litegraph searchbox/context menu",type:"slider",attrs:{min:1,max:100,step:1},defaultValue:5,onChange:u(n=>{this.setDefaults(n)},"onChange")})},slot_types_default_out:{},slot_types_default_in:{},async beforeRegisterNodeDef(n,e){var t=e.name;const o=e.input?.required;for(const l in o){var s=o[l];if(typeof s[0]!="string")continue;var a=s[0];if(a in Ee){var i=s[1];if(!i?.forceInput)continue}if(a in this.slot_types_default_out||(this.slot_types_default_out[a]=["Reroute"]),this.slot_types_default_out[a].includes(t))continue;this.slot_types_default_out[a].push(t);const c=a.toLocaleLowerCase();c in V.registered_slot_in_types||(V.registered_slot_in_types[c]={nodes:[]}),V.registered_slot_in_types[c].nodes.push(n.comfyClass)}var r=e.output??[];for(const l of r){const c=l;c in this.slot_types_default_in||(this.slot_types_default_in[c]=["Reroute"]),!this.slot_types_default_in[c].includes(t)&&(this.slot_types_default_in[c].push(t),c in V.registered_slot_out_types||(V.registered_slot_out_types[c]={nodes:[]}),V.registered_slot_out_types[c].nodes.push(n.comfyClass),V.slot_types_out.includes(c)||V.slot_types_out.push(c))}var d=this.suggestionsNumber.value;this.setDefaults(d)},setDefaults(n){V.slot_types_default_out={},V.slot_types_default_in={};for(const e in this.slot_types_default_out)V.slot_types_default_out[e]=this.slot_types_default_out[e].slice(0,n);for(const e in this.slot_types_default_in)V.slot_types_default_in[e]=this.slot_types_default_in[e].slice(0,n)}});async function Fa(n,e,t,o,s=!1){try{const a=new FormData;a.append("image",t),s&&a.append("subfolder","pasted");const i=await ae.fetchApi("/upload/image",{method:"POST",body:a});if(i.status===200){const r=await i.json();let d=r.name;r.subfolder&&(d=r.subfolder+"/"+d),n.options.values.includes(d)||n.options.values.push(d),o&&(e.element.src=ae.apiURL(ct(...wo(d))),n.value=d,n.callback?.(d))}else he().addAlert(i.status+" - "+i.statusText)}catch(a){he().addAlert(a)}}u(Fa,"uploadFile");b.registerExtension({name:"Comfy.AudioWidget",async beforeRegisterNodeDef(n,e){["LoadAudio","SaveAudio","PreviewAudio","SaveAudioMP3","SaveAudioOpus"].includes(n.prototype.comfyClass)&&(e.input.required.audioUI=["AUDIO_UI",{}])},getCustomWidgets(){return{AUDIO_UI(n,e){const t=document.createElement("audio");t.controls=!0,t.classList.add("comfy-audio"),t.setAttribute("name","media");const o=n.addDOMWidget(e,"audioUI",t);o.serialize=!1;const{nodeData:s}=n.constructor;if(s==null)throw new TypeError("nodeData is null");if(s.output_node){o.element.classList.add("empty-audio-widget");const i=n.onExecuted;n.onExecuted=function(r){i?.apply(this,arguments);const d=r.audio;if(!d)return;const l=d[0];o.element.src=ae.apiURL(ct(l.subfolder,l.filename,l.type)),o.element.classList.remove("empty-audio-widget")}}return o.onRemove=Xe(o.onRemove,()=>{o.element&&(o.element.pause(),o.element.src="",o.element.remove())}),{widget:o}}}},onNodeOutputsUpdated(n){for(const[e,t]of Object.entries(n))if("audio"in t){const o=nn(b.graph,e);if(!o)continue;const s=o.widgets.find(i=>i.name==="audioUI"),a=t.audio[0];s.element.src=ae.apiURL(ct(a.subfolder,a.filename,a.type)),s.element.classList.remove("empty-audio-widget")}}});b.registerExtension({name:"Comfy.UploadAudio",async beforeRegisterNodeDef(n,e){e?.input?.required?.audio?.[1]?.audio_upload===!0&&(e.input.required.upload=["AUDIOUPLOAD",{}])},getCustomWidgets(){return{AUDIOUPLOAD(n,e){const t=n.widgets.find(c=>c.name==="audio"),o=n.widgets.find(c=>c.name==="audioUI");o.options.canvasOnly=!0;const s=u(()=>{typeof t.value=="string"&&(o.element.src=ae.apiURL(ct(...wo(t.value))))},"onAudioWidgetUpdate");t.value&&s(),t.callback=s;const a=n.onGraphConfigured;n.onGraphConfigured=function(){a?.apply(this,arguments),t.value&&s()};const i=u(async c=>(c?.length&&Fa(t,o,c[0],!0),c),"handleUpload"),r=u(c=>c.type.startsWith("audio/"),"isAudioFile"),{openFileSelection:d}=sn(n,{accept:"audio/*",onSelect:i}),l=n.addWidget("button",e,"",d,{serialize:!1,canvasOnly:!0});return l.label=E("g.choose_file_to_upload"),an(n,{fileFilter:r,onDrop:i}),rn(n,{fileFilter:r,onPaste:i}),n.previewMediaType="audio",{widget:l}}}}});b.registerExtension({name:"Comfy.RecordAudio",getCustomWidgets(){return{AUDIO_RECORD(n,e){const t=document.createElement("audio");t.controls=!0,t.classList.add("comfy-audio"),t.setAttribute("name","media");const o=n.addDOMWidget(e,"audioUI",t);o.options.canvasOnly=!1;let s=null,a=!1,i=[],r=null,d=null,l=null,c=null;o.serializeValue=async()=>{a&&s&&(l=new Promise(p=>{c=p}),s.stop(),await l);const f=o.element.src;if(!f)return he().addAlert(E("g.noAudioRecorded")),"";const g=await fetch(f).then(p=>p.blob());return await je().convertBlobToFileAndSubmit(g)},d=n.addWidget("button",e,"",async()=>{if(a)s&&a&&s.stop();else try{r=await navigator.mediaDevices.getUserMedia({audio:!0}),s=new pn(r,{mimeType:"audio/wav"}),i=[],s.ondataavailable=f=>{i.push(f.data)},s.onstop=async()=>{const f=new Blob(i,{type:"audio/wav"});je().stopAllTracks(r),o.element.src&&o.element.src.startsWith("blob:")&&URL.revokeObjectURL(o.element.src),o.element.src=URL.createObjectURL(f),a=!1,d&&(d.label=E("g.startRecording")),c&&(c(),c=null,l=null)},s.onerror=f=>{console.error("MediaRecorder error:",f),je().stopAllTracks(r),a=!1,d&&(d.label=E("g.startRecording")),c&&(c(),c=null,l=null)},s.start(),a=!0,d&&(d.label=E("g.stopRecording"))}catch(f){if(console.error("Error accessing microphone:",f),he().addAlert(E("g.micPermissionDenied")),s)try{s.stop()}catch{}je().stopAllTracks(r),r=null,a=!1,d&&(d.label=E("g.startRecording"))}},{serialize:!1,canvasOnly:!1}),d.label=E("g.startRecording"),d.type="audiorecord";const h=n.onRemoved;return n.onRemoved=function(){a&&s&&s.stop(),je().stopAllTracks(r),o.element.src?.startsWith("blob:")&&URL.revokeObjectURL(o.element.src),h?.call(this)},{widget:d}}}},async nodeCreated(n){n.constructor.comfyClass==="RecordAudio"&&await je().registerWavEncoder()}});const $a=u(n=>{const[e,t]=n;return t?(t.image_upload===!0||t.video_upload===!0||t.animated_image_upload===!0)&&(ln(n)||e==="COMBO"):!1},"isMediaUploadComboInput"),Wa=u((n,e)=>["IMAGEUPLOAD",{...e[1],imageInputName:n}],"createUploadInput");b.registerExtension({name:"Comfy.UploadImage",beforeRegisterNodeDef(n,e){const{input:t}=e??{},{required:o}=t??{};if(!o)return;const s=Object.entries(o).find(([a,i])=>$a(i));if(s){const[a,i]=s;o.upload=Wa(a,i)}}});const lo=Symbol();b.registerExtension({name:"Comfy.WebcamCapture",getCustomWidgets(){return{WEBCAM(n,e){let t;n[lo]=new Promise(i=>t=i);const o=document.createElement("div");o.style.background="rgba(0,0,0,0.25)",o.style.textAlign="center";const s=document.createElement("video");return s.style.height=s.style.width="100%",u(async()=>{try{const i=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});o.replaceChildren(s),setTimeout(()=>t(s),500),s.addEventListener("loadedmetadata",()=>t(s),!1),s.srcObject=i,s.play()}catch(i){const r=document.createElement("div");r.style.color="red",r.style.overflow="auto",r.style.maxHeight="100%",r.style.whiteSpace="pre-wrap",window.isSecureContext?r.textContent=`Unable to load webcam, please ensure access is granted:
`+i.message:r.textContent=`Unable to load webcam. A secure context is required, if you are not accessing ComfyUI on localhost (127.0.0.1) you will have to enable TLS (https)

`+i.message,o.replaceChildren(r)}},"loadVideo")(),{widget:n.addDOMWidget(e,"WEBCAM",o)}}}},nodeCreated(n){if(n.type,n.constructor.comfyClass!=="WebcamCapture")return;let e;const t=n.widgets.find(l=>l.name==="image"),o=n.widgets.find(l=>l.name==="width"),s=n.widgets.find(l=>l.name==="height"),a=n.widgets.find(l=>l.name==="capture_on_queue"),i=document.createElement("canvas"),r=u(()=>{i.width=o.value,i.height=s.value,i.getContext("2d").drawImage(e,0,0,o.value,s.value);const c=i.toDataURL("image/png"),h=new Image;h.onload=()=>{n.imgs=[h],b.graph.setDirtyCanvas(!0)},h.src=c},"capture"),d=n.addWidget("button","waiting for camera...","capture",r,{canvasOnly:!0});d.disabled=!0,d.serializeValue=()=>{},t.serializeValue=async()=>{if(a.value)r();else if(!n.imgs?.length){const p="No webcam image captured";throw he().addAlert(p),new Error(p)}const l=await new Promise(p=>i.toBlob(p)),c=`${+new Date}.png`,h=new File([l],c),f=new FormData;f.append("image",h),f.append("subfolder","webcam"),f.append("type","temp");const g=await ae.fetchApi("/upload/image",{method:"POST",body:f});if(g.status!==200){const p=`Error uploading camera image: ${g.status} - ${g.statusText}`;throw he().addAlert(p),new Error(p)}return`webcam/${c} [temp]`},n[lo].then(l=>{e=l,o.value||(o.value=e.videoWidth||640,s.value=e.videoHeight||480),d.disabled=!1,d.label=E("g.capture")})}});Ze().registerExtension({name:"Comfy.LLMNodePreview",async beforeRegisterNodeDef(n,e){if(e.name==="LLMNode"){const t=n.prototype.onNodeCreated;n.prototype.onNodeCreated=function(){t&&t.apply(this,[]);const s=Ee.MARKDOWN(this,"preview",["MARKDOWN",{}],b).widget;s.element.readOnly=!0,s.serialize=!1};const o=n.prototype.onExecuted;n.prototype.onExecuted=function(s){o?.apply(this,[s]);const a=this.widgets?.find(i=>i.name==="preview");a&&s.text&&Array.isArray(s.text)&&s.text.length>0&&(a.value=s.text[0])}}}});
//# sourceMappingURL=index-BzO9u1rn.js.map
