from typing import Sequence, Optional, Literal

import numpy
import biocutils
import knncolle

from . import _lib_scranpy as lib


def correct_mnn(
    x: numpy.ndarray,
    block: Sequence,
    num_neighbors: int = 15,
    num_steps: int = 1,
    merge_policy: Literal["rss", "size", "variance", "input"] = "rss",
    num_mads: Optional[int] = None,
    robust_iterations: Optional[int] = None,
    robust_trim: Optional[float] = None,
    mass_cap: Optional[int] = None,
    order: Optional[Sequence] = None,
    reference_policy: Optional[str] = None,
    nn_parameters: knncolle.Parameters = knncolle.AnnoyParameters(),
    num_threads: int = 1
) -> biocutils.NamedList:
    """
    Perform mutual nearest neighbor (MNN) correction to remove batch effects from a matrix of low-dimensional embeddings.

    Args:
        x:
            Matrix of coordinates where rows are dimensions and columns are cells, typically generated by :py:func:`~scranpy.run_pca`.

        block:
            Factor specifying the block of origin (e.g., batch, sample) for each cell. Length should equal the number of columns in ``x``.

        num_neighbors:
            Number of neighbors to use when identifying MNN pairs.

        num_steps:
            Number of steps for the recursive neighbor search to compute the center of mass.
            Larger values mitigate the kissing effect but increase the risk of including inappropriately distant subpopulations into the center of mass.

        merge_policy:
            Policy for choosing the merge order.

            - ``input`` uses the input order of the batches.
              Observations in the last batch are corrected first, and then the second-last batch, and so on.
              This allows users to control the merge order by simply changing the inputs.
            - ``size`` merges batches in order of increasing size (i.e., the number of observations).
              So, the smallest batch is corrected first while the largest batch is unchanged.
              The aim is to lower compute time by reducing the number of observations that need to be reprocessed in later merge steps.
            - ``variance`` merges batches in order of increasing variance between observations. 
              So, the batch with the lowest variance is corrected first while the batch with the highest variance is unchanged.
              The aim is to lower compute time by encouraging more observations to be corrected to the most variable batch, thus avoid reprocessing in later merge steps.
            - ``rss`` merges batches in order of increasing residual sum of squares (RSS).
              This is effectively a compromise between ``variance`` and ``size``.

        num_mads:
            Deprecated and ignored.

        robust_iterations:
            Deprecated and ignored.

        robust_trim:
            Deprecated and ignored.

        mass_cap:
            Deprecated and ignored.

        order:
            Deprecated and ignored.
            Now the merge order is always determinted automatically.

        reference_policy:
            Deprecated, see ``merge_policy`` instead.

        nn_parameters:
            The nearest-neighbor algorithm to use.

        num_threads:
            Number of threads to use.

    Returns:
        A :py:class:`~biocutils.NamedList.NamedList` containing the following entries.

        - ``corrected``, a double-precision NumPy array of the same dimensions as ``x``, containing the corrected values.

    References:
        https://libscran.github.io/mnncorrect, which describes the MNN correction algorithm in more detail. 

    Examples:
        >>> import numpy
        >>> pcs = numpy.random.rand(10, 200)
        >>> block = ["A", "B"] * 100
        >>> import scranpy
        >>> mnn_out = scranpy.correct_mnn(pcs, block)
        >>> mnn_out["corrected"].shape
    """

    blocklev, blockind = biocutils.factorize(block, fail_missing=True, dtype=numpy.uint32)

    if reference_policy is not None:
        merge_policy = reference_policy

    builder, _ = knncolle.define_builder(nn_parameters)
    corrected = lib.correct_mnn(
        x, 
        blockind, 
        num_neighbors,
        num_steps,
        num_threads,
        merge_policy,
        builder.ptr
    )

    return biocutils.NamedList([corrected["corrected"]], ["corrected"])
