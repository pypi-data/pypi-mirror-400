---
# SPDX-FileCopyrightText: 2026 Tymoteusz Blazejczyk <tymoteusz.blazejczyk@tymonx.com>
# SPDX-License-Identifier: Apache-2.0

.python:
    image: python:latest
    needs: []
    rules:
        - if: $CI_COMMIT_REF_NAME
          when: always
        - when: never
    before_script:
        - python3 -m venv .venv
        - . .venv/bin/activate
        - pip install --upgrade pip
        - pip install ${PIP_INSTALL:-}

reuse:
    extends: .python
    variables:
        PIP_INSTALL: reuse
    script:
        - reuse lint

deploy-pypi-public:
    extends: .python
    variables:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: $PYPI_API_TOKEN
        PIP_INSTALL: build twine
    rules:
        - if: $CI_COMMIT_TAG
          when: always
        - when: never
    script:
        - python -m build
        - python -m twine upload dist/*

deploy-pypi-gitlab:
    extends: .python
    variables:
        TWINE_USERNAME: gitlab-ci-token
        TWINE_PASSWORD: $CI_JOB_TOKEN
        PIP_INSTALL: build twine
    rules:
        - if: $CI_COMMIT_TAG || $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
          when: always
        - when: never
    script:
        - python -m build
        - python -m twine upload --repository-url "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi" dist/*
