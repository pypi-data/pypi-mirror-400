import{r as f,j as s,A as w,p as S,y as O,l as P,F as $,w as H,c as G,m as X,$ as F,a0 as T,a1 as b,q as L}from"./index-4cf586ed.js";import{u as _}from"./hooks-e8b12550.js";import{m as I}from"./ConnectUtils-bd734a4a.js";function R(t){return t instanceof Object&&"data"in t}function j(t,e="Expected H5Dataset"){if(!R(t))throw new Error(e)}function k(t){return t instanceof Object&&"children"in t}function z(t,e="Expected H5Group"){if(!k(t))throw new Error(e)}function A(t){return!t.group||P.values(t.group.children).length===1?null:s.jsx($.Control,{as:"select",size:"sm",onChange:e=>t.onChange(e.target.value),children:P.map(t.group.children,e=>s.jsx("option",{value:e.name,children:e.name},e.name))})}function N(t){return t===void 0?null:typeof t=="string"?[t]:t}class c extends Error{constructor(e){super(e),Object.setPrototypeOf(this,c.prototype)}}function W(t){const e={xaxis:{title:{text:""}},yaxis:{title:{text:""},type:"linear",showexponent:"all",exponentformat:"e"}},a=N(t.attrs.axes);if(!a)throw new c("No axes found in NXdata");const r=[];if(a.length!==1)throw new c(`Expect 1 and only 1 axis, found ${a.length}`);const i=t.children[t.attrs.axes[0]];j(i);const o=i.data;e.xaxis.title.text=t.children[t.attrs.axes[0]].attrs.units;const h=t.children[t.attrs.signal];j(h);const g=h.data;e.yaxis.title.text=t.children[t.attrs.signal].attrs.units,t.attrs.SILX_style&&JSON.parse(t.attrs.SILX_style).signal_scale_type==="log"&&(e.yaxis.type="log");const m={x:o,y:g,type:"scattergl",name:t.attrs.signal};r.push(m);const d=N(t.attrs.auxiliary_signals);if(d&&P.each(d,l=>{const x=t.children[l];j(x);const p=x.data,y={x:o,y:p,yaxis:"y2",type:"scattergl",name:l};r.push(y)}),r.length===0)throw new c("No data was found");return[r,e]}function q(t){const e=N(t.attrs.signal);if(!e)throw new c("No signal found in NXdata");if(e.length!==1)throw new c(`Expect one and only one signal, found ${e.length}`);const a=t.children[e[0]];if(j(a),!a)throw new c(`Dataset from signal ${e[0]} does not exists`);if(a.ndim!==2)throw new c(`Dataset from signal ${e[0]} must be 2 ndim (found ${a.ndim})`);return[[{z:a.data,type:"heatmapgl"}],{}]}function J(t){let e="";try{return q(t)}catch(a){if(a instanceof c)e+=`Image plot: ${a.message}`;else throw a}try{return W(t)}catch(a){if(a instanceof c)e+=`Curve plot: ${a.message}`;else throw a}throw new c(e)}function K(t){if((t==null?void 0:t.attrs.NX_class)==="NXdata")return J(t);throw new c("Only NXdata group is supported")}function U(t){var p,y,v,E,C;const e=f.useRef(),[a,r]=f.useState((y=(p=t.group)==null?void 0:p.attrs)==null?void 0:y.default),{autoprocprogramid:i=null,datacollectionid:o=null,params:h={},poll:g=0,options:m}=t,d=_(t.options.events),l=f.useCallback(n=>{var u,D;console.log("refresh"),(D=(u=t.actions)==null?void 0:u.setParams)==null||D.call(u,{type:"processing",uri:m.uri},!0).then(()=>{n&&(e.current=setTimeout(()=>l(n),n*1e3))}).catch(Q=>{console.log("Could not fetch group data")})},[m.uri,t.actions]);if(f.useEffect(()=>{var n;d!==null&&o===null&&(n=t.actions)!=null&&n.setParams&&(t.actions.setParams({datacollectionid:d==null?void 0:d.datacollectionid}),l())},[i,o,d,t.actions,m.uri,l]),f.useEffect(()=>{var u;const n={};o&&(n.datacollectionid=o),i&&(n.autoprocprogramid=i),(h.datacollectionid!==n.datacollectionid||h.autoprocprogramid!==n.autoprocprogramid)&&(u=t.actions)!=null&&u.setParams&&(t.actions.setParams(n),l(g))},[i,o,g,t.actions,h,l]),f.useEffect(()=>()=>{e.current&&clearTimeout(e.current)},[]),f.useEffect(()=>{!a&&t.group&&t.group.attrs.default&&r(t.group.attrs.default)},[t.group,a]),i===null&&o===null)return s.jsx("p",{children:"Select a processing program output"});if(t.error){const n=o||i;return s.jsxs(w,{variant:"warning",children:['Could not load data for processing program id "',n,'" with uri "',m.uri,'"']})}if(!t.group)return s.jsx(w,{variant:"info",children:s.jsx("p",{children:"Waiting for data"})});const x=a?(v=t.group)==null?void 0:v.children[a]:((C=t.group)==null?void 0:C.children[(E=t.group)==null?void 0:E.attrs.default])||t.group||null;if(!x)return s.jsx(w,{variant:"info",children:s.jsx("p",{children:"No data to display"})});z(x);try{const[n,u]=K(x);return s.jsxs("div",{className:"plot1d-container",children:[a&&s.jsx(A,{group:t.group,onChange:r}),s.jsx(S,{children:s.jsx(O,{data:n,layout:u})})]})}catch(n){if(n instanceof c)return s.jsxs(w,{variant:"error",children:[s.jsx("p",{children:"Data format unsupported:"}),s.jsx("p",{children:n.message})]});throw n}}const Y=(t,e,a)=>{const{providers:r,options:i}=e,{groups:o}=r.hdf5;return{group:o.selector("results",t)[i.uri],error:o.selector("error",t),params:r.hdf5.groups.selector("params",t),datacollectionid:X.selector("selectedDataCollection",t)}};function B(t,e){return{actions:{setParams:(a,r)=>e.providers.hdf5.groups.setParams(a,r)}}}const M=H({hdf5:F})(G(I(Y),B)(U));function et(t){const{providers:e,yamlNode:a,events:r,url:i,...o}=t;return T(a,"events",r),b(a,"url",i),L(a,o),s.jsx(M,{providers:e,options:{url:i,events:r}})}export{et as default};
